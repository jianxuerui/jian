#!/usr/bin/env bash
# nockchain_toolbox.sh ç»ˆæä¿®å¤ç‰ˆ v10.0
# æ–°å¢ç‰¹æ€§ï¼šCUDAæ™ºèƒ½æ£€æµ‹ + è·¯å¾„è‡ªåŠ¨ä¿®å¤ + å…¨å‘è¡Œç‰ˆæ”¯æŒ

set -euo pipefail
IFS=$'\n\t'

###############################
# å…¨å±€é…ç½®
###############################
SRC_DIR="${HOME}/build/ethminer"
INSTALL_PREFIX="/usr/local"
LOG_FILE="${HOME}/nockchain.log"
CONFIG_FILE="${HOME}/.nockchain.conf"

###############################
# é¢œè‰²è¾“å‡ºå‡½æ•°
###############################
c_info() { printf "\033[32m[INFO]\033[0m %s\n" "$*"; }
c_warn() { printf "\033[33m[WARN]\033[0m %s\n" "$*"; }
c_err()  { printf "\033[31m[ERR]\033[0m %s\n" "$*"; exit 1; }

###############################
# CUDAæ™ºèƒ½æ£€æµ‹ç³»ç»Ÿ
###############################
detect_cuda() {
    # æ£€æµ‹æ ‡å‡†å®‰è£…è·¯å¾„
    local cuda_paths=(
        "/usr/local/cuda"
        "/opt/cuda"
        "${HOME}/cuda"
    )
    
    for path in "${cuda_paths[@]}"; do
        if [[ -d "${path}/bin" && -x "${path}/bin/nvcc" ]]; then
            echo "${path}"
            return 0
        fi
    done

    # æ£€æµ‹ç¯å¢ƒå˜é‡
    if [[ -n "${CUDA_HOME}" && -d "${CUDA_HOME}/bin" ]]; then
        echo "${CUDA_HOME}"
        return 0
    fi

    # æ£€æµ‹PATHä¸­çš„nvcc
    local nvcc_path=$(which nvcc 2>/dev/null)
    if [[ -n "${nvcc_path}" ]]; then
        echo "$(dirname $(dirname ${nvcc_path}))"
        return 0
    fi

    echo "not_found"
}

###############################
# å¢å¼ºç‰ˆç³»ç»Ÿä¿®å¤
###############################
fix_system_deps() {
    # å®‰è£…åŸºç¡€ä¾èµ–
    if [[ -f /etc/redhat-release ]]; then
        c_info "ğŸ§ æ£€æµ‹åˆ° RHEL/CentOS ç³»ç»Ÿ"
        sudo yum install -y epel-release
        sudo yum groupinstall -y "Development Tools"
        sudo yum install -y \
            gcc-c++ \
            libstdc++-devel \
            openssl-devel \
            ocl-icd-devel \
            opencl-headers
        
    elif [[ -f /etc/debian_version ]]; then
        c_info "ğŸ§ æ£€æµ‹åˆ° Debian/Ubuntu ç³»ç»Ÿ"
        sudo apt-get update
        sudo apt-get install -y \
            build-essential \
            libstdc++-dev \
            libssl-dev \
            ocl-icd-opencl-dev \
            opencl-headers
    else
        c_err "âŒ ä¸æ”¯æŒçš„Linuxå‘è¡Œç‰ˆ"
    fi

    # ç‰¹æ®Šä¿®å¤ï¼šlibstdc++ç¬¦å·é“¾æ¥
    [[ ! -f /usr/lib64/libstdc++.so ]] && \
    sudo ln -svf /usr/lib64/libstdc++.so.6 /usr/lib64/libstdc++.so

    sudo ldconfig
}

###############################
# æ™ºèƒ½ç¼–è¯‘é…ç½®
###############################
configure_cmake() {
    local build_dir=$1
    local cuda_path=$2

    c_info "ğŸ”§ é…ç½®ç¼–è¯‘å‚æ•°..."
    cd "${build_dir}"
    
    local cmake_args=(
        "-DCMAKE_BUILD_TYPE=Release"
        "-DCMAKE_CXX_COMPILER=g++"
        "-DCMAKE_EXE_LINKER_FLAGS=-Wl,-rpath=/usr/lib64"
        "-DUSE_SYS_OPENCL=ON"
    )

    # CUDAç‰¹æ®Šå¤„ç†
    if [[ "${cuda_path}" != "not_found" ]]; then
        cmake_args+=(
            "-DETHASHCUDA=ON"
            "-DCUDA_TOOLKIT_ROOT_DIR=${cuda_path}"
        )
        c_info "âœ… æ£€æµ‹åˆ°CUDA: ${cuda_path}"
    else
        cmake_args+=("-DETHASHCUDA=OFF")
        c_warn "âš ï¸  æœªæ£€æµ‹åˆ°CUDAï¼Œç¦ç”¨CUDAæ”¯æŒ"
    fi

    cmake .. "${cmake_args[@]}"
}

###############################
# å…¨è‡ªåŠ¨ç¼–è¯‘æµç¨‹
###############################
rebuild_project() {
    local build_dir="${SRC_DIR}/build_release"
    
    # æ¸…ç†ç¯å¢ƒ
    c_info "ğŸ§¹ æ¸…ç†æ„å»ºç›®å½•..."
    rm -rf "${build_dir}"
    mkdir -p "${build_dir}"

    # æ£€æµ‹CUDAè·¯å¾„
    local cuda_path=$(detect_cuda)
    
    # é…ç½®ç¼–è¯‘å‚æ•°
    configure_cmake "${build_dir}" "${cuda_path}"

    # å¼€å§‹ç¼–è¯‘
    c_info "ğŸš€ å¼€å§‹ç¼–è¯‘ï¼ˆä½¿ç”¨$(nproc)çº¿ç¨‹ï¼‰..."
    if make -j$(nproc); then
        c_info "ğŸ‰ ç¼–è¯‘æˆåŠŸï¼"
        sudo make install
    else
        c_err "ğŸ’¥ ç¼–è¯‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        tail -n 50 CMakeFiles/CMakeError.log
        exit 1
    fi
}

###############################
# å¢å¼ºèœå•ç³»ç»Ÿ (å‰©ä½™åŠŸèƒ½ä¿æŒä¸å˜)
###############################
show_menu() {
    clear
    echo -e "\n========== Nockchain ç»ˆæç®¡ç†å·¥å…· =========="
    echo "1) è‡ªåŠ¨ä¿®å¤ä¾èµ–ç¯å¢ƒ"
    echo "2) æ™ºèƒ½é‡æ–°ç¼–è¯‘"
    echo "3) é…ç½®é’±åŒ…åœ°å€"
    echo "4) å¯åŠ¨æŒ–çŸ¿èŠ‚ç‚¹"
    echo "5) æŸ¥çœ‹å®æ—¶æ—¥å¿—"
    echo "6) æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯"
    echo "7) é€€å‡º"
    echo -e "==========================================\n"
}

# ...ï¼ˆå…¶ä½™èœå•åŠŸèƒ½ä¿æŒä¸å˜ï¼‰...

main() {
    trap 'c_err "ç”¨æˆ·ä¸­æ–­æ“ä½œï¼Œé€€å‡ºè„šæœ¬"' INT TERM
    while true; do
        show_menu
        read -rp "è¯·è¾“å…¥é€‰é¡¹ [1-7]: " choice
        case $choice in
            1) fix_system_deps ;;
            2) rebuild_project ;;
            3) manage_wallet ;;
            4) start_mining ;;
            5) view_logs ;;
            6) validate_environment ;;
            7) c_info "æ„Ÿè°¢ä½¿ç”¨ï¼"; exit 0 ;;
            *) c_warn "æ— æ•ˆè¾“å…¥ï¼Œè¯·é‡æ–°é€‰æ‹©" ;;
        esac
        read -rp "æŒ‰å›è½¦è¿”å›ä¸»èœå•..."
    done
}

main "$@"
