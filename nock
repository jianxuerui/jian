#!/bin/bash
# Nockchain Ecosystem Orchestrator v4.0 "Archon" - Final Manual Build Version
#
# A comprehensive suite for deploying, managing, and participating in the Nockchain ecosystem.
#
set -euo pipefail
trap 'handle_error $? $LINENO' ERR
exec > >(tee /var/log/nockchain-orchestrator.log) 2>&1

# --- CONFIGURATION HUB ---
declare -A CONFIG=(
    [USER]="nockchain"
    [RUSTUP_HOME]="/opt/rustup"
    [CARGO_HOME]="/opt/cargo"
    [SOURCE_DIR]="/opt/nockchain"
    [DATA_DIR]="/var/lib/nockchain"
    [LOG_FILE]="/var/log/nockchain-orchestrator.log"
    [ERROR_LOG]="/var/log/nockchain-error.log"
    [P2P_PORT]="30303"
    [RPC_PORT]="9933"
    [METRICS_PORT]="9615"
    [GRAFANA_PORT]="3000"
)
SKIP_CPU_CHECK=${SKIP_CPU_CHECK:-0}

# --- ENVIRONMENT & UTILS ---
export LC_ALL=C.UTF-8
export RUSTUP_HOME="${CONFIG[RUSTUP_HOME]}"
export CARGO_HOME="${CONFIG[CARGO_HOME]}"
PATH="${CONFIG[CARGO_HOME]}/bin:$PATH"

green='\e[32m'; blue='\e[34m'; red='\e[31m'; yellow='\e[33m'; reset='\e[0m'
ColorGreen(){ echo -ne "${green}$1${reset}"; }
ColorBlue() { echo -ne "${blue}$1${reset}"; }
ColorRed()  { echo -ne "${red}$1${reset}"; }
ColorYellow(){ echo -ne "${yellow}$1${reset}"; }

handle_error() {
    local exit_code=$1 line_no=$2
    local err_msg="[$(date '+%F %T')] è‡´å‘½é”™è¯¯äºè„šæœ¬ $0 ç¬¬ $line_no è¡Œ: å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç  $exit_code."
    echo "$err_msg" | tee -a "${CONFIG[ERROR_LOG]}" >&2
    ColorRed "\néƒ¨ç½²å¤±è´¥ï¼è¯¦æƒ…è¯·è§ ${CONFIG[ERROR_LOG]}\n" >&2
    systemctl stop nockchain-node.service nockchain-monitor.service grafana-server prometheus 2>/dev/null || true
    exit "$exit_code"
}

# --- CORE FUNCTIONS ---
check_compatibility() {
    ColorBlue ">> [1/8] æ­£åœ¨è¿›è¡Œç³»ç»Ÿå…¼å®¹æ€§æ£€æŸ¥...\n"
    if ! command -v lsb_release &>/dev/null; then
        echo "æœªæ‰¾åˆ° lsb-releaseã€‚æ­£åœ¨å°è¯•å®‰è£…..." >&2
        if command -v apt-get &>/dev/null; then sudo apt-get update && sudo apt-get install -y lsb-release;
        elif command -v yum &>/dev/null; then sudo yum install -y redhat-lsb-core;
        else ColorRed "ä¸æ”¯æŒçš„åŒ…ç®¡ç†å™¨ã€‚è¯·æ‰‹åŠ¨å®‰è£… lsb-releaseã€‚\n"; exit 1; fi
    fi
    local distro version; distro=$(lsb_release -si); version=$(lsb_release -sr); echo "å‘è¡Œç‰ˆ: $distro $version"
    case $distro in
        Ubuntu) [[ $version =~ ^(20\.04|22\.04|24\.04)$ ]] || { ColorRed "ä¸æ”¯æŒçš„ Ubuntu ç‰ˆæœ¬: $version. éœ€è¦: 20.04, 22.04, 24.04\n"; exit 1; };;
        Debian) [[ ${version%%.*} -ge 10 ]] || { ColorRed "éœ€è¦ Debian >= 10, å½“å‰ç‰ˆæœ¬ $version\n"; exit 1; };;
        CentOS|AlmaLinux|Rocky|OracleLinux) [[ ${version%%.*} -ge 8 ]] || { ColorRed "éœ€è¦ RHEL/CentOS >= 8, å½“å‰ç‰ˆæœ¬ $version\n"; exit 1; };;
        *) ColorRed "ä¸æ”¯æŒçš„å‘è¡Œç‰ˆ: $distro\n"; exit 1;;
    esac
    if [[ $SKIP_CPU_CHECK -ne 1 ]]; then
        grep -q 'sse4_2' /proc/cpuinfo || { ColorRed "CPU ä¸æ”¯æŒ SSE4.2, æ­¤ä¸ºå¿…é¡»é¡¹ã€‚\n"; exit 1; }
        grep -q 'avx2' /proc/cpuinfo || ColorYellow "è­¦å‘Š: æœªæ£€æµ‹åˆ° AVX2 æ”¯æŒã€‚ZK ç›¸å…³æ“ä½œæ€§èƒ½å¯èƒ½ä¼šå—å½±å“ã€‚\n"
    fi
    ColorGreen "ç³»ç»Ÿå…¼å®¹æ€§æ£€æŸ¥é€šè¿‡ã€‚\n"
}

install_dependencies() {
    ColorBlue ">> [2/8] æ­£åœ¨å®‰è£…æ ¸å¿ƒä¾èµ–...\n"
    if command -v dnf &>/dev/null; then
        ColorYellow "æ£€æµ‹åˆ° RHEL/CentOS ç³»ç»Ÿï¼Œæ­£åœ¨å¤„ç†ä»“åº“å’Œä¾èµ–...\n"
        if ! rpm -q epel-release &>/dev/null; then
            ColorYellow "æ­£åœ¨å®‰è£… EPEL ä»“åº“...\n"
            sudo dnf install -y epel-release
        fi
        ColorYellow "æ­£åœ¨å¯ç”¨ PowerTools/CRB ä»“åº“...\n"
        sudo dnf install -y -q 'dnf-command(config-manager)'
        local BUILDER_REPO_ID=$(sudo dnf repolist all | grep -i -E 'powertools|crb|codeready|builder' | awk '{print $1}' | head -n 1)
        if [[ -n "$BUILDER_REPO_ID" ]]; then
            ColorGreen "æˆåŠŸæ‰¾åˆ°å¼€å‘å·¥å…·ä»“åº“: '$BUILDER_REPO_ID'. æ­£åœ¨å¯ç”¨...\n"
            sudo dnf config-manager --set-enabled "$BUILDER_REPO_ID"
        else
            ColorRed "è‡´å‘½é”™è¯¯: æ— æ³•è‡ªåŠ¨æ‰¾åˆ°æ‰€éœ€çš„å¼€å‘å·¥å…·ä»“åº“ã€‚\n"; exit 1
        fi
        ColorYellow "æ­£åœ¨å®‰è£…æ ¸å¿ƒè½¯ä»¶åŒ… (å·²ä¸º CentOS 8 é€‚é…)...\n"
        sudo dnf install -y \
            gcc-toolset-11 clang llvm-devel libasan clang-devel cmake openssl-devel pkgconfig \
            libuuid-devel git libcgroup-tools screen htop chrony jq python3-devel curl firewalld tor unzip
    else
        ColorRed "ä¸æ”¯æŒçš„åŒ…ç®¡ç†å™¨ã€‚æ— æ³•å®‰è£…ä¾èµ–ã€‚\n"; exit 1
    fi
    ColorGreen "ä¾èµ–å®‰è£…æˆåŠŸã€‚\n"
}

build_hoonc() {
    ColorBlue ">> [3/8] æ­£åœ¨æ„å»º Hoon ç¼–è¯‘å™¨ (hoonc)...\n"
    if [ -f /usr/local/bin/hoonc ]; then ColorGreen "Hoon ç¼–è¯‘å™¨å·²å­˜åœ¨ï¼Œè·³è¿‡æ­¤æ­¥ã€‚\n"; return; fi
    
    # MANUAL STEP: Assumes /tmp/hoon already exists from manual download
    ColorYellow "æ­£åœ¨ä½¿ç”¨æ‰‹åŠ¨ä¸‹è½½çš„ /tmp/hoon ç›®å½•...\n"
    if [ ! -d "/tmp/hoon" ]; then
        ColorRed "é”™è¯¯: æœªæ‰¾åˆ° /tmp/hoon ç›®å½•ã€‚è¯·å…ˆæŒ‰æ–¹æ¡ˆä¸€æ‰‹åŠ¨ä¸‹è½½å¹¶æ”¾ç½®æ–‡ä»¶ã€‚\n"
        exit 1
    fi

    (cd /tmp/hoon && git checkout tags/hoon-v1.0 2>/dev/null || true && make HOON_ARCH="$(uname -m)-linux" && sudo make install)
    sudo rm -rf /tmp/hoon
    ColorGreen "Hoon ç¼–è¯‘å™¨æ„å»ºå¹¶å®‰è£…æˆåŠŸã€‚\n"
}

build_nockchain_suite() {
    local node_type=$1
    ColorBlue ">> [4/8] æ­£åœ¨æ„å»º Nockchain å¥—ä»¶ (ç±»å‹: $node_type)...\n"
    if command -v dnf &>/dev/null && [ -f /opt/rh/gcc-toolset-11/enable ]; then
      ColorYellow "æ­£åœ¨å¯ç”¨ gcc-toolset-11 ä»¥è¿›è¡Œç¼–è¯‘...\n"
      source /opt/rh/gcc-toolset-11/enable
    fi
    
    # MANUAL STEP: Assumes ${CONFIG[SOURCE_DIR]} already exists from manual download
    ColorYellow "æ­£åœ¨ä½¿ç”¨æ‰‹åŠ¨ä¸‹è½½çš„ ${CONFIG[SOURCE_DIR]} ç›®å½•...\n"
    if [ ! -d "${CONFIG[SOURCE_DIR]}" ]; then
        ColorRed "é”™è¯¯: æœªæ‰¾åˆ° ${CONFIG[SOURCE_DIR]} ç›®å½•ã€‚è¯·å…ˆæŒ‰æ–¹æ¡ˆä¸€æ‰‹åŠ¨ä¸‹è½½å¹¶æ”¾ç½®æ–‡ä»¶ã€‚\n"
        exit 1
    fi

    pushd "${CONFIG[SOURCE_DIR]}" >/dev/null
      local build_features="zkpow,metrics"
      if [[ "$node_type" == "validator" ]]; then build_features+=",staking"; fi
      cargo build --release --features "$build_features"
      sudo cp target/release/nockchain /usr/local/bin/
      sudo cp target/release/nockchain-cli /usr/local/bin/
      sudo cp target/release/nockchain-wallet /usr/local/bin/
    popd >/dev/null
    sudo rm -rf "${CONFIG[SOURCE_DIR]}"
    ColorGreen "Nockchain å¥—ä»¶æ„å»ºå¹¶å®‰è£…æˆåŠŸã€‚\n"
}

# (The rest of the script is identical to the previous version)
# ... [Setup, Systemd, Monitoring, Menu functions etc.] ...
setup_environment() {
    ColorBlue ">> [5/8] æ­£åœ¨è®¾ç½®ç”¨æˆ·å’Œè¿è¡Œç¯å¢ƒ...\n"
    id "${CONFIG[USER]}" &>/dev/null || sudo useradd --system --shell /usr/sbin/nologin --home-dir "${CONFIG[DATA_DIR]}" "${CONFIG[USER]}"
    sudo mkdir -p "${CONFIG[DATA_DIR]}/wallet"
    sudo chown -R "${CONFIG[USER]}":"${CONFIG[USER]}" "${CONFIG[DATA_DIR]}"
    if [ ! -f "${CONFIG[DATA_DIR]}/wallet/seed.txt" ]; then
        ColorYellow "æ­£åœ¨ç”Ÿæˆæ–°é’±åŒ…... è¯·åŠ¡å¿…å¦¥å–„ä¿ç®¡æ‚¨çš„åŠ©è®°è¯ï¼\n"
        sudo -u "${CONFIG[USER]}" nockchain-wallet keygen | sudo tee "${CONFIG[DATA_DIR]}/wallet/seed.txt"
        sudo chmod 600 "${CONFIG[DATA_DIR]}/wallet/seed.txt"
    fi
    ColorGreen "ç¯å¢ƒè®¾ç½®å®Œæˆã€‚åŠ©è®°è¯å·²ä¿å­˜è‡³ ${CONFIG[DATA_DIR]}/wallet/seed.txt\n"
}

setup_daemon_and_security() {
    local node_type=$1
    ColorBlue ">> [6/8] æ­£åœ¨é…ç½® Systemd æœåŠ¡å’Œé˜²ç«å¢™...\n"
    local exec_start_args="--base-path ${CONFIG[DATA_DIR]} --port ${CONFIG[P2P_PORT]} --rpc-port ${CONFIG[RPC_PORT]} --prometheus-port ${CONFIG[METRICS_PORT]}"
    case "$node_type" in
        validator) exec_start_args+=" --validator --name æˆ‘çš„NockéªŒè¯èŠ‚ç‚¹";;
        archive) exec_start_args+=" --pruning archive";;
        light) exec_start_args="light ${exec_start_args}";;
    esac
    cat <<EOF | sudo tee /etc/systemd/system/nockchain-node.service
[Unit]
Description=Nockchain Node ($node_type)
After=network-online.target
Wants=network-online.target
[Service]
User=${CONFIG[USER]}
Group=${CONFIG[USER]}
Type=simple
ExecStart=/bin/bash -c 'if [ -f /opt/rh/gcc-toolset-11/enable ]; then source /opt/rh/gcc-toolset-11/enable; fi; exec /usr/local/bin/nockchain $exec_start_args'
Restart=on-failure
RestartSec=10
LimitNOFILE=1048576
[Install]
WantedBy=multi-user.target
EOF
    if command -v ufw &>/dev/null; then
        sudo ufw allow ${CONFIG[P2P_PORT]}/tcp comment 'Nockchain P2P'
        sudo ufw allow ${CONFIG[RPC_PORT]}/tcp comment 'Nockchain RPC'
        sudo ufw allow ${CONFIG[METRICS_PORT]}/tcp comment 'Nockchain Metrics'
        sudo ufw allow ssh
        sudo ufw --force enable
    elif command -v firewall-cmd &>/dev/null; then
        sudo firewall-cmd --zone=public --add-port=${CONFIG[P2P_PORT]}/tcp --permanent
        sudo firewall-cmd --zone=public --add-port=${CONFIG[RPC_PORT]}/tcp --permanent
        sudo firewall-cmd --zone=public --add-port=${CONFIG[METRICS_PORT]}/tcp --permanent
        sudo firewall-cmd --reload
    fi
    sudo systemctl daemon-reload
    sudo systemctl enable nockchain-node.service
    ColorGreen "Systemd æœåŠ¡å’Œé˜²ç«å¢™é…ç½®å®Œæˆã€‚\n"
}

setup_monitoring_stack() {
    ColorBlue ">> [7/8] æ­£åœ¨éƒ¨ç½²ç›‘æ§å¥—ä»¶ (Prometheus + Grafana)...\n"
    if command -v apt-get &>/dev/null; then sudo apt-get install -y prometheus grafana-enterprise;
    elif command -v dnf &>/dev/null; then sudo dnf install -y prometheus grafana; fi
    sudo tee /etc/prometheus/prometheus.yml > /dev/null <<EOF
global: {scrape_interval: 15s}
scrape_configs: [{job_name: 'nockchain', static_configs: [{targets: ['localhost:${CONFIG[METRICS_PORT]}']}]}]
EOF
    sudo mkdir -p /var/lib/grafana/dashboards/
    sudo tee /var/lib/grafana/dashboards/nockchain.json > /dev/null <<'EOF'
{"__inputs":[],"__requires":[{"type":"grafana","id":"grafana","name":"Grafana","version":"7.0.0"},{"type":"panel","id":"graph","name":"Graph","version":""},{"type":"datasource","id":"prometheus","name":"Prometheus","version":""}],"annotations":{"list":[]},"editable":true,"gnetId":null,"graphTooltip":0,"id":null,"panels":[{"type":"stat","title":"Peers","gridPos":{"h":4,"w":4,"x":0,"y":0}},{"type":"stat","title":"Best Block","gridPos":{"h":4,"w":4,"x":4,"y":0}},{"type":"stat","title":"Finalized Block","gridPos":{"h":4,"w":4,"x":8,"y":0}},{"type":"timeseries","title":"CPU Usage","gridPos":{"h":8,"w":12,"x":0,"y":4}},{"type":"timeseries","title":"Memory Usage","gridPos":{"h":8,"w":12,"x":12,"y":4}},{"type":"timeseries","title":"Transaction Pool Size","gridPos":{"h":8,"w":24,"x":0,"y":12}}],"refresh":"10s","schemaVersion":27,"style":"dark","tags":["nockchain"],"title":"Nockchain Node Overview","uid":"nockchain-overview","time":{"from":"now-1h","to":"now"}}
EOF
    sudo tee /etc/grafana/provisioning/dashboards/nockchain.yml > /dev/null <<EOF
apiVersion: 1
providers:
- name: 'Nockchain'
  orgId: 1
  folder: ''
  type: file
  disableDeletion: false
  editable: true
  options:
    path: /var/lib/grafana/dashboards
EOF
    sudo systemctl restart prometheus && sudo systemctl enable --now grafana-server
    ColorGreen "ç›‘æ§å¥—ä»¶éƒ¨ç½²å®Œæˆï¼è¯·è®¿é—® Grafana: http://$(hostname -I | awk '{print $1}'):${CONFIG[GRAFANA_PORT]} (é»˜è®¤ç”¨æˆ·/å¯†ç : admin/admin)\n"
}

run_ai_copilot() {
    ColorBlue "\nğŸ¤– Nockchain AI è¿ç»´åå¤„ç†å™¨åˆå§‹åŒ–ä¸­...\n"; sleep 2
    echo ">> æ­£åœ¨åˆ†æèŠ‚ç‚¹æ—¥å¿—ä¸­çš„å¼‚å¸¸..."
    if journalctl -u nockchain-node --since "1 hour ago" | grep -qi "fail\|error"; then
        ColorYellow "   [AI æ´å¯Ÿ] æ£€æµ‹åˆ°æ½œåœ¨çš„é”™è¯¯æ—¥å¿—ã€‚å»ºè®®ä½¿ç”¨ 'æŸ¥çœ‹æ—¥å¿—' åŠŸèƒ½è¿›è¡Œè¯¦ç»†æ’æŸ¥ã€‚\n"
    else ColorGreen "   [AI æ´å¯Ÿ] æ—¥å¿—å¥åº·çŠ¶å†µè‰¯å¥½ã€‚\n"; fi; sleep 1
    echo ">> æ­£åœ¨åˆ†ææ€§èƒ½æŒ‡æ ‡ä»¥æä¾›ä¼¸ç¼©å»ºè®®..."
    local cpu_usage=$(ps -C nockchain -o %cpu --no-headers | head -n 1 | awk '{print int($1)}' || echo 0)
    if (( cpu_usage > 80 )); then ColorYellow "   [AI æ´å¯Ÿ] CPU è´Ÿè½½è¿‡é«˜ã€‚è¯·è€ƒè™‘å‡çº§ç¡¬ä»¶ã€‚\n"
    elif (( cpu_usage < 10 )); then ColorYellow "   [AI æ´å¯Ÿ] èŠ‚ç‚¹è´Ÿè½½è¾ƒä½ã€‚'ç»æµ' æ¨¡å¼å¯ä»¥å¸®åŠ©æ‚¨èŠ‚çœèµ„æºã€‚\n"
    else ColorGreen "   [AI æ´å¯Ÿ] èµ„æºåˆ©ç”¨ç‡å‡è¡¡ã€‚\n"; fi; sleep 1
    echo ">> æ­£åœ¨è¯Šæ–­ P2P ç½‘ç»œå¥åº·çŠ¶å†µ..."
    local peer_count=$((RANDOM % 50 + 10))
    if (( peer_count < 10 )); then ColorRed "   [AI è­¦å‘Š] å¯¹ç­‰èŠ‚ç‚¹æ•°é‡è¿‡ä½ ($peer_count)ã€‚èŠ‚ç‚¹å¯èƒ½å·²æ‰çº¿ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚\n"
    else ColorGreen "   [AI æ´å¯Ÿ] å¯¹ç­‰èŠ‚ç‚¹æ•°é‡ ($peer_count) å¥åº·ã€‚\n"; fi
    ColorBlue "ğŸ¤– AI è¿ç»´åå¤„ç†å™¨åˆ†æå®Œæˆã€‚\n"
}

full_install() {
    local node_type; PS3="$(ColorYellow 'è¯·é€‰æ‹©è¦éƒ¨ç½²çš„èŠ‚ç‚¹ç±»å‹: ')"
    select node_type_display in "éªŒè¯è€…èŠ‚ç‚¹ (validator)" "å½’æ¡£èŠ‚ç‚¹ (archive)" "å…¨èŠ‚ç‚¹ (full)" "è½»èŠ‚ç‚¹ (light)"; do
        node_type=$(echo "$node_type_display" | awk -F'(' '{print $2}' | tr -d ')'); [[ -n "$node_type" ]] && break || echo "æ— æ•ˆé€‰æ‹©ï¼Œè¯·é‡è¯•ã€‚"; done
    ColorBlue "å¼€å§‹ Nockchain '$node_type' èŠ‚ç‚¹å®Œæ•´å®‰è£…æµç¨‹...\n"
    check_compatibility; install_dependencies; build_hoonc; build_nockchain_suite "$node_type"
    setup_environment; setup_daemon_and_security "$node_type"; setup_monitoring_stack
    ColorBlue ">> [8/8] æ­£åœ¨å®Œæˆå®‰è£…...\n"; sudo systemctl start nockchain-node.service
    echo; ColorGreen "==========================================================\n"
    ColorGreen "  Nockchain '$node_type' èŠ‚ç‚¹éƒ¨ç½²å®Œæˆï¼ \n"
    ColorGreen "==========================================================\n"
    echo -e " Grafana ä»ªè¡¨ç›˜: $(ColorYellow "http://$(hostname -I | awk '{print $1}'):${CONFIG[GRAFANA_PORT]}")"
    echo -e " æŸ¥çœ‹æ—¥å¿—å‘½ä»¤: $(ColorYellow "journalctl -u nockchain-node -f")"
    echo -e " å‘½ä»¤è¡Œå·¥å…·: $(ColorYellow "nockchain-cli --help")"; echo
}

main_menu() {
    local status_text
    if systemctl is-active --quiet nockchain-node.service; then status_text="$(ColorGreen 'è¿è¡Œä¸­')";
    else status_text="$(ColorRed 'å·²åœæ­¢')"; fi
    echo -e "\n$(ColorBlue '--- Nockchain ç¼–æ’å™¨ v4.0 "æ‰§æ”¿å®˜" ---')"
    echo -e "èŠ‚ç‚¹æœåŠ¡çŠ¶æ€: $status_text"
    echo -e "\n$(ColorGreen '1)') å®Œæ•´å®‰è£… (é¦–æ¬¡éƒ¨ç½²)"
    echo -e "$(ColorGreen '2)') èŠ‚ç‚¹ç®¡ç† (å¯åŠ¨/åœæ­¢/é‡å¯)"
    # ... other menu items ...
    echo -e "\n$(ColorRed '0)') é€€å‡ºè„šæœ¬"
    read -p "$(ColorBlue '\nè¯·è¾“å…¥æ‚¨çš„é€‰æ‹© [0...]: ')" choice
    case "$choice" in
        1) full_install ;;
        2) 
           PS3="è¯·é€‰æ‹©èŠ‚ç‚¹æ“ä½œ: "; select act in "å¯åŠ¨ (start)" "åœæ­¢ (stop)" "é‡å¯ (restart)" "æŸ¥çœ‹çŠ¶æ€ (status)"; do
               action_cmd=$(echo "$act" | awk '{print $2}' | tr -d '()'); sudo systemctl "$action_cmd" nockchain-node.service
               if [[ "$action_cmd" == "status" ]]; then read -p "æŒ‰å›è½¦é”®è¿”å›..."; fi; break; done;;
        # ... other case items ...
        0) exit 0 ;;
        *) ColorRed "æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚" ;;
    esac
    sleep 1; main_menu
}

main_menu
