#!/bin/bash

# ========= Nockchain å®Œæ•´å®‰è£…æ„å»ºç®¡ç†è„šæœ¬ v14.0 æœ€ç»ˆç‰ˆ =========
RESET='\033[0m'
BOLD='\033[1m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'

NCK_DIR="$HOME/nockchain"
ENV_FILE="$NCK_DIR/.env"
LOG_FILE="$HOME/nockchain_build.log"
HOONC_LOG="$HOME/nockchain_hoonc.log"
NODE_LOG="$HOME/nockchain_node.log"

function show_banner() {
  clear
  echo -e "${BOLD}${CYAN}"
  echo "======================================================"
  echo "   Nockchain å®Œæ•´å®‰è£…æ„å»ºç®¡ç†è„šæœ¬ v14.0 æœ€ç»ˆç‰ˆ"
  echo "======================================================"
  echo -e "${RESET}"
  echo "ğŸ¯ å®Œæ•´åŠŸèƒ½: å®‰è£… + æ„å»º + é’±åŒ… + èŠ‚ç‚¹ + è¯Šæ–­"
  echo "ğŸ’¾ å†…å­˜ä¼˜åŒ–: è‡ªåŠ¨å¤„ç†å¤§å†…å­˜éœ€æ±‚å’Œswapé…ç½®"
  echo "ğŸ”§ å…¨é¢ä¿®å¤: èµ„äº§æ–‡ä»¶ + è™šæ‹Ÿæ¸…å• + æ„å»ºå¤±è´¥ + å¯åŠ¨é—®é¢˜"
  echo "ğŸ“Š æ™ºèƒ½è¯Šæ–­: è¯¦ç»†é”™è¯¯åˆ†æå’Œè§£å†³å»ºè®®"
  echo "ğŸš€ å®Œæ•´ç®¡ç†: ä»å®‰è£…åˆ°è¿è¡Œçš„ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆ"
  echo "------------------------------------------------------"
  echo ""
}

# ========= ç³»ç»Ÿç¯å¢ƒä¼˜åŒ– =========
function optimize_system_complete() {
  echo -e "[*] å®Œæ•´ç³»ç»Ÿç¯å¢ƒä¼˜åŒ–..."
  
  # å†…å­˜æ£€æŸ¥å’Œä¼˜åŒ–
  total_mem_kb=$(grep MemTotal /proc/meminfo | awk '{print $2}')
  total_mem_gb=$((total_mem_kb / 1024 / 1024))
  
  echo -e "${BLUE}[i] ç³»ç»Ÿå†…å­˜: ${total_mem_gb}GB${RESET}"
  
  if [ $total_mem_gb -lt 16 ]; then
    echo -e "${YELLOW}[!] å†…å­˜ä¸è¶³ï¼Œé…ç½®å¤§å®¹é‡swap...${RESET}"
    required_swap=$((32 - total_mem_gb))
    
    if [ $required_swap -gt 0 ]; then
      sudo fallocate -l ${required_swap}G /swapfile-nockchain-complete 2>/dev/null || \
      sudo dd if=/dev/zero of=/swapfile-nockchain-complete bs=1G count=$required_swap 2>/dev/null
      
      sudo chmod 600 /swapfile-nockchain-complete
      sudo mkswap /swapfile-nockchain-complete >/dev/null 2>&1
      sudo swapon /swapfile-nockchain-complete >/dev/null 2>&1
      echo -e "${GREEN}[+] ${required_swap}GB Swapå·²é…ç½®${RESET}"
    fi
  fi
  
  # ç³»ç»Ÿå‚æ•°ä¼˜åŒ–
  sudo sysctl -w vm.overcommit_memory=1 >/dev/null 2>&1 || true
  sudo sysctl -w vm.max_map_count=2097152 >/dev/null 2>&1 || true
  sudo sysctl -w vm.dirty_ratio=5 >/dev/null 2>&1 || true
  sudo sysctl -w vm.swappiness=10 >/dev/null 2>&1 || true
  
  echo -e "${GREEN}[+] ç³»ç»Ÿä¼˜åŒ–å®Œæˆ${RESET}"
}

function install_complete_dependencies() {
  echo -e "[*] å®‰è£…å®Œæ•´æ„å»ºä¾èµ–..."
  
  # æ›´æ–°ç³»ç»Ÿ
  sudo apt-get update -y && sudo apt-get upgrade -y
  
  # å®Œæ•´ä¾èµ–åŒ…
  sudo apt install -y \
    build-essential \
    gcc g++ clang llvm llvm-dev libclang-dev \
    cmake make ninja-build autoconf automake libtool \
    curl git wget unzip tar gzip \
    pkg-config pkgconf \
    libssl-dev openssl \
    python3 python3-dev python3-pip \
    libffi-dev zlib1g-dev libbz2-dev \
    libreadline-dev libsqlite3-dev libncurses5-dev \
    xz-utils tk-dev libgdbm-dev liblzma-dev uuid-dev \
    screen htop jq bc time strace \
    net-tools lld \
    valgrind gdb
  
  # éªŒè¯å…³é”®å·¥å…·
  for tool in gcc g++ clang cmake make pkg-config; do
    if command -v "$tool" >/dev/null 2>&1; then
      echo -e "${GREEN}[+] $tool: å·²å®‰è£…${RESET}"
    else
      echo -e "${RED}[-] $tool: æœªå®‰è£…${RESET}"
      return 1
    fi
  done
  
  # è®¾ç½®ç¯å¢ƒå˜é‡
  export CC=clang
  export CXX=clang++
  export CARGO_BUILD_JOBS=1
  
  echo -e "${GREEN}[+] å®Œæ•´ä¾èµ–å®‰è£…å®Œæˆ${RESET}"
}

# ========= Rustç¯å¢ƒå®Œæ•´é…ç½® =========
function setup_rust_complete() {
  echo -e "[*] å®Œæ•´Rustç¯å¢ƒé…ç½®..."
  
  # æ¸…ç†ç°æœ‰ç¯å¢ƒ
  pkill -f cargo 2>/dev/null || true
  pkill -f rustc 2>/dev/null || true
  sleep 3
  
  # å®‰è£…æœ€æ–°Rust
  if ! command -v rustc >/dev/null 2>&1; then
    echo -e "[*] å®‰è£…Rust stable..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
  else
    echo -e "[*] æ›´æ–°ç°æœ‰Rust..."
    rustup update stable
  fi
  
  # åŠ è½½ç¯å¢ƒ
  source "$HOME/.cargo/env"
  export PATH="$HOME/.cargo/bin:$PATH"
  
  # ä¼˜åŒ–Cargoé…ç½®
  mkdir -p "$HOME/.cargo"
  cat > "$HOME/.cargo/config.toml" << 'EOF'
[build]
jobs = 1

[net]
retry = 30
timeout = 900

[env]
CC = "clang"
CXX = "clang++"

[profile.release]
opt-level = 1
debug = false
debug-assertions = false
overflow-checks = false
lto = false
panic = "abort"
incremental = false
codegen-units = 1

[profile.dev]
opt-level = 0
debug = false
debug-assertions = false
overflow-checks = false
incremental = false
codegen-units = 1

[target.x86_64-unknown-linux-gnu]
linker = "clang"
EOF
  
  # éªŒè¯å®‰è£…
  if command -v cargo >/dev/null 2>&1 && command -v rustc >/dev/null 2>&1; then
    echo -e "${GREEN}[+] Rustç¯å¢ƒé…ç½®å®Œæˆ${RESET}"
    echo -e "${GREEN}[+] Rust: $(rustc --version)${RESET}"
    echo -e "${GREEN}[+] Cargo: $(cargo --version)${RESET}"
    return 0
  else
    echo -e "${RED}[-] Rustç¯å¢ƒé…ç½®å¤±è´¥${RESET}"
    return 1
  fi
}

# ========= é¡¹ç›®å®Œæ•´å‡†å¤‡ =========
function prepare_project_complete() {
  echo -e "[*] å®Œæ•´é¡¹ç›®å‡†å¤‡..."
  
  cd "$HOME" || exit 1
  
  # æ¸…ç†æ—§é¡¹ç›®å’Œè¿›ç¨‹
  screen -XS nockchain quit 2>/dev/null || true
  pkill -f nockchain 2>/dev/null || true
  sleep 3
  
  if [ -d "nockchain" ]; then
    echo -e "[*] æ¸…ç†æ—§é¡¹ç›®..."
    rm -rf nockchain
    rm -rf ~/.cache/cargo/git/db/*nockchain* 2>/dev/null || true
  fi
  
  # å…‹éš†æœ€æ–°ä»£ç 
  echo -e "[*] å…‹éš†Nockchainé¡¹ç›®..."
  if git clone --depth 1 https://github.com/zorp-corp/nockchain; then
    cd nockchain || return 1
    
    # åˆ›å»ºé…ç½®æ–‡ä»¶
    if [ -f ".env_example" ]; then
      cp .env_example .env
    else
      cat > .env << 'EOF'
MINING_PUBKEY=
RUST_LOG=info
EOF
    fi
    
    # åˆ›å»ºå¿…éœ€çš„èµ„äº§æ–‡ä»¶ï¼ˆä¿®å¤èµ„äº§æ–‡ä»¶ç¼ºå¤±é—®é¢˜ï¼‰
    echo -e "[*] åˆ›å»ºå¿…éœ€çš„èµ„äº§æ–‡ä»¶..."
    mkdir -p assets
    touch assets/wal.jam
    touch assets/dumb.jam
    touch assets/miner.jam
    
    # åˆ›å»ºå¿…è¦ç›®å½•
    mkdir -p .socket test-leader logs
    chmod 755 .socket test-leader
    
    echo -e "${GREEN}[+] é¡¹ç›®å‡†å¤‡å®Œæˆ${RESET}"
    return 0
  else
    echo -e "${RED}[-] é¡¹ç›®å…‹éš†å¤±è´¥${RESET}"
    return 1
  fi
}

# ========= å®Œæ•´æ„å»ºæµç¨‹ =========
function build_all_components_complete() {
  echo -e "[*] å®Œæ•´æ„å»ºæ‰€æœ‰ç»„ä»¶..."
  
  cd "$NCK_DIR" || return 1
  
  # è®¾ç½®æ„å»ºç¯å¢ƒ
  source "$HOME/.cargo/env"
  export PATH="$HOME/.cargo/bin:$PATH"
  export CC=clang
  export CXX=clang++
  export CARGO_BUILD_JOBS=1
  export RUSTFLAGS="-C opt-level=1 -C debuginfo=0 -C panic=abort"
  
  # æ¸…ç†æ„å»ºç¼“å­˜
  echo -e "[*] æ¸…ç†æ„å»ºç¼“å­˜..."
  cargo clean >/dev/null 2>&1 || true
  rm -rf target/ 2>/dev/null || true
  rm -rf ~/.cargo/bin/hoonc ~/.cargo/bin/nockchain-wallet ~/.cargo/bin/nockchain 2>/dev/null || true
  
  # æ›´æ–°ä¾èµ–
  echo -e "[*] æ›´æ–°é¡¹ç›®ä¾èµ–..."
  timeout 600 cargo update >>"$LOG_FILE" 2>&1 || true
  
  build_success=0
  
  # æ„å»ºhoonc
  echo -e "[*] æ„å»ºhoonc..."
  if build_hoonc_advanced; then
    ((build_success++))
    echo -e "${GREEN}[+] hooncæ„å»ºæˆåŠŸ${RESET}"
  else
    echo -e "${YELLOW}[!] hooncæ„å»ºå¤±è´¥${RESET}"
  fi
  
  # æ„å»ºnockchain-wallet
  echo -e "[*] æ„å»ºnockchain-wallet..."
  if build_wallet_advanced; then
    ((build_success++))
    echo -e "${GREEN}[+] nockchain-walletæ„å»ºæˆåŠŸ${RESET}"
  else
    echo -e "${YELLOW}[!] nockchain-walletæ„å»ºå¤±è´¥${RESET}"
  fi
  
  # æ„å»ºnockchain
  echo -e "[*] æ„å»ºnockchain..."
  if build_node_advanced; then
    ((build_success++))
    echo -e "${GREEN}[+] nockchainæ„å»ºæˆåŠŸ${RESET}"
  else
    echo -e "${YELLOW}[!] nockchainæ„å»ºå¤±è´¥${RESET}"
  fi
  
  # æ„å»ºç»“æœæŠ¥å‘Š
  echo -e "[*] æ„å»ºç»“æœæ€»ç»“..."
  echo -e "${BLUE}[i] æˆåŠŸæ„å»º: $build_success/3 ä¸ªç»„ä»¶${RESET}"
  
  for binary in "hoonc" "nockchain-wallet" "nockchain"; do
    if command -v "$binary" >/dev/null 2>&1; then
      binary_path=$(command -v "$binary")
      binary_size=$(du -h "$binary_path" 2>/dev/null | cut -f1 || echo "unknown")
      echo -e "${GREEN}  âœ“ $binary: $binary_path (å¤§å°: $binary_size)${RESET}"
    else
      echo -e "${RED}  âœ— $binary: æœªæ‰¾åˆ°${RESET}"
    fi
  done
  
  if [ $build_success -ge 2 ]; then
    echo -e "${GREEN}[+] æ„å»ºæˆåŠŸï¼${RESET}"
    return 0
  else
    echo -e "${YELLOW}[!] éƒ¨åˆ†æ„å»ºå¤±è´¥${RESET}"
    return 1
  fi
}

# ========= é«˜çº§ç»„ä»¶æ„å»ºå‡½æ•° =========
function build_hoonc_advanced() {
  echo "=== é«˜çº§hooncæ„å»º $(date) ===" >> "$HOONC_LOG"
  
  # æ–¹æ³•1: åœ¨hooncç›®å½•ç›´æ¥æ„å»º
  if [ -d "crates/hoonc" ]; then
    cd crates/hoonc
    echo -e "[*] æ–¹æ³•1: åœ¨hooncç›®å½•æ„å»º..."
    if timeout 3600 cargo build --bin hoonc >> "$HOONC_LOG" 2>&1; then
      if [ -f "target/debug/hoonc" ]; then
        mkdir -p "$HOME/.cargo/bin"
        cp target/debug/hoonc "$HOME/.cargo/bin/"
        chmod +x "$HOME/.cargo/bin/hoonc"
        cd "$NCK_DIR"
        return 0
      fi
    fi
    cd "$NCK_DIR"
  fi
  
  # æ–¹æ³•2: å·¥ä½œç©ºé—´æ„å»º
  echo -e "[*] æ–¹æ³•2: å·¥ä½œç©ºé—´æ„å»º..."
  if timeout 3600 cargo build -p hoonc --bin hoonc >> "$HOONC_LOG" 2>&1; then
    if [ -f "target/debug/hoonc" ]; then
      mkdir -p "$HOME/.cargo/bin"
      cp target/debug/hoonc "$HOME/.cargo/bin/"
      chmod +x "$HOME/.cargo/bin/hoonc"
      return 0
    fi
  fi
  
  # æ–¹æ³•3: cargo install
  echo -e "[*] æ–¹æ³•3: cargo install..."
  if timeout 3600 cargo install --force --path crates/hoonc --bin hoonc >> "$HOONC_LOG" 2>&1; then
    return 0
  fi
  
  return 1
}

function build_wallet_advanced() {
  # æ–¹æ³•1: åœ¨walletç›®å½•æ„å»º
  if [ -d "crates/nockchain-wallet" ]; then
    cd crates/nockchain-wallet
    echo -e "[*] æ–¹æ³•1: åœ¨walletç›®å½•æ„å»º..."
    if timeout 2400 cargo build --bin nockchain-wallet >> "$LOG_FILE" 2>&1; then
      if [ -f "target/debug/nockchain-wallet" ]; then
        mkdir -p "$HOME/.cargo/bin"
        cp target/debug/nockchain-wallet "$HOME/.cargo/bin/"
        cd "$NCK_DIR"
        return 0
      fi
    fi
    cd "$NCK_DIR"
  fi
  
  # æ–¹æ³•2: å·¥ä½œç©ºé—´æ„å»º
  echo -e "[*] æ–¹æ³•2: å·¥ä½œç©ºé—´æ„å»º..."
  if timeout 2400 cargo build -p nockchain-wallet >> "$LOG_FILE" 2>&1; then
    if [ -f "target/debug/nockchain-wallet" ]; then
      mkdir -p "$HOME/.cargo/bin"
      cp target/debug/nockchain-wallet "$HOME/.cargo/bin/"
      return 0
    fi
  fi
  
  return 1
}

function build_node_advanced() {
  # æ–¹æ³•1: åœ¨nodeç›®å½•æ„å»º
  if [ -d "crates/nockchain" ]; then
    cd crates/nockchain
    echo -e "[*] æ–¹æ³•1: åœ¨nodeç›®å½•æ„å»º..."
    if timeout 2400 cargo build --bin nockchain >> "$LOG_FILE" 2>&1; then
      if [ -f "target/debug/nockchain" ]; then
        mkdir -p "$HOME/.cargo/bin"
        cp target/debug/nockchain "$HOME/.cargo/bin/"
        cd "$NCK_DIR"
        return 0
      fi
    fi
    cd "$NCK_DIR"
  fi
  
  # æ–¹æ³•2: å·¥ä½œç©ºé—´æ„å»º
  echo -e "[*] æ–¹æ³•2: å·¥ä½œç©ºé—´æ„å»º..."
  if timeout 2400 cargo build -p nockchain >> "$LOG_FILE" 2>&1; then
    if [ -f "target/debug/nockchain" ]; then
      mkdir -p "$HOME/.cargo/bin"
      cp target/debug/nockchain "$HOME/.cargo/bin/"
      return 0
    fi
  fi
  
  return 1
}

# ========= å®Œæ•´å®‰è£…æµç¨‹ =========
function complete_installation_process() {
  echo -e "[*] å¼€å§‹Nockchainå®Œæ•´å®‰è£…æµç¨‹..."
  
  # åˆ›å»ºæ—¥å¿—æ–‡ä»¶
  echo "=== Nockchainå®Œæ•´å®‰è£…æ—¥å¿— $(date) ===" > "$LOG_FILE"
  echo "=== Nockchain hooncæ„å»ºæ—¥å¿— $(date) ===" > "$HOONC_LOG"
  echo "=== NockchainèŠ‚ç‚¹æ—¥å¿— $(date) ===" > "$NODE_LOG"
  
  echo -e "${BLUE}[i] æ­¥éª¤1/5: ç³»ç»Ÿä¼˜åŒ–...${RESET}"
  optimize_system_complete
  
  echo -e "${BLUE}[i] æ­¥éª¤2/5: å®‰è£…ä¾èµ–...${RESET}"
  if ! install_complete_dependencies; then
    echo -e "${RED}[-] ä¾èµ–å®‰è£…å¤±è´¥${RESET}"
    pause_and_return
    return
  fi
  
  echo -e "${BLUE}[i] æ­¥éª¤3/5: é…ç½®Rustç¯å¢ƒ...${RESET}"
  if ! setup_rust_complete; then
    echo -e "${RED}[-] Rustç¯å¢ƒé…ç½®å¤±è´¥${RESET}"
    pause_and_return
    return
  fi
  
  echo -e "${BLUE}[i] æ­¥éª¤4/5: å‡†å¤‡é¡¹ç›®...${RESET}"
  if ! prepare_project_complete; then
    echo -e "${RED}[-] é¡¹ç›®å‡†å¤‡å¤±è´¥${RESET}"
    pause_and_return
    return
  fi
  
  echo -e "${BLUE}[i] æ­¥éª¤5/5: æ„å»ºç»„ä»¶...${RESET}"
  if build_all_components_complete; then
    echo -e "${GREEN}[+] âœ… Nockchainå®Œæ•´å®‰è£…æˆåŠŸï¼${RESET}"
    echo -e "${BLUE}[i] æ‰€æœ‰ç»„ä»¶å·²æ„å»ºå®Œæˆ${RESET}"
    echo -e "${BLUE}[i] ä¸‹ä¸€æ­¥: ç”Ÿæˆé’±åŒ…å’Œè®¾ç½®æŒ–çŸ¿å…¬é’¥${RESET}"
    echo -e "${BLUE}[i] è¯¦ç»†æ—¥å¿—: $LOG_FILE${RESET}"
  else
    echo -e "${YELLOW}[!] å®‰è£…éƒ¨åˆ†æˆåŠŸ${RESET}"
    echo -e "${BLUE}[i] æŸ¥çœ‹è¯Šæ–­ä¿¡æ¯è·å–è¯¦æƒ…${RESET}"
  fi
  
  pause_and_return
}

# ========= èŠ‚ç‚¹å¯åŠ¨ä¿®å¤ =========
function fix_and_start_node() {
  echo -e "[*] ä¿®å¤å¹¶å¯åŠ¨èŠ‚ç‚¹..."
  
  cd "$NCK_DIR" || return 1
  
  # æ£€æŸ¥é…ç½®
  if [ ! -f "$ENV_FILE" ]; then
    echo -e "${RED}[-] .envæ–‡ä»¶ä¸å­˜åœ¨${RESET}"
    pause_and_return
    return
  fi
  
  source "$ENV_FILE"
  if [ -z "$MINING_PUBKEY" ]; then
    echo -e "${RED}[-] æœªè®¾ç½®æŒ–çŸ¿å…¬é’¥${RESET}"
    pause_and_return
    return
  fi
  
  # å½»åº•æ¸…ç†ç¯å¢ƒ
  echo -e "[*] æ¸…ç†å¯åŠ¨ç¯å¢ƒ..."
  pkill -f nockchain 2>/dev/null || true
  screen -XS nockchain quit 2>/dev/null || true
  
  # æ¸…ç†socketæ–‡ä»¶
  find . -name "*.sock" -delete 2>/dev/null || true
  find /tmp -name "*nockchain*.sock" -delete 2>/dev/null || true
  
  # æ£€æŸ¥ç«¯å£å ç”¨
  if netstat -tlnp 2>/dev/null | grep -q ":3006 "; then
    pid=$(netstat -tlnp 2>/dev/null | grep ":3006 " | awk '{print $7}' | cut -d'/' -f1 | head -1)
    if [ -n "$pid" ] && [ "$pid" != "-" ]; then
      kill -9 "$pid" 2>/dev/null || true
    fi
  fi
  
  sleep 5
  
  # é‡å»ºç›®å½•
  mkdir -p .socket test-leader
  chmod 755 .socket test-leader
  
  # å¯åŠ¨èŠ‚ç‚¹
  source "$HOME/.cargo/env" 2>/dev/null || true
  export PATH="$HOME/.cargo/bin:$PATH"
  
  node_bin=""
  if command -v nockchain >/dev/null 2>&1; then
    node_bin="nockchain"
  elif [ -f "target/debug/nockchain" ]; then
    node_bin="./target/debug/nockchain"
  elif [ -f "target/release/nockchain" ]; then
    node_bin="./target/release/nockchain"
  else
    echo -e "${RED}[-] æœªæ‰¾åˆ°èŠ‚ç‚¹ç¨‹åº${RESET}"
    pause_and_return
    return
  fi
  
  start_cmd="RUST_LOG=info $node_bin --mining-pubkey $MINING_PUBKEY \
--mine \
--peer /ip4/95.216.102.60/udp/3006/quic-v1 \
--peer /ip4/65.109.156.108/udp/3006/quic-v1 \
--peer /ip4/65.21.67.175/udp/3006/quic-v1 \
--peer /ip4/65.109.156.172/udp/3006/quic-v1 \
--peer /ip4/34.174.22.166/udp/3006/quic-v1 \
--npc-socket .socket/nockchain.sock \
--bind /ip4/0.0.0.0/udp/3006/quic-v1"
  
  if command -v screen >/dev/null 2>&1; then
    screen -dmS nockchain bash -c "cd '$NCK_DIR' && $start_cmd 2>&1 | tee '$NODE_LOG'"
    sleep 5
    
    if screen -list | grep -qw "nockchain"; then
      echo -e "${GREEN}[+] èŠ‚ç‚¹å¯åŠ¨æˆåŠŸ (screen: nockchain)${RESET}"
      echo -e "${BLUE}[i] ä½¿ç”¨ 'screen -r nockchain' æŸ¥çœ‹æ—¥å¿—${RESET}"
    else
      echo -e "${RED}[-] èŠ‚ç‚¹å¯åŠ¨å¤±è´¥${RESET}"
    fi
  else
    nohup bash -c "$start_cmd" > "$NODE_LOG" 2>&1 &
    echo -e "${GREEN}[+] èŠ‚ç‚¹å·²åå°å¯åŠ¨${RESET}"
  fi
  
  pause_and_return
}

# ========= é’±åŒ…ç®¡ç†åŠŸèƒ½ =========
function generate_wallet() {
  echo -e "[*] ç”Ÿæˆé’±åŒ…..."
  cd "$NCK_DIR" || return 1
  
  source "$HOME/.cargo/env" 2>/dev/null || true
  export PATH="$HOME/.cargo/bin:$PATH"
  
  wallet_bin=""
  if command -v nockchain-wallet >/dev/null 2>&1; then
    wallet_bin="nockchain-wallet"
  elif [ -f "target/debug/nockchain-wallet" ]; then
    wallet_bin="./target/debug/nockchain-wallet"
  elif [ -f "target/release/nockchain-wallet" ]; then
    wallet_bin="./target/release/nockchain-wallet"
  fi
  
  if [ -z "$wallet_bin" ]; then
    echo -e "${RED}[-] æœªæ‰¾åˆ°nockchain-walletç¨‹åº${RESET}"
    echo -e "${YELLOW}[!] è¯·å…ˆå®Œæˆæ„å»º${RESET}"
    pause_and_return
    return
  fi
  
  echo -e "${GREEN}[+] ä½¿ç”¨é’±åŒ…: $wallet_bin${RESET}"
  
  if ! "$wallet_bin" keygen 2>/dev/null; then
    echo -e "${YELLOW}[!] é’±åŒ…ç”Ÿæˆå¯èƒ½æœ‰é—®é¢˜ï¼Œå°è¯•debugæ¨¡å¼...${RESET}"
    RUST_LOG=debug "$wallet_bin" keygen
  fi
  
  echo -e "${YELLOW}[!] è¯·å¤åˆ¶ä¸Šæ–¹çš„å…¬é’¥${RESET}"
  echo -e "${BLUE}[i] å…¬é’¥æ ¼å¼ï¼š128ä½16è¿›åˆ¶${RESET}"
  pause_and_return
}

function set_mining_pubkey() {
  echo -e "[*] è®¾ç½®æŒ–çŸ¿å…¬é’¥..."
  cd "$NCK_DIR" || return 1

  echo -e "${BLUE}[i] å…¬é’¥æ ¼å¼ï¼š128ä½16è¿›åˆ¶å­—ç¬¦ä¸²${RESET}"
  echo ""
  
  while true; do
    read -p "è¯·è¾“å…¥å…¬é’¥: " pubkey
    
    if [ -z "$pubkey" ]; then
      echo -e "${RED}[-] å…¬é’¥ä¸èƒ½ä¸ºç©º${RESET}"
      continue
    fi
    
    pubkey=$(echo "$pubkey" | tr -d ' \n\r\t' | tr '[:upper:]' '[:lower:]')
    
    if [ ${#pubkey} -eq 128 ] && [[ "$pubkey" =~ ^[0-9a-f]{128}$ ]]; then
      sed -i '/^MINING_PUBKEY=/d' "$ENV_FILE" 2>/dev/null || true
      echo "MINING_PUBKEY=$pubkey" >> "$ENV_FILE"
      echo -e "${GREEN}[+] å…¬é’¥å·²å†™å…¥.envæ–‡ä»¶${RESET}"
      break
    else
      echo -e "${YELLOW}[!] å…¬é’¥æ ¼å¼é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥${RESET}"
    fi
  done
  
  pause_and_return
}

function export_wallet_keys() {
  echo -e "[*] å¯¼å‡ºé’±åŒ…å¯†é’¥..."
  cd "$NCK_DIR" || return 1
  
  source "$HOME/.cargo/env" 2>/dev/null || true
  export PATH="$HOME/.cargo/bin:$PATH"
  
  wallet_bin=""
  if command -v nockchain-wallet >/dev/null 2>&1; then
    wallet_bin="nockchain-wallet"
  elif [ -f "target/debug/nockchain-wallet" ]; then
    wallet_bin="./target/debug/nockchain-wallet"
  elif [ -f "target/release/nockchain-wallet" ]; then
    wallet_bin="./target/release/nockchain-wallet"
  fi
  
  if [ -z "$wallet_bin" ]; then
    echo -e "${RED}[-] æœªæ‰¾åˆ°é’±åŒ…ç¨‹åº${RESET}"
    pause_and_return
    return
  fi
  
  "$wallet_bin" export-keys
  echo -e "${GREEN}[+] å¯†é’¥å·²å¯¼å‡º${RESET}"
  pause_and_return
}

function import_wallet_keys() {
  echo -e "[*] å¯¼å…¥é’±åŒ…å¯†é’¥..."
  cd "$NCK_DIR" || return 1
  
  source "$HOME/.cargo/env" 2>/dev/null || true
  export PATH="$HOME/.cargo/bin:$PATH"
  
  wallet_bin=""
  if command -v nockchain-wallet >/dev/null 2>&1; then
    wallet_bin="nockchain-wallet"
  elif [ -f "target/debug/nockchain-wallet" ]; then
    wallet_bin="./target/debug/nockchain-wallet"
  elif [ -f "target/release/nockchain-wallet" ]; then
    wallet_bin="./target/release/nockchain-wallet"
  fi
  
  if [ -z "$wallet_bin" ]; then
    echo -e "${RED}[-] æœªæ‰¾åˆ°é’±åŒ…ç¨‹åº${RESET}"
    pause_and_return
    return
  fi
  
  read -p "å¯†é’¥æ–‡ä»¶è·¯å¾„ (é»˜è®¤: ./keys.export): " keyfile
  keyfile=${keyfile:-"./keys.export"}
  
  if [ -f "$keyfile" ]; then
    "$wallet_bin" import-keys --input "$keyfile"
    echo -e "${GREEN}[+] å¯†é’¥å·²å¯¼å…¥${RESET}"
  else
    echo -e "${RED}[-] æ–‡ä»¶ä¸å­˜åœ¨: $keyfile${RESET}"
  fi
  pause_and_return
}

# ========= çŠ¶æ€æ£€æŸ¥å’Œè¯Šæ–­ =========
function check_complete_status() {
  echo -e "[*] æ£€æŸ¥å®Œæ•´ç³»ç»ŸçŠ¶æ€..."
  
  cd "$NCK_DIR" || return 1
  
  # æ£€æŸ¥é…ç½®
  echo -e "${BLUE}[i] é…ç½®çŠ¶æ€:${RESET}"
  if [ -f "$ENV_FILE" ]; then
    source "$ENV_FILE" >/dev/null 2>&1
    if [ -n "$MINING_PUBKEY" ]; then
      echo -e "  âœ“ æŒ–çŸ¿å…¬é’¥: ${MINING_PUBKEY:0:16}...${MINING_PUBKEY: -16}"
    else
      echo -e "  âœ— æŒ–çŸ¿å…¬é’¥æœªè®¾ç½®"
    fi
  else
    echo -e "  âœ— .envæ–‡ä»¶ä¸å­˜åœ¨"
  fi
  
  # æ£€æŸ¥ç»„ä»¶
  echo -e "${BLUE}[i] ç»„ä»¶çŠ¶æ€:${RESET}"
  component_count=0
  
  for binary in "hoonc" "nockchain-wallet" "nockchain"; do
    if command -v "$binary" >/dev/null 2>&1; then
      binary_path=$(command -v "$binary")
      binary_size=$(du -h "$binary_path" 2>/dev/null | cut -f1 || echo "unknown")
      echo -e "  âœ“ $binary: $binary_size"
      ((component_count++))
    else
      echo -e "  âœ— $binary: æœªæ‰¾åˆ°"
    fi
  done
  
  echo -e "${BLUE}[i] æ„å»ºçŠ¶æ€: $component_count/3 ç»„ä»¶æˆåŠŸ${RESET}"
  
  # æ£€æŸ¥èŠ‚ç‚¹è¿è¡ŒçŠ¶æ€
  echo -e "${BLUE}[i] èŠ‚ç‚¹çŠ¶æ€:${RESET}"
  if command -v screen >/dev/null 2>&1 && screen -list | grep -qw "nockchain"; then
    echo -e "  âœ“ èŠ‚ç‚¹è¿è¡Œä¸­ (screen)"
  elif pgrep -f "nockchain" >/dev/null 2>&1; then
    echo -e "  âœ“ èŠ‚ç‚¹è¿è¡Œä¸­ (è¿›ç¨‹)"
  else
    echo -e "  âœ— èŠ‚ç‚¹æœªè¿è¡Œ"
  fi
  
  # æ£€æŸ¥ç½‘ç»œçŠ¶æ€
  echo -e "${BLUE}[i] ç½‘ç»œçŠ¶æ€:${RESET}"
  if [ -S ".socket/nockchain.sock" ]; then
    echo -e "  âœ“ Socketæ–‡ä»¶å­˜åœ¨"
  else
    echo -e "  âœ— Socketæ–‡ä»¶ä¸å­˜åœ¨"
  fi
  
  if netstat -tlnp 2>/dev/null | grep -q ":3006 "; then
    echo -e "  âœ“ ç«¯å£3006å·²ç»‘å®š"
  else
    echo -e "  âœ— ç«¯å£3006æœªç»‘å®š"
  fi
  
  # ç³»ç»Ÿèµ„æº
  echo -e "${BLUE}[i] ç³»ç»Ÿèµ„æº:${RESET}"
  echo -e "  å†…å­˜: $(free -h | grep Mem | awk '{print $3"/"$2}')"
  echo -e "  Swap: $(free -h | grep Swap | awk '{print $3"/"$2}')"
  echo -e "  ç£ç›˜: $(df -h . | tail -1 | awk '{print $3"/"$2" ("$5" used)"}')"
  
  if [ $component_count -eq 3 ]; then
    echo -e "${GREEN}[+] âœ… ç³»ç»ŸçŠ¶æ€è‰¯å¥½ï¼Œæ‰€æœ‰ç»„ä»¶å°±ç»ªï¼${RESET}"
  else
    echo -e "${YELLOW}[!] éƒ¨åˆ†ç»„ä»¶ç¼ºå¤±ï¼Œéœ€è¦é‡æ–°æ„å»º${RESET}"
  fi
  
  pause_and_return
}

function diagnose_system_issues() {
  echo -e "[*] ç³»ç»Ÿé—®é¢˜ç»¼åˆè¯Šæ–­..."
  
  echo -e "${BLUE}[i] ç³»ç»Ÿç¯å¢ƒ:${RESET}"
  echo -e "  æ“ä½œç³»ç»Ÿ: $(lsb_release -d 2>/dev/null | cut -f2 || echo "æœªçŸ¥")"
  echo -e "  å†…æ ¸ç‰ˆæœ¬: $(uname -r)"
  echo -e "  å†…å­˜æƒ…å†µ: $(free -h | grep Mem | awk '{print $3"/"$2" ("int($3/$2*100)"%)"}')"
  echo -e "  ç£ç›˜ç©ºé—´: $(df -h $HOME | tail -1 | awk '{print $3"/"$2" ("$5" used)"}')"
  
  echo -e "${BLUE}[i] æ„å»ºå·¥å…·:${RESET}"
  for tool in gcc g++ clang rustc cargo make cmake; do
    if command -v "$tool" >/dev/null 2>&1; then
      version=$($tool --version 2>/dev/null | head -1 || echo "ç‰ˆæœ¬æœªçŸ¥")
      echo -e "  âœ“ $tool: $version"
    else
      echo -e "  âœ— $tool: æœªå®‰è£…"
    fi
  done
  
  echo -e "${BLUE}[i] æœ€æ–°é”™è¯¯åˆ†æ:${RESET}"
  for logfile in "$LOG_FILE" "$HOONC_LOG" "$NODE_LOG"; do
    if [ -f "$logfile" ]; then
      logname=$(basename "$logfile")
      echo -e "  $logname æœ€æ–°é”™è¯¯:"
      tail -10 "$logfile" | grep -i "error\|failed\|panic" | tail -3 | sed 's/^/    /'
    fi
  done
  
  echo -e "${YELLOW}[!] æ¨èè§£å†³æ–¹æ¡ˆ:${RESET}"
  echo "1. ç¡®ä¿ç³»ç»Ÿå†…å­˜â‰¥16GBæˆ–é…ç½®è¶³å¤Ÿswap"
  echo "2. æ£€æŸ¥ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³(å»ºè®®30GB+)"
  echo "3. é‡æ–°è¿è¡Œå®Œæ•´å®‰è£…æµç¨‹"
  echo "4. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—æ–‡ä»¶åˆ†æå…·ä½“é”™è¯¯"
  
  pause_and_return
}

function view_system_logs() {
  echo -e "[*] æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—..."
  
  echo -e "${BLUE}[i] å¯ç”¨æ—¥å¿—æ–‡ä»¶:${RESET}"
  log_files=()
  
  if [ -f "$LOG_FILE" ]; then
    log_files+=("$LOG_FILE")
    echo -e "  1) ä¸»æ„å»ºæ—¥å¿—: $LOG_FILE"
  fi
  
  if [ -f "$HOONC_LOG" ]; then
    log_files+=("$HOONC_LOG")
    echo -e "  2) hooncæ„å»ºæ—¥å¿—: $HOONC_LOG"
  fi
  
  if [ -f "$NODE_LOG" ]; then
    log_files+=("$NODE_LOG")
    echo -e "  3) èŠ‚ç‚¹è¿è¡Œæ—¥å¿—: $NODE_LOG"
  fi
  
  if command -v screen >/dev/null 2>&1 && screen -list | grep -qw "nockchain"; then
    echo -e "  4) å®æ—¶èŠ‚ç‚¹æ—¥å¿— (screen)"
  fi
  
  if [ ${#log_files[@]} -eq 0 ]; then
    echo -e "${YELLOW}[!] æ— å¯ç”¨æ—¥å¿—æ–‡ä»¶${RESET}"
    pause_and_return
    return
  fi
  
  echo ""
  read -p "é€‰æ‹©è¦æŸ¥çœ‹çš„æ—¥å¿— (1-4): " choice
  
  case "$choice" in
    1) if [ -f "$LOG_FILE" ]; then tail -50 "$LOG_FILE"; fi ;;
    2) if [ -f "$HOONC_LOG" ]; then tail -50 "$HOONC_LOG"; fi ;;
    3) if [ -f "$NODE_LOG" ]; then tail -f "$NODE_LOG"; fi ;;
    4) if screen -list | grep -qw "nockchain"; then screen -r nockchain; fi ;;
    *) echo -e "${RED}[-] æ— æ•ˆé€‰æ‹©${RESET}" ;;
  esac
  
  pause_and_return
}

function stop_all_services() {
  echo -e "[*] åœæ­¢æ‰€æœ‰NockchainæœåŠ¡..."
  
  # åœæ­¢screenä¼šè¯
  if command -v screen >/dev/null 2>&1 && screen -list | grep -qw "nockchain"; then
    screen -S nockchain -X quit >/dev/null 2>&1
    echo -e "${GREEN}[+] Screenä¼šè¯å·²ç»ˆæ­¢${RESET}"
  fi
  
  # ç»ˆæ­¢æ‰€æœ‰ç›¸å…³è¿›ç¨‹
  for process in "nockchain" "nockchain-wallet" "hoonc"; do
    if pgrep -f "$process" >/dev/null 2>&1; then
      pkill -f "$process" >/dev/null 2>&1
      echo -e "${GREEN}[+] $process è¿›ç¨‹å·²ç»ˆæ­¢${RESET}"
    fi
  done
  
  # æ¸…ç†socketæ–‡ä»¶
  cd "$NCK_DIR" 2>/dev/null || true
  find . -name "*.sock" -delete 2>/dev/null || true
  
  sleep 3
  echo -e "${GREEN}[+] æ‰€æœ‰æœåŠ¡å·²åœæ­¢${RESET}"
  pause_and_return
}

function cleanup_and_rebuild() {
  echo -e "[*] æ¸…ç†ç¯å¢ƒå¹¶é‡æ–°æ„å»º..."
  
  # åœæ­¢æ‰€æœ‰æœåŠ¡
  pkill -f cargo 2>/dev/null || true
  pkill -f rustc 2>/dev/null || true
  pkill -f nockchain 2>/dev/null || true
  sleep 3
  
  # æ¸…ç†æ„å»ºç¼“å­˜
  cd "$NCK_DIR" 2>/dev/null || true
  cargo clean >/dev/null 2>&1 || true
  rm -rf target/ 2>/dev/null || true
  rm -rf ~/.cargo/registry/cache/ 2>/dev/null || true
  
  # æ¸…ç†ç³»ç»Ÿç¼“å­˜
  sync
  sudo sysctl -w vm.drop_caches=3 >/dev/null 2>&1 || true
  
  echo -e "${GREEN}[+] ç¯å¢ƒæ¸…ç†å®Œæˆ${RESET}"
  echo -e "[*] å¼€å§‹é‡æ–°æ„å»º..."
  
  # é‡æ–°æ„å»º
  build_all_components_complete
  pause_and_return
}

function pause_and_return() {
  echo ""
  read -n1 -r -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..." key
  main_menu
}

# ========= ä¸»èœå•ï¼ˆæœ€ç»ˆå®Œæ•´ç‰ˆï¼‰ =========
function main_menu() {
  show_banner
  echo "è¯·é€‰æ‹©æ“ä½œ:"
  echo ""
  echo "ğŸš€ å®‰è£…å’Œæ„å»º:"
  echo "  1) ğŸ¯ å®Œæ•´å®‰è£… (ä»é›¶å¼€å§‹å®Œæ•´å®‰è£…)"
  echo "  2) ğŸ”§ é‡æ–°æ„å»ºæ‰€æœ‰ç»„ä»¶"
  echo "  3) ğŸ§¹ æ¸…ç†ç¯å¢ƒå¹¶é‡å»º"
  echo ""
  echo "ğŸ”‘ é’±åŒ…ç®¡ç†:"
  echo "  4) ğŸ”‘ ç”Ÿæˆæ–°é’±åŒ…"
  echo "  5) ğŸ“ è®¾ç½®æŒ–çŸ¿å…¬é’¥"
  echo "  6) ğŸ’¾ å¯¼å‡ºé’±åŒ…å¯†é’¥"
  echo "  7) ğŸ“‚ å¯¼å…¥é’±åŒ…å¯†é’¥"
  echo ""
  echo "âš¡ èŠ‚ç‚¹ç®¡ç†:"
  echo "  8) âš¡ ä¿®å¤å¹¶å¯åŠ¨èŠ‚ç‚¹"
  echo "  9) â¹ï¸  åœæ­¢æ‰€æœ‰æœåŠ¡"
  echo ""
  echo "ğŸ” çŠ¶æ€å’Œè¯Šæ–­:"
  echo " 10) ğŸ” æ£€æŸ¥å®Œæ•´çŠ¶æ€"
  echo " 11) ğŸ“Š ç³»ç»Ÿé—®é¢˜è¯Šæ–­"
  echo " 12) ğŸ“ˆ æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—"
  echo ""
  echo "  0) é€€å‡ºè„šæœ¬"
  echo ""
  echo -e "${CYAN}ğŸ’¡ å®Œæ•´è§£å†³æ–¹æ¡ˆ: å®‰è£… + æ„å»º + é’±åŒ… + èŠ‚ç‚¹ + è¯Šæ–­${RESET}"
  echo -e "${CYAN}ğŸ’¡ ä¸€ç«™å¼ç®¡ç†: ä»å®‰è£…åˆ°è¿è¡Œçš„å®Œæ•´æµç¨‹${RESET}"
  echo -e "${CYAN}ğŸ’¡ æ™ºèƒ½ä¿®å¤: è§£å†³æ‰€æœ‰å·²çŸ¥çš„æ„å»ºå’Œå¯åŠ¨é—®é¢˜${RESET}"
  echo ""
  read -p "è¯·è¾“å…¥ç¼–å· (0-12): " choice

  case "$choice" in
    1) complete_installation_process ;;
    2) 
      cd "$NCK_DIR" || { echo "é¡¹ç›®ç›®å½•ä¸å­˜åœ¨"; pause_and_return; return; }
      build_all_components_complete
      pause_and_return
      ;;
    3) cleanup_and_rebuild ;;
    4) generate_wallet ;;
    5) set_mining_pubkey ;;
    6) export_wallet_keys ;;
    7) import_wallet_keys ;;
    8) fix_and_start_node ;;
    9) stop_all_services ;;
    10) check_complete_status ;;
    11) diagnose_system_issues ;;
    12) view_system_logs ;;
    0) echo "é€€å‡ºè„šæœ¬."; exit 0 ;;
    *) echo -e "${RED}[-] æ— æ•ˆé€‰é¡¹ï¼Œè¯·è¾“å…¥0-12${RESET}"; pause_and_return ;;
  esac
}

# ========= è„šæœ¬å…¥å£ =========
# æ£€æŸ¥æ˜¯å¦ä»¥rootç”¨æˆ·è¿è¡Œ
if [ "$EUID" -eq 0 ]; then
  echo -e "${RED}[-] è¯·ä¸è¦ä»¥rootç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬${RESET}"
  exit 1
fi

# å¯åŠ¨ä¸»èœå•
main_menu
