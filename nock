#!/bin/bash

# ========= Nockchain äºŒè¿›åˆ¶ä¿®å¤ç‰ˆè„šæœ¬ v28.0 =========
RESET='\033[0m'
BOLD='\033[1m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'

NCK_DIR="$HOME/nockchain"
ENV_FILE="$NCK_DIR/.env"
BUILD_LOG="$HOME/nockchain_build.log"
NODE_LOG="$NCK_DIR/logs/nockchain.log"

# ---------- è¾…åŠ©å‡½æ•° ----------
log() { echo -e "${BLUE}[*] $*${RESET}"; }
ok()  { echo -e "${GREEN}[âœ“] $*${RESET}"; }
warn(){ echo -e "${YELLOW}[!] $*${RESET}"; }
err() { echo -e "${RED}[âœ—] $*${RESET}"; }
pause() { echo; read -n1 -r -p "æŒ‰ä»»æ„é”®è¿”å›èœå•..." _; }

# ---------- äºŒè¿›åˆ¶æ–‡ä»¶ä¿®å¤å‡½æ•° ----------
fix_binary_not_found() {
  log "ä¿®å¤ nockchain ç¨‹åºä¸å­˜åœ¨é—®é¢˜"
  
  # æ£€æŸ¥é¡¹ç›®ç›®å½•
  if [ ! -d "$NCK_DIR" ]; then
    err "Nockchain é¡¹ç›®ç›®å½•ä¸å­˜åœ¨ï¼Œè¯·å…ˆå…‹éš†é¡¹ç›®"
    log "æ­£åœ¨å…‹éš† Nockchain é¡¹ç›®..."
    git clone --depth 1 https://github.com/zorp-corp/nockchain "$NCK_DIR" || {
      err "é¡¹ç›®å…‹éš†å¤±è´¥"
      return 1
    }
  fi
  
  cd "$NCK_DIR"
  
  # æ£€æŸ¥ target/release ç›®å½•ä¸­æ˜¯å¦æœ‰äºŒè¿›åˆ¶æ–‡ä»¶
  if [ -f "target/release/nockchain" ]; then
    log "æ‰¾åˆ°å·²ç¼–è¯‘çš„ nockchain äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ­£åœ¨å®‰è£…..."
    
    # åˆ›å»ºç”¨æˆ· bin ç›®å½•å¹¶æ·»åŠ åˆ° PATH
    mkdir -p "$HOME/.local/bin"
    cp target/release/{nockchain,nockchain-wallet,hoonc} "$HOME/.local/bin/" 2>/dev/null || true
    
    # æ·»åŠ åˆ° PATHï¼ˆå¦‚æœå°šæœªæ·»åŠ ï¼‰
    if ! grep -q "$HOME/.local/bin" "$HOME/.bashrc"; then
      echo 'export PATH="$HOME/.local/bin:$PATH"' >> "$HOME/.bashrc"
      export PATH="$HOME/.local/bin:$PATH"
    fi
    
    ok "äºŒè¿›åˆ¶æ–‡ä»¶å·²å®‰è£…åˆ° $HOME/.local/bin"
    log "è¯·è¿è¡Œ 'source ~/.bashrc' æ›´æ–°ç¯å¢ƒå˜é‡"
    return 0
  fi
  
  # å¦‚æœæ²¡æœ‰æ‰¾åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå°è¯•é‡æ–°ç¼–è¯‘
  log "æœªæ‰¾åˆ°å·²ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå°è¯•é‡æ–°ç¼–è¯‘..."
  
  # å®‰è£…ä¾èµ–
  if ! command -v rustc >/dev/null; then
    log "å®‰è£… Rust ç¼–ç¨‹è¯­è¨€..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    source "$HOME/.cargo/env"
  fi
  
  # ä¼˜åŒ– Cargo é…ç½®
  mkdir -p "$HOME/.cargo"
  cat > "$HOME/.cargo/config.toml" << 'EOF'
[build]
jobs = 1

[net]
retry = 50
timeout = 3600
git-fetch-with-cli = true

[profile.release]
opt-level = 1
debug = false
panic = "abort"
codegen-units = 1
strip = true
EOF
  
  # è®¾ç½®ç¯å¢ƒå˜é‡
  export RUST_MIN_STACK=33554432
  export CARGO_BUILD_JOBS=1
  export RUSTFLAGS="-C opt-level=1 -C debuginfo=0 -C panic=abort"
  
  # æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶
  cargo clean
  
  # é‡æ–°ç¼–è¯‘
  log "å¼€å§‹ç¼–è¯‘ Nockchainï¼ˆè¿™å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼‰..."
  cargo build --release 2>&1 | tee "$BUILD_LOG"
  
  # æ£€æŸ¥ç¼–è¯‘ç»“æœ
  if [ -f "target/release/nockchain" ]; then
    ok "ç¼–è¯‘æˆåŠŸ"
    
    # å®‰è£…åˆ°ç”¨æˆ· bin ç›®å½•
    mkdir -p "$HOME/.local/bin"
    cp target/release/{nockchain,nockchain-wallet,hoonc} "$HOME/.local/bin/" 2>/dev/null || true
    
    # æ·»åŠ åˆ° PATHï¼ˆå¦‚æœå°šæœªæ·»åŠ ï¼‰
    if ! grep -q "$HOME/.local/bin" "$HOME/.bashrc"; then
      echo 'export PATH="$HOME/.local/bin:$PATH"' >> "$HOME/.bashrc"
    fi
    
    export PATH="$HOME/.local/bin:$PATH"
    ok "äºŒè¿›åˆ¶æ–‡ä»¶å·²å®‰è£…åˆ° $HOME/.local/bin"
    log "è¯·è¿è¡Œ 'source ~/.bashrc' æ›´æ–°ç¯å¢ƒå˜é‡"
    return 0
  else
    err "ç¼–è¯‘å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—: $BUILD_LOG"
    return 1
  fi
}

# ---------- æ‰‹åŠ¨å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶ ----------
manual_copy_binaries() {
  log "æ‰‹åŠ¨å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶"
  
  # æ£€æŸ¥é¡¹ç›®ç›®å½•
  if [ ! -d "$NCK_DIR" ]; then
    err "Nockchain é¡¹ç›®ç›®å½•ä¸å­˜åœ¨"
    return 1
  fi
  
  cd "$NCK_DIR"
  
  # æ£€æŸ¥ target/release ç›®å½•
  if [ ! -d "target/release" ]; then
    err "target/release ç›®å½•ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ„å»ºé¡¹ç›®"
    return 1
  fi
  
  # æ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶
  binaries_found=0
  for binary in nockchain nockchain-wallet hoonc; do
    if [ -f "target/release/$binary" ]; then
      ((binaries_found++))
    fi
  done
  
  if [ $binaries_found -eq 0 ]; then
    err "æœªæ‰¾åˆ°ä»»ä½•äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¯·å…ˆæ„å»ºé¡¹ç›®"
    return 1
  fi
  
  # åˆ›å»ºç›®æ ‡ç›®å½•
  mkdir -p "$HOME/.local/bin"
  
  # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
  for binary in nockchain nockchain-wallet hoonc; do
    if [ -f "target/release/$binary" ]; then
      cp "target/release/$binary" "$HOME/.local/bin/"
      chmod +x "$HOME/.local/bin/$binary"
      ok "$binary å·²å¤åˆ¶åˆ° $HOME/.local/bin/"
    fi
  done
  
  # æ·»åŠ åˆ° PATH
  if ! grep -q "$HOME/.local/bin" "$HOME/.bashrc"; then
    echo 'export PATH="$HOME/.local/bin:$PATH"' >> "$HOME/.bashrc"
    log "å·²å°† $HOME/.local/bin æ·»åŠ åˆ° PATH"
  fi
  
  export PATH="$HOME/.local/bin:$PATH"
  
  ok "äºŒè¿›åˆ¶æ–‡ä»¶å·²æ‰‹åŠ¨å¤åˆ¶å®Œæˆ"
  log "è¯·è¿è¡Œ 'source ~/.bashrc' æ›´æ–°ç¯å¢ƒå˜é‡"
}

# ---------- å®Œæ•´ç¯å¢ƒå®‰è£… ----------
complete_installation() {
  log "å¼€å§‹å®Œæ•´å®‰è£… Nockchain"
  
  # å®‰è£…ç³»ç»Ÿä¾èµ–
  if command -v apt >/dev/null; then
    log "å®‰è£…ç³»ç»Ÿä¾èµ–..."
    sudo apt update -y
    sudo apt install -y build-essential git curl pkg-config libssl-dev clang cmake
  fi
  
  # å®‰è£… Rust
  if ! command -v rustc >/dev/null; then
    log "å®‰è£… Rust..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    source "$HOME/.cargo/env"
  fi
  
  # å…‹éš†é¡¹ç›®
  if [ ! -d "$NCK_DIR" ]; then
    log "å…‹éš† Nockchain é¡¹ç›®..."
    git clone --depth 1 https://github.com/zorp-corp/nockchain "$NCK_DIR"
  else
    log "æ›´æ–° Nockchain é¡¹ç›®..."
    cd "$NCK_DIR"
    git pull
  fi
  
  cd "$NCK_DIR"
  
  # ä¼˜åŒ– Cargo é…ç½®
  mkdir -p "$HOME/.cargo"
  cat > "$HOME/.cargo/config.toml" << 'EOF'
[build]
jobs = 1

[net]
retry = 50
timeout = 3600
git-fetch-with-cli = true

[profile.release]
opt-level = 1
debug = false
panic = "abort"
codegen-units = 1
strip = true
EOF
  
  # è®¾ç½®ç¯å¢ƒå˜é‡
  export RUST_MIN_STACK=33554432
  export CARGO_BUILD_JOBS=1
  export RUSTFLAGS="-C opt-level=1 -C debuginfo=0 -C panic=abort"
  
  # æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶
  cargo clean
  
  # ç¼–è¯‘é¡¹ç›®
  log "ç¼–è¯‘ Nockchainï¼ˆè¿™å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼‰..."
  cargo build --release 2>&1 | tee "$BUILD_LOG"
  
  # æ£€æŸ¥ç¼–è¯‘ç»“æœ
  if [ -f "target/release/nockchain" ]; then
    ok "ç¼–è¯‘æˆåŠŸ"
    
    # å®‰è£…åˆ°ç”¨æˆ· bin ç›®å½•
    mkdir -p "$HOME/.local/bin"
    cp target/release/{nockchain,nockchain-wallet,hoonc} "$HOME/.local/bin/" 2>/dev/null || true
    
    # æ·»åŠ åˆ° PATH
    if ! grep -q "$HOME/.local/bin" "$HOME/.bashrc"; then
      echo 'export PATH="$HOME/.local/bin:$PATH"' >> "$HOME/.bashrc"
    fi
    
    export PATH="$HOME/.local/bin:$PATH"
    
    # åˆ›å»ºå¿…è¦ç›®å½•
    mkdir -p "$NCK_DIR/logs" "$NCK_DIR/.socket"
    
    # åˆ›å»ºç¯å¢ƒæ–‡ä»¶
    if [ ! -f "$ENV_FILE" ]; then
      cat > "$ENV_FILE" <<EOF
MINING_PUBKEY=
RUST_LOG=info
EOF
    fi
    
    ok "å®‰è£…å®Œæˆ"
  else
    err "ç¼–è¯‘å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—: $BUILD_LOG"
  fi
}

# ---------- è®¾ç½®æŒ–çŸ¿å…¬é’¥ ----------
set_mining_pubkey() {
  log "è®¾ç½®æŒ–çŸ¿å…¬é’¥"
  
  if [ ! -f "$ENV_FILE" ]; then
    mkdir -p "$NCK_DIR"
    echo "MINING_PUBKEY=" > "$ENV_FILE"
    echo "RUST_LOG=info" >> "$ENV_FILE"
  fi
  
  read -rp "è¾“å…¥ 128 ä½å…¬é’¥: " key
  key=$(echo "$key" | tr -d '[:space:]' | tr A-F a-f)
  
  if [ ${#key} -eq 128 ] && [[ "$key" =~ ^[0-9a-f]+$ ]]; then
    sed -i "/^MINING_PUBKEY=/d" "$ENV_FILE"
    echo "MINING_PUBKEY=$key" >> "$ENV_FILE"
    ok "å…¬é’¥å·²å†™å…¥ .env"
  else
    err "å…¬é’¥æ ¼å¼ä¸æ­£ç¡®"
  fi
  
  pause
}

# ---------- å¯åŠ¨èŠ‚ç‚¹ ----------
start_node() {
  log "å¯åŠ¨ Nockchain èŠ‚ç‚¹"
  
  # æ£€æŸ¥ç¯å¢ƒ
  source "$ENV_FILE" 2>/dev/null || true
  if [ -z "$MINING_PUBKEY" ]; then
    err "æœªè®¾ç½®æŒ–çŸ¿å…¬é’¥ï¼Œè¯·å…ˆè®¾ç½®"
    pause
    return 1
  fi
  
  # æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶
  if ! command -v nockchain >/dev/null && [ ! -f "$NCK_DIR/target/release/nockchain" ]; then
    err "nockchain ç¨‹åºä¸å­˜åœ¨ï¼Œè¯·å…ˆæ‰§è¡Œå®‰è£…æˆ–æ„å»º"
    pause
    return 1
  fi
  
  # ç¡®å®šä½¿ç”¨çš„å¯æ‰§è¡Œæ–‡ä»¶
  if command -v nockchain >/dev/null; then
    NOCKCHAIN_BIN="nockchain"
  else
    NOCKCHAIN_BIN="$NCK_DIR/target/release/nockchain"
  fi
  
  # æ¸…ç† socket æ–‡ä»¶
  pkill -f nockchain 2>/dev/null || true
  find "$NCK_DIR" -name "*.sock" -delete 2>/dev/null || true
  mkdir -p "$NCK_DIR/.socket" "$NCK_DIR/logs"
  
  # æ„å»ºå¯åŠ¨å‘½ä»¤
  START_CMD="RUST_MIN_STACK=33554432 RUST_LOG=info $NOCKCHAIN_BIN \
    --mining-pubkey $MINING_PUBKEY \
    --mine \
    --peer /ip4/95.216.102.60/udp/3006/quic-v1 \
    --peer /ip4/65.109.156.108/udp/3006/quic-v1 \
    --peer /ip4/65.21.67.175/udp/3006/quic-v1 \
    --peer /ip4/65.109.156.172/udp/3006/quic-v1 \
    --peer /ip4/34.174.22.166/udp/3006/quic-v1 \
    --npc-socket $NCK_DIR/.socket/nockchain.sock \
    --bind /ip4/0.0.0.0/udp/3006/quic-v1"
  
  # å¯åŠ¨èŠ‚ç‚¹
  cd "$NCK_DIR"
  if command -v screen >/dev/null; then
    screen -dmS nockchain bash -c "$START_CMD 2>&1 | tee $NODE_LOG"
    sleep 3
    if screen -list | grep -qw "nockchain"; then
      ok "èŠ‚ç‚¹å·²å¯åŠ¨ (screen ä¼šè¯: nockchain)"
    else
      err "èŠ‚ç‚¹å¯åŠ¨å¤±è´¥"
    fi
  else
    nohup bash -c "$START_CMD" > "$NODE_LOG" 2>&1 &
    ok "èŠ‚ç‚¹å·²åå°å¯åŠ¨"
  fi
  
  pause
}

# ---------- æŸ¥çœ‹æ—¥å¿— ----------
view_logs() {
  if [ -f "$NODE_LOG" ]; then
    tail -n 100 -f "$NODE_LOG"
  else
    err "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨: $NODE_LOG"
  fi
  pause
}

# ---------- ä¸»èœå• ----------
while true; do
  clear
  echo -e "${CYAN}${BOLD}"
  echo "================================================"
  echo "        Nockchain äºŒè¿›åˆ¶ä¿®å¤ç‰ˆè„šæœ¬ v28.0"
  echo "================================================"
  echo -e "${RESET}"
  echo ""
  echo -e "${GREEN}ğŸ”§ ä¿®å¤é€‰é¡¹:${RESET}"
  echo "  1) ä¿®å¤ nockchain ç¨‹åºä¸å­˜åœ¨é—®é¢˜"
  echo "  2) æ‰‹åŠ¨å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶"
  echo "  3) å®Œæ•´é‡æ–°å®‰è£…"
  echo ""
  echo -e "${GREEN}ğŸ”‘ èŠ‚ç‚¹ç®¡ç†:${RESET}"
  echo "  4) è®¾ç½®æŒ–çŸ¿å…¬é’¥"
  echo "  5) å¯åŠ¨æŒ–çŸ¿èŠ‚ç‚¹"
  echo "  6) æŸ¥çœ‹èŠ‚ç‚¹æ—¥å¿—"
  echo ""
  echo "  0) é€€å‡ºè„šæœ¬"
  echo ""
  read -rp "è¯·é€‰æ‹©æ“ä½œ (0-6): " choice
  
  case $choice in
    1) fix_binary_not_found; pause ;;
    2) manual_copy_binaries; pause ;;
    3) complete_installation; pause ;;
    4) set_mining_pubkey ;;
    5) start_node ;;
    6) view_logs ;;
    0) echo -e "${GREEN}æ„Ÿè°¢ä½¿ç”¨ï¼${RESET}"; exit 0 ;;
    *) warn "æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°é€‰æ‹©"; sleep 1 ;;
  esac
done
