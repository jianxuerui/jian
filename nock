#!/bin/bash

# ========= Nockchain éRootç”¨æˆ·ä¸“ç”¨æ„å»ºè„šæœ¬ v17.0 =========
RESET='\033[0m'
BOLD='\033[1m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'

NCK_DIR="$HOME/nockchain"
ENV_FILE="$NCK_DIR/.env"
LOG_FILE="$HOME/nockchain_build.log"
USER_SOFTWARE_DIR="$HOME/software"
USER_BIN_DIR="$USER_SOFTWARE_DIR/bin"
USER_LIB_DIR="$USER_SOFTWARE_DIR/lib"
USER_INCLUDE_DIR="$USER_SOFTWARE_DIR/include"

function show_banner() {
  clear
  echo -e "${BOLD}${CYAN}"
  echo "============================================================"
  echo "   Nockchain éRootç”¨æˆ·ä¸“ç”¨æ„å»ºè„šæœ¬ v17.0"
  echo "============================================================"
  echo -e "${RESET}"
  echo "ğŸš« æ— éœ€sudo: å®Œå…¨åœ¨ç”¨æˆ·ç©ºé—´å®‰è£…æ‰€æœ‰ä¾èµ–"
  echo "ğŸ  ç”¨æˆ·ç›®å½•: æ‰€æœ‰è½¯ä»¶å®‰è£…åˆ° $USER_SOFTWARE_DIR"
  echo "ğŸ“¦ æºç å®‰è£…: è‡ªåŠ¨ä¸‹è½½å¹¶ç¼–è¯‘GCCã€Clangã€LLVMç­‰å·¥å…·"
  echo "ğŸ”§ æ™ºèƒ½æ£€æµ‹: è‡ªåŠ¨æ£€æµ‹ç°æœ‰å·¥å…·ï¼Œé¿å…é‡å¤å®‰è£…"
  echo "ğŸ¯ ä¸“é—¨è§£å†³: nockuser is not in sudoers é—®é¢˜"
  echo "------------------------------------------------------------"
  echo ""
}

# ========= æ£€æµ‹ç”¨æˆ·æƒé™å’Œç¯å¢ƒ =========
function check_user_permissions() {
  echo -e "[*] æ£€æµ‹ç”¨æˆ·æƒé™å’Œç¯å¢ƒ..."
  
  echo -e "${BLUE}[i] å½“å‰ç”¨æˆ·: $(whoami)${RESET}"
  echo -e "${BLUE}[i] ç”¨æˆ·ä¸»ç›®å½•: $HOME${RESET}"
  
  # æ£€æµ‹æ˜¯å¦æœ‰sudoæƒé™
  if sudo -n true 2>/dev/null; then
    echo -e "${GREEN}[+] ç”¨æˆ·æœ‰sudoæƒé™${RESET}"
    HAS_SUDO=true
  else
    echo -e "${YELLOW}[!] ç”¨æˆ·æ— sudoæƒé™ï¼Œå°†ä½¿ç”¨æºç å®‰è£…æ–¹å¼${RESET}"
    HAS_SUDO=false
  fi
  
  # åˆ›å»ºç”¨æˆ·è½¯ä»¶ç›®å½•ç»“æ„[1]
  echo -e "[*] åˆ›å»ºç”¨æˆ·è½¯ä»¶ç›®å½•ç»“æ„..."
  mkdir -p "$USER_SOFTWARE_DIR"/{bin,lib,lib64,include,share,src,build}
  
  # è®¾ç½®åŸºç¡€ç¯å¢ƒå˜é‡
  export PATH="$USER_BIN_DIR:$PATH"
  export LD_LIBRARY_PATH="$USER_LIB_DIR:$USER_SOFTWARE_DIR/lib64:$LD_LIBRARY_PATH"
  export PKG_CONFIG_PATH="$USER_LIB_DIR/pkgconfig:$USER_SOFTWARE_DIR/lib64/pkgconfig:$PKG_CONFIG_PATH"
  export C_INCLUDE_PATH="$USER_INCLUDE_DIR:$C_INCLUDE_PATH"
  export CPLUS_INCLUDE_PATH="$USER_INCLUDE_DIR:$CPLUS_INCLUDE_PATH"
  
  echo -e "${GREEN}[+] ç”¨æˆ·ç¯å¢ƒå‡†å¤‡å®Œæˆ${RESET}"
}

# ========= æ— sudoæƒé™å®‰è£…åŸºç¡€å·¥å…· =========
function install_basic_tools_no_sudo() {
  echo -e "[*] æ— sudoæƒé™å®‰è£…åŸºç¡€å·¥å…·..."
  
  cd "$USER_SOFTWARE_DIR/src"
  
  # å®‰è£…wgetï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
  if ! command -v wget >/dev/null 2>&1; then
    echo -e "[*] å®‰è£…wget..."
    curl -L https://ftp.gnu.org/gnu/wget/wget-1.21.3.tar.gz -o wget-1.21.3.tar.gz
    tar -xzf wget-1.21.3.tar.gz
    cd wget-1.21.3
    ./configure --prefix="$USER_SOFTWARE_DIR" --without-ssl
    make -j$(nproc) && make install
    cd ..
  fi
  
  # å®‰è£…tarï¼ˆå¦‚æœç‰ˆæœ¬å¤ªè€ï¼‰
  if ! tar --version | grep -q "1.3[0-9]"; then
    echo -e "[*] å®‰è£…æ–°ç‰ˆtar..."
    wget -q https://ftp.gnu.org/gnu/tar/tar-1.34.tar.xz
    tar -xf tar-1.34.tar.xz
    cd tar-1.34
    ./configure --prefix="$USER_SOFTWARE_DIR"
    make -j$(nproc) && make install
    cd ..
  fi
  
  export PATH="$USER_BIN_DIR:$PATH"
  echo -e "${GREEN}[+] åŸºç¡€å·¥å…·å®‰è£…å®Œæˆ${RESET}"
}

# ========= æºç å®‰è£…GCCï¼ˆæ— sudoæƒé™ï¼‰=========
function install_gcc_from_source() {
  echo -e "[*] æºç å®‰è£…GCCï¼ˆæ— sudoæƒé™ï¼‰..."
  
  cd "$USER_SOFTWARE_DIR/src"
  
  # æ£€æŸ¥æ˜¯å¦å·²æœ‰å¯ç”¨çš„GCC
  if command -v gcc >/dev/null 2>&1; then
    gcc_version=$(gcc --version | head -1 | grep -o '[0-9]\+\.[0-9]\+' | head -1)
    if [ "$(echo "$gcc_version >= 7.0" | bc 2>/dev/null || echo 0)" = "1" ]; then
      echo -e "${GREEN}[+] å·²æœ‰GCC $gcc_versionï¼Œè·³è¿‡å®‰è£…${RESET}"
      return 0
    fi
  fi
  
  echo -e "[*] ä¸‹è½½GCC 9.5.0æºç ..."[2][4][9]
  if [ ! -f "gcc-9.5.0.tar.gz" ]; then
    wget -q https://ftp.gnu.org/gnu/gcc/gcc-9.5.0/gcc-9.5.0.tar.gz || {
      echo -e "${RED}[-] GCCä¸‹è½½å¤±è´¥${RESET}"
      return 1
    }
  fi
  
  echo -e "[*] è§£å‹GCCæºç ..."
  tar -xzf gcc-9.5.0.tar.gz
  cd gcc-9.5.0
  
  echo -e "[*] ä¸‹è½½GCCä¾èµ–åº“..."[9]
  # æ‰‹åŠ¨ä¸‹è½½ä¾èµ–ï¼Œå› ä¸ºå¯èƒ½æ— æ³•è”ç½‘æˆ–è„šæœ¬å¤±è´¥
  mkdir -p gmp mpfr mpc isl
  
  # ä¸‹è½½GMP
  if [ ! -d "gmp-6.2.1" ]; then
    wget -q https://gmplib.org/download/gmp/gmp-6.2.1.tar.bz2
    tar -xjf gmp-6.2.1.tar.bz2
    ln -sf gmp-6.2.1 gmp
  fi
  
  # ä¸‹è½½MPFR
  if [ ! -d "mpfr-4.1.0" ]; then
    wget -q https://www.mpfr.org/mpfr-current/mpfr-4.1.0.tar.bz2
    tar -xjf mpfr-4.1.0.tar.bz2
    ln -sf mpfr-4.1.0 mpfr
  fi
  
  # ä¸‹è½½MPC
  if [ ! -d "mpc-1.2.1" ]; then
    wget -q https://ftp.gnu.org/gnu/mpc/mpc-1.2.1.tar.gz
    tar -xzf mpc-1.2.1.tar.gz
    ln -sf mpc-1.2.1 mpc
  fi
  
  # ä¸‹è½½ISL
  if [ ! -d "isl-0.24" ]; then
    wget -q https://gcc.gnu.org/pub/gcc/infrastructure/isl-0.24.tar.bz2
    tar -xjf isl-0.24.tar.bz2
    ln -sf isl-0.24 isl
  fi
  
  echo -e "[*] é…ç½®GCCæ„å»º..."[2][4]
  mkdir -p "$USER_SOFTWARE_DIR/build/gcc-build"
  cd "$USER_SOFTWARE_DIR/build/gcc-build"
  
  # é…ç½®GCCå®‰è£…åˆ°ç”¨æˆ·ç›®å½•
  ../../src/gcc-9.5.0/configure \
    --prefix="$USER_SOFTWARE_DIR" \
    --disable-checking \
    --enable-languages=c,c++ \
    --disable-multilib \
    --enable-threads=posix \
    --disable-libstdcxx-pch \
    --enable-linker-build-id \
    --enable-plugin \
    --enable-gold \
    --with-system-zlib 2>>"$LOG_FILE"
  
  echo -e "[*] ç¼–è¯‘GCCï¼ˆè¿™å°†éœ€è¦å¾ˆé•¿æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…ï¼‰..."
  make -j$(nproc) 2>>"$LOG_FILE" || {
    echo -e "${YELLOW}[!] å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘...${RESET}"
    make -j1 2>>"$LOG_FILE"
  }
  
  echo -e "[*] å®‰è£…GCC..."
  make install 2>>"$LOG_FILE"
  
  # æ›´æ–°ç¯å¢ƒå˜é‡[9]
  export PATH="$USER_BIN_DIR:$PATH"
  export LD_LIBRARY_PATH="$USER_LIB_DIR:$USER_SOFTWARE_DIR/lib64:$LD_LIBRARY_PATH"
  
  echo -e "${GREEN}[+] GCCå®‰è£…å®Œæˆ${RESET}"
  echo -e "${GREEN}[+] GCCç‰ˆæœ¬: $(gcc --version | head -1)${RESET}"
}

# ========= æºç å®‰è£…LLVM/Clangï¼ˆæ— sudoæƒé™ï¼‰=========
function install_llvm_from_source() {
  echo -e "[*] æºç å®‰è£…LLVM/Clangï¼ˆæ— sudoæƒé™ï¼‰..."
  
  cd "$USER_SOFTWARE_DIR/src"
  
  # æ£€æŸ¥æ˜¯å¦å·²æœ‰Clang
  if command -v clang >/dev/null 2>&1; then
    clang_version=$(clang --version | head -1 | grep -o '[0-9]\+\.[0-9]\+' | head -1)
    if [ "$(echo "$clang_version >= 12.0" | bc 2>/dev/null || echo 0)" = "1" ]; then
      echo -e "${GREEN}[+] å·²æœ‰Clang $clang_versionï¼Œè·³è¿‡å®‰è£…${RESET}"
      export CC=clang
      export CXX=clang++
      return 0
    fi
  fi
  
  echo -e "[*] ä¸‹è½½LLVM 14.0.6æºç ..."
  if [ ! -f "llvm-14.0.6.src.tar.xz" ]; then
    wget -q https://github.com/llvm/llvm-project/releases/download/llvmorg-14.0.6/llvm-14.0.6.src.tar.xz
    wget -q https://github.com/llvm/llvm-project/releases/download/llvmorg-14.0.6/clang-14.0.6.src.tar.xz
  fi
  
  echo -e "[*] è§£å‹LLVMæºç ..."
  tar -xf llvm-14.0.6.src.tar.xz
  tar -xf clang-14.0.6.src.tar.xz
  
  # ç§»åŠ¨clangåˆ°æ­£ç¡®ä½ç½®
  mv clang-14.0.6.src llvm-14.0.6.src/tools/clang
  
  echo -e "[*] é…ç½®LLVMæ„å»º..."
  mkdir -p "$USER_SOFTWARE_DIR/build/llvm-build"
  cd "$USER_SOFTWARE_DIR/build/llvm-build"
  
  # ä½¿ç”¨cmakeé…ç½®ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼Œå¦åˆ™ä½¿ç”¨configure
  if command -v cmake >/dev/null 2>&1; then
    cmake -DCMAKE_INSTALL_PREFIX="$USER_SOFTWARE_DIR" \
          -DCMAKE_BUILD_TYPE=Release \
          -DLLVM_ENABLE_PROJECTS="clang" \
          -DLLVM_TARGETS_TO_BUILD="X86" \
          ../../src/llvm-14.0.6.src
  else
    echo -e "${YELLOW}[!] éœ€è¦cmakeï¼Œå°è¯•å®‰è£…cmake...${RESET}"
    install_cmake_from_source
    cmake -DCMAKE_INSTALL_PREFIX="$USER_SOFTWARE_DIR" \
          -DCMAKE_BUILD_TYPE=Release \
          -DLLVM_ENABLE_PROJECTS="clang" \
          -DLLVM_TARGETS_TO_BUILD="X86" \
          ../../src/llvm-14.0.6.src
  fi
  
  echo -e "[*] ç¼–è¯‘LLVM/Clangï¼ˆè¿™å°†éœ€è¦å¾ˆé•¿æ—¶é—´ï¼‰..."
  make -j$(( $(nproc) / 2 )) 2>>"$LOG_FILE" || {
    echo -e "${YELLOW}[!] å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘...${RESET}"
    make -j1 2>>"$LOG_FILE"
  }
  
  echo -e "[*] å®‰è£…LLVM/Clang..."
  make install 2>>"$LOG_FILE"
  
  # è®¾ç½®ç¯å¢ƒå˜é‡
  export PATH="$USER_BIN_DIR:$PATH"
  export CC=clang
  export CXX=clang++
  export LIBCLANG_PATH="$USER_LIB_DIR"
  
  echo -e "${GREEN}[+] LLVM/Clangå®‰è£…å®Œæˆ${RESET}"
}

# ========= å®‰è£…cmakeï¼ˆå¦‚æœéœ€è¦ï¼‰=========
function install_cmake_from_source() {
  echo -e "[*] æºç å®‰è£…CMake..."
  
  cd "$USER_SOFTWARE_DIR/src"
  
  if [ ! -f "cmake-3.25.2.tar.gz" ]; then
    wget -q https://github.com/Kitware/CMake/releases/download/v3.25.2/cmake-3.25.2.tar.gz
  fi
  
  tar -xzf cmake-3.25.2.tar.gz
  cd cmake-3.25.2
  
  ./configure --prefix="$USER_SOFTWARE_DIR"
  make -j$(nproc) && make install
  
  export PATH="$USER_BIN_DIR:$PATH"
  echo -e "${GREEN}[+] CMakeå®‰è£…å®Œæˆ${RESET}"
}

# ========= å®‰è£…å…¶ä»–å¿…è¦å·¥å…· =========
function install_other_tools_no_sudo() {
  echo -e "[*] å®‰è£…å…¶ä»–å¿…è¦å·¥å…·ï¼ˆæ— sudoæƒé™ï¼‰..."
  
  cd "$USER_SOFTWARE_DIR/src"
  
  # å®‰è£…pkg-config
  if ! command -v pkg-config >/dev/null 2>&1; then
    echo -e "[*] å®‰è£…pkg-config..."
    wget -q https://pkgconfig.freedesktop.org/releases/pkg-config-0.29.2.tar.gz
    tar -xzf pkg-config-0.29.2.tar.gz
    cd pkg-config-0.29.2
    ./configure --prefix="$USER_SOFTWARE_DIR" --with-internal-glib
    make -j$(nproc) && make install
    cd ..
  fi
  
  # å®‰è£…makeï¼ˆå¦‚æœç‰ˆæœ¬å¤ªè€ï¼‰
  if ! make --version | grep -q "GNU Make 4"; then
    echo -e "[*] å®‰è£…GNU Make 4.3..."
    wget -q https://ftp.gnu.org/gnu/make/make-4.3.tar.gz
    tar -xzf make-4.3.tar.gz
    cd make-4.3
    ./configure --prefix="$USER_SOFTWARE_DIR"
    make -j$(nproc) && make install
    cd ..
  fi
  
  # å®‰è£…gitï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
  if ! command -v git >/dev/null 2>&1; then
    echo -e "[*] å®‰è£…Git..."
    wget -q https://github.com/git/git/archive/v2.40.0.tar.gz -O git-2.40.0.tar.gz
    tar -xzf git-2.40.0.tar.gz
    cd git-2.40.0
    make configure
    ./configure --prefix="$USER_SOFTWARE_DIR"
    make -j$(nproc) && make install
    cd ..
  fi
  
  export PATH="$USER_BIN_DIR:$PATH"
  echo -e "${GREEN}[+] å…¶ä»–å·¥å…·å®‰è£…å®Œæˆ${RESET}"
}

# ========= è®¾ç½®æ°¸ä¹…ç¯å¢ƒå˜é‡ =========
function setup_permanent_environment() {
  echo -e "[*] è®¾ç½®æ°¸ä¹…ç¯å¢ƒå˜é‡..."
  
  # åˆ›å»ºç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶[1][9]
  cat > "$HOME/.nockchain_env" << EOF
#!/bin/bash
# Nockchainç”¨æˆ·ç¼–è¯‘ç¯å¢ƒå˜é‡
export PATH="$USER_BIN_DIR:\$PATH"
export LD_LIBRARY_PATH="$USER_LIB_DIR:$USER_SOFTWARE_DIR/lib64:\$LD_LIBRARY_PATH"
export PKG_CONFIG_PATH="$USER_LIB_DIR/pkgconfig:$USER_SOFTWARE_DIR/lib64/pkgconfig:\$PKG_CONFIG_PATH"
export C_INCLUDE_PATH="$USER_INCLUDE_DIR:\$C_INCLUDE_PATH"
export CPLUS_INCLUDE_PATH="$USER_INCLUDE_DIR:\$CPLUS_INCLUDE_PATH"
export CC=clang
export CXX=clang++
export LIBCLANG_PATH="$USER_LIB_DIR"
export LLVM_CONFIG_PATH="$USER_BIN_DIR/llvm-config"
export CARGO_BUILD_JOBS=1
export RUSTFLAGS="-C opt-level=1 -C debuginfo=0 -C panic=abort"
EOF
  
  # æ·»åŠ åˆ°bashrc[1]
  if ! grep -q "source.*nockchain_env" "$HOME/.bashrc" 2>/dev/null; then
    echo "# Nockchainç¼–è¯‘ç¯å¢ƒ" >> "$HOME/.bashrc"
    echo "source \$HOME/.nockchain_env" >> "$HOME/.bashrc"
  fi
  
  # ç«‹å³åŠ è½½ç¯å¢ƒå˜é‡
  source "$HOME/.nockchain_env"
  
  echo -e "${GREEN}[+] ç¯å¢ƒå˜é‡è®¾ç½®å®Œæˆ${RESET}"
  echo -e "${BLUE}[i] é‡æ–°ç™»å½•åç¯å¢ƒå˜é‡å°†è‡ªåŠ¨ç”Ÿæ•ˆ${RESET}"
}

# ========= å®‰è£…Rustï¼ˆç”¨æˆ·æ¨¡å¼ï¼‰=========
function install_rust_user_mode() {
  echo -e "[*] å®‰è£…Rustï¼ˆç”¨æˆ·æ¨¡å¼ï¼‰..."
  
  if ! command -v rustc >/dev/null 2>&1; then
    echo -e "[*] ä¸‹è½½å¹¶å®‰è£…Rust..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
  else
    echo -e "[*] æ›´æ–°ç°æœ‰Rust..."
    rustup update stable 2>/dev/null || true
  fi
  
  source "$HOME/.cargo/env"
  export PATH="$HOME/.cargo/bin:$PATH"
  
  # ä¼˜åŒ–Cargoé…ç½®
  mkdir -p "$HOME/.cargo"
  cat > "$HOME/.cargo/config.toml" << 'EOF'
[build]
jobs = 1

[net]
retry = 100
timeout = 3600
git-fetch-with-cli = true

[profile.release]
opt-level = 1
debug = false
debug-assertions = false
overflow-checks = false
lto = "off"
panic = "abort"
incremental = false
codegen-units = 1
strip = true

[profile.dev]
opt-level = 0
debug = false
debug-assertions = false
overflow-checks = false
incremental = false
codegen-units = 1
strip = true
EOF
  
  echo -e "${GREEN}[+] Rustå®‰è£…å®Œæˆ${RESET}"
  echo -e "${GREEN}[+] Rustç‰ˆæœ¬: $(rustc --version)${RESET}"
}

# ========= éªŒè¯å·¥å…·å®‰è£… =========
function verify_tools_installation() {
  echo -e "[*] éªŒè¯å·¥å…·å®‰è£…..."
  
  # åŠ è½½ç¯å¢ƒå˜é‡
  source "$HOME/.nockchain_env" 2>/dev/null || true
  
  echo -e "${BLUE}[i] éªŒè¯å…³é”®å·¥å…·:${RESET}"
  tools_success=0
  total_tools=7
  
  for tool in gcc g++ clang make cmake pkg-config git; do
    if command -v "$tool" >/dev/null 2>&1; then
      tool_version=$(eval "$tool --version 2>/dev/null | head -1" || echo "unknown")
      echo -e "${GREEN}  âœ“ $tool: $tool_version${RESET}"
      ((tools_success++))
    else
      echo -e "${RED}  âœ— $tool: æœªæ‰¾åˆ°${RESET}"
    fi
  done
  
  echo -e "${BLUE}[i] å·¥å…·å¯ç”¨æ€§: $tools_success/$total_tools${RESET}"
  
  if [ $tools_success -ge 5 ]; then
    echo -e "${GREEN}[+] åŸºç¡€å·¥å…·éªŒè¯é€šè¿‡${RESET}"
    return 0
  else
    echo -e "${RED}[-] å·¥å…·éªŒè¯å¤±è´¥${RESET}"
    return 1
  fi
}

# ========= å®Œæ•´çš„æ— sudoæƒé™å®‰è£…æµç¨‹ =========
function complete_installation_no_sudo() {
  echo -e "[*] å¼€å§‹Nockchainæ— sudoæƒé™å®Œæ•´å®‰è£…..."
  
  echo "=== NockchainéRootç”¨æˆ·å®‰è£…æ—¥å¿— $(date) ===" > "$LOG_FILE"
  
  echo -e "${BLUE}[i] æ­¥éª¤1/8: æ£€æµ‹ç”¨æˆ·æƒé™...${RESET}"
  check_user_permissions
  
  echo -e "${BLUE}[i] æ­¥éª¤2/8: å®‰è£…åŸºç¡€å·¥å…·...${RESET}"
  install_basic_tools_no_sudo
  
  echo -e "${BLUE}[i] æ­¥éª¤3/8: æºç å®‰è£…GCC...${RESET}"
  if ! install_gcc_from_source; then
    echo -e "${YELLOW}[!] GCCå®‰è£…å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ç³»ç»ŸGCC${RESET}"
  fi
  
  echo -e "${BLUE}[i] æ­¥éª¤4/8: æºç å®‰è£…LLVM/Clang...${RESET}"
  if ! install_llvm_from_source; then
    echo -e "${YELLOW}[!] LLVM/Clangå®‰è£…å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ç³»ç»Ÿç‰ˆæœ¬${RESET}"
  fi
  
  echo -e "${BLUE}[i] æ­¥éª¤5/8: å®‰è£…å…¶ä»–å·¥å…·...${RESET}"
  install_other_tools_no_sudo
  
  echo -e "${BLUE}[i] æ­¥éª¤6/8: è®¾ç½®ç¯å¢ƒå˜é‡...${RESET}"
  setup_permanent_environment
  
  echo -e "${BLUE}[i] æ­¥éª¤7/8: å®‰è£…Rust...${RESET}"
  install_rust_user_mode
  
  echo -e "${BLUE}[i] æ­¥éª¤8/8: éªŒè¯å·¥å…·å®‰è£…...${RESET}"
  if verify_tools_installation; then
    echo -e "${GREEN}[+] âœ… æ— sudoæƒé™å®‰è£…å®Œæˆï¼${RESET}"
    echo -e "${BLUE}[i] ä¸‹ä¸€æ­¥: å…‹éš†å’Œæ„å»ºNockchainé¡¹ç›®${RESET}"
  else
    echo -e "${YELLOW}[!] éƒ¨åˆ†å·¥å…·å®‰è£…å¤±è´¥ï¼Œä½†å¯å°è¯•ç»§ç»­æ„å»º${RESET}"
  fi
  
  echo -e "${BLUE}[i] è¯¦ç»†æ—¥å¿—: $LOG_FILE${RESET}"
  pause_and_return
}

# ========= æ„å»ºNockchainé¡¹ç›® =========
function build_nockchain_no_sudo() {
  echo -e "[*] æ„å»ºNockchainé¡¹ç›®ï¼ˆæ— sudoæƒé™ï¼‰..."
  
  # åŠ è½½ç¯å¢ƒå˜é‡
  source "$HOME/.nockchain_env" 2>/dev/null || true
  source "$HOME/.cargo/env" 2>/dev/null || true
  
  # å…‹éš†æˆ–å‡†å¤‡é¡¹ç›®
  if [ ! -d "$NCK_DIR" ]; then
    echo -e "[*] å…‹éš†Nockchainé¡¹ç›®..."
    git clone --depth 1 https://github.com/zorp-corp/nockchain "$NCK_DIR" || {
      echo -e "${RED}[-] é¡¹ç›®å…‹éš†å¤±è´¥${RESET}"
      pause_and_return
      return
    }
  fi
  
  cd "$NCK_DIR"
  
  # æ¸…ç†å¹¶å‡†å¤‡æ„å»º
  cargo clean >/dev/null 2>&1 || true
  rm -rf target/ 2>/dev/null || true
  
  # åˆ›å»ºé…ç½®æ–‡ä»¶
  if [ -f ".env_example" ]; then
    cp .env_example .env
  else
    cat > .env << 'EOF'
MINING_PUBKEY=
RUST_LOG=info
EOF
  fi
  
  # åˆ›å»ºå¿…è¦ç›®å½•
  mkdir -p assets .socket test-leader logs
  touch assets/wal.jam assets/dumb.jam assets/miner.jam 2>/dev/null || true
  
  echo -e "[*] å¼€å§‹æ„å»ºNockchainç»„ä»¶..."
  
  # æ„å»ºhoonc
  echo -e "[*] æ„å»ºhooncç¼–è¯‘å™¨..."
  if timeout 7200 make install-hoonc >>"$LOG_FILE" 2>&1; then
    echo -e "${GREEN}[+] hooncæ„å»ºæˆåŠŸ${RESET}"
  else
    echo -e "${YELLOW}[!] hooncæ„å»ºå¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—äº†è§£è¯¦æƒ…${RESET}"
  fi
  
  # æ„å»ºä¸»é¡¹ç›®
  echo -e "[*] æ„å»ºä¸»é¡¹ç›®..."
  if timeout 9000 make build >>"$LOG_FILE" 2>&1; then
    echo -e "${GREEN}[+] ä¸»é¡¹ç›®æ„å»ºæˆåŠŸ${RESET}"
  else
    echo -e "${YELLOW}[!] ä¸»é¡¹ç›®æ„å»ºå¤±è´¥ï¼Œå°è¯•å•ç‹¬æ„å»ºç»„ä»¶...${RESET}"
    for component in "nockchain-wallet" "nockchain"; do
      echo -e "[*] æ„å»º $component..."
      timeout 7200 cargo build --bin "$component" --release >>"$LOG_FILE" 2>&1 || true
    done
  fi
  
  # éªŒè¯æ„å»ºç»“æœ
  echo -e "[*] éªŒè¯æ„å»ºç»“æœ..."
  component_count=0
  for binary in "hoonc" "nockchain-wallet" "nockchain"; do
    if command -v "$binary" >/dev/null 2>&1 || [ -f "target/release/$binary" ]; then
      echo -e "${GREEN}  âœ“ $binary: æ„å»ºæˆåŠŸ${RESET}"
      ((component_count++))
    else
      echo -e "${RED}  âœ— $binary: æ„å»ºå¤±è´¥${RESET}"
    fi
  done
  
  echo -e "${BLUE}[i] æ„å»ºæˆåŠŸ: $component_count/3 ä¸ªç»„ä»¶${RESET}"
  
  if [ $component_count -ge 2 ]; then
    echo -e "${GREEN}[+] âœ… Nockchainæ„å»ºåŸºæœ¬æˆåŠŸï¼${RESET}"
  else
    echo -e "${YELLOW}[!] æ„å»ºéƒ¨åˆ†å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—${RESET}"
  fi
  
  pause_and_return
}

# ========= å…¶ä»–ç®¡ç†åŠŸèƒ½ =========
function generate_wallet_no_sudo() {
  echo -e "[*] ç”Ÿæˆé’±åŒ…..."
  
  cd "$NCK_DIR" || return
  source "$HOME/.cargo/env" 2>/dev/null || true
  source "$HOME/.nockchain_env" 2>/dev/null || true
  
  if command -v nockchain-wallet >/dev/null 2>&1; then
    nockchain-wallet keygen
  elif [ -f "target/release/nockchain-wallet" ]; then
    ./target/release/nockchain-wallet keygen
  else
    echo -e "${RED}[-] æœªæ‰¾åˆ°nockchain-walletç¨‹åº${RESET}"
  fi
  
  pause_and_return
}

function set_mining_pubkey_no_sudo() {
  echo -e "[*] è®¾ç½®æŒ–çŸ¿å…¬é’¥..."
  
  cd "$NCK_DIR" || return
  
  read -p "è¯·è¾“å…¥å®Œæ•´çš„æŒ–çŸ¿å…¬é’¥: " pubkey
  
  if [ ${#pubkey} -eq 128 ] && [[ "$pubkey" =~ ^[0-9a-f]{128}$ ]]; then
    sed -i '/^MINING_PUBKEY=/d' "$ENV_FILE" 2>/dev/null || true
    echo "MINING_PUBKEY=$pubkey" >> "$ENV_FILE"
    echo -e "${GREEN}[+] å…¬é’¥å·²æˆåŠŸå†™å…¥.envæ–‡ä»¶${RESET}"
  else
    echo -e "${RED}[-] å…¬é’¥æ ¼å¼é”™è¯¯ï¼Œéœ€è¦128ä½16è¿›åˆ¶${RESET}"
  fi
  
  pause_and_return
}

function start_node_no_sudo() {
  echo -e "[*] å¯åŠ¨èŠ‚ç‚¹..."
  
  cd "$NCK_DIR" || return
  source "$HOME/.cargo/env" 2>/dev/null || true
  source "$HOME/.nockchain_env" 2>/dev/null || true
  
  if [ ! -f "$ENV_FILE" ] || [ -z "$(grep MINING_PUBKEY "$ENV_FILE" | cut -d'=' -f2)" ]; then
    echo -e "${RED}[-] è¯·å…ˆè®¾ç½®æŒ–çŸ¿å…¬é’¥${RESET}"
    pause_and_return
    return
  fi
  
  source "$ENV_FILE"
  
  # æ¸…ç†æ—§è¿›ç¨‹å’Œsocket
  pkill -f nockchain 2>/dev/null || true
  find . -name "*.sock" -delete 2>/dev/null || true
  mkdir -p .socket test-leader
  
  # å¯åŠ¨èŠ‚ç‚¹
  start_cmd="RUST_LOG=info nockchain --mining-pubkey $MINING_PUBKEY \
--mine \
--peer /ip4/95.216.102.60/udp/3006/quic-v1 \
--peer /ip4/65.109.156.108/udp/3006/quic-v1 \
--peer /ip4/65.21.67.175/udp/3006/quic-v1 \
--peer /ip4/65.109.156.172/udp/3006/quic-v1 \
--peer /ip4/34.174.22.166/udp/3006/quic-v1 \
--npc-socket .socket/nockchain.sock \
--bind /ip4/0.0.0.0/udp/3006/quic-v1"
  
  if command -v screen >/dev/null 2>&1; then
    screen -dmS nockchain bash -c "cd '$NCK_DIR' && $start_cmd"
    echo -e "${GREEN}[+] èŠ‚ç‚¹å·²å¯åŠ¨ï¼ˆscreenä¼šè¯ï¼‰${RESET}"
  else
    nohup bash -c "$start_cmd" > nockchain.log 2>&1 &
    echo -e "${GREEN}[+] èŠ‚ç‚¹å·²åå°å¯åŠ¨${RESET}"
  fi
  
  pause_and_return
}

function check_status_no_sudo() {
  echo -e "[*] æ£€æŸ¥çŠ¶æ€..."
  
  source "$HOME/.nockchain_env" 2>/dev/null || true
  
  echo -e "${BLUE}[i] ç¯å¢ƒçŠ¶æ€:${RESET}"
  echo -e "  è½¯ä»¶ç›®å½•: $USER_SOFTWARE_DIR"
  echo -e "  PATH: $(echo $PATH | tr ':' '\n' | grep $USER_BIN_DIR | head -1 || echo 'æœªè®¾ç½®')"
  
  echo -e "${BLUE}[i] å·¥å…·çŠ¶æ€:${RESET}"
  for tool in gcc g++ clang make cmake pkg-config git rustc cargo; do
    if command -v "$tool" >/dev/null 2>&1; then
      echo -e "  âœ“ $tool"
    else
      echo -e "  âœ— $tool"
    fi
  done
  
  echo -e "${BLUE}[i] Nockchainç»„ä»¶:${RESET}"
  if [ -d "$NCK_DIR" ]; then
    cd "$NCK_DIR"
    for binary in "hoonc" "nockchain-wallet" "nockchain"; do
      if command -v "$binary" >/dev/null 2>&1 || [ -f "target/release/$binary" ]; then
        echo -e "  âœ“ $binary"
      else
        echo -e "  âœ— $binary"
      fi
    done
  else
    echo -e "  âœ— é¡¹ç›®ç›®å½•ä¸å­˜åœ¨"
  fi
  
  pause_and_return
}

function pause_and_return() {
  echo ""
  read -n1 -r -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..." key
  main_menu
}

# ========= ä¸»èœå• =========
function main_menu() {
  show_banner
  echo "è¯·é€‰æ‹©æ“ä½œ:"
  echo ""
  echo "ğŸ”§ ç¯å¢ƒå‡†å¤‡:"
  echo "  1) ğŸ”§ å®Œæ•´ç¯å¢ƒå®‰è£…ï¼ˆæ— sudoæƒé™ï¼‰"
  echo "  2) ğŸ¯ æ„å»ºNockchainé¡¹ç›®"
  echo ""
  echo "ğŸ”‘ é’±åŒ…ç®¡ç†:"
  echo "  3) ğŸ”‘ ç”Ÿæˆé’±åŒ…"
  echo "  4) ğŸ“ è®¾ç½®æŒ–çŸ¿å…¬é’¥"
  echo ""
  echo "âš¡ èŠ‚ç‚¹ç®¡ç†:"
  echo "  5) âš¡ å¯åŠ¨èŠ‚ç‚¹"
  echo "  6) ğŸ” æ£€æŸ¥çŠ¶æ€"
  echo ""
  echo "  0) é€€å‡ºè„šæœ¬"
  echo ""
  echo -e "${CYAN}ğŸ¯ ä¸“é—¨è§£å†³: nockuser is not in sudoers é—®é¢˜${RESET}"
  echo -e "${CYAN}ğŸ’¡ æ‰€æœ‰ä¾èµ–å®‰è£…åˆ°ç”¨æˆ·ç›®å½•: $USER_SOFTWARE_DIR${RESET}"[11][12][13][14]
  echo ""
  read -p "è¯·è¾“å…¥ç¼–å· (0-6): " choice

  case "$choice" in
    1) complete_installation_no_sudo ;;
    2) build_nockchain_no_sudo ;;
    3) generate_wallet_no_sudo ;;
    4) set_mining_pubkey_no_sudo ;;
    5) start_node_no_sudo ;;
    6) check_status_no_sudo ;;
    0) echo "é€€å‡ºè„šæœ¬."; exit 0 ;;
    *) echo -e "${RED}[-] æ— æ•ˆé€‰é¡¹${RESET}"; pause_and_return ;;
  esac
}

# æ£€æŸ¥æ˜¯å¦ä»¥rootè¿è¡Œ
if [ "$EUID" -eq 0 ]; then
  echo -e "${RED}[-] è¯·ä¸è¦ä»¥rootç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬${RESET}"
  exit 1
fi

# å¯åŠ¨ä¸»èœå•
main_menu
