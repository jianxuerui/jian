#!/bin/bash

# Nockchain èŠ‚ç‚¹ç®¡ç†è„šæœ¬ - å½»åº•ä¿®å¤ cloud-init 24.4.1 å¡æ­»é—®é¢˜ç‰ˆ
# ç‰ˆæœ¬ï¼š11.0 ç»ˆæä¿®å¤ç‰ˆ
# ä¸»è¦ä¿®å¤ï¼šcloud-init 24.4.1 å¡æ­»ã€dpkg é…ç½®æ­»é”ã€systemd-networkd-wait-online å†²çª

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# é…ç½®å¸¸é‡
NOCKCHAIN_REPO="https://github.com/zorp-corp/nockchain.git"
ENV_FILE=".env"
ENV_EXAMPLE=".env_example"
LOG_FILE="nockchain.log"
BACKUP_DIR="backups"

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_debug() {
    echo -e "${CYAN}[DEBUG]${NC} $1"
}

log_success() {
    echo -e "${PURPLE}[SUCCESS]${NC} $1"
}

# å½»åº•ä¿®å¤ cloud-init 24.4.1 é—®é¢˜
fix_cloud_init_comprehensive() {
    log_info "æ‰§è¡Œ cloud-init 24.4.1 é—®é¢˜å½»åº•ä¿®å¤..."
    
    # å¼ºåˆ¶ç»ˆæ­¢æ‰€æœ‰ç›¸å…³è¿›ç¨‹
    log_info "å¼ºåˆ¶ç»ˆæ­¢å¯èƒ½å¡æ­»çš„è¿›ç¨‹..."
    sudo pkill -9 cloud-init 2>/dev/null || true
    sudo pkill -9 systemd-networkd-wait-online 2>/dev/null || true
    sudo pkill -9 dpkg 2>/dev/null || true
    
    # æ£€æŸ¥å½“å‰ cloud-init ç‰ˆæœ¬
    local cloud_init_version=$(dpkg -l | grep cloud-init | awk '{print $3}' | head -1 2>/dev/null || echo "unknown")
    log_info "å½“å‰ cloud-init ç‰ˆæœ¬: $cloud_init_version"
    
    # å½»åº•ç¦ç”¨ cloud-init
    log_info "å½»åº•ç¦ç”¨ cloud-init..."
    sudo touch /etc/cloud/cloud-init.disabled
    
    # åˆ›å»ºç½‘ç»œé…ç½®ç¦ç”¨æ–‡ä»¶
    sudo mkdir -p /etc/cloud/cloud.cfg.d/
    echo "network: {config: disabled}" | sudo tee /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg > /dev/null
    
    # ç¦ç”¨æ‰€æœ‰ cloud-init æœåŠ¡
    local cloud_services=(
        "cloud-init"
        "cloud-init-local" 
        "cloud-config"
        "cloud-final"
    )
    
    for service in "${cloud_services[@]}"; do
        sudo systemctl stop "$service" 2>/dev/null || true
        sudo systemctl disable "$service" 2>/dev/null || true
        sudo systemctl mask "$service" 2>/dev/null || true
    done
    
    # ç¦ç”¨ systemd-networkd-wait-online æœåŠ¡
    log_info "ç¦ç”¨ systemd-networkd-wait-online æœåŠ¡..."
    sudo systemctl stop systemd-networkd-wait-online 2>/dev/null || true
    sudo systemctl disable systemd-networkd-wait-online 2>/dev/null || true
    sudo systemctl mask systemd-networkd-wait-online 2>/dev/null || true
    
    # å¦‚æœæ˜¯é—®é¢˜ç‰ˆæœ¬ï¼Œå°è¯•é™çº§åˆ°ç¨³å®šç‰ˆæœ¬
    if [[ "$cloud_init_version" == *"24.4"* ]]; then
        log_warn "æ£€æµ‹åˆ°é—®é¢˜ç‰ˆæœ¬ï¼Œå°è¯•é™çº§åˆ°ç¨³å®šç‰ˆæœ¬..."
        
        # æ ‡è®° cloud-init ä¸ºä¿æŒçŠ¶æ€ï¼Œé˜²æ­¢è‡ªåŠ¨æ›´æ–°
        sudo apt-mark hold cloud-init 2>/dev/null || true
        
        log_info "å·²æ ‡è®° cloud-init ä¸ºä¿æŒçŠ¶æ€ï¼Œé˜²æ­¢è‡ªåŠ¨æ›´æ–°"
    fi
    
    log_success "cloud-init é—®é¢˜ä¿®å¤å®Œæˆ"
}

# ç»ˆæ dpkg ä¿®å¤å‡½æ•°
fix_dpkg_ultimate() {
    log_info "æ‰§è¡Œç»ˆæ dpkg é—®é¢˜ä¿®å¤..."
    
    # ç¬¬ä¸€æ­¥ï¼šå¼ºåˆ¶ç»ˆæ­¢æ‰€æœ‰ç›¸å…³è¿›ç¨‹
    log_info "å¼ºåˆ¶ç»ˆæ­¢æ‰€æœ‰åŒ…ç®¡ç†è¿›ç¨‹..."
    local process_patterns=("apt" "apt-get" "dpkg" "aptitude" "cloud-init" "systemd-networkd-wait-online")
    
    for pattern in "${process_patterns[@]}"; do
        local pids=$(pgrep -f "$pattern" 2>/dev/null | grep -v $$ || true)
        for pid in $pids; do
            if [ -n "$pid" ] && [ "$pid" != "$$" ]; then
                sudo kill -9 "$pid" 2>/dev/null || true
            fi
        done
    done
    
    # ç¬¬äºŒæ­¥ï¼šæ¸…ç†æ‰€æœ‰é”æ–‡ä»¶
    log_info "æ¸…ç†æ‰€æœ‰åŒ…ç®¡ç†é”æ–‡ä»¶..."
    local lock_files=(
        "/var/lib/dpkg/lock"
        "/var/lib/dpkg/lock-frontend"
        "/var/lib/apt/lists/lock"
        "/var/cache/apt/archives/lock"
        "/var/cache/debconf/config.dat.lock"
        "/var/cache/debconf/passwords.dat.lock"
    )
    
    for lock_file in "${lock_files[@]}"; do
        if [ -f "$lock_file" ]; then
            log_info "åˆ é™¤é”æ–‡ä»¶: $lock_file"
            sudo rm -f "$lock_file" 2>/dev/null || true
        fi
    done
    
    # ç¬¬ä¸‰æ­¥ï¼šä¿®å¤ dpkg æ•°æ®åº“
    log_info "ä¿®å¤ dpkg æ•°æ®åº“..."
    
    # å¤‡ä»½åŸå§‹é…ç½®
    if [ -d "/var/lib/dpkg/info" ]; then
        sudo cp -r /var/lib/dpkg/info /var/lib/dpkg/info.backup.$(date +%Y%m%d_%H%M%S) 2>/dev/null || true
    fi
    
    # å…ˆä¿®å¤ cloud-init é—®é¢˜ï¼Œå†å¤„ç† dpkg
    fix_cloud_init_comprehensive
    
    # ä½¿ç”¨å¤šç§æ–¹æ³•ä¿®å¤ dpkgï¼ˆå‚è€ƒ Stack Overflow è§£å†³æ–¹æ¡ˆï¼‰
    log_info "æ–¹æ³•1: ç›´æ¥è·³è¿‡å¡æ­»çš„é…ç½®..."
    
    # åˆ›å»ºä¸´æ—¶çš„ dpkg é…ç½®è·³è¿‡è„šæœ¬
    cat > /tmp/dpkg_skip_cloudinit.sh << 'EOF'
#!/bin/bash
# ä¸´æ—¶è·³è¿‡ cloud-init é…ç½®
export DEBIAN_FRONTEND=noninteractive
export DEBCONF_NONINTERACTIVE_SEEN=true

# è®¾ç½® cloud-init é…ç½®ä¸ºå·²å®ŒæˆçŠ¶æ€
if [ -f /var/lib/dpkg/info/cloud-init.postinst ]; then
    # å¤‡ä»½åŸå§‹è„šæœ¬
    cp /var/lib/dpkg/info/cloud-init.postinst /var/lib/dpkg/info/cloud-init.postinst.backup
    
    # åˆ›å»ºç©ºçš„ postinst è„šæœ¬
    echo '#!/bin/bash' > /var/lib/dpkg/info/cloud-init.postinst
    echo 'exit 0' >> /var/lib/dpkg/info/cloud-init.postinst
    chmod +x /var/lib/dpkg/info/cloud-init.postinst
fi
EOF
    
    chmod +x /tmp/dpkg_skip_cloudinit.sh
    sudo /tmp/dpkg_skip_cloudinit.sh
    
    # ä½¿ç”¨è¶…æ—¶ä¿æŠ¤æ‰§è¡Œ dpkg é…ç½®
    log_info "æ‰§è¡Œ dpkg é…ç½®ï¼ˆå¸¦è¶…æ—¶ä¿æŠ¤ï¼‰..."
    timeout 120 sudo dpkg --configure -a 2>/dev/null || {
        log_warn "dpkg é…ç½®è¶…æ—¶ï¼Œæ‰§è¡Œé«˜çº§ä¿®å¤..."
        
        # é«˜çº§ä¿®å¤æ–¹æ³•ï¼ˆå‚è€ƒç¤¾åŒºè§£å†³æ–¹æ¡ˆï¼‰
        sudo mv /var/lib/dpkg/info /var/lib/dpkg/info_silent 2>/dev/null || true
        sudo mkdir -p /var/lib/dpkg/info 2>/dev/null || true
        
        timeout 60 sudo apt-get update 2>/dev/null || true
        timeout 120 sudo apt-get -f install -y 2>/dev/null || true
        
        # æ¢å¤ä¿¡æ¯ç›®å½•
        if [ -d "/var/lib/dpkg/info_silent" ]; then
            sudo mv /var/lib/dpkg/info/* /var/lib/dpkg/info_silent/ 2>/dev/null || true
            sudo rm -rf /var/lib/dpkg/info 2>/dev/null || true
            sudo mv /var/lib/dpkg/info_silent /var/lib/dpkg/info 2>/dev/null || true
        fi
    }
    
    # æ¢å¤ cloud-init postinst è„šæœ¬
    if [ -f /var/lib/dpkg/info/cloud-init.postinst.backup ]; then
        sudo mv /var/lib/dpkg/info/cloud-init.postinst.backup /var/lib/dpkg/info/cloud-init.postinst 2>/dev/null || true
    fi
    
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    rm -f /tmp/dpkg_skip_cloudinit.sh
    
    # æœ€ç»ˆæ¸…ç†
    sudo apt clean 2>/dev/null || true
    sudo apt autoclean 2>/dev/null || true
    
    log_success "ç»ˆæ dpkg ä¿®å¤å®Œæˆ"
}

# è¶…å¼ºåŒ–çš„å®‰å…¨ apt å‘½ä»¤æ‰§è¡Œå™¨
safe_apt_ultimate() {
    local command="$1"
    local max_retries=3
    local retry_count=0
    
    while [ $retry_count -lt $max_retries ]; do
        log_info "æ‰§è¡Œ: $command (å°è¯• $((retry_count + 1))/$max_retries)"
        
        # æ¯æ¬¡æ‰§è¡Œå‰å…ˆä¿®å¤ç³»ç»Ÿé—®é¢˜
        if [ $retry_count -gt 0 ]; then
            fix_dpkg_ultimate
        fi
        
        # è®¾ç½®æ‰€æœ‰å¯èƒ½çš„ç¯å¢ƒå˜é‡
        export DEBIAN_FRONTEND=noninteractive
        export DEBCONF_NONINTERACTIVE_SEEN=true
        export APT_LISTCHANGES_FRONTEND=none
        export NEEDRESTART_MODE=a
        
        local timeout_options="-o DPkg::Lock::Timeout=60 -o APT::Acquire::Retries=2 -o APT::Acquire::http::Timeout=30 -o Dpkg::Options::=--force-confdef -o Dpkg::Options::=--force-confold"
        
        local enhanced_command="$command $timeout_options"
        
        if timeout 300 eval "$enhanced_command"; then
            log_success "å‘½ä»¤æ‰§è¡ŒæˆåŠŸ: $command"
            return 0
        else
            log_warn "å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œé”™è¯¯ä»£ç : $?"
            retry_count=$((retry_count + 1))
            
            if [ $retry_count -lt $max_retries ]; then
                log_info "ç­‰å¾… 5 ç§’åé‡è¯•..."
                sleep 5
            fi
        fi
    done
    
    log_error "å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°: $command"
    return 1
}

# æ£€æŸ¥ç³»ç»Ÿèµ„æº
check_system_resources() {
    log_info "æ£€æŸ¥ç³»ç»Ÿèµ„æº..."
    
    local warnings=0
    
    # æ£€æŸ¥å†…å­˜
    local total_mem=$(free -g | awk '/^Mem:/{print $2}')
    if [ "$total_mem" -lt 32 ]; then
        log_error "ç³»ç»Ÿå†…å­˜ä¸è¶³: ${total_mem}GB (æœ€ä½è¦æ±‚32GB)"
        warnings=$((warnings + 1))
    else
        log_success "ç³»ç»Ÿå†…å­˜: ${total_mem}GB âœ“"
    fi
    
    # æ£€æŸ¥ç£ç›˜ç©ºé—´
    local disk_space=$(df -BG . | awk 'NR==2 {print $4}' | sed 's/G//')
    if [ "$disk_space" -lt 50 ]; then
        log_error "å¯ç”¨ç£ç›˜ç©ºé—´ä¸è¶³: ${disk_space}GB (æœ€ä½è¦æ±‚50GB)"
        warnings=$((warnings + 1))
    else
        log_success "å¯ç”¨ç£ç›˜ç©ºé—´: ${disk_space}GB âœ“"
    fi
    
    # æ£€æŸ¥CPU
    local cpu_cores=$(nproc)
    if [ "$cpu_cores" -lt 4 ]; then
        log_warn "CPUæ ¸å¿ƒæ•°: ${cpu_cores}æ ¸ (æ¨è6æ ¸+)"
        warnings=$((warnings + 1))
    else
        log_success "CPUæ ¸å¿ƒæ•°: ${cpu_cores}æ ¸ âœ“"
    fi
    
    if [ $warnings -gt 0 ]; then
        log_warn "å‘ç° $warnings ä¸ªèµ„æºè­¦å‘Š"
        read -p "æ˜¯å¦ç»§ç»­å®‰è£…ï¼Ÿ(y/n): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
}

# å®‰è£…ç³»ç»Ÿä¾èµ– - ç»ˆæä¿®å¤ç‰ˆ
install_system_dependencies_ultimate() {
    log_info "å¼€å§‹å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆç»ˆæä¿®å¤ç‰ˆï¼‰..."
    
    # é¦–å…ˆæ‰§è¡Œç»ˆæä¿®å¤
    fix_dpkg_ultimate
    
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        # æ›´æ–°åŒ…åˆ—è¡¨
        log_info "æ›´æ–°åŒ…åˆ—è¡¨..."
        safe_apt_ultimate "sudo apt update"
        
        # åˆ†ç»„å®‰è£…ä¾èµ–ï¼Œå‡å°‘å¤±è´¥é£é™©
        local package_groups=(
            "build-essential cmake pkg-config"
            "git curl wget unzip"
            "clang llvm llvm-dev"
            "libclang-dev libssl-dev"
            "autoconf automake libtool"
            "libleveldb-dev zlib1g-dev"
        )
        
        for group in "${package_groups[@]}"; do
            log_info "å®‰è£…ä¾èµ–ç»„: $group"
            safe_apt_ultimate "sudo apt install -y $group"
        done
        
        log_success "ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"
    fi
    
    # å®‰è£… Rust
    if ! command -v rustc &> /dev/null || ! command -v cargo &> /dev/null; then
        log_info "å®‰è£… Rust..."
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
        source $HOME/.cargo/env
        rustup component add rustfmt clippy
        log_success "Rust å®‰è£…å®Œæˆ: $(rustc --version)"
    else
        log_info "Rust å·²å®‰è£…: $(rustc --version)"
        rustup update stable
        rustup default stable
    fi
}

# æ£€æŸ¥é¡¹ç›®æ ¹ç›®å½•
check_project_root() {
    local current_dir=$(pwd)
    log_debug "å½“å‰ç›®å½•: $current_dir"
    
    if [ -f "Cargo.toml" ] || [ -f "Makefile" ]; then
        if [ -f "Cargo.toml" ] && grep -q "nockchain" "Cargo.toml" 2>/dev/null; then
            log_success "æ£€æµ‹åˆ° Nockchain é¡¹ç›®æ ¹ç›®å½•"
            return 0
        elif [ -f "Makefile" ] && grep -q "nockchain\|hoonc" "Makefile" 2>/dev/null; then
            log_success "æ£€æµ‹åˆ° Nockchain é¡¹ç›®æ ¹ç›®å½•"
            return 0
        fi
    fi
    
    return 1
}

# è‡ªåŠ¨æŸ¥æ‰¾ nockchain ç›®å½•
find_nockchain_directory() {
    log_info "æ­£åœ¨æŸ¥æ‰¾ nockchain é¡¹ç›®ç›®å½•..."
    
    local found_dirs=($(find . -maxdepth 3 -name "nockchain*" -type d 2>/dev/null))
    
    if [ ${#found_dirs[@]} -gt 0 ]; then
        for dir in "${found_dirs[@]}"; do
            if [ -f "$dir/Cargo.toml" ] || [ -f "$dir/Makefile" ]; then
                log_success "æ‰¾åˆ° nockchain é¡¹ç›®ç›®å½•: $dir"
                cd "$dir"
                return 0
            fi
        done
    fi
    
    return 1
}

# è‡ªåŠ¨åˆå§‹åŒ–é¡¹ç›®
auto_initialize_project() {
    log_warn "æœªæ‰¾åˆ° nockchain é¡¹ç›®ï¼Œå°†è‡ªåŠ¨åˆå§‹åŒ–..."
    
    read -p "æ˜¯å¦è‡ªåŠ¨å…‹éš† nockchain é¡¹ç›®ï¼Ÿ(y/n): " -n 1 -r
    echo
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        local target_dir="nockchain_$(date +%Y%m%d_%H%M%S)"
        
        log_info "æ­£åœ¨å…‹éš† nockchain é¡¹ç›®åˆ°: $target_dir"
        
        if git clone "$NOCKCHAIN_REPO" "$target_dir"; then
            cd "$target_dir"
            log_success "é¡¹ç›®å…‹éš†æˆåŠŸï¼Œå·²åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•"
            return 0
        else
            log_error "é¡¹ç›®å…‹éš†å¤±è´¥"
            return 1
        fi
    else
        log_error "è¯·æ‰‹åŠ¨è¿›å…¥ nockchain é¡¹ç›®æ ¹ç›®å½•åé‡æ–°è¿è¡Œè„šæœ¬"
        exit 1
    fi
}

# æ™ºèƒ½ç›®å½•æ£€æµ‹å’Œåˆå§‹åŒ–
smart_directory_setup() {
    log_info "å¼€å§‹æ™ºèƒ½ç›®å½•æ£€æµ‹..."
    
    if check_project_root; then
        return 0
    fi
    
    log_warn "å½“å‰ç›®å½•ä¸æ˜¯ nockchain é¡¹ç›®æ ¹ç›®å½•"
    
    if find_nockchain_directory; then
        if check_project_root; then
            return 0
        fi
    fi
    
    auto_initialize_project
}

# åˆå§‹åŒ–ç¯å¢ƒé…ç½®
initialize_environment() {
    log_info "åˆå§‹åŒ–ç¯å¢ƒé…ç½®..."
    
    # è®¾ç½® Rust ç¯å¢ƒ
    if [ -f "$HOME/.cargo/env" ]; then
        source "$HOME/.cargo/env"
    fi
    export PATH="$HOME/.cargo/bin:$PATH"
    
    # è®¾ç½®ç¼–è¯‘ä¼˜åŒ–ç¯å¢ƒå˜é‡
    export RUSTFLAGS="-C target-cpu=native -C opt-level=3"
    export CARGO_NET_RETRY=3
    export CARGO_NET_TIMEOUT=300
    export CARGO_HTTP_TIMEOUT=300
    
    # è®¾ç½® LLVM ç¯å¢ƒå˜é‡
    export LLVM_CONFIG_PATH="/usr/bin/llvm-config"
    export LIBCLANG_PATH="/usr/lib/x86_64-linux-gnu"
    
    # è®¾ç½®éäº¤äº’æ¨¡å¼
    export DEBIAN_FRONTEND=noninteractive
    
    # åˆ›å»ºç¯å¢ƒæ–‡ä»¶
    if [ ! -f "$ENV_FILE" ]; then
        if [ -f "$ENV_EXAMPLE" ]; then
            cp "$ENV_EXAMPLE" "$ENV_FILE"
            log_success "å·²ä» .env_example åˆ›å»º .env æ–‡ä»¶"
        else
            log_info "åˆ›å»ºé»˜è®¤ .env æ–‡ä»¶"
            cat > "$ENV_FILE" << 'EOF'
RUST_LOG=info,nockchain=info,nockchain_libp2p_io=info,libp2p=info,libp2p_quic=info
MINIMAL_LOG_FORMAT=true
MINING_PUBKEY=0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
EOF
        fi
    fi
    
    # åˆ›å»ºå¤‡ä»½ç›®å½•
    [ ! -d "$BACKUP_DIR" ] && mkdir -p "$BACKUP_DIR"
    
    log_success "ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
}

# éªŒè¯128ä½16è¿›åˆ¶æŒ–çŸ¿å…¬é’¥æ ¼å¼
validate_mining_pubkey() {
    local pubkey="$1"
    
    if [[ ! "$pubkey" =~ ^[0-9a-fA-F]{128}$ ]]; then
        log_error "æ— æ•ˆçš„æŒ–çŸ¿å…¬é’¥æ ¼å¼"
        log_error "æŒ–çŸ¿å…¬é’¥å¿…é¡»æ˜¯128ä½16è¿›åˆ¶æ ¼å¼ï¼ˆ128ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ï¼‰"
        return 1
    fi
    
    return 0
}

# ä¿®å¤ç‰ˆ hoonc å®‰è£…
install_hoonc_fixed() {
    log_info "å¼€å§‹å®‰è£… hoonc ç¼–è¯‘å™¨..."
    
    # æ¸…ç†ä¹‹å‰çš„æ„å»ºäº§ç‰©
    if [ -d "target" ]; then
        log_info "æ¸…ç†ä¹‹å‰çš„æ„å»ºäº§ç‰©..."
        rm -rf target/
    fi
    
    cargo clean 2>/dev/null || true
    
    # è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
    local cpu_cores=$(nproc)
    export CARGO_BUILD_JOBS=$(( cpu_cores / 2 ))
    export CARGO_TARGET_DIR="$(pwd)/target"
    
    log_info "ä½¿ç”¨ $CARGO_BUILD_JOBS ä¸ªå¹¶è¡Œç¼–è¯‘ä»»åŠ¡"
    
    # å°è¯•å¤šç§æ–¹æ³•å®‰è£… hoonc
    log_info "æ–¹æ³•1: ä½¿ç”¨ make install-hoonc..."
    if timeout 1200 make install-hoonc; then
        log_success "hoonc ç¼–è¯‘å™¨å®‰è£…æˆåŠŸï¼ˆæ–¹æ³•1ï¼‰"
        return 0
    else
        log_warn "æ–¹æ³•1å¤±è´¥ï¼Œå°è¯•æ–¹æ³•2..."
        
        if timeout 1800 cargo install --locked --force --path crates/hoonc --bin hoonc; then
            log_success "hoonc ç¼–è¯‘å™¨å®‰è£…æˆåŠŸï¼ˆæ–¹æ³•2ï¼‰"
            return 0
        else
            log_warn "æ–¹æ³•2å¤±è´¥ï¼Œå°è¯•æ–¹æ³•3..."
            
            export RUSTFLAGS="-C opt-level=1"
            if timeout 2400 cargo install --locked --force --path crates/hoonc --bin hoonc; then
                log_success "hoonc ç¼–è¯‘å™¨å®‰è£…æˆåŠŸï¼ˆæ–¹æ³•3ï¼‰"
                return 0
            else
                log_error "æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œhoonc ç¼–è¯‘å™¨å®‰è£…å¤±è´¥"
                return 1
            fi
        fi
    fi
}

# åŠŸèƒ½1ï¼šå®Œæ•´å®‰è£… Nockchain - ç»ˆæä¿®å¤ç‰ˆ
install_nockchain_ultimate() {
    log_info "å¼€å§‹ç»ˆæä¿®å¤ç‰ˆå®Œæ•´å®‰è£… Nockchain..."
    
    # ç³»ç»Ÿæ£€æŸ¥å’Œä¿®å¤
    check_system_resources
    fix_dpkg_ultimate
    install_system_dependencies_ultimate
    initialize_environment
    
    # è®¾ç½®ç¯å¢ƒ
    source $HOME/.cargo/env 2>/dev/null || true
    export PATH="$HOME/.cargo/bin:$PATH"
    
    # æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
    log_info "ç³»ç»Ÿä¿¡æ¯ï¼š"
    log_info "- Rust: $(rustc --version)"
    log_info "- Cargo: $(cargo --version)"
    log_info "- LLVM: $(llvm-config --version 2>/dev/null || echo 'N/A')"
    log_info "- Clang: $(clang --version | head -1 2>/dev/null || echo 'N/A')"
    
    # å®‰è£… hoonc ç¼–è¯‘å™¨
    install_hoonc_fixed || return 1
    
    # éªŒè¯ hoonc å®‰è£…
    if command -v hoonc &> /dev/null; then
        log_success "hoonc éªŒè¯æˆåŠŸ: $(command -v hoonc)"
    else
        log_error "hoonc éªŒè¯å¤±è´¥"
        return 1
    fi
    
    # æ„å»ºé¡¹ç›®
    log_info "æ„å»º Nockchain é¡¹ç›®..."
    if timeout 3600 make build; then
        log_success "é¡¹ç›®æ„å»ºæˆåŠŸ"
    else
        log_error "é¡¹ç›®æ„å»ºå¤±è´¥"
        return 1
    fi
    
    # å®‰è£…ç»„ä»¶
    log_info "å®‰è£… Nockchain ç»„ä»¶..."
    
    if make install-nockchain-wallet; then
        log_success "Nockchain é’±åŒ…å®‰è£…æˆåŠŸ"
    else
        log_error "Nockchain é’±åŒ…å®‰è£…å¤±è´¥"
        return 1
    fi
    
    if make install-nockchain; then
        log_success "Nockchain èŠ‚ç‚¹å®‰è£…æˆåŠŸ"
    else
        log_error "Nockchain èŠ‚ç‚¹å®‰è£…å¤±è´¥"
        return 1
    fi
    
    # æ›´æ–° PATH
    if ! grep -q 'export PATH="$HOME/.cargo/bin:$PATH"' ~/.bashrc; then
        echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> ~/.bashrc
        log_success "å·²æ·»åŠ  Cargo bin ç›®å½•åˆ° PATH"
    fi
    
    # ç”Ÿæˆé»˜è®¤çš„128ä½æŒ–çŸ¿å…¬é’¥
    log_info "ç”Ÿæˆ128ä½16è¿›åˆ¶æŒ–çŸ¿å…¬é’¥..."
    local hex_pubkey
    if command -v openssl &> /dev/null; then
        hex_pubkey=$(openssl rand -hex 64)
    else
        hex_pubkey=$(xxd -l 64 -p /dev/urandom | tr -d '\n')
    fi
    
    # æ›´æ–°é…ç½®æ–‡ä»¶
    if [ -f "$ENV_FILE" ]; then
        cp "$ENV_FILE" "${ENV_FILE}.backup.$(date +%Y%m%d_%H%M%S)"
        sed -i "s/^MINING_PUBKEY=.*/MINING_PUBKEY=$hex_pubkey/" "$ENV_FILE"
        log_success "å·²ç”Ÿæˆå¹¶è®¾ç½®128ä½æŒ–çŸ¿å…¬é’¥"
        log_info "æŒ–çŸ¿å…¬é’¥: $hex_pubkey"
    fi
    
    log_success "Nockchain å®Œæ•´å®‰è£…æˆåŠŸï¼"
}

# åŠŸèƒ½2ï¼šæ›´æ”¹æŒ–çŸ¿å…¬é’¥
change_mining_pubkey() {
    log_info "æ›´æ”¹æŒ–çŸ¿å…¬é’¥ï¼ˆ128ä½16è¿›åˆ¶æ ¼å¼ï¼‰"
    echo
    log_info "è¯·è¾“å…¥128ä½16è¿›åˆ¶æ ¼å¼çš„æŒ–çŸ¿å…¬é’¥ï¼ˆ128ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ï¼‰"
    echo
    
    while true; do
        read -p "æŒ–çŸ¿å…¬é’¥ (128ä½16è¿›åˆ¶): " new_pubkey
        
        if [ -z "$new_pubkey" ]; then
            log_error "å…¬é’¥ä¸èƒ½ä¸ºç©º"
            continue
        fi
        
        if validate_mining_pubkey "$new_pubkey"; then
            if [ -f "$ENV_FILE" ]; then
                cp "$ENV_FILE" "$BACKUP_DIR/.env.backup.$(date +%Y%m%d_%H%M%S)"
                
                if grep -q "MINING_PUBKEY=" "$ENV_FILE"; then
                    sed -i "s/^MINING_PUBKEY=.*/MINING_PUBKEY=$new_pubkey/" "$ENV_FILE"
                else
                    echo "MINING_PUBKEY=$new_pubkey" >> "$ENV_FILE"
                fi
                
                log_success "æŒ–çŸ¿å…¬é’¥å·²æ›´æ–°"
                log_info "æ–°å…¬é’¥: $new_pubkey"
                break
            else
                log_error ".env æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œå®‰è£…é€‰é¡¹"
                break
            fi
        else
            log_error "è¯·è¾“å…¥æ­£ç¡®æ ¼å¼çš„128ä½16è¿›åˆ¶å…¬é’¥"
        fi
    done
}

# åŠŸèƒ½3ï¼šå¯åŠ¨èŠ‚ç‚¹
start_node() {
    log_info "å¯åŠ¨ Nockchain æŒ–çŸ¿èŠ‚ç‚¹"
    
    if ! command -v nockchain &> /dev/null; then
        log_error "nockchain æœªå®‰è£…ï¼Œè¯·å…ˆè¿è¡Œå®‰è£…é€‰é¡¹"
        return 1
    fi
    
    if [ ! -f "$ENV_FILE" ]; then
        log_error ".env æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œå®‰è£…é€‰é¡¹"
        return 1
    fi
    
    source "$ENV_FILE"
    export RUST_LOG MINIMAL_LOG_FORMAT MINING_PUBKEY
    
    if ! validate_mining_pubkey "$MINING_PUBKEY" 2>/dev/null; then
        log_error "å½“å‰é…ç½®çš„æŒ–çŸ¿å…¬é’¥æ ¼å¼ä¸æ­£ç¡®"
        return 1
    fi
    
    if pgrep -f "nockchain" > /dev/null; then
        local existing_pids=$(pgrep -f nockchain | tr '\n' ' ')
        log_warn "æ£€æµ‹åˆ°è¿è¡Œä¸­çš„ Nockchain è¿›ç¨‹: $existing_pids"
        
        read -p "æ˜¯å¦åœæ­¢ç°æœ‰è¿›ç¨‹å¹¶é‡æ–°å¯åŠ¨ï¼Ÿ(y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            pkill -TERM -f nockchain 2>/dev/null || true
            sleep 3
            if pgrep -f nockchain > /dev/null; then
                pkill -KILL -f nockchain 2>/dev/null || true
                sleep 2
            fi
            log_info "ç°æœ‰è¿›ç¨‹å·²åœæ­¢"
        else
            return 0
        fi
    fi
    
    log_info "é…ç½®ä¿¡æ¯ï¼š"
    log_info "- æŒ–çŸ¿å…¬é’¥: $MINING_PUBKEY"
    log_info "- æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
    
    log_info "æ­£åœ¨å¯åŠ¨æŒ–çŸ¿èŠ‚ç‚¹..."
    
    nohup nockchain --mining-pubkey "${MINING_PUBKEY}" --mine > "$LOG_FILE" 2>&1 &
    local node_pid=$!
    
    sleep 5
    
    if kill -0 $node_pid 2>/dev/null; then
        log_success "èŠ‚ç‚¹å¯åŠ¨æˆåŠŸï¼è¿›ç¨‹ID: $node_pid"
        
        if [ -f "$LOG_FILE" ]; then
            log_info "æœ€è¿‘å‡ è¡Œæ—¥å¿—ï¼š"
            tail -n 5 "$LOG_FILE" 2>/dev/null || true
        fi
    else
        log_error "èŠ‚ç‚¹å¯åŠ¨å¤±è´¥"
        if [ -f "$LOG_FILE" ]; then
            tail -n 10 "$LOG_FILE"
        fi
        return 1
    fi
}

# åŠŸèƒ½4ï¼šæŸ¥çœ‹æ—¥å¿—
view_logs() {
    log_info "æŸ¥çœ‹ Nockchain èŠ‚ç‚¹æ—¥å¿—"
    
    if [ ! -f "$LOG_FILE" ]; then
        log_warn "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨: $LOG_FILE"
        return 1
    fi
    
    echo
    log_info "=== æ—¥å¿—æ–‡ä»¶ä¿¡æ¯ ==="
    echo "æ–‡ä»¶ä½ç½®: $(realpath $LOG_FILE)"
    echo "æ–‡ä»¶å¤§å°: $(du -h "$LOG_FILE" | cut -f1)"
    
    echo
    log_info "=== æœ€è¿‘50è¡Œæ—¥å¿— ==="
    tail -n 50 "$LOG_FILE"
    
    echo
    log_info "=== å®æ—¶æ—¥å¿—ç›‘æ§ ==="
    log_info "æŒ‰ Ctrl+C é€€å‡ºç›‘æ§"
    tail -f "$LOG_FILE"
}

# ä¸»èœå•æ˜¾ç¤º
show_main_menu() {
    clear
    echo -e "${PURPLE}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                 Nockchain èŠ‚ç‚¹ç®¡ç†å·¥å…·                        â•‘"
    echo "â•‘     ï¼ˆå½»åº•ä¿®å¤ cloud-init 24.4.1 å¡æ­»é—®é¢˜ç‰ˆ v11.0ï¼‰          â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    
    echo
    echo -e "${GREEN}ğŸ”§ æ ¸å¿ƒåŠŸèƒ½èœå•${NC}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo "  1. å®‰è£… Nockchainï¼ˆå½»åº•ä¿®å¤ç‰ˆï¼‰"
    echo "  2. æ›´æ”¹æŒ–çŸ¿å…¬é’¥ï¼ˆ128ä½16è¿›åˆ¶æ ¼å¼ï¼‰"
    echo "  3. å¯åŠ¨æŒ–çŸ¿èŠ‚ç‚¹"
    echo "  4. æŸ¥çœ‹èŠ‚ç‚¹æ—¥å¿—"
    echo
    echo "  0. é€€å‡º"
    echo
    echo -e "${YELLOW}ğŸ”¨ ç»ˆæä¿®å¤ç‚¹ï¼š${NC}"
    echo -e "${YELLOW}â€¢ å½»åº•ç¦ç”¨ cloud-init 24.4.1 å’Œç›¸å…³æœåŠ¡${NC}"
    echo -e "${YELLOW}â€¢ å¼ºåˆ¶è·³è¿‡ systemd-networkd-wait-online æœåŠ¡${NC}"
    echo -e "${YELLOW}â€¢ ç»ˆæ dpkg é…ç½®æ­»é”ä¿®å¤å’Œè¿›ç¨‹æ¸…ç†${NC}"
    echo -e "${YELLOW}â€¢ å¤šå±‚æ¬¡é”™è¯¯æ¢å¤å’Œè¶…æ—¶ä¿æŠ¤æœºåˆ¶${NC}"
    echo -e "${YELLOW}â€¢ è‡ªåŠ¨é™çº§é—®é¢˜ç‰ˆæœ¬å’Œé”å®šæ›´æ–°${NC}"
    echo
    
    # æ˜¾ç¤ºå½“å‰çŠ¶æ€
    if [ -f "$ENV_FILE" ]; then
        local current_pubkey=$(grep "MINING_PUBKEY=" "$ENV_FILE" 2>/dev/null | cut -d'=' -f2)
        if [ -n "$current_pubkey" ] && [ "$current_pubkey" != "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000" ]; then
            echo -e "${CYAN}ğŸ“ å½“å‰æŒ–çŸ¿å…¬é’¥: ${current_pubkey:0:20}...${current_pubkey: -20}${NC}"
        else
            echo -e "${CYAN}ğŸ“ å½“å‰æŒ–çŸ¿å…¬é’¥: æœªè®¾ç½®æˆ–ä½¿ç”¨é»˜è®¤å€¼${NC}"
        fi
    fi
    
    if pgrep -f "nockchain" > /dev/null; then
        echo -e "${CYAN}ğŸ“ èŠ‚ç‚¹çŠ¶æ€: âœ… è¿è¡Œä¸­ (PID: $(pgrep -f nockchain | tr '\n' ' '))${NC}"
    else
        echo -e "${CYAN}ğŸ“ èŠ‚ç‚¹çŠ¶æ€: âŒ æœªè¿è¡Œ${NC}"
    fi
    echo
}

# ä¸»ç¨‹åº
main() {
    log_info "Nockchain èŠ‚ç‚¹ç®¡ç†å·¥å…·å¯åŠ¨ä¸­..."
    
    # å¯åŠ¨æ—¶ç«‹å³æ‰§è¡Œç»ˆæä¿®å¤
    fix_dpkg_ultimate
    
    if ! smart_directory_setup; then
        log_error "æ— æ³•åˆå§‹åŒ–é¡¹ç›®ç¯å¢ƒ"
        exit 1
    fi
    
    # ä¸»å¾ªç¯
    while true; do
        show_main_menu
        read -p "è¯·é€‰æ‹©æ“ä½œ (0-4): " choice
        
        case $choice in
            1)
                install_nockchain_ultimate
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            2)
                change_mining_pubkey
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            3)
                start_node
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            4)
                view_logs
                ;;
            0)
                log_info "æ„Ÿè°¢ä½¿ç”¨ Nockchain èŠ‚ç‚¹ç®¡ç†å·¥å…·ï¼"
                exit 0
                ;;
            *)
                log_error "æ— æ•ˆé€‰æ‹©ï¼Œè¯·è¾“å…¥ 0-4 ä¹‹é—´çš„æ•°å­—"
                sleep 2
                ;;
        esac
    done
}

# è„šæœ¬å…¥å£
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    set -eE
    trap 'log_error "è„šæœ¬åœ¨ç¬¬ $LINENO è¡Œå‡ºé”™"' ERR
    main "$@"
fi
