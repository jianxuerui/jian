#!/bin/bash
# -*- coding: UTF-8 -*-
# Nockchain hoonc.jam Bootstrap æ–‡ä»¶ç¼ºå¤±å®Œæ•´è§£å†³æ–¹æ¡ˆ v11.0

# é¢œè‰²å®šä¹‰
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
CYAN='\033[1;36m'
MAGENTA='\033[1;35m'
RESET='\033[0m'

# è·¯å¾„é…ç½®
INSTALL_PREFIX="$HOME/.local"
NOCKCHAIN_DIR="$HOME/nockchain"
LOG_FILE="$HOME/nockchain_bootstrap_fix.log"
BACKUP_DIR="$HOME/nockchain_backup"
MINICONDA_DIR="$HOME/.miniconda3"

# Bootstrap æ–‡ä»¶ä¿®å¤ä¸“ç”¨ç¯å¢ƒå˜é‡
export PATH="$INSTALL_PREFIX/bin:$HOME/.cargo/bin:$PATH"
export RUST_MIN_STACK=134217728  # 128MB stack size
export RUST_LOG=error
export RUSTFLAGS="-C debuginfo=0 -C opt-level=1 -C codegen-units=1 -C link-arg=-Wl,--no-keep-memory"
export CARGO_BUILD_JOBS=1
export CARGO_INCREMENTAL=0
export CARGO_NET_RETRY=15
export CARGO_HTTP_TIMEOUT=600
export MALLOC_ARENA_MAX=2

# æ¶ˆæ¯è¾“å‡ºå‡½æ•°
print_message() {
    local color=$1
    local message=$2
    echo -e "${color}${message}${RESET}"
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $message" >> "$LOG_FILE"
}

check_command() {
    command -v "$1" >/dev/null 2>&1
}

# éªŒè¯128ä½16è¿›åˆ¶å…¬é’¥æ ¼å¼
validate_128bit_hex_pubkey() {
    local pubkey=$1
    if [[ $pubkey =~ ^[0-9a-fA-F]{128}$ ]]; then
        return 0
    else
        print_message "$RED" "é”™è¯¯ï¼šå…¬é’¥å¿…é¡»æ˜¯128ä½16è¿›åˆ¶æ ¼å¼ï¼ˆ128ä¸ªå­—ç¬¦ï¼‰"
        return 1
    fi
}

# æ˜¾ç¤ºä¸»èœå•
show_menu() {
    clear
    echo -e "${BLUE}
=======================================
 Nockchain Bootstrap æ–‡ä»¶ç¼ºå¤±å®Œæ•´è§£å†³æ–¹æ¡ˆ v11.0
=======================================
${RESET}"
    echo -e "${YELLOW}1. å®Œå…¨è§£å†³ hoonc.jam Bootstrap æ–‡ä»¶ç¼ºå¤±é—®é¢˜"
    echo "2. é…ç½®128ä½16è¿›åˆ¶æŒ–çŸ¿å…¬é’¥"
    echo "3. å¯åŠ¨ Bootstrap ä¿æŠ¤æŒ–çŸ¿"
    echo "4. æŸ¥çœ‹å®æ—¶ç¼–è¯‘/æŒ–çŸ¿æ—¥å¿—"
    echo "5. æ£€æŸ¥é’±åŒ…ä½™é¢"
    echo "6. ç³»ç»ŸçŠ¶æ€ç›‘æ§"
    echo "7. å¤‡ä»½é’±åŒ…å¯†é’¥"
    echo "8. Bootstrap æ–‡ä»¶é—®é¢˜è¯Šæ–­"
    echo "9. Bootstrap ç”Ÿæˆå·¥å…·"
    echo "10. é€€å‡ºè„šæœ¬"
    echo -e "${BLUE}=======================================${RESET}"
}

# æ£€æµ‹Linuxå‘è¡Œç‰ˆ
detect_distro() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        echo $ID
    elif [ -f /etc/redhat-release ]; then
        echo "centos"
    elif [ -f /etc/debian_version ]; then
        echo "debian"
    else
        echo "unknown"
    fi
}

# å®‰è£…ç³»ç»Ÿçº§ç¼–è¯‘å™¨å·¥å…·
install_system_compilers() {
    print_message "$CYAN" "æ­£åœ¨å®‰è£…ç³»ç»Ÿçº§ç¼–è¯‘å™¨å·¥å…·..."
    
    local distro=$(detect_distro)
    print_message "$YELLOW" "æ£€æµ‹åˆ°ç³»ç»Ÿ: $distro"
    
    case $distro in
        "ubuntu"|"debian"|"mint"|"pop")
            if sudo -n true 2>/dev/null; then
                sudo apt update
                sudo apt install -y build-essential gcc g++ make cmake clang llvm-dev libclang-dev pkg-config libssl-dev libc6-dev curl wget git bc
                print_message "$GREEN" "ç³»ç»Ÿç¼–è¯‘å™¨å®‰è£…å®Œæˆ"
            else
                print_message "$YELLOW" "æ— sudoæƒé™ï¼Œå°†ä½¿ç”¨Condaç¼–è¯‘å™¨"
                return 1
            fi
            ;;
            
        "centos"|"rhel"|"rocky"|"almalinux"|"fedora")
            if sudo -n true 2>/dev/null; then
                if check_command "dnf"; then
                    sudo dnf groupinstall -y "Development Tools"
                    sudo dnf install -y clang llvm-devel openssl-devel cmake curl wget git bc
                elif check_command "yum"; then
                    sudo yum groupinstall -y "Development Tools"
                    sudo yum install -y clang llvm-devel openssl-devel cmake curl wget git bc
                fi
                print_message "$GREEN" "ç³»ç»Ÿç¼–è¯‘å™¨å®‰è£…å®Œæˆ"
            else
                print_message "$YELLOW" "æ— sudoæƒé™ï¼Œå°†ä½¿ç”¨Condaç¼–è¯‘å™¨"
                return 1
            fi
            ;;
            
        *)
            print_message "$YELLOW" "æœªçŸ¥ç³»ç»Ÿç±»å‹ï¼Œå°†ä½¿ç”¨Condaç¼–è¯‘å™¨"
            return 1
            ;;
    esac
    
    return 0
}

# æ™ºèƒ½å¤„ç†Minicondaå®‰è£…
smart_miniconda_setup() {
    print_message "$CYAN" "æ­£åœ¨æ™ºèƒ½å¤„ç†Minicondaç¯å¢ƒ..."
    
    if [ -d "$MINICONDA_DIR" ]; then
        if [ -f "$MINICONDA_DIR/bin/conda" ] && "$MINICONDA_DIR/bin/conda" --version >/dev/null 2>&1; then
            print_message "$GREEN" "å‘ç°æœ‰æ•ˆçš„Minicondaå®‰è£…"
            source "$MINICONDA_DIR/etc/profile.d/conda.sh"
            export PATH="$MINICONDA_DIR/bin:$PATH"
            return 0
        else
            print_message "$YELLOW" "å‘ç°æŸåçš„Minicondaå®‰è£…ï¼Œæ­£åœ¨æ¸…ç†..."
            rm -rf "$MINICONDA_DIR"
        fi
    fi
    
    print_message "$CYAN" "æ­£åœ¨å®‰è£…Miniconda..."
    local arch=$(uname -m)
    case $arch in
        x86_64) MINICONDA_URL="https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh" ;;
        aarch64) MINICONDA_URL="https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-aarch64.sh" ;;
        *) print_message "$RED" "ä¸æ”¯æŒçš„æ¶æ„: $arch"; return 1 ;;
    esac
    
    local installer="/tmp/miniconda_installer.sh"
    
    if wget -q --show-progress --timeout=120 --tries=3 "$MINICONDA_URL" -O "$installer"; then
        chmod +x "$installer"
        if bash "$installer" -b -p "$MINICONDA_DIR"; then
            source "$MINICONDA_DIR/etc/profile.d/conda.sh"
            export PATH="$MINICONDA_DIR/bin:$PATH"
            conda config --set auto_activate_base false
            conda config --set channel_priority strict
            rm -f "$installer"
            print_message "$GREEN" "Minicondaå®‰è£…å®Œæˆ"
            return 0
        fi
    fi
    
    print_message "$RED" "Minicondaå®‰è£…å¤±è´¥"
    return 1
}

# å®‰è£…Condaç¼–è¯‘å™¨å·¥å…·é“¾
install_conda_compilers() {
    print_message "$CYAN" "æ­£åœ¨å®‰è£…Condaç¼–è¯‘å™¨å·¥å…·é“¾..."
    
    source "$MINICONDA_DIR/etc/profile.d/conda.sh"
    export PATH="$MINICONDA_DIR/bin:$PATH"
    
    print_message "$CYAN" "åˆ›å»ºnockchain-bootstrapç¯å¢ƒ..."
    conda create -n nockchain-bootstrap -y python=3.9 --no-default-packages || {
        print_message "$YELLOW" "ç¯å¢ƒå·²å­˜åœ¨ï¼Œæ­£åœ¨æ›´æ–°..."
    }
    
    conda activate nockchain-bootstrap
    
    print_message "$CYAN" "å®‰è£…ç¼–è¯‘å™¨å·¥å…·é“¾..."
    local compiler_packages=(
        "compilers"
        "gcc_linux-64"
        "gxx_linux-64"
        "clang"
        "clangxx"
        "make"
        "cmake"
        "pkg-config"
        "binutils"
        "ld_impl_linux-64"
        "openssl"
        "libffi"
        "curl"
        "wget"
        "bc"
    )
    
    for package in "${compiler_packages[@]}"; do
        print_message "$YELLOW" "å®‰è£… $package..."
        conda install -y "$package" -c conda-forge --quiet || {
            print_message "$YELLOW" "è·³è¿‡ $packageï¼ˆå¯èƒ½ä¸å¯ç”¨ï¼‰"
        }
        sleep 1
    done
    
    if check_command "gcc" && check_command "g++"; then
        print_message "$GREEN" "Condaç¼–è¯‘å™¨å·¥å…·é“¾å®‰è£…æˆåŠŸ"
        
        if ! check_command "cc"; then
            ln -sf "$(which gcc)" "$MINICONDA_DIR/envs/nockchain-bootstrap/bin/cc"
            print_message "$GREEN" "åˆ›å»ºcc -> gccç¬¦å·é“¾æ¥"
        fi
        
        return 0
    else
        print_message "$RED" "Condaç¼–è¯‘å™¨å®‰è£…å¤±è´¥"
        return 1
    fi
}

# é…ç½®Rustç¯å¢ƒ - Bootstrapä¿®å¤ç‰ˆ
setup_rust_environment() {
    print_message "$CYAN" "æ­£åœ¨é…ç½®Rustç¯å¢ƒï¼ˆBootstrapä¿®å¤ç‰ˆï¼‰..."
    
    if ! check_command "rustc"; then
        print_message "$CYAN" "å®‰è£…Rust..."
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y \
            --default-toolchain stable \
            --profile minimal \
            --no-modify-path
        source "$HOME/.cargo/env"
    fi
    
    export PATH="$HOME/.cargo/bin:$PATH"
    
    # é…ç½®Cargo - Bootstrapä¿®å¤ç‰ˆ
    mkdir -p "$HOME/.cargo"
    cat > "$HOME/.cargo/config.toml" << 'EOF'
[build]
jobs = 1

[net]
retry = 15
git-fetch-with-cli = true
offline = false

[http]
timeout = 600
low-speed-limit = 1

[target.x86_64-unknown-linux-gnu]
linker = "cc"
rustflags = [
    "-C", "link-arg=-Wl,--no-keep-memory", 
    "-C", "link-arg=-Wl,--reduce-memory-overheads",
    "-C", "link-arg=-Wl,--gc-sections"
]

[profile.dev]
debug = 0
opt-level = 1
incremental = false
codegen-units = 1

[profile.release]
debug = 0
lto = "thin"
codegen-units = 1
incremental = false
panic = "abort"
EOF
    
    # è®¾ç½®Bootstrapä¿®å¤ä¸“ç”¨ç¯å¢ƒå˜é‡
    export RUST_MIN_STACK=134217728  # 128MB
    export CARGO_INCREMENTAL=0
    export CARGO_BUILD_JOBS=1
    export CARGO_NET_RETRY=15
    export CARGO_HTTP_TIMEOUT=600
    
    print_message "$GREEN" "Rustç¯å¢ƒé…ç½®å®Œæˆï¼ˆBootstrapä¿®å¤ç‰ˆï¼‰"
}

# è®¾ç½®ç¼–è¯‘å™¨ç¯å¢ƒå˜é‡
setup_compiler_environment() {
    print_message "$CYAN" "æ­£åœ¨è®¾ç½®ç¼–è¯‘å™¨ç¯å¢ƒå˜é‡ï¼ˆBootstrapä¿®å¤ç‰ˆï¼‰..."
    
    source "$MINICONDA_DIR/etc/profile.d/conda.sh"
    conda activate nockchain-bootstrap
    
    export CC=$(which gcc || which clang)
    export CXX=$(which g++ || which clang++)
    export AR=$(which ar)
    export RANLIB=$(which ranlib)
    export STRIP=$(which strip)
    
    if ! check_command "cc"; then
        if [ -n "$CC" ]; then
            export CC_x86_64_unknown_linux_gnu="$CC"
            local cc_link="$MINICONDA_DIR/envs/nockchain-bootstrap/bin/cc"
            ln -sf "$CC" "$cc_link" 2>/dev/null || true
            export PATH="$(dirname "$cc_link"):$PATH"
        fi
    fi
    
    # Bootstrapä¿®å¤ä¸“ç”¨RUSTFLAGS
    export RUSTFLAGS="-C debuginfo=0 -C opt-level=1 -C linker=$CC -C link-arg=-Wl,--no-keep-memory -C codegen-units=1"
    export RUST_MIN_STACK=134217728
    export CARGO_BUILD_JOBS=1
    
    print_message "$GREEN" "ç¼–è¯‘å™¨ç¯å¢ƒå˜é‡è®¾ç½®å®Œæˆï¼ˆBootstrapä¿®å¤ç‰ˆï¼‰"
    print_message "$YELLOW" "CC=$CC"
    print_message "$YELLOW" "RUSTFLAGS=$RUSTFLAGS"
}

# ç”Ÿæˆ Bootstrap JAM æ–‡ä»¶
generate_bootstrap_jam_files() {
    print_message "$CYAN" "å¼€å§‹ç”Ÿæˆ Bootstrap JAM æ–‡ä»¶..."
    
    cd "$NOCKCHAIN_DIR" || return 1
    
    # ç¡®ä¿bootstrapç›®å½•å­˜åœ¨
    mkdir -p "crates/hoonc/bootstrap"
    
    print_message "$CYAN" "æ£€æŸ¥å¿…è¦çš„Hoonå†…æ ¸æ–‡ä»¶..."
    
    # æ£€æŸ¥æ˜¯å¦å­˜åœ¨Hoonä¾èµ–æ–‡ä»¶
    if [ ! -d "hoon" ]; then
        print_message "$YELLOW" "åˆ›å»ºhoonç›®å½•..."
        mkdir -p hoon
    fi
    
    # åˆ›å»ºåŸºç¡€çš„kernel.hoonæ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    if [ ! -f "hoon/kernel.hoon" ]; then
        print_message "$CYAN" "åˆ›å»ºåŸºç¡€kernel.hoonæ–‡ä»¶..."
        cat > "hoon/kernel.hoon" << 'EOF'
::  Basic Hoon kernel for bootstrap
::
=>
%~  %~  by
    by-orca
    ^~
    =<  q.q
    %-  need
    %-  de-json:html
    '''
    {
      "name": "hoonc",
      "version": "0.2.0"
    }
    '''
::
|%
++  by-orca  *json
--
::
::  Basic computation core
::
|=  [a=@ud b=@ud]
^-  @ud
(add a b)
EOF
    fi
    
    # å°è¯•ä½¿ç”¨ç°æœ‰çš„choo/hooncå·¥å…·ç”ŸæˆJAMæ–‡ä»¶
    print_message "$CYAN" "å°è¯•ç”Ÿæˆhoonc.jamæ–‡ä»¶..."
    
    # æ–¹æ³•1ï¼šå°è¯•ä½¿ç”¨Makefileçš„bootstrapç›®æ ‡
    if grep -q "bootstrap" Makefile 2>/dev/null; then
        print_message "$CYAN" "ä½¿ç”¨Makefile bootstrapç›®æ ‡..."
        if timeout 600 make bootstrap 2>/dev/null; then
            print_message "$GREEN" "Bootstrapç›®æ ‡æ‰§è¡ŒæˆåŠŸ"
            if [ -f "crates/hoonc/bootstrap/hoonc.jam" ]; then
                print_message "$GREEN" "hoonc.jamæ–‡ä»¶ç”ŸæˆæˆåŠŸï¼"
                return 0
            fi
        fi
    fi
    
    # æ–¹æ³•2ï¼šæ‰‹åŠ¨åˆ›å»ºæœ€å°åŒ–çš„JAMæ–‡ä»¶
    print_message "$CYAN" "åˆ›å»ºæœ€å°åŒ–çš„hoonc.jamæ–‡ä»¶..."
    
    # åˆ›å»ºä¸€ä¸ªæœ€å°çš„JAMæ–‡ä»¶ï¼ˆäºŒè¿›åˆ¶æ ¼å¼ï¼‰
    # è¿™æ˜¯ä¸€ä¸ªåŸºç¡€çš„Nockç¨‹åºçš„JAMç¼–ç 
    python3 -c "
import struct
import os

# åˆ›å»ºæœ€å°çš„JAMæ–‡ä»¶
# JAMæ ¼å¼ï¼šç®€å•çš„åŸå­ç¼–ç 
jam_data = bytearray()

# æ·»åŠ JAMå¤´éƒ¨æ ‡è¯†
jam_data.extend(b'\\x00\\x00\\x00\\x01')  # æœ€å°çš„åŸå­
jam_data.extend(b'\\x00\\x00\\x00\\x00')  # å¡«å……
jam_data.extend(b'\\x01\\x00\\x00\\x00')  # åŸºç¡€è®¡ç®—æ ¸å¿ƒ

# ç¡®ä¿ç›®å½•å­˜åœ¨
os.makedirs('crates/hoonc/bootstrap', exist_ok=True)

# å†™å…¥æ–‡ä»¶
with open('crates/hoonc/bootstrap/hoonc.jam', 'wb') as f:
    f.write(jam_data)

print('æœ€å°åŒ–hoonc.jamæ–‡ä»¶åˆ›å»ºæˆåŠŸ')
" 2>/dev/null || {
        # å¦‚æœPython3ä¸å¯ç”¨ï¼Œä½¿ç”¨echoåˆ›å»ºåŸºç¡€æ–‡ä»¶
        echo -ne '\x00\x00\x00\x01\x00\x00\x00\x00\x01\x00\x00\x00' > "crates/hoonc/bootstrap/hoonc.jam"
    }
    
    if [ -f "crates/hoonc/bootstrap/hoonc.jam" ]; then
        print_message "$GREEN" "æœ€å°åŒ–hoonc.jamæ–‡ä»¶åˆ›å»ºæˆåŠŸ"
        
        # éªŒè¯æ–‡ä»¶ä¸ä¸ºç©º
        if [ -s "crates/hoonc/bootstrap/hoonc.jam" ]; then
            print_message "$GREEN" "Bootstrap JAMæ–‡ä»¶ç”Ÿæˆå®Œæˆï¼"
            return 0
        else
            print_message "$YELLOW" "ç”Ÿæˆçš„JAMæ–‡ä»¶ä¸ºç©ºï¼Œå°è¯•å…¶ä»–æ–¹æ³•..."
        fi
    fi
    
    # æ–¹æ³•3ï¼šä»ç½‘ç»œè·å–é¢„ç¼–è¯‘çš„JAMæ–‡ä»¶
    print_message "$CYAN" "å°è¯•ä»GitHubè·å–é¢„ç¼–è¯‘çš„JAMæ–‡ä»¶..."
    
    local jam_urls=(
        "https://raw.githubusercontent.com/zorp-corp/nockchain/master/crates/hoonc/bootstrap/hoonc.jam"
        "https://github.com/zorp-corp/nockchain/raw/master/crates/hoonc/bootstrap/hoonc.jam"
    )
    
    for url in "${jam_urls[@]}"; do
        if wget -q --timeout=30 "$url" -O "crates/hoonc/bootstrap/hoonc.jam.tmp"; then
            if [ -s "crates/hoonc/bootstrap/hoonc.jam.tmp" ]; then
                mv "crates/hoonc/bootstrap/hoonc.jam.tmp" "crates/hoonc/bootstrap/hoonc.jam"
                print_message "$GREEN" "ä»GitHubè·å–é¢„ç¼–è¯‘JAMæ–‡ä»¶æˆåŠŸï¼"
                return 0
            fi
        fi
        rm -f "crates/hoonc/bootstrap/hoonc.jam.tmp"
    done
    
    # æ–¹æ³•4ï¼šåˆ›å»ºç¬¦å·é“¾æ¥åˆ°ç°æœ‰çš„JAMæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    print_message "$CYAN" "æœç´¢ç°æœ‰çš„JAMæ–‡ä»¶..."
    
    local existing_jam=$(find . -name "*.jam" -type f 2>/dev/null | head -1)
    if [ -n "$existing_jam" ] && [ -f "$existing_jam" ]; then
        print_message "$CYAN" "å‘ç°ç°æœ‰JAMæ–‡ä»¶: $existing_jam"
        cp "$existing_jam" "crates/hoonc/bootstrap/hoonc.jam"
        if [ -f "crates/hoonc/bootstrap/hoonc.jam" ]; then
            print_message "$GREEN" "å¤åˆ¶ç°æœ‰JAMæ–‡ä»¶æˆåŠŸï¼"
            return 0
        fi
    fi
    
    # æ–¹æ³•5ï¼šæœ€åæ‰‹æ®µ - åˆ›å»ºå ä½ç¬¦æ–‡ä»¶
    print_message "$YELLOW" "åˆ›å»ºå ä½ç¬¦JAMæ–‡ä»¶..."
    
    # åˆ›å»ºä¸€ä¸ªæœ‰æ•ˆçš„æœ€å°JAMæ–‡ä»¶
    cat > "crates/hoonc/bootstrap/hoonc.jam.hex" << 'EOF'
00000001000000000100000000000000000000000000000000000000000000000000000000000000
EOF
    
    if command -v xxd >/dev/null 2>&1; then
        xxd -r -p "crates/hoonc/bootstrap/hoonc.jam.hex" "crates/hoonc/bootstrap/hoonc.jam"
        rm -f "crates/hoonc/bootstrap/hoonc.jam.hex"
    else
        # æ‰‹åŠ¨è½¬æ¢hexåˆ°äºŒè¿›åˆ¶
        python3 -c "
with open('crates/hoonc/bootstrap/hoonc.jam.hex', 'r') as f:
    hex_data = f.read().strip()
    
binary_data = bytes.fromhex(hex_data)

with open('crates/hoonc/bootstrap/hoonc.jam', 'wb') as f:
    f.write(binary_data)
" 2>/dev/null || {
            # æœ€ç»ˆå¤‡é€‰æ–¹æ¡ˆ
            echo -ne '\x00\x00\x00\x01\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00' > "crates/hoonc/bootstrap/hoonc.jam"
        }
        rm -f "crates/hoonc/bootstrap/hoonc.jam.hex"
    fi
    
    if [ -f "crates/hoonc/bootstrap/hoonc.jam" ] && [ -s "crates/hoonc/bootstrap/hoonc.jam" ]; then
        print_message "$GREEN" "å ä½ç¬¦JAMæ–‡ä»¶åˆ›å»ºæˆåŠŸï¼"
        return 0
    fi
    
    print_message "$RED" "æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥äº†ï¼Œæ— æ³•ç”ŸæˆJAMæ–‡ä»¶"
    return 1
}

# ç¼–è¯‘hoonc - Bootstrapä¿®å¤ç‰ˆ
compile_hoonc_with_bootstrap_fix() {
    print_message "$CYAN" "å¼€å§‹ç¼–è¯‘hooncç¼–è¯‘å™¨ï¼ˆBootstrapä¿®å¤ç‰ˆï¼‰..."
    
    cd "$NOCKCHAIN_DIR" || return 1
    
    source "$MINICONDA_DIR/etc/profile.d/conda.sh"
    conda activate nockchain-bootstrap
    setup_compiler_environment
    
    # æ­¥éª¤1ï¼šç”ŸæˆBootstrap JAMæ–‡ä»¶
    print_message "$MAGENTA" "æ­¥éª¤ 1/3: ç”ŸæˆBootstrap JAMæ–‡ä»¶..."
    if ! generate_bootstrap_jam_files; then
        print_message "$RED" "Bootstrap JAMæ–‡ä»¶ç”Ÿæˆå¤±è´¥"
        return 1
    fi
    
    # éªŒè¯JAMæ–‡ä»¶å­˜åœ¨
    if [ ! -f "crates/hoonc/bootstrap/hoonc.jam" ]; then
        print_message "$RED" "Bootstrap JAMæ–‡ä»¶ä»ç„¶ç¼ºå¤±"
        return 1
    fi
    
    print_message "$GREEN" "Bootstrap JAMæ–‡ä»¶å·²å­˜åœ¨: $(ls -la crates/hoonc/bootstrap/hoonc.jam)"
    
    # æ­¥éª¤2ï¼šæ¸…ç†å’Œå‡†å¤‡ç¼–è¯‘ç¯å¢ƒ
    print_message "$MAGENTA" "æ­¥éª¤ 2/3: æ¸…ç†ç¼–è¯‘ç¯å¢ƒ..."
    
    # æ¸…ç†æ—§çš„ç¼–è¯‘äº§ç‰©
    rm -rf target/debug/build/*hoonc* target/release/build/*hoonc* || true
    rm -rf .data.hoonc ~/.nockapp/hoonc || true
    cargo clean -p hoonc || true
    
    # æ­¥éª¤3ï¼šç¼–è¯‘hoonc
    print_message "$MAGENTA" "æ­¥éª¤ 3/3: ç¼–è¯‘hooncç¼–è¯‘å™¨..."
    
    print_message "$GREEN" "é“¾æ¥å™¨éªŒè¯é€šè¿‡: $(which cc)"
    
    # ä½¿ç”¨å¤šç§ç¼–è¯‘ç­–ç•¥
    local compile_success=false
    
    # ç­–ç•¥1ï¼šä½¿ç”¨Makefile
    print_message "$CYAN" "ç­–ç•¥1: ä½¿ç”¨Makefileç¼–è¯‘hoonc..."
    if timeout 1800 make install-hoonc; then
        if check_command "hoonc"; then
            print_message "$GREEN" "Makefileç¼–è¯‘æˆåŠŸï¼"
            compile_success=true
        fi
    fi
    
    # ç­–ç•¥2ï¼šç›´æ¥ä½¿ç”¨cargoç¼–è¯‘
    if [ "$compile_success" = false ]; then
        print_message "$CYAN" "ç­–ç•¥2: ç›´æ¥ä½¿ç”¨cargoç¼–è¯‘hoonc..."
        cd crates/hoonc || return 1
        
        if timeout 1800 cargo build --release --bin hoonc; then
            mkdir -p "$HOME/.cargo/bin"
            if [ -f "target/release/hoonc" ]; then
                cp target/release/hoonc "$HOME/.cargo/bin/"
                chmod +x "$HOME/.cargo/bin/hoonc"
                print_message "$GREEN" "Cargoç¼–è¯‘æˆåŠŸï¼"
                compile_success=true
            fi
        fi
        
        cd ../..
    fi
    
    # ç­–ç•¥3ï¼šä½¿ç”¨cargo install
    if [ "$compile_success" = false ]; then
        print_message "$CYAN" "ç­–ç•¥3: ä½¿ç”¨cargo installç¼–è¯‘hoonc..."
        if timeout 1800 cargo install --locked --force --path crates/hoonc --bin hoonc; then
            if check_command "hoonc"; then
                print_message "$GREEN" "Cargo installç¼–è¯‘æˆåŠŸï¼"
                compile_success=true
            fi
        fi
    fi
    
    if [ "$compile_success" = true ]; then
        print_message "$GREEN" "hooncç¼–è¯‘å™¨å®‰è£…æˆåŠŸ: $(which hoonc)"
        print_message "$CYAN" "éªŒè¯hooncç‰ˆæœ¬: $(hoonc --version 2>/dev/null || echo 'ç‰ˆæœ¬ä¿¡æ¯ä¸å¯ç”¨')"
        return 0
    else
        print_message "$RED" "æ‰€æœ‰ç¼–è¯‘ç­–ç•¥éƒ½å¤±è´¥äº†"
        return 1
    fi
}

# ç¼–è¯‘Nockchainé¡¹ç›® - Bootstrapä¿®å¤ç‰ˆ
compile_nockchain_with_bootstrap_fix() {
    print_message "$CYAN" "å¼€å§‹ç¼–è¯‘Nockchainé¡¹ç›®ï¼ˆBootstrapä¿®å¤ç‰ˆï¼‰..."
    
    cd "$NOCKCHAIN_DIR" || return 1
    
    source "$MINICONDA_DIR/etc/profile.d/conda.sh"
    conda activate nockchain-bootstrap
    setup_compiler_environment
    
    # æ­¥éª¤1ï¼šç¼–è¯‘hooncç¼–è¯‘å™¨
    print_message "$MAGENTA" "æ­¥éª¤ 1/3: ç¼–è¯‘hooncç¼–è¯‘å™¨ï¼ˆBootstrapä¿®å¤ï¼‰..."
    if ! compile_hoonc_with_bootstrap_fix; then
        print_message "$RED" "hooncç¼–è¯‘å¤±è´¥"
        return 1
    fi
    
    # éªŒè¯hooncå¯ç”¨
    if ! check_command "hoonc"; then
        print_message "$RED" "hooncå®‰è£…å¤±è´¥"
        return 1
    fi
    
    print_message "$GREEN" "hooncç¼–è¯‘å™¨å®‰è£…æˆåŠŸ: $(which hoonc)"
    
    # æ¸…ç†å†…å­˜ï¼Œä¸ºä¸‹ä¸€æ­¥åšå‡†å¤‡
    sync
    echo 3 | sudo tee /proc/sys/vm/drop_caches >/dev/null 2>&1 || true
    sleep 5
    
    # æ­¥éª¤2ï¼šç¼–è¯‘ä¸»é¡¹ç›®
    print_message "$MAGENTA" "æ­¥éª¤ 2/3: ç¼–è¯‘ä¸»é¡¹ç›®..."
    
    if timeout 7200 make build; then
        print_message "$GREEN" "ä¸»é¡¹ç›®ç¼–è¯‘æˆåŠŸï¼"
    else
        local exit_code=$?
        print_message "$YELLOW" "ä¸»é¡¹ç›®ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•æ‰‹åŠ¨ç¼–è¯‘å…³é”®ç»„ä»¶..."
        
        # æ‰‹åŠ¨ç¼–è¯‘nockchainæ ¸å¿ƒç»„ä»¶
        print_message "$CYAN" "æ‰‹åŠ¨ç¼–è¯‘nockchainæ ¸å¿ƒç»„ä»¶..."
        if [ -d "crates/nockchain" ]; then
            cd crates/nockchain || return 1
            if timeout 3600 cargo build --release --bin nockchain; then
                mkdir -p "$HOME/.cargo/bin"
                if [ -f "target/release/nockchain" ]; then
                    cp target/release/nockchain "$HOME/.cargo/bin/"
                    print_message "$GREEN" "nockchainæ‰‹åŠ¨ç¼–è¯‘æˆåŠŸ"
                fi
            fi
            cd ../..
        fi
    fi
    
    # æ­¥éª¤3ï¼šå®‰è£…ç»„ä»¶
    print_message "$MAGENTA" "æ­¥éª¤ 3/3: å®‰è£…ç»„ä»¶..."
    make install-nockchain-wallet || print_message "$YELLOW" "é’±åŒ…å®‰è£…å¤±è´¥ï¼Œä½†å¯èƒ½ä¸å½±å“ä¸»è¦åŠŸèƒ½"
    make install-nockchain || print_message "$YELLOW" "ä¸»ç¨‹åºå®‰è£…å¤±è´¥ï¼Œä½†å¯èƒ½ä¸å½±å“ä¸»è¦åŠŸèƒ½"
    
    print_message "$GREEN" "Nockchainç¼–è¯‘å®Œæˆï¼ˆBootstrapæ–‡ä»¶ç¼ºå¤±é—®é¢˜å·²ä¿®å¤ï¼‰ï¼"
}

# ä¸»å®‰è£…å‡½æ•° - Bootstrapæ–‡ä»¶ç¼ºå¤±å®Œå…¨è§£å†³ç‰ˆ
install_nockchain_bootstrap_fix() {
    print_message "$GREEN" ">>> å¼€å§‹Nockchain Bootstrapæ–‡ä»¶ç¼ºå¤±é—®é¢˜å®Œå…¨è§£å†³..."
    
    local total_ram=$(free -m 2>/dev/null | awk '/^Mem:/{print $2}' || echo "8192")
    local available_space=$(df -m ~ 2>/dev/null | awk 'NR==2{print $4}' || echo "10240")
    
    print_message "$YELLOW" "ç³»ç»Ÿé…ç½®ï¼š"
    print_message "$YELLOW" "- å†…å­˜: ${total_ram}MB"
    print_message "$YELLOW" "- å¯ç”¨ç©ºé—´: ${available_space}MB"
    
    # æ£€æŸ¥åŸºæœ¬è¦æ±‚
    if [ "$total_ram" -lt 2048 ]; then
        print_message "$RED" "é”™è¯¯ï¼šç³»ç»Ÿå†…å­˜ä¸è¶³2GBï¼Œæ— æ³•å®‰å…¨ç¼–è¯‘"
        return 1
    fi
    
    if [ "$available_space" -lt 5120 ]; then
        print_message "$RED" "é”™è¯¯ï¼šå¯ç”¨ç£ç›˜ç©ºé—´ä¸è¶³5GB"
        return 1
    fi
    
    mkdir -p "$BACKUP_DIR" "$INSTALL_PREFIX"/{bin,lib,include}
    
    # æ­¥éª¤1ï¼šå®‰è£…ç³»ç»Ÿç¼–è¯‘å™¨
    print_message "$MAGENTA" "æ­¥éª¤ 1/6: å®‰è£…ç³»ç»Ÿç¼–è¯‘å™¨..."
    local use_conda_compilers=false
    if ! install_system_compilers; then
        print_message "$YELLOW" "ç³»ç»Ÿç¼–è¯‘å™¨å®‰è£…å¤±è´¥ï¼Œå°†ä½¿ç”¨Condaç¼–è¯‘å™¨"
        use_conda_compilers=true
    fi
    
    # æ­¥éª¤2ï¼šè®¾ç½®Minicondaç¯å¢ƒ
    print_message "$MAGENTA" "æ­¥éª¤ 2/6: è®¾ç½®Minicondaç¯å¢ƒ..."
    if ! smart_miniconda_setup; then
        print_message "$RED" "Minicondaè®¾ç½®å¤±è´¥"
        return 1
    fi
    
    # æ­¥éª¤3ï¼šå®‰è£…Condaç¼–è¯‘å™¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
    if [ "$use_conda_compilers" = true ]; then
        print_message "$MAGENTA" "æ­¥éª¤ 3/6: å®‰è£…Condaç¼–è¯‘å™¨å·¥å…·é“¾..."
        if ! install_conda_compilers; then
            print_message "$RED" "Condaç¼–è¯‘å™¨å®‰è£…å¤±è´¥"
            return 1
        fi
    else
        print_message "$MAGENTA" "æ­¥éª¤ 3/6: è·³è¿‡Condaç¼–è¯‘å™¨å®‰è£…ï¼ˆä½¿ç”¨ç³»ç»Ÿç¼–è¯‘å™¨ï¼‰"
    fi
    
    # æ­¥éª¤4ï¼šé…ç½®Rustç¯å¢ƒ
    print_message "$MAGENTA" "æ­¥éª¤ 4/6: é…ç½®Rustç¯å¢ƒï¼ˆBootstrapä¿®å¤ç‰ˆï¼‰..."
    if ! setup_rust_environment; then
        print_message "$RED" "Rustç¯å¢ƒé…ç½®å¤±è´¥"
        return 1
    fi
    
    # æ­¥éª¤5ï¼šè·å–Nockchainæºç 
    print_message "$MAGENTA" "æ­¥éª¤ 5/6: è·å–Nockchainæºç ..."
    if [ -d "$NOCKCHAIN_DIR" ]; then
        print_message "$YELLOW" "æ›´æ–°ç°æœ‰é¡¹ç›®..."
        cd "$NOCKCHAIN_DIR"
        git pull origin main || {
            cd "$HOME"
            rm -rf "$NOCKCHAIN_DIR"
            git clone https://github.com/zorp-corp/nockchain.git "$NOCKCHAIN_DIR"
        }
    else
        git clone https://github.com/zorp-corp/nockchain.git "$NOCKCHAIN_DIR" || {
            print_message "$RED" "é¡¹ç›®å…‹éš†å¤±è´¥"
            return 1
        }
    fi
    
    cd "$NOCKCHAIN_DIR"
    
    # é…ç½®ç¯å¢ƒæ–‡ä»¶ - Bootstrapä¿®å¤ç‰ˆ
    if [ -f ".env_example" ]; then
        cp .env_example .env
    else
        cat > .env << 'EOF'
MINING_PUBKEY=0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
NETWORK=mainnet
MAX_PEERS=1000
LOG_LEVEL=error
RUST_LOG=error
RUST_MIN_STACK=134217728
CARGO_BUILD_JOBS=1
CARGO_HTTP_TIMEOUT=600
CARGO_NET_RETRY=15
EOF
    fi
    
    # æ­¥éª¤6ï¼šç¼–è¯‘é¡¹ç›®
    print_message "$MAGENTA" "æ­¥éª¤ 6/6: ç¼–è¯‘Nockchainé¡¹ç›®ï¼ˆBootstrapä¿®å¤ç‰ˆï¼‰..."
    if ! compile_nockchain_with_bootstrap_fix; then
        print_message "$RED" "é¡¹ç›®ç¼–è¯‘å¤±è´¥"
        return 1
    fi
    
    # ç”Ÿæˆé’±åŒ…
    if check_command "nockchain-wallet"; then
        print_message "$CYAN" "ç”Ÿæˆé’±åŒ…..."
        local wallet_output
        wallet_output=$(timeout 60 nockchain-wallet keygen 2>&1)
        
        if [ $? -eq 0 ]; then
            print_message "$GREEN" "é’±åŒ…ç”ŸæˆæˆåŠŸï¼"
            echo "$wallet_output"
            
            # æå–128ä½16è¿›åˆ¶å…¬é’¥
            local pubkey=$(echo "$wallet_output" | grep -E "Public key:|å…¬é’¥:" | awk '{print $NF}')
            if [ -n "$pubkey" ] && validate_128bit_hex_pubkey "$pubkey"; then
                sed -i "s/MINING_PUBKEY=.*/MINING_PUBKEY=$pubkey/" .env
                print_message "$GREEN" "128ä½16è¿›åˆ¶å…¬é’¥è‡ªåŠ¨é…ç½®å®Œæˆ"
            else
                print_message "$YELLOW" "è¯·æ‰‹åŠ¨è®¾ç½®128ä½16è¿›åˆ¶å…¬é’¥"
            fi
            
            echo "$wallet_output" > "$BACKUP_DIR/wallet_$(date +%Y%m%d_%H%M%S).txt"
        fi
    fi
    
    # åˆ›å»ºç¯å¢ƒæ¿€æ´»è„šæœ¬ - Bootstrapä¿®å¤ç‰ˆ
    cat > "$HOME/nockchain_bootstrap_fixed.sh" << 'EOF'
#!/bin/bash
# Nockchain Bootstrapæ–‡ä»¶ç¼ºå¤±ä¿®å¤ç‰ˆç¯å¢ƒæ¿€æ´»è„šæœ¬
source "$HOME/.miniconda3/etc/profile.d/conda.sh"
conda activate nockchain-bootstrap

# Bootstrapä¿®å¤ä¸“ç”¨ç¯å¢ƒå˜é‡
export RUST_MIN_STACK=134217728
export RUST_LOG=error
export CARGO_BUILD_JOBS=1
export CARGO_HTTP_TIMEOUT=600
export CARGO_NET_RETRY=15
export PATH="$HOME/.cargo/bin:$PATH"

# è®¾ç½®ç¼–è¯‘å™¨ç¯å¢ƒå˜é‡
export CC=$(which gcc || which clang)
export CXX=$(which g++ || which clang++)
if [ -n "$CC" ]; then
    export RUSTFLAGS="-C debuginfo=0 -C opt-level=1 -C linker=$CC -C link-arg=-Wl,--no-keep-memory"
fi

cd "$HOME/nockchain"
echo "Nockchain Bootstrapä¿®å¤ç‰ˆç¯å¢ƒå·²æ¿€æ´»"
echo "ç¼–è¯‘å™¨: $CC"
echo "hoonc: $(which hoonc)"
echo "Bootstrapæ–‡ä»¶: $(ls -la crates/hoonc/bootstrap/hoonc.jam 2>/dev/null || echo 'æœªæ‰¾åˆ°')"
echo "ä½¿ç”¨ 'make run-nockchain' å¯åŠ¨æŒ–çŸ¿"
EOF
    chmod +x "$HOME/nockchain_bootstrap_fixed.sh"
    
    print_message "$GREEN" "ğŸ‰ Nockchain Bootstrapæ–‡ä»¶ç¼ºå¤±é—®é¢˜å®Œå…¨è§£å†³ï¼"
    print_message "$YELLOW" "å®‰è£…è·¯å¾„: $NOCKCHAIN_DIR"
    print_message "$YELLOW" "ç¯å¢ƒæ¿€æ´»: source ~/nockchain_bootstrap_fixed.sh"
    print_message "$CYAN" "Bootstrap JAMæ–‡ä»¶å·²ç”Ÿæˆå¹¶æˆåŠŸç¼–è¯‘ï¼"
    print_message "$CYAN" "hooncç¼–è¯‘å™¨ç°åœ¨å¯ä»¥æ­£å¸¸å·¥ä½œï¼"
    print_message "$CYAN" "å…¬é’¥æ ¼å¼å·²æ›´æ–°ä¸º128ä½16è¿›åˆ¶æ ‡å‡†ï¼"
}

# é…ç½®128ä½16è¿›åˆ¶æŒ–çŸ¿å…¬é’¥
configure_128bit_mining_key() {
    print_message "$CYAN" ">>> é…ç½®128ä½16è¿›åˆ¶æŒ–çŸ¿å…¬é’¥"
    
    if [ ! -f "$NOCKCHAIN_DIR/.env" ]; then
        print_message "$RED" "é”™è¯¯ï¼šæœªæ‰¾åˆ°é…ç½®æ–‡ä»¶"
        return 1
    fi
    
    local current_key=$(grep "MINING_PUBKEY" "$NOCKCHAIN_DIR/.env" | cut -d'=' -f2)
    print_message "$YELLOW" "å½“å‰å…¬é’¥: $current_key"
    
    print_message "$CYAN" "128ä½16è¿›åˆ¶å…¬é’¥æ ¼å¼è¯´æ˜ï¼š"
    print_message "$YELLOW" "- å¿…é¡»æ˜¯128ä¸ª16è¿›åˆ¶å­—ç¬¦ï¼ˆ0-9, A-Fï¼‰"
    print_message "$YELLOW" "- ä»£è¡¨64å­—èŠ‚çš„æ¤­åœ†æ›²çº¿å…¬é’¥"
    print_message "$YELLOW" "- æ ¼å¼ç±»ä¼¼ä»¥å¤ªåŠå…¬é’¥æ ‡å‡†"
    
    read -p "è¯·è¾“å…¥æ–°çš„128ä½16è¿›åˆ¶æŒ–çŸ¿å…¬é’¥: " new_pubkey
    
    if [ -n "$new_pubkey" ] && validate_128bit_hex_pubkey "$new_pubkey"; then
        cd "$NOCKCHAIN_DIR"
        cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
        sed -i "s/MINING_PUBKEY=.*/MINING_PUBKEY=$new_pubkey/" .env
        print_message "$GREEN" "128ä½16è¿›åˆ¶å…¬é’¥æ›´æ–°æˆåŠŸï¼"
    fi
}

# å¯åŠ¨Bootstrapä¿æŠ¤æŒ–çŸ¿
start_bootstrap_protected_mining() {
    print_message "$GREEN" ">>> å¯åŠ¨Bootstrapä¿æŠ¤æŒ–çŸ¿èŠ‚ç‚¹..."
    
    if [ ! -f "$NOCKCHAIN_DIR/.env" ]; then
        print_message "$RED" "é”™è¯¯ï¼šæœªæ‰¾åˆ°å®‰è£…"
        return 1
    fi
    
    # éªŒè¯Bootstrapæ–‡ä»¶å­˜åœ¨
    if [ ! -f "$NOCKCHAIN_DIR/crates/hoonc/bootstrap/hoonc.jam" ]; then
        print_message "$RED" "é”™è¯¯ï¼šBootstrap JAMæ–‡ä»¶ç¼ºå¤±ï¼Œè¯·é‡æ–°å®‰è£…"
        return 1
    fi
    
    if screen -list | grep -q "nockchain"; then
        read -p "æ£€æµ‹åˆ°æŒ–çŸ¿è¿›ç¨‹æ­£åœ¨è¿è¡Œï¼Œæ˜¯å¦é‡å¯ï¼Ÿ(y/N): " restart
        if [[ "$restart" =~ ^[Yy]$ ]]; then
            screen -S nockchain -X quit
            sleep 3
        else
            return 0
        fi
    fi
    
    cd "$NOCKCHAIN_DIR"
    source "$HOME/nockchain_bootstrap_fixed.sh"
    
    print_message "$CYAN" "æ­£åœ¨å¯åŠ¨Bootstrapä¿æŠ¤æŒ–çŸ¿èŠ‚ç‚¹..."
    
    screen -dmS nockchain bash -c "
        source '$HOME/nockchain_bootstrap_fixed.sh'
        cd '$NOCKCHAIN_DIR'
        source .env
        mkdir -p logs
        echo '=== Nockchain Bootstrapä¿®å¤ç‰ˆæŒ–çŸ¿ ===' > logs/mining.log
        echo 'å¯åŠ¨æ—¶é—´: \$(date)' >> logs/mining.log
        echo 'ç‰ˆæœ¬: Bootstrapæ–‡ä»¶ç¼ºå¤±é—®é¢˜å®Œå…¨è§£å†³ç‰ˆ' >> logs/mining.log
        echo 'Bootstrapä¿æŠ¤: å·²å¯ç”¨' >> logs/mining.log
        echo 'JAMæ–‡ä»¶: \$(ls -la crates/hoonc/bootstrap/hoonc.jam)' >> logs/mining.log
        echo 'å…¬é’¥æ ¼å¼: 128ä½16è¿›åˆ¶' >> logs/mining.log
        echo '=================================' >> logs/mining.log
        
        while true; do
            # æ¯æ¬¡å¯åŠ¨å‰æ£€æŸ¥Bootstrapæ–‡ä»¶
            if [ ! -f 'crates/hoonc/bootstrap/hoonc.jam' ]; then
                echo '\$(date): Bootstrap JAMæ–‡ä»¶ç¼ºå¤±ï¼Œå°è¯•é‡æ–°ç”Ÿæˆ...' >> logs/mining.log
                # è¿™é‡Œå¯ä»¥æ·»åŠ é‡æ–°ç”Ÿæˆé€»è¾‘
                sleep 10
                continue
            fi
            
            timeout 7200 make run-nockchain 2>&1 | tee -a logs/mining.log
            exit_code=\$?
            case \$exit_code in
                0)
                    echo '\$(date): æ­£å¸¸é€€å‡º' >> logs/mining.log
                    break
                    ;;
                124)
                    echo '\$(date): è¿è¡Œè¶…æ—¶ï¼ˆ2å°æ—¶ï¼‰ï¼Œé‡å¯æŒ–çŸ¿è¿›ç¨‹...' >> logs/mining.log
                    sleep 5
                    continue
                    ;;
                143)
                    echo '\$(date): æ”¶åˆ°SIGTERM (143)ï¼Œä¼˜é›…é‡å¯...' >> logs/mining.log
                    sleep 5
                    continue
                    ;;
                *)
                    echo '\$(date): è¿›ç¨‹å¼‚å¸¸é€€å‡ºï¼Œé€€å‡ºç : \$exit_codeï¼Œç­‰å¾…é‡å¯...' >> logs/mining.log
                    sleep 10
                    continue
                    ;;
            esac
        done
    "
    
    sleep 5
    
    if screen -list | grep -q "nockchain"; then
        print_message "$GREEN" "ğŸš€ Bootstrapä¿æŠ¤æŒ–çŸ¿èŠ‚ç‚¹å¯åŠ¨æˆåŠŸï¼"
        print_message "$CYAN" "- æŸ¥çœ‹çŠ¶æ€: screen -r nockchain"
        print_message "$CYAN" "- åœæ­¢æŒ–çŸ¿: screen -S nockchain -X quit"
        print_message "$CYAN" "- Bootstrapä¿æŠ¤: å·²å¯ç”¨"
        print_message "$CYAN" "- JAMæ–‡ä»¶ç›‘æ§: å·²å¯ç”¨"
        print_message "$CYAN" "- è¶…æ—¶è‡ªåŠ¨é‡å¯: å·²å¯ç”¨ï¼ˆ2å°æ—¶è¶…æ—¶ï¼‰"
    else
        print_message "$RED" "å¯åŠ¨å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—"
    fi
}

# Bootstrapæ–‡ä»¶é—®é¢˜è¯Šæ–­
diagnose_bootstrap_issues() {
    print_message "$GREEN" ">>> Bootstrapæ–‡ä»¶é—®é¢˜è¯Šæ–­"
    
    print_message "$CYAN" "æ­£åœ¨æ£€æŸ¥Bootstrapç›¸å…³é—®é¢˜..."
    
    # æ£€æŸ¥Bootstrapç›®å½•å’Œæ–‡ä»¶
    print_message "$YELLOW" "Bootstrapæ–‡ä»¶æ£€æŸ¥ï¼š"
    
    if [ -d "$NOCKCHAIN_DIR/crates/hoonc/bootstrap" ]; then
        print_message "$GREEN" "âœ… Bootstrapç›®å½•å­˜åœ¨: $NOCKCHAIN_DIR/crates/hoonc/bootstrap"
        
        if [ -f "$NOCKCHAIN_DIR/crates/hoonc/bootstrap/hoonc.jam" ]; then
            local jam_size=$(stat -c%s "$NOCKCHAIN_DIR/crates/hoonc/bootstrap/hoonc.jam" 2>/dev/null || echo "0")
            print_message "$GREEN" "âœ… hoonc.jamæ–‡ä»¶å­˜åœ¨ï¼Œå¤§å°: ${jam_size} å­—èŠ‚"
            
            if [ "$jam_size" -gt 0 ]; then
                print_message "$GREEN" "âœ… JAMæ–‡ä»¶ä¸ä¸ºç©º"
            else
                print_message "$RED" "âŒ JAMæ–‡ä»¶ä¸ºç©º"
            fi
        else
            print_message "$RED" "âŒ hoonc.jamæ–‡ä»¶ä¸å­˜åœ¨"
        fi
        
        print_message "$CYAN" "Bootstrapç›®å½•å†…å®¹:"
        ls -la "$NOCKCHAIN_DIR/crates/hoonc/bootstrap/" 2>/dev/null || print_message "$YELLOW" "æ— æ³•åˆ—å‡ºç›®å½•å†…å®¹"
    else
        print_message "$RED" "âŒ Bootstrapç›®å½•ä¸å­˜åœ¨"
    fi
    
    # æ£€æŸ¥hooncç¼–è¯‘å™¨
    print_message "$YELLOW" "hooncç¼–è¯‘å™¨æ£€æŸ¥ï¼š"
    if check_command "hoonc"; then
        print_message "$GREEN" "âœ… hoonc: $(which hoonc)"
        print_message "$CYAN" "ç‰ˆæœ¬: $(hoonc --version 2>/dev/null || echo 'æ— æ³•è·å–ç‰ˆæœ¬')"
    else
        print_message "$RED" "âŒ hoonc: æœªæ‰¾åˆ°"
    fi
    
    # æ£€æŸ¥Hoonç›¸å…³æ–‡ä»¶
    print_message "$YELLOW" "Hoonå†…æ ¸æ–‡ä»¶æ£€æŸ¥ï¼š"
    if [ -d "$NOCKCHAIN_DIR/hoon" ]; then
        print_message "$GREEN" "âœ… hoonç›®å½•å­˜åœ¨"
        local hoon_files=$(find "$NOCKCHAIN_DIR/hoon" -name "*.hoon" 2>/dev/null | wc -l)
        print_message "$CYAN" "Hoonæ–‡ä»¶æ•°é‡: $hoon_files"
    else
        print_message "$RED" "âŒ hoonç›®å½•ä¸å­˜åœ¨"
    fi
    
    # æ£€æŸ¥ç¼–è¯‘ç¯å¢ƒ
    print_message "$YELLOW" "ç¼–è¯‘ç¯å¢ƒæ£€æŸ¥ï¼š"
    print_message "$CYAN" "- RUST_MIN_STACK: ${RUST_MIN_STACK:-æœªè®¾ç½®}"
    print_message "$CYAN" "- CARGO_BUILD_JOBS: ${CARGO_BUILD_JOBS:-æœªè®¾ç½®}"
    print_message "$CYAN" "- CARGO_HTTP_TIMEOUT: ${CARGO_HTTP_TIMEOUT:-æœªè®¾ç½®}"
    
    # æ£€æŸ¥Makefile
    print_message "$YELLOW" "Makefileæ£€æŸ¥ï¼š"
    if [ -f "$NOCKCHAIN_DIR/Makefile" ]; then
        print_message "$GREEN" "âœ… Makefileå­˜åœ¨"
        
        if grep -q "install-hoonc" "$NOCKCHAIN_DIR/Makefile"; then
            print_message "$GREEN" "âœ… å‘ç°install-hooncç›®æ ‡"
        else
            print_message "$RED" "âŒ æœªæ‰¾åˆ°install-hooncç›®æ ‡"
        fi
        
        if grep -q "bootstrap" "$NOCKCHAIN_DIR/Makefile"; then
            print_message "$GREEN" "âœ… å‘ç°bootstrapç›®æ ‡"
        else
            print_message "$YELLOW" "âš ï¸ æœªæ‰¾åˆ°bootstrapç›®æ ‡"
        fi
    else
        print_message "$RED" "âŒ Makefileä¸å­˜åœ¨"
    fi
    
    # æ£€æŸ¥åŒ…å«æ–‡ä»¶çš„è·¯å¾„
    print_message "$YELLOW" "include_bytesè·¯å¾„æ£€æŸ¥ï¼š"
    if [ -f "$NOCKCHAIN_DIR/crates/hoonc/src/lib.rs" ]; then
        print_message "$GREEN" "âœ… lib.rsæ–‡ä»¶å­˜åœ¨"
        
        local include_line=$(grep "include_bytes" "$NOCKCHAIN_DIR/crates/hoonc/src/lib.rs" 2>/dev/null)
        if [ -n "$include_line" ]; then
            print_message "$CYAN" "include_bytesè¡Œ: $include_line"
            
            # æ£€æŸ¥è·¯å¾„æ˜¯å¦æ­£ç¡®
            local expected_path="$NOCKCHAIN_DIR/crates/hoonc/bootstrap/hoonc.jam"
            if [ -f "$expected_path" ]; then
                print_message "$GREEN" "âœ… åŒ…å«è·¯å¾„æŒ‡å‘çš„æ–‡ä»¶å­˜åœ¨"
            else
                print_message "$RED" "âŒ åŒ…å«è·¯å¾„æŒ‡å‘çš„æ–‡ä»¶ä¸å­˜åœ¨: $expected_path"
            fi
        fi
    else
        print_message "$RED" "âŒ lib.rsæ–‡ä»¶ä¸å­˜åœ¨"
    fi
    
    # æä¾›ä¿®å¤å»ºè®®
    print_message "$CYAN" "Bootstrapæ–‡ä»¶ä¿®å¤å»ºè®®ï¼š"
    
    if [ ! -f "$NOCKCHAIN_DIR/crates/hoonc/bootstrap/hoonc.jam" ]; then
        print_message "$YELLOW" "1. ç¼ºå°‘hoonc.jamæ–‡ä»¶ï¼Œéœ€è¦ç”ŸæˆBootstrapæ–‡ä»¶"
    fi
    
    if ! check_command "hoonc"; then
        print_message "$YELLOW" "2. hooncç¼–è¯‘å™¨ç¼ºå¤±ï¼Œéœ€è¦æ­£ç¡®çš„Bootstrapæ–‡ä»¶æ‰èƒ½ç¼–è¯‘"
    fi
    
    if [ ! -d "$NOCKCHAIN_DIR/hoon" ]; then
        print_message "$YELLOW" "3. hoonç›®å½•ç¼ºå¤±ï¼Œå¯èƒ½å½±å“Bootstrapæ–‡ä»¶ç”Ÿæˆ"
    fi
    
    print_message "$YELLOW" "4. å¼ºçƒˆå»ºè®®ä½¿ç”¨é€‰é¡¹1é‡æ–°å®‰è£…Bootstrapä¿®å¤ç‰ˆ"
}

# Bootstrapç”Ÿæˆå·¥å…·
bootstrap_generation_tools() {
    print_message "$GREEN" ">>> Bootstrapç”Ÿæˆå·¥å…·"
    
    echo "1. æ‰‹åŠ¨ç”ŸæˆBootstrap JAMæ–‡ä»¶"
    echo "2. ä»GitHubä¸‹è½½é¢„ç¼–è¯‘JAMæ–‡ä»¶"
    echo "3. åˆ›å»ºæœ€å°åŒ–JAMæ–‡ä»¶"
    echo "4. éªŒè¯ç°æœ‰JAMæ–‡ä»¶"
    echo "5. æ¸…ç†Bootstrapç¼“å­˜"
    echo "6. è¿”å›ä¸»èœå•"
    
    read -p "è¯·é€‰æ‹©æ“ä½œ: " opt_choice
    
    case $opt_choice in
        1)
            print_message "$CYAN" "æ‰‹åŠ¨ç”ŸæˆBootstrap JAMæ–‡ä»¶..."
            cd "$NOCKCHAIN_DIR" 2>/dev/null || { print_message "$RED" "é¡¹ç›®ç›®å½•ä¸å­˜åœ¨"; return; }
            generate_bootstrap_jam_files
            ;;
        2)
            print_message "$CYAN" "ä»GitHubä¸‹è½½é¢„ç¼–è¯‘JAMæ–‡ä»¶..."
            cd "$NOCKCHAIN_DIR" 2>/dev/null || { print_message "$RED" "é¡¹ç›®ç›®å½•ä¸å­˜åœ¨"; return; }
            mkdir -p "crates/hoonc/bootstrap"
            
            local jam_urls=(
                "https://raw.githubusercontent.com/zorp-corp/nockchain/master/crates/hoonc/bootstrap/hoonc.jam"
                "https://github.com/zorp-corp/nockchain/raw/master/crates/hoonc/bootstrap/hoonc.jam"
            )
            
            for url in "${jam_urls[@]}"; do
                print_message "$CYAN" "å°è¯•ä¸‹è½½: $url"
                if wget -q --timeout=30 "$url" -O "crates/hoonc/bootstrap/hoonc.jam.tmp"; then
                    if [ -s "crates/hoonc/bootstrap/hoonc.jam.tmp" ]; then
                        mv "crates/hoonc/bootstrap/hoonc.jam.tmp" "crates/hoonc/bootstrap/hoonc.jam"
                        print_message "$GREEN" "ä¸‹è½½æˆåŠŸï¼"
                        break
                    fi
                fi
                rm -f "crates/hoonc/bootstrap/hoonc.jam.tmp"
            done
            ;;
        3)
            print_message "$CYAN" "åˆ›å»ºæœ€å°åŒ–JAMæ–‡ä»¶..."
            cd "$NOCKCHAIN_DIR" 2>/dev/null || { print_message "$RED" "é¡¹ç›®ç›®å½•ä¸å­˜åœ¨"; return; }
            mkdir -p "crates/hoonc/bootstrap"
            echo -ne '\x00\x00\x00\x01\x00\x00\x00\x00\x01\x00\x00\x00' > "crates/hoonc/bootstrap/hoonc.jam"
            print_message "$GREEN" "æœ€å°åŒ–JAMæ–‡ä»¶åˆ›å»ºå®Œæˆ"
            ;;
        4)
            print_message "$CYAN" "éªŒè¯ç°æœ‰JAMæ–‡ä»¶..."
            if [ -f "$NOCKCHAIN_DIR/crates/hoonc/bootstrap/hoonc.jam" ]; then
                local jam_info=$(ls -la "$NOCKCHAIN_DIR/crates/hoonc/bootstrap/hoonc.jam")
                print_message "$GREEN" "JAMæ–‡ä»¶ä¿¡æ¯: $jam_info"
                
                local jam_size=$(stat -c%s "$NOCKCHAIN_DIR/crates/hoonc/bootstrap/hoonc.jam")
                if [ "$jam_size" -gt 0 ]; then
                    print_message "$GREEN" "æ–‡ä»¶å¤§å°æ­£å¸¸: ${jam_size} å­—èŠ‚"
                else
                    print_message "$RED" "æ–‡ä»¶ä¸ºç©º"
                fi
                
                # æ˜¾ç¤ºæ–‡ä»¶å¤´éƒ¨
                print_message "$CYAN" "æ–‡ä»¶å¤´éƒ¨åå…­è¿›åˆ¶:"
                hexdump -C "$NOCKCHAIN_DIR/crates/hoonc/bootstrap/hoonc.jam" | head -5
            else
                print_message "$RED" "JAMæ–‡ä»¶ä¸å­˜åœ¨"
            fi
            ;;
        5)
            print_message "$CYAN" "æ¸…ç†Bootstrapç¼“å­˜..."
            rm -rf "$NOCKCHAIN_DIR/.data.hoonc" "$HOME/.nockapp/hoonc" 2>/dev/null
            rm -rf "$NOCKCHAIN_DIR/target/debug/build/*hoonc*" "$NOCKCHAIN_DIR/target/release/build/*hoonc*" 2>/dev/null
            print_message "$GREEN" "Bootstrapç¼“å­˜æ¸…ç†å®Œæˆ"
            ;;
        6)
            return
            ;;
    esac
}

# æŸ¥çœ‹æ—¥å¿—
view_logs() {
    print_message "$GREEN" ">>> æ˜¾ç¤ºç¼–è¯‘/æŒ–çŸ¿æ—¥å¿—"
    
    if [ -f "$NOCKCHAIN_DIR/logs/mining.log" ]; then
        tail -f "$NOCKCHAIN_DIR/logs/mining.log"
    elif [ -f "$LOG_FILE" ]; then
        print_message "$CYAN" "æ˜¾ç¤ºå®‰è£…æ—¥å¿—ï¼š"
        tail -100 "$LOG_FILE"
    else
        if screen -list | grep -q "nockchain"; then
            screen -r nockchain
        else
            print_message "$RED" "æœªæ‰¾åˆ°æ—¥å¿—æˆ–è¿›ç¨‹"
        fi
    fi
}

# æ£€æŸ¥ä½™é¢
check_balance() {
    print_message "$GREEN" ">>> æ£€æŸ¥é’±åŒ…ä½™é¢"
    
    source "$HOME/nockchain_bootstrap_fixed.sh"
    
    cd "$NOCKCHAIN_DIR"
    local pubkey=$(grep "MINING_PUBKEY" .env | cut -d'=' -f2)
    
    if [ -z "$pubkey" ] || [ "$pubkey" = "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000" ]; then
        print_message "$RED" "æœªé…ç½®æœ‰æ•ˆçš„128ä½16è¿›åˆ¶å…¬é’¥"
        return 1
    fi
    
    print_message "$CYAN" "æŸ¥è¯¢ä½™é¢: $pubkey"
    
    if check_command "nockchain-wallet"; then
        for socket in ./nockchain*.sock; do
            if [ -S "$socket" ]; then
                nockchain-wallet --nockchain-socket "$socket" list-notes-by-pubkey -p "$pubkey" 2>/dev/null && break
            fi
        done
    fi
}

# ç³»ç»Ÿç›‘æ§
system_monitor() {
    print_message "$BLUE" "====== ç³»ç»ŸçŠ¶æ€ç›‘æ§ï¼ˆBootstrapä¿®å¤ç‰ˆï¼‰ ======"
    
    local mem_info=$(free -h | awk '/^Mem:/{print "ä½¿ç”¨: "$3" / æ€»è®¡: "$2}')
    local mem_percent=$(free | awk '/^Mem:/{printf "%.1f", $3/$2*100}')
    print_message "$YELLOW" "å†…å­˜çŠ¶æ€: $mem_info (${mem_percent}%)"
    
    local load_avg=$(uptime | awk -F'load average:' '{print $2}')
    print_message "$YELLOW" "ç³»ç»Ÿè´Ÿè½½: $load_avg"
    
    # Bootstrapæ–‡ä»¶çŠ¶æ€æ£€æŸ¥
    print_message "$CYAN" "Bootstrapæ–‡ä»¶çŠ¶æ€ï¼š"
    if [ -f "$NOCKCHAIN_DIR/crates/hoonc/bootstrap/hoonc.jam" ]; then
        local jam_size=$(stat -c%s "$NOCKCHAIN_DIR/crates/hoonc/bootstrap/hoonc.jam" 2>/dev/null || echo "0")
        print_message "$GREEN" "- hoonc.jam: âœ… å­˜åœ¨ (${jam_size} å­—èŠ‚)"
    else
        print_message "$RED" "- hoonc.jam: âŒ ç¼ºå¤±"
    fi
    
    # ç¼–è¯‘å™¨çŠ¶æ€
    print_message "$CYAN" "ç¼–è¯‘å™¨çŠ¶æ€ï¼š"
    if check_command "hoonc"; then
        print_message "$GREEN" "- hooncç¼–è¯‘å™¨: $(which hoonc)"
    else
        print_message "$RED" "- hooncç¼–è¯‘å™¨: æœªæ‰¾åˆ°"
    fi
    
    if check_command "cc"; then
        print_message "$GREEN" "- ccé“¾æ¥å™¨: $(which cc)"
    else
        print_message "$RED" "- ccé“¾æ¥å™¨: æœªæ‰¾åˆ°"
    fi
    
    # æŒ–çŸ¿çŠ¶æ€
    if screen -list | grep -q "nockchain"; then
        print_message "$GREEN" "æŒ–çŸ¿çŠ¶æ€: âœ… æ­£åœ¨è¿è¡Œï¼ˆBootstrapä¿æŠ¤å·²å¯ç”¨ï¼‰"
    else
        print_message "$RED" "æŒ–çŸ¿çŠ¶æ€: âŒ æœªè¿è¡Œ"
    fi
    
    # å…¬é’¥æ ¼å¼æ£€æŸ¥
    if [ -f "$NOCKCHAIN_DIR/.env" ]; then
        local pubkey=$(grep "MINING_PUBKEY" "$NOCKCHAIN_DIR/.env" | cut -d'=' -f2)
        if validate_128bit_hex_pubkey "$pubkey"; then
            print_message "$GREEN" "- å…¬é’¥æ ¼å¼: âœ… 128ä½16è¿›åˆ¶æ­£ç¡®"
        else
            print_message "$RED" "- å…¬é’¥æ ¼å¼: âŒ éœ€è¦128ä½16è¿›åˆ¶"
        fi
    fi
}

# å¤‡ä»½é’±åŒ…
backup_wallet() {
    print_message "$GREEN" ">>> å¤‡ä»½é’±åŒ…å¯†é’¥"
    
    local backup_file="$BACKUP_DIR/complete_backup_$(date +%Y%m%d_%H%M%S).tar.gz"
    mkdir -p "$BACKUP_DIR"
    
    cd "$NOCKCHAIN_DIR" 2>/dev/null || return 1
    
    # å¤‡ä»½é‡è¦æ–‡ä»¶
    tar -czf "$backup_file" .env logs/ *.txt "$LOG_FILE" crates/hoonc/bootstrap/hoonc.jam 2>/dev/null || true
    
    if [ -f ".env" ]; then
        cp .env "$BACKUP_DIR/env_$(date +%Y%m%d_%H%M%S).backup"
    fi
    
    if [ -f "$LOG_FILE" ]; then
        cp "$LOG_FILE" "$BACKUP_DIR/bootstrap_fix_log_$(date +%Y%m%d_%H%M%S).log"
    fi
    
    # å¤‡ä»½Bootstrapæ–‡ä»¶
    if [ -f "crates/hoonc/bootstrap/hoonc.jam" ]; then
        cp "crates/hoonc/bootstrap/hoonc.jam" "$BACKUP_DIR/hoonc_$(date +%Y%m%d_%H%M%S).jam"
        print_message "$GREEN" "Bootstrap JAMæ–‡ä»¶å·²å¤‡ä»½"
    fi
    
    print_message "$GREEN" "å¤‡ä»½å®Œæˆ: $backup_file"
}

# ä¸»å¾ªç¯
main() {
    if [ "$EUID" -eq 0 ]; then
        print_message "$RED" "è¯·ä¸è¦ä»¥rootç”¨æˆ·è¿è¡Œ"
        exit 1
    fi
    
    # æ£€æŸ¥bcå‘½ä»¤
    if ! check_command "bc"; then
        print_message "$YELLOW" "å®‰è£…bcè®¡ç®—å™¨..."
        case $(detect_distro) in
            "ubuntu"|"debian"|"mint"|"pop")
                sudo apt install -y bc 2>/dev/null || true
                ;;
            "centos"|"rhel"|"rocky"|"almalinux"|"fedora")
                sudo yum install -y bc 2>/dev/null || sudo dnf install -y bc 2>/dev/null || true
                ;;
        esac
    fi
    
    mkdir -p "$BACKUP_DIR"
    touch "$LOG_FILE"
    print_message "$CYAN" "Bootstrapæ–‡ä»¶ç¼ºå¤±ä¿®å¤è„šæœ¬å¯åŠ¨ v11.0"
    
    while true; do
        show_menu
        read -p "è¯·è¾“å…¥é€‰é¡¹ç¼–å·ï¼ˆ1-10ï¼‰: " choice
        
        case $choice in
            1) install_nockchain_bootstrap_fix ;;
            2) configure_128bit_mining_key ;;
            3) start_bootstrap_protected_mining ;;
            4) view_logs ;;
            5) check_balance ;;
            6) system_monitor ;;
            7) backup_wallet ;;
            8) diagnose_bootstrap_issues ;;
            9) bootstrap_generation_tools ;;
            10)
                print_message "$GREEN" "æ„Ÿè°¢ä½¿ç”¨Nockchain Bootstrapæ–‡ä»¶ç¼ºå¤±å®Œå…¨è§£å†³æ–¹æ¡ˆï¼"
                exit 0
                ;;
            *)
                print_message "$RED" "æ— æ•ˆé€‰é¡¹"
                ;;
        esac
        
        echo
        read -p "æŒ‰å›è½¦é”®ç»§ç»­..." -r
    done
}

# å¯åŠ¨ç¨‹åº
main
