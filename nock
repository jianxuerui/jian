#!/bin/bash
# -*- coding: UTF-8 -*-

# 定义颜色代码
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
RESET='\033[0m'

# 主菜单函数
show_menu() {
  clear
  echo -e "${BLUE}
=======================================
 Nockchain 中文优化挖矿脚本 v2.1.5
=======================================
${RESET}"
  echo -e "${YELLOW}1. 安装Nockchain节点"
  echo "2. 配置挖矿公钥"
  echo "3. 启动优化挖矿"
  echo "4. 查看实时日志"
  echo "5. 检查钱包余额"
  echo "6. 系统状态监控"
  echo "7. 退出脚本"
  echo -e "${BLUE}=======================================${RESET}"
}

# 公钥验证函数
validate_pubkey() {
  local pubkey=$1
  if [[ $pubkey =~ ^[0-9a-fA-F]{128}$ ]]; then
    return 0
  else
    echo -e "${RED}错误：公钥格式应为128位十六进制字符${RESET}"
    return 1
  fi
}

# 安装模块
install_node() {
  echo -e "${GREEN}>>> 开始安装Nockchain节点...${RESET}"
  
  # 检查系统架构
  ARCH=$(uname -m)
  case $ARCH in
    x86_64) BIN_URL="https://nockchain.org/builds/linux-amd64/v0.4.2/nockchain-node" ;;
    arm64)  BIN_URL="https://nockchain.org/builds/linux-arm64/v0.4.2/nockchain-node" ;;
    *)      echo -e "${RED}不支持的架构: $ARCH${RESET}"; return 1 ;;
  esac

  # 下载节点程序
  if ! wget -q --show-progress $BIN_URL -O /tmp/nockchain-node; then
    echo -e "${RED}节点程序下载失败${RESET}"
    return 1
  fi

  # 安装到用户目录
  mkdir -p $HOME/nockchain/bin
  mv /tmp/nockchain-node $HOME/nockchain/bin/
  chmod +x $HOME/nockchain/bin/nockchain-node

  # 生成初始配置
  cat > $HOME/nockchain/.env <<EOF
MINING_PUBKEY=0000000000000000000000000000000000000000000000000000000000000000
NETWORK=mainnet
MAX_PEERS=4000
LOG_LEVEL=info
EOF

  echo -e "${GREEN}安装完成！节点程序位于 $HOME/nockchain${RESET}"
}

# 主循环
while true; do
  show_menu
  read -p "请输入选项编号：" choice
  case $choice in
    1) install_node ;;
    2)
      read -p "请输入新的挖矿公钥：" pubkey
      if validate_pubkey "$pubkey"; then
        sed -i "s/MINING_PUBKEY=.*/MINING_PUBKEY=$pubkey/" $HOME/nockchain/.env
        echo -e "${GREEN}公钥更新成功！${RESET}"
      fi
      ;;
    3)
      echo -e "${GREEN}>>> 启动优化挖矿节点...${RESET}"
      export RUST_MIN_STACK=8388608
      screen -dmS nockchain $HOME/nockchain/bin/nockchain-node \
        --config $HOME/nockchain/.env \
        --peers "${PEER_NODES[@]}"
      echo -e "节点已在后台运行，使用 ${YELLOW}screen -r nockchain${RESET} 查看"
      ;;
    4)
      echo -e "${GREEN}>>> 显示实时日志：${RESET}"
      tail -f $HOME/nockchain/logs/nockchain.log
      ;;
    5)
      BALANCE=$($HOME/nockchain/bin/nockchain-node wallet balance)
      echo -e "当前余额: ${GREEN}$BALANCE NOCK${RESET}"
      ;;
    6)
      echo -e "${BLUE}====== 系统状态 ======${RESET}"
      echo -e "CPU使用率: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}')%"
      echo -e "内存使用: $(free -m | awk '/Mem/{print $3}')MB / $(free -m | awk '/Mem/{print $2}')MB"
      echo -e "存储空间: $(df -h $HOME | awk 'NR==2{print $4}') 可用"
      ;;
    7) exit 0 ;;
    *) echo -e "${RED}无效选项，请重新选择${RESET}" ;;
  esac
  read -p "按回车键继续..."
done
