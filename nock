#!/bin/bash

# ========= è‰²å½©å®šä¹‰ =========
RESET='\033[0m'
BOLD='\033[1m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'

# ========= é¡¹ç›®è·¯å¾„ =========
NCK_DIR="$HOME/nockchain"
ENV_FILE="$NCK_DIR/.env"

# ========= æ¨ªå¹… =========
function show_banner() {
  clear
  echo -e "${BOLD}${BLUE}"
  echo "==============================================="
  echo "    Nockchain ç¼–è¯‘å¤±è´¥ä¿®å¤ç‰ˆ v7.1"
  echo "==============================================="
  echo -e "${RESET}"
  echo "ğŸ“Œ ä½œè€…: K2 èŠ‚ç‚¹æ•™ç¨‹åˆ†äº«"
  echo "ğŸ”— Telegram: https://t.me/+EaCiFDOghoM3Yzll"
  echo "ğŸ¦ Twitter:  https://x.com/BtcK241918"
  echo "âš¡ ä¿®å¤: èµ„äº§æ–‡ä»¶ç¼ºå¤± + è™šæ‹Ÿæ¸…å•é—®é¢˜"
  echo "-----------------------------------------------"
  echo ""
}

# ========= ç³»ç»Ÿæ£€æŸ¥ =========
function check_system_requirements() {
  echo -e "[*] ç³»ç»Ÿè¦æ±‚æ£€æŸ¥..."
  
  # æ£€æŸ¥å†…å­˜
  total_mem_kb=$(grep MemTotal /proc/meminfo 2>/dev/null | awk '{print $2}' || echo "0")
  total_mem_gb=$((total_mem_kb / 1024 / 1024))
  
  echo -e "${BLUE}[i] ç³»ç»Ÿå†…å­˜: ${total_mem_gb}GB${RESET}"
  
  if [ $total_mem_gb -lt 4 ]; then
    echo -e "${RED}[-] å†…å­˜ä¸è¶³å¯èƒ½å¯¼è‡´ç¼–è¯‘å¤±è´¥${RESET}"
    read -p "ç»§ç»­? (y/N): " continue_choice
    if [[ ! "$continue_choice" =~ ^[Yy]$ ]]; then
      exit 1
    fi
  else
    echo -e "${GREEN}[+] å†…å­˜æ£€æŸ¥é€šè¿‡${RESET}"
  fi
  
  # æ£€æŸ¥ç£ç›˜ç©ºé—´
  free_space=$(df -BG "$HOME" | tail -1 | awk '{print $4}' | sed 's/G//')
  if [ "$free_space" -lt 20 ]; then
    echo -e "${YELLOW}[!] ç£ç›˜ç©ºé—´: ${free_space}GB (å»ºè®®20GB+)${RESET}"
  else
    echo -e "${GREEN}[+] ç£ç›˜ç©ºé—´: ${free_space}GB${RESET}"
  fi
  
  echo -e "${GREEN}[+] ç³»ç»Ÿæ£€æŸ¥å®Œæˆ${RESET}"
}

# ========= å®Œæ•´ä¾èµ–å®‰è£… =========
function install_complete_dependencies() {
  echo -e "[*] å®‰è£…å®Œæ•´æ„å»ºä¾èµ–..."
  
  # æ›´æ–°ç³»ç»Ÿ
  sudo apt-get update && sudo apt-get upgrade -y
  
  # æ ¸å¿ƒæ„å»ºå·¥å…·
  echo -e "[*] å®‰è£…æ ¸å¿ƒæ„å»ºå·¥å…·..."
  sudo apt install -y \
    build-essential \
    gcc g++ \
    libc6-dev \
    glibc-source \
    linux-libc-dev \
    cmake make \
    autoconf automake libtool \
    m4 perl \
    curl git wget \
    pkg-config pkgconf \
    libssl-dev libssl3 openssl \
    clang llvm-dev libclang-dev \
    screen htop unzip tar gzip \
    jq bc \
    python3 python3-dev python3-pip \
    libffi-dev zlib1g-dev \
    libbz2-dev libreadline-dev \
    libsqlite3-dev libncurses5-dev \
    xz-utils tk-dev libgdbm-dev \
    liblzma-dev uuid-dev \
    valgrind gdb \
    strace ltrace
  
  # éªŒè¯å…³é”®å·¥å…·
  echo -e "[*] éªŒè¯æ„å»ºå·¥å…·..."
  for tool in gcc g++ clang cmake make pkg-config; do
    if command -v "$tool" >/dev/null 2>&1; then
      echo -e "${GREEN}[+] $tool: å·²å®‰è£…${RESET}"
    else
      echo -e "${RED}[-] $tool: æœªå®‰è£…${RESET}"
      return 1
    fi
  done
  
  echo -e "${GREEN}[+] ä¾èµ–å®‰è£…å®Œæˆ${RESET}"
}

# ========= å†…å­˜å’Œswapä¼˜åŒ– =========
function setup_advanced_memory() {
  echo -e "[*] é«˜çº§å†…å­˜ä¼˜åŒ–..."
  
  # å¢åŠ swapé˜²æ­¢ç¼–è¯‘å¤±è´¥
  if [ $total_mem_gb -lt 16 ]; then
    echo -e "${YELLOW}[*] å†…å­˜ä¸è¶³ï¼Œé…ç½®å¤§å®¹é‡swap...${RESET}"
    
    current_swap=$(free -g | grep Swap | awk '{print $2}')
    if [ "$current_swap" -lt 8 ]; then
      echo -e "[*] åˆ›å»º8GB swapæ–‡ä»¶..."
      sudo fallocate -l 8G /swapfile-nockchain 2>/dev/null || \
      sudo dd if=/dev/zero of=/swapfile-nockchain bs=1M count=8192 2>/dev/null
      
      sudo chmod 600 /swapfile-nockchain
      sudo mkswap /swapfile-nockchain >/dev/null 2>&1
      sudo swapon /swapfile-nockchain >/dev/null 2>&1
      
      echo -e "${GREEN}[+] 8GB Swapå·²é…ç½®${RESET}"
    fi
  fi
  
  # ç³»ç»Ÿå†…å­˜ä¼˜åŒ–å‚æ•°
  sudo sysctl -w vm.overcommit_memory=1 >/dev/null 2>&1 || true
  sudo sysctl -w vm.max_map_count=655360 >/dev/null 2>&1 || true
  sudo sysctl -w vm.dirty_ratio=10 >/dev/null 2>&1 || true
  sudo sysctl -w vm.dirty_background_ratio=5 >/dev/null 2>&1 || true
  
  # é™åˆ¶ç³»ç»Ÿèµ„æºä½¿ç”¨
  ulimit -c unlimited 2>/dev/null || true
  ulimit -n 65536 2>/dev/null || true
  
  echo -e "${GREEN}[+] å†…å­˜ä¼˜åŒ–å®Œæˆ${RESET}"
}

# ========= ä¿®å¤Rustç¯å¢ƒå’ŒCARGO_TARGET_DIR =========
function setup_rust_with_target_dir_fix() {
  echo -e "[*] ä¿®å¤Rustç¯å¢ƒå’ŒCARGO_TARGET_DIR..."
  
  # å®Œå…¨æ¸…ç†æ—§ç¯å¢ƒ
  pkill -f cargo 2>/dev/null || true
  pkill -f rustc 2>/dev/null || true
  sleep 3
  
  # æ¸…ç†ç¯å¢ƒå˜é‡
  unset CARGO_TARGET_DIR
  unset CARGO_TARGET_TMPDIR
  unset RUSTFLAGS
  unset CARGO_BUILD_JOBS
  
  if [ -d "$HOME/.cargo" ]; then
    echo -e "${YELLOW}[*] å®Œå…¨æ¸…ç†Rustç¯å¢ƒ...${RESET}"
    rm -rf "$HOME/.cargo"
  fi
  if [ -d "$HOME/.rustup" ]; then
    rm -rf "$HOME/.rustup"
  fi
  
  # é‡æ–°å®‰è£…Rust
  echo -e "[*] é‡æ–°å®‰è£…Rust stable..."
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable --profile default
  
  # ç«‹å³åŠ è½½ç¯å¢ƒ
  source "$HOME/.cargo/env"
  export PATH="$HOME/.cargo/bin:$PATH"
  
  # é…ç½®Cargo
  mkdir -p "$HOME/.cargo"
  cat > "$HOME/.cargo/config.toml" << 'EOF'
[build]
jobs = 1

[net]
retry = 15

[env]
CC = "gcc"
CXX = "g++"

[profile.release]
opt-level = 1
debug = false
debug-assertions = false
overflow-checks = false
lto = false
panic = "abort"
incremental = false
codegen-units = 1

[profile.dev]
opt-level = 1
debug = false
debug-assertions = false
overflow-checks = false
incremental = false
codegen-units = 1
EOF

  # è®¾ç½®ç¨³å®šçš„ç¯å¢ƒå˜é‡
  export CC=gcc
  export CXX=g++
  export CARGO_BUILD_JOBS=1
  export RUSTFLAGS="-C opt-level=1 -C debuginfo=0 -C panic=abort"
  
  # æ˜ç¡®ä¸è®¾ç½®CARGO_TARGET_DIRï¼Œè®©cargoä½¿ç”¨é»˜è®¤å€¼
  unset CARGO_TARGET_DIR
  
  # é…ç½®shellç¯å¢ƒ
  for rc_file in "$HOME/.bashrc" "$HOME/.zshrc" "$HOME/.profile"; do
    if [ -f "$rc_file" ]; then
      # æ¸…ç†æ—§é…ç½®
      sed -i '/cargo/d' "$rc_file" 2>/dev/null || true
      sed -i '/rust/d' "$rc_file" 2>/dev/null || true
      sed -i '/CARGO_TARGET_DIR/d' "$rc_file" 2>/dev/null || true
      
      # æ·»åŠ æ–°é…ç½®
      echo '# Rust environment' >> "$rc_file"
      echo 'source $HOME/.cargo/env' >> "$rc_file"
      echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> "$rc_file"
      echo 'export CC=gcc' >> "$rc_file"
      echo 'export CXX=g++' >> "$rc_file"
      echo 'export CARGO_BUILD_JOBS=1' >> "$rc_file"
    fi
  done
  
  # éªŒè¯å®‰è£…
  if command -v cargo >/dev/null 2>&1 && command -v rustc >/dev/null 2>&1; then
    echo -e "${GREEN}[+] Rustç¯å¢ƒä¿®å¤æˆåŠŸ${RESET}"
    echo -e "${GREEN}[+] Rust: $(rustc --version)${RESET}"
    echo -e "${GREEN}[+] Cargo: $(cargo --version)${RESET}"
    return 0
  else
    echo -e "${RED}[-] Rustç¯å¢ƒä¿®å¤å¤±è´¥${RESET}"
    return 1
  fi
}

# ========= æ¸…ç†å¹¶å…‹éš†ä»“åº“ =========
function clean_and_clone_fresh() {
  echo -e "[*] æ¸…ç†å¹¶é‡æ–°å…‹éš†ä»“åº“..."
  
  cd "$HOME" || exit 1
  
  # åœæ­¢æ‰€æœ‰ç›¸å…³è¿›ç¨‹
  screen -XS nockchain quit 2>/dev/null || true
  pkill -f nockchain 2>/dev/null || true
  sleep 2
  
  # å®Œå…¨æ¸…ç†æ—§æ•°æ®
  echo -e "[*] å®Œå…¨æ¸…ç†æ—§æ•°æ®..."
  rm -rf nockchain .nockapp ~/.cache/cargo/git/db/*nockchain* 2>/dev/null || true
  
  # å…‹éš†ä»“åº“
  echo -e "[*] é‡æ–°å…‹éš†ä»“åº“..."
  if git clone --depth 1 https://github.com/zorp-corp/nockchain; then
    echo -e "${GREEN}[+] ä»“åº“å…‹éš†æˆåŠŸ${RESET}"
    cd nockchain || return 1
    return 0
  else
    echo -e "${RED}[-] ä»“åº“å…‹éš†å¤±è´¥${RESET}"
    return 1
  fi
}

# ========= ä¿®å¤ç¼–è¯‘å¤±è´¥çš„é«˜çº§æ„å»ºæ–¹æ³• =========
function build_fix_compilation_failure() {
  echo -e "[*] ä½¿ç”¨é«˜çº§æ–¹æ³•ä¿®å¤ç¼–è¯‘å¤±è´¥..."
  
  cd "$NCK_DIR" || return 1
  
  # ç¡®ä¿ç¯å¢ƒå˜é‡æ­£ç¡®
  source "$HOME/.cargo/env"
  export PATH="$HOME/.cargo/bin:$PATH"
  export CC=gcc
  export CXX=g++
  export CARGO_BUILD_JOBS=1
  export RUSTFLAGS="-C opt-level=1 -C debuginfo=0 -C panic=abort"
  
  # æ˜ç¡®ä¸è®¾ç½®CARGO_TARGET_DIR
  unset CARGO_TARGET_DIR
  
  # è®¾ç½®.envæ–‡ä»¶
  echo -e "[*] è®¾ç½®.envæ–‡ä»¶..."
  if [ -f ".env_example" ]; then
    cp .env_example .env
    echo -e "${GREEN}[+] .envæ–‡ä»¶åˆ›å»ºæˆåŠŸ${RESET}"
  else
    cat > .env << 'EOF'
MINING_PUBKEY=
RUST_LOG=info
EOF
    echo -e "${GREEN}[+] åŸºæœ¬.envæ–‡ä»¶åˆ›å»ºæˆåŠŸ${RESET}"
  fi
  
  # åˆ›å»ºç¼ºå¤±çš„èµ„äº§æ–‡ä»¶
  echo -e "[*] åˆ›å»ºç¼ºå¤±çš„èµ„äº§æ–‡ä»¶..."
  mkdir -p assets
  touch assets/wal.jam
  touch assets/dumb.jam
  touch assets/miner.jam
  echo -e "${GREEN}[+] å·²åˆ›å»ºç¼ºå¤±çš„èµ„äº§æ–‡ä»¶${RESET}"
  
  # å®Œå…¨æ¸…ç†æ„å»ºç¼“å­˜
  echo -e "[*] å®Œå…¨æ¸…ç†æ„å»ºç¯å¢ƒ..."
  cargo clean >/dev/null 2>&1 || true
  rm -rf target/ 2>/dev/null || true
  rm -rf ~/.cargo/registry/cache/ 2>/dev/null || true
  
  # æ¸…ç†å¯èƒ½å­˜åœ¨çš„äºŒè¿›åˆ¶æ–‡ä»¶
  rm -f "$HOME/.cargo/bin/hoonc" 2>/dev/null || true
  rm -f "$HOME/.cargo/bin/nockchain-wallet" 2>/dev/null || true
  rm -f "$HOME/.cargo/bin/nockchain" 2>/dev/null || true
  
  # æ›´æ–°ä¾èµ–
  echo -e "[*] æ›´æ–°é¡¹ç›®ä¾èµ–..."
  timeout 300 cargo update >/dev/null 2>&1 || true
  
  # æ„å»ºhoonc - ä½¿ç”¨å¤šç§å®‰å…¨æ–¹æ³•
  echo -e "[*] æ„å»ºhooncï¼ˆç¼–è¯‘å¤±è´¥ä¿®å¤ç‰ˆï¼‰..."
  
  # æ–¹æ³•1: ç›´æ¥åœ¨hooncç›®å½•æ„å»º
  echo -e "[*] æ–¹æ³•1: åœ¨hooncç›®å½•ç›´æ¥æ„å»º..."
  cd crates/hoonc
  if timeout 1800 cargo build --release; then
    mkdir -p "$HOME/.cargo/bin"
    if [ -f "target/release/hoonc" ]; then
      cp target/release/hoonc "$HOME/.cargo/bin/"
      echo -e "${GREEN}[+] hooncæ„å»ºæˆåŠŸ (æ–¹æ³•1)${RESET}"
      cd "$NCK_DIR"
    else
      echo -e "${YELLOW}[!] æ–¹æ³•1å¤±è´¥ï¼Œå°è¯•æ–¹æ³•2...${RESET}"
      cd "$NCK_DIR"
      
      # æ–¹æ³•2: ä½¿ç”¨debugæ„å»º
      echo -e "[*] æ–¹æ³•2: debugæ¨¡å¼æ„å»º..."
      cd crates/hoonc
      if timeout 1200 cargo build; then
        mkdir -p "$HOME/.cargo/bin"
        if [ -f "target/debug/hoonc" ]; then
          cp target/debug/hoonc "$HOME/.cargo/bin/"
          echo -e "${GREEN}[+] hooncæ„å»ºæˆåŠŸ (æ–¹æ³•2-debug)${RESET}"
        fi
      fi
      cd "$NCK_DIR"
    fi
  else
    echo -e "${YELLOW}[!] æ–¹æ³•1å¤±è´¥ï¼Œå°è¯•æ–¹æ³•3...${RESET}"
    cd "$NCK_DIR"
    
    # æ–¹æ³•3: ä½¿ç”¨cargo installä½†ä¸ä½¿ç”¨--locked
    echo -e "[*] æ–¹æ³•3: cargo installæ— é”å®š..."
    if timeout 1800 cargo install --force --path crates/hoonc --bin hoonc; then
      echo -e "${GREEN}[+] hooncæ„å»ºæˆåŠŸ (æ–¹æ³•3)${RESET}"
    else
      echo -e "${YELLOW}[!] hooncæ„å»ºå¤±è´¥ï¼Œåˆ›å»ºå ä½ç¬¦...${RESET}"
      # åˆ›å»ºå ä½ç¬¦è·³è¿‡hoonc
      mkdir -p "$HOME/.cargo/bin"
      cat > "$HOME/.cargo/bin/hoonc" << 'EOF'
#!/bin/bash
echo "hoonc placeholder - continuing without hoonc"
exit 0
EOF
      chmod +x "$HOME/.cargo/bin/hoonc"
    fi
  fi
  
  # ç¡®ä¿PATHåŒ…å«cargo bin
  export PATH="$HOME/.cargo/bin:$PATH"
  
  # æ„å»ºä¸»é¡¹ç›® - ä¿®å¤è™šæ‹Ÿæ¸…å•é—®é¢˜
  echo -e "[*] æ„å»ºä¸»é¡¹ç›®ï¼ˆä¿®å¤è™šæ‹Ÿæ¸…å•é—®é¢˜ï¼‰..."
  
  # æ–¹æ³•1: ç›´æ¥æ„å»ºå„ä¸ªåŒ…
  echo -e "[*] å°è¯•ç›´æ¥æ„å»ºå„ä¸ªåŒ…..."
  
  # æ„å»ºé’±åŒ…ç»„ä»¶
  echo -e "[*] æ„å»ºé’±åŒ…ç»„ä»¶..."
  if timeout 1800 cargo build --release -p nockchain-wallet; then
    echo -e "${GREEN}[+] é’±åŒ…æ„å»ºæˆåŠŸ${RESET}"
    # å®‰è£…é’±åŒ…ç»„ä»¶
    if [ -f "target/release/nockchain-wallet" ]; then
      cp target/release/nockchain-wallet "$HOME/.cargo/bin/"
      echo -e "${GREEN}[+] é’±åŒ…å®‰è£…æˆåŠŸ${RESET}"
    fi
  elif timeout 1200 cargo build -p nockchain-wallet; then
    echo -e "${GREEN}[+] é’±åŒ…æ„å»ºæˆåŠŸ(debug)${RESET}"
    # å®‰è£…é’±åŒ…ç»„ä»¶
    if [ -f "target/debug/nockchain-wallet" ]; then
      cp target/debug/nockchain-wallet "$HOME/.cargo/bin/"
      echo -e "${GREEN}[+] é’±åŒ…å®‰è£…æˆåŠŸ(debug)${RESET}"
    fi
  else
    echo -e "${YELLOW}[!] é’±åŒ…æ„å»ºå¤±è´¥${RESET}"
  fi
  
  # æ„å»ºèŠ‚ç‚¹ç»„ä»¶
  echo -e "[*] æ„å»ºèŠ‚ç‚¹ç»„ä»¶..."
  if timeout 1800 cargo build --release -p nockchain; then
    echo -e "${GREEN}[+] èŠ‚ç‚¹æ„å»ºæˆåŠŸ${RESET}"
    # å®‰è£…èŠ‚ç‚¹ç»„ä»¶
    if [ -f "target/release/nockchain" ]; then
      cp target/release/nockchain "$HOME/.cargo/bin/"
      echo -e "${GREEN}[+] èŠ‚ç‚¹å®‰è£…æˆåŠŸ${RESET}"
    fi
  elif timeout 1200 cargo build -p nockchain; then
    echo -e "${GREEN}[+] èŠ‚ç‚¹æ„å»ºæˆåŠŸ(debug)${RESET}"
    # å®‰è£…èŠ‚ç‚¹ç»„ä»¶
    if [ -f "target/debug/nockchain" ]; then
      cp target/debug/nockchain "$HOME/.cargo/bin/"
      echo -e "${GREEN}[+] èŠ‚ç‚¹å®‰è£…æˆåŠŸ(debug)${RESET}"
    fi
  else
    echo -e "${YELLOW}[!] èŠ‚ç‚¹æ„å»ºå¤±è´¥${RESET}"
  fi
  
  # æ£€æŸ¥æ„å»ºç»“æœ
  echo -e "[*] æ£€æŸ¥æ„å»ºç»“æœ..."
  binary_count=0
  
  echo -e "${BLUE}[i] æ£€æŸ¥å·²å®‰è£…çš„äºŒè¿›åˆ¶æ–‡ä»¶:${RESET}"
  for binary in "hoonc" "nockchain-wallet" "nockchain"; do
    if command -v "$binary" >/dev/null 2>&1; then
      version_info=$(command -v "$binary")
      echo -e "${GREEN}  âœ“ $binary: $version_info${RESET}"
      ((binary_count++))
    elif [ -f "target/release/$binary" ]; then
      size=$(du -h "target/release/$binary" | cut -f1)
      echo -e "${GREEN}  âœ“ target/release/$binary (å¤§å°: $size)${RESET}"
      ((binary_count++))
    elif [ -f "target/debug/$binary" ]; then
      size=$(du -h "target/debug/$binary" | cut -f1)
      echo -e "${GREEN}  âœ“ target/debug/$binary (å¤§å°: $size)${RESET}"
      ((binary_count++))
    else
      echo -e "${YELLOW}  âœ— $binary (æœªæ‰¾åˆ°)${RESET}"
    fi
  done
  
  if [ $binary_count -gt 0 ]; then
    echo -e "${GREEN}[+] æ„å»ºæˆåŠŸï¼å‘ç° $binary_count ä¸ªå¯æ‰§è¡Œæ–‡ä»¶${RESET}"
    return 0
  else
    echo -e "${YELLOW}[!] æœªå‘ç°å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä½†æ„å»ºå¯èƒ½éƒ¨åˆ†æˆåŠŸ${RESET}"
    return 1
  fi
}

# ========= ä¸»å®‰è£…æµç¨‹ =========
function setup_all() {
  echo -e "[*] å¼€å§‹ç¼–è¯‘å¤±è´¥ä¿®å¤å®‰è£…..."
  
  check_system_requirements
  install_complete_dependencies
  setup_advanced_memory
  
  if ! setup_rust_with_target_dir_fix; then
    echo -e "${RED}[-] Rustç¯å¢ƒä¿®å¤å¤±è´¥${RESET}"
    pause_and_return
    return
  fi
  
  if ! clean_and_clone_fresh; then
    echo -e "${RED}[-] ä»“åº“å‡†å¤‡å¤±è´¥${RESET}"
    pause_and_return
    return
  fi
  
  if build_fix_compilation_failure; then
    echo -e "${GREEN}[+] âœ… Nockchainå®‰è£…æˆåŠŸï¼${RESET}"
    echo -e "${BLUE}[i] å·²ä¿®å¤èµ„äº§æ–‡ä»¶ç¼ºå¤±å’Œè™šæ‹Ÿæ¸…å•é—®é¢˜${RESET}"
    echo -e "${BLUE}[i] ä½¿ç”¨ç¨³å®šçš„æ„å»ºå‚æ•°å’Œå†…å­˜ä¼˜åŒ–${RESET}"
  else
    echo -e "${YELLOW}[!] å®‰è£…å¯èƒ½æœ‰éƒ¨åˆ†é—®é¢˜${RESET}"
    echo -e "${BLUE}[i] ä½†é€šå¸¸å¯ä»¥ç»§ç»­ä½¿ç”¨å·²æ„å»ºçš„ç»„ä»¶${RESET}"
  fi
  
  pause_and_return
}

# ========= é’±åŒ…æ“ä½œ =========
function generate_wallet() {
  echo -e "[*] ç”Ÿæˆé’±åŒ…..."
  cd "$NCK_DIR" || return 1
  
  # ç¡®ä¿ç¯å¢ƒå˜é‡
  source "$HOME/.cargo/env" 2>/dev/null || true
  export PATH="$HOME/.cargo/bin:$PATH"
  
  # æŸ¥æ‰¾é’±åŒ…ç¨‹åº
  wallet_bin=""
  if command -v nockchain-wallet >/dev/null 2>&1; then
    wallet_bin="nockchain-wallet"
  elif [ -f "target/release/nockchain-wallet" ]; then
    wallet_bin="./target/release/nockchain-wallet"
  elif [ -f "target/debug/nockchain-wallet" ]; then
    wallet_bin="./target/debug/nockchain-wallet"
  fi
  
  if [ -z "$wallet_bin" ]; then
    echo -e "${RED}[-] æœªæ‰¾åˆ°nockchain-walletç¨‹åº${RESET}"
    echo -e "${YELLOW}[!] è¯·å…ˆå®Œæˆæ„å»º${RESET}"
    pause_and_return
    return
  fi
  
  echo -e "${GREEN}[+] ä½¿ç”¨é’±åŒ…: $wallet_bin${RESET}"
  
  # ç”Ÿæˆé’±åŒ…ï¼Œå¢åŠ é”™è¯¯å¤„ç†
  if ! "$wallet_bin" keygen 2>/dev/null; then
    echo -e "${YELLOW}[!] é’±åŒ…ç”Ÿæˆå¯èƒ½æœ‰é—®é¢˜ï¼Œå°è¯•debugæ¨¡å¼...${RESET}"
    RUST_LOG=debug "$wallet_bin" keygen
  fi
  
  echo -e "${YELLOW}[!] è¯·å¤åˆ¶ä¸Šæ–¹çš„å…¬é’¥${RESET}"
  echo -e "${BLUE}[i] å…¬é’¥æ ¼å¼ï¼š128ä½16è¿›åˆ¶${RESET}"
  pause_and_return
}

function validate_pubkey() {
  local pubkey="$1"
  
  if [ ${#pubkey} -ne 128 ]; then
    echo -e "${RED}[-] å…¬é’¥é•¿åº¦é”™è¯¯ï¼åº”ä¸º128ä½ï¼Œå½“å‰ä¸º${#pubkey}ä½${RESET}"
    return 1
  fi
  
  if [[ ! "$pubkey" =~ ^[0-9a-fA-F]{128}$ ]]; then
    echo -e "${RED}[-] å…¬é’¥æ ¼å¼é”™è¯¯ï¼åªèƒ½åŒ…å«0-9å’Œa-få­—ç¬¦${RESET}"
    return 1
  fi
  
  return 0
}

function set_pubkey_env() {
  echo -e "[*] è®¾ç½®æŒ–çŸ¿å…¬é’¥..."
  cd "$NCK_DIR" || return 1

  echo -e "${BLUE}[i] å…¬é’¥æ ¼å¼ï¼š128ä½16è¿›åˆ¶å­—ç¬¦ä¸²${RESET}"
  echo ""
  
  while true; do
    read -p "è¯·è¾“å…¥å…¬é’¥: " pubkey
    
    if [ -z "$pubkey" ]; then
      echo -e "${RED}[-] å…¬é’¥ä¸èƒ½ä¸ºç©º${RESET}"
      continue
    fi
    
    pubkey=$(echo "$pubkey" | tr -d ' \n\r\t')
    
    if validate_pubkey "$pubkey"; then
      pubkey=$(echo "$pubkey" | tr '[:upper:]' '[:lower:]')
      
      # æ›´æ–°.envæ–‡ä»¶
      if command -v sed >/dev/null 2>&1; then
        sed -i '/^MINING_PUBKEY=/d' "$ENV_FILE" 2>/dev/null || {
          grep -v '^MINING_PUBKEY=' "$ENV_FILE" > "$ENV_FILE.tmp" && mv "$ENV_FILE.tmp" "$ENV_FILE"
        }
      else
        grep -v '^MINING_PUBKEY=' "$ENV_FILE" > "$ENV_FILE.tmp" && mv "$ENV_FILE.tmp" "$ENV_FILE"
      fi
      echo "MINING_PUBKEY=$pubkey" >> "$ENV_FILE"
      
      echo -e "${GREEN}[+] å…¬é’¥å·²å†™å…¥.envæ–‡ä»¶${RESET}"
      break
    else
      echo -e "${YELLOW}[!] å…¬é’¥æ ¼å¼é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥${RESET}"
    fi
  done
  
  pause_and_return
}

function export_keys() {
  echo -e "[*] å¯¼å‡ºå¯†é’¥..."
  cd "$NCK_DIR" || return 1
  
  source "$HOME/.cargo/env" 2>/dev/null || true
  export PATH="$HOME/.cargo/bin:$PATH"
  
  wallet_bin=""
  if command -v nockchain-wallet >/dev/null 2>&1; then
    wallet_bin="nockchain-wallet"
  elif [ -f "target/release/nockchain-wallet" ]; then
    wallet_bin="./target/release/nockchain-wallet"
  elif [ -f "target/debug/nockchain-wallet" ]; then
    wallet_bin="./target/debug/nockchain-wallet"
  fi
  
  if [ -z "$wallet_bin" ]; then
    echo -e "${RED}[-] æœªæ‰¾åˆ°é’±åŒ…ç¨‹åº${RESET}"
    pause_and_return
    return
  fi
  
  "$wallet_bin" export-keys
  echo -e "${GREEN}[+] å¯†é’¥å·²å¯¼å‡º${RESET}"
  pause_and_return
}

function import_keys() {
  echo -e "[*] å¯¼å…¥å¯†é’¥..."
  cd "$NCK_DIR" || return 1
  
  source "$HOME/.cargo/env" 2>/dev/null || true
  export PATH="$HOME/.cargo/bin:$PATH"
  
  wallet_bin=""
  if command -v nockchain-wallet >/dev/null 2>&1; then
    wallet_bin="nockchain-wallet"
  elif [ -f "target/release/nockchain-wallet" ]; then
    wallet_bin="./target/release/nockchain-wallet"
  elif [ -f "target/debug/nockchain-wallet" ]; then
    wallet_bin="./target/debug/nockchain-wallet"
  fi
  
  if [ -z "$wallet_bin" ]; then
    echo -e "${RED}[-] æœªæ‰¾åˆ°é’±åŒ…ç¨‹åº${RESET}"
    pause_and_return
    return
  fi
  
  read -p "å¯†é’¥æ–‡ä»¶è·¯å¾„ (é»˜è®¤: ./keys.export): " keyfile
  keyfile=${keyfile:-"./keys.export"}
  
  if [ -f "$keyfile" ]; then
    "$wallet_bin" import-keys --input "$keyfile"
    echo -e "${GREEN}[+] å¯†é’¥å·²å¯¼å…¥${RESET}"
  else
    echo -e "${RED}[-] æ–‡ä»¶ä¸å­˜åœ¨: $keyfile${RESET}"
  fi
  pause_and_return
}

function start_node() {
  echo -e "[*] å¯åŠ¨èŠ‚ç‚¹..."
  cd "$NCK_DIR" || return 1
  
  if [ ! -f "$ENV_FILE" ]; then
    echo -e "${RED}[-] .envæ–‡ä»¶ä¸å­˜åœ¨${RESET}"
    pause_and_return
    return
  fi
  
  source "$ENV_FILE"
  if [ -z "$MINING_PUBKEY" ]; then
    echo -e "${RED}[-] æœªè®¾ç½®æŒ–çŸ¿å…¬é’¥${RESET}"
    pause_and_return
    return
  fi

  source "$HOME/.cargo/env" 2>/dev/null || true
  export PATH="$HOME/.cargo/bin:$PATH"

  # æŸ¥æ‰¾èŠ‚ç‚¹ç¨‹åº
  node_bin=""
  if command -v nockchain >/dev/null 2>&1; then
    node_bin="nockchain"
  elif [ -f "target/release/nockchain" ]; then
    node_bin="./target/release/nockchain"
  elif [ -f "target/debug/nockchain" ]; then
    node_bin="./target/debug/nockchain"
  fi
  
  if [ -z "$node_bin" ]; then
    echo -e "${RED}[-] æœªæ‰¾åˆ°èŠ‚ç‚¹ç¨‹åº${RESET}"
    pause_and_return
    return
  fi

  echo -e "${GREEN}[+] ä½¿ç”¨èŠ‚ç‚¹: $node_bin${RESET}"

  # æ¸…ç†æ—§æ•°æ®
  rm -rf ./.data.nockchain .socket/nockchain_npc.sock 2>/dev/null || true
  mkdir -p .socket

  # å¯åŠ¨å‘½ä»¤
  start_cmd="RUST_LOG=info $node_bin --mining-pubkey $MINING_PUBKEY \
--mine \
--peer /ip4/95.216.102.60/udp/3006/quic-v1 \
--peer /ip4/65.109.156.108/udp/3006/quic-v1 \
--peer /ip4/65.21.67.175/udp/3006/quic-v1 \
--peer /ip4/65.109.156.172/udp/3006/quic-v1 \
--peer /ip4/34.174.22.166/udp/3006/quic-v1 \
--npc-socket .socket/nockchain.sock \
--bind /ip4/0.0.0.0/udp/3006/quic-v1"

  if ! command -v screen >/dev/null 2>&1; then
    echo -e "${YELLOW}[!] åå°å¯åŠ¨...${RESET}"
    nohup bash -c "$start_cmd" > nockchain.log 2>&1 &
    echo -e "${GREEN}[+] èŠ‚ç‚¹å·²åå°å¯åŠ¨${RESET}"
  else
    if screen -list | grep -qw "nockchain"; then
      screen -S nockchain -X quit >/dev/null 2>&1
      sleep 2
    fi
    
    screen -dmS nockchain bash -c "cd '$NCK_DIR' && $start_cmd"
    sleep 3
    
    if screen -list | grep -qw "nockchain"; then
      echo -e "${GREEN}[+] èŠ‚ç‚¹å·²å¯åŠ¨ (screen: nockchain)${RESET}"
      echo -e "${YELLOW}[!] ä½¿ç”¨ 'screen -r nockchain' æŸ¥çœ‹æ—¥å¿—${RESET}"
    else
      echo -e "${RED}[-] èŠ‚ç‚¹å¯åŠ¨å¤±è´¥${RESET}"
    fi
  fi
  
  pause_and_return
}

function view_logs() {
  if command -v screen >/dev/null 2>&1 && screen -list | grep -qw "nockchain"; then
    echo -e "${YELLOW}[!] è¿›å…¥æ—¥å¿—æŸ¥çœ‹ (Ctrl+A+D é€€å‡º)...${RESET}"
    screen -r nockchain
  elif [ -f "$NCK_DIR/nockchain.log" ]; then
    echo -e "${YELLOW}[!] æ˜¾ç¤ºæ—¥å¿—:${RESET}"
    tail -f "$NCK_DIR/nockchain.log"
  else
    echo -e "${RED}[-] æ— æ—¥å¿—æ–‡ä»¶${RESET}"
  fi
  pause_and_return
}

function check_status() {
  echo -e "[*] æ£€æŸ¥çŠ¶æ€..."
  
  cd "$NCK_DIR" || return 1
  if [ -f "$ENV_FILE" ]; then
    source "$ENV_FILE" >/dev/null 2>&1
    if [ -n "$MINING_PUBKEY" ]; then
      echo -e "${GREEN}[+] å…¬é’¥: ${MINING_PUBKEY:0:16}...${MINING_PUBKEY: -16}${RESET}"
    else
      echo -e "${YELLOW}[!] æœªè®¾ç½®å…¬é’¥${RESET}"
    fi
  fi
  
  if command -v screen >/dev/null 2>&1 && screen -list | grep -qw "nockchain"; then
    echo -e "${GREEN}[+] èŠ‚ç‚¹è¿è¡Œä¸­${RESET}"
  elif pgrep -f "nockchain" >/dev/null 2>&1; then
    echo -e "${GREEN}[+] èŠ‚ç‚¹è¿è¡Œä¸­${RESET}"
  else
    echo -e "${RED}[-] èŠ‚ç‚¹æœªè¿è¡Œ${RESET}"
  fi
  
  # æ˜¾ç¤ºå·²å®‰è£…çš„ç»„ä»¶
  echo -e "${BLUE}[i] å·²å®‰è£…ç»„ä»¶:${RESET}"
  for binary in "hoonc" "nockchain-wallet" "nockchain"; do
    if command -v "$binary" >/dev/null 2>&1; then
      echo -e "${GREEN}  âœ“ $binary${RESET}"
    else
      echo -e "${YELLOW}  âœ— $binary${RESET}"
    fi
  done
  
  # æ˜¾ç¤ºç³»ç»Ÿèµ„æº
  echo -e "${BLUE}[i] ç³»ç»Ÿèµ„æº:${RESET}"
  echo -e "${BLUE}  å†…å­˜ä½¿ç”¨: $(free -h | grep Mem | awk '{print $3"/"$2}')${RESET}"
  echo -e "${BLUE}  Swapä½¿ç”¨: $(free -h | grep Swap | awk '{print $3"/"$2}')${RESET}"
  
  pause_and_return
}

function stop_node() {
  echo -e "[*] åœæ­¢èŠ‚ç‚¹..."
  
  if command -v screen >/dev/null 2>&1 && screen -list | grep -qw "nockchain"; then
    screen -S nockchain -X quit >/dev/null 2>&1
  fi
  
  if pgrep -f "nockchain" >/dev/null 2>&1; then
    pkill -f "nockchain" >/dev/null 2>&1
  fi
  
  sleep 2
  echo -e "${GREEN}[+] èŠ‚ç‚¹å·²åœæ­¢${RESET}"
  pause_and_return
}

function pause_and_return() {
  echo ""
  read -n1 -r -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..." key
  main_menu
}

function main_menu() {
  show_banner
  echo "è¯·é€‰æ‹©æ“ä½œ:"
  echo "  1) ğŸš€ ä¿®å¤å®‰è£… (è§£å†³èµ„äº§æ–‡ä»¶å’Œè™šæ‹Ÿæ¸…å•é—®é¢˜)"
  echo "  2) ğŸ”‘ ç”Ÿæˆé’±åŒ…"
  echo "  3) ğŸ“ è®¾ç½®æŒ–çŸ¿å…¬é’¥"
  echo "  4) ğŸ’¾ å¯¼å‡ºå¯†é’¥"
  echo "  5) ğŸ“‚ å¯¼å…¥å¯†é’¥"
  echo "  6) âš¡ å¯åŠ¨èŠ‚ç‚¹"
  echo "  7) ğŸ“Š æŸ¥çœ‹æ—¥å¿—"
  echo "  8) ğŸ” æ£€æŸ¥çŠ¶æ€"
  echo "  9) â¹ï¸  åœæ­¢èŠ‚ç‚¹"
  echo "  0) é€€å‡º"
  echo ""
  echo -e "${BLUE}ğŸ’¡ ä¸“é—¨ä¿®å¤: èµ„äº§æ–‡ä»¶ç¼ºå¤± + è™šæ‹Ÿæ¸…å•é”™è¯¯${RESET}"
  echo -e "${BLUE}ğŸ’¡ ä½¿ç”¨-på‚æ•°æŒ‡å®šåŒ…å + è‡ªåŠ¨åˆ›å»ºèµ„äº§æ–‡ä»¶${RESET}"
  echo ""
  read -p "è¯·è¾“å…¥ç¼–å·: " choice

  case "$choice" in
    1) setup_all ;;
    2) generate_wallet ;;
    3) set_pubkey_env ;;
    4) export_keys ;;
    5) import_keys ;;
    6) start_node ;;
    7) view_logs ;;
    8) check_status ;;
    9) stop_node ;;
    0) echo "é€€å‡ºè„šæœ¬."; exit 0 ;;
    *) echo -e "${RED}[-] æ— æ•ˆé€‰é¡¹${RESET}"; pause_and_return ;;
  esac
}

main_menu
