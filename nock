#!/bin/bash
# ==============================================================================
# Nockchain æŒ–çŸ¿åŠ©æ‰‹ (K2 å¢å¼ºèåˆç‰ˆ v11.0.0 - å†…æ ¸ä¸­å¿ƒç¨³å®šç‰ˆ)
# ==============================================================================
# ä½œè€…: K2 èŠ‚ç‚¹æ•™ç¨‹åˆ†äº« (AI ç»ˆæç¦»çº¿å†…æ ¸ç‰ˆ)
#
# v11.0.0 æ›´æ–°æ—¥å¿—:
# - [å†…æ ¸ä¸­å¿ƒ] æ–°å¢å†…æ ¸å®Œæ•´æ€§æ ¡éªŒï¼ä½¿ç”¨ SHA256 ç¡®ä¿å†…æ ¸åœ¨å®‰è£…å’Œå¯åŠ¨æ—¶æœªè¢«ç¯¡æ”¹ã€‚
# - [å†…æ ¸ä¸­å¿ƒ] æ–°å¢å¯åŠ¨å‰ç½®å®‰å…¨æ£€æŸ¥ã€‚åœ¨å¯åŠ¨æœåŠ¡å‰ï¼ŒéªŒè¯æ‰€æœ‰å…³é”®æ–‡ä»¶ï¼ˆäºŒè¿›åˆ¶ã€é…ç½®ã€å†…æ ¸ï¼‰çš„å®Œæ•´æ€§ã€‚
# - [å†…æ ¸ä¸­å¿ƒ] æ–°å¢ç‹¬ç«‹çš„å†…æ ¸æ›´æ–°åŠŸèƒ½ï¼Œå¯ä»æŒ‡å®š URL æ‹‰å–å¹¶éªŒè¯æ–°å†…æ ¸ï¼Œå®ç°æ— ç¼å‡çº§ã€‚
# - [ç¨³å®šæ€§å¢å¼º] æ–°å¢â€œå¥åº·æ£€æŸ¥â€åŠŸèƒ½ï¼Œæä¾›è¯¦ç»†çš„è¿è¡ŒçŠ¶æ€æŠ¥å‘Šï¼ŒåŒ…æ‹¬è¿›ç¨‹ã€èµ„æºå ç”¨å’Œå†…æ ¸çŠ¶æ€ã€‚
# - [ä½“éªŒä¼˜åŒ–] ä¸»èœå•å’ŒçŠ¶æ€æŠ¥å‘Šæ›´åŠ æ¸…æ™°ï¼Œæ‰€æœ‰æ“ä½œéƒ½å›´ç»•ç€ä¸€ä¸ªç¨³å®šã€å¯ä¿¡çš„å†…æ ¸è¿›è¡Œã€‚
# ==============================================================================

# --- æ™ºèƒ½å¼•å¯¼ä¸æƒé™æ£€æŸ¥ ---
# ... (æ­¤éƒ¨åˆ†ä»£ç æ— å˜åŒ–ï¼Œä¿æŒåŸæ ·) ...
if [ -z "$BASH_VERSION" ]; then echo -e "\033[0;31m[é”™è¯¯] æ­¤è„šæœ¬å¿…é¡»ä½¿ç”¨ 'bash' è§£é‡Šå™¨è¿è¡Œã€‚\033[0m"; echo -e "\033[1;33mè¯·ä½¿ç”¨: \033[0;32mbash $0\033[0m"; exit 1; fi
if [ "$(id -u)" -ne 0 ]; then echo -e "\033[1;33m[æç¤º] æ­¤è„šæœ¬éœ€è¦ Root æƒé™ã€‚\033[0m"; if ! command -v sudo &>/dev/null; then echo -e "\033[0;31m[é”™è¯¯] 'sudo' æœªæ‰¾åˆ°ã€‚è¯·ä»¥ root èº«ä»½è¿è¡Œã€‚\033[0m"; exit 1; fi; sudo bash "$0" "$@"; exit $?; fi
# --- å¼•å¯¼ç»“æŸ ---

set -e

# --- å…¨å±€é…ç½® ---
MINER_USERNAME="miner"
MINER_HOME="/home/${MINER_USERNAME}"
NCK_DIR="${MINER_HOME}/nockchain"
NCK_BIN="${MINER_HOME}/.cargo/bin/nockchain"
ENV_FILE="${NCK_DIR}/.env"
KERNEL_FILE="${NCK_DIR}/pkg/hoon.hoon"
SERVICE_NAME="nockchain-miner" # ä¹Ÿç”¨ä½œ screen ä¼šè¯å
SERVICE_FILE="/etc/systemd/system/${SERVICE_NAME}.service"

# --- é¢œè‰²å®šä¹‰ ---
# ... (æ­¤éƒ¨åˆ†ä»£ç æ— å˜åŒ–ï¼Œä¿æŒåŸæ ·) ...
if [ -t 1 ]; then RESET='\033[0m'; BOLD='\033[1m'; GREEN='\033[0;32m'; BLUE='\033[0;34m'; YELLOW='\033[1;33m'; RED='\033[0;31m'; PURPLE='\033[0;35m'; CYAN='\033[0;36m'; else RESET=''; BOLD=''; GREEN=''; BLUE=''; YELLOW=''; RED=''; PURPLE=''; CYAN=''; fi

# --- å†…æ ¸æ•°æ® (v140) ---
# [å†…æ ¸ä¸­å¿ƒ] å®šä¹‰å†…æ ¸ç‰ˆæœ¬å’Œæ ¡éªŒå’Œ
HOON_KERNEL_VERSION="v140"
HOON_KERNEL_SHA256="7a33a8246d30234795326164f9f688e404b9015e1284d720b080517457712398"
KERNEL_UPDATE_URL="https://gist.githubusercontent.com/someuser/somegist/raw/hoon.hoon" # ç¤ºä¾‹URLï¼Œè¯·æ›¿æ¢ä¸ºçœŸå®çš„

read -r -d '' HOON_KERNEL_CONTENT <<'EOF'
::
/+  hoon
|%
++  ver
  |%
  ++  arvo  0vI.need
  ++  kelvin  (as-co:co /(~ . 400))
  ++  hoon  140
  --
++  ride
  |%
  ++  sins  |=  a=ovum  (send a)
  ++  fard  |=  a=ovum  (send a)
  ++  send  |=  a=ovum  ~|([! a] !!)
  --
--
EOF

# ==============================================================================
# === åŠ©æ‰‹å‡½æ•° (ç¨³å®šæ€§æ ¸å¿ƒ) ===
# ==============================================================================

function check_command_exists() { command -v "$1" &>/dev/null; }
function detect_system_info() {
    # ... (æ­¤å‡½æ•°å†…éƒ¨é€»è¾‘ä¸å˜) ...
    if [ -f /etc/os-release ]; then . /etc/os-release; OS_ID=${ID,,}; else OS_ID=$(uname -s | tr '[:upper:]' '[:lower:]'); fi
    local screen_dep="screen"
    if check_command_exists apt-get; then export PKG_MANAGER="apt"; export UPDATE_CMD="apt-get update -y"; export INSTALL_CMD="apt-get install -y"; export DEP_PACKAGES="clang llvm libclang-dev pkg-config libssl-dev build-essential cmake git make curl dos2unix coreutils ${screen_dep} bc";
    elif check_command_exists dnf; then export PKG_MANAGER="dnf"; export UPDATE_CMD="dnf check-update"; export INSTALL_CMD="dnf install -y"; export DEP_PACKAGES="clang llvm-devel libclang-devel pkgconfig openssl-devel cmake git make curl dos2unix coreutils ${screen_dep} bc"; export GROUP_INSTALL_CMD="dnf groupinstall -y 'Development Tools'";
    elif check_command_exists yum; then export PKG_MANAGER="yum"; export UPDATE_CMD="yum check-update"; export INSTALL_CMD="yum install -y"; export DEP_PACKAGES="clang llvm-devel libclang-devel pkgconfig openssl-devel cmake git make curl dos2unix coreutils ${screen_dep} bc"; export GROUP_INSTALL_CMD="yum groupinstall -y 'Development Tools'";
    elif check_command_exists pacman; then export PKG_MANAGER="pacman"; export UPDATE_CMD="pacman -Sy"; export INSTALL_CMD="pacman -S --noconfirm --needed"; export DEP_PACKAGES="clang llvm libclang pkg-config openssl cmake git make curl dos2unix base-devel coreutils ${screen_dep} bc";
    elif check_command_exists zypper; then export PKG_MANAGER="zypper"; export UPDATE_CMD="zypper refresh"; export INSTALL_CMD="zypper install -y"; export DEP_PACKAGES="clang llvm-devel libclang-devel pkg-config libopenssl-devel cmake git make curl dos2unix patterns-devel-base-devel_basis coreutils ${screen_dep} bc";
    else export PKG_MANAGER="unsupported"; fi
    if [[ "$OS_ID" == "ubuntu" || "$OS_ID" == "debian" ]]; then export SUDO_GROUP="sudo"; else export SUDO_GROUP="wheel"; fi
}
function check_initial_deps() {
    # ... (æ­¤å‡½æ•°å†…éƒ¨é€»è¾‘ä¸å˜) ...
    local missing_deps=(); ! check_command_exists curl && missing_deps+=("curl"); ! check_command_exists git && missing_deps+=("git"); if [ ${#missing_deps[@]} -ne 0 ]; then echo -e "${RED}é”™è¯¯: ç¼ºå°‘æ ¸å¿ƒä¾èµ–: ${missing_deps[*]}${RESET}"; if [ "$PKG_MANAGER" != "unsupported" ]; then echo -e "${YELLOW}è¯·å°è¯•è¿è¡Œ: ${CYAN}${INSTALL_CMD} ${missing_deps[*]}${RESET}"; else echo -e "${YELLOW}è¯·æ‰‹åŠ¨å®‰è£…ã€‚${RESET}"; fi; exit 1; fi
}
function show_banner() {
    clear
    echo -e "${BOLD}${BLUE}===========================================================${RESET}"
    echo -e "${BOLD}${BLUE} Nockchain æŒ–çŸ¿åŠ©æ‰‹ (K2 v11.0.0 - å†…æ ¸ä¸­å¿ƒç¨³å®šç‰ˆ)${RESET}"
    echo -e "${BOLD}${BLUE}===========================================================${RESET}"
    echo -e "âœ¨ ${BOLD}${PURPLE}ç¨³å®šå†…æ ¸: ä½¿ç”¨å†…ç½® ${HOON_KERNEL_VERSION} (SHA256: ${HOON_KERNEL_SHA256:0:12}...)${RESET}"
    if check_systemd; then echo -e "âš™ï¸ ${BOLD}${GREEN}ç®¡ç†æ¨¡å¼: Systemd (ç°ä»£ç³»ç»Ÿæ ‡å‡†)${RESET}"; else echo -e "âš™ï¸ ${BOLD}${YELLOW}ç®¡ç†æ¨¡å¼: Screen (å…¼å®¹æ¨¡å¼)${RESET}"; fi
    if id "${MINER_USERNAME}" &>/dev/null; then echo -e "ğŸ‘¤ ${GREEN}ä¸“ç”¨ç”¨æˆ· '${MINER_USERNAME}' å·²åˆ›å»ºã€‚${RESET}"; else echo -e "ğŸ‘¤ ${YELLOW}ä¸“ç”¨ç”¨æˆ· '${MINER_USERNAME}' å¾…åˆ›å»ºã€‚${RESET}"; fi
    echo "ğŸ“Œ ä½œè€…: K2 èŠ‚ç‚¹æ•™ç¨‹åˆ†äº«"
    echo "-----------------------------------------------------------"; echo ""
}
function pause_and_return() { echo ""; read -r -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..." -s -n 1; echo; }
function check_systemd() { [ -d /run/systemd/system ] && check_command_exists systemctl; }

# [å†…æ ¸ä¸­å¿ƒ] æ–°å¢å†…æ ¸æ ¡éªŒå‡½æ•°
function verify_kernel_file() {
    local file_path="$1"
    local expected_sha="$2"
    if [ ! -f "$file_path" ]; then return 1; fi
    local actual_sha=$(sha256sum "$file_path" | awk '{print $1}')
    if [ "$actual_sha" == "$expected_sha" ]; then return 0; else return 1; fi
}

# [ç¨³å®šæ€§å¢å¼º] æ–°å¢å¯åŠ¨å‰ç½®æ£€æŸ¥å‡½æ•°
function pre_start_check() {
    echo -e "${CYAN}--- æ­£åœ¨æ‰§è¡Œå¯åŠ¨å‰ç½®å®‰å…¨æ£€æŸ¥ ---${RESET}"
    local pass=true
    if [ ! -f "$NCK_BIN" ]; then echo -e "${RED}[âœ—] æ£€æŸ¥å¤±è´¥: nockchain å¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°!${RESET}"; pass=false; fi
    if [ ! -f "$ENV_FILE" ] || ! grep -q "MINING_PUBKEY" "$ENV_FILE"; then echo -e "${RED}[âœ—] æ£€æŸ¥å¤±è´¥: æŒ–çŸ¿å…¬é’¥æœªè®¾ç½®!${RESET}"; pass=false; fi
    if [ ! -f "$KERNEL_FILE" ]; then echo -e "${RED}[âœ—] æ£€æŸ¥å¤±è´¥: å†…æ ¸æ–‡ä»¶ (hoon.hoon) æœªæ‰¾åˆ°!${RESET}"; pass=false; fi
    if ! verify_kernel_file "$KERNEL_FILE" "$HOON_KERNEL_SHA256"; then echo -e "${RED}[âœ—] æ£€æŸ¥å¤±è´¥: å†…æ ¸æ–‡ä»¶æ ¡éªŒå’Œä¸åŒ¹é…! å¯èƒ½å·²æŸåæˆ–è¢«ç¯¡æ”¹ã€‚${RESET}"; pass=false; fi
    
    if [ "$pass" = true ]; then
        echo -e "${GREEN}[âœ“] æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œç³»ç»Ÿå‡†å¤‡å°±ç»ªã€‚${RESET}"
        return 0
    else
        echo -e "${YELLOW}è¯·å…ˆè¿è¡Œ [1]å…¨æ–°å®‰è£… æˆ– [7]æ›´æ–°å†…æ ¸ ä»¥ä¿®å¤é—®é¢˜ã€‚${RESET}"
        return 1
    fi
}


# ==============================================================================
# === æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ===
# ==============================================================================

function install_all() {
    # ... (å¤§éƒ¨åˆ†é€»è¾‘ä¸å˜, ä»…åœ¨æ³¨å…¥å†…æ ¸åå¢åŠ æ ¡éªŒ) ...
    show_banner; check_initial_deps
    echo -e "${YELLOW}[*] å¼€å§‹å…¨æ–°å®‰è£… Nockchain...${RESET}"
    echo -e "${BLUE}--- æ­¥éª¤ 1/5: å‡†å¤‡ä¸“ç”¨ç”¨æˆ· '${MINER_USERNAME}' ---${RESET}"
    if id "${MINER_USERNAME}" &>/dev/null; then echo -e "${YELLOW}[!] æ¸…ç†æ—§ç”¨æˆ· '${MINER_USERNAME}'...${RESET}"; if check_systemd; then systemctl stop "$SERVICE_NAME" &>/dev/null; systemctl disable "$SERVICE_NAME" &>/dev/null; rm -f "$SERVICE_FILE"; systemctl daemon-reload &>/dev/null; fi; if check_command_exists screen; then screen -S ${SERVICE_NAME} -X quit &>/dev/null || true; fi; killall -u "${MINER_USERNAME}" 2>/dev/null || true; userdel -r "${MINER_USERNAME}" 2>/dev/null || true; echo -e "${GREEN}[+] æ—§ç¯å¢ƒæ¸…ç†å®Œæ¯•ã€‚${RESET}"; fi
    if [[ "$OS_ID" == "debian" || "$OS_ID" == "ubuntu" ]] && command -v adduser &>/dev/null; then adduser --disabled-password --gecos "" "${MINER_USERNAME}"; else useradd -m -s /bin/bash "${MINER_USERNAME}"; fi; usermod -aG "${SUDO_GROUP}" "${MINER_USERNAME}"; echo -e "${GREEN}[âœ“] ç”¨æˆ·åˆ›å»ºæˆåŠŸå¹¶é…ç½® sudoï¼${RESET}"
    
    echo -e "${BLUE}--- æ­¥éª¤ 2/5: å®‰è£…ç³»ç»Ÿä¾èµ– ---${RESET}"
    if [ "$PKG_MANAGER" == "unsupported" ]; then echo -e "${RED}é”™è¯¯: æœªçŸ¥åŒ…ç®¡ç†å™¨ã€‚${RESET}"; exit 1; fi
    echo -e "${CYAN}æ­£åœ¨æ›´æ–°åŒ…åˆ—è¡¨...${RESET}"; eval "$UPDATE_CMD"; echo -e "${CYAN}æ­£åœ¨å®‰è£…æ ¸å¿ƒä¾èµ–...${RESET}"; eval "$INSTALL_CMD $DEP_PACKAGES"; if [ -n "$GROUP_INSTALL_CMD" ]; then echo -e "${CYAN}æ­£åœ¨å®‰è£…å¼€å‘å·¥å…·é›†...${RESET}"; eval "$GROUP_INSTALL_CMD"; fi
    echo -e "${GREEN}[âœ“] ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆã€‚${RESET}"

    echo -e "${BLUE}--- æ­¥éª¤ 3/5 & 4/5: å…‹éš†ã€æ³¨å…¥å†…æ ¸å¹¶ç¼–è¯‘ ---${RESET}"
    local b64_kernel; b64_kernel=$(echo -n "$HOON_KERNEL_CONTENT" | base64)
    su - "${MINER_USERNAME}" -c bash <<EOF
    set -euo pipefail
    source "\$HOME/.cargo/env" || true
    if ! command -v cargo &>/dev/null; then curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y; source "\$HOME/.cargo/env"; fi
    
    NCK_DIR_SUB="\$HOME/nockchain"; rm -rf "\$NCK_DIR_SUB"; git clone https://github.com/zorp-corp/nockchain "\$NCK_DIR_SUB"; cd "\$NCK_DIR_SUB"
    
    echo "--- [${MINER_USERNAME}] æ­£åœ¨æ³¨å…¥ ${HOON_KERNEL_VERSION} å†…æ ¸... ---"
    echo "$b64_kernel" | base64 -d > "\$NCK_DIR_SUB/pkg/hoon.hoon"
    
    # [å†…æ ¸ä¸­å¿ƒ] æ³¨å…¥åç«‹å³è¿›è¡Œæ ¡éªŒ
    echo "--- [${MINER_USERNAME}] æ­£åœ¨æ ¡éªŒå†…æ ¸å®Œæ•´æ€§... ---"
    actual_sha=\$(sha256sum "\$NCK_DIR_SUB/pkg/hoon.hoon" | awk '{print \$1}')
    if [ "\$actual_sha" != "${HOON_KERNEL_SHA256}" ]; then
        echo -e "\033[0;31m[é”™è¯¯] å†…æ ¸æ³¨å…¥å¤±è´¥æˆ–æ ¡éªŒå’Œä¸åŒ¹é…ï¼å®‰è£…ä¸­æ­¢ã€‚\033[0m"
        exit 1
    fi
    echo -e "\033[0;32m[âœ“] å†…æ ¸æ ¡éªŒæˆåŠŸï¼\033[0m"

    echo "--- [${MINER_USERNAME}] æ­£åœ¨ç¼–è¯‘... ---"
    cargo build --release -p hoonc; mkdir -p assets
    "\$NCK_DIR_SUB/target/release/hoonc" pkg/miner.hoon > assets/miner.jam; "\$NCK_DIR_SUB/target/release/hoonc" pkg/dumb.hoon > assets/dumb.jam; "\$NCK_DIR_SUB/target/release/hoonc" pkg/wal.hoon > assets/wal.jam
    export RUSTFLAGS="-C target-cpu=native -C opt-level=3"; export CARGO_PROFILE_RELEASE_LTO="true"
    BUILD_JOBS=\$(nproc 2>/dev/null || echo 1)
    cargo build --release --workspace --exclude hoonc -j"\${BUILD_JOBS}"
    cp "\$NCK_DIR_SUB/target/release/nockchain" "\$HOME/.cargo/bin/"
    echo "--- [${MINER_USERNAME}] ç¼–è¯‘æˆåŠŸï¼ ---"
EOF
    if [ $? -ne 0 ]; then echo -e "\n${RED}å®‰è£…å¤±è´¥ï¼${RESET}"; else echo -e "\n${GREEN}[âœ“] Nockchain å®‰è£…æˆåŠŸï¼${RESET}"; fi
    pause_and_return
}

function set_pubkey() {
    # ... (æ­¤éƒ¨åˆ†ä»£ç æ— å˜åŒ–) ...
    show_banner; if [ ! -d "$NCK_DIR" ]; then echo -e "${RED}é”™è¯¯: Nockchain å°šæœªå®‰è£…ã€‚${RESET}"; pause_and_return; return; fi; local pubkey; read -r -p "è¯·è¾“å…¥æ‚¨çš„128ä½æŒ–çŸ¿å…¬é’¥: " pubkey; if ! [[ "$pubkey" =~ ^[0-9a-fA-F]{128}$ ]]; then echo -e "\n${RED}é”™è¯¯: å…¬é’¥æ ¼å¼æ— æ•ˆã€‚${RESET}"; pause_and_return; return; fi; touch "$ENV_FILE"; chown "${MINER_USERNAME}:${MINER_USERNAME}" "$ENV_FILE"; sed -i '/^MINING_PUBKEY=/d' "$ENV_FILE"; sed -i '/^MINER_THREADS=/d' "$ENV_FILE"; echo "MINING_PUBKEY=$pubkey" >> "$ENV_FILE"; echo "MINER_THREADS=$(nproc 2>/dev/null || echo 1)" >> "$ENV_FILE"; echo -e "\n${GREEN}[âœ“] é…ç½®å·²æˆåŠŸä¿å­˜ï¼${RESET}"; pause_and_return
}

# --- æœåŠ¡ç®¡ç† (å·²é›†æˆå‰ç½®æ£€æŸ¥) ---
function start_node() { show_banner; if ! pre_start_check; then pause_and_return; return; fi; if check_systemd; then start_node_systemd; else start_node_screen; fi; pause_and_return; }
function stop_node() { show_banner; if check_systemd; then stop_node_systemd; else stop_node_screen; fi; pause_and_return; }
function view_logs() { show_banner; if check_systemd; then view_logs_systemd; else view_logs_screen; fi; }

# --- Systemd å®ç° ---
function start_node_systemd() {
    echo -e "${YELLOW}[*] æ­£åœ¨ä½¿ç”¨ Systemd å¯åŠ¨æœåŠ¡...${RESET}"
    cat <<EOF > "$SERVICE_FILE"
[Unit]
Description=${SERVICE_NAME}; After=network-online.target
[Service]
User=${MINER_USERNAME}; Group=$(id -gn "${MINER_USERNAME}"); WorkingDirectory=${NCK_DIR}; EnvironmentFile=${ENV_FILE}
ExecStart=${NCK_BIN}
Restart=on-failure; RestartSec=10; LimitNOFILE=65536; Nice=-5
[Install]
WantedBy=multi-user.target
EOF
    systemctl daemon-reload; systemctl enable "$SERVICE_NAME"; systemctl restart "$SERVICE_NAME"
    echo -e "\n${GREEN}[âœ“] Systemd æœåŠ¡ '${SERVICE_NAME}' å·²å¯åŠ¨å¹¶è®¾ä¸ºå¼€æœºè‡ªå¯ï¼${RESET}"
}
function stop_node_systemd() { if ! systemctl list-units --full -all | grep -q "${SERVICE_NAME}.service"; then echo -e "${YELLOW}æç¤º: æœåŠ¡æœªå®‰è£…ã€‚${RESET}"; return; fi; echo -e "${YELLOW}[*] æ­£åœ¨åœæ­¢ Systemd æœåŠ¡...${RESET}"; systemctl stop "$SERVICE_NAME"; echo -e "\n${GREEN}[âœ“] Systemd æœåŠ¡ '${SERVICE_NAME}' å·²åœæ­¢ã€‚${RESET}"; }
function view_logs_systemd() { if ! systemctl list-units --full -all | grep -q "${SERVICE_NAME}.service"; then echo -e "${YELLOW}æç¤º: æœåŠ¡æœªå®‰è£…ã€‚${RESET}"; pause_and_return; return; fi; echo -e "${YELLOW}æ˜¾ç¤ºå®æ—¶æ—¥å¿— (Systemd)... æŒ‰ Ctrl+C é€€å‡ºã€‚${RESET}"; echo "------------------------------------------------------"; journalctl -u "$SERVICE_NAME" -f --no-pager; pause_and_return; }

# --- Screen (å…¼å®¹æ¨¡å¼) å®ç° ---
function start_node_screen() {
    if ! check_command_exists screen; then echo -e "${RED}é”™è¯¯: 'screen' æœªå®‰è£…ã€‚${RESET}"; return; fi
    if screen -ls | grep -q "${SERVICE_NAME}"; then echo -e "${YELLOW}æç¤º: æŒ–çŸ¿è¿›ç¨‹å·²åœ¨ Screen ä¸­è¿è¡Œã€‚${RESET}"; return; fi
    echo -e "${YELLOW}[*] æ­£åœ¨ä½¿ç”¨ Screen (å…¼å®¹æ¨¡å¼) åœ¨åå°å¯åŠ¨æŒ–çŸ¿...${RESET}"
    su - "${MINER_USERNAME}" -c "screen -dmS ${SERVICE_NAME} bash -c 'cd ${NCK_DIR} && source ${ENV_FILE} && ${NCK_BIN}'"
    echo -e "\n${GREEN}[âœ“] æŒ–çŸ¿å·²åœ¨åä¸º '${SERVICE_NAME}' çš„ Screen ä¼šè¯ä¸­å¯åŠ¨ï¼${RESET}"; echo -e "${CYAN}æç¤º: æ­¤æ¨¡å¼ä¸ä¼šå¼€æœºè‡ªå¯ã€‚${RESET}";
}
function stop_node_screen() { if ! check_command_exists screen; then echo -e "${RED}é”™è¯¯: 'screen' æœªå®‰è£…ã€‚${RESET}"; return; fi; if ! screen -ls | grep -q "${SERVICE_NAME}"; then echo -e "${YELLOW}æç¤º: Screen ä¸­æ²¡æœ‰æ­£åœ¨è¿è¡Œçš„æŒ–çŸ¿è¿›ç¨‹ã€‚${RESET}"; return; fi; echo -e "${YELLOW}[*] æ­£åœ¨åœæ­¢ Screen ä¼šè¯...${RESET}"; screen -S "${SERVICE_NAME}" -X quit; echo -e "\n${GREEN}[âœ“] Screen ä¼šè¯ '${SERVICE_NAME}' å·²åœæ­¢ã€‚${RESET}"; }
function view_logs_screen() { if ! check_command_exists screen; then echo -e "${RED}é”™è¯¯: 'screen' æœªå®‰è£…ã€‚${RESET}"; pause_and_return; return; fi; if ! screen -ls | grep -q "${SERVICE_NAME}"; then echo -e "${YELLOW}æç¤º: Screen ä¸­æ²¡æœ‰æ­£åœ¨è¿è¡Œçš„æŒ–çŸ¿è¿›ç¨‹ã€‚${RESET}"; pause_and_return; return; fi; echo -e "${YELLOW}æ­£åœ¨é™„åŠ åˆ° Screen ä¼šè¯... ${CYAN}æŒ‰ç»„åˆé”® Ctrl+A ç„¶åæŒ‰ D é€€å‡º${RESET}"; echo "------------------------------------------------------"; sleep 2; screen -r "${SERVICE_NAME}"; pause_and_return; }

# [å†…æ ¸ä¸­å¿ƒ] æ–°å¢å†…æ ¸ç®¡ç†å’Œå¥åº·æ£€æŸ¥åŠŸèƒ½
function update_kernel() {
    show_banner
    if [ ! -d "$NCK_DIR" ]; then echo -e "${RED}é”™è¯¯: Nockchain å°šæœªå®‰è£…ï¼Œæ— æ³•æ›´æ–°å†…æ ¸ã€‚${RESET}"; pause_and_return; return; fi
    echo -e "${YELLOW}æ­¤æ“ä½œå°†ä»ä»¥ä¸‹ URL ä¸‹è½½æ–°å†…æ ¸å¹¶è¦†ç›–ç°æœ‰æ–‡ä»¶:${RESET}"
    echo -e "${CYAN}${KERNEL_UPDATE_URL}${RESET}"
    echo -e "${YELLOW}æ–°å†…æ ¸å¿…é¡»ä¸è„šæœ¬å†…ç½®çš„æ ¡éªŒå’Œ (${HOON_KERNEL_SHA256:0:16}...) åŒ¹é…ã€‚${RESET}"
    read -r -p "ç¡®å®šè¦ç»§ç»­å—? (y/N): " confirm
    if [[ ! "$confirm" =~ ^[yY]$ ]]; then echo -e "${RED}æ“ä½œå·²å–æ¶ˆã€‚${RESET}"; pause_and_return; return; fi

    echo -e "${CYAN}æ­£åœ¨åœæ­¢æŒ–çŸ¿è¿›ç¨‹ä»¥å®‰å…¨æ›´æ–°...${RESET}"
    if check_systemd; then stop_node_systemd; else stop_node_screen; fi

    echo -e "${CYAN}æ­£åœ¨ä¸‹è½½æ–°å†…æ ¸...${RESET}"
    if ! curl -L --fail -o "${KERNEL_FILE}.tmp" "${KERNEL_UPDATE_URL}"; then
        echo -e "${RED}é”™è¯¯: å†…æ ¸ä¸‹è½½å¤±è´¥ï¼è¯·æ£€æŸ¥ URL æˆ–ç½‘ç»œè¿æ¥ã€‚${RESET}"; rm -f "${KERNEL_FILE}.tmp"; pause_and_return; return;
    fi

    echo -e "${CYAN}æ­£åœ¨æ ¡éªŒä¸‹è½½çš„å†…æ ¸...${RESET}"
    if verify_kernel_file "${KERNEL_FILE}.tmp" "$HOON_KERNEL_SHA256"; then
        echo -e "${GREEN}[âœ“] æ–°å†…æ ¸æ ¡éªŒæˆåŠŸï¼${RESET}"
        chown "${MINER_USERNAME}:${MINER_USERNAME}" "${KERNEL_FILE}.tmp"
        mv "${KERNEL_FILE}.tmp" "${KERNEL_FILE}"
        echo -e "${GREEN}å†…æ ¸å·²æˆåŠŸæ›´æ–°ä¸º ${HOON_KERNEL_VERSION}ï¼${RESET}"
    else
        echo -e "${RED}[âœ—] é”™è¯¯: ä¸‹è½½çš„å†…æ ¸æ–‡ä»¶æ ¡éªŒå’Œä¸åŒ¹é…ï¼ä¸ºå®‰å…¨èµ·è§ï¼Œæ›´æ–°å·²ä¸­æ­¢ã€‚${RESET}"
        rm -f "${KERNEL_FILE}.tmp"
    fi
    pause_and_return
}

function health_check() {
    show_banner
    echo -e "${BOLD}${PURPLE}--- ç³»ç»Ÿå¥åº·æ£€æŸ¥æŠ¥å‘Š ---${RESET}"
    
    # 1. æœåŠ¡çŠ¶æ€
    echo -e "${BLUE}1. æœåŠ¡çŠ¶æ€:${RESET}"
    local is_running=false
    if check_systemd; then
        if systemctl is-active --quiet "$SERVICE_NAME"; then echo -e "   - ç®¡ç†æ–¹å¼: ${GREEN}Systemd${RESET}"; echo -e "   - çŠ¶æ€: ${GREEN}è¿è¡Œä¸­${RESET}"; is_running=true; else echo -e "   - ç®¡ç†æ–¹å¼: ${GREEN}Systemd${RESET}"; echo -e "   - çŠ¶æ€: ${RED}å·²åœæ­¢${RESET}"; fi
    elif check_command_exists screen; then
        if screen -ls | grep -q -w "${SERVICE_NAME}"; then echo -e "   - ç®¡ç†æ–¹å¼: ${YELLOW}Screen${RESET}"; echo -e "   - çŠ¶æ€: ${GREEN}è¿è¡Œä¸­${RESET}"; is_running=true; else echo -e "   - ç®¡ç†æ–¹å¼: ${YELLOW}Screen${RESET}"; echo -e "   - çŠ¶æ€: ${RED}å·²åœæ­¢${RESET}"; fi
    else echo -e "   - ${RED}æœªæ‰¾åˆ°æœåŠ¡ç®¡ç†å·¥å…·ã€‚${RESET}"; fi

    # 2. è¿›ç¨‹ä¿¡æ¯ (å¦‚æœæ­£åœ¨è¿è¡Œ)
    echo -e "${BLUE}2. è¿›ç¨‹ä¿¡æ¯:${RESET}"
    if $is_running; then
        local pid=$(pgrep -u "${MINER_USERNAME}" -f nockchain)
        if [ -n "$pid" ]; then
            local p_info=$(ps -p "$pid" -o pid=,etime=,%cpu=,%mem=,rss=)
            echo -e "   - PID: ${GREEN}$(echo $p_info | awk '{print $1}')${RESET}"
            echo -e "   - è¿è¡Œæ—¶é—´: ${GREEN}$(echo $p_info | awk '{print $2}')${RESET}"
            echo -e "   - CPU å ç”¨: ${GREEN}$(echo $p_info | awk '{print $3}')%${RESET}"
            echo -e "   - å†…å­˜å ç”¨: ${GREEN}$(echo $p_info | awk '{print $4}')% ($(echo $p_info | awk '{print $5/1024}' | xargs printf "%.2f") MB)${RESET}"
        else echo -e "   - ${YELLOW}è­¦å‘Š: æœåŠ¡çŠ¶æ€ä¸ºè¿è¡Œä¸­ï¼Œä½†æ‰¾ä¸åˆ° nockchain è¿›ç¨‹!${RESET}"; fi
    else echo "   - ${CYAN}æœåŠ¡æœªè¿è¡Œã€‚${RESET}"; fi

    # 3. å†…æ ¸ä¸é…ç½®æ£€æŸ¥
    echo -e "${BLUE}3. å†…æ ¸ä¸é…ç½®:${RESET}"
    if [ -f "$KERNEL_FILE" ]; then
        if verify_kernel_file "$KERNEL_FILE" "$HOON_KERNEL_SHA256"; then echo -e "   - å†…æ ¸çŠ¶æ€: ${GREEN}[OK] ${HOON_KERNEL_VERSION} (æ ¡éªŒå’ŒåŒ¹é…)${RESET}"; else echo -e "   - å†…æ ¸çŠ¶æ€: ${RED}[ä¸åŒ¹é…!] å½“å‰å†…æ ¸å·²æŸåæˆ–ç‰ˆæœ¬ä¸æ­£ç¡®!${RESET}"; fi
    else echo -e "   - å†…æ ¸çŠ¶æ€: ${RED}[ç¼ºå¤±!] å†…æ ¸æ–‡ä»¶ hoon.hoon ä¸å­˜åœ¨!${RESET}"; fi
    if [ -f "$ENV_FILE" ] && grep -q "MINING_PUBKEY" "$ENV_FILE"; then pubkey=$(grep MINING_PUBKEY "$ENV_FILE" | cut -d '=' -f 2); echo -e "   - æŒ–çŸ¿å…¬é’¥: ${GREEN}${pubkey:0:8}...${pubkey: -8}${RESET}"; else echo -e "   - æŒ–çŸ¿å…¬é’¥: ${RED}[æœªè®¾ç½®!]${RESET}"; fi
    
    echo "---------------------------"
    pause_and_return
}


function main_menu() {
    while true; do
    show_banner
    echo -e "${BOLD}${GREEN}--- ä¸»èœå• ---${RESET}"; echo "è¯·é€‰æ‹©è¦æ‰§è¡Œçš„æ“ä½œ:"; echo ""
    echo -e "  ${CYAN}1)${RESET} å…¨æ–°å®‰è£… Nockchain (ä¼šæ¸…ç©ºæ—§æ•°æ®)"
    echo -e "  ${CYAN}2)${RESET} è®¾ç½®/æ›´æ–°æŒ–çŸ¿å…¬é’¥"
    echo ""
    if check_systemd; then
        if systemctl is-active --quiet "$SERVICE_NAME"; then SERVICE_STATUS="${GREEN}(è¿è¡Œä¸­)${RESET}"; else SERVICE_STATUS="${RED}(å·²åœæ­¢)${RESET}"; fi
        echo -e "  ${CYAN}3)${RESET} ${BOLD}å¯åŠ¨${RESET}æŒ–çŸ¿ (Systemd) ${SERVICE_STATUS}"
        echo -e "  ${CYAN}4)${RESET} ${BOLD}åœæ­¢${RESET}æŒ–çŸ¿ (Systemd)"
        echo -e "  ${CYAN}5)${RESET} æŸ¥çœ‹å®æ—¶æ—¥å¿— (Systemd)"
    elif check_command_exists screen; then
        if screen -ls | grep -q -w "${SERVICE_NAME}"; then SERVICE_STATUS="${GREEN}(è¿è¡Œä¸­)${RESET}"; else SERVICE_STATUS="${RED}(å·²åœæ­¢)${RESET}"; fi
        echo -e "  ${CYAN}3)${RESET} ${BOLD}å¯åŠ¨${RESET}æŒ–çŸ¿ (Screen) ${SERVICE_STATUS}"
        echo -e "  ${CYAN}4)${RESET} ${BOLD}åœæ­¢${RESET}æŒ–çŸ¿ (Screen)"
        echo -e "  ${CYAN}5)${RESET} æŸ¥çœ‹æŒ–çŸ¿çª—å£ (Screen)"
    else
        echo -e "  ${RED}3-5) (ä¸å¯ç”¨) ç¼ºå°‘ Systemd æˆ– Screenã€‚${RESET}"
    fi
    echo ""
    echo -e "  ${PURPLE}6)${RESET} ${BOLD}å¥åº·æ£€æŸ¥${RESET} (æ£€æŸ¥è¿è¡ŒçŠ¶æ€ä¸å†…æ ¸)"
    echo -e "  ${PURPLE}7)${RESET} ä»ç½‘ç»œæ›´æ–°å†…æ ¸"
    echo ""
    echo -e "  ${YELLOW}0) é€€å‡ºè„šæœ¬${RESET}"; echo ""
    read -r -p "è¯·è¾“å…¥é€‰é¡¹ç¼–å·: " choice
    case "$choice" in
        1) install_all ;; 2) set_pubkey ;; 3) start_node ;; 4) stop_node ;; 5) view_logs ;;
        6) health_check ;; 7) update_kernel ;;
        0) echo -e "${BLUE}æ„Ÿè°¢ä½¿ç”¨ï¼å†è§ã€‚${RESET}"; exit 0 ;;
        *) echo -e "${RED}æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚${RESET}"; sleep 1 ;;
    esac
    done
}

# --- è„šæœ¬å…¥å£ ---
detect_system_info
main_menu
