#!/bin/bash

# Nockchain èŠ‚ç‚¹ç®¡ç†è„šæœ¬
# åŠŸèƒ½ï¼šå®‰è£…ã€é…ç½®ã€å¯åŠ¨èŠ‚ç‚¹å’Œæ—¥å¿—æŸ¥çœ‹
# ç‰ˆæœ¬ï¼š2.0 ä¿®å¤æ”¹è¿›ç‰ˆ

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# é…ç½®æ–‡ä»¶è·¯å¾„
ENV_FILE=".env"
ENV_EXAMPLE=".env_example"
LOG_FILE="nockchain.log"

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_blue() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

# éªŒè¯æŒ–çŸ¿å…¬é’¥æ ¼å¼
validate_mining_pubkey() {
    local pubkey="$1"
    
    # æ£€æŸ¥æ˜¯å¦ä¸º128ä½16è¿›åˆ¶ï¼ˆ64ä¸ªå­—ç¬¦çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼‰
    if [[ ! "$pubkey" =~ ^[0-9a-fA-F]{64}$ ]]; then
        log_error "æ— æ•ˆçš„æŒ–çŸ¿å…¬é’¥æ ¼å¼"
        log_error "æŒ–çŸ¿å…¬é’¥å¿…é¡»æ˜¯128ä½16è¿›åˆ¶æ ¼å¼ï¼ˆ64ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ï¼‰"
        log_error "ç¤ºä¾‹æ ¼å¼: 1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
        return 1
    fi
    
    return 0
}

# æ£€æŸ¥ç³»ç»Ÿèµ„æº
check_system_resources() {
    log_info "æ£€æŸ¥ç³»ç»Ÿèµ„æº..."
    
    # æ£€æŸ¥å†…å­˜
    local total_mem=$(free -g | awk '/^Mem:/{print $2}')
    if [ "$total_mem" -lt 64 ]; then
        log_warn "è­¦å‘Šï¼šç³»ç»Ÿå†…å­˜ä¸º ${total_mem}GBï¼Œå»ºè®®è‡³å°‘64GB"
        log_warn "è¿™å¯èƒ½å½±å“èŠ‚ç‚¹æ€§èƒ½"
    else
        log_info "å†…å­˜æ£€æŸ¥é€šè¿‡ï¼š${total_mem}GB"
    fi
    
    # æ£€æŸ¥ç£ç›˜ç©ºé—´
    local disk_space=$(df -BG . | awk 'NR==2 {print $4}' | sed 's/G//')
    if [ "$disk_space" -lt 200 ]; then
        log_warn "è­¦å‘Šï¼šå¯ç”¨ç£ç›˜ç©ºé—´ä¸º ${disk_space}GBï¼Œå»ºè®®è‡³å°‘200GB"
    else
        log_info "ç£ç›˜ç©ºé—´æ£€æŸ¥é€šè¿‡ï¼š${disk_space}GBå¯ç”¨"
    fi
    
    # æ£€æŸ¥CPUæ ¸å¿ƒæ•°
    local cpu_cores=$(nproc)
    if [ "$cpu_cores" -lt 6 ]; then
        log_warn "è­¦å‘Šï¼šCPUæ ¸å¿ƒæ•°ä¸º ${cpu_cores}ï¼Œå»ºè®®è‡³å°‘6æ ¸"
    else
        log_info "CPUæ£€æŸ¥é€šè¿‡ï¼š${cpu_cores}æ ¸"
    fi
}

# æ£€æŸ¥ä¾èµ–
check_dependencies() {
    log_info "æ£€æŸ¥ç³»ç»Ÿä¾èµ–..."
    
    # æ£€æŸ¥ Rust å’Œ Cargo
    if ! command -v cargo &> /dev/null; then
        log_error "Cargo æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£… Rust..."
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source $HOME/.cargo/env
        log_info "Rust å®‰è£…å®Œæˆ"
    else
        log_info "Rust/Cargo å·²å®‰è£…ï¼š$(cargo --version)"
    fi
    
    # æ£€æŸ¥å¿…è¦çš„ç³»ç»ŸåŒ…
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        local required_packages=(
            "curl" "git" "build-essential" "pkg-config" 
            "libssl-dev" "clang" "libclang-dev" "llvm-dev"
            "libleveldb-dev" "make" "cmake"
        )
        local missing_packages=()
        
        for package in "${required_packages[@]}"; do
            if ! dpkg -l | grep -q "^ii.*$package"; then
                missing_packages+=("$package")
            fi
        done
        
        if [ ${#missing_packages[@]} -ne 0 ]; then
            log_warn "ç¼ºå°‘ä»¥ä¸‹ä¾èµ–åŒ…: ${missing_packages[*]}"
            read -p "æ˜¯å¦è‡ªåŠ¨å®‰è£…è¿™äº›ä¾èµ–ï¼Ÿ(y/n): " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                sudo apt update
                sudo apt install -y "${missing_packages[@]}"
                log_info "ä¾èµ–åŒ…å®‰è£…å®Œæˆ"
            else
                log_warn "è¯·æ‰‹åŠ¨å®‰è£…ç¼ºå°‘çš„ä¾èµ–åŒ…"
                return 1
            fi
        else
            log_info "æ‰€æœ‰å¿…éœ€çš„ä¾èµ–åŒ…éƒ½å·²å®‰è£…"
        fi
    fi
    
    log_info "ä¾èµ–æ£€æŸ¥å®Œæˆ"
}

# åˆå§‹åŒ–ç¯å¢ƒæ–‡ä»¶
init_env_file() {
    if [ ! -f "$ENV_FILE" ]; then
        if [ -f "$ENV_EXAMPLE" ]; then
            cp "$ENV_EXAMPLE" "$ENV_FILE"
            log_info "å·²ä» .env_example åˆ›å»º .env æ–‡ä»¶"
        else
            log_warn ".env_example æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤é…ç½®"
            cat > "$ENV_FILE" << EOF
RUST_LOG=info,nockchain=info,nockchain_libp2p_io=info,libp2p=info,libp2p_quic=info
MINIMAL_LOG_FORMAT=true
MINING_PUBKEY=0000000000000000000000000000000000000000000000000000000000000000
EOF
        fi
        log_info "ç¯å¢ƒæ–‡ä»¶åˆå§‹åŒ–å®Œæˆ"
    else
        log_info "ç¯å¢ƒæ–‡ä»¶å·²å­˜åœ¨"
    fi
}

# å®Œæ•´å®‰è£…å‡½æ•°
install_nockchain() {
    log_info "å¼€å§‹å®‰è£… Nockchain..."
    
    # æ£€æŸ¥ç³»ç»Ÿèµ„æº
    check_system_resources
    
    # æ£€æŸ¥ä¾èµ–
    check_dependencies || return 1
    
    # åˆå§‹åŒ–ç¯å¢ƒæ–‡ä»¶
    init_env_file
    
    # ç¡®ä¿ Rust ç¯å¢ƒå¯ç”¨
    source $HOME/.cargo/env 2>/dev/null || true
    export PATH="$HOME/.cargo/bin:$PATH"
    
    # å®‰è£… hoonc ç¼–è¯‘å™¨
    log_info "å®‰è£… Hoon ç¼–è¯‘å™¨..."
    if make install-hoonc; then
        log_info "Hoon ç¼–è¯‘å™¨å®‰è£…æˆåŠŸ"
    else
        log_error "Hoon ç¼–è¯‘å™¨å®‰è£…å¤±è´¥"
        log_error "è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œç³»ç»Ÿä¾èµ–"
        return 1
    fi
    
    # æ„å»ºé¡¹ç›®
    log_info "æ„å»º Nockchain é¡¹ç›®..."
    if make build; then
        log_info "é¡¹ç›®æ„å»ºæˆåŠŸ"
    else
        log_error "é¡¹ç›®æ„å»ºå¤±è´¥"
        log_error "è¯·æ£€æŸ¥ç³»ç»Ÿèµ„æºå’Œä¾èµ–"
        return 1
    fi
    
    # å®‰è£… nockchain äºŒè¿›åˆ¶æ–‡ä»¶
    log_info "å®‰è£… Nockchain èŠ‚ç‚¹..."
    if make install-nockchain; then
        log_info "Nockchain èŠ‚ç‚¹å®‰è£…æˆåŠŸ"
    else
        log_error "Nockchain èŠ‚ç‚¹å®‰è£…å¤±è´¥"
        return 1
    fi
    
    # å®‰è£…é’±åŒ…
    log_info "å®‰è£… Nockchain é’±åŒ…..."
    if make install-nockchain-wallet; then
        log_info "Nockchain é’±åŒ…å®‰è£…æˆåŠŸ"
    else
        log_error "Nockchain é’±åŒ…å®‰è£…å¤±è´¥"
        return 1
    fi
    
    log_info "Nockchain å®‰è£…å®Œæˆï¼"
    log_info "è¯·ç¡®ä¿å°† \$HOME/.cargo/bin æ·»åŠ åˆ°æ‚¨çš„ PATH ç¯å¢ƒå˜é‡ä¸­"
    
    # æ·»åŠ åˆ° .bashrc
    if ! grep -q 'export PATH="$HOME/.cargo/bin:$PATH"' ~/.bashrc; then
        echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> ~/.bashrc
        log_info "å·²è‡ªåŠ¨æ·»åŠ  Cargo bin ç›®å½•åˆ° PATH"
    fi
}

# ç”Ÿæˆæ–°çš„æŒ–çŸ¿å¯†é’¥
generate_mining_key() {
    log_info "ç”Ÿæˆæ–°çš„æŒ–çŸ¿å¯†é’¥..."
    
    if ! command -v nockchain-wallet &> /dev/null; then
        log_error "nockchain-wallet æœªå®‰è£…ï¼Œè¯·å…ˆè¿è¡Œå®‰è£…é€‰é¡¹"
        return 1
    fi
    
    # ç”Ÿæˆå¯†é’¥å¯¹
    local key_output
    key_output=$(nockchain-wallet keygen 2>&1)
    
    if [ $? -eq 0 ]; then
        echo "$key_output"
        
        # ç”Ÿæˆ128ä½16è¿›åˆ¶æ ¼å¼çš„æŒ–çŸ¿å…¬é’¥
        local hex_pubkey
        if command -v openssl &> /dev/null; then
            hex_pubkey=$(openssl rand -hex 32)
        else
            hex_pubkey=$(xxd -l 32 -p /dev/urandom | tr -d '\n')
        fi
        
        log_info "ç”Ÿæˆçš„128ä½16è¿›åˆ¶æŒ–çŸ¿å…¬é’¥:"
        log_blue "$hex_pubkey"
        
        # æ›´æ–° .env æ–‡ä»¶
        if [ -f "$ENV_FILE" ]; then
            # å¤‡ä»½åŸæ–‡ä»¶
            cp "$ENV_FILE" "${ENV_FILE}.backup.$(date +%Y%m%d_%H%M%S)"
            
            # æ›´æ–° MINING_PUBKEY
            sed -i "s/^MINING_PUBKEY=.*/MINING_PUBKEY=$hex_pubkey/" "$ENV_FILE"
            log_info "æŒ–çŸ¿å…¬é’¥å·²æ›´æ–°åˆ° .env æ–‡ä»¶"
            log_info "åŸé…ç½®å·²å¤‡ä»½"
        else
            log_warn ".env æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·æ‰‹åŠ¨åˆ›å»ºå¹¶æ·»åŠ å…¬é’¥"
        fi
        
        log_warn "é‡è¦æç¤ºï¼šè¯·å¤‡ä»½æ‚¨çš„åŠ©è®°è¯å’Œç§é’¥ï¼"
        read -p "æŒ‰ä»»æ„é”®ç»§ç»­..."
    else
        log_error "å¯†é’¥ç”Ÿæˆå¤±è´¥: $key_output"
        return 1
    fi
}

# æ›´æ”¹æŒ–çŸ¿å…¬é’¥
change_mining_key() {
    log_info "æ›´æ”¹æŒ–çŸ¿å…¬é’¥"
    log_info "è¯·è¾“å…¥128ä½16è¿›åˆ¶æ ¼å¼çš„æŒ–çŸ¿å…¬é’¥ï¼ˆ64ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ï¼‰"
    echo
    log_blue "æ ¼å¼ç¤ºä¾‹: 1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
    echo
    
    while true; do
        read -p "æŒ–çŸ¿å…¬é’¥: " new_pubkey
        
        if [ -z "$new_pubkey" ]; then
            log_error "å…¬é’¥ä¸èƒ½ä¸ºç©º"
            continue
        fi
        
        # éªŒè¯å…¬é’¥æ ¼å¼
        if validate_mining_pubkey "$new_pubkey"; then
            if [ -f "$ENV_FILE" ]; then
                # å¤‡ä»½åŸæ–‡ä»¶
                cp "$ENV_FILE" "${ENV_FILE}.backup.$(date +%Y%m%d_%H%M%S)"
                
                # æ›´æ–° MINING_PUBKEY
                sed -i "s/^MINING_PUBKEY=.*/MINING_PUBKEY=$new_pubkey/" "$ENV_FILE"
                log_info "æŒ–çŸ¿å…¬é’¥å·²æ›´æ–°"
                log_info "åŸé…ç½®å·²å¤‡ä»½"
                break
            else
                log_error ".env æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œå®‰è£…é€‰é¡¹"
                break
            fi
        else
            log_error "è¯·é‡æ–°è¾“å…¥æ­£ç¡®æ ¼å¼çš„å…¬é’¥"
        fi
    done
}

# å¯åŠ¨èŠ‚ç‚¹
start_node() {
    log_info "å¯åŠ¨ Nockchain èŠ‚ç‚¹"
    
    if ! command -v nockchain &> /dev/null; then
        log_error "nockchain æœªå®‰è£…ï¼Œè¯·å…ˆè¿è¡Œå®‰è£…é€‰é¡¹"
        return 1
    fi
    
    if [ ! -f "$ENV_FILE" ]; then
        log_error ".env æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œå®‰è£…æˆ–é…ç½®é€‰é¡¹"
        return 1
    fi
    
    # åŠ è½½ç¯å¢ƒå˜é‡
    source "$ENV_FILE"
    export RUST_LOG
    export MINIMAL_LOG_FORMAT
    export MINING_PUBKEY
    
    # éªŒè¯æŒ–çŸ¿å…¬é’¥æ ¼å¼
    if ! validate_mining_pubkey "$MINING_PUBKEY"; then
        log_error "å½“å‰é…ç½®çš„æŒ–çŸ¿å…¬é’¥æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·å…ˆæ›´æ–°å…¬é’¥"
        return 1
    fi
    
    # æ£€æŸ¥æ˜¯å¦å·²æœ‰èŠ‚ç‚¹åœ¨è¿è¡Œ
    if pgrep -f "nockchain" > /dev/null; then
        log_warn "æ£€æµ‹åˆ° Nockchain è¿›ç¨‹å·²åœ¨è¿è¡Œ"
        log_warn "è¿›ç¨‹ID: $(pgrep -f nockchain)"
        read -p "æ˜¯å¦åœæ­¢ç°æœ‰è¿›ç¨‹å¹¶é‡æ–°å¯åŠ¨ï¼Ÿ(y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            pkill -f nockchain
            sleep 2
            log_info "å·²åœæ­¢ç°æœ‰è¿›ç¨‹"
        else
            log_info "ä¿æŒç°æœ‰è¿›ç¨‹è¿è¡Œ"
            return 0
        fi
    fi
    
    log_info "å¯åŠ¨æŒ–çŸ¿èŠ‚ç‚¹..."
    log_info "ä½¿ç”¨æŒ–çŸ¿å…¬é’¥: $MINING_PUBKEY"
    log_info "æ—¥å¿—å°†ä¿å­˜åˆ°: $LOG_FILE"
    
    # å¯åŠ¨èŠ‚ç‚¹å¹¶å°†è¾“å‡ºé‡å®šå‘åˆ°æ—¥å¿—æ–‡ä»¶
    nohup nockchain --mining-pubkey "${MINING_PUBKEY}" --mine > "$LOG_FILE" 2>&1 &
    local node_pid=$!
    
    sleep 3
    
    # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦æˆåŠŸå¯åŠ¨
    if kill -0 $node_pid 2>/dev/null; then
        log_info "èŠ‚ç‚¹å¯åŠ¨æˆåŠŸï¼è¿›ç¨‹ID: $node_pid"
        log_info "ä½¿ç”¨ 'æŸ¥çœ‹æ—¥å¿—' é€‰é¡¹ç›‘æ§èŠ‚ç‚¹çŠ¶æ€"
    else
        log_error "èŠ‚ç‚¹å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
        return 1
    fi
}

# åœæ­¢èŠ‚ç‚¹
stop_node() {
    log_info "åœæ­¢ Nockchain èŠ‚ç‚¹"
    
    if pgrep -f "nockchain" > /dev/null; then
        local pids=$(pgrep -f nockchain)
        log_info "æ‰¾åˆ° Nockchain è¿›ç¨‹: $pids"
        
        # ä¼˜é›…åœæ­¢
        pkill -TERM -f nockchain
        sleep 5
        
        # æ£€æŸ¥æ˜¯å¦è¿˜åœ¨è¿è¡Œ
        if pgrep -f "nockchain" > /dev/null; then
            log_warn "è¿›ç¨‹æœªæ­£å¸¸åœæ­¢ï¼Œå¼ºåˆ¶ç»ˆæ­¢..."
            pkill -KILL -f nockchain
            sleep 2
        fi
        
        if ! pgrep -f "nockchain" > /dev/null; then
            log_info "èŠ‚ç‚¹å·²åœæ­¢"
        else
            log_error "æ— æ³•åœæ­¢èŠ‚ç‚¹è¿›ç¨‹"
            return 1
        fi
    else
        log_info "æ²¡æœ‰æ‰¾åˆ°è¿è¡Œä¸­çš„ Nockchain è¿›ç¨‹"
    fi
}

# æŸ¥çœ‹æ—¥å¿—
view_logs() {
    log_info "æŸ¥çœ‹ Nockchain æ—¥å¿—"
    
    if [ -f "$LOG_FILE" ]; then
        echo
        log_info "=== æœ€è¿‘50è¡Œæ—¥å¿— ==="
        tail -n 50 "$LOG_FILE"
        echo
        log_info "=== å®æ—¶æ—¥å¿—ï¼ˆCtrl+C é€€å‡ºï¼‰==="
        tail -f "$LOG_FILE"
    else
        log_warn "æœªæ‰¾åˆ°æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
        log_info "å¦‚æœèŠ‚ç‚¹æ­£åœ¨è¿è¡Œï¼Œå¯èƒ½æ—¥å¿—ç›´æ¥è¾“å‡ºåˆ°ç»ˆç«¯"
        
        # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦åœ¨è¿è¡Œ
        if pgrep -f "nockchain" > /dev/null; then
            log_info "èŠ‚ç‚¹è¿›ç¨‹æ­£åœ¨è¿è¡Œï¼Œä½†æ²¡æœ‰æ—¥å¿—æ–‡ä»¶"
            log_info "å»ºè®®é‡å¯èŠ‚ç‚¹ä»¥ç”Ÿæˆæ—¥å¿—æ–‡ä»¶"
        fi
    fi
}

# æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€
show_status() {
    log_info "ç³»ç»ŸçŠ¶æ€æ£€æŸ¥"
    
    echo "=== ç¯å¢ƒæ£€æŸ¥ ==="
    echo "æ“ä½œç³»ç»Ÿ: $(uname -s) $(uname -r)"
    echo "Rustç‰ˆæœ¬: $(rustc --version 2>/dev/null || echo 'æœªå®‰è£…')"
    echo "Cargoç‰ˆæœ¬: $(cargo --version 2>/dev/null || echo 'æœªå®‰è£…')"
    echo "nockchain: $(command -v nockchain &>/dev/null && echo "å·²å®‰è£… ($(command -v nockchain))" || echo 'æœªå®‰è£…')"
    echo "nockchain-wallet: $(command -v nockchain-wallet &>/dev/null && echo "å·²å®‰è£… ($(command -v nockchain-wallet))" || echo 'æœªå®‰è£…')"
    echo "hoonc: $(command -v hoonc &>/dev/null && echo "å·²å®‰è£… ($(command -v hoonc))" || echo 'æœªå®‰è£…')"
    
    echo -e "\n=== ç³»ç»Ÿèµ„æº ==="
    echo "CPUæ ¸å¿ƒ: $(nproc)"
    echo "å†…å­˜: $(free -h | awk '/^Mem:/{print $2}') æ€»é‡, $(free -h | awk '/^Mem:/{print $7}') å¯ç”¨"
    echo "ç£ç›˜ç©ºé—´: $(df -h . | awk 'NR==2 {print $4}') å¯ç”¨"
    
    echo -e "\n=== é…ç½®æ–‡ä»¶ ==="
    if [ -f "$ENV_FILE" ]; then
        echo ".env æ–‡ä»¶: å­˜åœ¨"
        local current_pubkey=$(grep MINING_PUBKEY "$ENV_FILE" | cut -d'=' -f2)
        echo "å½“å‰æŒ–çŸ¿å…¬é’¥: $current_pubkey"
        
        # éªŒè¯å½“å‰å…¬é’¥æ ¼å¼
        if validate_mining_pubkey "$current_pubkey" 2>/dev/null; then
            echo "å…¬é’¥æ ¼å¼: âœ… æ­£ç¡®ï¼ˆ128ä½16è¿›åˆ¶ï¼‰"
        else
            echo "å…¬é’¥æ ¼å¼: âŒ é”™è¯¯ï¼ˆéœ€è¦128ä½16è¿›åˆ¶æ ¼å¼ï¼‰"
        fi
        
        echo "æ—¥å¿—çº§åˆ«: $(grep RUST_LOG "$ENV_FILE" | cut -d'=' -f2)"
    else
        echo ".env æ–‡ä»¶: ä¸å­˜åœ¨"
    fi
    
    echo -e "\n=== è¿›ç¨‹çŠ¶æ€ ==="
    if pgrep -f "nockchain" > /dev/null; then
        echo "Nockchain è¿›ç¨‹: è¿è¡Œä¸­"
        echo "è¿›ç¨‹ID: $(pgrep -f nockchain)"
        echo "è¿è¡Œæ—¶é—´: $(ps -o etime= -p $(pgrep -f nockchain) | tr -d ' ')"
        echo "å†…å­˜ä½¿ç”¨: $(ps -o rss= -p $(pgrep -f nockchain) | awk '{printf "%.2f MB\n", $1/1024}')"
    else
        echo "Nockchain è¿›ç¨‹: æœªè¿è¡Œ"
    fi
    
    echo -e "\n=== æ—¥å¿—æ–‡ä»¶ ==="
    if [ -f "$LOG_FILE" ]; then
        echo "æ—¥å¿—æ–‡ä»¶: å­˜åœ¨"
        echo "æ–‡ä»¶å¤§å°: $(du -h "$LOG_FILE" | cut -f1)"
        echo "æœ€åä¿®æ”¹: $(stat -c %y "$LOG_FILE" 2>/dev/null || stat -f %Sm "$LOG_FILE" 2>/dev/null)"
    else
        echo "æ—¥å¿—æ–‡ä»¶: ä¸å­˜åœ¨"
    fi
}

# æ¸…ç†å’Œé‡ç½®
cleanup_reset() {
    log_warn "æ¸…ç†å’Œé‡ç½® Nockchain"
    log_warn "è¿™å°†åˆ é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®å’Œé…ç½®ï¼"
    read -p "ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ(y/n): " -n 1 -r
    echo
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        # åœæ­¢èŠ‚ç‚¹
        stop_node
        
        # å¤‡ä»½é…ç½®
        if [ -f "$ENV_FILE" ]; then
            cp "$ENV_FILE" "${ENV_FILE}.cleanup_backup.$(date +%Y%m%d_%H%M%S)"
            log_info "é…ç½®æ–‡ä»¶å·²å¤‡ä»½"
        fi
        
        # æ¸…ç†æ—¥å¿—
        if [ -f "$LOG_FILE" ]; then
            rm -f "$LOG_FILE"
            log_info "æ—¥å¿—æ–‡ä»¶å·²åˆ é™¤"
        fi
        
        # æ¸…ç†æ„å»ºç›®å½•
        if [ -d "target" ]; then
            rm -rf target
            log_info "æ„å»ºç›®å½•å·²æ¸…ç†"
        fi
        
        log_info "æ¸…ç†å®Œæˆ"
    else
        log_info "å·²å–æ¶ˆæ¸…ç†æ“ä½œ"
    fi
}

# ä¸»èœå•
show_main_menu() {
    clear
    echo -e "${BLUE}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          Nockchain èŠ‚ç‚¹ç®¡ç†å·¥å…·            â•‘"
    echo "â•‘        ï¼ˆä¿®å¤æ”¹è¿›ç‰ˆ v2.0ï¼‰                 â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    echo
    echo "ğŸ“¦ å®‰è£…å’Œé…ç½®:"
    echo "  1. å®‰è£… Nockchain"
    echo "  2. ç”Ÿæˆæ–°çš„æŒ–çŸ¿å¯†é’¥"
    echo "  3. æ›´æ”¹æŒ–çŸ¿å…¬é’¥"
    echo
    echo "ğŸš€ èŠ‚ç‚¹æ“ä½œ:"
    echo "  4. å¯åŠ¨èŠ‚ç‚¹"
    echo "  5. åœæ­¢èŠ‚ç‚¹"
    echo "  6. é‡å¯èŠ‚ç‚¹"
    echo
    echo "ğŸ“Š ç›‘æ§å’Œç»´æŠ¤:"
    echo "  7. æŸ¥çœ‹æ—¥å¿—"
    echo "  8. ç³»ç»ŸçŠ¶æ€"
    echo "  9. æ¸…ç†é‡ç½®"
    echo
    echo "  0. é€€å‡º"
    echo
    echo -e "${YELLOW}æ³¨æ„ï¼šæŒ–çŸ¿å…¬é’¥å¿…é¡»æ˜¯128ä½16è¿›åˆ¶æ ¼å¼ï¼ˆ64ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ï¼‰${NC}"
    echo
}

# é‡å¯èŠ‚ç‚¹
restart_node() {
    log_info "é‡å¯ Nockchain èŠ‚ç‚¹"
    stop_node
    sleep 2
    start_node
}

# ä¸»ç¨‹åº
main() {
    # æ£€æŸ¥æ˜¯å¦åœ¨æ­£ç¡®çš„ç›®å½•
    if [ ! -f "Cargo.toml" ] && [ ! -f "Makefile" ]; then
        log_error "è¯·åœ¨ nockchain é¡¹ç›®æ ¹ç›®å½•ä¸‹è¿è¡Œæ­¤è„šæœ¬"
        log_error "åº”è¯¥åŒ…å« Cargo.toml æˆ– Makefile æ–‡ä»¶"
        exit 1
    fi
    
    # è®¾ç½® PATH
    export PATH="$HOME/.cargo/bin:$PATH"
    
    while true; do
        show_main_menu
        read -p "è¯·é€‰æ‹©æ“ä½œ (0-9): " choice
        
        case $choice in
            1)
                install_nockchain
                read -p "æŒ‰ä»»æ„é”®ç»§ç»­..."
                ;;
            2)
                generate_mining_key
                read -p "æŒ‰ä»»æ„é”®ç»§ç»­..."
                ;;
            3)
                change_mining_key
                read -p "æŒ‰ä»»æ„é”®ç»§ç»­..."
                ;;
            4)
                start_node
                read -p "æŒ‰ä»»æ„é”®ç»§ç»­..."
                ;;
            5)
                stop_node
                read -p "æŒ‰ä»»æ„é”®ç»§ç»­..."
                ;;
            6)
                restart_node
                read -p "æŒ‰ä»»æ„é”®ç»§ç»­..."
                ;;
            7)
                view_logs
                read -p "æŒ‰ä»»æ„é”®ç»§ç»­..."
                ;;
            8)
                show_status
                read -p "æŒ‰ä»»æ„é”®ç»§ç»­..."
                ;;
            9)
                cleanup_reset
                read -p "æŒ‰ä»»æ„é”®ç»§ç»­..."
                ;;
            0)
                log_info "æ„Ÿè°¢ä½¿ç”¨ Nockchain èŠ‚ç‚¹ç®¡ç†å·¥å…·ï¼"
                exit 0
                ;;
            *)
                log_error "æ— æ•ˆé€‰æ‹©ï¼Œè¯·é‡è¯•"
                sleep 1
                ;;
        esac
    done
}

# è„šæœ¬å…¥å£ç‚¹
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
