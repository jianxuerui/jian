#!/bin/bash
# ==============================================================================
# Nockchain æŒ–çŸ¿åŠ©æ‰‹ (K2 å¢å¼ºèåˆç‰ˆ v4.1 - æ™ºèƒ½å®¹é”™)
# ------------------------------------------------------------------------------
# HOW TO RUN THIS SCRIPT (é‡è¦è¿è¡Œè¯´æ˜):
# 1. ä¿å­˜æ­¤è„šæœ¬: ä¾‹å¦‚ï¼Œä¿å­˜ä¸º `nock.sh`
# 2. æˆäºˆæ‰§è¡Œæƒé™: chmod +x nock.sh
# 3. (å¯é€‰ä½†æ¨è) ä¿®å¤æ ¼å¼é—®é¢˜: sudo apt-get install -y dos2unix && dos2unix nock.sh
# 4. åœ¨ screen/tmux ä¸­è¿è¡Œä»¥é˜²æ‰çº¿:
#    screen -S nck
#    ./nock.sh
# ==============================================================================
# ä½œè€…: K2 èŠ‚ç‚¹æ•™ç¨‹åˆ†äº«
# Telegram: https://t.me/+EaCiFDOghoM3Yzll
# Twitter:  https://x.com/BtcK241918
# ==============================================================================

# è„šæœ¬å¥å£®æ€§è®¾ç½®
set -euo pipefail

# --- å…¨å±€å¸¸é‡å’Œé¢œè‰²å®šä¹‰ ---
RESET='\033[0m'
BOLD='\033[1m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'

NCK_DIR="$HOME/nockchain"
ENV_FILE="$NCK_DIR/.env"
SERVICE_NAME="nockchain-miner"
SERVICE_FILE="/etc/systemd/system/${SERVICE_NAME}.service"
HOON_KERNEL_PATH="$NCK_DIR/pkg/sys/hoon"

# --- å¢å¼ºç‰ˆ Hoon å†…æ ¸ (Base64 ç¼–ç ) ---
ENHANCED_HOON_KERNEL_BASE64="OjoKOjo6OAEgICAgL3N5cy9ob29uICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOjoKICAPOjoiOjoAPToAPAE9PCAgcmlkZQo9PiAgJTEzOSAAPg==CiAgOjo6OgAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6OgogIA86OiI6OiAPToAPAE8PACAwOiB2ZXJzaW9uIHN0dWIgICAgICAgICAgICAgICAgICAgOjoKICApOjo/Pjw6Ojo7PDs/Ojo+Pjs6OiAgaG9vbi12ZXJzaW9uICA+"

# --- æ ¸å¿ƒå‡½æ•° ---

function show_banner() {
  clear
  echo -e "${BOLD}${BLUE}"
  echo "======================================================"
  echo "  Nockchain æŒ–çŸ¿åŠ©æ‰‹ (K2 å¢å¼ºèåˆç‰ˆ v4.1)"
  echo "======================================================"
  echo -e "${RESET}"
  echo -e "âœ¨ ${BOLD}${PURPLE}å†…æ ¸å¢å¼º: å·²æ³¨å…¥ v139 ä¼˜åŒ–ç‰ˆ Hoon å†…æ ¸ï¼${RESET}"
  echo -e "ğŸ§  ${BOLD}${GREEN}æ™ºèƒ½ç¯å¢ƒæ„ŸçŸ¥: è‡ªåŠ¨æ£€æŸ¥å†…å­˜å¹¶å¯åˆ›å»ºSwapï¼${RESET}"
  echo -e "ğŸ›¡ï¸ ${BOLD}${CYAN}æ™ºèƒ½å®¹é”™: å®‰è£…å¤±è´¥æ—¶å°†æä¾›æ˜ç¡®çš„é”™è¯¯æç¤ºï¼${RESET}"
  echo "ğŸš€ ${BOLD}ä½¿ç”¨ Systemd æœåŠ¡ç®¡ç†ï¼Œç¡®ä¿ç¨³å®šè¿è¡Œã€‚${RESET}"
  echo "ğŸ“Œ ä½œè€…: K2 èŠ‚ç‚¹æ•™ç¨‹åˆ†äº«"
  echo "ğŸ”— Telegram: https://t.me/+EaCiFDOghoM3Yzll"
  echo "ğŸ¦ Twitter:  https://x.com/BtcK241918"
  echo "------------------------------------------------------"
  echo ""
}

function check_command() {
    if ! command -v "$1" &>/dev/null; then
        echo -e "${RED}[-] é”™è¯¯: å‘½ä»¤ '$1' æœªæ‰¾åˆ°ã€‚è¯·ç¡®ä¿å·²å®‰è£…ã€‚${RESET}" >&2
        return 1
    fi
}

function get_num_cores() {
    nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 4
}

function pause_and_return() {
  echo ""
  read -r -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..." -s -n 1
  echo
}

# æ™ºèƒ½æ£€æŸ¥å¹¶æç¤ºä½¿ç”¨ screen/tmux
function preflight_check() {
    if [[ -z "${STY}" && -z "${TMUX}" ]]; then
        echo -e "${BOLD}${YELLOW}*** è­¦å‘Šï¼šæ‚¨å½“å‰ä¸åœ¨ screen æˆ– tmux ä¼šè¯ä¸­ï¼***${RESET}"
        echo -e "ä¸ºé˜²æ­¢SSHæ‰çº¿å¯¼è‡´å®‰è£…ä¸­æ–­ï¼Œå¼ºçƒˆå»ºè®®æ‚¨é€€å‡ºè„šæœ¬ï¼Œç„¶åæŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š"
        echo -e "   1. è¿è¡Œ: ${GREEN}screen -S nck${RESET}"
        echo -e "   2. åœ¨æ–°ä¼šè¯ä¸­ï¼Œé‡æ–°è¿è¡Œæœ¬è„šæœ¬: ${GREEN}./$(basename "$0")${RESET}"
        echo -e "   (å¦‚æœæ‰çº¿ï¼Œé‡è¿åè¿è¡Œ ${GREEN}screen -r nck${RESET} å³å¯æ¢å¤)"
        echo ""
        read -r -p "æ‚¨ç¡®å®šè¦åœ¨æ²¡æœ‰ screen/tmux çš„æƒ…å†µä¸‹ç»§ç»­å—ï¼Ÿ(å¯èƒ½å¯¼è‡´å®‰è£…å¤±è´¥) [y/N]: " confirm
        if [[ ! "$confirm" =~ ^[yY](es)?$ ]]; then
            echo -e "${RED}æ“ä½œå·²å–æ¶ˆã€‚${RESET}"
            exit 1
        fi
    else
        echo -e "${GREEN}[+] æ£€æµ‹åˆ°æ‚¨æ­£åœ¨ screen æˆ– tmux ä¼šè¯ä¸­ï¼Œéå¸¸æ£’ï¼å®‰è£…å°†ç»§ç»­ã€‚${RESET}"
    fi
    sleep 2
}

# æ£€æŸ¥å¹¶åˆ›å»º Swap è™šæ‹Ÿå†…å­˜
function check_and_create_swap() {
    echo -e "${BLUE}[*] æ­£åœ¨æ£€æŸ¥ç³»ç»Ÿå†…å­˜å’ŒSwapç©ºé—´...${RESET}"
    local ram_mb=$(free -m | awk '/^Mem:/{print $2}')
    local swap_mb=$(free -m | awk '/^Swap:/{print $2}')
    local total_mem_mb=$((ram_mb + swap_mb))
    local min_mem_mb=3800 # æ¨èè‡³å°‘æœ‰æ¥è¿‘4GBçš„æ€»å†…å­˜ï¼ˆRAM+Swapï¼‰ç”¨äºç¼–è¯‘

    if [ "$total_mem_mb" -lt "$min_mem_mb" ]; then
        echo -e "${YELLOW}[!] è­¦å‘Š: ç³»ç»Ÿæ€»å†…å­˜ (RAM + Swap) å°äº ${min_mem_mb}MBã€‚${RESET}"
        echo -e "ç¼–è¯‘ Nockchain éœ€è¦å¤§é‡å†…å­˜ï¼Œå¯èƒ½ä¼šå› å†…å­˜ä¸è¶³è€Œå¤±è´¥ã€‚"
        read -r -p "æ˜¯å¦éœ€è¦è‡ªåŠ¨åˆ›å»º 4GB çš„ Swap è™šæ‹Ÿå†…å­˜æ–‡ä»¶? [Y/n]: " choice
        if [[ -z "$choice" || "$choice" =~ ^[yY]$ ]]; then
            echo -e "${BLUE}[*] æ­£åœ¨åˆ›å»º 4GB Swap æ–‡ä»¶... è¿™å¯èƒ½éœ€è¦ä¸€ç‚¹æ—¶é—´ã€‚${RESET}"
            sudo fallocate -l 4G /swapfile || { echo -e "${RED}åˆ›å»ºSwapæ–‡ä»¶å¤±è´¥ã€‚${RESET}"; return 1; }
            sudo chmod 600 /swapfile
            sudo mkswap /swapfile
            sudo swapon /swapfile
            # ç¡®ä¿é‡å¯åä¹Ÿç”Ÿæ•ˆ
            if ! grep -q '/swapfile' /etc/fstab; then
                echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
            fi
            echo -e "${GREEN}[+] 4GB Swap å·²æˆåŠŸåˆ›å»ºå¹¶æ¿€æ´»ï¼${RESET}"
            free -h
        else
            echo -e "${YELLOW}[!] æ‚¨å·²é€‰æ‹©è·³è¿‡åˆ›å»ºSwapã€‚è¯·æ³¨æ„ï¼Œç¼–è¯‘è¿‡ç¨‹å¯èƒ½å¤±è´¥ã€‚${RESET}"
        fi
    else
        echo -e "${GREEN}[+] ç³»ç»Ÿå†…å­˜å……è¶³ï¼Œæ— éœ€åˆ›å»ºSwapã€‚${RESET}"
    fi
    sleep 2
}

# --- èœå•åŠŸèƒ½å®ç° ---

# 1. ä¸€é”®å®‰è£…
function install_all() {
    show_banner
    preflight_check
    check_and_create_swap

    # ==================== MODIFICATION START ====================
    # ä½¿ç”¨å­ shell æ¥éš”ç¦»ç¯å¢ƒå’Œé”™è¯¯å¤„ç†ã€‚
    # è¿™æ ·å³ä½¿å®‰è£…å¤±è´¥ï¼Œä¸»è„šæœ¬ä¹Ÿä¸ä¼šå›  `set -e` è€Œé€€å‡ºï¼Œ
    # è€Œæ˜¯å¯ä»¥æ•è·é”™è¯¯å¹¶ç»™ç”¨æˆ·æ¸…æ™°çš„æç¤ºã€‚
    (
    set -e # åœ¨è¿™ä¸ªä»£ç å—ä¸­ï¼Œä»»ä½•é”™è¯¯éƒ½ä¼šå¯¼è‡´å®ƒç«‹å³é€€å‡º

    echo -e "${BLUE}--- æ­¥éª¤ 1/5: å®‰è£…ç³»ç»Ÿä¾èµ– ---${RESET}"
    sudo apt-get update
    sudo apt-get install -y clang llvm-dev libclang-dev pkg-config libssl-dev build-essential cmake git make curl

    echo -e "${BLUE}--- æ­¥éª¤ 2/5: å®‰è£… Rust ---${RESET}"
    if ! command -v cargo &>/dev/null; then
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        # ç«‹å³å°† cargo æ·»åŠ åˆ° PATHï¼Œä»¥ä¾¿åç»­æ­¥éª¤ä½¿ç”¨
        export PATH="$HOME/.cargo/bin:$PATH"
    else
        echo -e "${YELLOW}[!] Rust å·²å®‰è£…ï¼Œè·³è¿‡ã€‚${RESET}"
    fi
    # ç¡®ä¿cargoè·¯å¾„åœ¨å½“å‰ä¼šè¯ä¸­ç”Ÿæ•ˆ
    export PATH="$HOME/.cargo/bin:$PATH"

    echo -e "${BLUE}--- æ­¥éª¤ 3/5: è·å–æˆ–æ›´æ–° Nockchain ä»“åº“ ---${RESET}"
    if [ -d "$NCK_DIR" ]; then
        echo -e "${BLUE}[*] ç›®å½•å­˜åœ¨ï¼Œæ­£åœ¨æ›´æ–°...${RESET}"
        cd "$NCK_DIR" && git pull
    else
        echo -e "${BLUE}[*] æ­£åœ¨å…‹éš†ä»“åº“...${RESET}"
        git clone https://github.com/zorp-corp/nockchain "$NCK_DIR"
        cd "$NCK_DIR"
    fi

    echo -e "${PURPLE}--- æ­¥éª¤ 4/5: æ³¨å…¥ K2 å¢å¼ºç‰ˆ Hoon å†…æ ¸ (v139) ---${RESET}"
    if ! check_command base64; then
        echo -e "${RED}[-] é”™è¯¯: ç¼ºå°‘ 'base64' å‘½ä»¤ã€‚è¯·å®‰è£… coreutilsã€‚${RESET}"
        exit 1
    fi

    echo "$ENHANCED_HOON_KERNEL_BASE64" | base64 --decode > "$HOON_KERNEL_PATH"
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}[+] å¢å¼ºç‰ˆ Hoon å†…æ ¸å·²æˆåŠŸæ³¨å…¥ã€‚${RESET}"
    else
        echo -e "${RED}[-] é”™è¯¯: æ³¨å…¥å¢å¼ºç‰ˆ Hoon å†…æ ¸å¤±è´¥ã€‚${RESET}"
        exit 1
    fi

    echo -e "${BLUE}--- æ­¥éª¤ 5/5: ç¼–è¯‘å¹¶å®‰è£… Nockchain ---${RESET}"
    export RUSTFLAGS="-C target-cpu=native -C opt-level=3"
    export CARGO_PROFILE_RELEASE_LTO="true"
    local num_cores=$(get_num_cores)
    echo -e "[*] ä½¿ç”¨ ${num_cores} ä¸ªCPUæ ¸å¿ƒè¿›è¡Œç¼–è¯‘..."
    # ç¼–è¯‘å¤±è´¥æ—¶ï¼Œä¸‹é¢çš„å‘½ä»¤ä¼šå› ä¸º `set -e` è‡ªåŠ¨é€€å‡ºå­ shell
    make -j"$num_cores" install
    )

    # æ•è·ä¸Šé¢å­ shell çš„é€€å‡ºç 
    local exit_code=$?

    if [ "$exit_code" -ne 0 ]; then
        echo -e "${RED}=======================================================${RESET}"
        echo -e "${BOLD}${RED}[-] å®‰è£…æˆ–æ„å»ºè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼è¯·å‘ä¸Šæ»šåŠ¨æŸ¥çœ‹å…·ä½“æ—¥å¿—ã€‚${RESET}"
        echo -e "${YELLOW}å¸¸è§åŸå› åŒ…æ‹¬: æƒé™ä¸è¶³(sudo)ã€ç½‘ç»œé—®é¢˜ã€å†…å­˜ä¸è¶³ç­‰ã€‚${RESET}"
        echo -e "${RED}=======================================================${RESET}"
    else
        echo -e "${GREEN}===============================================${RESET}"
        echo -e "${BOLD}${GREEN}[+] Nockchain å¢å¼ºç‰ˆå·²æˆåŠŸå®‰è£…ï¼${RESET}"
        echo -e "${YELLOW}[!] ä¸‹ä¸€æ­¥: è¯·è¿è¡Œé€‰é¡¹ 2 è®¾ç½®æ‚¨çš„æŒ–çŸ¿å…¬é’¥ã€‚${RESET}"
        echo -e "${GREEN}===============================================${RESET}"
    fi
    # ===================== MODIFICATION END =====================
    pause_and_return
}

# 2. è®¾ç½®å…¬é’¥
function set_pubkey() {
    echo -e "${BLUE}[*] è®¾ç½® MINING_PUBKEY åˆ° .env æ–‡ä»¶...${RESET}"
    if [ ! -d "$NCK_DIR" ]; then echo -e "${RED}é¡¹ç›®ç›®å½•ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œå®‰è£…ã€‚${RESET}"; pause_and_return; return; fi

    read -r -p "è¯·è¾“å…¥æ‚¨çš„æŒ–çŸ¿å…¬é’¥ (MINING_PUBKEY): " pubkey
    if ! [[ "$pubkey" =~ ^[0-9a-fA-F]{128}$ ]]; then
        echo -e "${RED}[-] é”™è¯¯: å…¬é’¥æ ¼å¼ä¸æ­£ç¡®ã€‚å®ƒåº”è¯¥æ˜¯128ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ã€‚${RESET}"
        pause_and_return
        return
    fi

    if [ ! -f "$ENV_FILE" ]; then
        echo -e "${BLUE}[*] .env æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†ä» .env_example åˆ›å»ºã€‚${RESET}"
        cp "$NCK_DIR/.env_example" "$ENV_FILE"
    fi

    local num_cores=$(get_num_cores)
    # ä½¿ç”¨ sed æ›´æ–°å…¬é’¥ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åœ¨æ–‡ä»¶æœ«å°¾è¿½åŠ 
    if grep -q '^MINING_PUBKEY=' "$ENV_FILE"; then
        sed -i -e "/^MINING_PUBKEY=/c\MINING_PUBKEY=$pubkey" "$ENV_FILE"
    else
        echo "MINING_PUBKEY=$pubkey" >> "$ENV_FILE"
    fi
    # è‡ªåŠ¨è®¾ç½®çº¿ç¨‹æ•°ï¼Œå¦‚æœä¸å­˜åœ¨çš„è¯
    if ! grep -q '^MINER_THREADS=' "$ENV_FILE"; then
        echo "MINER_THREADS=$num_cores" >> "$ENV_FILE"
    fi

    echo -e "${GREEN}[+] æŒ–çŸ¿é…ç½®å·²æ›´æ–°åˆ° $ENV_FILEã€‚${RESET}"
    echo -e "${YELLOW}[!] å¦‚æœæ‚¨å·²å¯åŠ¨æŒ–çŸ¿æœåŠ¡ï¼Œè¯·é‡å¯ (é€‰é¡¹ 3) ä»¥ä½¿æ›´æ”¹ç”Ÿæ•ˆã€‚${RESET}"
    pause_and_return
}

# 3. å®‰è£…å¹¶å¯åŠ¨èŠ‚ç‚¹ (systemd)
function start_node() {
    echo -e "${BLUE}[*] å®‰è£…å¹¶å¯åŠ¨ Nockchain æŒ–çŸ¿æœåŠ¡...${RESET}"
    if ! check_command systemctl; then
        echo -e "${RED}[-] é”™è¯¯: æ‚¨çš„ç³»ç»Ÿä¸æ”¯æŒ systemdã€‚æ­¤åŠŸèƒ½ä¸å¯ç”¨ã€‚${RESET}"
        pause_and_return
        return
    fi
    
    if [ ! -f "$ENV_FILE" ] || ! grep -q "MINING_PUBKEY" "$ENV_FILE"; then
        echo -e "${RED}[-] é”™è¯¯: MINING_PUBKEY æœªè®¾ç½®! è¯·å…ˆè¿è¡Œé€‰é¡¹ 2ã€‚${RESET}"
        pause_and_return
        return
    fi
    
    cd "$NCK_DIR"
    
    echo -e "${BLUE}[*] æ­£åœ¨åˆ›å»º systemd æœåŠ¡...${RESET}"
    sudo bash -c "cat <<EOF > $SERVICE_FILE
[Unit]
Description=$SERVICE_NAME service
After=network-online.target

[Service]
User=$USER
Group=$(id -gn "$USER")
WorkingDirectory=$NCK_DIR
EnvironmentFile=$ENV_FILE
ExecStart=$HOME/.cargo/bin/nockchain
Restart=on-failure
RestartSec=10
LimitNOFILE=65536
Nice=-5

[Install]
WantedBy=multi-user.target
EOF"

    echo -e "${BLUE}[*] æ­£åœ¨é‡è½½å¹¶å¯åŠ¨æœåŠ¡...${RESET}"
    sudo systemctl daemon-reload
    sudo systemctl enable "$SERVICE_NAME"
    sudo systemctl restart "$SERVICE_NAME" # ä½¿ç”¨ restart ç¡®ä¿æ€»æ˜¯æœ€æ–°çš„é…ç½®

    echo -e "${GREEN}===============================================${RESET}"
    echo -e "${GREEN}[+] Nockchain æŒ–çŸ¿æœåŠ¡å·²æˆåŠŸå¯åŠ¨ï¼${RESET}"
    echo -e "${YELLOW}    ä½¿ç”¨é€‰é¡¹ 5 æŸ¥çœ‹å®æ—¶æ—¥å¿—ã€‚${RESET}"
    echo -e "${GREEN}===============================================${RESET}"
    pause_and_return
}

# 4. åœæ­¢èŠ‚ç‚¹ (systemd)
function stop_node() {
    echo -e "${BLUE}[*] åœæ­¢ Nockchain æŒ–çŸ¿æœåŠ¡...${RESET}"
    if ! check_command systemctl || [ ! -f "$SERVICE_FILE" ]; then
        echo -e "${YELLOW}[!] Systemd æœåŠ¡æœªå®‰è£…æˆ–ä¸å¯ç”¨ã€‚${RESET}"
        pause_and_return
        return
    fi
    sudo systemctl stop "$SERVICE_NAME"
    echo -e "${GREEN}[+] æœåŠ¡å·²åœæ­¢ã€‚${RESET}"
    pause_and_return
}

# 5. æŸ¥çœ‹æ—¥å¿— (systemd)
function view_logs() {
    echo -e "${BLUE}[*] æŸ¥çœ‹å®æ—¶æŒ–çŸ¿æ—¥å¿—...${RESET}"
    if ! check_command journalctl || [ ! -f "$SERVICE_FILE" ]; then
        echo -e "${YELLOW}[!] Systemd æœåŠ¡æœªå®‰è£…æˆ–ä¸å¯ç”¨ã€‚${RESET}"
        pause_and_return
        return
    fi
    echo -e "${YELLOW}[!] æŒ‰ Ctrl+C é€€å‡ºæ—¥å¿—æŸ¥çœ‹ã€‚${RESET}"
    journalctl -u "$SERVICE_NAME" -f --no-pager
    pause_and_return
}

# ========= ä¸»èœå• =========
function main_menu() {
  show_banner
  echo -e "${BOLD}${GREEN}--- Nockchain æŒ–çŸ¿åŠ©æ‰‹ ---${RESET}"
  echo "è¯·é€‰æ‹©æ“ä½œ:"
  echo ""
  echo -e "  ${BOLD}1) ä¸€é”®å®‰è£…å¢å¼ºç‰ˆ Nockchain${RESET} ${YELLOW}(è‡ªåŠ¨ç¯å¢ƒæ£€æŸ¥, æ™ºèƒ½å®¹é”™)${RESET}"
  echo -e "  ${BOLD}2) è®¾ç½®æŒ–çŸ¿å…¬é’¥ (MINING_PUBKEY)${RESET}"
  echo ""
  echo "  ${GREEN}3) å®‰è£…å¹¶å¯åŠ¨/é‡å¯æŒ–çŸ¿æœåŠ¡ (Systemd)${RESET}"
  echo "  ${RED}4) åœæ­¢æŒ–çŸ¿æœåŠ¡ (Systemd)${RESET}"
  echo "  ${YELLOW}5) æŸ¥çœ‹å®æ—¶æŒ–çŸ¿æ—¥å¿— (Systemd)${RESET}"
  echo ""
  echo -e "  ${CYAN}0) é€€å‡ºè„šæœ¬${RESET}"
  echo ""
  read -r -p "è¯·è¾“å…¥ç¼–å·: " choice

  case "$choice" in
    1) install_all ;;
    2) set_pubkey ;;
    3) start_node ;;
    4) stop_node ;;
    5) view_logs ;;
    0) echo "é€€å‡ºè„šæœ¬."; exit 0 ;;
    *) echo -e "${RED}[-] æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚${RESET}"; pause_and_return ;;
  esac
}

# ========= è„šæœ¬å…¥å£ =========
while true; do
    main_menu
done

exit 0
