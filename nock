#!/bin/bash

# ========= è‰²å½©å®šä¹‰ =========
RESET='\033[0m'
BOLD='\033[1m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'

# ========= é¡¹ç›®è·¯å¾„ =========
NCK_DIR="$HOME/nockchain"
ENV_FILE="$NCK_DIR/.env"

# ========= æ¨ªå¹… =========
function show_banner() {
  clear
  echo -e "${BOLD}${BLUE}"
  echo "==============================================="
  echo "         Nockchain æŒ–çŸ¿ä¼˜åŒ–åŠ©æ‰‹ v2.0"
  echo "==============================================="
  echo -e "${RESET}"
  echo "ğŸ“Œ ä½œè€…: K2 èŠ‚ç‚¹æ•™ç¨‹åˆ†äº«"
  echo "ğŸ”— Telegram: https://t.me/+EaCiFDOghoM3Yzll"
  echo "ğŸ¦ Twitter:  https://x.com/BtcK241918"
  echo "âš¡ ä¼˜åŒ–ç‰ˆæœ¬: ç¼–è¯‘ä¼˜åŒ– + æ€§èƒ½è°ƒä¼˜"
  echo "-----------------------------------------------"
  echo ""
}

function cd_nck_dir() {
  if [ -d "$NCK_DIR" ]; then
    cd "$NCK_DIR" || exit 1
  else
    echo -e "${RED}[-] é¡¹ç›®ç›®å½•ä¸å­˜åœ¨: $NCK_DIR${RESET}"
    exit 1
  fi
}

function optimize_system() {
  echo -e "${YELLOW}[*] åº”ç”¨ç³»ç»Ÿçº§æ€§èƒ½ä¼˜åŒ–...${RESET}"
  
  # CPUæ€§èƒ½æ¨¡å¼
  for gov in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor 2>/dev/null
  do
    if [ -w "$gov" ]; then
      echo performance | sudo tee "$gov" >/dev/null 2>&1
    fi
  done
  
  # ç½‘ç»œä¼˜åŒ–
  sudo sysctl -w net.core.rmem_max=16777216 >/dev/null 2>&1
  sudo sysctl -w net.core.wmem_max=16777216 >/dev/null 2>&1
  
  echo -e "${GREEN}[+] ç³»ç»Ÿä¼˜åŒ–å®Œæˆ${RESET}"
}

function setup_all() {
  echo -e "[*] å¼€å§‹ä¼˜åŒ–å®‰è£…æµç¨‹..."
  
  # ç³»ç»Ÿä¼˜åŒ–
  optimize_system
  
  echo -e "[*] å®‰è£…ç³»ç»Ÿä¾èµ–..."
  sudo apt update -qq
  sudo apt install -y clang llvm-dev libclang-dev pkg-config libssl-dev build-essential cmake curl git make screen htop

  echo -e "[*] å®‰è£… Rust å·¥å…·é“¾..."
  if ! command -v cargo &>/dev/null; then
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    source "$HOME/.cargo/env"
  fi

  RC_FILE="$HOME/.bashrc"
  [[ "$SHELL" == *"zsh"* ]] && RC_FILE="$HOME/.zshrc"
  if ! grep -q 'export PATH="$HOME/.cargo/bin:$PATH"' "$RC_FILE"; then
    echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> "$RC_FILE"
  fi
  export PATH="$HOME/.cargo/bin:$PATH"

  echo -e "[*] è·å–ä»“åº“..."
  if [ -d "$NCK_DIR" ]; then
    cd "$NCK_DIR" && git pull
  else
    git clone https://github.com/zorp-corp/nockchain "$NCK_DIR"
  fi

  cd_nck_dir

  echo -e "[*] è®¾ç½®ç¯å¢ƒé…ç½®..."
  cp -n .env_example "$ENV_FILE"

  echo -e "[*] å®‰è£… hoonc..."
  make install-hoonc || { echo -e "${RED}[-] install-hoonc å¤±è´¥${RESET}"; exit 1; }

  echo -e "[*] å¼€å§‹ä¼˜åŒ–ç¼–è¯‘ Nockchain..."
  # é«˜æ€§èƒ½ç¼–è¯‘ä¼˜åŒ–è®¾ç½®
  export RUSTFLAGS="-C target-cpu=native -C opt-level=3 -C codegen-units=1 -C lto=fat"
  export CARGO_PROFILE_RELEASE_LTO=true
  export CARGO_PROFILE_RELEASE_CODEGEN_UNITS=1
  export CARGO_PROFILE_RELEASE_PANIC="abort"
  
  make build || { echo -e "${RED}[-] build å¤±è´¥${RESET}"; exit 1; }

  echo -e "[*] å®‰è£…é’±åŒ…ç»„ä»¶..."
  make install-nockchain-wallet || { echo -e "${RED}[-] install-nockchain-wallet å¤±è´¥${RESET}"; exit 1; }

  echo -e "[*] å®‰è£…èŠ‚ç‚¹ç»„ä»¶..."
  make install-nockchain || { echo -e "${RED}[-] install-nockchain å¤±è´¥${RESET}"; exit 1; }

  echo -e "${GREEN}[+] ä¼˜åŒ–å®‰è£…å®Œæˆï¼${RESET}"
  pause_and_return
}

function generate_wallet() {
  echo -e "[*] ç”Ÿæˆé’±åŒ…..."
  cd_nck_dir
  ./target/release/nockchain-wallet keygen
  echo -e "${YELLOW}[!] é’±åŒ…ç”Ÿæˆå®Œæˆï¼Œè¯·å¤åˆ¶ä¸Šæ–¹å…¬é’¥åˆ°ä¸‹ä¸€æ­¥è®¾ç½®ä¸­${RESET}"
  echo -e "${BLUE}[i] å…¬é’¥æ ¼å¼ä¸º128ä½16è¿›åˆ¶å­—ç¬¦ä¸²${RESET}"
  pause_and_return
}

function validate_pubkey() {
  local pubkey="$1"
  
  # æ£€æŸ¥é•¿åº¦æ˜¯å¦ä¸º128ä½
  if [ ${#pubkey} -ne 128 ]; then
    echo -e "${RED}[-] å…¬é’¥é•¿åº¦é”™è¯¯ï¼åº”ä¸º128ä½ï¼Œå½“å‰ä¸º${#pubkey}ä½${RESET}"
    return 1
  fi
  
  # æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„16è¿›åˆ¶å­—ç¬¦
  if [[ ! "$pubkey" =~ ^[0-9a-fA-F]{128}$ ]]; then
    echo -e "${RED}[-] å…¬é’¥æ ¼å¼é”™è¯¯ï¼åªèƒ½åŒ…å«0-9å’Œa-få­—ç¬¦${RESET}"
    return 1
  fi
  
  return 0
}

function set_pubkey_env() {
  echo -e "[*] è®¾ç½® MINING_PUBKEY åˆ° .env..."
  cd_nck_dir

  echo -e "${BLUE}[i] å…¬é’¥æ ¼å¼è¦æ±‚ï¼š128ä½16è¿›åˆ¶å­—ç¬¦ä¸²${RESET}"
  echo -e "${BLUE}[i] ç¤ºä¾‹æ ¼å¼ï¼šd24c0c53d1162325eba695f32b7194f4c9b2943441a3162837922d36f3325c341ce049e7b3992080a9603e91147e4529f79261a355e16570c975a6c0e81716e3${RESET}"
  echo ""
  
  while true; do
    read -p "è¯·è¾“å…¥å…¬é’¥ (MINING_PUBKEY): " pubkey
    
    if [ -z "$pubkey" ]; then
      echo -e "${RED}[-] å…¬é’¥ä¸èƒ½ä¸ºç©º${RESET}"
      continue
    fi
    
    # å»é™¤å¯èƒ½çš„ç©ºæ ¼
    pubkey=$(echo "$pubkey" | tr -d ' ')
    
    # éªŒè¯å…¬é’¥æ ¼å¼
    if validate_pubkey "$pubkey"; then
      # è½¬æ¢ä¸ºå°å†™
      pubkey=$(echo "$pubkey" | tr '[:upper:]' '[:lower:]')
      
      # å†™å…¥ç¯å¢ƒæ–‡ä»¶
      sed -i '/^MINING_PUBKEY=/d' "$ENV_FILE"
      echo "MINING_PUBKEY=$pubkey" >> "$ENV_FILE"
      
      echo -e "${GREEN}[+] å…¬é’¥æ ¼å¼éªŒè¯é€šè¿‡ï¼Œå·²å†™å…¥ .env æ–‡ä»¶${RESET}"
      echo -e "${GREEN}[+] å…¬é’¥: $pubkey${RESET}"
      break
    else
      echo -e "${YELLOW}[!] è¯·é‡æ–°è¾“å…¥æ­£ç¡®æ ¼å¼çš„å…¬é’¥${RESET}"
    fi
  done
  
  pause_and_return
}

function export_keys() {
  echo -e "[*] å¯¼å‡ºé’±åŒ…å¯†é’¥..."
  cd_nck_dir
  ./target/release/nockchain-wallet export-keys
  echo -e "${GREEN}[+] å¯†é’¥å·²å¯¼å‡ºåˆ° keys.export${RESET}"
  pause_and_return
}

function import_keys() {
  echo -e "[*] å¯¼å…¥é’±åŒ…å¯†é’¥..."
  cd_nck_dir
  read -p "[?] è¯·è¾“å…¥å¯†é’¥æ–‡ä»¶è·¯å¾„ (é»˜è®¤: ./keys.export): " keyfile
  keyfile=${keyfile:-"./keys.export"}
  ./target/release/nockchain-wallet import-keys --input "$keyfile"
  echo -e "${GREEN}[+] å¯†é’¥å·²å¯¼å…¥${RESET}"
  pause_and_return
}

function start_node() {
  echo -e "[*] å¯åŠ¨ä¼˜åŒ–èŠ‚ç‚¹ (screen)..."
  cd_nck_dir
  source "$ENV_FILE"

  # æ£€æŸ¥æ˜¯å¦å·²è®¾ç½®å…¬é’¥
  if [ -z "$MINING_PUBKEY" ]; then
    echo -e "${RED}[-] æœªè®¾ç½® MINING_PUBKEYï¼Œè¯·å…ˆè®¾ç½®æŒ–çŸ¿å…¬é’¥${RESET}"
    pause_and_return
    return
  fi

  chmod +x ./scripts/run_nockchain_miner.sh

  if screen -list | grep -qw "nockchain"; then
    echo "[*] å…³é—­æ—§çš„ screen ä¼šè¯..."
    screen -S nockchain -X quit
    sleep 2
  fi

  # ä½¿ç”¨é«˜ä¼˜å…ˆçº§å¯åŠ¨
  screen -dmS nockchain bash -c "cd $NCK_DIR && nice -n -10 ./scripts/run_nockchain_miner.sh"

  sleep 3
  if screen -list | grep -qw "nockchain"; then
    echo -e "${GREEN}[+] èŠ‚ç‚¹å·²å¯åŠ¨ (screen ä¼šè¯å: nockchain)${RESET}"
    echo -e "${GREEN}[+] ä½¿ç”¨å…¬é’¥: $MINING_PUBKEY${RESET}"
    echo -e "${YELLOW}[!] ä½¿ç”¨ 'screen -r nockchain' æŸ¥çœ‹æ—¥å¿—${RESET}"
  else
    echo -e "${RED}[-] èŠ‚ç‚¹å¯åŠ¨å¤±è´¥${RESET}"
    echo "è¯·æ£€æŸ¥ $NCK_DIR/scripts/run_nockchain_miner.sh è„šæœ¬"
  fi
  pause_and_return
}

function view_logs() {
  if screen -list | grep -qw "nockchain"; then
    echo -e "${YELLOW}[!] è¿›å…¥æ—¥å¿—æŸ¥çœ‹ (Ctrl+A+D å¯é€€å‡º)...${RESET}"
    screen -r nockchain
  else
    echo -e "${RED}[-] èŠ‚ç‚¹æœªè¿è¡Œ${RESET}"
  fi
  pause_and_return
}

function check_status() {
  echo -e "[*] æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€..."
  
  # æ˜¾ç¤ºå½“å‰å…¬é’¥é…ç½®
  cd_nck_dir
  if [ -f "$ENV_FILE" ]; then
    source "$ENV_FILE"
    if [ -n "$MINING_PUBKEY" ]; then
      echo -e "${GREEN}[+] å·²é…ç½®å…¬é’¥: ${MINING_PUBKEY:0:16}...${MINING_PUBKEY: -16}${RESET}"
    else
      echo -e "${YELLOW}[!] æœªè®¾ç½®æŒ–çŸ¿å…¬é’¥${RESET}"
    fi
  fi
  
  if screen -list | grep -qw "nockchain"; then
    echo -e "${GREEN}[+] èŠ‚ç‚¹è¿è¡Œä¸­${RESET}"
    
    # æ˜¾ç¤ºCPUä½¿ç”¨æƒ…å†µ
    if command -v htop >/dev/null; then
      echo -e "${YELLOW}[*] CPUä½¿ç”¨æƒ…å†µ (5ç§’åè‡ªåŠ¨è¿”å›):${RESET}"
      timeout 5 htop -d 1 || true
    fi
  else
    echo -e "${RED}[-] èŠ‚ç‚¹æœªè¿è¡Œ${RESET}"
  fi
  
  pause_and_return
}

function stop_node() {
  echo -e "[*] åœæ­¢èŠ‚ç‚¹..."
  if screen -list | grep -qw "nockchain"; then
    screen -S nockchain -X quit
    sleep 2
    echo -e "${GREEN}[+] èŠ‚ç‚¹å·²åœæ­¢${RESET}"
  else
    echo -e "${YELLOW}[!] èŠ‚ç‚¹æœªè¿è¡Œ${RESET}"
  fi
  pause_and_return
}

function pause_and_return() {
  echo ""
  read -n1 -r -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..." key
  main_menu
}

function main_menu() {
  show_banner
  echo "è¯·é€‰æ‹©æ“ä½œ:"
  echo "  1) ğŸš€ ä¸€é”®ä¼˜åŒ–å®‰è£…"
  echo "  2) ğŸ”‘ ç”Ÿæˆé’±åŒ…"
  echo "  3) ğŸ“ è®¾ç½®æŒ–çŸ¿å…¬é’¥ (128ä½16è¿›åˆ¶)"
  echo "  4) ğŸ’¾ å¯¼å‡ºå¯†é’¥"
  echo "  5) ğŸ“‚ å¯¼å…¥å¯†é’¥"
  echo "  6) âš¡ å¯åŠ¨èŠ‚ç‚¹"
  echo "  7) ğŸ“Š æŸ¥çœ‹æ—¥å¿—"
  echo "  8) ğŸ” æ£€æŸ¥çŠ¶æ€"
  echo "  9) â¹ï¸  åœæ­¢èŠ‚ç‚¹"
  echo "  0) é€€å‡º"
  echo ""
  read -p "è¯·è¾“å…¥ç¼–å·: " choice

  case "$choice" in
    1) setup_all ;;
    2) generate_wallet ;;
    3) set_pubkey_env ;;
    4) export_keys ;;
    5) import_keys ;;
    6) start_node ;;
    7) view_logs ;;
    8) check_status ;;
    9) stop_node ;;
    0) echo "é€€å‡ºè„šæœ¬."; exit 0 ;;
    *) echo -e "${RED}[-] æ— æ•ˆé€‰é¡¹${RESET}"; pause_and_return ;;
  esac
}

main_menu
