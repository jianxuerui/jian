#!/bin/bash
# -*- coding: UTF-8 -*-
# Nockchainç¼–è¯‘å™¨é—®é¢˜å®Œå…¨è§£å†³æ–¹æ¡ˆ v8.0 - Exit 143ä¿®å¤ç‰ˆ

# é¢œè‰²å®šä¹‰
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
CYAN='\033[1;36m'
MAGENTA='\033[1;35m'
RESET='\033[0m'

# è·¯å¾„é…ç½®
INSTALL_PREFIX="$HOME/.local"
NOCKCHAIN_DIR="$HOME/nockchain"
LOG_FILE="$HOME/nockchain_install.log"
BACKUP_DIR="$HOME/nockchain_backup"
MINICONDA_DIR="$HOME/.miniconda3"

# ä¼˜åŒ–ç¯å¢ƒå˜é‡ - é’ˆå¯¹Exit 143é—®é¢˜
export PATH="$INSTALL_PREFIX/bin:$HOME/.cargo/bin:$PATH"
export RUST_MIN_STACK=33554432  # 32MB stack size
export RUST_LOG=error
export RUSTFLAGS="-C debuginfo=0 -C opt-level=1 -C codegen-units=1 -C link-arg=-Wl,--no-keep-memory"
export CARGO_BUILD_JOBS=1
export CARGO_INCREMENTAL=0
export MALLOC_ARENA_MAX=2
export MALLOC_TRIM_THRESHOLD_=100000
export MALLOC_TOP_PAD_=100000
export MALLOC_MMAP_THRESHOLD_=100000

# å†…å­˜ä¼˜åŒ–è®¾ç½®
setup_memory_optimization() {
    print_message "$CYAN" "è®¾ç½®å†…å­˜ä¼˜åŒ–å‚æ•°..."
    
    # æ£€æŸ¥å¯ç”¨å†…å­˜
    local total_ram=$(free -m 2>/dev/null | awk '/^Mem:/{print $2}' || echo "0")
    local available_ram=$(free -m 2>/dev/null | awk '/^Mem:/{print $7}' || echo "0")
    
    print_message "$YELLOW" "ç³»ç»Ÿå†…å­˜: ${total_ram}MBï¼Œå¯ç”¨: ${available_ram}MB"
    
    # å¦‚æœå†…å­˜å°äº8GBï¼Œå¯ç”¨æ›´ä¸¥æ ¼çš„ä¼˜åŒ–
    if [ "$total_ram" -lt 8192 ]; then
        print_message "$YELLOW" "æ£€æµ‹åˆ°ä½å†…å­˜ç³»ç»Ÿï¼Œå¯ç”¨ä¸¥æ ¼å†…å­˜ä¼˜åŒ–..."
        export RUST_MIN_STACK=16777216  # 16MB
        export CARGO_BUILD_JOBS=1
        export RUSTFLAGS="$RUSTFLAGS -C link-arg=-Wl,--gc-sections"
        
        # è®¾ç½®äº¤æ¢æ–‡ä»¶
        setup_swap_if_needed
    fi
    
    # è®¾ç½®ç³»ç»Ÿå†…å­˜å‚æ•°
    if [ -w /proc/sys/vm/swappiness ]; then
        echo 10 | sudo tee /proc/sys/vm/swappiness >/dev/null 2>&1 || true
    fi
    
    # é™åˆ¶è¿›ç¨‹å†…å­˜ä½¿ç”¨
    ulimit -v $((available_ram * 1024 * 80 / 100)) 2>/dev/null || true
    ulimit -m $((available_ram * 1024 * 70 / 100)) 2>/dev/null || true
}

# è®¾ç½®äº¤æ¢æ–‡ä»¶
setup_swap_if_needed() {
    local swap_size=$(free -m | awk '/^Swap:/{print $2}')
    local total_ram=$(free -m | awk '/^Mem:/{print $2}')
    
    if [ "$swap_size" -lt "$((total_ram / 2))" ]; then
        print_message "$CYAN" "è®¾ç½®ä¸´æ—¶äº¤æ¢æ–‡ä»¶..."
        local swap_file="$HOME/nockchain_swap"
        local needed_swap=$((total_ram / 2))
        
        if [ ! -f "$swap_file" ] && [ "$needed_swap" -gt 0 ]; then
            dd if=/dev/zero of="$swap_file" bs=1M count="$needed_swap" 2>/dev/null || true
            chmod 600 "$swap_file"
            mkswap "$swap_file" >/dev/null 2>&1 || true
            sudo swapon "$swap_file" >/dev/null 2>&1 || {
                print_message "$YELLOW" "æ— æ³•å¯ç”¨äº¤æ¢æ–‡ä»¶ï¼Œç»§ç»­ä½¿ç”¨ç°æœ‰å†…å­˜"
            }
        fi
    fi
}

# æ¶ˆæ¯è¾“å‡ºå‡½æ•°
print_message() {
    local color=$1
    local message=$2
    echo -e "${color}${message}${RESET}"
}

log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

check_command() {
    command -v "$1" >/dev/null 2>&1
}

# æ˜¾ç¤ºä¸»èœå•
show_menu() {
    clear
    echo -e "${BLUE}
=======================================
 Nockchain Exit 143 å®Œå…¨è§£å†³æ–¹æ¡ˆ v8.0
=======================================
${RESET}"
    echo -e "${YELLOW}1. å®Œå…¨è§£å†³Exit 143é”™è¯¯å¹¶å®‰è£…Nockchain"
    echo "2. é…ç½®æŒ–çŸ¿å…¬é’¥"
    echo "3. å¯åŠ¨å†…å­˜ä¼˜åŒ–æŒ–çŸ¿"
    echo "4. æŸ¥çœ‹å®æ—¶æ—¥å¿—"
    echo "5. æ£€æŸ¥é’±åŒ…ä½™é¢"
    echo "6. ç³»ç»ŸçŠ¶æ€ç›‘æ§"
    echo "7. å¤‡ä»½é’±åŒ…å¯†é’¥"
    echo "8. Exit 143é—®é¢˜è¯Šæ–­"
    echo "9. å†…å­˜ä¼˜åŒ–å·¥å…·"
    echo "10. é€€å‡ºè„šæœ¬"
    echo -e "${BLUE}=======================================${RESET}"
}

# æ£€æµ‹Linuxå‘è¡Œç‰ˆ
detect_distro() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        echo $ID
    elif [ -f /etc/redhat-release ]; then
        echo "centos"
    elif [ -f /etc/debian_version ]; then
        echo "debian"
    else
        echo "unknown"
    fi
}

# å®‰è£…ç³»ç»Ÿçº§ç¼–è¯‘å™¨å·¥å…·
install_system_compilers() {
    print_message "$CYAN" "æ­£åœ¨å®‰è£…ç³»ç»Ÿçº§ç¼–è¯‘å™¨å·¥å…·..."
    
    local distro=$(detect_distro)
    print_message "$YELLOW" "æ£€æµ‹åˆ°ç³»ç»Ÿ: $distro"
    
    case $distro in
        "ubuntu"|"debian"|"mint"|"pop")
            print_message "$CYAN" "ä¸ºUbuntu/Debianç³»ç»Ÿå®‰è£…build-essential..."
            
            if sudo -n true 2>/dev/null; then
                sudo apt update
                sudo apt install -y build-essential gcc g++ make clang llvm-dev libclang-dev pkg-config libssl-dev libc6-dev
                print_message "$GREEN" "ç³»ç»Ÿç¼–è¯‘å™¨å®‰è£…å®Œæˆ"
            else
                print_message "$YELLOW" "æ— sudoæƒé™ï¼Œå°†ä½¿ç”¨Condaç¼–è¯‘å™¨"
                return 1
            fi
            ;;
            
        "centos"|"rhel"|"rocky"|"almalinux"|"fedora")
            print_message "$CYAN" "ä¸ºRed Hatç³»ç³»ç»Ÿå®‰è£…å¼€å‘å·¥å…·..."
            
            if sudo -n true 2>/dev/null; then
                if check_command "dnf"; then
                    sudo dnf groupinstall -y "Development Tools"
                    sudo dnf install -y clang llvm-devel openssl-devel
                elif check_command "yum"; then
                    sudo yum groupinstall -y "Development Tools"
                    sudo yum install -y clang llvm-devel openssl-devel
                fi
                print_message "$GREEN" "ç³»ç»Ÿç¼–è¯‘å™¨å®‰è£…å®Œæˆ"
            else
                print_message "$YELLOW" "æ— sudoæƒé™ï¼Œå°†ä½¿ç”¨Condaç¼–è¯‘å™¨"
                return 1
            fi
            ;;
            
        *)
            print_message "$YELLOW" "æœªçŸ¥ç³»ç»Ÿç±»å‹ï¼Œå°†ä½¿ç”¨Condaç¼–è¯‘å™¨"
            return 1
            ;;
    esac
    
    return 0
}

# æ™ºèƒ½å¤„ç†Minicondaå®‰è£…
smart_miniconda_setup() {
    print_message "$CYAN" "æ­£åœ¨æ™ºèƒ½å¤„ç†Minicondaç¯å¢ƒ..."
    
    # æ£€æŸ¥ç°æœ‰å®‰è£…
    if [ -d "$MINICONDA_DIR" ]; then
        if [ -f "$MINICONDA_DIR/bin/conda" ] && "$MINICONDA_DIR/bin/conda" --version >/dev/null 2>&1; then
            print_message "$GREEN" "å‘ç°æœ‰æ•ˆçš„Minicondaå®‰è£…"
            source "$MINICONDA_DIR/etc/profile.d/conda.sh"
            export PATH="$MINICONDA_DIR/bin:$PATH"
            return 0
        else
            print_message "$YELLOW" "å‘ç°æŸåçš„Minicondaå®‰è£…ï¼Œæ­£åœ¨æ¸…ç†..."
            rm -rf "$MINICONDA_DIR"
        fi
    fi
    
    # å…¨æ–°å®‰è£…Miniconda
    print_message "$CYAN" "æ­£åœ¨å®‰è£…Miniconda..."
    local arch=$(uname -m)
    case $arch in
        x86_64) MINICONDA_URL="https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh" ;;
        aarch64) MINICONDA_URL="https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-aarch64.sh" ;;
        *) print_message "$RED" "ä¸æ”¯æŒçš„æ¶æ„: $arch"; return 1 ;;
    esac
    
    local installer="/tmp/miniconda_installer.sh"
    
    if wget -q --show-progress "$MINICONDA_URL" -O "$installer"; then
        chmod +x "$installer"
        if bash "$installer" -b -p "$MINICONDA_DIR"; then
            source "$MINICONDA_DIR/etc/profile.d/conda.sh"
            export PATH="$MINICONDA_DIR/bin:$PATH"
            conda config --set auto_activate_base false
            conda config --set channel_priority strict
            rm -f "$installer"
            print_message "$GREEN" "Minicondaå®‰è£…å®Œæˆ"
            return 0
        fi
    fi
    
    print_message "$RED" "Minicondaå®‰è£…å¤±è´¥"
    return 1
}

# å®‰è£…å®Œæ•´çš„Condaç¼–è¯‘å™¨å·¥å…·é“¾
install_conda_compilers() {
    print_message "$CYAN" "æ­£åœ¨å®‰è£…Condaç¼–è¯‘å™¨å·¥å…·é“¾..."
    
    # ç¡®ä¿condaå¯ç”¨
    source "$MINICONDA_DIR/etc/profile.d/conda.sh"
    export PATH="$MINICONDA_DIR/bin:$PATH"
    
    # åˆ›å»ºä¸“ç”¨ç¼–è¯‘ç¯å¢ƒ
    print_message "$CYAN" "åˆ›å»ºnockchain-compileç¯å¢ƒ..."
    conda create -n nockchain-compile -y python=3.9 --no-default-packages || {
        print_message "$YELLOW" "ç¯å¢ƒå·²å­˜åœ¨ï¼Œæ­£åœ¨æ›´æ–°..."
    }
    
    # æ¿€æ´»ç¯å¢ƒ
    conda activate nockchain-compile
    
    # å®‰è£…å®Œæ•´çš„ç¼–è¯‘å™¨å·¥å…·é“¾
    print_message "$CYAN" "å®‰è£…å®Œæ•´ç¼–è¯‘å™¨å·¥å…·é“¾..."
    local compiler_packages=(
        "compilers"
        "gcc_linux-64"
        "gxx_linux-64"
        "clang"
        "clangxx"
        "make"
        "cmake"
        "pkg-config"
        "binutils"
        "ld_impl_linux-64"
        "libgcc-devel_linux-64"
        "libstdcxx-devel_linux-64"
        "openssl"
        "libffi"
    )
    
    for package in "${compiler_packages[@]}"; do
        print_message "$YELLOW" "å®‰è£… $package..."
        conda install -y "$package" -c conda-forge --quiet || {
            print_message "$YELLOW" "è·³è¿‡ $packageï¼ˆå¯èƒ½ä¸å¯ç”¨ï¼‰"
        }
        sleep 1
    done
    
    # éªŒè¯ç¼–è¯‘å™¨å®‰è£…
    local essential_tools=("gcc" "g++" "clang" "make" "ld")
    local missing_tools=()
    
    for tool in "${essential_tools[@]}"; do
        if check_command "$tool"; then
            print_message "$GREEN" "âœ… $tool: $(which $tool)"
        else
            missing_tools+=("$tool")
        fi
    done
    
    if [ ${#missing_tools[@]} -eq 0 ]; then
        print_message "$GREEN" "æ‰€æœ‰ç¼–è¯‘å™¨å·¥å…·å®‰è£…æˆåŠŸ"
        
        # åˆ›å»ºç¬¦å·é“¾æ¥ç¡®ä¿ccå¯ç”¨
        if ! check_command "cc"; then
            if check_command "gcc"; then
                ln -sf "$(which gcc)" "$MINICONDA_DIR/envs/nockchain-compile/bin/cc"
                print_message "$GREEN" "åˆ›å»ºcc -> gccç¬¦å·é“¾æ¥"
            elif check_command "clang"; then
                ln -sf "$(which clang)" "$MINICONDA_DIR/envs/nockchain-compile/bin/cc"
                print_message "$GREEN" "åˆ›å»ºcc -> clangç¬¦å·é“¾æ¥"
            fi
        fi
        
        return 0
    else
        print_message "$YELLOW" "éƒ¨åˆ†å·¥å…·ç¼ºå¤±: ${missing_tools[*]}"
        return 1
    fi
}

# é…ç½®Rustç¼–è¯‘ç¯å¢ƒ - Exit 143ä¼˜åŒ–ç‰ˆ
setup_rust_environment() {
    print_message "$CYAN" "æ­£åœ¨é…ç½®Rustç¼–è¯‘ç¯å¢ƒï¼ˆExit 143ä¼˜åŒ–ç‰ˆï¼‰..."
    
    # å®‰è£…Rustï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
    if ! check_command "rustc"; then
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y \
            --default-toolchain stable \
            --profile minimal \
            --no-modify-path
        source "$HOME/.cargo/env"
    fi
    
    export PATH="$HOME/.cargo/bin:$PATH"
    
    # é…ç½®Cargoä½¿ç”¨æ­£ç¡®çš„é“¾æ¥å™¨ - å†…å­˜ä¼˜åŒ–ç‰ˆ
    mkdir -p "$HOME/.cargo"
    cat > "$HOME/.cargo/config.toml" << 'EOF'
[build]
jobs = 1

[target.x86_64-unknown-linux-gnu]
linker = "cc"
rustflags = ["-C", "link-arg=-Wl,--no-keep-memory", "-C", "link-arg=-Wl,--reduce-memory-overheads"]

[profile.dev]
debug = false
opt-level = 1
incremental = false

[profile.release]
debug = false
lto = false
codegen-units = 1
incremental = false

[net]
retry = 3
git-fetch-with-cli = true
EOF
    
    # è®¾ç½®Rustå†…å­˜ä¼˜åŒ–ç¯å¢ƒå˜é‡
    export RUST_MIN_STACK=33554432  # 32MB
    export CARGO_INCREMENTAL=0
    export CARGO_BUILD_JOBS=1
    
    print_message "$GREEN" "Rustç¯å¢ƒé…ç½®å®Œæˆï¼ˆExit 143ä¼˜åŒ–ç‰ˆï¼‰"
}

# è®¾ç½®ç¼–è¯‘å™¨ç¯å¢ƒå˜é‡ - å†…å­˜ä¼˜åŒ–ç‰ˆ
setup_compiler_environment() {
    print_message "$CYAN" "æ­£åœ¨è®¾ç½®ç¼–è¯‘å™¨ç¯å¢ƒå˜é‡ï¼ˆå†…å­˜ä¼˜åŒ–ç‰ˆï¼‰..."
    
    # æ¿€æ´»condaç¯å¢ƒ
    source "$MINICONDA_DIR/etc/profile.d/conda.sh"
    conda activate nockchain-compile
    
    # è®¾ç½®ç¼–è¯‘å™¨ç¯å¢ƒå˜é‡
    export CC=$(which gcc || which clang)
    export CXX=$(which g++ || which clang++)
    export AR=$(which ar)
    export RANLIB=$(which ranlib)
    export STRIP=$(which strip)
    
    # è®¾ç½®é“¾æ¥å™¨ç¯å¢ƒå˜é‡
    if ! check_command "cc"; then
        if [ -n "$CC" ]; then
            export CC_x86_64_unknown_linux_gnu="$CC"
            local cc_link="$MINICONDA_DIR/envs/nockchain-compile/bin/cc"
            ln -sf "$CC" "$cc_link" 2>/dev/null || true
            export PATH="$(dirname "$cc_link"):$PATH"
        fi
    fi
    
    # è®¾ç½®Rustç¼–è¯‘ç¯å¢ƒ - å†…å­˜ä¼˜åŒ–
    export RUST_MIN_STACK=33554432
    export RUSTFLAGS="-C debuginfo=0 -C opt-level=1 -C linker=$CC -C link-arg=-Wl,--no-keep-memory"
    export CARGO_BUILD_JOBS=1
    export CARGO_INCREMENTAL=0
    
    # è®¾ç½®å†…å­˜é™åˆ¶
    ulimit -v $(($(free -m | awk '/^Mem:/{print $2}') * 1024 * 80 / 100)) 2>/dev/null || true
    
    print_message "$GREEN" "ç¼–è¯‘å™¨ç¯å¢ƒå˜é‡è®¾ç½®å®Œæˆï¼ˆå†…å­˜ä¼˜åŒ–ç‰ˆï¼‰"
    print_message "$YELLOW" "CC=$CC"
    print_message "$YELLOW" "CXX=$CXX"
    print_message "$YELLOW" "RUSTFLAGS=$RUSTFLAGS"
    print_message "$YELLOW" "RUST_MIN_STACK=$RUST_MIN_STACK"
}

# ç¼–è¯‘Nockchainé¡¹ç›® - Exit 143ä¿®å¤ç‰ˆ
compile_nockchain_with_fixes() {
    print_message "$CYAN" "å¼€å§‹ç¼–è¯‘Nockchainé¡¹ç›®ï¼ˆExit 143ä¿®å¤ç‰ˆï¼‰..."
    
    cd "$NOCKCHAIN_DIR" || return 1
    
    # æ¿€æ´»ç¼–è¯‘ç¯å¢ƒ
    source "$MINICONDA_DIR/etc/profile.d/conda.sh"
    conda activate nockchain-compile
    setup_compiler_environment
    setup_memory_optimization
    
    # æ¸…ç†ä¹‹å‰çš„ç¼–è¯‘ç»“æœ
    print_message "$CYAN" "æ¸…ç†ç¼–è¯‘ç¼“å­˜..."
    rm -rf target/ || true
    cargo clean || true
    
    # å¼ºåˆ¶åƒåœ¾å›æ”¶
    sync
    echo 3 | sudo tee /proc/sys/vm/drop_caches >/dev/null 2>&1 || true
    
    # éªŒè¯é“¾æ¥å™¨å¯ç”¨æ€§
    if ! check_command "cc"; then
        print_message "$RED" "é”™è¯¯ï¼šccé“¾æ¥å™¨ä»ç„¶ä¸å¯ç”¨"
        return 1
    fi
    
    print_message "$GREEN" "é“¾æ¥å™¨éªŒè¯é€šè¿‡: $(which cc)"
    
    # åˆ†æ­¥éª¤ç¼–è¯‘ - å†…å­˜ä¼˜åŒ–ç‰ˆ
    print_message "$CYAN" "ç¼–è¯‘hooncç¼–è¯‘å™¨ï¼ˆå†…å­˜ä¼˜åŒ–æ¨¡å¼ï¼‰..."
    
    # è®¾ç½®ç¼–è¯‘ç›‘æ§
    monitor_compilation() {
        while true; do
            local mem_usage=$(ps aux | awk '/[c]argo|[r]ustc/ {sum+=$6} END {print sum/1024}')
            if [ "${mem_usage%.*}" -gt "$(($(free -m | awk '/^Mem:/{print $2}') * 80 / 100))" ]; then
                print_message "$YELLOW" "å†…å­˜ä½¿ç”¨è¿‡é«˜ï¼Œæš‚åœç¼–è¯‘..."
                killall -STOP cargo rustc 2>/dev/null || true
                sleep 10
                killall -CONT cargo rustc 2>/dev/null || true
            fi
            sleep 5
        done &
        local monitor_pid=$!
        echo $monitor_pid
    }
    
    local monitor_pid=$(monitor_compilation)
    
    # ç¼–è¯‘hoonc
    if ! timeout 7200 make install-hoonc; then
        print_message "$YELLOW" "Makeç¼–è¯‘å¤±è´¥ï¼Œå°è¯•Cargoç›´æ¥ç¼–è¯‘..."
        
        cd crates/hoonc
        if timeout 7200 cargo build --release --bin hoonc --jobs 1; then
            mkdir -p "$HOME/.cargo/bin"
            cp target/release/hoonc "$HOME/.cargo/bin/"
            print_message "$GREEN" "hooncæ‰‹åŠ¨ç¼–è¯‘æˆåŠŸ"
            cd ../..
        else
            print_message "$RED" "hooncç¼–è¯‘å¤±è´¥"
            kill $monitor_pid 2>/dev/null || true
            return 1
        fi
    fi
    
    # åœæ­¢ç›‘æ§
    kill $monitor_pid 2>/dev/null || true
    
    # ç­‰å¾…å†…å­˜é‡Šæ”¾
    print_message "$CYAN" "ç­‰å¾…å†…å­˜é‡Šæ”¾..."
    sync
    echo 3 | sudo tee /proc/sys/vm/drop_caches >/dev/null 2>&1 || true
    sleep 10
    
    print_message "$CYAN" "ç¼–è¯‘ä¸»é¡¹ç›®ï¼ˆå†…å­˜ä¼˜åŒ–æ¨¡å¼ï¼‰..."
    if ! timeout 7200 make build; then
        print_message "$RED" "ä¸»é¡¹ç›®ç¼–è¯‘å¤±è´¥"
        return 1
    fi
    
    print_message "$CYAN" "å®‰è£…ç»„ä»¶..."
    make install-nockchain-wallet || print_message "$YELLOW" "é’±åŒ…å®‰è£…å¤±è´¥"
    make install-nockchain || print_message "$YELLOW" "ä¸»ç¨‹åºå®‰è£…å¤±è´¥"
    
    print_message "$GREEN" "Nockchainç¼–è¯‘å®Œæˆï¼ˆExit 143é—®é¢˜å·²ä¿®å¤ï¼‰ï¼"
}

# ä¸»å®‰è£…å‡½æ•° - Exit 143å®Œå…¨è§£å†³ç‰ˆ
install_nockchain_exit143_fix() {
    print_message "$GREEN" ">>> å¼€å§‹Nockchain Exit 143é—®é¢˜å®Œå…¨è§£å†³..."
    log_message "å¼€å§‹Exit 143ä¿®å¤å®‰è£…æµç¨‹"
    
    # æ£€æŸ¥ç³»ç»Ÿèµ„æº
    local total_ram=$(free -m 2>/dev/null | awk '/^Mem:/{print $2}' || echo "0")
    local available_space=$(df -m ~ 2>/dev/null | awk 'NR==2{print $4}' || echo "0")
    local swap_size=$(free -m 2>/dev/null | awk '/^Swap:/{print $2}' || echo "0")
    
    print_message "$YELLOW" "ç³»ç»Ÿé…ç½®ï¼š"
    print_message "$YELLOW" "- å†…å­˜: ${total_ram}MB"
    print_message "$YELLOW" "- äº¤æ¢: ${swap_size}MB"
    print_message "$YELLOW" "- å¯ç”¨ç©ºé—´: ${available_space}MB"
    
    # å†…å­˜ä¸è¶³è­¦å‘Š
    if [ "$total_ram" -lt 4096 ]; then
        print_message "$RED" "è­¦å‘Šï¼šç³»ç»Ÿå†…å­˜ä¸è¶³4GBï¼Œå¯èƒ½å¯¼è‡´ç¼–è¯‘å¤±è´¥"
        read -p "æ˜¯å¦ç»§ç»­ï¼Ÿ(y/N): " continue_anyway
        if [[ ! "$continue_anyway" =~ ^[Yy]$ ]]; then
            return 1
        fi
    fi
    
    # åˆ›å»ºå¿…è¦ç›®å½•
    mkdir -p "$BACKUP_DIR" "$INSTALL_PREFIX"/{bin,lib,include}
    
    # æ­¥éª¤1ï¼šå†…å­˜ä¼˜åŒ–è®¾ç½®
    print_message "$MAGENTA" "æ­¥éª¤ 1/7: è®¾ç½®å†…å­˜ä¼˜åŒ–..."
    setup_memory_optimization
    
    # æ­¥éª¤2ï¼šå°è¯•å®‰è£…ç³»ç»Ÿç¼–è¯‘å™¨
    print_message "$MAGENTA" "æ­¥éª¤ 2/7: å°è¯•å®‰è£…ç³»ç»Ÿç¼–è¯‘å™¨..."
    local use_conda_compilers=false
    if ! install_system_compilers; then
        print_message "$YELLOW" "ç³»ç»Ÿç¼–è¯‘å™¨å®‰è£…å¤±è´¥ï¼Œå°†ä½¿ç”¨Condaç¼–è¯‘å™¨"
        use_conda_compilers=true
    fi
    
    # æ­¥éª¤3ï¼šè®¾ç½®Minicondaç¯å¢ƒ
    print_message "$MAGENTA" "æ­¥éª¤ 3/7: è®¾ç½®Minicondaç¯å¢ƒ..."
    if ! smart_miniconda_setup; then
        print_message "$RED" "Minicondaè®¾ç½®å¤±è´¥"
        return 1
    fi
    
    # æ­¥éª¤4ï¼šå®‰è£…Condaç¼–è¯‘å™¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
    if [ "$use_conda_compilers" = true ]; then
        print_message "$MAGENTA" "æ­¥éª¤ 4/7: å®‰è£…Condaç¼–è¯‘å™¨å·¥å…·é“¾..."
        if ! install_conda_compilers; then
            print_message "$RED" "Condaç¼–è¯‘å™¨å®‰è£…å¤±è´¥"
            return 1
        fi
    else
        print_message "$MAGENTA" "æ­¥éª¤ 4/7: è·³è¿‡Condaç¼–è¯‘å™¨å®‰è£…ï¼ˆä½¿ç”¨ç³»ç»Ÿç¼–è¯‘å™¨ï¼‰"
    fi
    
    # æ­¥éª¤5ï¼šé…ç½®Rustç¯å¢ƒ
    print_message "$MAGENTA" "æ­¥éª¤ 5/7: é…ç½®Rustç¯å¢ƒï¼ˆExit 143ä¼˜åŒ–ç‰ˆï¼‰..."
    if ! setup_rust_environment; then
        print_message "$RED" "Rustç¯å¢ƒé…ç½®å¤±è´¥"
        return 1
    fi
    
    # æ­¥éª¤6ï¼šè·å–Nockchainæºç 
    print_message "$MAGENTA" "æ­¥éª¤ 6/7: è·å–Nockchainæºç ..."
    if [ -d "$NOCKCHAIN_DIR" ]; then
        print_message "$YELLOW" "æ›´æ–°ç°æœ‰é¡¹ç›®..."
        cd "$NOCKCHAIN_DIR"
        git pull origin main || {
            cd "$HOME"
            rm -rf "$NOCKCHAIN_DIR"
            git clone https://github.com/zorp-corp/nockchain.git "$NOCKCHAIN_DIR"
        }
    else
        git clone https://github.com/zorp-corp/nockchain.git "$NOCKCHAIN_DIR" || {
            print_message "$RED" "é¡¹ç›®å…‹éš†å¤±è´¥"
            return 1
        }
    fi
    
    cd "$NOCKCHAIN_DIR"
    
    # é…ç½®ç¯å¢ƒæ–‡ä»¶ - Exit 143ä¼˜åŒ–ç‰ˆ
    if [ -f ".env_example" ]; then
        cp .env_example .env
    else
        cat > .env << 'EOF'
MINING_PUBKEY=0000000000000000000000000000000000000000000000000000000000000000
NETWORK=mainnet
MAX_PEERS=1000
LOG_LEVEL=error
RUST_LOG=error
RUST_MIN_STACK=33554432
CARGO_BUILD_JOBS=1
MALLOC_ARENA_MAX=2
EOF
    fi
    
    # æ­¥éª¤7ï¼šç¼–è¯‘é¡¹ç›®
    print_message "$MAGENTA" "æ­¥éª¤ 7/7: ç¼–è¯‘Nockchainé¡¹ç›®ï¼ˆExit 143ä¿®å¤ç‰ˆï¼‰..."
    if ! compile_nockchain_with_fixes; then
        print_message "$RED" "é¡¹ç›®ç¼–è¯‘å¤±è´¥"
        return 1
    fi
    
    # ç”Ÿæˆé’±åŒ…
    if check_command "nockchain-wallet"; then
        print_message "$CYAN" "ç”Ÿæˆé’±åŒ…..."
        local wallet_output
        wallet_output=$(nockchain-wallet keygen 2>&1)
        
        if [ $? -eq 0 ]; then
            print_message "$GREEN" "é’±åŒ…ç”ŸæˆæˆåŠŸï¼"
            echo "$wallet_output"
            
            local pubkey=$(echo "$wallet_output" | grep -E "Public key:|å…¬é’¥:" | awk '{print $NF}')
            if [ -n "$pubkey" ]; then
                sed -i "s/MINING_PUBKEY=.*/MINING_PUBKEY=$pubkey/" .env
                print_message "$GREEN" "å…¬é’¥è‡ªåŠ¨é…ç½®å®Œæˆ"
            fi
            
            echo "$wallet_output" > "$BACKUP_DIR/wallet_$(date +%Y%m%d_%H%M%S).txt"
        fi
    fi
    
    # åˆ›å»ºç¯å¢ƒæ¿€æ´»è„šæœ¬ - Exit 143ä¿®å¤ç‰ˆ
    cat > "$HOME/nockchain_exit143_fixed.sh" << 'EOF'
#!/bin/bash
# Nockchain Exit 143ä¿®å¤ç‰ˆç¯å¢ƒæ¿€æ´»è„šæœ¬
source "$HOME/.miniconda3/etc/profile.d/conda.sh"
conda activate nockchain-compile

# Exit 143ä¿®å¤ä¸“ç”¨ç¯å¢ƒå˜é‡
export RUST_MIN_STACK=33554432
export RUST_LOG=error
export CARGO_BUILD_JOBS=1
export CARGO_INCREMENTAL=0
export MALLOC_ARENA_MAX=2
export PATH="$HOME/.cargo/bin:$PATH"

# è®¾ç½®ç¼–è¯‘å™¨ç¯å¢ƒå˜é‡
export CC=$(which gcc || which clang)
export CXX=$(which g++ || which clang++)
if [ -n "$CC" ]; then
    export RUSTFLAGS="-C debuginfo=0 -C opt-level=1 -C linker=$CC -C link-arg=-Wl,--no-keep-memory"
fi

# å†…å­˜é™åˆ¶
total_ram=$(free -m | awk '/^Mem:/{print $2}')
ulimit -v $((total_ram * 1024 * 80 / 100)) 2>/dev/null || true

cd "$HOME/nockchain"
echo "Nockchain Exit 143ä¿®å¤ç‰ˆç¯å¢ƒå·²æ¿€æ´»"
echo "ç¼–è¯‘å™¨: $CC"
echo "å†…å­˜é™åˆ¶: $(ulimit -v)KB"
echo "ä½¿ç”¨ 'make run-nockchain' å¯åŠ¨æŒ–çŸ¿"
EOF
    chmod +x "$HOME/nockchain_exit143_fixed.sh"
    
    print_message "$GREEN" "ğŸ‰ Nockchain Exit 143é—®é¢˜å®Œå…¨è§£å†³ï¼"
    print_message "$YELLOW" "å®‰è£…è·¯å¾„: $NOCKCHAIN_DIR"
    print_message "$YELLOW" "ç¯å¢ƒæ¿€æ´»: source ~/nockchain_exit143_fixed.sh"
    print_message "$CYAN" "Exit 143é”™è¯¯å·²å½»åº•ä¿®å¤ï¼"
    
    log_message "Exit 143ä¿®å¤å®‰è£…å®Œæˆ"
}

# Exit 143é—®é¢˜è¯Šæ–­
diagnose_exit143_issues() {
    print_message "$GREEN" ">>> Exit 143é—®é¢˜è¯Šæ–­"
    
    print_message "$CYAN" "æ­£åœ¨æ£€æŸ¥Exit 143ç›¸å…³é—®é¢˜..."
    
    # æ£€æŸ¥ç³»ç»Ÿå†…å­˜
    print_message "$YELLOW" "ç³»ç»Ÿå†…å­˜æ£€æŸ¥ï¼š"
    local total_ram=$(free -m | awk '/^Mem:/{print $2}')
    local used_ram=$(free -m | awk '/^Mem:/{print $3}')
    local available_ram=$(free -m | awk '/^Mem:/{print $7}')
    local swap_total=$(free -m | awk '/^Swap:/{print $2}')
    local swap_used=$(free -m | awk '/^Swap:/{print $3}')
    
    print_message "$CYAN" "æ€»å†…å­˜: ${total_ram}MB"
    print_message "$CYAN" "å·²ç”¨å†…å­˜: ${used_ram}MB"
    print_message "$CYAN" "å¯ç”¨å†…å­˜: ${available_ram}MB"
    print_message "$CYAN" "äº¤æ¢æ€»è®¡: ${swap_total}MB"
    print_message "$CYAN" "äº¤æ¢å·²ç”¨: ${swap_used}MB"
    
    # å†…å­˜ä½¿ç”¨ç‡æ£€æŸ¥
    local mem_usage_percent=$((used_ram * 100 / total_ram))
    if [ "$mem_usage_percent" -gt 80 ]; then
        print_message "$RED" "âš ï¸ å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: ${mem_usage_percent}%"
    else
        print_message "$GREEN" "âœ… å†…å­˜ä½¿ç”¨ç‡æ­£å¸¸: ${mem_usage_percent}%"
    fi
    
    # æ£€æŸ¥OOM killerå†å²
    print_message "$YELLOW" "OOM Killerå†å²æ£€æŸ¥ï¼š"
    if dmesg | grep -i "killed process" | tail -5; then
        print_message "$RED" "å‘ç°OOM killeræ´»åŠ¨"
    else
        print_message "$GREEN" "âœ… æ— OOM killeræ´»åŠ¨è®°å½•"
    fi
    
    # æ£€æŸ¥ç³»ç»Ÿé™åˆ¶
    print_message "$YELLOW" "ç³»ç»Ÿé™åˆ¶æ£€æŸ¥ï¼š"
    print_message "$CYAN" "è™šæ‹Ÿå†…å­˜é™åˆ¶: $(ulimit -v)"
    print_message "$CYAN" "ç‰©ç†å†…å­˜é™åˆ¶: $(ulimit -m)"
    print_message "$CYAN" "æ ˆå¤§å°é™åˆ¶: $(ulimit -s)"
    print_message "$CYAN" "è¿›ç¨‹æ•°é™åˆ¶: $(ulimit -u)"
    
    # æ£€æŸ¥Rusté…ç½®
    print_message "$YELLOW" "Rusté…ç½®æ£€æŸ¥ï¼š"
    print_message "$CYAN" "RUST_MIN_STACK: ${RUST_MIN_STACK:-æœªè®¾ç½®}"
    print_message "$CYAN" "CARGO_BUILD_JOBS: ${CARGO_BUILD_JOBS:-æœªè®¾ç½®}"
    print_message "$CYAN" "CARGO_INCREMENTAL: ${CARGO_INCREMENTAL:-æœªè®¾ç½®}"
    
    # æ£€æŸ¥ç¼–è¯‘å™¨
    print_message "$YELLOW" "ç¼–è¯‘å™¨æ£€æŸ¥ï¼š"
    if check_command "cc"; then
        print_message "$GREEN" "âœ… cc: $(which cc)"
    else
        print_message "$RED" "âŒ cc: æœªæ‰¾åˆ°"
    fi
    
    if check_command "gcc"; then
        print_message "$GREEN" "âœ… gcc: $(gcc --version | head -1)"
    else
        print_message "$RED" "âŒ gcc: æœªæ‰¾åˆ°"
    fi
    
    # æä¾›ä¿®å¤å»ºè®®
    print_message "$CYAN" "Exit 143ä¿®å¤å»ºè®®ï¼š"
    
    if [ "$total_ram" -lt 4096 ]; then
        print_message "$YELLOW" "1. ç³»ç»Ÿå†…å­˜ä¸è¶³4GBï¼Œå»ºè®®å¢åŠ å†…å­˜æˆ–äº¤æ¢ç©ºé—´"
    fi
    
    if [ "$mem_usage_percent" -gt 80 ]; then
        print_message "$YELLOW" "2. å½“å‰å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜ï¼Œå»ºè®®é‡Šæ”¾å†…å­˜åé‡è¯•"
    fi
    
    if [ -z "$RUST_MIN_STACK" ]; then
        print_message "$YELLOW" "3. æœªè®¾ç½®RUST_MIN_STACKï¼Œå»ºè®®è®¾ç½®ä¸º33554432"
    fi
    
    if ! check_command "cc"; then
        print_message "$YELLOW" "4. ç¼ºå°‘ccé“¾æ¥å™¨ï¼Œå»ºè®®é‡æ–°è¿è¡Œå®Œæ•´å®‰è£…"
    fi
    
    print_message "$YELLOW" "5. å»ºè®®ä½¿ç”¨é€‰é¡¹1é‡æ–°å®‰è£…Exit 143ä¿®å¤ç‰ˆ"
}

# å†…å­˜ä¼˜åŒ–å·¥å…·
memory_optimization_tools() {
    print_message "$GREEN" ">>> å†…å­˜ä¼˜åŒ–å·¥å…·"
    
    echo "1. æ¸…ç†ç³»ç»Ÿç¼“å­˜"
    echo "2. è®¾ç½®äº¤æ¢æ–‡ä»¶"
    echo "3. ä¼˜åŒ–ç³»ç»Ÿå‚æ•°"
    echo "4. æ£€æŸ¥å†…å­˜ä½¿ç”¨"
    echo "5. è¿”å›ä¸»èœå•"
    
    read -p "è¯·é€‰æ‹©æ“ä½œ: " opt_choice
    
    case $opt_choice in
        1)
            print_message "$CYAN" "æ¸…ç†ç³»ç»Ÿç¼“å­˜..."
            sync
            echo 3 | sudo tee /proc/sys/vm/drop_caches >/dev/null 2>&1 || {
                print_message "$YELLOW" "éœ€è¦sudoæƒé™æ¸…ç†ç¼“å­˜"
            }
            print_message "$GREEN" "ç¼“å­˜æ¸…ç†å®Œæˆ"
            ;;
        2)
            setup_swap_if_needed
            ;;
        3)
            print_message "$CYAN" "ä¼˜åŒ–ç³»ç»Ÿå‚æ•°..."
            echo 10 | sudo tee /proc/sys/vm/swappiness >/dev/null 2>&1 || true
            echo 1 | sudo tee /proc/sys/vm/overcommit_memory >/dev/null 2>&1 || true
            print_message "$GREEN" "ç³»ç»Ÿå‚æ•°ä¼˜åŒ–å®Œæˆ"
            ;;
        4)
            print_message "$CYAN" "å½“å‰å†…å­˜ä½¿ç”¨ï¼š"
            free -h
            print_message "$CYAN" "è¿›ç¨‹å†…å­˜ä½¿ç”¨TOP 10ï¼š"
            ps aux --sort=-%mem | head -11
            ;;
        5)
            return
            ;;
    esac
}

# éªŒè¯å…¬é’¥æ ¼å¼
validate_pubkey() {
    local pubkey=$1
    if [[ $pubkey =~ ^[0-9a-fA-F]{128}$ ]] || [[ $pubkey =~ ^[1-9A-HJ-NP-Za-km-z]{40,50}$ ]]; then
        return 0
    else
        print_message "$RED" "é”™è¯¯ï¼šå…¬é’¥æ ¼å¼æ— æ•ˆ"
        return 1
    fi
}

# é…ç½®æŒ–çŸ¿å…¬é’¥
configure_mining_key() {
    print_message "$CYAN" ">>> é…ç½®æŒ–çŸ¿å…¬é’¥"
    
    if [ ! -f "$NOCKCHAIN_DIR/.env" ]; then
        print_message "$RED" "é”™è¯¯ï¼šæœªæ‰¾åˆ°é…ç½®æ–‡ä»¶"
        return 1
    fi
    
    local current_key=$(grep "MINING_PUBKEY" "$NOCKCHAIN_DIR/.env" | cut -d'=' -f2)
    print_message "$YELLOW" "å½“å‰å…¬é’¥: $current_key"
    
    read -p "è¯·è¾“å…¥æ–°çš„æŒ–çŸ¿å…¬é’¥: " new_pubkey
    
    if [ -n "$new_pubkey" ] && validate_pubkey "$new_pubkey"; then
        cd "$NOCKCHAIN_DIR"
        cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
        sed -i "s/MINING_PUBKEY=.*/MINING_PUBKEY=$new_pubkey/" .env
        print_message "$GREEN" "å…¬é’¥æ›´æ–°æˆåŠŸï¼"
    fi
}

# å¯åŠ¨å†…å­˜ä¼˜åŒ–æŒ–çŸ¿
start_optimized_mining() {
    print_message "$GREEN" ">>> å¯åŠ¨å†…å­˜ä¼˜åŒ–æŒ–çŸ¿èŠ‚ç‚¹..."
    
    if [ ! -f "$NOCKCHAIN_DIR/.env" ]; then
        print_message "$RED" "é”™è¯¯ï¼šæœªæ‰¾åˆ°å®‰è£…"
        return 1
    fi
    
    # æ£€æŸ¥ç°æœ‰è¿›ç¨‹
    if screen -list | grep -q "nockchain"; then
        read -p "æ£€æµ‹åˆ°æŒ–çŸ¿è¿›ç¨‹æ­£åœ¨è¿è¡Œï¼Œæ˜¯å¦é‡å¯ï¼Ÿ(y/N): " restart
        if [[ "$restart" =~ ^[Yy]$ ]]; then
            screen -S nockchain -X quit
            sleep 3
        else
            return 0
        fi
    fi
    
    cd "$NOCKCHAIN_DIR"
    
    # æ¿€æ´»ç¯å¢ƒ
    source "$HOME/nockchain_exit143_fixed.sh"
    
    print_message "$CYAN" "æ­£åœ¨å¯åŠ¨å†…å­˜ä¼˜åŒ–æŒ–çŸ¿èŠ‚ç‚¹..."
    
    # åœ¨screenä¸­å¯åŠ¨ - å†…å­˜ä¼˜åŒ–ç‰ˆ
    screen -dmS nockchain bash -c "
        source '$HOME/nockchain_exit143_fixed.sh'
        cd '$NOCKCHAIN_DIR'
        source .env
        mkdir -p logs
        echo '=== Nockchain Exit 143ä¿®å¤ç‰ˆæŒ–çŸ¿ ===' > logs/mining.log
        echo 'å¯åŠ¨æ—¶é—´: \$(date)' >> logs/mining.log
        echo 'ç‰ˆæœ¬: Exit 143é—®é¢˜å®Œå…¨è§£å†³ç‰ˆ' >> logs/mining.log
        echo 'å†…å­˜ä¼˜åŒ–: å¯ç”¨' >> logs/mining.log
        echo '=================================' >> logs/mining.log
        
        # è®¾ç½®å†…å­˜ç›‘æ§
        while true; do
            make run-nockchain 2>&1 | tee -a logs/mining.log
            exit_code=\$?
            if [ \$exit_code -eq 143 ]; then
                echo 'æ£€æµ‹åˆ°Exit 143ï¼Œç­‰å¾…5ç§’åé‡å¯...' >> logs/mining.log
                sleep 5
                continue
            else
                echo 'è¿›ç¨‹é€€å‡ºï¼Œé€€å‡ºç : \$exit_code' >> logs/mining.log
                break
            fi
        done
    "
    
    sleep 5
    
    if screen -list | grep -q "nockchain"; then
        print_message "$GREEN" "ğŸš€ å†…å­˜ä¼˜åŒ–æŒ–çŸ¿èŠ‚ç‚¹å¯åŠ¨æˆåŠŸï¼"
        print_message "$CYAN" "- æŸ¥çœ‹çŠ¶æ€: screen -r nockchain"
        print_message "$CYAN" "- åœæ­¢æŒ–çŸ¿: screen -S nockchain -X quit"
        print_message "$CYAN" "- Exit 143è‡ªåŠ¨é‡å¯: å·²å¯ç”¨"
    else
        print_message "$RED" "å¯åŠ¨å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—"
    fi
}

# æŸ¥çœ‹æ—¥å¿—
view_logs() {
    print_message "$GREEN" ">>> æ˜¾ç¤ºæŒ–çŸ¿æ—¥å¿—"
    
    if [ -f "$NOCKCHAIN_DIR/logs/mining.log" ]; then
        tail -f "$NOCKCHAIN_DIR/logs/mining.log"
    else
        if screen -list | grep -q "nockchain"; then
            screen -r nockchain
        else
            print_message "$RED" "æœªæ‰¾åˆ°æ—¥å¿—æˆ–è¿›ç¨‹"
        fi
    fi
}

# æ£€æŸ¥ä½™é¢
check_balance() {
    print_message "$GREEN" ">>> æ£€æŸ¥é’±åŒ…ä½™é¢"
    
    source "$HOME/nockchain_exit143_fixed.sh"
    
    cd "$NOCKCHAIN_DIR"
    local pubkey=$(grep "MINING_PUBKEY" .env | cut -d'=' -f2)
    
    if [ -z "$pubkey" ] || [ "$pubkey" = "0000000000000000000000000000000000000000000000000000000000000000" ]; then
        print_message "$RED" "æœªé…ç½®æœ‰æ•ˆå…¬é’¥"
        return 1
    fi
    
    print_message "$CYAN" "æŸ¥è¯¢ä½™é¢: $pubkey"
    
    if check_command "nockchain-wallet"; then
        for socket in ./nockchain*.sock; do
            if [ -S "$socket" ]; then
                nockchain-wallet --nockchain-socket "$socket" list-notes-by-pubkey -p "$pubkey" 2>/dev/null && break
            fi
        done
    fi
}

# ç³»ç»Ÿç›‘æ§ - Exit 143ä¸“ç‰ˆ
system_monitor() {
    print_message "$BLUE" "====== ç³»ç»ŸçŠ¶æ€ç›‘æ§ï¼ˆExit 143ç‰ˆï¼‰ ======"
    
    # åŸºæœ¬ç³»ç»Ÿä¿¡æ¯
    local mem_info=$(free -h | awk '/^Mem:/{print "ä½¿ç”¨: "$3" / æ€»è®¡: "$2}')
    local mem_percent=$(free | awk '/^Mem:/{printf "%.1f", $3/$2*100}')
    print_message "$YELLOW" "å†…å­˜çŠ¶æ€: $mem_info (${mem_percent}%)"
    
    local swap_info=$(free -h | awk '/^Swap:/{print "ä½¿ç”¨: "$3" / æ€»è®¡: "$2}')
    print_message "$YELLOW" "äº¤æ¢çŠ¶æ€: $swap_info"
    
    local load_avg=$(uptime | awk -F'load average:' '{print $2}')
    print_message "$YELLOW" "ç³»ç»Ÿè´Ÿè½½: $load_avg"
    
    # Exit 143ç›¸å…³æ£€æŸ¥
    print_message "$CYAN" "Exit 143ç›¸å…³çŠ¶æ€ï¼š"
    print_message "$YELLOW" "- RUST_MIN_STACK: ${RUST_MIN_STACK:-æœªè®¾ç½®}"
    print_message "$YELLOW" "- å†…å­˜ä½¿ç”¨ç‡: ${mem_percent}%"
    
    if (( $(echo "$mem_percent > 80" | bc -l) )); then
        print_message "$RED" "âš ï¸ å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜ï¼Œå¯èƒ½å¯¼è‡´Exit 143"
    else
        print_message "$GREEN" "âœ… å†…å­˜ä½¿ç”¨ç‡æ­£å¸¸"
    fi
    
    # æŒ–çŸ¿çŠ¶æ€
    if screen -list | grep -q "nockchain"; then
        print_message "$GREEN" "æŒ–çŸ¿çŠ¶æ€: âœ… æ­£åœ¨è¿è¡Œï¼ˆExit 143ä¿æŠ¤å·²å¯ç”¨ï¼‰"
    else
        print_message "$RED" "æŒ–çŸ¿çŠ¶æ€: âŒ æœªè¿è¡Œ"
    fi
    
    # ç¼–è¯‘å™¨çŠ¶æ€
    print_message "$CYAN" "ç¼–è¯‘å™¨çŠ¶æ€ï¼š"
    if check_command "cc"; then
        print_message "$GREEN" "- ccé“¾æ¥å™¨: $(which cc)"
    else
        print_message "$RED" "- ccé“¾æ¥å™¨: æœªæ‰¾åˆ°"
    fi
    
    if check_command "gcc"; then
        print_message "$GREEN" "- gccç¼–è¯‘å™¨: $(which gcc)"
    else
        print_message "$RED" "- gccç¼–è¯‘å™¨: æœªæ‰¾åˆ°"
    fi
    
    # OOMå†å²
    local oom_count=$(dmesg | grep -c "killed process" || echo "0")
    if [ "$oom_count" -gt 0 ]; then
        print_message "$YELLOW" "- OOMäº‹ä»¶: ${oom_count}æ¬¡ï¼ˆå¯èƒ½å¯¼è‡´Exit 143ï¼‰"
    else
        print_message "$GREEN" "- OOMäº‹ä»¶: æ— "
    fi
}

# å¤‡ä»½é’±åŒ…
backup_wallet() {
    print_message "$GREEN" ">>> å¤‡ä»½é’±åŒ…å¯†é’¥"
    
    local backup_file="$BACKUP_DIR/complete_backup_$(date +%Y%m%d_%H%M%S).tar.gz"
    mkdir -p "$BACKUP_DIR"
    
    cd "$NOCKCHAIN_DIR" 2>/dev/null || return 1
    
    # åˆ›å»ºå¤‡ä»½
    tar -czf "$backup_file" .env logs/ *.txt 2>/dev/null || true
    
    if [ -f ".env" ]; then
        cp .env "$BACKUP_DIR/env_$(date +%Y%m%d_%H%M%S).backup"
    fi
    
    print_message "$GREEN" "å¤‡ä»½å®Œæˆ: $backup_file"
}

# ä¸»å¾ªç¯
main() {
    if [ "$EUID" -eq 0 ]; then
        print_message "$RED" "è¯·ä¸è¦ä»¥rootç”¨æˆ·è¿è¡Œ"
        exit 1
    fi
    
    # æ£€æŸ¥bcå‘½ä»¤
    if ! check_command "bc"; then
        print_message "$YELLOW" "å®‰è£…bcè®¡ç®—å™¨..."
        case $(detect_distro) in
            "ubuntu"|"debian"|"mint"|"pop")
                sudo apt install -y bc 2>/dev/null || true
                ;;
            "centos"|"rhel"|"rocky"|"almalinux"|"fedora")
                sudo yum install -y bc 2>/dev/null || sudo dnf install -y bc 2>/dev/null || true
                ;;
        esac
    fi
    
    mkdir -p "$BACKUP_DIR"
    touch "$LOG_FILE"
    log_message "Exit 143ä¿®å¤è„šæœ¬å¯åŠ¨ v8.0"
    
    while true; do
        show_menu
        read -p "è¯·è¾“å…¥é€‰é¡¹ç¼–å·ï¼ˆ1-10ï¼‰: " choice
        
        case $choice in
            1) install_nockchain_exit143_fix ;;
            2) configure_mining_key ;;
            3) start_optimized_mining ;;
            4) view_logs ;;
            5) check_balance ;;
            6) system_monitor ;;
            7) backup_wallet ;;
            8) diagnose_exit143_issues ;;
            9) memory_optimization_tools ;;
            10)
                print_message "$GREEN" "æ„Ÿè°¢ä½¿ç”¨Nockchain Exit 143å®Œå…¨è§£å†³æ–¹æ¡ˆï¼"
                log_message "è„šæœ¬æ­£å¸¸é€€å‡º"
                exit 0
                ;;
            *)
                print_message "$RED" "æ— æ•ˆé€‰é¡¹"
                ;;
        esac
        
        echo
        read -p "æŒ‰å›è½¦é”®ç»§ç»­..." -r
    done
}

# å¯åŠ¨ç¨‹åº
main
