#!/bin/bash

# Nockchain 挖矿工具 - 精简优化版
# 功能：安装、更改挖矿公钥、节点启动和日志查看

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
RESET='\033[0m'

# 配置文件和目录
NOCKCHAIN_DIR="$HOME/.nockchain"
CONFIG_FILE="$NOCKCHAIN_DIR/miner.conf"
LOG_FILE="$NOCKCHAIN_DIR/miner.log"
PID_FILE="$NOCKCHAIN_DIR/miner.pid"

# 创建目录
mkdir -p "$NOCKCHAIN_DIR"

# 检查配置文件是否存在，不存在则创建
if [ ! -f "$CONFIG_FILE" ]; then
  echo "# Nockchain 挖矿配置" > "$CONFIG_FILE"
  echo "MINING_ADDRESS=\"0x0000000000000000000000000000000000000000\"" >> "$CONFIG_FILE"
  echo "RPC_URL=\"http://127.0.0.1:8545\"" >> "$CONFIG_FILE"
  echo "MINING_THREADS=4" >> "$CONFIG_FILE"
fi

# 加载配置
source "$CONFIG_FILE"

# 检查依赖
check_dependencies() {
  echo -e "${CYAN}正在检查系统依赖...${RESET}"
  
  # 检查必要的命令
  for cmd in curl git build-essential; do
    if ! command -v $cmd &> /dev/null; then
      echo -e "${YELLOW}正在安装 $cmd...${RESET}"
      sudo apt-get update
      sudo apt-get install -y $cmd
    fi
  done
  
  # 检查 Rust 环境
  if ! command -v rustc &> /dev/null; then
    echo -e "${YELLOW}Rust 未安装，正在安装...${RESET}"
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    source "$HOME/.cargo/env"
  fi
  
  echo -e "${GREEN}系统依赖检查完成！${RESET}"
}

# 安装 Nockchain
install_nockchain() {
  echo -e "${CYAN}开始安装 Nockchain...${RESET}"
  
  # 检查依赖
  check_dependencies
  
  # 克隆 Nockchain 代码库
  echo -e "${CYAN}正在下载 Nockchain 源代码...${RESET}"
  if [ ! -d "$HOME/nockchain" ]; then
    git clone https://github.com/nockchain/nockchain.git "$HOME/nockchain"
  else
    echo -e "${YELLOW}源代码已存在，正在更新...${RESET}"
    cd "$HOME/nockchain"
    git pull
  fi
  
  # 编译 Nockchain
  echo -e "${CYAN}正在编译 Nockchain...${RESET}"
  cd "$HOME/nockchain"
  cargo build --release
  
  # 复制可执行文件到本地 bin 目录
  mkdir -p "$HOME/.local/bin"
  cp "$HOME/nockchain/target/release/nockchain" "$HOME/.local/bin/"
  
  echo -e "${GREEN}Nockchain 安装完成！${RESET}"
  
  # 提示更改挖矿地址
  echo -e "${YELLOW}请记得使用选项 2 设置您的挖矿公钥！${RESET}"
}

# 更改挖矿公钥
change_mining_key() {
  echo -e "${CYAN}当前挖矿公钥: ${YELLOW}$MINING_ADDRESS${RESET}"
  echo -e "${CYAN}请输入新的挖矿公钥地址 (0x开头的42位地址):${RESET}"
  read -r new_address
  
  # 验证地址格式
  if [[ $new_address =~ ^0x[a-fA-F0-9]{40}$ ]]; then
    # 更新配置文件
    sed -i "s/^MINING_ADDRESS=.*/MINING_ADDRESS=\"$new_address\"/" "$CONFIG_FILE"
    source "$CONFIG_FILE"
    echo -e "${GREEN}挖矿公钥已更新为: ${YELLOW}$MINING_ADDRESS${RESET}"
  else
    echo -e "${RED}无效的地址格式！请输入有效的以太坊格式地址 (0x开头的42位十六进制字符串)${RESET}"
  fi
}

# 启动挖矿节点
start_mining() {
  # 检查是否已安装
  if [ ! -f "$HOME/.local/bin/nockchain" ]; then
    echo -e "${RED}未检测到 Nockchain 安装，请先安装！${RESET}"
    return 1
  fi
  
  # 检查挖矿地址
  if [ "$MINING_ADDRESS" = "0x0000000000000000000000000000000000000000" ]; then
    echo -e "${RED}请先设置有效的挖矿公钥！${RESET}"
    return 1
  fi
  
  # 检查是否已经在运行
  if [ -f "$PID_FILE" ] && ps -p $(cat "$PID_FILE") > /dev/null; then
    echo -e "${YELLOW}挖矿节点已经在运行中！${RESET}"
    return 0
  fi
  
  # 显示当前配置
  echo -e "${CYAN}当前挖矿配置:${RESET}"
  echo -e "  挖矿地址: ${YELLOW}$MINING_ADDRESS${RESET}"
  echo -e "  RPC URL: ${YELLOW}$RPC_URL${RESET}"
  echo -e "  挖矿线程: ${YELLOW}$MINING_THREADS${RESET}"
  
  # 确认启动
  echo -e "${CYAN}是否使用以上配置启动挖矿? (y/n)${RESET}"
  read -r confirm
  if [[ ! $confirm =~ ^[Yy]$ ]]; then
    echo -e "${YELLOW}已取消启动${RESET}"
    return 0
  fi
  
  # 启动挖矿进程
  echo -e "${CYAN}正在启动挖矿节点...${RESET}"
  nohup "$HOME/.local/bin/nockchain" mine --address "$MINING_ADDRESS" --threads "$MINING_THREADS" --rpc "$RPC_URL" > "$LOG_FILE" 2>&1 &
  echo $! > "$PID_FILE"
  
  echo -e "${GREEN}挖矿节点已启动！PID: $(cat "$PID_FILE")${RESET}"
  echo -e "${CYAN}使用选项 4 查看挖矿日志${RESET}"
}

# 查看挖矿日志
view_logs() {
  if [ ! -f "$LOG_FILE" ]; then
    echo -e "${RED}日志文件不存在，请先启动挖矿节点！${RESET}"
    return 1
  fi
  
  echo -e "${CYAN}显示最近的挖矿日志:${RESET}"
  echo -e "${YELLOW}按 Ctrl+C 退出日志查看${RESET}\n"
  
  # 先显示最后50行日志
  tail -n 50 "$LOG_FILE"
  
  # 然后跟踪日志更新
  echo -e "\n${CYAN}正在实时跟踪日志...${RESET}\n"
  tail -f "$LOG_FILE"
}

# 停止挖矿
stop_mining() {
  if [ ! -f "$PID_FILE" ]; then
    echo -e "${YELLOW}没有找到正在运行的挖矿进程${RESET}"
    return 0
  fi
  
  local pid=$(cat "$PID_FILE")
  if ps -p $pid > /dev/null; then
    echo -e "${CYAN}正在停止挖矿进程 (PID: $pid)...${RESET}"
    kill $pid
    rm "$PID_FILE"
    echo -e "${GREEN}挖矿进程已停止${RESET}"
  else
    echo -e "${YELLOW}挖矿进程不存在，可能已经停止${RESET}"
    rm "$PID_FILE"
  fi
}

# 显示菜单
show_menu() {
  clear
  echo -e "${CYAN}╔════════════════════════════════════════════════════════════╗${RESET}"
  echo -e "${CYAN}║                    Nockchain 挖矿工具                      ║${RESET}"
  echo -e "${CYAN}║                      精简优化版                            ║${RESET}"
  echo -e "${CYAN}╚════════════════════════════════════════════════════════════╝${RESET}"
  echo
  echo -e "${YELLOW}适用于 Nockchain ZK-PoW 挖矿${RESET}"
  echo
  echo -e "${CYAN}请选择操作:${RESET}"
  echo
  echo -e " ${GREEN}1)${RESET} 🚀 安装 Nockchain"
  echo -e " ${GREEN}2)${RESET} 🔑 更改挖矿公钥"
  echo -e " ${GREEN}3)${RESET} ⛏️  启动挖矿节点"
  echo -e " ${GREEN}4)${RESET} 📋 查看挖矿日志"
  echo -e " ${GREEN}5)${RESET} 🛑 停止挖矿"
  echo -e " ${GREEN}0)${RESET} 退出"
  echo
  echo -e "${CYAN}请输入选项 [0-5]:${RESET}"
}

# 主循环
main() {
  while true; do
    show_menu
    read -r option
    
    case $option in
      1) install_nockchain ;;
      2) change_mining_key ;;
      3) start_mining ;;
      4) view_logs ;;
      5) stop_mining ;;
      0) echo -e "${GREEN}感谢使用 Nockchain 挖矿工具！${RESET}"; exit 0 ;;
      *) echo -e "${RED}无效选项，请重新选择${RESET}" ;;
    esac
    
    echo
    echo -e "${YELLOW}按回车键继续...${RESET}"
    read -r
  done
}

# 启动主程序
main
