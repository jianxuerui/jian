#!/bin/bash

# ========= è‰²å½©å®šä¹‰ =========
RESET='\033[0m'
BOLD='\033[1m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'

# ========= é¡¹ç›®è·¯å¾„ =========
NCK_DIR="$HOME/nockchain"
ENV_FILE="$NCK_DIR/.env"

# ========= å·¥ä½œç›®å½•ä¿®å¤ =========
function fix_working_directory() {
  if ! pwd >/dev/null 2>&1; then
    echo -e "${YELLOW}[!] å½“å‰å·¥ä½œç›®å½•æ— æ³•è®¿é—®ï¼Œåˆ‡æ¢åˆ°HOMEç›®å½•...${RESET}"
    cd "$HOME" || cd / || {
      echo -e "${RED}[-] æ— æ³•è®¿é—®ä»»ä½•æœ‰æ•ˆç›®å½•${RESET}"
      exit 1
    }
  fi
  
  current_dir=$(pwd 2>/dev/null)
  if [ -z "$current_dir" ] || [ ! -d "$current_dir" ]; then
    echo -e "${YELLOW}[!] å·¥ä½œç›®å½•å¼‚å¸¸ï¼Œé‡ç½®åˆ°HOMEç›®å½•...${RESET}"
    cd "$HOME" || cd / || exit 1
  fi
  
  echo -e "${GREEN}[+] å·¥ä½œç›®å½•æ£€æŸ¥å®Œæˆ: $(pwd)${RESET}"
}

# ========= å…¼å®¹æ€§æ£€æµ‹ =========
function check_system() {
  if [[ "$OSTYPE" == "linux-gnu"* ]]; then
    OS="linux"
  elif [[ "$OSTYPE" == "darwin"* ]]; then
    OS="macos"
    echo -e "${YELLOW}[!] æ£€æµ‹åˆ° macOSï¼ŒæŸäº›ä¼˜åŒ–åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨${RESET}"
  else
    OS="unknown"
    echo -e "${YELLOW}[!] æœªçŸ¥æ“ä½œç³»ç»Ÿï¼Œè¯·è°¨æ…ä½¿ç”¨${RESET}"
  fi
  
  if ! sudo -n true 2>/dev/null; then
    echo -e "${YELLOW}[!] éœ€è¦sudoæƒé™è¿›è¡Œç³»ç»Ÿä¼˜åŒ–${RESET}"
  fi
}

# ========= æ¨ªå¹… =========
function show_banner() {
  clear
  echo -e "${BOLD}${BLUE}"
  echo "==============================================="
  echo "         Nockchain æŒ–çŸ¿ä¼˜åŒ–åŠ©æ‰‹ v2.4"
  echo "==============================================="
  echo -e "${RESET}"
  echo "ğŸ“Œ ä½œè€…: K2 èŠ‚ç‚¹æ•™ç¨‹åˆ†äº«"
  echo "ğŸ”— Telegram: https://t.me/+EaCiFDOghoM3Yzll"
  echo "ğŸ¦ Twitter:  https://x.com/BtcK241918"
  echo "âš¡ ä¼˜åŒ–ç‰ˆæœ¬: ä¿®å¤æ„å»ºé—®é¢˜ + Cargoç¼“å­˜æ¸…ç†"
  echo "-----------------------------------------------"
  echo ""
}

function cd_nck_dir() {
  if [ -d "$NCK_DIR" ]; then
    cd "$NCK_DIR" || {
      echo -e "${RED}[-] æ— æ³•è¿›å…¥é¡¹ç›®ç›®å½•: $NCK_DIR${RESET}"
      exit 1
    }
  else
    echo -e "${RED}[-] é¡¹ç›®ç›®å½•ä¸å­˜åœ¨: $NCK_DIR${RESET}"
    exit 1
  fi
}

function optimize_system() {
  echo -e "${YELLOW}[*] åº”ç”¨ç³»ç»Ÿçº§æ€§èƒ½ä¼˜åŒ–...${RESET}"
  
  check_system
  
  if [[ "$OS" == "linux" ]]; then
    cpu_gov_files=$(find /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor 2>/dev/null || true)
    
    if [ -n "$cpu_gov_files" ]; then
      echo "$cpu_gov_files" | while read -r gov; do
        if [ -w "$gov" ] && [ -f "$gov" ]; then
          echo performance | sudo tee "$gov" >/dev/null 2>&1 || true
        fi
      done
      echo -e "${GREEN}[+] CPUæ€§èƒ½æ¨¡å¼å·²è®¾ç½®${RESET}"
    else
      echo -e "${YELLOW}[!] æœªæ‰¾åˆ°CPUè°ƒé€Ÿå™¨æ–‡ä»¶ï¼Œè·³è¿‡CPUä¼˜åŒ–${RESET}"
    fi
    
    if command -v sysctl >/dev/null 2>&1; then
      sudo sysctl -w net.core.rmem_max=16777216 >/dev/null 2>&1 || true
      sudo sysctl -w net.core.wmem_max=16777216 >/dev/null 2>&1 || true
      echo -e "${GREEN}[+] ç½‘ç»œå‚æ•°ä¼˜åŒ–å®Œæˆ${RESET}"
    else
      echo -e "${YELLOW}[!] sysctlå‘½ä»¤ä¸å¯ç”¨ï¼Œè·³è¿‡ç½‘ç»œä¼˜åŒ–${RESET}"
    fi
  else
    echo -e "${YELLOW}[!] éLinuxç³»ç»Ÿï¼Œè·³è¿‡ç³»ç»Ÿçº§ä¼˜åŒ–${RESET}"
  fi
  
  echo -e "${GREEN}[+] ç³»ç»Ÿä¼˜åŒ–å®Œæˆ${RESET}"
}

function install_dependencies() {
  echo -e "[*] å®‰è£…ç³»ç»Ÿä¾èµ–..."
  
  if [[ "$OS" == "linux" ]]; then
    if command -v apt >/dev/null 2>&1; then
      sudo apt update -qq
      sudo apt install -y clang llvm-dev libclang-dev pkg-config libssl-dev build-essential cmake curl git make screen htop unzip
    elif command -v yum >/dev/null 2>&1; then
      sudo yum groupinstall -y "Development Tools"
      sudo yum install -y clang llvm-devel openssl-devel cmake curl git make screen htop unzip
    elif command -v pacman >/dev/null 2>&1; then
      sudo pacman -S --noconfirm clang llvm pkg-config openssl cmake curl git make screen htop unzip
    else
      echo -e "${RED}[-] æœªè¯†åˆ«çš„åŒ…ç®¡ç†å™¨ï¼Œè¯·æ‰‹åŠ¨å®‰è£…ä¾èµ–${RESET}"
      return 1
    fi
  elif [[ "$OS" == "macos" ]]; then
    if command -v brew >/dev/null 2>&1; then
      brew install llvm openssl cmake curl git make screen htop unzip
    else
      echo -e "${RED}[-] è¯·å…ˆå®‰è£… Homebrew${RESET}"
      return 1
    fi
  fi
  
  echo -e "${GREEN}[+] ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ${RESET}"
  return 0
}

function clean_cargo_cache() {
  echo -e "[*] æ¸…ç†Cargoç¼“å­˜..."
  
  # æ¸…ç†registryç¼“å­˜
  if [ -d "$HOME/.cargo/registry" ]; then
    echo -e "${YELLOW}[*] æ¸…ç†registryç¼“å­˜...${RESET}"
    rm -rf "$HOME/.cargo/registry/cache"
    rm -rf "$HOME/.cargo/registry/src"
  fi
  
  # æ¸…ç†gitç¼“å­˜
  if [ -d "$HOME/.cargo/git" ]; then
    echo -e "${YELLOW}[*] æ¸…ç†gitç¼“å­˜...${RESET}"
    rm -rf "$HOME/.cargo/git/db"
    rm -rf "$HOME/.cargo/git/checkouts"
  fi
  
  # æ›´æ–°cargo index
  cargo search --limit 0 >/dev/null 2>&1 || true
  
  echo -e "${GREEN}[+] Cargoç¼“å­˜æ¸…ç†å®Œæˆ${RESET}"
}

function setup_rust() {
  echo -e "[*] å®‰è£… Rust å·¥å…·é“¾..."
  
  if ! command -v cargo &>/dev/null; then
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    source "$HOME/.cargo/env"
  fi

  # æ›´æ–°Rustå·¥å…·é“¾
  rustup update stable >/dev/null 2>&1 || true
  
  # é…ç½®ç¯å¢ƒå˜é‡
  for rc_file in "$HOME/.bashrc" "$HOME/.zshrc" "$HOME/.profile"; do
    if [ -f "$rc_file" ] && ! grep -q 'export PATH="$HOME/.cargo/bin:$PATH"' "$rc_file"; then
      echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> "$rc_file"
    fi
  done
  
  # ç¡®ä¿å½“å‰ä¼šè¯å¯ç”¨
  export PATH="$HOME/.cargo/bin:$PATH"
  source "$HOME/.cargo/env" 2>/dev/null || true
  
  # æ¸…ç†ç¼“å­˜
  clean_cargo_cache
  
  echo -e "${GREEN}[+] Rustå·¥å…·é“¾å®‰è£…å®Œæˆ${RESET}"
}

function safe_remove_directory() {
  local dir="$1"
  if [ -d "$dir" ]; then
    echo -e "${YELLOW}[*] å®‰å…¨åˆ é™¤ç›®å½•: $dir${RESET}"
    if [[ "$(pwd)" == "$dir"* ]]; then
      cd "$HOME" || cd /
    fi
    rm -rf "$dir"
  fi
}

function clone_repository() {
  echo -e "[*] è·å–Nockchainä»“åº“..."
  
  fix_working_directory
  cd "$HOME" || {
    echo -e "${RED}[-] æ— æ³•è®¿é—®HOMEç›®å½•${RESET}"
    return 1
  }
  
  if [ -d "$NCK_DIR" ]; then
    echo -e "${YELLOW}[*] å‘ç°ç°æœ‰ç›®å½•ï¼Œæ£€æŸ¥gitä»“åº“çŠ¶æ€...${RESET}"
    
    cd "$NCK_DIR" 2>/dev/null && {
      if git status >/dev/null 2>&1; then
        echo -e "${YELLOW}[*] å‘ç°æœ‰æ•ˆgitä»“åº“ï¼Œå°è¯•æ›´æ–°...${RESET}"
        if git pull origin main 2>/dev/null || git pull origin master 2>/dev/null; then
          echo -e "${GREEN}[+] ä»“åº“æ›´æ–°æˆåŠŸ${RESET}"
          return 0
        else
          echo -e "${YELLOW}[!] æ›´æ–°å¤±è´¥ï¼Œé‡æ–°å…‹éš†...${RESET}"
        fi
      else
        echo -e "${YELLOW}[!] ç›®å½•å­˜åœ¨ä½†ä¸æ˜¯gitä»“åº“ï¼Œé‡æ–°å…‹éš†...${RESET}"
      fi
    } || {
      echo -e "${YELLOW}[!] æ— æ³•è®¿é—®ç°æœ‰ç›®å½•ï¼Œé‡æ–°å…‹éš†...${RESET}"
    }
    
    cd "$HOME"
    safe_remove_directory "$NCK_DIR"
  fi
  
  cd "$HOME" || {
    echo -e "${RED}[-] æ— æ³•è®¿é—®HOMEç›®å½•è¿›è¡Œå…‹éš†${RESET}"
    return 1
  }
  
  echo -e "[*] å¼€å§‹å…‹éš†ä»“åº“åˆ°: $NCK_DIR"
  
  clone_success=false
  
  if git clone https://github.com/zorp-corp/nockchain "$NCK_DIR" 2>/dev/null; then
    clone_success=true
  else
    echo -e "${YELLOW}[!] HTTPSå…‹éš†å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•...${RESET}"
    
    mkdir -p "$NCK_DIR" 2>/dev/null
    if cd "$NCK_DIR" 2>/dev/null; then
      if git clone https://github.com/zorp-corp/nockchain . 2>/dev/null; then
        clone_success=true
      else
        cd "$HOME"
        safe_remove_directory "$NCK_DIR"
        
        echo -e "${YELLOW}[!] Gitå…‹éš†å¤±è´¥ï¼Œå°è¯•ä¸‹è½½zipåŒ…...${RESET}"
        if curl -L "https://github.com/zorp-corp/nockchain/archive/refs/heads/main.zip" -o nockchain.zip 2>/dev/null; then
          if command -v unzip >/dev/null 2>&1; then
            unzip -q nockchain.zip && mv nockchain-main "$NCK_DIR" 2>/dev/null && {
              rm -f nockchain.zip
              clone_success=true
            }
          else
            echo -e "${RED}[-] éœ€è¦unzipå‘½ä»¤æ¥è§£å‹æ–‡ä»¶${RESET}"
          fi
        fi
      fi
    fi
  fi
  
  if [ "$clone_success" = true ] && [ -d "$NCK_DIR" ]; then
    cd "$NCK_DIR"
    echo -e "${GREEN}[+] ä»“åº“è·å–æˆåŠŸ${RESET}"
    return 0
  else
    echo -e "${RED}[-] ä»“åº“è·å–å¤±è´¥${RESET}"
    return 1
  fi
}

function build_hoonc() {
  echo -e "[*] æ„å»ºhooncå·¥å…·..."
  
  cd_nck_dir
  
  # æ£€æŸ¥hooncç›®å½•
  if [ ! -d "crates/hoonc" ]; then
    echo -e "${YELLOW}[!] æœªæ‰¾åˆ°hooncæºç ç›®å½•${RESET}"
    return 1
  fi
  
  # å°è¯•å¤šç§æ–¹å¼æ„å»ºhoonc
  hoonc_success=false
  
  # æ–¹æ³•1: ç›´æ¥cargo install
  echo -e "[*] å°è¯•ç›´æ¥å®‰è£…hoonc..."
  if cargo install --path crates/hoonc --bin hoonc --force; then
    hoonc_success=true
    echo -e "${GREEN}[+] hooncå®‰è£…æˆåŠŸ (æ–¹æ³•1)${RESET}"
  else
    echo -e "${YELLOW}[!] æ–¹æ³•1å¤±è´¥ï¼Œå°è¯•ä¸ä½¿ç”¨é”å®š...${RESET}"
    
    # æ–¹æ³•2: ä¸ä½¿ç”¨lockedå‚æ•°
    if cargo install --path crates/hoonc --bin hoonc --force --no-default-features; then
      hoonc_success=true
      echo -e "${GREEN}[+] hooncå®‰è£…æˆåŠŸ (æ–¹æ³•2)${RESET}"
    else
      echo -e "${YELLOW}[!] æ–¹æ³•2å¤±è´¥ï¼Œå°è¯•æœ¬åœ°æ„å»º...${RESET}"
      
      # æ–¹æ³•3: æœ¬åœ°æ„å»º
      cd crates/hoonc
      if cargo build --release --bin hoonc; then
        # æ‰‹åŠ¨å¤åˆ¶åˆ°cargo binç›®å½•
        mkdir -p "$HOME/.cargo/bin"
        cp target/release/hoonc "$HOME/.cargo/bin/" 2>/dev/null || {
          cp ../../target/release/hoonc "$HOME/.cargo/bin/" 2>/dev/null
        }
        hoonc_success=true
        echo -e "${GREEN}[+] hooncæ„å»ºæˆåŠŸ (æ–¹æ³•3)${RESET}"
      fi
      cd "$NCK_DIR"
    fi
  fi
  
  # éªŒè¯hooncæ˜¯å¦å¯ç”¨
  if command -v hoonc >/dev/null 2>&1; then
    echo -e "${GREEN}[+] hooncå·¥å…·éªŒè¯æˆåŠŸ${RESET}"
    return 0
  elif [ -f "$HOME/.cargo/bin/hoonc" ]; then
    echo -e "${GREEN}[+] hooncå·²å®‰è£…åˆ° $HOME/.cargo/bin/hoonc${RESET}"
    return 0
  else
    echo -e "${YELLOW}[!] hooncæ„å»ºå¯èƒ½å¤±è´¥ï¼Œä½†ç»§ç»­å°è¯•ä¸»é¡¹ç›®æ„å»º${RESET}"
    return 1
  fi
}

function build_project() {
  echo -e "[*] å¼€å§‹æ„å»ºNockchainé¡¹ç›®..."
  
  cd_nck_dir
  
  # è®¾ç½®ä¼˜åŒ–ç¼–è¯‘å‚æ•°
  export RUSTFLAGS="-C target-cpu=native -C opt-level=3 -C codegen-units=1"
  if rustc --print target-features 2>/dev/null | grep -q lto; then
    export RUSTFLAGS="$RUSTFLAGS -C lto=fat"
    export CARGO_PROFILE_RELEASE_LTO=true
  fi
  export CARGO_PROFILE_RELEASE_CODEGEN_UNITS=1
  export CARGO_PROFILE_RELEASE_PANIC="abort"
  
  # é¦–å…ˆå°è¯•æ„å»ºhoonc
  build_hoonc
  
  echo -e "[*] æ„å»ºä¸»é¡¹ç›®..."
  
  # æ¸…ç†ä¹‹å‰çš„æ„å»º
  cargo clean >/dev/null 2>&1 || true
  
  # æ›´æ–°ä¾èµ–
  echo -e "[*] æ›´æ–°é¡¹ç›®ä¾èµ–..."
  cargo update >/dev/null 2>&1 || true
  
  # å°è¯•Cargoæ„å»º
  if [ -f "Cargo.toml" ]; then
    echo -e "[*] ä½¿ç”¨Cargoæ„å»ºé¡¹ç›®..."
    
    # å°è¯•å®Œæ•´æ„å»º
    if cargo build --release 2>/dev/null; then
      echo -e "${GREEN}[+] é¡¹ç›®æ„å»ºæˆåŠŸ${RESET}"
      
      # æ£€æŸ¥ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶
      if [ -f "target/release/nockchain-wallet" ]; then
        echo -e "${GREEN}[+] é’±åŒ…ç¨‹åºæ„å»ºæˆåŠŸ${RESET}"
      fi
      
      if [ -f "target/release/nockchain" ] || [ -f "target/release/nockchain-miner" ]; then
        echo -e "${GREEN}[+] èŠ‚ç‚¹ç¨‹åºæ„å»ºæˆåŠŸ${RESET}"
      fi
      
      return 0
    else
      echo -e "${YELLOW}[!] å®Œæ•´æ„å»ºå¤±è´¥ï¼Œå°è¯•å•ç‹¬æ„å»ºç»„ä»¶...${RESET}"
      
      # å°è¯•æ„å»ºå·¥ä½œåŒºä¸­çš„æ‰€æœ‰åŒ…
      for package in $(cargo metadata --format-version 1 2>/dev/null | grep '"name"' | cut -d'"' -f4 | head -10); do
        echo -e "[*] å°è¯•æ„å»ºåŒ…: $package"
        cargo build --release --package "$package" 2>/dev/null && {
          echo -e "${GREEN}[+] åŒ… $package æ„å»ºæˆåŠŸ${RESET}"
        } || {
          echo -e "${YELLOW}[!] åŒ… $package æ„å»ºå¤±è´¥${RESET}"
        }
      done
    fi
  fi
  
  # å°è¯•Makefileæ„å»º
  if [ -f "Makefile" ]; then
    echo -e "[*] å°è¯•ä½¿ç”¨Makefileæ„å»º..."
    
    # ä¿®å¤Makefileä¸­çš„é—®é¢˜
    if grep -q "cargo install --locked" Makefile; then
      echo -e "[*] ä¿®å¤Makefileä¸­çš„é”å®šå‚æ•°..."
      sed -i.bak 's/cargo install --locked/cargo install --force/g' Makefile 2>/dev/null || true
    fi
    
    for target in "build" "all" "release" "build-release" "install" "compile"; do
      if make -n "$target" >/dev/null 2>&1; then
        echo -e "[*] å°è¯•æ„å»ºç›®æ ‡: $target"
        if make "$target" 2>/dev/null; then
          echo -e "${GREEN}[+] æ„å»ºæˆåŠŸ (ç›®æ ‡: $target)${RESET}"
          return 0
        fi
      fi
    done
  fi
  
  # æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•äºŒè¿›åˆ¶æ–‡ä»¶ç”Ÿæˆ
  if find . -name "nockchain*" -type f -executable 2>/dev/null | grep -q .; then
    echo -e "${GREEN}[+] å‘ç°å·²æ„å»ºçš„äºŒè¿›åˆ¶æ–‡ä»¶${RESET}"
    return 0
  fi
  
  echo -e "${YELLOW}[!] æ„å»ºå¯èƒ½æœ‰é—®é¢˜ï¼Œä½†å¯ä»¥ç»§ç»­é…ç½®${RESET}"
  return 1
}

function setup_environment() {
  echo -e "[*] è®¾ç½®ç¯å¢ƒé…ç½®..."
  cd_nck_dir
  
  # åˆ›å»º.envæ–‡ä»¶
  if [ -f ".env.example" ] || [ -f ".env_example" ]; then
    if [ -f ".env.example" ]; then
      cp -n .env.example "$ENV_FILE"
    else
      cp -n .env_example "$ENV_FILE"
    fi
    echo -e "${GREEN}[+] ä»ç¤ºä¾‹æ–‡ä»¶åˆ›å»º.env${RESET}"
  else
    echo -e "${YELLOW}[!] æœªæ‰¾åˆ°ç¤ºä¾‹æ–‡ä»¶ï¼Œåˆ›å»ºåŸºæœ¬.envæ–‡ä»¶${RESET}"
    cat > "$ENV_FILE" << 'EOF'
# Nockchain Configuration
MINING_PUBKEY=
RUST_LOG=info
EOF
  fi
  
  echo -e "${GREEN}[+] ç¯å¢ƒé…ç½®å®Œæˆ${RESET}"
}

function setup_all() {
  echo -e "[*] å¼€å§‹ä¼˜åŒ–å®‰è£…æµç¨‹..."
  
  fix_working_directory
  optimize_system
  
  if ! install_dependencies; then
    echo -e "${RED}[-] ä¾èµ–å®‰è£…å¤±è´¥${RESET}"
    pause_and_return
    return
  fi
  
  setup_rust
  
  if ! clone_repository; then
    echo -e "${RED}[-] ä»“åº“è·å–å¤±è´¥${RESET}"
    echo -e "${YELLOW}[!] è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–æ‰‹åŠ¨ä¸‹è½½é¡¹ç›®${RESET}"
    pause_and_return
    return
  fi
  
  setup_environment
  
  if build_project; then
    echo -e "${GREEN}[+] é¡¹ç›®å®‰è£…å®Œæˆï¼${RESET}"
  else
    echo -e "${YELLOW}[!] æ„å»ºå¯èƒ½æœ‰é—®é¢˜ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥${RESET}"
  fi
  
  pause_and_return
}

function generate_wallet() {
  echo -e "[*] ç”Ÿæˆé’±åŒ…..."
  cd_nck_dir
  
  # æŸ¥æ‰¾é’±åŒ…äºŒè¿›åˆ¶æ–‡ä»¶
  wallet_bin=""
  for path in "./target/release/nockchain-wallet" "./nockchain-wallet" "/usr/local/bin/nockchain-wallet" "$HOME/.cargo/bin/nockchain-wallet"; do
    if [ -f "$path" ] && [ -x "$path" ]; then
      wallet_bin="$path"
      break
    fi
  done
  
  if [ -z "$wallet_bin" ]; then
    echo -e "${RED}[-] æœªæ‰¾åˆ°nockchain-walletäºŒè¿›åˆ¶æ–‡ä»¶${RESET}"
    echo -e "${YELLOW}[!] è¯·å…ˆå®Œæˆé¡¹ç›®æ„å»º${RESET}"
    pause_and_return
    return
  fi
  
  echo -e "${GREEN}[+] ä½¿ç”¨é’±åŒ…: $wallet_bin${RESET}"
  "$wallet_bin" keygen
  
  echo -e "${YELLOW}[!] é’±åŒ…ç”Ÿæˆå®Œæˆï¼Œè¯·å¤åˆ¶ä¸Šæ–¹å…¬é’¥åˆ°ä¸‹ä¸€æ­¥è®¾ç½®ä¸­${RESET}"
  echo -e "${BLUE}[i] å…¬é’¥æ ¼å¼ä¸º128ä½16è¿›åˆ¶å­—ç¬¦ä¸²${RESET}"
  pause_and_return
}

function validate_pubkey() {
  local pubkey="$1"
  
  if [ ${#pubkey} -ne 128 ]; then
    echo -e "${RED}[-] å…¬é’¥é•¿åº¦é”™è¯¯ï¼åº”ä¸º128ä½ï¼Œå½“å‰ä¸º${#pubkey}ä½${RESET}"
    return 1
  fi
  
  if [[ ! "$pubkey" =~ ^[0-9a-fA-F]{128}$ ]]; then
    echo -e "${RED}[-] å…¬é’¥æ ¼å¼é”™è¯¯ï¼åªèƒ½åŒ…å«0-9å’Œa-få­—ç¬¦${RESET}"
    return 1
  fi
  
  return 0
}

function set_pubkey_env() {
  echo -e "[*] è®¾ç½® MINING_PUBKEY åˆ° .env..."
  cd_nck_dir

  echo -e "${BLUE}[i] å…¬é’¥æ ¼å¼è¦æ±‚ï¼š128ä½16è¿›åˆ¶å­—ç¬¦ä¸²${RESET}"
  echo -e "${BLUE}[i] ç¤ºä¾‹æ ¼å¼ï¼šd24c0c53d1162325eba695f32b7194f4c9b2943441a3162837922d36f3325c341ce049e7b3992080a9603e91147e4529f79261a355e16570c975a6c0e81716e3${RESET}"
  echo ""
  
  while true; do
    read -p "è¯·è¾“å…¥å…¬é’¥ (MINING_PUBKEY): " pubkey
    
    if [ -z "$pubkey" ]; then
      echo -e "${RED}[-] å…¬é’¥ä¸èƒ½ä¸ºç©º${RESET}"
      continue
    fi
    
    pubkey=$(echo "$pubkey" | tr -d ' \n\r\t')
    
    if validate_pubkey "$pubkey"; then
      pubkey=$(echo "$pubkey" | tr '[:upper:]' '[:lower:]')
      
      if command -v sed >/dev/null 2>&1; then
        sed -i '/^MINING_PUBKEY=/d' "$ENV_FILE" 2>/dev/null || {
          grep -v '^MINING_PUBKEY=' "$ENV_FILE" > "$ENV_FILE.tmp" && mv "$ENV_FILE.tmp" "$ENV_FILE"
        }
      else
        grep -v '^MINING_PUBKEY=' "$ENV_FILE" > "$ENV_FILE.tmp" && mv "$ENV_FILE.tmp" "$ENV_FILE"
      fi
      echo "MINING_PUBKEY=$pubkey" >> "$ENV_FILE"
      
      echo -e "${GREEN}[+] å…¬é’¥æ ¼å¼éªŒè¯é€šè¿‡ï¼Œå·²å†™å…¥ .env æ–‡ä»¶${RESET}"
      echo -e "${GREEN}[+] å…¬é’¥: $pubkey${RESET}"
      break
    else
      echo -e "${YELLOW}[!] è¯·é‡æ–°è¾“å…¥æ­£ç¡®æ ¼å¼çš„å…¬é’¥${RESET}"
    fi
  done
  
  pause_and_return
}

function export_keys() {
  echo -e "[*] å¯¼å‡ºé’±åŒ…å¯†é’¥..."
  cd_nck_dir
  
  wallet_bin=""
  for path in "./target/release/nockchain-wallet" "./nockchain-wallet" "/usr/local/bin/nockchain-wallet" "$HOME/.cargo/bin/nockchain-wallet"; do
    if [ -f "$path" ] && [ -x "$path" ]; then
      wallet_bin="$path"
      break
    fi
  done
  
  if [ -z "$wallet_bin" ]; then
    echo -e "${RED}[-] æœªæ‰¾åˆ°nockchain-walletäºŒè¿›åˆ¶æ–‡ä»¶${RESET}"
    pause_and_return
    return
  fi
  
  "$wallet_bin" export-keys
  echo -e "${GREEN}[+] å¯†é’¥å·²å¯¼å‡ºåˆ° keys.export${RESET}"
  pause_and_return
}

function import_keys() {
  echo -e "[*] å¯¼å…¥é’±åŒ…å¯†é’¥..."
  cd_nck_dir
  
  wallet_bin=""
  for path in "./target/release/nockchain-wallet" "./nockchain-wallet" "/usr/local/bin/nockchain-wallet" "$HOME/.cargo/bin/nockchain-wallet"; do
    if [ -f "$path" ] && [ -x "$path" ]; then
      wallet_bin="$path"
      break
    fi
  done
  
  if [ -z "$wallet_bin" ]; then
    echo -e "${RED}[-] æœªæ‰¾åˆ°nockchain-walletäºŒè¿›åˆ¶æ–‡ä»¶${RESET}"
    pause_and_return
    return
  fi
  
  read -p "[?] è¯·è¾“å…¥å¯†é’¥æ–‡ä»¶è·¯å¾„ (é»˜è®¤: ./keys.export): " keyfile
  keyfile=${keyfile:-"./keys.export"}
  
  if [ -f "$keyfile" ]; then
    "$wallet_bin" import-keys --input "$keyfile"
    echo -e "${GREEN}[+] å¯†é’¥å·²å¯¼å…¥${RESET}"
  else
    echo -e "${RED}[-] å¯†é’¥æ–‡ä»¶ä¸å­˜åœ¨: $keyfile${RESET}"
  fi
  pause_and_return
}

function start_node() {
  echo -e "[*] å¯åŠ¨ä¼˜åŒ–èŠ‚ç‚¹..."
  cd_nck_dir
  
  if [ ! -f "$ENV_FILE" ]; then
    echo -e "${RED}[-] .envæ–‡ä»¶ä¸å­˜åœ¨${RESET}"
    pause_and_return
    return
  fi
  
  source "$ENV_FILE"

  if [ -z "$MINING_PUBKEY" ]; then
    echo -e "${RED}[-] æœªè®¾ç½® MINING_PUBKEYï¼Œè¯·å…ˆè®¾ç½®æŒ–çŸ¿å…¬é’¥${RESET}"
    pause_and_return
    return
  fi

  # æŸ¥æ‰¾èŠ‚ç‚¹äºŒè¿›åˆ¶æ–‡ä»¶
  node_bin=""
  for path in "./target/release/nockchain" "./target/release/nockchain-miner" "./nockchain" "./nockchain-miner" "/usr/local/bin/nockchain" "$HOME/.cargo/bin/nockchain"; do
    if [ -f "$path" ] && [ -x "$path" ]; then
      node_bin="$path"
      break
    fi
  done
  
  if [ -z "$node_bin" ]; then
    echo -e "${RED}[-] æœªæ‰¾åˆ°èŠ‚ç‚¹äºŒè¿›åˆ¶æ–‡ä»¶${RESET}"
    echo -e "${YELLOW}[!] è¯·å…ˆå®Œæˆé¡¹ç›®æ„å»º${RESET}"
    pause_and_return
    return
  fi

  echo -e "${GREEN}[+] ä½¿ç”¨èŠ‚ç‚¹: $node_bin${RESET}"

  # æ£€æŸ¥å¯åŠ¨è„šæœ¬æˆ–ç›´æ¥è¿è¡Œ
  if [ -f "./scripts/run_nockchain_miner.sh" ]; then
    chmod +x ./scripts/run_nockchain_miner.sh
    start_script="./scripts/run_nockchain_miner.sh"
  else
    start_script="$node_bin"
  fi

  if ! command -v screen >/dev/null 2>&1; then
    echo -e "${YELLOW}[!] screenæœªå®‰è£…ï¼Œç›´æ¥åå°å¯åŠ¨...${RESET}"
    nohup "$start_script" > nockchain.log 2>&1 &
    echo -e "${GREEN}[+] èŠ‚ç‚¹å·²åå°å¯åŠ¨ï¼Œæ—¥å¿—æ–‡ä»¶: nockchain.log${RESET}"
  else
    if screen -list | grep -qw "nockchain"; then
      echo "[*] å…³é—­æ—§çš„ screen ä¼šè¯..."
      screen -S nockchain -X quit >/dev/null 2>&1
      sleep 2
    fi

    screen -dmS nockchain bash -c "cd '$NCK_DIR' && '$start_script'"

    sleep 3
    if screen -list | grep -qw "nockchain"; then
      echo -e "${GREEN}[+] èŠ‚ç‚¹å·²å¯åŠ¨ (screen ä¼šè¯å: nockchain)${RESET}"
      echo -e "${GREEN}[+] ä½¿ç”¨å…¬é’¥: $MINING_PUBKEY${RESET}"
      echo -e "${YELLOW}[!] ä½¿ç”¨ 'screen -r nockchain' æŸ¥çœ‹æ—¥å¿—${RESET}"
    else
      echo -e "${RED}[-] èŠ‚ç‚¹å¯åŠ¨å¤±è´¥${RESET}"
      echo "è¯·æ£€æŸ¥é”™è¯¯æ—¥å¿—"
    fi
  fi
  
  pause_and_return
}

function view_logs() {
  if command -v screen >/dev/null 2>&1 && screen -list | grep -qw "nockchain"; then
    echo -e "${YELLOW}[!] è¿›å…¥æ—¥å¿—æŸ¥çœ‹ (Ctrl+A+D å¯é€€å‡º)...${RESET}"
    screen -r nockchain
  elif [ -f "$NCK_DIR/nockchain.log" ]; then
    echo -e "${YELLOW}[!] æ˜¾ç¤ºæœ€è¿‘æ—¥å¿— (æŒ‰qé€€å‡º):${RESET}"
    tail -f "$NCK_DIR/nockchain.log"
  else
    echo -e "${RED}[-] èŠ‚ç‚¹æœªè¿è¡Œä¸”æ— æ—¥å¿—æ–‡ä»¶${RESET}"
  fi
  pause_and_return
}

function check_status() {
  echo -e "[*] æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€..."
  
  cd_nck_dir
  if [ -f "$ENV_FILE" ]; then
    source "$ENV_FILE" >/dev/null 2>&1
    if [ -n "$MINING_PUBKEY" ]; then
      echo -e "${GREEN}[+] å·²é…ç½®å…¬é’¥: ${MINING_PUBKEY:0:16}...${MINING_PUBKEY: -16}${RESET}"
    else
      echo -e "${YELLOW}[!] æœªè®¾ç½®æŒ–çŸ¿å…¬é’¥${RESET}"
    fi
  fi
  
  running=false
  if command -v screen >/dev/null 2>&1 && screen -list | grep -qw "nockchain"; then
    echo -e "${GREEN}[+] èŠ‚ç‚¹è¿è¡Œä¸­ (screenæ¨¡å¼)${RESET}"
    running=true
  elif pgrep -f "nockchain" >/dev/null 2>&1; then
    echo -e "${GREEN}[+] èŠ‚ç‚¹è¿è¡Œä¸­ (åå°æ¨¡å¼)${RESET}"
    running=true
  else
    echo -e "${RED}[-] èŠ‚ç‚¹æœªè¿è¡Œ${RESET}"
  fi
  
  if [ "$running" = true ]; then
    echo -e "${YELLOW}[*] ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ:${RESET}"
    if command -v htop >/dev/null 2>&1; then
      echo -e "${YELLOW}[*] å¯åŠ¨htopç›‘æ§ (5ç§’åè‡ªåŠ¨è¿”å›):${RESET}"
      timeout 5 htop -d 1 2>/dev/null || true
    elif command -v top >/dev/null 2>&1; then
      echo -e "${YELLOW}[*] CPUå’Œå†…å­˜ä½¿ç”¨æƒ…å†µ:${RESET}"
      top -b -n1 | head -20
    fi
  fi
  
  pause_and_return
}

function stop_node() {
  echo -e "[*] åœæ­¢èŠ‚ç‚¹..."
  stopped=false
  
  if command -v screen >/dev/null 2>&1 && screen -list | grep -qw "nockchain"; then
    screen -S nockchain -X quit >/dev/null 2>&1
    sleep 2
    stopped=true
  fi
  
  if pgrep -f "nockchain" >/dev/null 2>&1; then
    pkill -f "nockchain" >/dev/null 2>&1
    sleep 2
    stopped=true
  fi
  
  if [ "$stopped" = true ]; then
    echo -e "${GREEN}[+] èŠ‚ç‚¹å·²åœæ­¢${RESET}"
  else
    echo -e "${YELLOW}[!] èŠ‚ç‚¹æœªè¿è¡Œ${RESET}"
  fi
  pause_and_return
}

function pause_and_return() {
  echo ""
  read -n1 -r -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..." key
  main_menu
}

function main_menu() {
  show_banner
  echo "è¯·é€‰æ‹©æ“ä½œ:"
  echo "  1) ğŸš€ ä¸€é”®ä¼˜åŒ–å®‰è£…"
  echo "  2) ğŸ”‘ ç”Ÿæˆé’±åŒ…"
  echo "  3) ğŸ“ è®¾ç½®æŒ–çŸ¿å…¬é’¥ (128ä½16è¿›åˆ¶)"
  echo "  4) ğŸ’¾ å¯¼å‡ºå¯†é’¥"
  echo "  5) ğŸ“‚ å¯¼å…¥å¯†é’¥"
  echo "  6) âš¡ å¯åŠ¨èŠ‚ç‚¹"
  echo "  7) ğŸ“Š æŸ¥çœ‹æ—¥å¿—"
  echo "  8) ğŸ” æ£€æŸ¥çŠ¶æ€"
  echo "  9) â¹ï¸  åœæ­¢èŠ‚ç‚¹"
  echo "  0) é€€å‡º"
  echo ""
  read -p "è¯·è¾“å…¥ç¼–å·: " choice

  case "$choice" in
    1) setup_all ;;
    2) generate_wallet ;;
    3) set_pubkey_env ;;
    4) export_keys ;;
    5) import_keys ;;
    6) start_node ;;
    7) view_logs ;;
    8) check_status ;;
    9) stop_node ;;
    0) echo "é€€å‡ºè„šæœ¬."; exit 0 ;;
    *) echo -e "${RED}[-] æ— æ•ˆé€‰é¡¹${RESET}"; pause_and_return ;;
  esac
}

main_menu


