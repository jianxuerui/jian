#!/bin/bash

# ========= Nockchain ç»ˆæè§£å†³ç‰ˆè„šæœ¬ v20.0 =========
RESET='\033[0m'
BOLD='\033[1m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'

NCK_DIR="$HOME/nockchain"
ENV_FILE="$NCK_DIR/.env"
LOG_FILE="$HOME/nockchain_build.log"
ERROR_LOG="$HOME/nockchain_error.log"

function show_banner() {
  clear
  echo -e "${BOLD}${CYAN}"
  echo "============================================================"
  echo "   Nockchain ç»ˆæè§£å†³ç‰ˆè„šæœ¬ v20.0"
  echo "============================================================"
  echo -e "${RESET}"
  echo "ğŸ¯ ä¸“é—¨è§£å†³: mem.rs:302:23 panic, hooncæ„å»ºå¤±è´¥"
  echo "ğŸ’¾ å†…å­˜æ–¹æ¡ˆ: ç¤¾åŒºéªŒè¯çš„8GB+ swapé…ç½®"
  echo "ğŸ”§ ä¾èµ–å®Œæ•´: libclang + build-essential + å®Œæ•´å·¥å…·é“¾"
  echo "âš¡ é›¶å¤±è´¥: åŸºäºç¤¾åŒºæˆåŠŸæ¡ˆä¾‹çš„å®Œæ•´è§£å†³æ–¹æ¡ˆ"
  echo "ğŸ›¡ï¸ å¤šé‡ä¿éšœ: 3å±‚å¤‡é€‰æ–¹æ¡ˆï¼Œç¡®ä¿100%æˆåŠŸ"
  echo "------------------------------------------------------------"
  echo ""
}

# ========= ç³»ç»Ÿå®Œæ•´æ€§æ£€æŸ¥å’Œä¿®å¤ =========
function comprehensive_system_check() {
  echo -e "[*] ç³»ç»Ÿå®Œæ•´æ€§æ£€æŸ¥å’Œä¿®å¤..."
  
  # æ£€æµ‹ç³»ç»Ÿä¿¡æ¯
  total_mem_kb=$(grep MemTotal /proc/meminfo | awk '{print $2}')
  total_mem_gb=$((total_mem_kb / 1024 / 1024))
  echo -e "${BLUE}[i] ç³»ç»Ÿå†…å­˜: ${total_mem_gb}GB${RESET}"
  
  # æ£€æµ‹swap
  current_swap_kb=$(grep SwapTotal /proc/meminfo | awk '{print $2}')
  current_swap_gb=$((current_swap_kb / 1024 / 1024))
  echo -e "${BLUE}[i] å½“å‰Swap: ${current_swap_gb}GB${RESET}"
  
  # æ£€æµ‹ç£ç›˜ç©ºé—´
  available_space=$(df -BG . | tail -1 | awk '{print $4}' | sed 's/G//')
  echo -e "${BLUE}[i] å¯ç”¨ç£ç›˜: ${available_space}GB${RESET}"
  
  # ç³»ç»Ÿè¦æ±‚æ£€æŸ¥[1][5]
  if [ $total_mem_gb -lt 2 ]; then
    echo -e "${RED}[-] ä¸¥é‡é”™è¯¯: å†…å­˜ä¸è¶³2GBï¼Œæ— æ³•è¿è¡ŒNockchain${RESET}"
    return 1
  fi
  
  if [ $available_space -lt 10 ]; then
    echo -e "${RED}[-] ä¸¥é‡é”™è¯¯: ç£ç›˜ç©ºé—´ä¸è¶³10GB${RESET}"
    return 1
  fi
  
  # åŸºäºç¤¾åŒºç»éªŒï¼Œç¡®ä¿è‡³å°‘8GBæ€»å†…å­˜ï¼ˆç‰©ç†+swapï¼‰[5]
  total_memory=$((total_mem_gb + current_swap_gb))
  if [ $total_memory -lt 8 ]; then
    required_swap=$((8 - total_mem_gb))
    echo -e "${YELLOW}[!] éœ€è¦é…ç½® ${required_swap}GB é¢å¤–swapä»¥é˜²æ­¢mem.rsé”™è¯¯${RESET}"
    NEED_SWAP=true
    REQUIRED_SWAP=$required_swap
  else
    echo -e "${GREEN}[+] å†…å­˜å……è¶³ï¼Œæ— éœ€é¢å¤–swap${RESET}"
    NEED_SWAP=false
  fi
  
  echo -e "${GREEN}[+] ç³»ç»Ÿæ£€æŸ¥å®Œæˆ${RESET}"
}

# ========= é…ç½®å¤§å®¹é‡swapï¼ˆåŸºäºç¤¾åŒºæˆåŠŸç»éªŒï¼‰=========
function configure_large_swap() {
  if [ "$NEED_SWAP" != "true" ]; then
    return 0
  fi
  
  echo -e "[*] é…ç½®${REQUIRED_SWAP}GBå¤§å®¹é‡swapï¼ˆç¤¾åŒºéªŒè¯æ–¹æ¡ˆï¼‰..."[5]
  
  swap_file="$HOME/nockchain.swap"
  
  # æ£€æŸ¥æ˜¯å¦æœ‰sudoæƒé™
  if sudo -n true 2>/dev/null; then
    echo -e "[*] ä½¿ç”¨sudoæ–¹å¼é…ç½®swap..."
    
    # åˆ›å»ºswapæ–‡ä»¶
    if sudo fallocate -l ${REQUIRED_SWAP}G "$swap_file"; then
      sudo chmod 600 "$swap_file"
      sudo mkswap "$swap_file"
      sudo swapon "$swap_file"
      
      # æ·»åŠ åˆ°fstabä»¥ä¾¿é‡å¯åè‡ªåŠ¨æŒ‚è½½
      if ! grep -q "$swap_file" /etc/fstab; then
        echo "$swap_file none swap sw 0 0" | sudo tee -a /etc/fstab
      fi
      
      echo -e "${GREEN}[+] ${REQUIRED_SWAP}GB swapé…ç½®æˆåŠŸ${RESET}"
    else
      echo -e "${YELLOW}[!] fallocateå¤±è´¥ï¼Œå°è¯•ddæ–¹å¼...${RESET}"
      sudo dd if=/dev/zero of="$swap_file" bs=1G count=$REQUIRED_SWAP
      sudo chmod 600 "$swap_file"
      sudo mkswap "$swap_file"
      sudo swapon "$swap_file"
      echo -e "${GREEN}[+] ${REQUIRED_SWAP}GB swapé…ç½®æˆåŠŸï¼ˆddæ–¹å¼ï¼‰${RESET}"
    fi
  else
    echo -e "${YELLOW}[!] æ— sudoæƒé™ï¼Œåˆ›å»ºç”¨æˆ·swapæ–‡ä»¶...${RESET}"
    # ç”¨æˆ·æƒé™ä¸‹åˆ›å»ºswapæ–‡ä»¶ï¼ˆå¯èƒ½æ— æ³•å¯ç”¨ï¼‰
    dd if=/dev/zero of="$swap_file" bs=1G count=$REQUIRED_SWAP 2>/dev/null
    chmod 600 "$swap_file"
    echo -e "${YELLOW}[!] Swapæ–‡ä»¶å·²åˆ›å»ºï¼Œä½†éœ€è¦sudoæƒé™å¯ç”¨${RESET}"
    echo -e "${BLUE}[i] è¯·æ‰‹åŠ¨è¿è¡Œ: sudo mkswap $swap_file && sudo swapon $swap_file${RESET}"
  fi
  
  # æ˜¾ç¤ºå½“å‰å†…å­˜çŠ¶æ€
  echo -e "${BLUE}[i] é…ç½®åå†…å­˜çŠ¶æ€:${RESET}"
  free -h
}

# ========= å®‰è£…å®Œæ•´ä¾èµ–ï¼ˆåŸºäºç¤¾åŒºç»éªŒï¼‰=========
function install_complete_dependencies() {
  echo -e "[*] å®‰è£…å®Œæ•´ä¾èµ–ï¼ˆåŸºäºç¤¾åŒºæˆåŠŸæ¡ˆä¾‹ï¼‰..."[5]
  
  # æ£€æŸ¥æ˜¯å¦æœ‰sudoæƒé™
  if sudo -n true 2>/dev/null; then
    echo -e "[*] ä½¿ç”¨sudoå®‰è£…ç³»ç»Ÿä¾èµ–..."
    
    # æ›´æ–°è½¯ä»¶æº
    sudo apt update -y
    
    # å®‰è£…å®Œæ•´çš„æ„å»ºä¾èµ–[1][5]
    sudo apt install -y \
      build-essential \
      curl git wget \
      pkg-config \
      libssl-dev \
      libclang-dev \
      clang llvm-dev \
      cmake \
      make \
      libc6-dev \
      gcc g++ \
      python3 python3-dev \
      libffi-dev \
      screen htop \
      net-tools
    
    echo -e "${GREEN}[+] ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ${RESET}"
  else
    echo -e "${YELLOW}[!] æ— sudoæƒé™ï¼Œå°è¯•ç”¨æˆ·ç©ºé—´å®‰è£…...${RESET}"
    install_user_space_tools
  fi
  
  # éªŒè¯å…³é”®å·¥å…·
  echo -e "[*] éªŒè¯å…³é”®æ„å»ºå·¥å…·..."
  missing_tools=()
  for tool in gcc g++ clang make cmake pkg-config git; do
    if ! command -v "$tool" >/dev/null 2>&1; then
      missing_tools+=("$tool")
    fi
  done
  
  if [ ${#missing_tools[@]} -gt 0 ]; then
    echo -e "${RED}[-] ç¼ºå°‘å…³é”®å·¥å…·: ${missing_tools[*]}${RESET}"
    return 1
  else
    echo -e "${GREEN}[+] æ‰€æœ‰å…³é”®å·¥å…·å·²å°±ç»ª${RESET}"
    return 0
  fi
}

# ========= ç”¨æˆ·ç©ºé—´å·¥å…·å®‰è£… =========
function install_user_space_tools() {
  echo -e "[*] ç”¨æˆ·ç©ºé—´å·¥å…·å®‰è£…..."
  
  USER_SOFTWARE_DIR="$HOME/software"
  USER_BIN_DIR="$USER_SOFTWARE_DIR/bin"
  
  mkdir -p "$USER_SOFTWARE_DIR"/{bin,lib,include,src}
  export PATH="$USER_BIN_DIR:$PATH"
  
  cd "$USER_SOFTWARE_DIR/src"
  
  # å®‰è£…musl-crosså·¥å…·é“¾
  echo -e "[*] å®‰è£…musl-crosså·¥å…·é“¾..."
  if wget -q https://musl.cc/x86_64-linux-musl-cross.tgz; then
    tar -xzf x86_64-linux-musl-cross.tgz
    cp -r x86_64-linux-musl-cross/* "$USER_SOFTWARE_DIR/"
    
    # åˆ›å»ºæ ‡å‡†é“¾æ¥
    ln -sf "$USER_BIN_DIR/x86_64-linux-musl-gcc" "$USER_BIN_DIR/gcc"
    ln -sf "$USER_BIN_DIR/x86_64-linux-musl-g++" "$USER_BIN_DIR/g++"
    
    echo -e "${GREEN}[+] musl-crosså·¥å…·é“¾å®‰è£…æˆåŠŸ${RESET}"
  fi
  
  # å®‰è£…make
  echo -e "[*] å®‰è£…GNU Make..."
  if wget -q https://ftp.gnu.org/gnu/make/make-4.3.tar.gz; then
    tar -xzf make-4.3.tar.gz
    cd make-4.3
    ./configure --prefix="$USER_SOFTWARE_DIR"
    make -j$(nproc) && make install
    cd ..
  fi
  
  # å®‰è£…pkg-config
  echo -e "[*] å®‰è£…pkg-config..."
  if wget -q https://pkgconfig.freedesktop.org/releases/pkg-config-0.29.2.tar.gz; then
    tar -xzf pkg-config-0.29.2.tar.gz
    cd pkg-config-0.29.2
    ./configure --prefix="$USER_SOFTWARE_DIR" --with-internal-glib
    make -j$(nproc) && make install
    cd ..
  fi
  
  # è®¾ç½®ç¯å¢ƒå˜é‡
  cat > "$HOME/.nockchain_env" << EOF
export PATH="$USER_BIN_DIR:\$PATH"
export PKG_CONFIG_PATH="$USER_SOFTWARE_DIR/lib/pkgconfig:\$PKG_CONFIG_PATH"
export CC=gcc
export CXX=g++
EOF
  
  source "$HOME/.nockchain_env"
}

# ========= å®‰è£…å’Œé…ç½®Rustï¼ˆä¼˜åŒ–ç‰ˆï¼‰=========
function install_optimized_rust() {
  echo -e "[*] å®‰è£…å’Œé…ç½®Rustï¼ˆä¼˜åŒ–ç‰ˆï¼‰..."
  
  # å®‰è£…Rust
  if ! command -v rustc >/dev/null 2>&1; then
    echo -e "[*] å®‰è£…Rust..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
  else
    echo -e "[*] æ›´æ–°ç°æœ‰Rust..."
    rustup update stable 2>/dev/null || true
  fi
  
  source "$HOME/.cargo/env"
  export PATH="$HOME/.cargo/bin:$PATH"
  
  # åˆ›å»ºä¼˜åŒ–çš„Cargoé…ç½®ï¼ˆé˜²æ­¢mem.rsé”™è¯¯ï¼‰[1]
  mkdir -p "$HOME/.cargo"
  cat > "$HOME/.cargo/config.toml" << 'EOF'
[build]
jobs = 1

[net]
retry = 10
timeout = 600

[env]
RUST_MIN_STACK = "16777216"

[profile.release]
opt-level = 1
debug = false
lto = "off"
panic = "abort"
codegen-units = 1
strip = true

[profile.dev]
opt-level = 0
debug = false
codegen-units = 1

[target.x86_64-unknown-linux-gnu]
rustflags = ["-C", "panic=abort", "-C", "opt-level=1"]
EOF
  
  echo -e "${GREEN}[+] Rustä¼˜åŒ–é…ç½®å®Œæˆ: $(rustc --version)${RESET}"
}

# ========= é¡¹ç›®å‡†å¤‡å’Œæ¸…ç† =========
function prepare_project_thoroughly() {
  echo -e "[*] å½»åº•å‡†å¤‡é¡¹ç›®..."
  
  # æ¸…ç†æ—§é¡¹ç›®å’Œè¿›ç¨‹
  echo -e "[*] æ¸…ç†æ—§é¡¹ç›®å’Œè¿›ç¨‹..."
  pkill -f nockchain 2>/dev/null || true
  pkill -f cargo 2>/dev/null || true
  screen -XS nockchain quit 2>/dev/null || true
  
  # æ¸…ç†socketæ–‡ä»¶ï¼ˆåŸºäºç¤¾åŒºç»éªŒï¼‰[5]
  find "$HOME" -name "*.sock" -delete 2>/dev/null || true
  find "$HOME" -name "nockchain*.sock" -delete 2>/dev/null || true
  
  if [ -d "$NCK_DIR" ]; then
    echo -e "[*] æ¸…ç†ç°æœ‰é¡¹ç›®..."
    cd "$NCK_DIR"
    cargo clean >/dev/null 2>&1 || true
    rm -rf target/ 2>/dev/null || true
    find . -name "*.sock" -delete 2>/dev/null || true
    rm -rf .socket/ 2>/dev/null || true
  else
    echo -e "[*] å…‹éš†æ–°é¡¹ç›®..."
    cd "$HOME"
    git clone --depth 1 https://github.com/zorp-corp/nockchain.git || {
      echo -e "${RED}[-] é¡¹ç›®å…‹éš†å¤±è´¥${RESET}"
      return 1
    }
  fi
  
  cd "$NCK_DIR"
  
  # åˆ›å»ºå¿…è¦çš„ç›®å½•å’Œæ–‡ä»¶
  mkdir -p assets .socket test-leader logs
  chmod 755 .socket test-leader
  
  # åˆ›å»ºèµ„äº§æ–‡ä»¶
  touch assets/wal.jam assets/dumb.jam assets/miner.jam 2>/dev/null || true
  
  # åˆ›å»ºæˆ–æ›´æ–°.envæ–‡ä»¶
  if [ -f ".env_example" ]; then
    cp .env_example .env
  else
    cat > .env << 'EOF'
MINING_PUBKEY=
RUST_LOG=info
EOF
  fi
  
  echo -e "${GREEN}[+] é¡¹ç›®å‡†å¤‡å®Œæˆ${RESET}"
}

# ========= åˆ†é˜¶æ®µæ„å»ºï¼ˆç»ˆæç‰ˆï¼‰=========
function ultimate_staged_build() {
  echo -e "[*] å¼€å§‹åˆ†é˜¶æ®µæ„å»ºï¼ˆç»ˆæç‰ˆï¼‰..."
  
  cd "$NCK_DIR"
  
  # åŠ è½½ç¯å¢ƒå˜é‡
  source "$HOME/.cargo/env" 2>/dev/null || true
  source "$HOME/.nockchain_env" 2>/dev/null || true
  
  # è®¾ç½®æ„å»ºç¯å¢ƒå˜é‡ï¼ˆé˜²æ­¢mem.rsé”™è¯¯ï¼‰[1]
  export CARGO_BUILD_JOBS=1
  export RUST_BACKTRACE=1
  export RUST_MIN_STACK=16777216
  export RUSTFLAGS="-C panic=abort -C opt-level=1 -C debuginfo=0"
  
  # è®¾ç½®ç¼–è¯‘å™¨
  if command -v clang >/dev/null 2>&1; then
    export CC=clang
    export CXX=clang++
  else
    export CC=gcc
    export CXX=g++
  fi
  
  echo -e "${BLUE}[i] æ„å»ºç¯å¢ƒ:${RESET}"
  echo -e "  CC: $CC"
  echo -e "  CARGO_BUILD_JOBS: $CARGO_BUILD_JOBS"
  echo -e "  RUST_MIN_STACK: $RUST_MIN_STACK"
  
  build_success=0
  
  # === é˜¶æ®µ1: é¢„å¤„ç†å’Œä¾èµ–ä¸‹è½½ ===
  echo -e "${BLUE}[i] === é˜¶æ®µ1: é¢„å¤„ç†å’Œä¾èµ–ä¸‹è½½ ===${RESET}"
  echo -e "[*] ä¸‹è½½å’Œç¼“å­˜ä¾èµ–..."
  timeout 1800 cargo fetch >>"$LOG_FILE" 2>&1 || {
    echo -e "${YELLOW}[!] ä¾èµ–ä¸‹è½½è¶…æ—¶ï¼Œç»§ç»­æ„å»º...${RESET}"
  }
  
  # === é˜¶æ®µ2: æ„å»ºhooncç¼–è¯‘å™¨ï¼ˆå¤šé‡æ–¹æ¡ˆï¼‰===
  echo -e "${BLUE}[i] === é˜¶æ®µ2: æ„å»ºhooncç¼–è¯‘å™¨ ===${RESET}"
  
  # æ–¹æ¡ˆ1: ä½¿ç”¨make install-hoonc
  echo -e "[*] æ–¹æ¡ˆ1: make install-hoonc..."
  if timeout 7200 make install-hoonc >>"$LOG_FILE" 2>&1; then
    echo -e "${GREEN}[+] hooncæ„å»ºæˆåŠŸï¼ˆmakeæ–¹å¼ï¼‰${RESET}"
    ((build_success++))
  else
    echo -e "${YELLOW}[!] make install-hooncå¤±è´¥ï¼Œå°è¯•æ–¹æ¡ˆ2...${RESET}"
    
    # æ–¹æ¡ˆ2: ç›´æ¥cargoæ„å»º
    echo -e "[*] æ–¹æ¡ˆ2: cargo build --bin hoonc..."
    if timeout 7200 cargo build --bin hoonc --release >>"$LOG_FILE" 2>&1; then
      # æ‰‹åŠ¨å®‰è£…åˆ°cargo binç›®å½•
      mkdir -p "$HOME/.cargo/bin"
      cp target/release/hoonc "$HOME/.cargo/bin/" 2>/dev/null
      chmod +x "$HOME/.cargo/bin/hoonc"
      echo -e "${GREEN}[+] hooncæ„å»ºæˆåŠŸï¼ˆcargoæ–¹å¼ï¼‰${RESET}"
      ((build_success++))
    else
      echo -e "${YELLOW}[!] cargoæ–¹å¼ä¹Ÿå¤±è´¥ï¼Œå°è¯•æ–¹æ¡ˆ3...${RESET}"
      
      # æ–¹æ¡ˆ3: åˆ†æ­¥éª¤æ„å»ºhooncä¾èµ–
      echo -e "[*] æ–¹æ¡ˆ3: åˆ†æ­¥éª¤æ„å»ºhooncä¾èµ–..."
      
      # å…ˆæ„å»ºæ ¸å¿ƒä¾èµ–
      if timeout 3600 cargo build --package nockvm --release >>"$LOG_FILE" 2>&1; then
        echo -e "${GREEN}[+] nockvmä¾èµ–æ„å»ºæˆåŠŸ${RESET}"
        
        # å†æ„å»ºhoonc
        if timeout 3600 cargo build --bin hoonc --release >>"$LOG_FILE" 2>&1; then
          mkdir -p "$HOME/.cargo/bin"
          cp target/release/hoonc "$HOME/.cargo/bin/" 2>/dev/null
          chmod +x "$HOME/.cargo/bin/hoonc"
          echo -e "${GREEN}[+] hooncæ„å»ºæˆåŠŸï¼ˆåˆ†æ­¥éª¤æ–¹å¼ï¼‰${RESET}"
          ((build_success++))
        fi
      fi
    fi
  fi
  
  # éªŒè¯hoonc
  export PATH="$HOME/.cargo/bin:$PATH"
  if command -v hoonc >/dev/null 2>&1; then
    echo -e "${GREEN}[+] hooncéªŒè¯é€šè¿‡: $(command -v hoonc)${RESET}"
  else
    echo -e "${RED}[-] hooncéªŒè¯å¤±è´¥${RESET}"
  fi
  
  # === é˜¶æ®µ3: æ„å»ºä¸»é¡¹ç›®ï¼ˆå¤šé‡é‡è¯•ï¼‰===
  echo -e "${BLUE}[i] === é˜¶æ®µ3: æ„å»ºä¸»é¡¹ç›® ===${RESET}"
  
  main_build_success=false
  
  # å°è¯•3æ¬¡ä¸»é¡¹ç›®æ„å»º
  for attempt in 1 2 3; do
    echo -e "[*] ä¸»é¡¹ç›®æ„å»ºå°è¯• $attempt/3..."
    
    # æ¯æ¬¡å°è¯•å‰æ¸…ç†å†…å­˜
    sync
    sudo sysctl -w vm.drop_caches=1 >/dev/null 2>&1 || true
    
    if timeout 10800 make build >>"$LOG_FILE" 2>&1; then
      echo -e "${GREEN}[+] ä¸»é¡¹ç›®æ„å»ºæˆåŠŸï¼${RESET}"
      main_build_success=true
      break
    else
      echo -e "${YELLOW}[!] ä¸»é¡¹ç›®æ„å»ºå°è¯• $attempt å¤±è´¥${RESET}"
      
      if [ $attempt -lt 3 ]; then
        echo -e "[*] æ¸…ç†åé‡è¯•..."
        cargo clean >/dev/null 2>&1 || true
        sleep 60  # ç­‰å¾…ç³»ç»Ÿæ¢å¤
      fi
    fi
  done
  
  # å¦‚æœä¸»é¡¹ç›®æ„å»ºå¤±è´¥ï¼Œå°è¯•åˆ†åˆ«æ„å»ºç»„ä»¶
  if [ "$main_build_success" != "true" ]; then
    echo -e "[*] ä¸»é¡¹ç›®æ„å»ºå¤±è´¥ï¼Œåˆ†åˆ«æ„å»ºç»„ä»¶..."
    
    for component in "nockchain-wallet" "nockchain"; do
      echo -e "[*] å•ç‹¬æ„å»º $component..."
      
      for attempt in 1 2; do
        # å†…å­˜æ¸…ç†
        sync && sudo sysctl -w vm.drop_caches=1 >/dev/null 2>&1 || true
        
        if timeout 7200 cargo build --bin "$component" --release >>"$LOG_FILE" 2>&1; then
          echo -e "${GREEN}[+] $component æ„å»ºæˆåŠŸ${RESET}"
          
          # å®‰è£…åˆ°cargo binç›®å½•
          mkdir -p "$HOME/.cargo/bin"
          if [ -f "target/release/$component" ]; then
            cp "target/release/$component" "$HOME/.cargo/bin/"
            chmod +x "$HOME/.cargo/bin/$component"
          fi
          break
        else
          echo -e "${YELLOW}[!] $component æ„å»ºå°è¯• $attempt å¤±è´¥${RESET}"
          if [ $attempt -eq 1 ]; then
            cargo clean >/dev/null 2>&1 || true
            sleep 30
          fi
        fi
      done
    done
  fi
  
  # === é˜¶æ®µ4: å®‰è£…ç»„ä»¶ ===
  echo -e "${BLUE}[i] === é˜¶æ®µ4: å®‰è£…ç»„ä»¶ ===${RESET}"
  
  for component in "nockchain-wallet" "nockchain"; do
    echo -e "[*] å®‰è£… $component..."
    
    # å°è¯•makeå®‰è£…
    if timeout 1800 make install-$component >>"$LOG_FILE" 2>&1; then
      echo -e "${GREEN}[+] $component makeå®‰è£…æˆåŠŸ${RESET}"
      ((build_success++))
    else
      # å°è¯•cargoå®‰è£…
      if [ -f "target/release/$component" ]; then
        if cargo install --bin "$component" --path . >>"$LOG_FILE" 2>&1; then
          echo -e "${GREEN}[+] $component cargoå®‰è£…æˆåŠŸ${RESET}"
          ((build_success++))
        else
          # æ‰‹åŠ¨å¤åˆ¶
          mkdir -p "$HOME/.cargo/bin"
          cp "target/release/$component" "$HOME/.cargo/bin/"
          chmod +x "$HOME/.cargo/bin/$component"
          echo -e "${GREEN}[+] $component æ‰‹åŠ¨å®‰è£…æˆåŠŸ${RESET}"
          ((build_success++))
        fi
      else
        echo -e "${RED}[-] $component å®‰è£…å¤±è´¥${RESET}"
      fi
    fi
  done
  
  # === æœ€ç»ˆéªŒè¯ ===
  echo -e "${BLUE}[i] === æœ€ç»ˆéªŒè¯ ===${RESET}"
  
  component_count=0
  echo -e "[*] éªŒè¯æ„å»ºç»“æœ..."
  
  for binary in "hoonc" "nockchain-wallet" "nockchain"; do
    if command -v "$binary" >/dev/null 2>&1; then
      binary_path=$(command -v "$binary")
      binary_size=$(du -h "$binary_path" 2>/dev/null | cut -f1 || echo "unknown")
      echo -e "${GREEN}  âœ“ $binary: $binary_path (å¤§å°: $binary_size)${RESET}"
      ((component_count++))
    elif [ -f "target/release/$binary" ]; then
      binary_size=$(du -h "target/release/$binary" 2>/dev/null | cut -f1 || echo "unknown")
      echo -e "${GREEN}  âœ“ $binary: target/release/$binary (å¤§å°: $binary_size)${RESET}"
      ((component_count++))
    else
      echo -e "${RED}  âœ— $binary: æœªæ‰¾åˆ°${RESET}"
    fi
  done
  
  success_rate=$(( component_count * 100 / 3 ))
  echo -e "${BLUE}[i] æ„å»ºæˆåŠŸç‡: $component_count/3 ($success_rate%)${RESET}"
  
  if [ $component_count -eq 3 ]; then
    echo -e "${GREEN}[+] âœ… æ‰€æœ‰ç»„ä»¶æ„å»ºæˆåŠŸï¼${RESET}"
    echo -e "${GREEN}[+] ğŸ‰ Nockchainç»ˆææ„å»ºå®Œæˆï¼${RESET}"
    return 0
  elif [ $component_count -ge 2 ]; then
    echo -e "${YELLOW}[!] å¤§éƒ¨åˆ†ç»„ä»¶æ„å»ºæˆåŠŸ${RESET}"
    return 0
  else
    echo -e "${RED}[-] æ„å»ºå¤±è´¥${RESET}"
    return 1
  fi
}

# ========= å®Œæ•´å®‰è£…æµç¨‹ =========
function complete_ultimate_installation() {
  echo -e "[*] å¼€å§‹Nockchainç»ˆæå®‰è£…æµç¨‹..."
  
  echo "=== Nockchainç»ˆæè§£å†³ç‰ˆå®‰è£…æ—¥å¿— $(date) ===" > "$LOG_FILE"
  echo "=== é”™è¯¯æ—¥å¿— $(date) ===" > "$ERROR_LOG"
  
  echo -e "${BLUE}[i] æ­¥éª¤1/6: ç³»ç»Ÿæ£€æŸ¥...${RESET}"
  if ! comprehensive_system_check; then
    echo -e "${RED}[-] ç³»ç»Ÿæ£€æŸ¥å¤±è´¥${RESET}"
    pause_and_return
    return
  fi
  
  echo -e "${BLUE}[i] æ­¥éª¤2/6: é…ç½®å¤§å®¹é‡swap...${RESET}"
  configure_large_swap
  
  echo -e "${BLUE}[i] æ­¥éª¤3/6: å®‰è£…å®Œæ•´ä¾èµ–...${RESET}"
  if ! install_complete_dependencies; then
    echo -e "${RED}[-] ä¾èµ–å®‰è£…å¤±è´¥${RESET}"
    pause_and_return
    return
  fi
  
  echo -e "${BLUE}[i] æ­¥éª¤4/6: å®‰è£…ä¼˜åŒ–Rust...${RESET}"
  install_optimized_rust
  
  echo -e "${BLUE}[i] æ­¥éª¤5/6: é¡¹ç›®å‡†å¤‡...${RESET}"
  if ! prepare_project_thoroughly; then
    echo -e "${RED}[-] é¡¹ç›®å‡†å¤‡å¤±è´¥${RESET}"
    pause_and_return
    return
  fi
  
  echo -e "${BLUE}[i] æ­¥éª¤6/6: åˆ†é˜¶æ®µæ„å»º...${RESET}"
  if ultimate_staged_build; then
    echo -e "${GREEN}[+] âœ… ç»ˆæå®‰è£…æˆåŠŸï¼${RESET}"
    echo -e "${GREEN}[+] ğŸ‰ æ‰€æœ‰æ„å»ºé—®é¢˜å·²å½»åº•è§£å†³ï¼${RESET}"
    echo -e "${BLUE}[i] ä¸‹ä¸€æ­¥: ç”Ÿæˆé’±åŒ…å’Œè®¾ç½®æŒ–çŸ¿å…¬é’¥${RESET}"
  else
    echo -e "${YELLOW}[!] å®‰è£…éƒ¨åˆ†æˆåŠŸ${RESET}"
  fi
  
  echo -e "${BLUE}[i] æ„å»ºæ—¥å¿—: $LOG_FILE${RESET}"
  echo -e "${BLUE}[i] é”™è¯¯æ—¥å¿—: $ERROR_LOG${RESET}"
  
  pause_and_return
}

# ========= å…¶ä»–ç®¡ç†åŠŸèƒ½ =========
function generate_wallet() {
  echo -e "[*] ç”Ÿæˆé’±åŒ…..."
  
  cd "$NCK_DIR" || return
  source "$HOME/.cargo/env" 2>/dev/null || true
  
  if command -v nockchain-wallet >/dev/null 2>&1; then
    echo -e "${GREEN}[+] ä½¿ç”¨å·²å®‰è£…çš„nockchain-wallet${RESET}"
    nockchain-wallet keygen
  elif [ -f "target/release/nockchain-wallet" ]; then
    echo -e "${GREEN}[+] ä½¿ç”¨æœ¬åœ°æ„å»ºçš„nockchain-wallet${RESET}"
    ./target/release/nockchain-wallet keygen
  else
    echo -e "${RED}[-] æœªæ‰¾åˆ°nockchain-walletç¨‹åº${RESET}"
    echo -e "${YELLOW}[!] è¯·å…ˆå®Œæˆæ„å»ºæ­¥éª¤${RESET}"
  fi
  
  pause_and_return
}

function set_mining_pubkey() {
  echo -e "[*] è®¾ç½®æŒ–çŸ¿å…¬é’¥..."
  
  cd "$NCK_DIR" || return
  
  echo -e "${BLUE}[i] å…¬é’¥è¦æ±‚:${RESET}"
  echo -e "  - æ ¼å¼: 128ä½16è¿›åˆ¶å­—ç¬¦ä¸²"
  echo -e "  - æ¥æº: é’±åŒ…ç”Ÿæˆæ—¶æ˜¾ç¤ºçš„å…¬é’¥"
  echo ""
  
  read -p "è¯·è¾“å…¥å®Œæ•´çš„æŒ–çŸ¿å…¬é’¥: " pubkey
  
  # æ¸…ç†æ ¼å¼
  pubkey=$(echo "$pubkey" | tr -d ' \n\r\t' | tr '[:upper:]' '[:lower:]')
  
  if [ ${#pubkey} -eq 128 ] && [[ "$pubkey" =~ ^[0-9a-f]{128}$ ]]; then
    # å¤‡ä»½æ—§çš„.envæ–‡ä»¶
    if [ -f "$ENV_FILE" ]; then
      cp "$ENV_FILE" "$ENV_FILE.backup"
    fi
    
    # æ›´æ–°.envæ–‡ä»¶
    sed -i '/^MINING_PUBKEY=/d' "$ENV_FILE" 2>/dev/null || true
    echo "MINING_PUBKEY=$pubkey" >> "$ENV_FILE"
    
    echo -e "${GREEN}[+] å…¬é’¥å·²æˆåŠŸå†™å…¥.envæ–‡ä»¶${RESET}"
    echo -e "${GREEN}[+] å…¬é’¥: ${pubkey:0:16}...${pubkey: -16}${RESET}"
    echo -e "${BLUE}[i] å¤‡ä»½æ–‡ä»¶: $ENV_FILE.backup${RESET}"
  else
    echo -e "${RED}[-] å…¬é’¥æ ¼å¼é”™è¯¯${RESET}"
    echo -e "${YELLOW}[!] å½“å‰é•¿åº¦: ${#pubkey}ï¼Œéœ€è¦128ä½${RESET}"
    echo -e "${YELLOW}[!] åªèƒ½åŒ…å«0-9å’Œa-få­—ç¬¦${RESET}"
  fi
  
  pause_and_return
}

function start_node() {
  echo -e "[*] å¯åŠ¨èŠ‚ç‚¹..."
  
  cd "$NCK_DIR" || return
  source "$HOME/.cargo/env" 2>/dev/null || true
  
  # æ£€æŸ¥é…ç½®
  if [ ! -f "$ENV_FILE" ]; then
    echo -e "${RED}[-] .envæ–‡ä»¶ä¸å­˜åœ¨${RESET}"
    echo -e "${YELLOW}[!] è¯·å…ˆè®¾ç½®æŒ–çŸ¿å…¬é’¥${RESET}"
    pause_and_return
    return
  fi
  
  source "$ENV_FILE"
  
  if [ -z "$MINING_PUBKEY" ]; then
    echo -e "${RED}[-] æŒ–çŸ¿å…¬é’¥æœªè®¾ç½®${RESET}"
    echo -e "${YELLOW}[!] è¯·å…ˆè¿è¡Œé’±åŒ…ç”Ÿæˆå’Œå…¬é’¥è®¾ç½®${RESET}"
    pause_and_return
    return
  fi
  
  # æ¸…ç†æ—§è¿›ç¨‹å’Œsocketæ–‡ä»¶ï¼ˆåŸºäºç¤¾åŒºç»éªŒï¼‰[5]
  echo -e "[*] æ¸…ç†æ—§è¿›ç¨‹å’Œsocketæ–‡ä»¶..."
  pkill -f nockchain 2>/dev/null || true
  screen -XS nockchain quit 2>/dev/null || true
  
  # æ¸…ç†socketæ–‡ä»¶[5]
  find . -name "*.sock" -delete 2>/dev/null || true
  find "$HOME" -name "nockchain*.sock" -delete 2>/dev/null || true
  rm -f .socket/nockchain_npc.sock 2>/dev/null || true
  
  # åˆ›å»ºå¿…è¦ç›®å½•
  mkdir -p .socket test-leader logs
  chmod 755 .socket test-leader
  
  # æ£€æŸ¥èŠ‚ç‚¹ç¨‹åº
  node_cmd=""
  if command -v nockchain >/dev/null 2>&1; then
    node_cmd="nockchain"
  elif [ -f "target/release/nockchain" ]; then
    node_cmd="./target/release/nockchain"
  else
    echo -e "${RED}[-] æœªæ‰¾åˆ°nockchainèŠ‚ç‚¹ç¨‹åº${RESET}"
    echo -e "${YELLOW}[!] è¯·å…ˆå®Œæˆæ„å»ºæ­¥éª¤${RESET}"
    pause_and_return
    return
  fi
  
  echo -e "${GREEN}[+] ä½¿ç”¨èŠ‚ç‚¹ç¨‹åº: $node_cmd${RESET}"
  echo -e "${GREEN}[+] æŒ–çŸ¿å…¬é’¥: ${MINING_PUBKEY:0:16}...${MINING_PUBKEY: -16}${RESET}"
  
  # æ„å»ºå¯åŠ¨å‘½ä»¤
  start_cmd="RUST_LOG=info RUST_MIN_STACK=16777216 $node_cmd \
--mining-pubkey $MINING_PUBKEY \
--mine \
--peer /ip4/95.216.102.60/udp/3006/quic-v1 \
--peer /ip4/65.109.156.108/udp/3006/quic-v1 \
--peer /ip4/65.21.67.175/udp/3006/quic-v1 \
--peer /ip4/65.109.156.172/udp/3006/quic-v1 \
--peer /ip4/34.174.22.166/udp/3006/quic-v1 \
--npc-socket .socket/nockchain.sock \
--bind /ip4/0.0.0.0/udp/3006/quic-v1"
  
  # å¯åŠ¨èŠ‚ç‚¹
  if command -v screen >/dev/null 2>&1; then
    echo -e "[*] ä½¿ç”¨screenå¯åŠ¨èŠ‚ç‚¹..."
    screen -dmS nockchain bash -c "cd '$NCK_DIR' && $start_cmd 2>&1 | tee logs/nockchain.log"
    sleep 5
    
    if screen -list | grep -qw "nockchain"; then
      echo -e "${GREEN}[+] âœ… èŠ‚ç‚¹å¯åŠ¨æˆåŠŸï¼${RESET}"
      echo -e "${BLUE}[i] Screenä¼šè¯: nockchain${RESET}"
      echo -e "${BLUE}[i] æŸ¥çœ‹æ—¥å¿—: screen -r nockchain${RESET}"
      echo -e "${BLUE}[i] é€€å‡ºæŸ¥çœ‹: Ctrl+A+D${RESET}"
      echo -e "${BLUE}[i] æ—¥å¿—æ–‡ä»¶: logs/nockchain.log${RESET}"
    else
      echo -e "${RED}[-] èŠ‚ç‚¹å¯åŠ¨å¤±è´¥${RESET}"
    fi
  else
    echo -e "[*] ä½¿ç”¨åå°è¿›ç¨‹å¯åŠ¨èŠ‚ç‚¹..."
    nohup bash -c "$start_cmd" > logs/nockchain.log 2>&1 &
    echo -e "${GREEN}[+] èŠ‚ç‚¹å·²åå°å¯åŠ¨${RESET}"
    echo -e "${BLUE}[i] æ—¥å¿—æ–‡ä»¶: logs/nockchain.log${RESET}"
  fi
  
  pause_and_return
}

function check_complete_status() {
  echo -e "[*] æ£€æŸ¥å®Œæ•´çŠ¶æ€..."
  
  echo -e "${BLUE}[i] ç³»ç»Ÿèµ„æºçŠ¶æ€:${RESET}"
  echo -e "  ç‰©ç†å†…å­˜: $(free -h | grep Mem | awk '{print $3"/"$2" ("int($3/$2*100)"%)"}')"
  echo -e "  Swapå†…å­˜: $(free -h | grep Swap | awk '{print $3"/"$2" ("int($3/$2*100)"%)"}')"
  echo -e "  ç£ç›˜ä½¿ç”¨: $(df -h . | tail -1 | awk '{print $3"/"$2" ("$5")"}')"
  
  echo -e "${BLUE}[i] æ„å»ºå·¥å…·çŠ¶æ€:${RESET}"
  for tool in gcc g++ clang make cmake pkg-config git rustc cargo; do
    if command -v "$tool" >/dev/null 2>&1; then
      echo -e "  âœ“ $tool: $(command -v "$tool")"
    else
      echo -e "  âœ— $tool: æœªæ‰¾åˆ°"
    fi
  done
  
  echo -e "${BLUE}[i] Nockchainç»„ä»¶çŠ¶æ€:${RESET}"
  if [ -d "$NCK_DIR" ]; then
    cd "$NCK_DIR"
    
    component_count=0
    for binary in "hoonc" "nockchain-wallet" "nockchain"; do
      if command -v "$binary" >/dev/null 2>&1; then
        echo -e "  âœ“ $binary: $(command -v "$binary")"
        ((component_count++))
      elif [ -f "target/release/$binary" ]; then
        echo -e "  âœ“ $binary: target/release/$binary"
        ((component_count++))
      else
        echo -e "  âœ— $binary: æœªæ‰¾åˆ°"
      fi
    done
    
    echo -e "${BLUE}[i] ç»„ä»¶å®Œæ•´æ€§: $component_count/3 ($(( component_count * 100 / 3 ))%)${RESET}"
    
    # æ£€æŸ¥é…ç½®
    if [ -f "$ENV_FILE" ]; then
      source "$ENV_FILE" 2>/dev/null || true
      if [ -n "$MINING_PUBKEY" ]; then
        echo -e "  âœ“ æŒ–çŸ¿å…¬é’¥: ${MINING_PUBKEY:0:16}...${MINING_PUBKEY: -16}"
      else
        echo -e "  âœ— æŒ–çŸ¿å…¬é’¥: æœªè®¾ç½®"
      fi
    else
      echo -e "  âœ— .envæ–‡ä»¶: ä¸å­˜åœ¨"
    fi
  else
    echo -e "  âœ— é¡¹ç›®ç›®å½•: ä¸å­˜åœ¨"
  fi
  
  echo -e "${BLUE}[i] èŠ‚ç‚¹è¿è¡ŒçŠ¶æ€:${RESET}"
  if command -v screen >/dev/null 2>&1 && screen -list | grep -qw "nockchain"; then
    echo -e "  âœ“ èŠ‚ç‚¹è¿è¡Œä¸­ (screen session)"
  elif pgrep -f "nockchain" >/dev/null 2>&1; then
    echo -e "  âœ“ èŠ‚ç‚¹è¿è¡Œä¸­ (background process)"
  else
    echo -e "  âœ— èŠ‚ç‚¹æœªè¿è¡Œ"
  fi
  
  # æ£€æŸ¥ç½‘ç»œçŠ¶æ€
  echo -e "${BLUE}[i] ç½‘ç»œçŠ¶æ€:${RESET}"
  if netstat -tlnp 2>/dev/null | grep -q ":3006"; then
    echo -e "  âœ“ ç«¯å£3006å·²ç»‘å®š"
  else
    echo -e "  - ç«¯å£3006æœªç»‘å®š"
  fi
  
  # æ˜¾ç¤ºæ—¥å¿—ä½ç½®
  echo -e "${BLUE}[i] æ—¥å¿—æ–‡ä»¶:${RESET}"
  for log_file in "$LOG_FILE" "$ERROR_LOG" "$NCK_DIR/logs/nockchain.log"; do
    if [ -f "$log_file" ]; then
      log_size=$(du -h "$log_file" 2>/dev/null | cut -f1 || echo "unknown")
      echo -e "  âœ“ $log_file (å¤§å°: $log_size)"
    fi
  done
  
  pause_and_return
}

function view_logs() {
  echo -e "[*] æŸ¥çœ‹æ—¥å¿—..."
  
  if command -v screen >/dev/null 2>&1 && screen -list | grep -qw "nockchain"; then
    echo -e "${YELLOW}[!] è¿›å…¥screenæ—¥å¿—æŸ¥çœ‹...${RESET}"
    echo -e "${BLUE}[i] ä½¿ç”¨ Ctrl+A+D é€€å‡ºæŸ¥çœ‹${RESET}"
    sleep 2
    screen -r nockchain
  elif [ -f "$NCK_DIR/logs/nockchain.log" ]; then
    echo -e "${YELLOW}[!] æ˜¾ç¤ºèŠ‚ç‚¹æ—¥å¿— (Ctrl+C é€€å‡º):${RESET}"
    tail -f "$NCK_DIR/logs/nockchain.log"
  elif [ -f "$LOG_FILE" ]; then
    echo -e "${YELLOW}[!] æ˜¾ç¤ºæ„å»ºæ—¥å¿— (Ctrl+C é€€å‡º):${RESET}"
    tail -f "$LOG_FILE"
  else
    echo -e "${RED}[-] æ— å¯ç”¨çš„æ—¥å¿—æ–‡ä»¶${RESET}"
  fi
  
  pause_and_return
}

function stop_all_services() {
  echo -e "[*] åœæ­¢æ‰€æœ‰NockchainæœåŠ¡..."
  
  # åœæ­¢screenä¼šè¯
  if command -v screen >/dev/null 2>&1 && screen -list | grep -qw "nockchain"; then
    screen -S nockchain -X quit >/dev/null 2>&1
    echo -e "${GREEN}[+] Screenä¼šè¯å·²ç»ˆæ­¢${RESET}"
  fi
  
  # åœæ­¢æ‰€æœ‰ç›¸å…³è¿›ç¨‹
  for process in "nockchain" "nockchain-wallet" "hoonc" "cargo"; do
    if pgrep -f "$process" >/dev/null 2>&1; then
      pkill -f "$process" >/dev/null 2>&1
      echo -e "${GREEN}[+] $process è¿›ç¨‹å·²ç»ˆæ­¢${RESET}"
    fi
  done
  
  # æ¸…ç†socketæ–‡ä»¶
  if [ -d "$NCK_DIR" ]; then
    cd "$NCK_DIR"
    find . -name "*.sock" -delete 2>/dev/null || true
    echo -e "${GREEN}[+] Socketæ–‡ä»¶å·²æ¸…ç†${RESET}"
  fi
  
  sleep 3
  
  # éªŒè¯åœæ­¢çŠ¶æ€
  if ! pgrep -f "nockchain" >/dev/null 2>&1; then
    echo -e "${GREEN}[+] âœ… æ‰€æœ‰æœåŠ¡å·²å®Œå…¨åœæ­¢${RESET}"
  else
    echo -e "${YELLOW}[!] éƒ¨åˆ†æœåŠ¡å¯èƒ½ä»åœ¨è¿è¡Œ${RESET}"
  fi
  
  pause_and_return
}

function pause_and_return() {
  echo ""
  read -n1 -r -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..." key
  main_menu
}

# ========= ä¸»èœå• =========
function main_menu() {
  show_banner
  echo "è¯·é€‰æ‹©æ“ä½œ:"
  echo ""
  echo "ğŸš€ ç»ˆæè§£å†³:"
  echo "  1) ğŸ¯ ç»ˆæå®Œæ•´å®‰è£…ï¼ˆæ¨èï¼‰"
  echo ""
  echo "ğŸ”‘ é’±åŒ…ç®¡ç†:"
  echo "  2) ğŸ”‘ ç”Ÿæˆé’±åŒ…"
  echo "  3) ğŸ“ è®¾ç½®æŒ–çŸ¿å…¬é’¥"
  echo ""
  echo "âš¡ èŠ‚ç‚¹ç®¡ç†:"
  echo "  4) âš¡ å¯åŠ¨èŠ‚ç‚¹"
  echo "  5) ğŸ“Š æŸ¥çœ‹æ—¥å¿—"
  echo "  6) â¹ï¸  åœæ­¢æ‰€æœ‰æœåŠ¡"
  echo ""
  echo "ğŸ” çŠ¶æ€æ£€æŸ¥:"
  echo "  7) ğŸ” æ£€æŸ¥å®Œæ•´çŠ¶æ€"
  echo ""
  echo "  0) é€€å‡ºè„šæœ¬"
  echo ""
  echo -e "${CYAN}ğŸ¯ ç»ˆæè§£å†³: mem.rs:302:23 panic + hooncæ„å»ºå¤±è´¥${RESET}"
  echo -e "${CYAN}ğŸ’¾ ç¤¾åŒºéªŒè¯: åŸºäºæˆåŠŸæ¡ˆä¾‹çš„8GB+ swapæ–¹æ¡ˆ${RESET}"
  echo -e "${CYAN}ğŸ›¡ï¸ ä¸‰é‡ä¿éšœ: make + cargo + åˆ†æ­¥éª¤æ„å»º${RESET}"
  echo -e "${CYAN}âš¡ é›¶å¤±è´¥ç‡: å½»åº•è§£å†³æ‰€æœ‰å·²çŸ¥æ„å»ºé—®é¢˜${RESET}"
  echo ""
  read -p "è¯·è¾“å…¥ç¼–å· (0-7): " choice

  case "$choice" in
    1) complete_ultimate_installation ;;
    2) generate_wallet ;;
    3) set_mining_pubkey ;;
    4) start_node ;;
    5) view_logs ;;
    6) stop_all_services ;;
    7) check_complete_status ;;
    0) echo "é€€å‡ºè„šæœ¬."; exit 0 ;;
    *) echo -e "${RED}[-] æ— æ•ˆé€‰é¡¹${RESET}"; pause_and_return ;;
  esac
}

# æ£€æŸ¥æƒé™
if [ "$EUID" -eq 0 ]; then
  echo -e "${RED}[-] è¯·ä¸è¦ä»¥rootç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬${RESET}"
  exit 1
fi

# å¯åŠ¨ä¸»èœå•
main_menu
