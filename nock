#!/bin/bash
# ==============================================================================
# Nockchain æŒ–çŸ¿åŠ©æ‰‹ (K2 å¢å¼ºèåˆç‰ˆ v8.1 - æœ€å¤§å…¼å®¹ç‰ˆ)
# ==============================================================================
# ä½œè€…: K2 èŠ‚ç‚¹æ•™ç¨‹åˆ†äº« (AI ç»ˆæç¦»çº¿å†…æ ¸ç‰ˆ)
#
# v8.1 æ›´æ–°æ—¥å¿—:
# - [å…¼å®¹æ€§] å¢å¼ºåŒ…ç®¡ç†å™¨æ£€æµ‹ï¼Œæ”¯æŒ apt, dnf, yum, pacman, zypperã€‚
# - [å…¼å®¹æ€§] å¢åŠ å¤‡ç”¨æ–¹æ³•æ£€æµ‹CPUæ ¸å¿ƒæ•°ï¼Œæå‡åœ¨æœ€å°åŒ–ç³»ç»Ÿä¸Šçš„ç¨³å®šæ€§ã€‚
# - [å…¼å®¹æ€§] ä¼˜åŒ–ç³»ç»Ÿä¿¡æ¯æ£€æµ‹é€»è¾‘ï¼Œåœ¨è„šæœ¬å¯åŠ¨æ—¶ä¸€æ¬¡æ€§å®Œæˆã€‚
# - [ä¼˜åŒ–] æä¾›äº†æ›´æ¸…æ™°çš„å®‰è£…è¿‡ç¨‹åé¦ˆå’Œé”™è¯¯æç¤ºã€‚
# ==============================================================================
set -e

# --- å…¨å±€é…ç½® ---
MINER_USERNAME="miner"
MINER_HOME="/home/${MINER_USERNAME}"
NCK_DIR="${MINER_HOME}/nockchain"
ENV_FILE="${NCK_DIR}/.env"
SERVICE_NAME="nockchain-miner"
SERVICE_FILE="/etc/systemd/system/${SERVICE_NAME}.service"

# --- é¢œè‰²å®šä¹‰ ---
if [ -t 1 ]; then
    RESET='\033[0m'; BOLD='\033[1m'; GREEN='\033[0;32m'; BLUE='\033[0;34m';
    YELLOW='\033[1;33m'; RED='\033[0;31m'; PURPLE='\033[0;35m'; CYAN='\033[0;36m'
else
    RESET=''; BOLD=''; GREEN=''; BLUE=''; YELLOW=''; RED=''; PURPLE=''; CYAN=''
fi

# --- å†…æ ¸æ•°æ® ---
read -r -d '' HOON_KERNEL_CONTENT <<'EOF'
::
/+  sys/hoon
++  ride  |%
          --
++  ver
  |%
  ++  ost
    |%
    ++  arvo  0vI.need
    ++  vere  ~
    --
  ++  kelvin  (as-co:co /(~ . 400))
  ++  send  =>((mote ovum) (give:ost ovum))
  ++  give
    |=  a=ovum
    ~|  [! a]
    !!
  ++  kiln
    |%
    ++  sins  |=(a=ovum (send:ost a))
    ++  fard  |=(a=ovum (send:ost a))
    --
  ++  hoon-version   139
  --
EOF

# ==============================================================================
# === åŠ©æ‰‹å‡½æ•° (å…¼å®¹æ€§æ ¸å¿ƒ) ===
# ==============================================================================

# åœ¨è„šæœ¬å¯åŠ¨æ—¶æ£€æµ‹ç³»ç»Ÿä¿¡æ¯
function detect_system_info() {
    # æ£€æµ‹æ“ä½œç³»ç»Ÿä¿¡æ¯
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS_ID=${ID,,} # è½¬ä¸ºå°å†™
    else
        OS_ID=$(uname -s | tr '[:upper:]' '[:lower:]')
        echo -e "${YELLOW}è­¦å‘Š: æ— æ³•æ‰¾åˆ° /etc/os-release æ–‡ä»¶ï¼Œå…¼å®¹æ€§å¯èƒ½å—é™ã€‚${RESET}"
    fi

    # æ£€æµ‹åŒ…ç®¡ç†å™¨å¹¶è®¾ç½®ç›¸åº”å‘½ä»¤å’ŒåŒ…å
    if command -v apt-get &>/dev/null; then
        export PKG_MANAGER="apt"
        export UPDATE_CMD="apt-get update -y"
        export INSTALL_CMD="apt-get install -y"
        export DEP_PACKAGES="clang llvm libclang-dev pkg-config libssl-dev build-essential cmake git make curl dos2unix"
    elif command -v dnf &>/dev/null; then
        export PKG_MANAGER="dnf"
        export UPDATE_CMD="dnf check-update"
        export INSTALL_CMD="dnf install -y"
        export DEP_PACKAGES="clang llvm-devel libclang-devel pkgconfig openssl-devel cmake git make curl dos2unix"
        export GROUP_INSTALL_CMD="dnf groupinstall -y 'Development Tools'"
    elif command -v yum &>/dev/null; then
        export PKG_MANAGER="yum"
        export UPDATE_CMD="yum check-update"
        export INSTALL_CMD="yum install -y"
        export DEP_PACKAGES="clang llvm-devel libclang-devel pkgconfig openssl-devel cmake git make curl dos2unix"
        export GROUP_INSTALL_CMD="yum groupinstall -y 'Development Tools'"
    elif command -v pacman &>/dev/null; then
        export PKG_MANAGER="pacman"
        export UPDATE_CMD="pacman -Sy"
        export INSTALL_CMD="pacman -S --noconfirm --needed"
        export DEP_PACKAGES="clang llvm libclang pkg-config openssl cmake git make curl dos2unix base-devel"
    elif command -v zypper &>/dev/null; then
        export PKG_MANAGER="zypper"
        export UPDATE_CMD="zypper refresh"
        export INSTALL_CMD="zypper install -y"
        export DEP_PACKAGES="clang llvm-devel libclang-devel pkg-config libopenssl-devel cmake git make curl dos2unix patterns-devel-base-devel_basis"
    else
        export PKG_MANAGER="unsupported"
    fi

    # æ£€æµ‹ sudoers ç»„
    if [[ "$OS_ID" == "ubuntu" || "$OS_ID" == "debian" ]]; then
        export SUDO_GROUP="sudo"
    else
        export SUDO_GROUP="wheel" # RHEL, CentOS, Fedora, Arch, SUSE ç­‰çš„é€šç”¨é»˜è®¤å€¼
    fi
}

# æ£€æŸ¥æ˜¯å¦ä»¥ root èº«ä»½è¿è¡Œ
function check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        echo -e "${RED}é”™è¯¯: æ­¤è„šæœ¬éœ€è¦ä»¥ root æƒé™è¿è¡Œã€‚${RESET}"
        echo -e "${YELLOW}è¯·ä½¿ç”¨ 'sudo ./your_script_name.sh' æˆ–åˆ‡æ¢åˆ° root ç”¨æˆ·åè¿è¡Œã€‚${RESET}"
        exit 1
    fi
}

# æ˜¾ç¤ºæ¨ªå¹…
function show_banner() {
    clear
    echo -e "${BOLD}${BLUE}======================================================${RESET}"
    echo -e "${BOLD}${BLUE} Nockchain æŒ–çŸ¿åŠ©æ‰‹ (K2 å¢å¼ºèåˆç‰ˆ v8.1)${RESET}"
    echo -e "${BOLD}${BLUE}======================================================${RESET}"
    echo -e "âœ¨ ${BOLD}${PURPLE}å†…æ ¸å¢å¼º: ä½¿ç”¨å†…ç½® v139 å†…æ ¸ï¼${RESET}"
    echo -e "âš™ï¸ ${BOLD}${CYAN}è¿è¡Œæ¨¡å¼: æœ€å¤§å…¼å®¹ç‰ˆ (éœ€è¦ Root æƒé™)${RESET}"
    if id "${MINER_USERNAME}" &>/dev/null; then
        echo -e "ğŸ‘¤ ${GREEN}ä¸“ç”¨ç”¨æˆ· '${MINER_USERNAME}' å·²åˆ›å»ºã€‚${RESET}"
    else
        echo -e "ğŸ‘¤ ${YELLOW}ä¸“ç”¨ç”¨æˆ· '${MINER_USERNAME}' å¾…åˆ›å»ºã€‚${RESET}"
    fi
    echo "ğŸ“Œ ä½œè€…: K2 èŠ‚ç‚¹æ•™ç¨‹åˆ†äº«"
    echo "------------------------------------------------------"
    echo ""
}

# è·å–CPUæ ¸å¿ƒæ•° (å¢å¼ºç‰ˆ)
function get_num_cores() {
    # ä¼˜å…ˆä½¿ç”¨ nproc, å…¶æ¬¡æ˜¯ /proc/cpuinfo (Linuxé€šç”¨), å†æ¬¡æ˜¯ sysctl (BSD/macOS), æœ€åé»˜è®¤4æ ¸
    nproc 2>/dev/null || \
    grep -c '^processor' /proc/cpuinfo 2>/dev/null || \
    sysctl -n hw.ncpu 2>/dev/null || \
    echo 4
}

function pause_and_return() { echo ""; read -r -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..." -s -n 1; echo; }
function check_systemd() { if [ -d /run/systemd/system ]; then echo "true"; else echo "false"; fi; }

# ==============================================================================
# === æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ===
# ==============================================================================

function install_all() {
    check_root
    show_banner
    echo -e "${YELLOW}[*] å¼€å§‹å…¨æ–°å®‰è£… Nockchain...${RESET}"

    # --- æ­¥éª¤ 1: å‡†å¤‡ä¸“ç”¨ç”¨æˆ· ---
    echo -e "${BLUE}--- æ­¥éª¤ 1/5: å‡†å¤‡ä¸“ç”¨ç”¨æˆ· '${MINER_USERNAME}' ---${RESET}"
    if id "${MINER_USERNAME}" &>/dev/null; then
        echo -e "${YELLOW}[!] æ£€æµ‹åˆ°æ—§ç”¨æˆ· '${MINER_USERNAME}'ï¼Œæ­£åœ¨æ¸…ç†...${RESET}"
        if systemctl is-active --quiet "$SERVICE_NAME" &>/dev/null; then
            systemctl stop "$SERVICE_NAME"; systemctl disable "$SERVICE_NAME"; rm -f "$SERVICE_FILE"; systemctl daemon-reload
        fi
        killall -u "${MINER_USERNAME}" 2>/dev/null || true
        userdel -r "${MINER_USERNAME}" 2>/dev/null || true
        echo -e "${GREEN}[+] æ—§ç”¨æˆ·åŠç›¸å…³æœåŠ¡å·²æ¸…ç†ã€‚${RESET}"
    fi
    
    echo -e "${CYAN}æ­£åœ¨åˆ›å»ºæ–°ç”¨æˆ· '${MINER_USERNAME}'...${RESET}"
    # ä½¿ç”¨æ›´å‹å¥½çš„ adduser (å¦‚æœå­˜åœ¨äº Debian/Ubuntu)ï¼Œå¦åˆ™ç”¨é€šç”¨çš„ useradd
    if [[ "$OS_ID" == "debian" || "$OS_ID" == "ubuntu" ]] && command -v adduser &>/dev/null; then
        adduser --disabled-password --gecos "" "${MINER_USERNAME}"
    else
        useradd -m -s /bin/bash "${MINER_USERNAME}"
    fi
    usermod -aG "${SUDO_GROUP}" "${MINER_USERNAME}" # æ·»åŠ åˆ° sudo/wheel ç»„
    echo -e "${GREEN}[âœ“] ç”¨æˆ·åˆ›å»ºæˆåŠŸå¹¶å·²é…ç½® sudo æƒé™ï¼${RESET}"

    # --- æ­¥éª¤ 2: å®‰è£…ç³»ç»Ÿä¾èµ– (ä»¥ root èº«ä»½) ---
    echo -e "${BLUE}--- æ­¥éª¤ 2/5: å®‰è£…ç³»ç»Ÿä¾èµ– ---${RESET}"
    if [ "$PKG_MANAGER" == "unsupported" ]; then
        echo -e "${RED}é”™è¯¯: æœªèƒ½è¯†åˆ«æ‚¨çš„åŒ…ç®¡ç†å™¨ã€‚${RESET}"
        echo -e "${YELLOW}è¯·æ‰‹åŠ¨å®‰è£…ä»¥ä¸‹æˆ–ç±»ä¼¼çš„ä¾èµ–åŒ…: clang, llvm, libclang, pkg-config, openssl-devel, build-essential, cmake, git, make, curl, dos2unix${RESET}"
        exit 1
    fi
    echo -e "${CYAN}æ£€æµ‹åˆ°åŒ…ç®¡ç†å™¨: ${BOLD}${PKG_MANAGER}${RESET}"
    echo -e "${CYAN}æ­£åœ¨æ›´æ–°åŒ…åˆ—è¡¨... (è¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´)${RESET}"; eval "$UPDATE_CMD" >/dev/null 2>&1
    echo -e "${CYAN}æ­£åœ¨å®‰è£…æ ¸å¿ƒä¾èµ–...${RESET}"; eval "$INSTALL_CMD $DEP_PACKAGES"
    if [ -n "$GROUP_INSTALL_CMD" ]; then
        echo -e "${CYAN}æ­£åœ¨å®‰è£…å¼€å‘å·¥å…·é›†...${RESET}"; eval "$GROUP_INSTALL_CMD"
    fi
    echo -e "${GREEN}[âœ“] ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆã€‚${RESET}"

    # --- æ­¥éª¤ 3 & 4: å…‹éš†ã€ç¼–è¯‘ (åˆ‡æ¢åˆ° miner ç”¨æˆ·æ‰§è¡Œ) ---
    echo -e "${BLUE}--- æ­¥éª¤ 3/5: å®‰è£… Rust (ä»¥ '${MINER_USERNAME}' ç”¨æˆ·èº«ä»½) ---${RESET}"
    echo -e "${BLUE}--- æ­¥éª¤ 4/5: å…‹éš†å’Œç¼–è¯‘ Nockchain (ä»¥ '${MINER_USERNAME}' ç”¨æˆ·èº«ä»½) ---${RESET}"
    echo -e "${YELLOW}è¿™éƒ¨åˆ†å°†è‡ªåŠ¨æ‰§è¡Œï¼Œè¯·è€å¿ƒç­‰å¾…ç¼–è¯‘å®Œæˆ...${RESET}"
    
    # ä½¿ç”¨ su å’Œ heredoc åœ¨ miner ç”¨æˆ·ç¯å¢ƒä¸­æ‰§è¡Œä¸€é•¿ä¸²å‘½ä»¤
    # æ³¨æ„: heredoc ä¸­çš„ $() ä¼šåœ¨å¤–éƒ¨è¢«è§£æ, æ‰€ä»¥éœ€è¦è½¬ä¹‰, ä¾‹å¦‚ \$(get_num_cores)
    su - "${MINER_USERNAME}" -c bash <<EOF
    set -euo pipefail # åœ¨å­ shell ä¸­ä¹Ÿéœ€è¦è®¾ç½®
    
    echo "--- [${MINER_USERNAME}] æ­£åœ¨å®‰è£… Rust... ---"
    if ! command -v cargo &>/dev/null; then
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    fi
    source "\$HOME/.cargo/env"
    
    NCK_DIR_SUB="\$HOME/nockchain"
    rm -rf "\$NCK_DIR_SUB"
    
    echo "--- [${MINER_USERNAME}] æ­£åœ¨å…‹éš†ä»“åº“... ---"
    git clone https://github.com/zorp-corp/nockchain "\$NCK_DIR_SUB"
    cd "\$NCK_DIR_SUB"
    
    echo "--- [${MINER_USERNAME}] æ­£åœ¨æ³¨å…¥å¢å¼ºç‰ˆå†…æ ¸... ---"
    echo -n "$HOON_KERNEL_CONTENT" > "\$NCK_DIR_SUB/pkg/sys/hoon"
    
    echo "--- [${MINER_USERNAME}] æ­£åœ¨ç¼–è¯‘ï¼Œè¿™å°†èŠ±è´¹å‡ åˆ†é’Ÿæ—¶é—´... ---"
    cargo build --release -p hoonc
    mkdir -p assets
    "\$NCK_DIR_SUB/target/release/hoonc" pkg/miner.hoon > assets/miner.jam
    "\$NCK_DIR_SUB/target/release/hoonc" pkg/dumb.hoon > assets/dumb.jam
    "\$NCK_DIR_SUB/target/release/hoonc" pkg/wal.hoon > assets/wal.jam
    
    export RUSTFLAGS="-C target-cpu=native -C opt-level=3"
    export CARGO_PROFILE_RELEASE_LTO="true"
    # ä½¿ç”¨ get_num_cores å‡½æ•°è·å–æ ¸å¿ƒæ•°
    NUM_CORES=\$(nproc 2>/dev/null || grep -c '^processor' /proc/cpuinfo 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 4)
    cargo build --release --workspace --exclude hoonc -j"\$NUM_CORES"
    
    cp "\$NCK_DIR_SUB/target/release/nockchain" "\$HOME/.cargo/bin/"
    echo "--- [${MINER_USERNAME}] ç¼–è¯‘æˆåŠŸï¼ ---"
EOF

    local exit_code=$?
    if [ "$exit_code" -ne 0 ]; then
        echo -e "\n${RED}å®‰è£…å¤±è´¥ï¼è¯·æ£€æŸ¥ä¸Šé¢çš„é”™è¯¯ä¿¡æ¯ã€‚${RESET}"
    else
        echo -e "\n${GREEN}[âœ“] Nockchain å®‰è£…æˆåŠŸï¼${RESET}"
        echo -e "${YELLOW}--- æ­¥éª¤ 5/5: å®Œæˆ ---${RESET}"
        echo -e "${CYAN}æ¥ä¸‹æ¥ï¼Œè¯·ä½¿ç”¨èœå•é€‰é¡¹ '2' æ¥è®¾ç½®æ‚¨çš„æŒ–çŸ¿å…¬é’¥ã€‚${RESET}"
    fi
    pause_and_return
}

function set_pubkey() {
    check_root
    show_banner
    if [ ! -d "$NCK_DIR" ]; then
        echo -e "${RED}é”™è¯¯: Nockchain å°šæœªå®‰è£…ã€‚è¯·å…ˆé€‰æ‹© '1' è¿›è¡Œå®‰è£…ã€‚${RESET}"; pause_and_return; return
    fi
    local pubkey; read -r -p "è¯·è¾“å…¥æ‚¨çš„128ä½æŒ–çŸ¿å…¬é’¥: " pubkey
    if ! [[ "$pubkey" =~ ^[0-9a-fA-F]{128}$ ]]; then
        echo -e "\n${RED}é”™è¯¯: å…¬é’¥æ ¼å¼æ— æ•ˆã€‚${RESET}"; pause_and_return; return
    fi
    touch "$ENV_FILE"; chown "${MINER_USERNAME}:${MINER_USERNAME}" "$ENV_FILE"
    sed -i '/^MINING_PUBKEY=/d' "$ENV_FILE"; sed -i '/^MINER_THREADS=/d' "$ENV_FILE"
    echo "MINING_PUBKEY=$pubkey" >> "$ENV_FILE"
    echo "MINER_THREADS=$(get_num_cores)" >> "$ENV_FILE"
    echo -e "\n${GREEN}[âœ“] é…ç½®å·²æˆåŠŸä¿å­˜ï¼${RESET}"; pause_and_return
}

function start_node() {
    check_root
    show_banner
    if [[ "$(check_systemd)" != "true" ]]; then
        echo -e "${RED}é”™è¯¯: ç³»ç»Ÿä¸æ”¯æŒ Systemdã€‚${RESET}"; pause_and_return; return
    fi
    if [ ! -f "$ENV_FILE" ] || ! grep -q "MINING_PUBKEY" "$ENV_FILE"; then
        echo -e "${RED}é”™è¯¯: å°šæœªè®¾ç½®å…¬é’¥ã€‚${RESET}"; pause_and_return; return
    fi
    echo -e "${YELLOW}[*] æ­£åœ¨åˆ›å»ºå¹¶å¯åŠ¨ systemd æœåŠ¡...${RESET}"
    cat <<EOF > "$SERVICE_FILE"
[Unit]
Description=$SERVICE_NAME service
After=network-online.target
[Service]
User=${MINER_USERNAME}
Group=$(id -gn "${MINER_USERNAME}")
WorkingDirectory=${NCK_DIR}
EnvironmentFile=${ENV_FILE}
ExecStart=${MINER_HOME}/.cargo/bin/nockchain
Restart=on-failure; RestartSec=10; LimitNOFILE=65536; Nice=-5
[Install]
WantedBy=multi-user.target
EOF
    systemctl daemon-reload; systemctl enable "$SERVICE_NAME"; systemctl restart "$SERVICE_NAME"
    echo -e "\n${GREEN}[âœ“] æœåŠ¡ '${SERVICE_NAME}' å·²å¯åŠ¨å¹¶è®¾ä¸ºå¼€æœºè‡ªå¯ï¼${RESET}"; pause_and_return
}

function stop_node() {
    check_root; show_banner
    if ! systemctl list-units --full -all | grep -q "${SERVICE_NAME}.service"; then
        echo -e "${YELLOW}æç¤º: æœåŠ¡æœªå®‰è£…ï¼Œæ— éœ€åœæ­¢ã€‚${RESET}"; pause_and_return; return
    fi
    echo -e "${YELLOW}[*] æ­£åœ¨åœæ­¢ systemd æœåŠ¡...${RESET}"; systemctl stop "$SERVICE_NAME"
    echo -e "\n${GREEN}[âœ“] æœåŠ¡ '${SERVICE_NAME}' å·²åœæ­¢ã€‚${RESET}"; pause_and_return
}

function view_logs() {
    check_root; show_banner
    if ! systemctl list-units --full -all | grep -q "${SERVICE_NAME}.service"; then
        echo -e "${YELLOW}æç¤º: æœåŠ¡æœªå®‰è£…ï¼Œæ— æ³•æŸ¥çœ‹æ—¥å¿—ã€‚${RESET}"; pause_and_return; return
    fi
    echo -e "${YELLOW}æ­£åœ¨æ˜¾ç¤ºå®æ—¶æ—¥å¿—... æŒ‰ Ctrl+C é€€å‡ºæ—¥å¿—å¹¶è¿”å›èœå•ã€‚${RESET}"
    echo "------------------------------------------------------"
    journalctl -u "$SERVICE_NAME" -f --no-pager; pause_and_return
}

# ==============================================================================
# === ä¸»èœå•å’Œå¾ªç¯ ===
# ==============================================================================

function main_menu() {
    show_banner
    echo -e "${BOLD}${GREEN}--- ä¸»èœå• ---${RESET}"; echo "è¯·é€‰æ‹©è¦æ‰§è¡Œçš„æ“ä½œ:"; echo ""
    echo -e "  ${CYAN}1)${RESET} å…¨æ–°å®‰è£… Nockchain (ä¼šæ¸…ç©ºæ—§æ•°æ®)"
    echo -e "  ${CYAN}2)${RESET} è®¾ç½®/æ›´æ–°æŒ–çŸ¿å…¬é’¥"
    echo ""
    if [[ "$(check_systemd)" == "true" ]]; then
        if systemctl is-active --quiet "$SERVICE_NAME"; then SERVICE_STATUS="${GREEN}(è¿è¡Œä¸­)${RESET}"; else SERVICE_STATUS="${RED}(å·²åœæ­¢)${RESET}"; fi
        echo -e "  ${CYAN}3)${RESET} ${BOLD}å¯åŠ¨${RESET}æŒ–çŸ¿æœåŠ¡ ${SERVICE_STATUS}"
        echo -e "  ${CYAN}4)${RESET} ${BOLD}åœæ­¢${RESET}æŒ–çŸ¿æœåŠ¡"
        echo -e "  ${CYAN}5)${RESET} æŸ¥çœ‹å®æ—¶æ—¥å¿—"
    else
        echo -e "  ${RED}3-5) (ä¸å¯ç”¨) æ‚¨çš„ç³»ç»Ÿä¸æ”¯æŒ Systemd${RESET}"
    fi
    echo ""; echo -e "  ${YELLOW}0) é€€å‡ºè„šæœ¬${RESET}"; echo ""
    read -r -p "è¯·è¾“å…¥é€‰é¡¹ç¼–å·: " choice
    case "$choice" in
        1) install_all ;; 2) set_pubkey ;; 3) start_node ;; 4) stop_node ;; 5) view_logs ;;
        0) echo -e "${BLUE}æ„Ÿè°¢ä½¿ç”¨ï¼å†è§ã€‚${RESET}"; exit 0 ;;
        *) echo -e "${RED}æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚${RESET}"; sleep 1 ;;
    esac
}

# --- è„šæœ¬å…¥å£ ---
check_root
detect_system_info # è¿è¡Œä¸€æ¬¡ç³»ç»Ÿæ£€æµ‹
while true; do main_menu; done
