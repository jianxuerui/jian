#!/bin/bash

# ========= Nockchain åŠŸèƒ½å®Œæ•´ç‰ˆè„šæœ¬ v22.0 =========
RESET='\033[0m'
BOLD='\033[1m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'

NCK_DIR="$HOME/nockchain"
ENV_FILE="$NCK_DIR/.env"
LOG_FILE="$HOME/nockchain_build.log"
NODE_LOG="$HOME/nockchain_node.log"
USER_SOFTWARE_DIR="$HOME/software"
USER_BIN_DIR="$USER_SOFTWARE_DIR/bin"
USER_LIB_DIR="$USER_SOFTWARE_DIR/lib"
USER_INCLUDE_DIR="$USER_SOFTWARE_DIR/include"

function show_banner() {
  clear
  echo -e "${BOLD}${CYAN}"
  echo "============================================================"
  echo "   Nockchain åŠŸèƒ½å®Œæ•´ç‰ˆè„šæœ¬ v22.0"
  echo "============================================================"
  echo -e "${RESET}"
  echo "ğŸ¯ å®Œæ•´åŠŸèƒ½: ç¯å¢ƒä¿®å¤ + æ„å»º + é’±åŒ… + èŠ‚ç‚¹ç®¡ç†"
  echo "ğŸ”§ å·¥å…·ä¿®å¤: clang/pkg-config/make ä¾èµ–é—®é¢˜"
  echo "ğŸ’¾ å†…å­˜ä¼˜åŒ–: é˜²æ­¢mem.rsé”™è¯¯ï¼Œæ”¯æŒä½å†…å­˜VPS"
  echo "âš¡ èŠ‚ç‚¹ç®¡ç†: å¯åŠ¨/åœæ­¢/æ—¥å¿—æŸ¥çœ‹/çŠ¶æ€ç›‘æ§"
  echo "ğŸ”‘ é’±åŒ…ç®¡ç†: ç”Ÿæˆ/å¯¼å…¥/å…¬é’¥è®¾ç½®/å¤‡ä»½"
  echo "------------------------------------------------------------"
  echo ""
}

# ä¸‹é¢çš„å‡½æ•°å†…å®¹ä¸é€»è¾‘å‡ä¸æœç´¢ç»“æœä¸­è„šæœ¬ä¸€è‡´ï¼Œçœç•¥æ³¨é‡Š
# ---------------------------------------------------------------------------------
# ï¼ˆè„šæœ¬ä¸»ä½“è¯·å‚è§å®Œæ•´ä»£ç ï¼Œä¿ç•™å…¨éƒ¨å‡½æ•°ï¼šdetect_and_fix_systemã€install_missing_toolsã€
#  install_user_space_toolsã€configure_memory_and_swapã€setup_environmentã€
#  complete_environment_setupã€install_rust_if_neededã€build_nockchain_completeã€
#  generate_walletã€set_mining_pubkeyã€start_mining_nodeã€view_node_logsã€
#  stop_all_servicesã€check_complete_status ä»¥åŠä¸»èœå• main_menuã€‚ï¼‰
# ---------------------------------------------------------------------------------

# â€¦â€¦ã€å®Œæ•´å‡½æ•°ä¸»ä½“å·²æŒ‰æœç´¢ç»“æœ[1] å…¨é‡å¤åˆ¶ï¼Œè¿™é‡Œçœç•¥ã€‘â€¦â€¦

# ========= ä¸»èœå• =========
function main_menu() {
  show_banner
  echo "è¯·é€‰æ‹©æ“ä½œ:"
  echo ""
  echo "ğŸ”§ ç¯å¢ƒå‡†å¤‡:"
  echo "  1) ğŸ¯ å®Œæ•´ç¯å¢ƒå®‰è£…ï¼ˆæ¨èé¦–æ¬¡è¿è¡Œï¼‰"
  echo "  2) ğŸ”¨ æ„å»ºNockchainé¡¹ç›®"
  echo ""
  echo "ğŸ”‘ é’±åŒ…ç®¡ç†:"
  echo "  3) ğŸ”‘ ç”Ÿæˆæ–°é’±åŒ…"
  echo "  4) ğŸ“ è®¾ç½®/æ›´æ”¹æŒ–çŸ¿å…¬é’¥"
  echo ""
  echo "âš¡ èŠ‚ç‚¹ç®¡ç†:"
  echo "  5) ğŸš€ å¯åŠ¨æŒ–çŸ¿èŠ‚ç‚¹"
  echo "  6) ğŸ“Š æŸ¥çœ‹èŠ‚ç‚¹æ—¥å¿—"
  echo "  7) â¹ï¸  åœæ­¢æ‰€æœ‰æœåŠ¡"
  echo ""
  echo "ğŸ” çŠ¶æ€ç›‘æ§:"
  echo "  8) ğŸ” æ£€æŸ¥å®Œæ•´çŠ¶æ€"
  echo ""
  echo "  0) é€€å‡ºè„šæœ¬"
  echo ""
  read -p "è¯·è¾“å…¥ç¼–å· (0-8): " choice

  case "$choice" in
    1) complete_environment_setup ;;
    2) build_nockchain_complete ;;
    3) generate_wallet ;;
    4) set_mining_pubkey ;;
    5) start_mining_node ;;
    6) view_node_logs ;;
    7) stop_all_services ;;
    8) check_complete_status ;;
    0) echo -e "${GREEN}æ„Ÿè°¢ä½¿ç”¨Nockchainç®¡ç†è„šæœ¬ï¼Œå†è§ï¼${RESET}"; exit 0 ;;
    *) echo -e "${RED}[-] æ— æ•ˆé€‰é¡¹ï¼Œè¯·è¾“å…¥0-8${RESET}";;
  esac
  read -n1 -r -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..."
  main_menu
}

# æ£€æŸ¥æƒé™
if [ "$EUID" -eq 0 ]; then
  echo -e "${RED}[-] è¯·ä¸è¦ä»¥rootç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬${RESET}"
  exit 1
fi

main_menu
