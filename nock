#!/bin/bash

# ========= Nockchain é¢„ç¼–è¯‘äºŒè¿›åˆ¶ç‰ˆæ„å»ºè„šæœ¬ v18.0 =========
RESET='\033[0m'
BOLD='\033[1m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'

NCK_DIR="$HOME/nockchain"
ENV_FILE="$NCK_DIR/.env"
LOG_FILE="$HOME/nockchain_build.log"
USER_SOFTWARE_DIR="$HOME/software"
USER_BIN_DIR="$USER_SOFTWARE_DIR/bin"
USER_LIB_DIR="$USER_SOFTWARE_DIR/lib"
USER_INCLUDE_DIR="$USER_SOFTWARE_DIR/include"

function show_banner() {
  clear
  echo -e "${BOLD}${CYAN}"
  echo "============================================================"
  echo "   Nockchain é¢„ç¼–è¯‘äºŒè¿›åˆ¶ç‰ˆæ„å»ºè„šæœ¬ v18.0"
  echo "============================================================"
  echo -e "${RESET}"
  echo "ğŸš€ é¢„ç¼–è¯‘ç‰ˆ: ä½¿ç”¨ç°æˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œé¿å…é•¿æ—¶é—´æºç ç¼–è¯‘"
  echo "âš¡ å¿«é€Ÿéƒ¨ç½²: 5-10åˆ†é’Ÿå®Œæˆå…¨éƒ¨å·¥å…·å®‰è£…"
  echo "ğŸ¯ ä¸“é—¨ä¿®å¤: å·¥å…·éªŒè¯å¤±è´¥ï¼Œgcc/clangç­‰æœªæ‰¾åˆ°é—®é¢˜"
  echo "ğŸ“¦ å¤šæºä¸‹è½½: GitHubã€å®˜æ–¹é•œåƒã€å¤‡ç”¨æºå¤šé‡ä¿éšœ"
  echo "ğŸ”§ è½»é‡çº§: æœ€å°åŒ–å®‰è£…ï¼Œåªå®‰è£…å¿…éœ€çš„å·¥å…·"
  echo "------------------------------------------------------------"
  echo ""
}

# ========= è®¾ç½®åŸºç¡€ç¯å¢ƒ =========
function setup_base_environment() {
  echo -e "[*] è®¾ç½®åŸºç¡€ç¯å¢ƒ..."
  
  # åˆ›å»ºç›®å½•ç»“æ„
  mkdir -p "$USER_SOFTWARE_DIR"/{bin,lib,lib64,include,share,src,build}
  
  # è®¾ç½®ç¯å¢ƒå˜é‡[2]
  export PATH="$USER_BIN_DIR:$PATH"
  export LD_LIBRARY_PATH="$USER_LIB_DIR:$USER_SOFTWARE_DIR/lib64:$LD_LIBRARY_PATH"
  export PKG_CONFIG_PATH="$USER_LIB_DIR/pkgconfig:$USER_SOFTWARE_DIR/lib64/pkgconfig:$PKG_CONFIG_PATH"
  export C_INCLUDE_PATH="$USER_INCLUDE_DIR:$C_INCLUDE_PATH"
  export CPLUS_INCLUDE_PATH="$USER_INCLUDE_DIR:$CPLUS_INCLUDE_PATH"
  
  echo -e "${GREEN}[+] åŸºç¡€ç¯å¢ƒè®¾ç½®å®Œæˆ${RESET}"
}

# ========= ä¸‹è½½å·¥å…·å‡½æ•° =========
function download_with_retry() {
  local url="$1"
  local output="$2"
  local max_attempts=3
  
  for attempt in $(seq 1 $max_attempts); do
    echo -e "[*] ä¸‹è½½å°è¯• $attempt/$max_attempts: $(basename "$output")"
    
    if command -v wget >/dev/null 2>&1; then
      if wget -q -O "$output" "$url"; then
        echo -e "${GREEN}[+] ä¸‹è½½æˆåŠŸ${RESET}"
        return 0
      fi
    elif command -v curl >/dev/null 2>&1; then
      if curl -fsSL -o "$output" "$url"; then
        echo -e "${GREEN}[+] ä¸‹è½½æˆåŠŸ${RESET}"
        return 0
      fi
    fi
    
    echo -e "${YELLOW}[!] ä¸‹è½½å¤±è´¥ï¼Œé‡è¯•...${RESET}"
    sleep 5
  done
  
  echo -e "${RED}[-] ä¸‹è½½å¤±è´¥: $url${RESET}"
  return 1
}

# ========= å®‰è£…é¢„ç¼–è¯‘GCC =========
function install_prebuilt_gcc() {
  echo -e "[*] å®‰è£…é¢„ç¼–è¯‘GCC..."
  
  cd "$USER_SOFTWARE_DIR/src"
  
  # æ£€æŸ¥ç³»ç»Ÿæ¶æ„
  arch=$(uname -m)
  if [ "$arch" != "x86_64" ]; then
    echo -e "${YELLOW}[!] éx86_64æ¶æ„ï¼Œè·³è¿‡GCCå®‰è£…${RESET}"
    return 1
  fi
  
  # ä¸‹è½½é¢„ç¼–è¯‘GCC 9.4.0[4]
  gcc_url="https://github.com/spack/spack-bootstrap-mirrors/releases/download/v0.4/gcc-9.4.0-x86_64.tar.gz"
  gcc_file="gcc-9.4.0-x86_64.tar.gz"
  
  if [ ! -f "$gcc_file" ]; then
    if ! download_with_retry "$gcc_url" "$gcc_file"; then
      echo -e "${YELLOW}[!] é¢„ç¼–è¯‘GCCä¸‹è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æº...${RESET}"
      # å¤‡ç”¨æºï¼šä½¿ç”¨æ›´å°çš„GCCç‰ˆæœ¬
      gcc_url="https://ftp.gnu.org/gnu/gcc/gcc-7.5.0/gcc-7.5.0.tar.gz"
      if ! download_with_retry "$gcc_url" "gcc-7.5.0.tar.gz"; then
        return 1
      fi
      gcc_file="gcc-7.5.0.tar.gz"
    fi
  fi
  
  echo -e "[*] è§£å‹GCC..."
  if [[ "$gcc_file" == *"x86_64.tar.gz" ]]; then
    # é¢„ç¼–è¯‘ç‰ˆæœ¬ç›´æ¥è§£å‹åˆ°ç›®æ ‡ç›®å½•
    tar -xzf "$gcc_file" -C "$USER_SOFTWARE_DIR/" --strip-components=1
    
    # éªŒè¯å®‰è£…
    if [ -f "$USER_BIN_DIR/gcc" ]; then
      chmod +x "$USER_BIN_DIR/gcc" "$USER_BIN_DIR/g++"
      echo -e "${GREEN}[+] é¢„ç¼–è¯‘GCCå®‰è£…æˆåŠŸ${RESET}"
      return 0
    fi
  fi
  
  echo -e "${YELLOW}[!] é¢„ç¼–è¯‘GCCå®‰è£…å¤±è´¥${RESET}"
  return 1
}

# ========= å®‰è£…è½»é‡çº§æ„å»ºå·¥å…· =========
function install_lightweight_tools() {
  echo -e "[*] å®‰è£…è½»é‡çº§æ„å»ºå·¥å…·..."
  
  cd "$USER_SOFTWARE_DIR/src"
  
  # å®‰è£…musl-gccï¼ˆè½»é‡çº§Cç¼–è¯‘å™¨ï¼‰
  echo -e "[*] å®‰è£…musl-gcc..."
  musl_url="https://musl.cc/x86_64-linux-musl-cross.tgz"
  musl_file="x86_64-linux-musl-cross.tgz"
  
  if download_with_retry "$musl_url" "$musl_file"; then
    tar -xzf "$musl_file"
    cp -r x86_64-linux-musl-cross/* "$USER_SOFTWARE_DIR/"
    
    # åˆ›å»ºgccè½¯é“¾æ¥
    if [ -f "$USER_SOFTWARE_DIR/bin/x86_64-linux-musl-gcc" ]; then
      ln -sf "$USER_SOFTWARE_DIR/bin/x86_64-linux-musl-gcc" "$USER_BIN_DIR/gcc"
      ln -sf "$USER_SOFTWARE_DIR/bin/x86_64-linux-musl-g++" "$USER_BIN_DIR/g++"
      echo -e "${GREEN}[+] musl-gccå®‰è£…æˆåŠŸ${RESET}"
    fi
  fi
  
  # å®‰è£…clangé¢„ç¼–è¯‘ç‰ˆ[4]
  echo -e "[*] å®‰è£…é¢„ç¼–è¯‘Clang..."
  clang_url="https://github.com/llvm/llvm-project/releases/download/llvmorg-14.0.6/clang+llvm-14.0.6-x86_64-linux-gnu-ubuntu-18.04.tar.xz"
  clang_file="clang+llvm-14.0.6-x86_64-linux-gnu-ubuntu-18.04.tar.xz"
  
  if download_with_retry "$clang_url" "$clang_file"; then
    tar -xf "$clang_file"
    cp -r clang+llvm-14.0.6-x86_64-linux-gnu-ubuntu-18.04/* "$USER_SOFTWARE_DIR/"
    echo -e "${GREEN}[+] é¢„ç¼–è¯‘Clangå®‰è£…æˆåŠŸ${RESET}"
  fi
  
  # å®‰è£…make
  echo -e "[*] å®‰è£…GNU Make..."
  make_url="https://ftp.gnu.org/gnu/make/make-4.3.tar.gz"
  make_file="make-4.3.tar.gz"
  
  if download_with_retry "$make_url" "$make_file"; then
    tar -xzf "$make_file"
    cd make-4.3
    
    # ç®€åŒ–é…ç½®ï¼Œé¿å…ä¾èµ–é—®é¢˜
    ./configure --prefix="$USER_SOFTWARE_DIR" --disable-nls
    make -j$(nproc) && make install
    cd ..
    echo -e "${GREEN}[+] GNU Makeå®‰è£…æˆåŠŸ${RESET}"
  fi
  
  # å®‰è£…cmake
  echo -e "[*] å®‰è£…CMake..."[2]
  cmake_url="https://github.com/Kitware/CMake/releases/download/v3.25.2/cmake-3.25.2-linux-x86_64.tar.gz"
  cmake_file="cmake-3.25.2-linux-x86_64.tar.gz"
  
  if download_with_retry "$cmake_url" "$cmake_file"; then
    tar -xzf "$cmake_file"
    cp -r cmake-3.25.2-linux-x86_64/* "$USER_SOFTWARE_DIR/"
    echo -e "${GREEN}[+] CMakeå®‰è£…æˆåŠŸ${RESET}"
  fi
  
  # å®‰è£…pkg-config
  echo -e "[*] å®‰è£…pkg-config..."
  pkgconfig_url="https://pkgconfig.freedesktop.org/releases/pkg-config-0.29.2.tar.gz"
  pkgconfig_file="pkg-config-0.29.2.tar.gz"
  
  if download_with_retry "$pkgconfig_url" "$pkgconfig_file"; then
    tar -xzf "$pkgconfig_file"
    cd pkg-config-0.29.2
    ./configure --prefix="$USER_SOFTWARE_DIR" --with-internal-glib
    make -j$(nproc) && make install
    cd ..
    echo -e "${GREEN}[+] pkg-configå®‰è£…æˆåŠŸ${RESET}"
  fi
}

# ========= å®‰è£…åŸºç¡€å¼€å‘åº“ =========
function install_basic_libraries() {
  echo -e "[*] å®‰è£…åŸºç¡€å¼€å‘åº“..."
  
  cd "$USER_SOFTWARE_DIR/src"
  
  # å®‰è£…zlib
  echo -e "[*] å®‰è£…zlib..."
  zlib_url="https://zlib.net/zlib-1.2.13.tar.gz"
  if download_with_retry "$zlib_url" "zlib-1.2.13.tar.gz"; then
    tar -xzf zlib-1.2.13.tar.gz
    cd zlib-1.2.13
    ./configure --prefix="$USER_SOFTWARE_DIR"
    make -j$(nproc) && make install
    cd ..
  fi
  
  # å®‰è£…openssl
  echo -e "[*] å®‰è£…OpenSSL..."
  openssl_url="https://www.openssl.org/source/openssl-1.1.1w.tar.gz"
  if download_with_retry "$openssl_url" "openssl-1.1.1w.tar.gz"; then
    tar -xzf openssl-1.1.1w.tar.gz
    cd openssl-1.1.1w
    ./config --prefix="$USER_SOFTWARE_DIR" --openssldir="$USER_SOFTWARE_DIR/ssl" shared zlib
    make -j$(nproc) && make install
    cd ..
  fi
  
  echo -e "${GREEN}[+] åŸºç¡€åº“å®‰è£…å®Œæˆ${RESET}"
}

# ========= ä¿®å¤å·¥å…·è·¯å¾„å’Œæƒé™ =========
function fix_tools_and_permissions() {
  echo -e "[*] ä¿®å¤å·¥å…·è·¯å¾„å’Œæƒé™..."
  
  cd "$USER_BIN_DIR"
  
  # ç¡®ä¿æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶æœ‰æ‰§è¡Œæƒé™
  chmod +x * 2>/dev/null || true
  
  # åˆ›å»ºç¼ºå¤±çš„è½¯é“¾æ¥
  if [ ! -f "gcc" ] && [ -f "x86_64-linux-musl-gcc" ]; then
    ln -sf x86_64-linux-musl-gcc gcc
  fi
  
  if [ ! -f "g++" ] && [ -f "x86_64-linux-musl-g++" ]; then
    ln -sf x86_64-linux-musl-g++ g++
  fi
  
  if [ ! -f "clang" ] && [ -f "clang-14" ]; then
    ln -sf clang-14 clang
  fi
  
  if [ ! -f "clang++" ] && [ -f "clang++-14" ]; then
    ln -sf clang++-14 clang++
  fi
  
  # åˆ›å»ºæ ‡å‡†å·¥å…·çš„å¤‡ç”¨ç‰ˆæœ¬
  if [ ! -f "cc" ] && [ -f "gcc" ]; then
    ln -sf gcc cc
  fi
  
  echo -e "${GREEN}[+] å·¥å…·ä¿®å¤å®Œæˆ${RESET}"
}

# ========= è®¾ç½®ç¯å¢ƒå˜é‡æ–‡ä»¶ =========
function setup_environment_file() {
  echo -e "[*] è®¾ç½®ç¯å¢ƒå˜é‡æ–‡ä»¶..."
  
  # åˆ›å»ºç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶[2]
  cat > "$HOME/.nockchain_env" << EOF
#!/bin/bash
# Nockchainç”¨æˆ·ç¼–è¯‘ç¯å¢ƒå˜é‡ - é¢„ç¼–è¯‘ç‰ˆ
export PATH="$USER_BIN_DIR:\$PATH"
export LD_LIBRARY_PATH="$USER_LIB_DIR:$USER_SOFTWARE_DIR/lib64:\$LD_LIBRARY_PATH"
export PKG_CONFIG_PATH="$USER_LIB_DIR/pkgconfig:$USER_SOFTWARE_DIR/lib64/pkgconfig:\$PKG_CONFIG_PATH"
export C_INCLUDE_PATH="$USER_INCLUDE_DIR:\$C_INCLUDE_PATH"
export CPLUS_INCLUDE_PATH="$USER_INCLUDE_DIR:\$CPLUS_INCLUDE_PATH"
export LIBRARY_PATH="$USER_LIB_DIR:$USER_SOFTWARE_DIR/lib64:\$LIBRARY_PATH"
export CPATH="$USER_INCLUDE_DIR:\$CPATH"

# ç¼–è¯‘å™¨è®¾ç½®
export CC=gcc
export CXX=g++
if command -v clang >/dev/null 2>&1; then
  export CC=clang
  export CXX=clang++
  export LIBCLANG_PATH="$USER_LIB_DIR"
  export LLVM_CONFIG_PATH="$USER_BIN_DIR/llvm-config"
fi

# Rustå’ŒCargoè®¾ç½®
export CARGO_BUILD_JOBS=1
export RUSTFLAGS="-C opt-level=1 -C debuginfo=0 -C panic=abort"
export RUST_BACKTRACE=1
EOF
  
  # æ·»åŠ åˆ°bashrc
  if ! grep -q "source.*nockchain_env" "$HOME/.bashrc" 2>/dev/null; then
    echo "" >> "$HOME/.bashrc"
    echo "# Nockchainé¢„ç¼–è¯‘ç¯å¢ƒ - è‡ªåŠ¨æ·»åŠ " >> "$HOME/.bashrc"
    echo "source \$HOME/.nockchain_env" >> "$HOME/.bashrc"
  fi
  
  # ç«‹å³åŠ è½½ç¯å¢ƒå˜é‡
  source "$HOME/.nockchain_env"
  
  echo -e "${GREEN}[+] ç¯å¢ƒå˜é‡é…ç½®å®Œæˆ${RESET}"
}

# ========= éªŒè¯å·¥å…·å®‰è£… =========
function verify_tools_final() {
  echo -e "[*] æœ€ç»ˆéªŒè¯å·¥å…·å®‰è£…..."
  
  # åŠ è½½ç¯å¢ƒå˜é‡
  source "$HOME/.nockchain_env" 2>/dev/null || true
  
  echo -e "${BLUE}[i] éªŒè¯å…³é”®å·¥å…·:${RESET}"
  tools_success=0
  total_tools=7
  
  for tool in gcc g++ clang make cmake pkg-config git; do
    if command -v "$tool" >/dev/null 2>&1; then
      tool_path=$(command -v "$tool")
      tool_version=$(eval "$tool --version 2>/dev/null | head -1" | cut -d' ' -f1-3 || echo "unknown")
      echo -e "${GREEN}  âœ“ $tool: $tool_version${RESET}"
      echo -e "${BLUE}    è·¯å¾„: $tool_path${RESET}"
      ((tools_success++))
    else
      echo -e "${RED}  âœ— $tool: æœªæ‰¾åˆ°${RESET}"
    fi
  done
  
  echo -e "${BLUE}[i] å·¥å…·å¯ç”¨æ€§: $tools_success/$total_tools ($(( tools_success * 100 / total_tools ))%)${RESET}"
  
  # æµ‹è¯•ç¼–è¯‘åŠŸèƒ½
  echo -e "[*] æµ‹è¯•åŸºç¡€ç¼–è¯‘åŠŸèƒ½..."
  
  test_c_file="$USER_SOFTWARE_DIR/test.c"
  cat > "$test_c_file" << 'EOF'
#include <stdio.h>
int main() {
    printf("Hello, Nockchain!\n");
    return 0;
}
EOF
  
  if command -v gcc >/dev/null 2>&1; then
    if gcc -o "$USER_SOFTWARE_DIR/test" "$test_c_file" 2>/dev/null; then
      echo -e "${GREEN}[+] GCCç¼–è¯‘æµ‹è¯•é€šè¿‡${RESET}"
      rm -f "$USER_SOFTWARE_DIR/test" "$test_c_file"
    else
      echo -e "${YELLOW}[!] GCCç¼–è¯‘æµ‹è¯•å¤±è´¥${RESET}"
    fi
  fi
  
  if [ $tools_success -ge 5 ]; then
    echo -e "${GREEN}[+] âœ… å·¥å…·éªŒè¯é€šè¿‡ï¼å¯ä»¥å¼€å§‹æ„å»ºNockchain${RESET}"
    return 0
  else
    echo -e "${YELLOW}[!] éƒ¨åˆ†å·¥å…·ç¼ºå¤±ï¼Œä½†å¯å°è¯•ç»§ç»­${RESET}"
    return 1
  fi
}

# ========= å®‰è£…Rust =========
function install_rust_optimized() {
  echo -e "[*] å®‰è£…Rustï¼ˆä¼˜åŒ–ç‰ˆï¼‰..."
  
  if ! command -v rustc >/dev/null 2>&1; then
    echo -e "[*] ä¸‹è½½å¹¶å®‰è£…Rust..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
  else
    echo -e "[*] æ›´æ–°ç°æœ‰Rust..."
    rustup update stable 2>/dev/null || true
  fi
  
  source "$HOME/.cargo/env"
  export PATH="$HOME/.cargo/bin:$PATH"
  
  # ä¼˜åŒ–Cargoé…ç½®
  mkdir -p "$HOME/.cargo"
  cat > "$HOME/.cargo/config.toml" << 'EOF'
[build]
jobs = 1

[net]
retry = 50
timeout = 1800

[profile.release]
opt-level = 1
debug = false
lto = "off"
panic = "abort"
codegen-units = 1
strip = true

[profile.dev]
opt-level = 0
debug = false
codegen-units = 1
EOF
  
  echo -e "${GREEN}[+] Rustå®‰è£…å®Œæˆ: $(rustc --version)${RESET}"
}

# ========= ä¸»å®‰è£…æµç¨‹ =========
function complete_prebuilt_installation() {
  echo -e "[*] å¼€å§‹é¢„ç¼–è¯‘ç‰ˆå¿«é€Ÿå®‰è£…..."
  
  echo "=== Nockchainé¢„ç¼–è¯‘ç‰ˆå®‰è£…æ—¥å¿— $(date) ===" > "$LOG_FILE"
  
  echo -e "${BLUE}[i] æ­¥éª¤1/7: è®¾ç½®åŸºç¡€ç¯å¢ƒ...${RESET}"
  setup_base_environment
  
  echo -e "${BLUE}[i] æ­¥éª¤2/7: å®‰è£…é¢„ç¼–è¯‘GCC...${RESET}"
  install_prebuilt_gcc
  
  echo -e "${BLUE}[i] æ­¥éª¤3/7: å®‰è£…è½»é‡çº§å·¥å…·...${RESET}"
  install_lightweight_tools
  
  echo -e "${BLUE}[i] æ­¥éª¤4/7: å®‰è£…åŸºç¡€åº“...${RESET}"
  install_basic_libraries
  
  echo -e "${BLUE}[i] æ­¥éª¤5/7: ä¿®å¤å·¥å…·å’Œæƒé™...${RESET}"
  fix_tools_and_permissions
  
  echo -e "${BLUE}[i] æ­¥éª¤6/7: è®¾ç½®ç¯å¢ƒå˜é‡...${RESET}"
  setup_environment_file
  
  echo -e "${BLUE}[i] æ­¥éª¤7/7: æœ€ç»ˆéªŒè¯...${RESET}"
  if verify_tools_final; then
    echo -e "${GREEN}[+] âœ… é¢„ç¼–è¯‘ç‰ˆå®‰è£…å®Œæˆï¼${RESET}"
    echo -e "${BLUE}[i] æ‰€æœ‰ä¸»è¦å·¥å…·å·²å¯ç”¨${RESET}"
    echo -e "${BLUE}[i] ä¸‹ä¸€æ­¥: å®‰è£…Rustå¹¶æ„å»ºNockchain${RESET}"
  else
    echo -e "${YELLOW}[!] éƒ¨åˆ†å·¥å…·å®‰è£…å¤±è´¥ï¼Œä½†å¯ä»¥å°è¯•ç»§ç»­${RESET}"
  fi
  
  echo -e "${BLUE}[i] ç¯å¢ƒé…ç½®æ–‡ä»¶: $HOME/.nockchain_env${RESET}"
  echo -e "${BLUE}[i] è¯¦ç»†æ—¥å¿—: $LOG_FILE${RESET}"
  pause_and_return
}

# ========= æ„å»ºNockchain =========
function build_nockchain_prebuilt() {
  echo -e "[*] ä½¿ç”¨é¢„ç¼–è¯‘å·¥å…·æ„å»ºNockchain..."
  
  # åŠ è½½ç¯å¢ƒå˜é‡
  source "$HOME/.nockchain_env" 2>/dev/null || true
  source "$HOME/.cargo/env" 2>/dev/null || true
  
  # å®‰è£…Rustï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
  if ! command -v rustc >/dev/null 2>&1; then
    install_rust_optimized
  fi
  
  # éªŒè¯å¿…è¦å·¥å…·
  missing_tools=()
  for tool in make git rustc cargo; do
    if ! command -v "$tool" >/dev/null 2>&1; then
      missing_tools+=("$tool")
    fi
  done
  
  if [ ${#missing_tools[@]} -gt 0 ]; then
    echo -e "${RED}[-] ç¼ºå°‘å¿…è¦å·¥å…·: ${missing_tools[*]}${RESET}"
    echo -e "${YELLOW}[!] è¯·å…ˆè¿è¡Œé¢„ç¼–è¯‘ç‰ˆå®‰è£…${RESET}"
    pause_and_return
    return
  fi
  
  # å…‹éš†æˆ–å‡†å¤‡é¡¹ç›®
  if [ ! -d "$NCK_DIR" ]; then
    echo -e "[*] å…‹éš†Nockchainé¡¹ç›®..."
    git clone --depth 1 https://github.com/zorp-corp/nockchain "$NCK_DIR" || {
      echo -e "${RED}[-] é¡¹ç›®å…‹éš†å¤±è´¥${RESET}"
      pause_and_return
      return
    }
  fi
  
  cd "$NCK_DIR"
  
  # æ¸…ç†æ„å»ºç¯å¢ƒ
  cargo clean >/dev/null 2>&1 || true
  rm -rf target/ 2>/dev/null || true
  
  # å‡†å¤‡é…ç½®æ–‡ä»¶
  if [ -f ".env_example" ]; then
    cp .env_example .env
  else
    cat > .env << 'EOF'
MINING_PUBKEY=
RUST_LOG=info
EOF
  fi
  
  # åˆ›å»ºå¿…è¦ç›®å½•
  mkdir -p assets .socket test-leader logs
  touch assets/wal.jam assets/dumb.jam assets/miner.jam 2>/dev/null || true
  
  echo -e "[*] å¼€å§‹æ„å»ºNockchainç»„ä»¶..."
  
  # è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
  export CARGO_BUILD_JOBS=1
  export RUSTFLAGS="-C opt-level=1 -C debuginfo=0"
  
  # æ„å»ºhoonc
  echo -e "[*] æ„å»ºhooncç¼–è¯‘å™¨..."
  if timeout 3600 make install-hoonc >>"$LOG_FILE" 2>&1; then
    echo -e "${GREEN}[+] hooncæ„å»ºæˆåŠŸ${RESET}"
  else
    echo -e "${YELLOW}[!] hooncæ„å»ºå¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—äº†è§£è¯¦æƒ…${RESET}"
  fi
  
  # æ„å»ºä¸»é¡¹ç›®
  echo -e "[*] æ„å»ºä¸»é¡¹ç›®..."
  if timeout 7200 make build >>"$LOG_FILE" 2>&1; then
    echo -e "${GREEN}[+] ä¸»é¡¹ç›®æ„å»ºæˆåŠŸ${RESET}"
  else
    echo -e "${YELLOW}[!] ä¸»é¡¹ç›®æ„å»ºå¤±è´¥ï¼Œå°è¯•å•ç‹¬æ„å»º...${RESET}"
    for component in "nockchain-wallet" "nockchain"; do
      echo -e "[*] æ„å»º $component..."
      timeout 3600 cargo build --bin "$component" --release >>"$LOG_FILE" 2>&1 || true
    done
  fi
  
  # éªŒè¯æ„å»ºç»“æœ
  echo -e "[*] éªŒè¯æ„å»ºç»“æœ..."
  component_count=0
  for binary in "hoonc" "nockchain-wallet" "nockchain"; do
    if command -v "$binary" >/dev/null 2>&1 || [ -f "target/release/$binary" ]; then
      echo -e "${GREEN}  âœ“ $binary: æ„å»ºæˆåŠŸ${RESET}"
      ((component_count++))
    else
      echo -e "${RED}  âœ— $binary: æ„å»ºå¤±è´¥${RESET}"
    fi
  done
  
  echo -e "${BLUE}[i] æ„å»ºæˆåŠŸ: $component_count/3 ä¸ªç»„ä»¶${RESET}"
  
  if [ $component_count -ge 2 ]; then
    echo -e "${GREEN}[+] âœ… Nockchainæ„å»ºæˆåŠŸï¼${RESET}"
    echo -e "${BLUE}[i] ä¸‹ä¸€æ­¥: ç”Ÿæˆé’±åŒ…å’Œè®¾ç½®æŒ–çŸ¿å…¬é’¥${RESET}"
  else
    echo -e "${YELLOW}[!] æ„å»ºéƒ¨åˆ†å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—${RESET}"
  fi
  
  pause_and_return
}

# ========= å…¶ä»–åŠŸèƒ½ä¿æŒä¸å˜ =========
function generate_wallet() {
  echo -e "[*] ç”Ÿæˆé’±åŒ…..."
  cd "$NCK_DIR" || return
  source "$HOME/.cargo/env" 2>/dev/null || true
  
  if command -v nockchain-wallet >/dev/null 2>&1; then
    nockchain-wallet keygen
  elif [ -f "target/release/nockchain-wallet" ]; then
    ./target/release/nockchain-wallet keygen
  else
    echo -e "${RED}[-] æœªæ‰¾åˆ°nockchain-walletç¨‹åº${RESET}"
  fi
  pause_and_return
}

function set_mining_pubkey() {
  echo -e "[*] è®¾ç½®æŒ–çŸ¿å…¬é’¥..."
  cd "$NCK_DIR" || return
  
  read -p "è¯·è¾“å…¥å®Œæ•´çš„æŒ–çŸ¿å…¬é’¥: " pubkey
  
  if [ ${#pubkey} -eq 128 ] && [[ "$pubkey" =~ ^[0-9a-f]{128}$ ]]; then
    sed -i '/^MINING_PUBKEY=/d' "$ENV_FILE" 2>/dev/null || true
    echo "MINING_PUBKEY=$pubkey" >> "$ENV_FILE"
    echo -e "${GREEN}[+] å…¬é’¥å·²æˆåŠŸå†™å…¥.envæ–‡ä»¶${RESET}"
  else
    echo -e "${RED}[-] å…¬é’¥æ ¼å¼é”™è¯¯ï¼Œéœ€è¦128ä½16è¿›åˆ¶${RESET}"
  fi
  pause_and_return
}

function start_node() {
  echo -e "[*] å¯åŠ¨èŠ‚ç‚¹..."
  cd "$NCK_DIR" || return
  source "$HOME/.cargo/env" 2>/dev/null || true
  
  if [ ! -f "$ENV_FILE" ] || [ -z "$(grep MINING_PUBKEY "$ENV_FILE" | cut -d'=' -f2)" ]; then
    echo -e "${RED}[-] è¯·å…ˆè®¾ç½®æŒ–çŸ¿å…¬é’¥${RESET}"
    pause_and_return
    return
  fi
  
  source "$ENV_FILE"
  pkill -f nockchain 2>/dev/null || true
  find . -name "*.sock" -delete 2>/dev/null || true
  mkdir -p .socket test-leader
  
  start_cmd="RUST_LOG=info nockchain --mining-pubkey $MINING_PUBKEY --mine --peer /ip4/95.216.102.60/udp/3006/quic-v1 --peer /ip4/65.109.156.108/udp/3006/quic-v1 --peer /ip4/65.21.67.175/udp/3006/quic-v1 --peer /ip4/65.109.156.172/udp/3006/quic-v1 --peer /ip4/34.174.22.166/udp/3006/quic-v1 --npc-socket .socket/nockchain.sock --bind /ip4/0.0.0.0/udp/3006/quic-v1"
  
  if command -v screen >/dev/null 2>&1; then
    screen -dmS nockchain bash -c "cd '$NCK_DIR' && $start_cmd"
    echo -e "${GREEN}[+] èŠ‚ç‚¹å·²å¯åŠ¨ï¼ˆscreenä¼šè¯ï¼‰${RESET}"
  else
    nohup bash -c "$start_cmd" > nockchain.log 2>&1 &
    echo -e "${GREEN}[+] èŠ‚ç‚¹å·²åå°å¯åŠ¨${RESET}"
  fi
  pause_and_return
}

function check_status() {
  echo -e "[*] æ£€æŸ¥çŠ¶æ€..."
  source "$HOME/.nockchain_env" 2>/dev/null || true
  
  echo -e "${BLUE}[i] å·¥å…·çŠ¶æ€:${RESET}"
  for tool in gcc g++ clang make cmake pkg-config git rustc cargo; do
    if command -v "$tool" >/dev/null 2>&1; then
      echo -e "  âœ“ $tool: $(command -v "$tool")"
    else
      echo -e "  âœ— $tool: æœªæ‰¾åˆ°"
    fi
  done
  
  echo -e "${BLUE}[i] Nockchainç»„ä»¶:${RESET}"
  if [ -d "$NCK_DIR" ]; then
    cd "$NCK_DIR"
    for binary in "hoonc" "nockchain-wallet" "nockchain"; do
      if command -v "$binary" >/dev/null 2>&1 || [ -f "target/release/$binary" ]; then
        echo -e "  âœ“ $binary: å¯ç”¨"
      else
        echo -e "  âœ— $binary: æœªæ‰¾åˆ°"
      fi
    done
  fi
  pause_and_return
}

function pause_and_return() {
  echo ""
  read -n1 -r -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..." key
  main_menu
}

# ========= ä¸»èœå• =========
function main_menu() {
  show_banner
  echo "è¯·é€‰æ‹©æ“ä½œ:"
  echo ""
  echo "ğŸš€ å¿«é€Ÿå®‰è£…:"
  echo "  1) ğŸ¯ é¢„ç¼–è¯‘ç‰ˆç¯å¢ƒå®‰è£…ï¼ˆæ¨èï¼‰"
  echo "  2) ğŸ”§ æ„å»ºNockchainé¡¹ç›®"
  echo ""
  echo "ğŸ”‘ é’±åŒ…ç®¡ç†:"
  echo "  3) ğŸ”‘ ç”Ÿæˆé’±åŒ…"
  echo "  4) ğŸ“ è®¾ç½®æŒ–çŸ¿å…¬é’¥"
  echo ""
  echo "âš¡ èŠ‚ç‚¹ç®¡ç†:"
  echo "  5) âš¡ å¯åŠ¨èŠ‚ç‚¹"
  echo "  6) ğŸ” æ£€æŸ¥çŠ¶æ€"
  echo ""
  echo "  0) é€€å‡ºè„šæœ¬"
  echo ""
  echo -e "${CYAN}ğŸ¯ ä¸“é—¨ä¿®å¤: å·¥å…·éªŒè¯å¤±è´¥ï¼Œgcc/clangç­‰æœªæ‰¾åˆ°é—®é¢˜${RESET}"
  echo -e "${CYAN}âš¡ å¿«é€Ÿéƒ¨ç½²: ä½¿ç”¨é¢„ç¼–è¯‘äºŒè¿›åˆ¶ï¼Œ5-10åˆ†é’Ÿå®Œæˆ${RESET}"
  echo -e "${CYAN}ğŸ“¦ è½»é‡çº§: æœ€å°åŒ–å®‰è£…ï¼Œé¿å…é•¿æ—¶é—´æºç ç¼–è¯‘${RESET}"
  echo ""
  read -p "è¯·è¾“å…¥ç¼–å· (0-6): " choice

  case "$choice" in
    1) complete_prebuilt_installation ;;
    2) build_nockchain_prebuilt ;;
    3) generate_wallet ;;
    4) set_mining_pubkey ;;
    5) start_node ;;
    6) check_status ;;
    0) echo "é€€å‡ºè„šæœ¬."; exit 0 ;;
    *) echo -e "${RED}[-] æ— æ•ˆé€‰é¡¹${RESET}"; pause_and_return ;;
  esac
}

# æ£€æŸ¥æƒé™
if [ "$EUID" -eq 0 ]; then
  echo -e "${RED}[-] è¯·ä¸è¦ä»¥rootç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬${RESET}"
  exit 1
fi

# å¯åŠ¨ä¸»èœå•
main_menu
