#!/bin/bash

# ========= Nockchain èŠ‚ç‚¹å¯åŠ¨ä¿®å¤ç‰ˆè„šæœ¬ v1.0 =========
RESET='\033[0m'
BOLD='\033[1m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'

NCK_DIR="$HOME/nockchain"
ENV_FILE="$NCK_DIR/.env"
LOG_FILE="$HOME/nockchain_build.log"
NODE_LOG="$NCK_DIR/logs/nockchain.log"

# ---------- è¾…åŠ©å‡½æ•° ----------
log() { echo -e "${BLUE}[*] $*${RESET}"; }
ok()  { echo -e "${GREEN}[âœ“] $*${RESET}"; }
warn(){ echo -e "${YELLOW}[!] $*${RESET}"; }
err() { echo -e "${RED}[âœ—] $*${RESET}"; }
pause() { echo; read -n1 -r -p "æŒ‰ä»»æ„é”®è¿”å›žèœå•..." _; }

# ---------- å½»åº•æ¸…ç† socket æ–‡ä»¶ ----------
clean_socket_files() {
  log "å½»åº•æ¸…ç† socket æ–‡ä»¶"
  
  # åœæ­¢æ‰€æœ‰ç›¸å…³è¿›ç¨‹
  pkill -f nockchain 2>/dev/null || true
  screen -XS nockchain quit 2>/dev/null || true
  sleep 2
  
  # æ¸…ç† socket ç›®å½•
  if [ -d "$NCK_DIR/.socket" ]; then
    rm -rf "$NCK_DIR/.socket"/*
    ok "æ¸…ç† $NCK_DIR/.socket ç›®å½•"
  fi
  
  # åˆ›å»ºæ–°çš„ socket ç›®å½•
  mkdir -p "$NCK_DIR/.socket"
  chmod 755 "$NCK_DIR/.socket"
  
  # æŸ¥æ‰¾å¹¶åˆ é™¤æ‰€æœ‰ç›¸å…³ socket æ–‡ä»¶
  find "$HOME" -name "*.sock" -delete 2>/dev/null
  find "$HOME" -name "nockchain*.sock" -delete 2>/dev/null
  
  # æ£€æŸ¥ç«¯å£å ç”¨æƒ…å†µ
  if command -v netstat >/dev/null 2>&1; then
    if netstat -tlnp 2>/dev/null | grep -q ":3006 "; then
      warn "ç«¯å£ 3006 è¢«å ç”¨ï¼Œå°è¯•é‡Šæ”¾..."
      pid=$(netstat -tlnp 2>/dev/null | grep ":3006 " | awk '{print $7}' | cut -d'/' -f1 | head -1)
      if [ -n "$pid" ] && [ "$pid" != "-" ]; then
        kill -9 "$pid" 2>/dev/null || true
        ok "å·²é‡Šæ”¾ç«¯å£ 3006"
      fi
    fi
  fi
  
  ok "Socket æ–‡ä»¶æ¸…ç†å®Œæˆ"
}

# ---------- è®¾ç½®æŒ–çŸ¿å…¬é’¥ ----------
set_mining_pubkey() {
  log "è®¾ç½®æŒ–çŸ¿å…¬é’¥"
  
  if [ ! -f "$ENV_FILE" ]; then
    mkdir -p "$NCK_DIR"
    echo "MINING_PUBKEY=" > "$ENV_FILE"
    echo "RUST_LOG=info" >> "$ENV_FILE"
  fi
  
  read -rp "è¾“å…¥ 128 ä½å…¬é’¥: " key
  key=$(echo "$key" | tr -d '[:space:]' | tr A-F a-f)
  
  if [ ${#key} -eq 128 ] && [[ "$key" =~ ^[0-9a-f]+$ ]]; then
    sed -i "/^MINING_PUBKEY=/d" "$ENV_FILE"
    echo "MINING_PUBKEY=$key" >> "$ENV_FILE"
    ok "å…¬é’¥å·²å†™å…¥ .env"
  else
    err "å…¬é’¥æ ¼å¼ä¸æ­£ç¡®"
  fi
  
  pause
}

# ---------- å¯åŠ¨èŠ‚ç‚¹ ----------
start_node() {
  log "å¯åŠ¨ Nockchain èŠ‚ç‚¹"
  
  # åŠ è½½çŽ¯å¢ƒå˜é‡
  source "$ENV_FILE" 2>/dev/null || true
  
  # æ£€æŸ¥å…¬é’¥
  if [ -z "$MINING_PUBKEY" ]; then
    err "æœªè®¾ç½®æŒ–çŸ¿å…¬é’¥ï¼Œè¯·å…ˆè®¾ç½®"
    pause
    return 1
  fi
  
  # å½»åº•æ¸…ç† socket æ–‡ä»¶ï¼ˆå…³é”®ä¿®å¤ï¼‰
  clean_socket_files
  
  # åˆ›å»ºæ—¥å¿—ç›®å½•
  mkdir -p "$NCK_DIR/logs"
  
  # æž„å»ºå¯åŠ¨å‘½ä»¤
  START_CMD="RUST_MIN_STACK=33554432 RUST_LOG=info nockchain \
    --mining-pubkey $MINING_PUBKEY \
    --mine \
    --peer /ip4/95.216.102.60/udp/3006/quic-v1 \
    --peer /ip4/65.109.156.108/udp/3006/quic-v1 \
    --peer /ip4/65.21.67.175/udp/3006/quic-v1 \
    --peer /ip4/65.109.156.172/udp/3006/quic-v1 \
    --peer /ip4/34.174.22.166/udp/3006/quic-v1 \
    --npc-socket $NCK_DIR/.socket/nockchain.sock \
    --bind /ip4/0.0.0.0/udp/3006/quic-v1"
  
  # ä½¿ç”¨ screen å¯åŠ¨
  if command -v screen >/dev/null 2>&1; then
    screen -dmS nockchain bash -c "cd '$NCK_DIR' && $START_CMD 2>&1 | tee $NODE_LOG"
    sleep 3
    if screen -list | grep -qw "nockchain"; then
      ok "èŠ‚ç‚¹å·²å¯åŠ¨ (screen ä¼šè¯)"
    else
      err "èŠ‚ç‚¹å¯åŠ¨å¤±è´¥"
      warn "è¯·æ£€æŸ¥æ—¥å¿—: $NODE_LOG"
    fi
  else
    # åŽå°å¯åŠ¨
    cd "$NCK_DIR"
    nohup bash -c "$START_CMD" > "$NODE_LOG" 2>&1 &
    ok "èŠ‚ç‚¹å·²åŽå°å¯åŠ¨ (PID: $!)"
  fi
  
  pause
}

# ---------- æŸ¥çœ‹æ—¥å¿— ----------
view_logs() {
  if [ -f "$NODE_LOG" ]; then
    tail -n 100 -f "$NODE_LOG"
  else
    err "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨: $NODE_LOG"
  fi
  pause
}

# ---------- å®Œæ•´å®‰è£… ----------
complete_installation() {
  log "å¼€å§‹å®Œæ•´å®‰è£… Nockchain"
  
  # å®‰è£…ç³»ç»Ÿä¾èµ–
  if command -v apt >/dev/null; then
    log "å®‰è£…ç³»ç»Ÿä¾èµ–..."
    sudo apt update -y
    sudo apt install -y build-essential git curl pkg-config libssl-dev clang cmake
  fi
  
  # å®‰è£… Rust
  if ! command -v rustc >/dev/null; then
    log "å®‰è£… Rust..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    source "$HOME/.cargo/env"
  fi
  
  # å…‹éš†é¡¹ç›®
  if [ ! -d "$NCK_DIR" ]; then
    log "å…‹éš† Nockchain é¡¹ç›®..."
    git clone --depth 1 https://github.com/zorp-corp/nockchain "$NCK_DIR"
  else
    log "æ›´æ–° Nockchain é¡¹ç›®..."
    cd "$NCK_DIR"
    git pull
  fi
  
  cd "$NCK_DIR"
  
  # è®¾ç½®çŽ¯å¢ƒå˜é‡
  export RUST_MIN_STACK=33554432
  export CARGO_BUILD_JOBS=1
  export RUSTFLAGS="-C opt-level=1 -C debuginfo=0 -C panic=abort"
  
  # æ¸…ç†æ—§çš„æž„å»ºæ–‡ä»¶
  cargo clean
  
  # ç¼–è¯‘é¡¹ç›®
  log "ç¼–è¯‘ Nockchainï¼ˆè¿™å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼‰..."
  cargo build --release 2>&1 | tee "$BUILD_LOG"
  
  # æ£€æŸ¥ç¼–è¯‘ç»“æžœ
  if [ -f "target/release/nockchain" ]; then
    ok "ç¼–è¯‘æˆåŠŸ"
    
    # åˆ›å»ºå¿…è¦ç›®å½•
    mkdir -p "$NCK_DIR/logs" "$NCK_DIR/.socket"
    chmod 755 "$NCK_DIR/.socket"
    
    # åˆ›å»ºçŽ¯å¢ƒæ–‡ä»¶
    if [ ! -f "$ENV_FILE" ]; then
      cat > "$ENV_FILE" <<EOF
MINING_PUBKEY=
RUST_LOG=info
EOF
    fi
    
    ok "å®‰è£…å®Œæˆ"
  else
    err "ç¼–è¯‘å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—: $BUILD_LOG"
  fi
  
  pause
}

# ---------- ä¸»èœå• ----------
while true; do
  clear
  echo -e "${CYAN}${BOLD}"
  echo "================================================"
  echo "        Nockchain èŠ‚ç‚¹å¯åŠ¨ä¿®å¤ç‰ˆè„šæœ¬ v1.0"
  echo "================================================"
  echo -e "${RESET}"
  echo ""
  echo -e "${GREEN}ðŸ”§ å®‰è£…é€‰é¡¹:${RESET}"
  echo "  1) å®Œæ•´å®‰è£… Nockchain"
  echo ""
  echo -e "${GREEN}ðŸ”‘ èŠ‚ç‚¹ç®¡ç†:${RESET}"
  echo "  2) è®¾ç½®æŒ–çŸ¿å…¬é’¥"
  echo "  3) å¯åŠ¨æŒ–çŸ¿èŠ‚ç‚¹"
  echo "  4) æŸ¥çœ‹èŠ‚ç‚¹æ—¥å¿—"
  echo ""
  echo "  0) é€€å‡ºè„šæœ¬"
  echo ""
  read -rp "è¯·é€‰æ‹©æ“ä½œ (0-4): " choice
  
  case $choice in
    1) complete_installation ;;
    2) set_mining_pubkey ;;
    3) start_node ;;
    4) view_logs ;;
    0) echo -e "${GREEN}æ„Ÿè°¢ä½¿ç”¨ï¼${RESET}"; exit 0 ;;
    *) warn "æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°é€‰æ‹©"; sleep 1 ;;
  esac
done
