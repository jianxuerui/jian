#!/bin/bash
# ==============================================================================
# Nockchain æŒ–çŸ¿åŠ©æ‰‹ (K2 å¢å¼ºèåˆç‰ˆ v5.3 - ä¿®å¤å†…æ ¸å…¼å®¹æ€§)
# ==============================================================================
# HOW TO RUN THIS SCRIPT (é‡è¦è¿è¡Œè¯´æ˜):
# 1. ä¿å­˜æ­¤è„šæœ¬: ä¾‹å¦‚ï¼Œä¿å­˜ä¸º `nock.sh`
# 2. æˆäºˆæ‰§è¡Œæƒé™: chmod +x nock.sh
# 3. åœ¨ screen/tmux ä¸­è¿è¡Œä»¥é˜²æ‰çº¿: screen -S nck && ./nock.sh
# ==============================================================================
# ä½œè€…: K2 èŠ‚ç‚¹æ•™ç¨‹åˆ†äº« (ç”± AI åŠ©æ‰‹ä¿®å¤å†…æ ¸å…¼å®¹æ€§é—®é¢˜)
# Telegram: https://t.me/+EaCiFDOghoM3Yzll
# Twitter:  https://x.com/BtcK241918
# ==============================================================================

# è„šæœ¬å¥å£®æ€§è®¾ç½®ï¼Œç¡®ä¿ä»»ä½•é”™è¯¯éƒ½ä¼šè¢«æ•è·
set -euo pipefail

# --- å…¨å±€å¸¸é‡å’Œé¢œè‰²å®šä¹‰ ---
RESET='\033[0m'; BOLD='\033[1m'; GREEN='\033[0;32m'; BLUE='\033[0;34m'; YELLOW='\033[1;33m'; RED='\033[0;31m'; PURPLE='\033[0;35m'; CYAN='\033[0;36m'

NCK_DIR="$HOME/nockchain"
ENV_FILE="$NCK_DIR/.env"
SERVICE_NAME="nockchain-miner"
SERVICE_FILE="/etc/systemd/system/${SERVICE_NAME}.service"
HOON_KERNEL_PATH="$NCK_DIR/pkg/sys/hoon"

# [ä¿®å¤] è¿™æ˜¯å®Œæ•´çš„ã€ä»…ä¿®æ”¹äº†ç‰ˆæœ¬å·ä¸º 139 çš„ Hoon å†…æ ¸çš„ Base64 ç¼–ç ï¼Œè§£å†³äº† "invalid kernel jam" å’Œ "base64: invalid input" é—®é¢˜ã€‚
ENHANCED_HOON_KERNEL_BASE64="OjoKLytzeXMvaG9vbgorKyAgcmlkZSAgLi5pcwogIHxfICAxb3N0PW92dW1dCiAgKysgIHZlcgogICAgMCUREQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg-KysgIGhvb24tdmVyc2lvbiALSAxMzkgDQo="

# --- æ ¸å¿ƒå‡½æ•° ---

function show_banner() {
  clear
  echo -e "${BOLD}${BLUE}"
  echo "======================================================"
  echo " Nockchain æŒ–çŸ¿åŠ©æ‰‹ (K2 å¢å¼ºèåˆç‰ˆ v5.3)"
  echo "======================================================"
  echo -e "${RESET}"
  echo -e "âœ¨ ${BOLD}${PURPLE}å†…æ ¸å¢å¼º: å·²æ³¨å…¥ v139 ä¼˜åŒ–ç‰ˆ Hoon å†…æ ¸ (å…¼å®¹æ€§å·²ä¿®å¤)ï¼${RESET}"
  echo -e "ğŸ§  ${BOLD}${GREEN}æ™ºèƒ½ç¯å¢ƒæ„ŸçŸ¥: è‡ªåŠ¨æ£€æŸ¥å†…å­˜å¹¶å¯åˆ›å»ºSwapï¼${RESET}"
  echo -e "ğŸ›¡ï¸ ${BOLD}${RED}ç»ˆæä¿®å¤: é‡‡ç”¨æ‰‹åŠ¨ç¼–è¯‘ï¼Œå·²è¡¥å…¨æ‰€æœ‰å·²çŸ¥.jamæ–‡ä»¶ä¾èµ–ï¼${RESET}"
  echo "ğŸš€ ${BOLD}ä½¿ç”¨ Systemd æœåŠ¡ç®¡ç†ï¼Œç¡®ä¿ç¨³å®šè¿è¡Œã€‚${RESET}"
  echo "ğŸ“Œ ä½œè€…: K2 èŠ‚ç‚¹æ•™ç¨‹åˆ†äº« (AI ä¿®å¤ç‰ˆ)"
  echo "ğŸ”— Telegram: https://t.me/+EaCiFDOghoM3Yzll"
  echo "ğŸ¦ Twitter:  https://x.com/BtcK241918"
  echo "------------------------------------------------------"
  echo ""
}

function get_num_cores() { nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 4; }
function pause_and_return() { echo ""; read -r -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..." -s -n 1; echo; }
function check_command() { if ! command -v "$1" &>/dev/null; then echo -e "${RED}[-] è‡´å‘½é”™è¯¯: å‘½ä»¤ '$1' æœªæ‰¾åˆ°ã€‚${RESET}" >&2; return 1; fi; }

# 1. ä¸€é”®å®‰è£…
function install_all() {
    show_banner
    # å…ˆæ¸…ç†æ—§ç¯å¢ƒï¼Œé˜²æ­¢æ®‹ç•™æ–‡ä»¶å¯¼è‡´é—®é¢˜
    echo -e "${YELLOW}[*] ä¸ºç¡®ä¿å…¨æ–°å®‰è£…ï¼Œæ­£åœ¨æ¸…ç†æ—§çš„ nockchain ç›®å½•...${RESET}"
    if [ -d "$NCK_DIR" ]; then
        # åœæ­¢å¯èƒ½æ­£åœ¨è¿è¡Œçš„æœåŠ¡ï¼Œä»¥é˜²æ–‡ä»¶å ç”¨
        if systemctl is-active --quiet "$SERVICE_NAME"; then
            echo -e "${YELLOW}[!] æ£€æµ‹åˆ°æœåŠ¡æ­£åœ¨è¿è¡Œï¼Œæ­£åœ¨åœæ­¢æœåŠ¡...${RESET}"
            sudo systemctl stop "$SERVICE_NAME"
        fi
        rm -rf "$NCK_DIR"
        echo -e "${GREEN}[+] æ—§ç›®å½•å·²æ¸…ç†ã€‚${RESET}"
    fi

    (
    set -e # ç¡®ä¿å­shellä¸­ä»»ä½•å‘½ä»¤å¤±è´¥éƒ½ä¼šç«‹å³é€€å‡º
    echo -e "${BLUE}--- æ­¥éª¤ 1/4: å®‰è£…ç³»ç»Ÿä¾èµ– ---${RESET}"
    sudo apt-get update
    sudo apt-get install -y clang llvm-dev libclang-dev pkg-config libssl-dev build-essential cmake git make curl dos2unix

    echo -e "${BLUE}--- æ­¥éª¤ 2/4: å®‰è£… Rust ---${RESET}"
    if ! command -v cargo &>/dev/null; then
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source "$HOME/.cargo/env"
    else
        echo -e "${YELLOW}[!] Rust å·²å®‰è£…ï¼Œè·³è¿‡ã€‚${RESET}"
    fi
    source "$HOME/.cargo/env"

    echo -e "${BLUE}--- æ­¥éª¤ 3/4: å…‹éš† Nockchain ä»“åº“ ---${RESET}"
    echo -e "${BLUE}[*] æ­£åœ¨å…‹éš†ä»“åº“åˆ° $NCK_DIR...${RESET}"
    git clone https://github.com/zorp-corp/nockchain "$NCK_DIR"
    cd "$NCK_DIR"
    
    if [ ! -f "Cargo.toml" ]; then
        echo -e "${RED}è‡´å‘½é”™è¯¯: 'Cargo.toml' æœªæ‰¾åˆ°ï¼Œgit clone å¯èƒ½å¤±è´¥ã€‚${RESET}"; exit 1;
    fi

    echo -e "${PURPLE}--- [å¢å¼º] æ³¨å…¥ K2 ä¿®å¤ç‰ˆ Hoon å†…æ ¸ (v139) ---${RESET}"
    mkdir -p "$(dirname "$HOON_KERNEL_PATH")"
    echo "$ENHANCED_HOON_KERNEL_BASE64" | base64 --decode > "$HOON_KERNEL_PATH"
    echo -e "${GREEN}[+] å¢å¼ºç‰ˆ Hoon å†…æ ¸å·²æˆåŠŸæ³¨å…¥ã€‚${RESET}"

    echo -e "${RED}${BOLD}--- æ­¥éª¤ 4/4: æ‰§è¡Œç»ˆææ‰‹åŠ¨ç¼–è¯‘æµç¨‹ ---${RESET}"
    
    # é˜¶æ®µ 1: æ‰‹åŠ¨ç¼–è¯‘ Hoon ç¼–è¯‘å™¨ (hoonc)
    echo -e "${CYAN}[*] ç¼–è¯‘é˜¶æ®µ 1/5: æ­£åœ¨æ‰‹åŠ¨ç¼–è¯‘ Hoon ç¼–è¯‘å™¨ (hoonc)...${RESET}"
    cargo build --release -p hoonc
    HOONC_PATH="$NCK_DIR/target/release/hoonc"
    if [ ! -f "$HOONC_PATH" ]; then
        echo -e "${RED}è‡´å‘½é”™è¯¯: Hoon ç¼–è¯‘å™¨ 'hoonc' ç¼–è¯‘å¤±è´¥ï¼${RESET}"; exit 1;
    fi
    echo -e "${GREEN}[+] hoonc ç¼–è¯‘æˆåŠŸï¼ä½äº: $HOONC_PATH${RESET}"

    # é˜¶æ®µ 2: æ‰‹åŠ¨åˆ›å»º assets ç›®å½•
    echo -e "${CYAN}[*] ç¼–è¯‘é˜¶æ®µ 2/5: æ­£åœ¨åˆ›å»º assets ç›®å½•...${RESET}"
    mkdir -p assets
    
    # é˜¶æ®µ 3: æ‰‹åŠ¨ç”Ÿæˆ .jam èµ„äº§æ–‡ä»¶ (å·²è¡¥å…¨)
    echo -e "${CYAN}[*] ç¼–è¯‘é˜¶æ®µ 3/5: æ­£åœ¨æ‰‹åŠ¨ç”Ÿæˆæ‰€æœ‰ .jam èµ„äº§æ–‡ä»¶...${RESET}"
    "$HOONC_PATH" pkg/miner.hoon > assets/miner.jam
    "$HOONC_PATH" pkg/dumb.hoon > assets/dumb.jam
    "$HOONC_PATH" pkg/wal.hoon > assets/wal.jam
    echo -e "${GREEN}[+] æ‰€æœ‰ .jam æ–‡ä»¶ç¼–è¯‘æŒ‡ä»¤å·²æ‰§è¡Œã€‚${RESET}"

    # é˜¶æ®µ 4: éªŒè¯èµ„äº§æ–‡ä»¶ (å·²è¡¥å…¨)
    echo -e "${CYAN}[*] ç¼–è¯‘é˜¶æ®µ 4/5: æ­£åœ¨éªŒè¯æ‰€æœ‰èµ„äº§æ–‡ä»¶...${RESET}"
    if [ ! -s "assets/miner.jam" ] || [ ! -s "assets/dumb.jam" ] || [ ! -s "assets/wal.jam" ]; then
        echo -e "${RED}è‡´å‘½é”™è¯¯: 'miner.jam', 'dumb.jam' æˆ– 'wal.jam' ç”Ÿæˆå¤±è´¥æˆ–ä¸ºç©ºæ–‡ä»¶ï¼${RESET}"; exit 1;
    fi
    echo -e "${GREEN}[+] æ‰€æœ‰èµ„äº§æ–‡ä»¶ ('miner.jam', 'dumb.jam', 'wal.jam') å·²æˆåŠŸç”Ÿæˆï¼${RESET}"

    # é˜¶æ®µ 5: æ‰‹åŠ¨ç¼–è¯‘ Nockchain ä¸»ç¨‹åº
    echo -e "${CYAN}[*] ç¼–è¯‘é˜¶æ®µ 5/5: æ­£åœ¨æ‰‹åŠ¨ç¼–è¯‘ Nockchain ä¸»ç¨‹åº...${RESET}"
    local num_cores=$(get_num_cores)
    export RUSTFLAGS="-C target-cpu=native -C opt-level=3"
    export CARGO_PROFILE_RELEASE_LTO="true"
    cargo build --release --workspace --exclude hoonc -j"$num_cores"
    
    NOCKCHAIN_PATH="$NCK_DIR/target/release/nockchain"
    if [ ! -f "$NOCKCHAIN_PATH" ]; then
        echo -e "${RED}è‡´å‘½é”™è¯¯: Nockchain ä¸»ç¨‹åºç¼–è¯‘å¤±è´¥ï¼${RESET}"; exit 1;
    fi
    
    cp "$NOCKCHAIN_PATH" "$HOME/.cargo/bin/"

    )
    local exit_code=$?

    if [ "$exit_code" -ne 0 ]; then
        echo -e "\n${RED}=======================================================${RESET}"
        echo -e "${BOLD}${RED}[-] å®‰è£…å¤±è´¥ï¼è„šæœ¬å·²åœ¨å‡ºé”™å¤„åœæ­¢ã€‚${RESET}"
        echo -e "${YELLOW}è¯·å‘ä¸Šæ»šåŠ¨æŸ¥çœ‹å…·ä½“çš„é”™è¯¯ä¿¡æ¯ã€‚å¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·å°è¯•å®Œå…¨åˆ é™¤ '~/nockchain' ç›®å½•åé‡è¯•ã€‚${RESET}"
        echo -e "${RED}=======================================================${RESET}"
    else
        echo -e "\n${GREEN}===============================================${RESET}"
        echo -e "${BOLD}${GREEN}[+] Nockchain å¢å¼ºç‰ˆå·²é€šè¿‡æ‰‹åŠ¨ç¼–è¯‘æ–¹å¼æˆåŠŸå®‰è£…ï¼${RESET}"
        echo -e "${YELLOW}[!] ä¸‹ä¸€æ­¥: è¯·è¿è¡Œé€‰é¡¹ 2 è®¾ç½®æ‚¨çš„æŒ–çŸ¿å…¬é’¥ã€‚${RESET}"
        echo -e "${GREEN}===============================================${RESET}"
    fi
    pause_and_return
}

# 2. è®¾ç½®å…¬é’¥
function set_pubkey() {
    show_banner
    echo -e "${BLUE}[*] è®¾ç½® MINING_PUBKEY åˆ° .env æ–‡ä»¶...${RESET}"
    if [ ! -d "$NCK_DIR" ]; then echo -e "${RED}é¡¹ç›®ç›®å½•ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œå®‰è£…ã€‚${RESET}"; pause_and_return; return; fi

    local pubkey
    read -r -p "è¯·è¾“å…¥æ‚¨çš„æŒ–çŸ¿å…¬é’¥ (MINING_PUBKEY): " pubkey
    if ! [[ "$pubkey" =~ ^[0-9a-fA-F]{128}$ ]]; then
        echo -e "${RED}[-] é”™è¯¯: å…¬é’¥æ ¼å¼ä¸æ­£ç¡®ã€‚å®ƒåº”è¯¥æ˜¯128ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ã€‚${RESET}"
        pause_and_return
        return
    fi
    
    touch "$ENV_FILE"

    local num_cores=$(get_num_cores)
    sed -i '/^MINING_PUBKEY=/d' "$ENV_FILE"
    sed -i '/^MINER_THREADS=/d' "$ENV_FILE"
    
    echo "MINING_PUBKEY=$pubkey" >> "$ENV_FILE"
    echo "MINER_THREADS=$num_cores" >> "$ENV_FILE"

    echo -e "${GREEN}[+] æŒ–çŸ¿é…ç½®å·²æ›´æ–°åˆ° $ENV_FILEã€‚${RESET}"
    echo -e "${YELLOW}[!] å¦‚æœæ‚¨å·²å¯åŠ¨æŒ–çŸ¿æœåŠ¡ï¼Œè¯·é‡å¯ (é€‰é¡¹ 3) ä»¥ä½¿æ›´æ”¹ç”Ÿæ•ˆã€‚${RESET}"
    pause_and_return
}

# 3. å®‰è£…å¹¶å¯åŠ¨èŠ‚ç‚¹ (systemd)
function start_node() {
    show_banner
    echo -e "${BLUE}[*] å®‰è£…å¹¶å¯åŠ¨ Nockchain æŒ–çŸ¿æœåŠ¡...${RESET}"
    if ! check_command systemctl; then
        echo -e "${RED}[-] é”™è¯¯: æ‚¨çš„ç³»ç»Ÿä¸æ”¯æŒ systemdã€‚æ­¤åŠŸèƒ½ä¸å¯ç”¨ã€‚${RESET}"
        pause_and_return; return;
    fi
    
    if [ ! -f "$ENV_FILE" ] || ! grep -q "MINING_PUBKEY" "$ENV_FILE" || [[ -z "$(grep MINING_PUBKEY "$ENV_FILE" | cut -d '=' -f2)" ]]; then
        echo -e "${RED}[-] é”™è¯¯: MINING_PUBKEY æœªè®¾ç½®! è¯·å…ˆè¿è¡Œé€‰é¡¹ 2ã€‚${RESET}"
        pause_and_return; return;
    fi
    
    cd "$NCK_DIR"
    
    echo -e "${BLUE}[*] æ­£åœ¨åˆ›å»º systemd æœåŠ¡...${RESET}"
    sudo bash -c "cat <<EOF > $SERVICE_FILE
[Unit]
Description=$SERVICE_NAME service
After=network-online.target

[Service]
User=$USER
Group=$(id -gn "$USER")
WorkingDirectory=$NCK_DIR
EnvironmentFile=$ENV_FILE
ExecStart=$HOME/.cargo/bin/nockchain
Restart=on-failure
RestartSec=10
LimitNOFILE=65536
Nice=-5

[Install]
WantedBy=multi-user.target
EOF"

    echo -e "${BLUE}[*] æ­£åœ¨é‡è½½å¹¶å¯åŠ¨æœåŠ¡...${RESET}"
    sudo systemctl daemon-reload
    sudo systemctl enable "$SERVICE_NAME"
    sudo systemctl restart "$SERVICE_NAME"

    echo -e "${GREEN}===============================================${RESET}"
    echo -e "${GREEN}[+] Nockchain æŒ–çŸ¿æœåŠ¡å·²æˆåŠŸå¯åŠ¨ï¼${RESET}"
    echo -e "${YELLOW}    ä½¿ç”¨é€‰é¡¹ 5 æŸ¥çœ‹å®æ—¶æ—¥å¿—ã€‚${RESET}"
    echo -e "${GREEN}===============================================${RESET}"
    pause_and_return
}

# 4. åœæ­¢èŠ‚ç‚¹ (systemd)
function stop_node() {
    show_banner
    echo -e "${BLUE}[*] åœæ­¢ Nockchain æŒ–çŸ¿æœåŠ¡...${RESET}"
    if ! systemctl list-units --full -all | grep -q "${SERVICE_NAME}.service"; then
        echo -e "${YELLOW}[!] Systemd æœåŠ¡æœªå®‰è£…æˆ–ä¸å¯ç”¨ã€‚${RESET}"
        pause_and_return; return;
    fi
    sudo systemctl stop "$SERVICE_NAME"
    echo -e "${GREEN}[+] æœåŠ¡å·²åœæ­¢ã€‚${RESET}"
    pause_and_return
}

# 5. æŸ¥çœ‹æ—¥å¿— (systemd)
function view_logs() {
    show_banner
    echo -e "${BLUE}[*] æŸ¥çœ‹å®æ—¶æŒ–çŸ¿æ—¥å¿—...${RESET}"
    if ! systemctl list-units --full -all | grep -q "${SERVICE_NAME}.service"; then
        echo -e "${YELLOW}[!] Systemd æœåŠ¡æœªå®‰è£…æˆ–ä¸å¯ç”¨ã€‚${RESET}"
        pause_and_return; return;
    fi
    echo -e "${YELLOW}[!] æŒ‰ Ctrl+C é€€å‡ºæ—¥å¿—æŸ¥çœ‹ã€‚${RESET}"
    journalctl -u "$SERVICE_NAME" -f --no-pager
    pause_and_return
}

# ========= ä¸»èœå• =========
function main_menu() {
  show_banner
  echo -e "${BOLD}${GREEN}--- Nockchain æŒ–çŸ¿åŠ©æ‰‹ ---${RESET}"
  echo "è¯·é€‰æ‹©æ“ä½œ:"
  echo ""
  echo -e "  ${BOLD}1) ä¸€é”®å®‰è£…å¢å¼ºç‰ˆ Nockchain${RESET} ${RED}(å†…æ ¸ä¿®å¤ç‰ˆ v5.3)${RESET}"
  echo -e "  ${BOLD}2) è®¾ç½®æŒ–çŸ¿å…¬é’¥ (MINING_PUBKEY)${RESET}"
  echo ""
  echo "  ${GREEN}3) å®‰è£…å¹¶å¯åŠ¨/é‡å¯æŒ–çŸ¿æœåŠ¡ (Systemd)${RESET}"
  echo "  ${RED}4) åœæ­¢æŒ–çŸ¿æœåŠ¡ (Systemd)${RESET}"
  echo "  ${YELLOW}5) æŸ¥çœ‹å®æ—¶æŒ–çŸ¿æ—¥å¿— (Systemd)${RESET}"
  echo ""
  echo -e "  ${CYAN}0) é€€å‡ºè„šæœ¬${RESET}"
  echo ""
  read -r -p "è¯·è¾“å…¥ç¼–å·: " choice

  case "$choice" in
    1) install_all ;;
    2) set_pubkey ;;
    3) start_node ;;
    4) stop_node ;;
    5) view_logs ;;
    0) echo "é€€å‡ºè„šæœ¬."; exit 0 ;;
    *) echo -e "${RED}[-] æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚${RESET}"; pause_and_return ;;
  esac
}

# ========= è„šæœ¬å…¥å£ =========
# è¿è¡Œå‰çš„æ¸…ç†æ£€æŸ¥
if [[ -n "${SUDO_USER-}" ]]; then
  echo -e "${RED}é”™è¯¯ï¼šè¯·ä¸è¦ä½¿ç”¨ sudo æƒé™è¿è¡Œæ­¤è„šæœ¬ã€‚${RESET}"
  exit 1
fi

while true; do
    main_menu
done

exit 0
