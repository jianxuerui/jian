#!/bin/bash

# ========= Nockchainæ„å»ºå¤±è´¥ä¸“ç”¨ä¿®å¤è„šæœ¬ v8.2 =========
RESET='\033[0m'
BOLD='\033[1m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'

NCK_DIR="$HOME/nockchain"
ENV_FILE="$NCK_DIR/.env"
LOG_FILE="$HOME/nockchain_build.log"

function show_banner() {
  clear
  echo -e "${BOLD}${CYAN}"
  echo "=================================================="
  echo "   Nockchainæ„å»ºå¤±è´¥ä¸“ç”¨ä¿®å¤è„šæœ¬ v8.2"
  echo "=================================================="
  echo -e "${RESET}"
  echo "ğŸ¯ ä¸“é—¨è§£å†³: nockchain-wallet + nockchain æ„å»ºå¤±è´¥"
  echo "ğŸ’¾ å†…å­˜ä¼˜åŒ–: è‡ªåŠ¨å¤„ç†å¤§å†…å­˜éœ€æ±‚é—®é¢˜"
  echo "ğŸ”§ ä¾èµ–ä¿®å¤: Clang/LLVM + å®Œæ•´æ„å»ºå·¥å…·é“¾"
  echo "ğŸ“Š è°ƒè¯•æ¨¡å¼: è¯¦ç»†æ„å»ºæ—¥å¿—å’Œé”™è¯¯åˆ†æ"
  echo "ğŸš€ åˆ†é˜¶æ®µæ„å»º: ç‹¬ç«‹å¤„ç†æ¯ä¸ªç»„ä»¶"
  echo "--------------------------------------------------"
  echo ""
}

# ========= ç³»ç»Ÿèµ„æºæ£€æŸ¥å’Œä¼˜åŒ– =========
function check_and_optimize_system() {
  echo -e "[*] ç³»ç»Ÿèµ„æºæ£€æŸ¥å’Œä¼˜åŒ–..."
  
  # å†…å­˜æ£€æŸ¥
  total_mem_kb=$(grep MemTotal /proc/meminfo | awk '{print $2}')
  total_mem_gb=$((total_mem_kb / 1024 / 1024))
  available_mem_kb=$(grep MemAvailable /proc/meminfo | awk '{print $2}')
  available_mem_gb=$((available_mem_kb / 1024 / 1024))
  
  echo -e "${BLUE}[i] ç³»ç»Ÿå†…å­˜: ${total_mem_gb}GB (å¯ç”¨: ${available_mem_gb}GB)${RESET}"
  
  # æ ¹æ®ç¤¾åŒºåé¦ˆï¼ŒNockchainéœ€è¦å¤§é‡å†…å­˜[2]
  if [ $total_mem_gb -lt 8 ]; then
    echo -e "${RED}[-] è­¦å‘Š: å†…å­˜ä¸è¶³ï¼ŒNockchainéœ€è¦è‡³å°‘8GBå†…å­˜${RESET}"
    echo -e "${YELLOW}[!] ç¤¾åŒºæŠ¥å‘Šæ˜¾ç¤ºå¯èƒ½éœ€è¦16GB+å†…å­˜æ‰èƒ½ç¨³å®šæ„å»º${RESET}"
  fi
  
  # è®¾ç½®å¤§å®¹é‡swapï¼ˆå…³é”®ä¿®å¤ï¼‰
  echo -e "[*] é…ç½®å¤§å®¹é‡swap..."
  current_swap=$(free -g | grep Swap | awk '{print $2}')
  required_swap=$((16 - total_mem_gb))
  
  if [ $required_swap -gt 0 ] && [ $current_swap -lt $required_swap ]; then
    echo -e "${YELLOW}[*] åˆ›å»º${required_swap}GB swapæ–‡ä»¶...${RESET}"
    
    # åˆ›å»ºswapæ–‡ä»¶
    if sudo fallocate -l ${required_swap}G /swapfile-nockchain-large; then
      sudo chmod 600 /swapfile-nockchain-large
      sudo mkswap /swapfile-nockchain-large >/dev/null 2>&1
      sudo swapon /swapfile-nockchain-large >/dev/null 2>&1
      echo -e "${GREEN}[+] ${required_swap}GB Swapå·²é…ç½®${RESET}"
    else
      echo -e "${YELLOW}[!] Swapé…ç½®å¤±è´¥ï¼Œç»§ç»­å°è¯•æ„å»º...${RESET}"
    fi
  fi
  
  # ç³»ç»Ÿä¼˜åŒ–å‚æ•°
  echo -e "[*] ç³»ç»Ÿå‚æ•°ä¼˜åŒ–..."
  sudo sysctl -w vm.overcommit_memory=1 >/dev/null 2>&1 || true
  sudo sysctl -w vm.max_map_count=1048576 >/dev/null 2>&1 || true
  sudo sysctl -w vm.dirty_ratio=5 >/dev/null 2>&1 || true
  sudo sysctl -w vm.dirty_background_ratio=2 >/dev/null 2>&1 || true
  sudo sysctl -w vm.vfs_cache_pressure=50 >/dev/null 2>&1 || true
  
  # é™åˆ¶å¹¶å‘æ„å»ºè¿›ç¨‹
  export CARGO_BUILD_JOBS=1
  export RUSTFLAGS="-C opt-level=1 -C debuginfo=0 -C panic=abort -C codegen-units=1"
  
  echo -e "${GREEN}[+] ç³»ç»Ÿä¼˜åŒ–å®Œæˆ${RESET}"
}

# ========= å®Œæ•´ä¾èµ–å®‰è£…ï¼ˆåŒ…å«Clang/LLVMï¼‰ =========
function install_complete_build_dependencies() {
  echo -e "[*] å®‰è£…å®Œæ•´æ„å»ºä¾èµ–ï¼ˆåŒ…å«Clang/LLVMï¼‰..."
  
  # æ›´æ–°ç³»ç»Ÿ
  sudo apt-get update -y
  
  # æ ¸å¿ƒæ„å»ºå·¥å…·
  echo -e "[*] å®‰è£…æ ¸å¿ƒæ„å»ºå·¥å…·..."
  sudo apt install -y \
    build-essential \
    gcc g++ \
    clang llvm llvm-dev libclang-dev \
    cmake make ninja-build \
    autoconf automake libtool \
    m4 perl bison flex \
    curl git wget \
    pkg-config pkgconf \
    libssl-dev openssl \
    python3 python3-dev python3-pip \
    libffi-dev zlib1g-dev \
    libbz2-dev libreadline-dev \
    libsqlite3-dev libncurses5-dev \
    xz-utils tk-dev libgdbm-dev \
    liblzma-dev uuid-dev \
    screen htop unzip tar gzip \
    jq bc time strace \
    valgrind gdb
  
  # éªŒè¯å…³é”®å·¥å…·ï¼Œç‰¹åˆ«æ˜¯Clang/LLVM[2]
  echo -e "[*] éªŒè¯æ„å»ºå·¥å…·..."
  missing_tools=()
  
  for tool in gcc g++ clang llvm-config cmake make pkg-config; do
    if command -v "$tool" >/dev/null 2>&1; then
      version=$(command -v "$tool" 2>/dev/null && $tool --version 2>/dev/null | head -1 || echo "unknown")
      echo -e "${GREEN}[+] $tool: $version${RESET}"
    else
      echo -e "${RED}[-] $tool: æœªå®‰è£…${RESET}"
      missing_tools+=("$tool")
    fi
  done
  
  if [ ${#missing_tools[@]} -gt 0 ]; then
    echo -e "${RED}[-] ç¼ºå°‘å…³é”®å·¥å…·: ${missing_tools[*]}${RESET}"
    return 1
  fi
  
  # è®¾ç½®ç¯å¢ƒå˜é‡
  export CC=clang
  export CXX=clang++
  export LLVM_CONFIG_PATH=$(which llvm-config)
  
  echo -e "${GREEN}[+] æ„å»ºä¾èµ–å®‰è£…å®Œæˆ${RESET}"
}

# ========= Rustç¯å¢ƒé‡å»º =========
function rebuild_rust_environment() {
  echo -e "[*] é‡å»ºRustç¯å¢ƒ..."
  
  # åœæ­¢æ‰€æœ‰Rustè¿›ç¨‹
  pkill -f cargo 2>/dev/null || true
  pkill -f rustc 2>/dev/null || true
  sleep 5
  
  # å®Œå…¨æ¸…ç†Rustç¯å¢ƒ
  echo -e "[*] æ¸…ç†æ—§Rustç¯å¢ƒ..."
  rm -rf "$HOME/.cargo" "$HOME/.rustup" 2>/dev/null || true
  
  # é‡æ–°å®‰è£…Rust
  echo -e "[*] å®‰è£…Rust stable..."
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable --profile default
  
  # åŠ è½½Rustç¯å¢ƒ
  source "$HOME/.cargo/env"
  export PATH="$HOME/.cargo/bin:$PATH"
  
  # é…ç½®Cargoï¼ˆä¼˜åŒ–å†…å­˜ä½¿ç”¨ï¼‰
  mkdir -p "$HOME/.cargo"
  cat > "$HOME/.cargo/config.toml" << 'EOF'
[build]
jobs = 1

[net]
retry = 20
timeout = 300

[env]
CC = "clang"
CXX = "clang++"

[profile.release]
opt-level = 1
debug = false
debug-assertions = false
overflow-checks = false
lto = false
panic = "abort"
incremental = false
codegen-units = 1

[profile.dev]
opt-level = 1
debug = false
debug-assertions = false
overflow-checks = false
incremental = false
codegen-units = 1
EOF
  
  # éªŒè¯Rustå®‰è£…
  if command -v cargo >/dev/null 2>&1 && command -v rustc >/dev/null 2>&1; then
    echo -e "${GREEN}[+] Rustç¯å¢ƒé‡å»ºæˆåŠŸ${RESET}"
    echo -e "${GREEN}[+] Rust: $(rustc --version)${RESET}"
    echo -e "${GREEN}[+] Cargo: $(cargo --version)${RESET}"
    return 0
  else
    echo -e "${RED}[-] Rustç¯å¢ƒé‡å»ºå¤±è´¥${RESET}"
    return 1
  fi
}

# ========= æ¸…ç†å’Œå‡†å¤‡é¡¹ç›® =========
function prepare_project_clean() {
  echo -e "[*] æ¸…ç†å’Œå‡†å¤‡é¡¹ç›®..."
  
  cd "$HOME" || exit 1
  
  # åœæ­¢ç›¸å…³è¿›ç¨‹
  screen -XS nockchain quit 2>/dev/null || true
  pkill -f nockchain 2>/dev/null || true
  sleep 3
  
  # å®Œå…¨æ¸…ç†
  echo -e "[*] å®Œå…¨æ¸…ç†æ—§é¡¹ç›®..."
  rm -rf nockchain 2>/dev/null || true
  rm -rf ~/.cache/cargo/git/db/*nockchain* 2>/dev/null || true
  rm -rf ~/.nockapp 2>/dev/null || true
  
  # é‡æ–°å…‹éš†
  echo -e "[*] å…‹éš†Nockchainä»“åº“..."
  if git clone --depth 1 https://github.com/zorp-corp/nockchain; then
    echo -e "${GREEN}[+] ä»“åº“å…‹éš†æˆåŠŸ${RESET}"
    cd nockchain || return 1
    
    # åˆ›å»º.envæ–‡ä»¶
    if [ -f ".env_example" ]; then
      cp .env_example .env
    else
      cat > .env << 'EOF'
MINING_PUBKEY=
RUST_LOG=info
EOF
    fi
    
    # åˆ›å»ºç¼ºå¤±çš„èµ„äº§æ–‡ä»¶
    echo -e "[*] åˆ›å»ºç¼ºå¤±çš„èµ„äº§æ–‡ä»¶..."
    mkdir -p assets
    touch assets/wal.jam
    touch assets/dumb.jam  
    touch assets/miner.jam
    echo -e "${GREEN}[+] èµ„äº§æ–‡ä»¶å·²åˆ›å»º${RESET}"
    
    return 0
  else
    echo -e "${RED}[-] ä»“åº“å…‹éš†å¤±è´¥${RESET}"
    return 1
  fi
}

# ========= åˆ†é˜¶æ®µæ„å»ºä¿®å¤ç‰ˆ =========  
function build_components_step_by_step() {
  echo -e "[*] åˆ†é˜¶æ®µæ„å»ºNockchainç»„ä»¶..."
  
  cd "$NCK_DIR" || return 1
  
  # è®¾ç½®ç¯å¢ƒå˜é‡
  source "$HOME/.cargo/env"
  export PATH="$HOME/.cargo/bin:$PATH"
  export CC=clang
  export CXX=clang++
  export CARGO_BUILD_JOBS=1
  export RUSTFLAGS="-C opt-level=1 -C debuginfo=0 -C panic=abort -C codegen-units=1"
  
  # æ¸…ç†æ„å»ºç¼“å­˜
  echo -e "[*] æ¸…ç†æ„å»ºç¼“å­˜..."
  cargo clean >/dev/null 2>&1 || true
  rm -rf target/ 2>/dev/null || true
  
  # æ›´æ–°ä¾èµ–
  echo -e "[*] æ›´æ–°é¡¹ç›®ä¾èµ–..."
  timeout 300 cargo update >>"$LOG_FILE" 2>&1 || true
  
  # æ„å»ºç­–ç•¥ï¼šåˆ†é˜¶æ®µæ„å»ºæ¯ä¸ªç»„ä»¶
  build_success=0
  
  # é˜¶æ®µ1: æ„å»ºhooncï¼ˆå·²æˆåŠŸï¼‰
  echo -e "${GREEN}[+] hooncå·²æ„å»ºæˆåŠŸ${RESET}"
  ((build_success++))
  
  # é˜¶æ®µ2: æ„å»ºnockchain-walletï¼ˆé‡ç‚¹ä¿®å¤ï¼‰
  echo -e "[*] é˜¶æ®µ2: æ„å»ºnockchain-wallet..."
  
  # å°è¯•å¤šç§æ„å»ºæ–¹æ³•
  wallet_built=false
  
  # æ–¹æ³•1: ç›´æ¥åœ¨walletç›®å½•æ„å»º
  if [ -d "crates/nockchain-wallet" ]; then
    echo -e "[*] æ–¹æ³•1: åœ¨walletç›®å½•ç›´æ¥æ„å»º..."
    cd crates/nockchain-wallet
    
    echo "=== æ„å»ºnockchain-wallet (æ–¹æ³•1) ===" >> "$LOG_FILE"
    if timeout 2400 cargo build --release --bin nockchain-wallet >> "$LOG_FILE" 2>&1; then
      if [ -f "target/release/nockchain-wallet" ]; then
        mkdir -p "$HOME/.cargo/bin"
        cp target/release/nockchain-wallet "$HOME/.cargo/bin/"
        echo -e "${GREEN}[+] nockchain-walletæ„å»ºæˆåŠŸ (æ–¹æ³•1)${RESET}"
        wallet_built=true
        ((build_success++))
      fi
    elif timeout 1800 cargo build --bin nockchain-wallet >> "$LOG_FILE" 2>&1; then
      if [ -f "target/debug/nockchain-wallet" ]; then
        mkdir -p "$HOME/.cargo/bin"
        cp target/debug/nockchain-wallet "$HOME/.cargo/bin/"
        echo -e "${GREEN}[+] nockchain-walletæ„å»ºæˆåŠŸ (debug)${RESET}"
        wallet_built=true
        ((build_success++))
      fi
    fi
    cd "$NCK_DIR"
  fi
  
  # æ–¹æ³•2: ä½¿ç”¨å·¥ä½œç©ºé—´æ„å»º
  if [ "$wallet_built" = false ]; then
    echo -e "[*] æ–¹æ³•2: å·¥ä½œç©ºé—´æ„å»º..."
    echo "=== æ„å»ºnockchain-wallet (æ–¹æ³•2) ===" >> "$LOG_FILE"
    
    if timeout 2400 cargo build --release -p nockchain-wallet >> "$LOG_FILE" 2>&1; then
      if [ -f "target/release/nockchain-wallet" ]; then
        mkdir -p "$HOME/.cargo/bin"
        cp target/release/nockchain-wallet "$HOME/.cargo/bin/"
        echo -e "${GREEN}[+] nockchain-walletæ„å»ºæˆåŠŸ (æ–¹æ³•2)${RESET}"
        wallet_built=true
        ((build_success++))
      fi
    elif timeout 1800 cargo build -p nockchain-wallet >> "$LOG_FILE" 2>&1; then
      if [ -f "target/debug/nockchain-wallet" ]; then
        mkdir -p "$HOME/.cargo/bin"
        cp target/debug/nockchain-wallet "$HOME/.cargo/bin/"
        echo -e "${GREEN}[+] nockchain-walletæ„å»ºæˆåŠŸ (debug)${RESET}"
        wallet_built=true
        ((build_success++))
      fi
    fi
  fi
  
  # æ–¹æ³•3: cargo install
  if [ "$wallet_built" = false ]; then
    echo -e "[*] æ–¹æ³•3: cargo install..."
    echo "=== æ„å»ºnockchain-wallet (æ–¹æ³•3) ===" >> "$LOG_FILE"
    
    if timeout 2400 cargo install --force --path crates/nockchain-wallet --bin nockchain-wallet >> "$LOG_FILE" 2>&1; then
      echo -e "${GREEN}[+] nockchain-walletæ„å»ºæˆåŠŸ (æ–¹æ³•3)${RESET}"
      wallet_built=true
      ((build_success++))
    fi
  fi
  
  if [ "$wallet_built" = false ]; then
    echo -e "${RED}[-] nockchain-walletæ„å»ºå¤±è´¥${RESET}"
    echo -e "${YELLOW}[!] æŸ¥çœ‹è¯¦ç»†é”™è¯¯: tail -50 $LOG_FILE${RESET}"
  fi
  
  # é˜¶æ®µ3: æ„å»ºnockchainèŠ‚ç‚¹ï¼ˆé‡ç‚¹ä¿®å¤ï¼‰
  echo -e "[*] é˜¶æ®µ3: æ„å»ºnockchainèŠ‚ç‚¹..."
  
  node_built=false
  
  # æ–¹æ³•1: ç›´æ¥åœ¨nodeç›®å½•æ„å»º
  if [ -d "crates/nockchain" ]; then
    echo -e "[*] æ–¹æ³•1: åœ¨nodeç›®å½•ç›´æ¥æ„å»º..."
    cd crates/nockchain
    
    echo "=== æ„å»ºnockchain (æ–¹æ³•1) ===" >> "$LOG_FILE"
    if timeout 2400 cargo build --release --bin nockchain >> "$LOG_FILE" 2>&1; then
      if [ -f "target/release/nockchain" ]; then
        mkdir -p "$HOME/.cargo/bin"
        cp target/release/nockchain "$HOME/.cargo/bin/"
        echo -e "${GREEN}[+] nockchainæ„å»ºæˆåŠŸ (æ–¹æ³•1)${RESET}"
        node_built=true
        ((build_success++))
      fi
    elif timeout 1800 cargo build --bin nockchain >> "$LOG_FILE" 2>&1; then
      if [ -f "target/debug/nockchain" ]; then
        mkdir -p "$HOME/.cargo/bin"
        cp target/debug/nockchain "$HOME/.cargo/bin/"
        echo -e "${GREEN}[+] nockchainæ„å»ºæˆåŠŸ (debug)${RESET}"
        node_built=true
        ((build_success++))
      fi
    fi
    cd "$NCK_DIR"
  fi
  
  # æ–¹æ³•2: ä½¿ç”¨å·¥ä½œç©ºé—´æ„å»º
  if [ "$node_built" = false ]; then
    echo -e "[*] æ–¹æ³•2: å·¥ä½œç©ºé—´æ„å»º..."
    echo "=== æ„å»ºnockchain (æ–¹æ³•2) ===" >> "$LOG_FILE"
    
    if timeout 2400 cargo build --release -p nockchain >> "$LOG_FILE" 2>&1; then
      if [ -f "target/release/nockchain" ]; then
        mkdir -p "$HOME/.cargo/bin"
        cp target/release/nockchain "$HOME/.cargo/bin/"
        echo -e "${GREEN}[+] nockchainæ„å»ºæˆåŠŸ (æ–¹æ³•2)${RESET}"
        node_built=true
        ((build_success++))
      fi
    elif timeout 1800 cargo build -p nockchain >> "$LOG_FILE" 2>&1; then
      if [ -f "target/debug/nockchain" ]; then
        mkdir -p "$HOME/.cargo/bin"
        cp target/debug/nockchain "$HOME/.cargo/bin/"
        echo -e "${GREEN}[+] nockchainæ„å»ºæˆåŠŸ (debug)${RESET}"
        node_built=true
        ((build_success++))
      fi
    fi
  fi
  
  # æ–¹æ³•3: cargo install
  if [ "$node_built" = false ]; then
    echo -e "[*] æ–¹æ³•3: cargo install..."
    echo "=== æ„å»ºnockchain (æ–¹æ³•3) ===" >> "$LOG_FILE"
    
    if timeout 2400 cargo install --force --path crates/nockchain --bin nockchain >> "$LOG_FILE" 2>&1; then
      echo -e "${GREEN}[+] nockchainæ„å»ºæˆåŠŸ (æ–¹æ³•3)${RESET}"
      node_built=true
      ((build_success++))
    fi
  fi
  
  if [ "$node_built" = false ]; then
    echo -e "${RED}[-] nockchainæ„å»ºå¤±è´¥${RESET}"
    echo -e "${YELLOW}[!] æŸ¥çœ‹è¯¦ç»†é”™è¯¯: tail -50 $LOG_FILE${RESET}"
  fi
  
  # æ„å»ºç»“æœæ€»ç»“
  echo -e "[*] æ„å»ºç»“æœæ€»ç»“..."
  echo -e "${BLUE}[i] æ£€æŸ¥å·²å®‰è£…çš„äºŒè¿›åˆ¶æ–‡ä»¶:${RESET}"
  
  for binary in "hoonc" "nockchain-wallet" "nockchain"; do
    if command -v "$binary" >/dev/null 2>&1; then
      binary_path=$(command -v "$binary")
      binary_size=$(du -h "$binary_path" 2>/dev/null | cut -f1 || echo "unknown")
      echo -e "${GREEN}  âœ“ $binary: $binary_path (å¤§å°: $binary_size)${RESET}"
    else
      echo -e "${RED}  âœ— $binary (æœªæ‰¾åˆ°)${RESET}"
    fi
  done
  
  if [ $build_success -ge 2 ]; then
    echo -e "${GREEN}[+] æ„å»ºæˆåŠŸï¼å‘ç° $build_success ä¸ªå¯æ‰§è¡Œæ–‡ä»¶${RESET}"
    return 0
  else
    echo -e "${YELLOW}[!] éƒ¨åˆ†æ„å»ºå¤±è´¥ï¼ŒæˆåŠŸ $build_success ä¸ªç»„ä»¶${RESET}"
    return 1
  fi
}

# ========= æ„å»ºå¤±è´¥è¯Šæ–­ =========
function diagnose_build_failure() {
  echo -e "[*] æ„å»ºå¤±è´¥è¯Šæ–­..."
  
  echo -e "${BLUE}[i] ç³»ç»Ÿä¿¡æ¯:${RESET}"
  echo -e "  å†…å­˜: $(free -h | grep Mem | awk '{print $3"/"$2}')"
  echo -e "  Swap: $(free -h | grep Swap | awk '{print $3"/"$2}')"
  echo -e "  ç£ç›˜: $(df -h $HOME | tail -1 | awk '{print $3"/"$2" ("$5" used)"}')"
  
  echo -e "${BLUE}[i] æ„å»ºå·¥å…·:${RESET}"
  for tool in gcc g++ clang rustc cargo; do
    if command -v "$tool" >/dev/null 2>&1; then
      echo -e "  âœ“ $tool: $(command -v $tool)"
    else
      echo -e "  âœ— $tool: æœªæ‰¾åˆ°"
    fi
  done
  
  echo -e "${BLUE}[i] æœ€æ–°æ„å»ºé”™è¯¯:${RESET}"
  if [ -f "$LOG_FILE" ]; then
    echo "æŸ¥çœ‹å®Œæ•´æ—¥å¿—: cat $LOG_FILE"
    echo ""
    echo "æœ€æ–°é”™è¯¯:"
    tail -20 "$LOG_FILE" | grep -i "error\|failed\|panic" | tail -5
  fi
  
  echo -e "${YELLOW}[!] æ¨èè§£å†³æ–¹æ¡ˆ:${RESET}"
  echo "1. å¢åŠ ç³»ç»Ÿå†…å­˜åˆ°16GB+"
  echo "2. å¢åŠ swapç©ºé—´åˆ°8GB+"  
  echo "3. æ£€æŸ¥ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³"
  echo "4. é‡æ–°è¿è¡Œè„šæœ¬é€‰æ‹©æ„å»ºä¿®å¤"
}

# ========= é’±åŒ…å’ŒèŠ‚ç‚¹æ“ä½œ =========
function generate_wallet() {
  echo -e "[*] ç”Ÿæˆé’±åŒ…..."
  cd "$NCK_DIR" || return 1
  
  source "$HOME/.cargo/env" 2>/dev/null || true
  export PATH="$HOME/.cargo/bin:$PATH"
  
  wallet_bin=""
  if command -v nockchain-wallet >/dev/null 2>&1; then
    wallet_bin="nockchain-wallet"
  elif [ -f "target/release/nockchain-wallet" ]; then
    wallet_bin="./target/release/nockchain-wallet"
  elif [ -f "target/debug/nockchain-wallet" ]; then
    wallet_bin="./target/debug/nockchain-wallet"
  fi
  
  if [ -z "$wallet_bin" ]; then
    echo -e "${RED}[-] æœªæ‰¾åˆ°nockchain-walletç¨‹åº${RESET}"
    echo -e "${YELLOW}[!] è¯·å…ˆå®Œæˆæ„å»º${RESET}"
    pause_and_return
    return
  fi
  
  echo -e "${GREEN}[+] ä½¿ç”¨é’±åŒ…: $wallet_bin${RESET}"
  
  if ! "$wallet_bin" keygen 2>/dev/null; then
    echo -e "${YELLOW}[!] é’±åŒ…ç”Ÿæˆå¯èƒ½æœ‰é—®é¢˜ï¼Œå°è¯•debugæ¨¡å¼...${RESET}"
    RUST_LOG=debug "$wallet_bin" keygen
  fi
  
  echo -e "${YELLOW}[!] è¯·å¤åˆ¶ä¸Šæ–¹çš„å…¬é’¥${RESET}"
  echo -e "${BLUE}[i] å…¬é’¥æ ¼å¼ï¼š128ä½16è¿›åˆ¶${RESET}"
  pause_and_return
}

function set_pubkey_env() {
  echo -e "[*] è®¾ç½®æŒ–çŸ¿å…¬é’¥..."
  cd "$NCK_DIR" || return 1

  echo -e "${BLUE}[i] å…¬é’¥æ ¼å¼ï¼š128ä½16è¿›åˆ¶å­—ç¬¦ä¸²${RESET}"
  echo ""
  
  while true; do
    read -p "è¯·è¾“å…¥å…¬é’¥: " pubkey
    
    if [ -z "$pubkey" ]; then
      echo -e "${RED}[-] å…¬é’¥ä¸èƒ½ä¸ºç©º${RESET}"
      continue
    fi
    
    pubkey=$(echo "$pubkey" | tr -d ' \n\r\t' | tr '[:upper:]' '[:lower:]')
    
    if [ ${#pubkey} -eq 128 ] && [[ "$pubkey" =~ ^[0-9a-f]{128}$ ]]; then
      sed -i '/^MINING_PUBKEY=/d' "$ENV_FILE" 2>/dev/null || true
      echo "MINING_PUBKEY=$pubkey" >> "$ENV_FILE"
      echo -e "${GREEN}[+] å…¬é’¥å·²å†™å…¥.envæ–‡ä»¶${RESET}"
      break
    else
      echo -e "${YELLOW}[!] å…¬é’¥æ ¼å¼é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥${RESET}"
    fi
  done
  
  pause_and_return
}

function start_node() {
  echo -e "[*] å¯åŠ¨èŠ‚ç‚¹..."
  cd "$NCK_DIR" || return 1
  
  if [ ! -f "$ENV_FILE" ]; then
    echo -e "${RED}[-] .envæ–‡ä»¶ä¸å­˜åœ¨${RESET}"
    pause_and_return
    return
  fi
  
  source "$ENV_FILE"
  if [ -z "$MINING_PUBKEY" ]; then
    echo -e "${RED}[-] æœªè®¾ç½®æŒ–çŸ¿å…¬é’¥${RESET}"
    pause_and_return
    return
  fi

  source "$HOME/.cargo/env" 2>/dev/null || true
  export PATH="$HOME/.cargo/bin:$PATH"

  node_bin=""
  if command -v nockchain >/dev/null 2>&1; then
    node_bin="nockchain"
  elif [ -f "target/release/nockchain" ]; then
    node_bin="./target/release/nockchain"
  elif [ -f "target/debug/nockchain" ]; then
    node_bin="./target/debug/nockchain"
  fi
  
  if [ -z "$node_bin" ]; then
    echo -e "${RED}[-] æœªæ‰¾åˆ°èŠ‚ç‚¹ç¨‹åº${RESET}"
    pause_and_return
    return
  fi

  echo -e "${GREEN}[+] ä½¿ç”¨èŠ‚ç‚¹: $node_bin${RESET}"

  rm -rf ./.data.nockchain .socket/nockchain_npc.sock 2>/dev/null || true
  mkdir -p .socket

  start_cmd="RUST_LOG=info $node_bin --mining-pubkey $MINING_PUBKEY \
--mine \
--peer /ip4/95.216.102.60/udp/3006/quic-v1 \
--peer /ip4/65.109.156.108/udp/3006/quic-v1 \
--peer /ip4/65.21.67.175/udp/3006/quic-v1 \
--peer /ip4/65.109.156.172/udp/3006/quic-v1 \
--peer /ip4/34.174.22.166/udp/3006/quic-v1 \
--npc-socket .socket/nockchain.sock \
--bind /ip4/0.0.0.0/udp/3006/quic-v1"

  if command -v screen >/dev/null 2>&1; then
    if screen -list | grep -qw "nockchain"; then
      screen -S nockchain -X quit >/dev/null 2>&1
      sleep 2
    fi
    
    screen -dmS nockchain bash -c "cd '$NCK_DIR' && $start_cmd"
    sleep 3
    
    if screen -list | grep -qw "nockchain"; then
      echo -e "${GREEN}[+] èŠ‚ç‚¹å·²å¯åŠ¨ (screen: nockchain)${RESET}"
      echo -e "${YELLOW}[!] ä½¿ç”¨ 'screen -r nockchain' æŸ¥çœ‹æ—¥å¿—${RESET}"
    else
      echo -e "${RED}[-] èŠ‚ç‚¹å¯åŠ¨å¤±è´¥${RESET}"
    fi
  else
    nohup bash -c "$start_cmd" > nockchain.log 2>&1 &
    echo -e "${GREEN}[+] èŠ‚ç‚¹å·²åå°å¯åŠ¨${RESET}"
  fi
  
  pause_and_return
}

function check_status() {
  echo -e "[*] æ£€æŸ¥çŠ¶æ€..."
  
  cd "$NCK_DIR" || return 1
  
  # æ£€æŸ¥å…¬é’¥é…ç½®
  if [ -f "$ENV_FILE" ]; then
    source "$ENV_FILE" >/dev/null 2>&1
    if [ -n "$MINING_PUBKEY" ]; then
      echo -e "${GREEN}[+] å…¬é’¥: ${MINING_PUBKEY:0:16}...${MINING_PUBKEY: -16}${RESET}"
    else
      echo -e "${YELLOW}[!] æœªè®¾ç½®å…¬é’¥${RESET}"
    fi
  fi
  
  # æ£€æŸ¥èŠ‚ç‚¹è¿è¡ŒçŠ¶æ€
  if command -v screen >/dev/null 2>&1 && screen -list | grep -qw "nockchain"; then
    echo -e "${GREEN}[+] èŠ‚ç‚¹è¿è¡Œä¸­ (screen)${RESET}"
  elif pgrep -f "nockchain" >/dev/null 2>&1; then
    echo -e "${GREEN}[+] èŠ‚ç‚¹è¿è¡Œä¸­ (è¿›ç¨‹)${RESET}"
  else
    echo -e "${RED}[-] èŠ‚ç‚¹æœªè¿è¡Œ${RESET}"
  fi
  
  # æ˜¾ç¤ºå·²å®‰è£…çš„ç»„ä»¶
  echo -e "${BLUE}[i] å·²å®‰è£…ç»„ä»¶:${RESET}"
  for binary in "hoonc" "nockchain-wallet" "nockchain"; do
    if command -v "$binary" >/dev/null 2>&1; then
      binary_path=$(command -v "$binary")
      binary_size=$(du -h "$binary_path" 2>/dev/null | cut -f1 || echo "unknown")
      echo -e "${GREEN}  âœ“ $binary ($binary_size)${RESET}"
    else
      echo -e "${YELLOW}  âœ— $binary${RESET}"
    fi
  done
  
  # æ˜¾ç¤ºç³»ç»Ÿèµ„æº
  echo -e "${BLUE}[i] ç³»ç»Ÿèµ„æº:${RESET}"
  echo -e "${BLUE}  å†…å­˜ä½¿ç”¨: $(free -h | grep Mem | awk '{print $3"/"$2}')${RESET}"
  echo -e "${BLUE}  Swapä½¿ç”¨: $(free -h | grep Swap | awk '{print $3"/"$2}')${RESET}"
  
  pause_and_return
}

function view_logs() {
  if command -v screen >/dev/null 2>&1 && screen -list | grep -qw "nockchain"; then
    echo -e "${YELLOW}[!] è¿›å…¥æ—¥å¿—æŸ¥çœ‹ (Ctrl+A+D é€€å‡º)...${RESET}"
    screen -r nockchain
  elif [ -f "$NCK_DIR/nockchain.log" ]; then
    echo -e "${YELLOW}[!] æ˜¾ç¤ºæ—¥å¿—:${RESET}"
    tail -f "$NCK_DIR/nockchain.log"
  else
    echo -e "${RED}[-] æ— æ—¥å¿—æ–‡ä»¶${RESET}"
  fi
  pause_and_return
}

function stop_node() {
  echo -e "[*] åœæ­¢èŠ‚ç‚¹..."
  
  if command -v screen >/dev/null 2>&1 && screen -list | grep -qw "nockchain"; then
    screen -S nockchain -X quit >/dev/null 2>&1
  fi
  
  if pgrep -f "nockchain" >/dev/null 2>&1; then
    pkill -f "nockchain" >/dev/null 2>&1
  fi
  
  sleep 2
  echo -e "${GREEN}[+] èŠ‚ç‚¹å·²åœæ­¢${RESET}"
  pause_and_return
}

function pause_and_return() {
  echo ""
  read -n1 -r -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..." key
  main_menu
}

# ========= å®Œæ•´ä¿®å¤å®‰è£…æµç¨‹ =========
function complete_fix_installation() {
  echo -e "[*] å¼€å§‹æ„å»ºå¤±è´¥ä¸“ç”¨ä¿®å¤å®‰è£…..."
  
  # åˆ›å»ºæ—¥å¿—æ–‡ä»¶
  echo "=== Nockchainæ„å»ºå¤±è´¥ä¿®å¤æ—¥å¿— $(date) ===" > "$LOG_FILE"
  
  check_and_optimize_system
  
  if ! install_complete_build_dependencies; then
    echo -e "${RED}[-] ä¾èµ–å®‰è£…å¤±è´¥${RESET}"
    diagnose_build_failure
    pause_and_return
    return
  fi
  
  if ! rebuild_rust_environment; then
    echo -e "${RED}[-] Rustç¯å¢ƒé‡å»ºå¤±è´¥${RESET}"
    diagnose_build_failure
    pause_and_return
    return
  fi
  
  if ! prepare_project_clean; then
    echo -e "${RED}[-] é¡¹ç›®å‡†å¤‡å¤±è´¥${RESET}"
    diagnose_build_failure
    pause_and_return
    return
  fi
  
  if build_components_step_by_step; then
    echo -e "${GREEN}[+] âœ… Nockchainä¿®å¤å®‰è£…æˆåŠŸï¼${RESET}"
    echo -e "${BLUE}[i] å·²ä¿®å¤nockchain-walletå’Œnockchainæ„å»ºå¤±è´¥${RESET}"
    echo -e "${BLUE}[i] ä½¿ç”¨å¤§å†…å­˜ä¼˜åŒ–å’ŒClang/LLVMå·¥å…·é“¾${RESET}"
    echo -e "${BLUE}[i] è¯¦ç»†æ—¥å¿—: $LOG_FILE${RESET}"
  else
    echo -e "${YELLOW}[!] æ„å»ºéƒ¨åˆ†æˆåŠŸ${RESET}"
    echo -e "${BLUE}[i] æŸ¥çœ‹æ„å»ºè¯Šæ–­è·å–æ›´å¤šä¿¡æ¯${RESET}"
    diagnose_build_failure
  fi
  
  pause_and_return
}

function main_menu() {
  show_banner
  echo "è¯·é€‰æ‹©æ“ä½œ:"
  echo "  1) ğŸ”§ ä¿®å¤æ„å»ºå¤±è´¥ (ä¸“ç”¨ç‰ˆ)"
  echo "  2) ğŸ“Š æ„å»ºå¤±è´¥è¯Šæ–­"
  echo "  3) ğŸ”‘ ç”Ÿæˆé’±åŒ…"
  echo "  4) ğŸ“ è®¾ç½®æŒ–çŸ¿å…¬é’¥"
  echo "  5) âš¡ å¯åŠ¨èŠ‚ç‚¹"
  echo "  6) ğŸ“ˆ æŸ¥çœ‹æ—¥å¿—"
  echo "  7) ğŸ” æ£€æŸ¥çŠ¶æ€"
  echo "  8) â¹ï¸  åœæ­¢èŠ‚ç‚¹"
  echo "  0) é€€å‡º"
  echo ""
  echo -e "${CYAN}ğŸ’¡ ä¸“é—¨è§£å†³: nockchain-wallet + nockchain æ„å»ºå¤±è´¥${RESET}"
  echo -e "${CYAN}ğŸ’¡ å†…å­˜ä¼˜åŒ–: è‡ªåŠ¨é…ç½®å¤§å®¹é‡swapå’Œç³»ç»Ÿå‚æ•°${RESET}"
  echo -e "${CYAN}ğŸ’¡ å·¥å…·é“¾: å®Œæ•´Clang/LLVMæ„å»ºç¯å¢ƒ${RESET}"
  echo ""
  read -p "è¯·è¾“å…¥ç¼–å·: " choice

  case "$choice" in
    1) complete_fix_installation ;;
    2) diagnose_build_failure; pause_and_return ;;
    3) generate_wallet ;;
    4) set_pubkey_env ;;
    5) start_node ;;
    6) view_logs ;;
    7) check_status ;;
    8) stop_node ;;
    0) echo "é€€å‡ºè„šæœ¬."; exit 0 ;;
    *) echo -e "${RED}[-] æ— æ•ˆé€‰é¡¹${RESET}"; pause_and_return ;;
  esac
}

# å¯åŠ¨ä¸»èœå•
main_menu
