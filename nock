#!/bin/bash

# ==============================================================================
# Nockchain å®‰è£…ä¸æŒ–çŸ¿åŠ©æ‰‹
# ------------------------------------------------------------------------------
# ä½œè€…: K2 èŠ‚ç‚¹æ•™ç¨‹åˆ†äº«
# Telegram: https://t.me/+EaCiFDOghoM3Yzll
# Twitter:  https://x.com/BtcK241918
# ==============================================================================

# ========= è‰²å½©å®šä¹‰ =========
RESET='\033[0m'
BOLD='\033[1m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'

# ========= é¡¹ç›®è·¯å¾„ =========
NCK_DIR="$HOME/nockchain"
ENV_FILE="$NCK_DIR/.env"

# ========= æ¨ªå¹… =========
function show_banner() {
  clear
  echo -e "${BOLD}${BLUE}"
  echo "==============================================="
  echo "         Nockchain å®‰è£…ä¸æŒ–çŸ¿åŠ©æ‰‹"
  echo "==============================================="
  echo -e "${RESET}"
  echo "ğŸ”§ å¢å¼ºç¼–è¯‘å¹¶è¡Œåº¦ï¼Œé…ç½®æŒ–çŸ¿çº¿ç¨‹æ•°"
  echo "ğŸ“Œ ä½œè€…: K2 èŠ‚ç‚¹æ•™ç¨‹åˆ†äº«"
  echo "ğŸ”— Telegram: https://t.me/+EaCiFDOghoM3Yzll"
  echo "ğŸ¦ Twitter:  https://x.com/BtcK241918"
  echo "-----------------------------------------------"
  echo ""
}

# ========= å¸¸ç”¨å‡½æ•° =========

# æ£€æŸ¥å‘½ä»¤æ˜¯å¦å­˜åœ¨
function check_command() {
    local cmd="$1"
    if ! command -v "$cmd" &>/dev/null; then
        echo -e "${RED}[-] é”™è¯¯: å‘½ä»¤ '$cmd' æœªæ‰¾åˆ°ã€‚è¯·ç¡®ä¿å·²å®‰è£…æˆ–åœ¨ PATH ä¸­ã€‚${RESET}"
        return 1
    fi
    return 0
}

# è·å–CPUæ ¸å¿ƒæ•°ï¼ˆå…¼å®¹ä¸åŒç³»ç»Ÿï¼‰
function get_num_cores() {
    local cores
    if check_command nproc; then
        cores=$(nproc)
    elif check_command sysctl; then # macOS/BSD
        cores=$(sysctl -n hw.ncpu)
    else
        echo -e "${YELLOW}[!] è­¦å‘Š: æ— æ³•è‡ªåŠ¨æ£€æµ‹CPUæ ¸å¿ƒæ•°ï¼Œé»˜è®¤ä¸º 2ã€‚${RESET}"
        cores=2 # é»˜è®¤å€¼
    fi
    echo "$cores"
}

# åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
function cd_nck_dir() {
  if [ -d "$NCK_DIR" ]; then
    cd "$NCK_DIR" || { echo -e "${RED}[-] æ— æ³•è¿›å…¥é¡¹ç›®ç›®å½•: $NCK_DIR${RESET}"; return 1; }
  else
    echo -e "${RED}[-] é¡¹ç›®ç›®å½•ä¸å­˜åœ¨: $NCK_DIR${RESET}"
    return 1
  fi
  return 0
}

# æš‚åœå¹¶è¿”å›ä¸»èœå•
function pause_and_return() {
  echo ""
  # ä½¿ç”¨ `-s` éšè—æŒ‰é”®è¾“å…¥ï¼Œ`-r` é˜²æ­¢åæ–œæ è½¬ä¹‰
  read -r -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..." -s -n 1 # -n 1: åªè¯»å–ä¸€ä¸ªå­—ç¬¦
  echo # æ¢è¡Œï¼Œå› ä¸º -s ä¸ä¼šæ¢è¡Œ
  main_menu
}

# æ£€æŸ¥æœ€ä½ç£ç›˜ç©ºé—´ (ä¾‹å¦‚ï¼Œ5GB)
function check_disk_space() {
    local required_gb=5
    local available_kb

    # å°è¯•ä½¿ç”¨ df -k å¹¶è§£æï¼Œå…¼å®¹æ€§æ›´å¥½
    # awk '{print $4}' è·å–ç¬¬å››åˆ— (Available)
    # tail -n 1 ç¡®ä¿åªå–æœ€åä¸€è¡Œ (é€šå¸¸æ˜¯ç£ç›˜æŒ‚è½½ç‚¹ä¿¡æ¯)
    available_kb=$(df -k "$HOME" 2>/dev/null | awk 'NR==2 {print $4}')

    if [ -z "$available_kb" ]; then
        echo -e "${YELLOW}[!] è­¦å‘Š: æ— æ³•æ£€æŸ¥ç£ç›˜ç©ºé—´ï¼Œè¯·æ‰‹åŠ¨ç¡®è®¤æ‚¨çš„ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³ã€‚${RESET}"
        return 0 # ä¸é˜»æ­¢æ‰§è¡Œ
    fi

    local available_gb=$((available_kb / 1024 / 1024))

    if [ "$available_gb" -lt "$required_gb" ]; then
        echo -e "${RED}[-] é”™è¯¯: ç£ç›˜ç©ºé—´ä¸è¶³! è‡³å°‘éœ€è¦ ${required_gb}GBï¼Œå½“å‰å¯ç”¨ ${available_gb}GBã€‚${RESET}"
        echo -e "${RED}    è¯·æ¸…ç†ç£ç›˜ç©ºé—´åå†è¿è¡Œã€‚${RESET}"
        return 1 # é˜»æ­¢æ‰§è¡Œ
    else
        echo -e "${GREEN}[+] ç£ç›˜ç©ºé—´æ£€æŸ¥é€šè¿‡ï¼Œå¯ç”¨ ${available_gb}GBã€‚${RESET}"
        return 0 # å…è®¸æ‰§è¡Œ
    fi
}

# æŸ¥æ‰¾å¹¶æ‰§è¡Œ Nockchain äºŒè¿›åˆ¶æ–‡ä»¶
# å‚æ•°: binary_name (ä¾‹å¦‚: nockchain-wallet), ...args
function run_nockchain_binary() {
    local binary_name="$1"
    shift # ç§»é™¤ç¬¬ä¸€ä¸ªå‚æ•° (binary_name)
    local args="$@"

    local binary_path=""

    # 1. å°è¯•ä» PATH ä¸­æŸ¥æ‰¾
    if command -v "$binary_name" &>/dev/null; then
        binary_path=$(command -v "$binary_name")
        echo -e "[*] æ­£åœ¨ä½¿ç”¨ PATH ä¸­çš„ '$binary_path'${RESET}"
    # 2. å°è¯•ä» NCK_DIR/target/release ä¸­æŸ¥æ‰¾
    elif [ -x "$NCK_DIR/target/release/$binary_name" ]; then
        binary_path="$NCK_DIR/target/release/$binary_name"
        echo -e "[*] æ­£åœ¨ä½¿ç”¨é¡¹ç›®ç›®å½•ä¸­çš„ '$binary_path'${RESET}"
    else
        echo -e "${RED}[-] é”™è¯¯: æ‰¾ä¸åˆ°å¯æ‰§è¡Œæ–‡ä»¶ '$binary_name'ã€‚è¯·ç¡®ä¿å·²ç¼–è¯‘å¹¶å®‰è£… (è¿è¡Œé€‰é¡¹ 1)ã€‚${RESET}"
        return 1
    fi

    # æ‰§è¡Œå‘½ä»¤
    "$binary_path" $args || {
        echo -e "${RED}[-] å‘½ä»¤ '$binary_name $args' æ‰§è¡Œå¤±è´¥${RESET}"
        return 1
    }
    return 0
}


# ========= é…ç½®å‡½æ•° =========

# ç¡®ä¿ .env æ–‡ä»¶å­˜åœ¨å¹¶åŒ…å«å¿…è¦çš„å˜é‡
function configure_mining_env() {
  echo -e "[*] æ£€æŸ¥å¹¶è®¾ç½® .env æ–‡ä»¶ä¸­çš„æŒ–çŸ¿ç›¸å…³é…ç½®..."
  local env_file="$1"
  local num_cores=$(get_num_cores)

  # å¤åˆ¶ç¤ºä¾‹æ–‡ä»¶å¦‚æœ .env ä¸å­˜åœ¨
  if [ ! -f "$env_file" ]; then
    if [ -f "$NCK_DIR/.env_example" ]; then
      cp -n "$NCK_DIR/.env_example" "$env_file"
      echo -e "${GREEN}[+] å·²ä» .env_example åˆ›å»º $env_file${RESET}"
    else
      echo -e "${RED}[-] é”™è¯¯: æ‰¾ä¸åˆ° .env_example æ–‡ä»¶ï¼Œæ— æ³•åˆ›å»º .env${RESET}"
      return 1
    fi
  fi

  # ç¡®ä¿ MINING_PUBKEY å­˜åœ¨ (ä»…æ£€æŸ¥ï¼Œä¸è‡ªåŠ¨è®¾ç½®ï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨æˆ–é€šè¿‡èœå•è®¾ç½®)
  if ! grep -q '^MINING_PUBKEY=' "$env_file"; then
    echo -e "${YELLOW}[!] æ¸©é¦¨æç¤º: .env æ–‡ä»¶ä¸­ç¼ºå°‘ MINING_PUBKEYï¼Œè¯·è¿è¡Œé€‰é¡¹ 2/3 ç”Ÿæˆ/è®¾ç½®æ‚¨çš„å…¬é’¥!${RESET}"
  fi

  # ç¡®ä¿ MINER_THREADS å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æ·»åŠ ï¼Œé»˜è®¤ä¸ºæ ¸å¿ƒæ•°
  if ! grep -q '^MINER_THREADS=' "$env_file"; then
    echo -e "${YELLOW}[!] .env æ–‡ä»¶ä¸­ç¼ºå°‘ MINER_THREADSï¼Œå°†æ·»åŠ é»˜è®¤å€¼ (CPUæ ¸å¿ƒæ•°: $num_cores)${RESET}"
    # ä½¿ç”¨ sed æ·»åŠ ï¼Œç¡®ä¿ä¸é‡å¤æ·»åŠ 
    if ! grep -q '^# æŒ–çŸ¿çº¿ç¨‹æ•°' "$env_file"; then
        echo "" >> "$env_file" # æ·»åŠ ä¸€ä¸ªç©ºè¡Œç¡®ä¿æ ¼å¼
        echo "# æŒ–çŸ¿çº¿ç¨‹æ•°ï¼Œå»ºè®®è®¾ç½®ä¸ºæ‚¨çš„CPUæ ¸å¿ƒæ•°" >> "$env_file"
    fi
    echo "MINER_THREADS=$num_cores" >> "$env_file"
    echo -e "${GREEN}[+] å·²æ·»åŠ  MINER_THREADS=$num_cores åˆ° $env_file${RESET}"
  else
    local current_threads=$(grep '^MINER_THREADS=' "$env_file" | cut -d'=' -f2)
    echo -e "[*] .env æ–‡ä»¶ä¸­å·²å­˜åœ¨ MINER_THREADS=$current_threads"
  fi

  return 0
}

function set_pubkey_env() {
  echo -e "[*] è®¾ç½® MINING_PUBKEY åˆ° .env..."
  if ! cd_nck_dir; then pause_and_return; return; fi

  read -r -p "è¯·è¾“å…¥å…¬é’¥ (MINING_PUBKEY): " pubkey
  if [ -z "$pubkey" ]; then
    echo -e "${RED}[-] å…¬é’¥ä¸èƒ½ä¸ºç©º${RESET}"
    pause_and_return
    return
  fi

  # ä½¿ç”¨ sed åˆ é™¤æ—§è¡Œå¹¶æ·»åŠ æ–°è¡Œ
  # å…¼å®¹ GNU/BSD sedï¼Œå…ˆå°è¯• GNU è¯­æ³•ï¼Œå¤±è´¥åˆ™å°è¯• BSD è¯­æ³•
  if grep -q '^MINING_PUBKEY=' "$ENV_FILE"; then
    if sed -i "/^MINING_PUBKEY=/c\MINING_PUBKEY=$pubkey" "$ENV_FILE" 2>/dev/null; then
      echo -e "${GREEN}[+] å·²æ›´æ–° MINING_PUBKEY åˆ° $ENV_FILE${RESET}"
    elif sed -i "" "/^MINING_PUBKEY=/c\MINING_PUBKEY=$pubkey" "$ENV_FILE" 2>/dev/null; then
      echo -e "${GREEN}[+] å·²æ›´æ–° MINING_PUBKEY åˆ° $ENV_FILE (ä½¿ç”¨ BSD sed å…¼å®¹æ¨¡å¼)${RESET}"
    else
      echo -e "${RED}[-] è­¦å‘Š: æ— æ³•æ›´æ–° MINING_PUBKEY åˆ° $ENV_FILEï¼Œè¯·æ‰‹åŠ¨ç¼–è¾‘ã€‚${RESET}"
      pause_and_return
      return
    fi
  else
    # å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ·»åŠ 
    echo "" >> "$ENV_FILE" # ç¡®ä¿åœ¨æœ«å°¾æ·»åŠ æ—¶æ ¼å¼æ­£ç¡®
    echo "MINING_PUBKEY=$pubkey" >> "$ENV_FILE"
    echo -e "${GREEN}[+] å·²æ·»åŠ  MINING_PUBKEY=$pubkey åˆ° $ENV_FILE${RESET}"
  fi

  if grep -q "MINING_PUBKEY=$pubkey" "$ENV_FILE"; then
      echo -e "${GREEN}[+] MINING_PUBKEY=$pubkey å·²æˆåŠŸå†™å…¥/æ›´æ–°åˆ° .env${RESET}"
      # é‡æ–° .env ä½¿é…ç½®ç”Ÿæ•ˆ for this script run
      . "$ENV_FILE" # POSIX `.` å‘½ä»¤æ›¿ä»£ `source`
  else
      echo -e "${RED}[-] å†™å…¥ MINING_PUBKEY åˆ° .env å¤±è´¥${RESET}"
  fi

  pause_and_return
}

function set_miner_threads_env() {
  echo -e "[*] è®¾ç½® MINER_THREADS åˆ° .env..."
  if ! cd_nck_dir; then pause_and_return; return; fi

  local max_cores=$(get_num_cores)
  echo "æ‚¨çš„ç³»ç»Ÿæ£€æµ‹åˆ°æœ‰ ${max_cores} ä¸ª CPU æ ¸å¿ƒã€‚"
  read -r -p "è¯·è¾“å…¥æŒ–çŸ¿çº¿ç¨‹æ•° (MINER_THREADSï¼Œå»ºè®®ä¸è¶…è¿‡æ ¸å¿ƒæ•° $max_cores): " threads
  if [ -z "$threads" ]; then
    echo -e "${RED}[-] çº¿ç¨‹æ•°ä¸èƒ½ä¸ºç©º${RESET}"
    pause_and_return
    return
  fi

  # éªŒè¯è¾“å…¥æ˜¯å¦ä¸ºéè´Ÿæ•°å­—
  if ! echo "$threads" | grep -q '^[0-9]\+$'; then # POSIX å…¼å®¹çš„æ•°å­—æ£€æŸ¥
    echo -e "${RED}[-] è¾“å…¥æ— æ•ˆï¼Œè¯·è¾“å…¥ä¸€ä¸ªéè´Ÿæ•°å­—${RESET}"
    pause_and_return
    return
  fi

   # ä½¿ç”¨ sed åˆ é™¤æ—§è¡Œå¹¶æ·»åŠ æ–°è¡Œ
  if grep -q '^MINER_THREADS=' "$ENV_FILE"; then
    if sed -i "/^MINER_THREADS=/c\MINER_THREADS=$threads" "$ENV_FILE" 2>/dev/null; then
      echo -e "${GREEN}[+] å·²æ›´æ–° MINER_THREADS=$threads åˆ° $ENV_FILE${RESET}"
    elif sed -i "" "/^MINER_THREADS=/c\MINER_THREADS=$threads" "$ENV_FILE" 2>/dev/null; then
      echo -e "${GREEN}[+] å·²æ›´æ–° MINER_THREADS=$threads åˆ° $ENV_FILE (ä½¿ç”¨ BSD sed å…¼å®¹æ¨¡å¼)${RESET}"
    else
      echo -e "${RED}[-] è­¦å‘Š: æ— æ³•æ›´æ–° MINER_THREADS åˆ° $ENV_FILEï¼Œè¯·æ‰‹åŠ¨ç¼–è¾‘ã€‚${RESET}"
      pause_and_return
      return
    fi
  else
    # å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ·»åŠ 
     if ! grep -q '^# æŒ–çŸ¿çº¿ç¨‹æ•°' "$ENV_FILE"; then
        echo "" >> "$ENV_FILE" # ç¡®ä¿åœ¨æœ«å°¾æ·»åŠ æ—¶æ ¼å¼æ­£ç¡®
        echo "# æŒ–çŸ¿çº¿ç¨‹æ•°ï¼Œå»ºè®®è®¾ç½®ä¸ºæ‚¨çš„CPUæ ¸å¿ƒæ•°" >> "$ENV_FILE"
    fi
    echo "MINER_THREADS=$threads" >> "$ENV_FILE"
    echo -e "${GREEN}[+] å·²æ·»åŠ  MINER_THREADS=$threads åˆ° $ENV_FILE${RESET}"
  fi

  if grep -q "MINER_THREADS=$threads" "$ENV_FILE"; then
      echo -e "${GREEN}[+] MINER_THREADS=$threads å·²æˆåŠŸå†™å…¥/æ›´æ–°åˆ° .env${RESET}"
      echo -e "${YELLOW}[!] æ³¨æ„: å¯åŠ¨èŠ‚ç‚¹è„šæœ¬ (run_nockchain_miner.sh) éœ€è¦è¯»å–å¹¶ä½¿ç”¨è¿™ä¸ªå˜é‡æ‰èƒ½ç”Ÿæ•ˆã€‚${RESET}"
      # é‡æ–° .env ä½¿é…ç½®ç”Ÿæ•ˆ for this script run
      . "$ENV_FILE" # POSIX `.` å‘½ä»¤æ›¿ä»£ `source`
  else
      echo -e "${RED}[-] å†™å…¥ MINER_THREADS åˆ° .env å¤±è´¥${RESET}"
  fi

  pause_and_return
}

# ========= å®‰è£…æ„å»ºå‡½æ•° =========
function setup_all() {
  show_banner # åœ¨å®‰è£…å‰å†æ¬¡æ˜¾ç¤ºæ¨ªå¹…

  # æ£€æŸ¥ç£ç›˜ç©ºé—´
  echo -e "[*] æ£€æŸ¥ç£ç›˜ç©ºé—´..."
  if ! check_disk_space; then
      pause_and_return
      return
  fi

  echo -e "[*] å®‰è£…ç³»ç»Ÿä¾èµ– (build-essential, cmake, curl, git, make, screen)..."
  # ç¡®ä¿æ‰€æœ‰å…³é”®å‘½ä»¤å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™å°è¯•å®‰è£…
  # æ£€æŸ¥ screen æ˜¯å¦å®‰è£…
  if ! check_command screen; then
      echo -e "${YELLOW}[!] 'screen' å‘½ä»¤æœªæ‰¾åˆ°ï¼Œå°†å°è¯•å®‰è£…ã€‚${RESET}"
  fi

  sudo apt update || { echo -e "${RED}[-] apt update å¤±è´¥${RESET}"; pause_and_return; return; }
  sudo apt install -y clang llvm-dev libclang-dev pkg-config libssl-dev build-essential cmake curl git make screen || { echo -e "${RED}[-] ç³»ç»Ÿä¾èµ–å®‰è£…å¤±è´¥${RESET}"; pause_and_return; return; }
  echo -e "${GREEN}[+] ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ${RESET}"

  echo -e "[*] å®‰è£… Rust..."
  if ! check_command cargo; then
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y || { echo -e "${RED}[-] Rust å®‰è£…å¤±è´¥${RESET}"; pause_and_return; return; }
    # ç«‹å³ä½¿ cargo åœ¨å½“å‰ shell session å¯ç”¨
    export PATH="$HOME/.cargo/bin:$PATH"
    echo -e "${GREEN}[+] Rust å®‰è£…å®Œæˆ${RESET}"
  else
    echo -e "${YELLOW}[!] Rust å·²å®‰è£…ï¼Œè·³è¿‡å®‰è£…æ­¥éª¤${RESET}"
    # ç¡®ä¿å½“å‰ shell session æœ‰ cargoï¼Œå³ä½¿å·²ç»å®‰è£…
    export PATH="$HOME/.cargo/bin:$PATH"
  fi

  # ç¡®ä¿ cargo bin ç›®å½•åœ¨ PATH ä¸­ (æŒä¹…åŒ–)
  # ä½¿ç”¨ $SHELL å˜é‡åˆ¤æ–­ç”¨æˆ·å½“å‰ä½¿ç”¨çš„ shell
  local rc_file=""
  case "$(basename "$SHELL")" in
      "bash") rc_file="$HOME/.bashrc" ;;
      "zsh") rc_file="$HOME/.zshrc" ;;
      *) rc_file="$HOME/.profile" # Fallback for other shells or non-interactive sessions
  esac

  if ! grep -q 'export PATH=.*\$HOME/\.cargo/bin:\$PATH' "$rc_file" 2>/dev/null; then
    echo '# Add Rust cargo bin to PATH' >> "$rc_file"
    echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> "$rc_file"
    echo -e "${GREEN}[+] å·²å°† Cargo æ·»åŠ åˆ° ${rc_file} çš„ PATH (å¯èƒ½éœ€è¦é‡æ–°ç™»å½•æˆ– '. ${rc_file}' ç”Ÿæ•ˆ)${RESET}"
  else
     echo -e "${YELLOW}[!] Cargo å·²åœ¨ ${rc_file} çš„ PATH ä¸­${RESET}"
  fi


  echo -e "[*] è·å–æˆ–æ›´æ–°ä»“åº“..."
  if [ -d "$NCK_DIR" ]; then
    echo -e "[*] é¡¹ç›®ç›®å½•å·²å­˜åœ¨ï¼Œå°è¯•æ‹‰å–æœ€æ–°ä»£ç ..."
    if ! cd_nck_dir; then pause_and_return; return; fi
    git pull || { echo -e "${RED}[-] Git pull å¤±è´¥${RESET}"; pause_and_return; return; }
    echo -e "${GREEN}[+] ä»“åº“å·²æ›´æ–°${RESET}"
  else
    echo -e "[*] å…‹éš†ä»“åº“åˆ° $NCK_DIR..."
    git clone https://github.com/zorp-corp/nockchain "$NCK_DIR" || { echo -e "${RED}[-] Git clone å¤±è´¥${RESET}"; pause_and_return; return; }
    echo -e "${GREEN}[+] ä»“åº“å…‹éš†å®Œæˆ${RESET}"
    if ! cd_nck_dir; then pause_and_return; return; fi
  fi

  # é…ç½® .env æ–‡ä»¶ï¼ŒåŒ…æ‹¬æŒ–çŸ¿çº¿ç¨‹æ•°
  configure_mining_env "$ENV_FILE" || { echo -e "${RED}[-] .env é…ç½®å¤±è´¥${RESET}"; pause_and_return; return; }

  echo -e "[*] æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶..."
  # ç¡®ä¿ make å’Œ cargo å‘½ä»¤å­˜åœ¨
  if check_command make; then make clean || echo -e "${YELLOW}[!] make clean å¯èƒ½å¤±è´¥ï¼Œå¦‚æœé¦–æ¬¡æ„å»ºè¯·å¿½ç•¥æ­¤è­¦å‘Šã€‚${RESET}"; fi
  if check_command cargo; then cargo clean || echo -e "${YELLOW}[!] cargo clean å¯èƒ½å¤±è´¥ï¼Œå¦‚æœé¦–æ¬¡æ„å»ºè¯·å¿½ç•¥æ­¤è­¦å‘Šã€‚${RESET}"; fi
  echo -e "${GREEN}[+] æ¸…ç†å®Œæˆ (æˆ–å·²è·³è¿‡)${RESET}"

  local num_j_cores=$(get_num_cores) # ä½¿ç”¨å…¼å®¹æ€§å‡½æ•°è·å–æ ¸å¿ƒæ•°
  if [ "$num_j_cores" -eq 0 ]; then num_j_cores=1; fi # é¿å… -j 0 å¯¼è‡´çš„é—®é¢˜

  echo -e "[*] å®‰è£… hoonc (ä½¿ç”¨å¤šçº¿ç¨‹ç¼–è¯‘: make -j$num_j_cores)..."
  if ! cd_nck_dir; then pause_and_return; return; fi
  make -j"$num_j_cores" install-hoonc || { echo -e "${RED}[-] install-hoonc å¤±è´¥${RESET}"; echo "è¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯å¹¶å°è¯•æ‰‹åŠ¨è¿è¡Œ 'cd $NCK_DIR && make -j$num_j_cores install-hoonc'"; pause_and_return; return; }
  echo -e "${GREEN}[+] hoonc å®‰è£…å®Œæˆ${RESET}"

  echo -e "[*] ç¼–è¯‘ Nockchain (ä½¿ç”¨å¤šçº¿ç¨‹ç¼–è¯‘: make -j$num_j_cores)..."
  if ! cd_nck_dir; then pause_and_return; return; fi
  make -j"$num_j_cores" build || { echo -e "${RED}[-] build å¤±è´¥${RESET}"; echo "è¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯å¹¶å°è¯•æ‰‹åŠ¨è¿è¡Œ 'cd $NCK_DIR && make -j$num_j_cores build'"; pause_and_return; return; }
  echo -e "${GREEN}[+] Nockchain ç¼–è¯‘å®Œæˆ${RESET}"

  echo -e "[*] å®‰è£…é’±åŒ… (ä½¿ç”¨å¤šçº¿ç¨‹ç¼–è¯‘: make -j$num_j_cores)..."
  if ! cd_nck_dir; then pause_and_return; return; fi
  make -j"$num_j_cores" install-nockchain-wallet || { echo -e "${RED}[-] install-nockchain-wallet å¤±è´¥${RESET}"; echo "è¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯å¹¶å°è¯•æ‰‹åŠ¨è¿è¡Œ 'cd $NCK_DIR && make -j$num_j_cores install-nockchain-wallet'"; pause_and_return; return; }
  echo -e "${GREEN}[+] é’±åŒ…å®‰è£…å®Œæˆ${RESET}"

  echo -e "[*] å®‰è£…èŠ‚ç‚¹ (ä½¿ç”¨å¤šçº¿ç¨‹ç¼–è¯‘: make -j$num_j_cores)..."
  if ! cd_nck_dir; then pause_and_return; return; fi
  make -j"$num_j_cores" install-nockchain || { echo -e "${RED}[-] install-nockchain å¤±è´¥${RESET}"; echo "è¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯å¹¶å°è¯•æ‰‹åŠ¨è¿è¡Œ 'cd $NCK_DIR && make -j$num_j_cores install-nockchain'"; pause_and_return; return; }
  echo -e "${GREEN}[+] èŠ‚ç‚¹ç¨‹åºå®‰è£…å®Œæˆ${RESET}"

  echo -e "${GREEN}===============================================${RESET}"
  echo -e "${GREEN}[+] Nockchain å®‰è£…å’Œæ„å»ºå·²å®Œæˆï¼${RESET}"
  echo -e "${GREEN}===============================================${RESET}"
  echo ""
  echo -e "${YELLOW}[!] ä¸‹ä¸€æ­¥é‡è¦äº‹é¡¹: ${RESET}"
  echo -e "${YELLOW}  1. ç”Ÿæˆæ‚¨çš„é’±åŒ…å¯†é’¥å¯¹ (èœå•é€‰é¡¹ 2)ã€‚${RESET}"
  echo -e "${YELLOW}  2. å°†ç”Ÿæˆçš„å…¬é’¥é…ç½®åˆ° .env æ–‡ä»¶ä¸­ (èœå•é€‰é¡¹ 3)ã€‚${RESET}"
  echo -e "${YELLOW}  3. æ£€æŸ¥ .env ä¸­çš„ MINER_THREADS é…ç½® (èœå•é€‰é¡¹ 8 å¯è®¾ç½®)ã€‚${RESET}"
  echo -e "${YELLOW}  4. å¯åŠ¨èŠ‚ç‚¹è¿›è¡ŒæŒ–çŸ¿ (èœå•é€‰é¡¹ 6)ã€‚${RESET}"
  echo ""

  pause_and_return
}

# ========= é’±åŒ…æ“ä½œå‡½æ•° =========
function generate_wallet() {
  echo -e "[*] ç”Ÿæˆé’±åŒ…å¯†é’¥å¯¹..."
  if ! cd_nck_dir; then pause_and_return; return; fi

  # æ£€æŸ¥ç›®æ ‡ç›®å½•æ˜¯å¦æœ‰å†™å…¥æƒé™
  if [ ! -w "$NCK_DIR" ]; then
      echo -e "${RED}[-] é”™è¯¯: æ— æ³•åœ¨ $NCK_DIR ç›®å½•å†™å…¥æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥æƒé™ã€‚${RESET}"
      pause_and_return
      return
  fi

  echo -e "${YELLOW}[!] ç”Ÿæˆå¯†é’¥å¯¹çš„è¾“å‡ºä¼šåŒ…å«æ‚¨çš„ç§é’¥å’Œå…¬é’¥ï¼Œè¯·åŠ¡å¿…ä¿å­˜å¥½ï¼${RESET}"
  echo -e "${YELLOW}    ç‰¹åˆ«æ˜¯å…¬é’¥ï¼Œç¨åéœ€è¦é…ç½®åˆ° .env æ–‡ä»¶ä¸­ (MINING_PUBKEY)ã€‚${RESET}"
  echo -e "${YELLOW}    ç§é’¥ä¿å­˜åœ¨æ‚¨è¿è¡Œå‘½ä»¤çš„å½“å‰ç›®å½•ä¸‹çš„ wallet.keys æ–‡ä»¶ä¸­ã€‚${RESET}"
  echo "-----------------------------------------------"

  # åœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆ wallet.keys
  run_nockchain_binary "nockchain-wallet" keygen || {
    echo -e "${RED}[-] é’±åŒ…ç”Ÿæˆå¤±è´¥${RESET}"
    pause_and_return
    return
  }

  echo "-----------------------------------------------"
  echo -e "${GREEN}[+] é’±åŒ…å¯†é’¥å¯¹ç”Ÿæˆå®Œæˆ${RESET}"
  echo -e "${YELLOW}[!] å†æ¬¡æé†’ï¼šè¯·è®°å½•æ˜¾ç¤ºçš„å…¬é’¥ï¼Œå¹¶ä½¿ç”¨èœå•é€‰é¡¹ 3 å°†å…¶å†™å…¥ .env æ–‡ä»¶ä¸­çš„ MINING_PUBKEYã€‚${RESET}"
  echo -e "${YELLOW}[!] ç§é’¥å·²ä¿å­˜åˆ° $NCK_DIR/wallet.keys (è¯·å¦¥å–„ä¿ç®¡æ­¤æ–‡ä»¶ï¼)ã€‚${RESET}"

  pause_and_return
}

function export_keys() {
  echo -e "[*] å¯¼å‡ºé’±åŒ…å¯†é’¥åˆ°æ–‡ä»¶..."
  if ! cd_nck_dir; then pause_and_return; return; fi

  echo -e "${YELLOW}[!] å¯†é’¥æ–‡ä»¶åŒ…å«æ‚¨çš„ç§é’¥ï¼Œè¯·å¦¥å–„ä¿ç®¡å¯¼å‡ºæ–‡ä»¶ï¼${RESET}"
  echo -e "${YELLOW}    é»˜è®¤å¯¼å‡ºåˆ° $NCK_DIR/keys.export${RESET}"

  run_nockchain_binary "nockchain-wallet" export-keys || {
    echo -e "${RED}[-] å¯¼å‡ºå¯†é’¥å¤±è´¥${RESET}"
    pause_and_return
    return
  }

  echo -e "${GREEN}[+] å¯†é’¥å·²å¯¼å‡ºåˆ° $NCK_DIR/keys.export${RESET}"
  pause_and_return
}

function import_keys() {
  echo -e "[*] å¯¼å…¥é’±åŒ…å¯†é’¥æ–‡ä»¶..."
  if ! cd_nck_dir; then pause_and_return; return; fi

  read -r -p "[?] è¯·è¾“å…¥è¦å¯¼å…¥çš„å¯†é’¥æ–‡ä»¶è·¯å¾„ (é»˜è®¤: $NCK_DIR/keys.export): " keyfile_input
  keyfile=${keyfile_input:-"$NCK_DIR/keys.export"}

  if [ ! -f "$keyfile" ]; then
    echo -e "${RED}[-] é”™è¯¯: å¯†é’¥æ–‡ä»¶ '$keyfile' ä¸å­˜åœ¨${RESET}"
    pause_and_return
    return
  fi

  echo -e "[*] å°è¯•å¯¼å…¥ '$keyfile'..."
  run_nockchain_binary "nockchain-wallet" import-keys --input "$keyfile" || {
    echo -e "${RED}[-] å¯¼å…¥å¯†é’¥å¤±è´¥${RESET}"
    pause_and_return
    return
  }

  echo -e "${GREEN}[+] å¯†é’¥å·²æˆåŠŸå¯¼å…¥${RESET}"
  pause_and_return
}

# ========= èŠ‚ç‚¹æ“ä½œå‡½æ•° =========
function start_node() {
  echo -e "[*] å¯åŠ¨èŠ‚ç‚¹ (screen åå°ä¼šè¯: nockchain)..."
  if ! cd_nck_dir; then pause_and_return; return; fi

  # æ£€æŸ¥å¯åŠ¨è„šæœ¬æ˜¯å¦å­˜åœ¨å¹¶èµ‹äºˆæ‰§è¡Œæƒé™
  local run_script="./scripts/run_nockchain_miner.sh"
  if [ ! -f "$run_script" ]; then
    echo -e "${RED}[-] é”™è¯¯: æ‰¾ä¸åˆ°å¯åŠ¨è„šæœ¬ $run_script${RESET}"
    echo "è¯·å…ˆè¿è¡Œé€‰é¡¹ 1 å®Œæˆå®‰è£…æ„å»ºã€‚"
    pause_and_return
    return
  fi
  chmod +x "$run_script"

  # æ£€æŸ¥èŠ‚ç‚¹ç¨‹åºæ˜¯å¦å­˜åœ¨ (ä½¿ç”¨ run_nockchain_binary çš„æ£€æŸ¥é€»è¾‘)
  if ! run_nockchain_binary "nockchain" --version &>/dev/null; then # ç®€å•æ£€æŸ¥æ˜¯å¦å­˜åœ¨
      echo -e "${RED}[-] é”™è¯¯: èŠ‚ç‚¹ç¨‹åº 'nockchain' ä¸å­˜åœ¨æˆ–ä¸å¯æ‰§è¡Œã€‚è¯·å…ˆè¿è¡Œé€‰é¡¹ 1 å®Œæˆå®‰è£…æ„å»ºã€‚${RESET}"
      pause_and_return
      return
  fi

  # é‡æ–° .env ç¡®ä¿æœ€æ–°çš„é…ç½®è¢«è¯»å–
  if [ -f "$ENV_FILE" ]; then
      . "$ENV_FILE" # POSIX `.` å‘½ä»¤æ›¿ä»£ `source`
      echo -e "${GREEN}[+] å·²åŠ è½½ .env é…ç½®æ–‡ä»¶${RESET}"
  else
      echo -e "${RED}[-] è­¦å‘Š: .env æ–‡ä»¶ä¸å­˜åœ¨ï¼Œéƒ¨åˆ†é…ç½®å¯èƒ½ç¼ºå¤±ã€‚è¯·å…ˆè¿è¡Œé€‰é¡¹ 1 æˆ–æ‰‹åŠ¨åˆ›å»º .env${RESET}"
      pause_and_return # å¦‚æœ .env éƒ½ä¸å­˜åœ¨ï¼Œå¤§æ¦‚ç‡æ— æ³•å¯åŠ¨
      return
  fi

  # æ£€æŸ¥ MINING_PUBKEY æ˜¯å¦å·²è®¾ç½® (éç©º)
  if [ -z "$MINING_PUBKEY" ]; then
      echo -e "${RED}[-] é”™è¯¯: MINING_PUBKEY æœªåœ¨ .env æ–‡ä»¶ä¸­è®¾ç½®!${RESET}"
      echo "è¯·å…ˆè¿è¡Œèœå•é€‰é¡¹ 2 (ç”Ÿæˆé’±åŒ…) å’Œ 3 (è®¾ç½®å…¬é’¥) å®Œæˆé…ç½®ã€‚"
      pause_and_return
      return
  fi
  echo -e "[*] MINING_PUBKEY å·²é…ç½®: ${GREEN}$MINING_PUBKEY${RESET}"

  # æ£€æŸ¥ MINER_THREADS æ˜¯å¦å·²è®¾ç½® (éç©º)ï¼Œå¹¶æç¤º
  if [ -z "$MINER_THREADS" ]; then
      echo -e "${YELLOW}[!] è­¦å‘Š: MINER_THREADS æœªåœ¨ .env æ–‡ä»¶ä¸­è®¾ç½®ã€‚${RESET}"
      echo "    çŸ¿å·¥å¯èƒ½ä¼šä»¥é»˜è®¤çº¿ç¨‹æ•°è¿è¡Œ (é€šå¸¸ä¸ºå•çº¿ç¨‹)ã€‚å»ºè®®é€šè¿‡é€‰é¡¹ 8 è®¾ç½®ã€‚"
  else
      echo -e "[*] MINER_THREADS å·²é…ç½®: ${GREEN}$MINER_THREADS${RESET}"
  fi

  # æ£€æŸ¥å¹¶å…³é—­æ—§çš„ screen ä¼šè¯
  if screen -list | grep -q "nockchain"; then # ä½¿ç”¨ grep -q æ£€æŸ¥å­˜åœ¨æ€§ï¼Œé¿å…è¾“å‡º
    echo "[*] æ£€æµ‹åˆ°æ—§çš„ 'nockchain' screen ä¼šè¯ï¼Œå°è¯•å…³é—­..."
    screen -S nockchain -X quit || {
      echo -e "${RED}[-] æ— æ³•å…³é—­æ—§çš„ screen ä¼šè¯ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨æ“ä½œ: screen -S nockchain -X quit${RESET}"
    }
    sleep 2 # ç­‰å¾…æ—§ä¼šè¯å®Œå…¨é€€å‡º
    if ! screen -list | grep -q "nockchain"; then
        echo -e "${GREEN}[+] æ—§çš„ screen ä¼šè¯å·²å…³é—­${RESET}"
    else
        echo -e "${YELLOW}[!] è­¦å‘Š: æ—§çš„ screen ä¼šè¯å¯èƒ½æœªèƒ½å®Œå…¨å…³é—­ã€‚è¯·æ‰‹åŠ¨æ£€æŸ¥ã€‚${RESET}"
    fi
  fi

  # å¯åŠ¨æ–°çš„ screen ä¼šè¯å¹¶è¿è¡Œè„šæœ¬
  echo -e "[*] åœ¨ screen ä¼šè¯ 'nockchain' ä¸­å¯åŠ¨æŒ–çŸ¿è„šæœ¬..."
  # æ³¨æ„è¿™é‡Œçš„å‘½ä»¤ï¼šcd åˆ°ç›®å½•ï¼Œç„¶å . .envï¼Œæœ€åæ‰§è¡Œè„šæœ¬ã€‚
  screen -dmS nockchain sh -c "cd '$NCK_DIR' && . '$ENV_FILE' && './scripts/run_nockchain_miner.sh'"

  sleep 3 # ç­‰å¾… screen ä¼šè¯å¯åŠ¨å¹¶æ‰§è¡Œå‘½ä»¤

  if screen -list | grep -q "nockchain"; then
    echo -e "${GREEN}===============================================${RESET}"
    echo -e "${GREEN}[+] èŠ‚ç‚¹å·²æˆåŠŸåœ¨ screen ä¼šè¯ 'nockchain' åå°å¯åŠ¨${RESET}"
    echo -e "${GREEN}===============================================${RESET}"
    echo -e "${YELLOW}[!] ä½¿ç”¨ 'screen -r nockchain' å‘½ä»¤æŸ¥çœ‹æ—¥å¿—ã€‚${RESET}"
    echo -e "${YELLOW}[!] åœ¨ screen ä¼šè¯ä¸­ï¼ŒæŒ‰ Ctrl+A ç„¶åæŒ‰ D é”®å¯ä»¥é€€å‡ºä¼šè¯å¹¶è®©å…¶åœ¨åå°è¿è¡Œã€‚${RESET}"
  else
    echo -e "${RED}===============================================${RESET}"
    echo -e "${RED}[-] èŠ‚ç‚¹å¯åŠ¨å¤±è´¥!${RESET}"
    echo -e "${RED}    è¯·å°è¯•æ‰‹åŠ¨è¿è¡Œ: cd '$NCK_DIR' && . '$ENV_FILE' && './scripts/run_nockchain_miner.sh'${RESET}"
    echo -e "${RED}    æ£€æŸ¥é”™è¯¯è¾“å‡ºã€‚${RESET}"
    echo -e "${RED}===============================================${RESET}"
  fi

  pause_and_return
}

function view_logs() {
  if screen -list | grep -q "nockchain"; then
    echo -e "${YELLOW}[!] è¿æ¥åˆ° screen ä¼šè¯ 'nockchain' æŸ¥çœ‹æ—¥å¿—ã€‚${RESET}"
    echo -e "${YELLOW}[!] åœ¨ screen ä¸­æŒ‰ Ctrl+A ç„¶åæŒ‰ D é”®å¯ä»¥é€€å‡ºä¼šè¯å¹¶è®©å…¶åœ¨åå°è¿è¡Œã€‚${RESET}"
    echo -e "${YELLOW}[!] æŒ‰ Ctrl+C å¯èƒ½ç»ˆæ­¢èŠ‚ç‚¹è¿›ç¨‹ï¼Œè¯·è°¨æ…æ“ä½œã€‚${RESET}"
    echo "-----------------------------------------------"
    screen -r nockchain
  else
    echo -e "${RED}[-] èŠ‚ç‚¹ screen ä¼šè¯ 'nockchain' æœªè¿è¡Œã€‚${RESET}"
    echo "è¯·ä½¿ç”¨èœå•é€‰é¡¹ 6 å¯åŠ¨èŠ‚ç‚¹ã€‚"
  fi
  pause_and_return
}

function stop_node() {
    echo -e "[*] åœæ­¢èŠ‚ç‚¹ screen ä¼šè¯..."
    if screen -list | grep -q "nockchain"; then
        echo "[*] æ£€æµ‹åˆ° 'nockchain' screen ä¼šè¯ï¼Œå°è¯•åœæ­¢..."
        screen -S nockchain -X quit || {
            echo -e "${RED}[-] æ— æ³•åœæ­¢ screen ä¼šè¯ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨æ“ä½œ: screen -S nockchain -X quit${RESET}"
            pause_and_return
            return
        }
        sleep 2 # ç­‰å¾…ä¼šè¯å®Œå…¨é€€å‡º
        if ! screen -list | grep -q "nockchain"; then
             echo -e "${GREEN}[+] èŠ‚ç‚¹ screen ä¼šè¯å·²åœæ­¢${RESET}"
        else
             echo -e "${YELLOW}[!] è­¦å‘Š: èŠ‚ç‚¹ screen ä¼šè¯å¯èƒ½æœªèƒ½å®Œå…¨åœæ­¢ã€‚è¯·æ‰‹åŠ¨æ£€æŸ¥ã€‚${RESET}"
        fi
    else
        echo -e "${YELLOW}[!] èŠ‚ç‚¹ screen ä¼šè¯ 'nockchain' æœªè¿è¡Œï¼Œæ— éœ€åœæ­¢ã€‚${RESET}"
    fi
    pause_and_return
}


# ========= ä¸»èœå• =========
function main_menu() {
  show_banner
  echo "è¯·é€‰æ‹©æ“ä½œ:"
  echo "  ${GREEN}1) ä¸€é”®å®‰è£…ã€æ„å»ºå¹¶åˆå§‹åŒ– .env (æ¨èé¦–æ¬¡è¿è¡Œ)${RESET}"
  echo "  ${BLUE}--- é’±åŒ…æ“ä½œ ---${RESET}"
  echo "  2) ç”Ÿæˆé’±åŒ…å¯†é’¥å¯¹ (æ˜¾ç¤ºå…¬é’¥ï¼Œç§é’¥ä¿å­˜åˆ° wallet.keys)"
  echo "  3) è®¾ç½® MINING_PUBKEY åˆ° .env (æ ¹æ®å…¬é’¥è®¾ç½®æŒ–çŸ¿åœ°å€)"
  echo "  4) å¯¼å‡ºé’±åŒ…å¯†é’¥åˆ°æ–‡ä»¶ (keys.export)"
  echo "  5) å¯¼å…¥é’±åŒ…å¯†é’¥æ–‡ä»¶"
  echo "  ${BLUE}--- èŠ‚ç‚¹æ“ä½œ ---${RESET}"
  echo "  6) å¯åŠ¨èŠ‚ç‚¹ (screen åå°è¿è¡Œ)"
  echo "  7) æŸ¥çœ‹èŠ‚ç‚¹æ—¥å¿— (è¿æ¥åˆ° screen ä¼šè¯)"
  echo "  8) è®¾ç½®æŒ–çŸ¿çº¿ç¨‹æ•° (MINER_THREADS) åˆ° .env"
  echo "  9) åœæ­¢èŠ‚ç‚¹ (screen ä¼šè¯)"
  echo "  ${RED}0) é€€å‡º${RESET}"
  echo ""
  read -r -p "è¯·è¾“å…¥ç¼–å·: " choice

  case "$choice" in
    1) setup_all ;;
    2) generate_wallet ;;
    3) set_pubkey_env ;;
    4) export_keys ;;
    5) import_keys ;;
    6) start_node ;;
    7) view_logs ;;
    8) set_miner_threads_env ;;
    9) stop_node ;;
    0) echo "é€€å‡ºè„šæœ¬."; exit 0 ;;
    *) echo -e "${RED}[-] æ— æ•ˆé€‰é¡¹${RESET}"; pause_and_return ;;
  esac
}

# ========= è„šæœ¬å…¥å£ =========
# ç¡®ä¿åœ¨è„šæœ¬å¼€å§‹æ—¶å°±åŠ è½½ .envï¼Œä»¥ä¾¿åç»­å‡½æ•°å¯ä»¥ä½¿ç”¨å…¶ä¸­çš„å˜é‡ï¼ˆå¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼‰
# æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨ POSIX `.` å‘½ä»¤æ›¿ä»£ `source`
if [ -f "$ENV_FILE" ]; then
    . "$ENV_FILE"
fi

# å¯åŠ¨ä¸»èœå•å¾ªç¯
while true; do
    main_menu
done

exit 0 # æ­£å¸¸é€€å‡º
