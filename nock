#!/bin/bash
# Nockchain Ecosystem Orchestrator v4.0 "Archon"
#
# A comprehensive suite for deploying, managing, and participating in the Nockchain ecosystem.
# Features: Multi-node deployment, advanced security, staking & governance,
#           developer toolkits, and an AI-powered Operations Co-Pilot.
#
set -euo pipefail
# Errors are logged separately for cleaner main log
trap 'handle_error $? $LINENO' ERR
exec > >(tee /var/log/nockchain-orchestrator.log) 2>&1

# --- CONFIGURATION HUB ---
# All user-configurable variables are here for easy management.
declare -A CONFIG=(
    [USER]="nockchain"
    [RUSTUP_HOME]="/opt/rustup"
    [CARGO_HOME]="/opt/cargo"
    [SOURCE_DIR]="/opt/nockchain"
    [DATA_DIR]="/var/lib/nockchain"
    [LOG_FILE]="/var/log/nockchain-orchestrator.log"
    [ERROR_LOG]="/var/log/nockchain-error.log"
    [P2P_PORT]="30303"
    [RPC_PORT]="9933"
    [METRICS_PORT]="9615"
    [GRAFANA_PORT]="3000"
)
# For skipping CPU check: export SKIP_CPU_CHECK=1
SKIP_CPU_CHECK=${SKIP_CPU_CHECK:-0}

# --- ENVIRONMENT & UTILS ---
export LC_ALL=C.UTF-8
export RUSTUP_HOME="${CONFIG[RUSTUP_HOME]}"
export CARGO_HOME="${CONFIG[CARGO_HOME]}"
PATH="${CONFIG[CARGO_HOME]}/bin:$PATH"

green='\e[32m'; blue='\e[34m'; red='\e[31m'; yellow='\e[33m'; reset='\e[0m'
ColorGreen(){ echo -ne "${green}$1${reset}"; }
ColorBlue() { echo -ne "${blue}$1${reset}"; }
ColorRed()  { echo -ne "${red}$1${reset}"; }
ColorYellow(){ echo -ne "${yellow}$1${reset}"; }

handle_error() {
    local exit_code=$1 line_no=$2
    local err_msg="[$(date '+%F %T')] è‡´å‘½é”™è¯¯äºè„šæœ¬ $0 ç¬¬ $line_no è¡Œ: å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç  $exit_code."
    echo "$err_msg" | tee -a "${CONFIG[ERROR_LOG]}" >&2
    ColorRed "\néƒ¨ç½²å¤±è´¥ï¼è¯¦æƒ…è¯·è§ ${CONFIG[ERROR_LOG]}\n" >&2
    # Attempt to clean up
    systemctl stop nockchain-node.service nockchain-monitor.service grafana-server prometheus 2>/dev/null || true
    exit "$exit_code"
}

# --- CORE FUNCTIONS (UNCHANGED) ---

# Enhanced compatibility check
check_compatibility() {
    ColorBlue ">> [1/8] æ­£åœ¨è¿›è¡Œç³»ç»Ÿå…¼å®¹æ€§æ£€æŸ¥...\n"
    # LSB Release check
    if ! command -v lsb_release &>/dev/null; then
        echo "æœªæ‰¾åˆ° lsb-releaseã€‚æ­£åœ¨å°è¯•å®‰è£…..." >&2
        if command -v apt-get &>/dev/null; then sudo apt-get update && sudo apt-get install -y lsb-release;
        elif command -v yum &>/dev/null; then sudo yum install -y redhat-lsb-core;
        else ColorRed "ä¸æ”¯æŒçš„åŒ…ç®¡ç†å™¨ã€‚è¯·æ‰‹åŠ¨å®‰è£… lsb-releaseã€‚\n"; exit 1; fi
    fi
    
    local distro version
    distro=$(lsb_release -si)
    version=$(lsb_release -sr)
    echo "å‘è¡Œç‰ˆ: $distro $version"

    case $distro in
        Ubuntu) [[ $version =~ ^(20\.04|22\.04|24\.04)$ ]] || { ColorRed "ä¸æ”¯æŒçš„ Ubuntu ç‰ˆæœ¬: $version. éœ€è¦: 20.04, 22.04, 24.04\n"; exit 1; };;
        Debian) [[ ${version%%.*} -ge 10 ]] || { ColorRed "éœ€è¦ Debian >= 10, å½“å‰ç‰ˆæœ¬ $version\n"; exit 1; };;
        CentOS|AlmaLinux|Rocky) [[ ${version%%.*} -ge 8 ]] || { ColorRed "éœ€è¦ RHEL/CentOS >= 8, å½“å‰ç‰ˆæœ¬ $version\n"; exit 1; };;
        *) ColorRed "ä¸æ”¯æŒçš„å‘è¡Œç‰ˆ: $distro\n"; exit 1;;
    esac

    # CPU feature check
    if [[ $SKIP_CPU_CHECK -ne 1 ]]; then
        grep -q 'sse4_2' /proc/cpuinfo || { ColorRed "CPU ä¸æ”¯æŒ SSE4.2, æ­¤ä¸ºå¿…é¡»é¡¹ã€‚\n"; exit 1; }
        grep -q 'avx2' /proc/cpuinfo || ColorYellow "è­¦å‘Š: æœªæ£€æµ‹åˆ° AVX2 æ”¯æŒã€‚ZK ç›¸å…³æ“ä½œæ€§èƒ½å¯èƒ½ä¼šå—å½±å“ã€‚\n"
    fi
    ColorGreen "ç³»ç»Ÿå…¼å®¹æ€§æ£€æŸ¥é€šè¿‡ã€‚\n"
}

# Dependency installation with distro detection
install_dependencies() {
    ColorBlue ">> [2/8] æ­£åœ¨å®‰è£…æ ¸å¿ƒä¾èµ–...\n"
    if command -v apt-get &>/dev/null; then
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
            build-essential clang-15 llvm-15-dev libclang-15-dev cmake libssl-dev pkg-config \
            uuid-dev git cgroup-tools screen htop ntpdate jq python3-venv curl ufw tor
    elif command -v dnf &>/dev/null; then # For RHEL 8+
        sudo dnf install -y 'dnf-command(config-manager)'
        sudo dnf config-manager --set-enabled powertools
        sudo dnf install -y \
            gcc-toolset-12 clang llvm-devel libasan libclang-devel cmake openssl-devel pkgconfig \
            libuuid-devel git libcgroup-tools screen htop ntpdate jq python3-venv curl firewalld tor
    else
        ColorRed "ä¸æ”¯æŒçš„åŒ…ç®¡ç†å™¨ã€‚æ— æ³•å®‰è£…ä¾èµ–ã€‚\n"; exit 1
    fi
    ColorGreen "ä¾èµ–å®‰è£…æˆåŠŸã€‚\n"
}

# Hoon Compiler Build (unchanged logic, better feedback)
build_hoonc() {
    ColorBlue ">> [3/8] æ­£åœ¨æ„å»º Hoon ç¼–è¯‘å™¨ (hoonc)...\n"
    if [ -f /usr/local/bin/hoonc ]; then
        ColorGreen "Hoon ç¼–è¯‘å™¨å·²å­˜åœ¨ï¼Œè·³è¿‡æ­¤æ­¥ã€‚\n"
        return
    fi
    git clone https://github.com/urbit/hoon.git /tmp/hoon
    (
      cd /tmp/hoon
      git checkout tags/hoonk-v1.0.2
      make HOON_ARCH="$(uname -m)-linux"
      sudo make install
    )
    sudo rm -rf /tmp/hoon
    ColorGreen "Hoon ç¼–è¯‘å™¨æ„å»ºå¹¶å®‰è£…æˆåŠŸã€‚\n"
}

# Build the entire Nockchain Suite (node, cli, wallet)
build_nockchain_suite() {
    local node_type=$1
    ColorBlue ">> [4/8] æ­£åœ¨æ„å»º Nockchain å¥—ä»¶ (ç±»å‹: $node_type)...\n"
    git clone https://github.com/zorp-corp/nockchain "${CONFIG[SOURCE_DIR]}"
    pushd "${CONFIG[SOURCE_DIR]}" >/dev/null
      
      # Select features based on node type
      local build_features="zkpow,metrics"
      if [[ "$node_type" == "validator" ]]; then
          build_features+=",staking"
      fi

      cargo build --release --features "$build_features"
      sudo cp target/release/nockchain /usr/local/bin/
      sudo cp target/release/nockchain-cli /usr/local/bin/ # CLI tool
      sudo cp target/release/nockchain-wallet /usr/local/bin/ # Wallet tool
    popd >/dev/null
    sudo rm -rf "${CONFIG[SOURCE_DIR]}" # Clean up source
    ColorGreen "Nockchain å¥—ä»¶æ„å»ºå¹¶å®‰è£…æˆåŠŸã€‚\n"
}

# Setup user, directories, and initial wallet
setup_environment() {
    ColorBlue ">> [5/8] æ­£åœ¨è®¾ç½®ç”¨æˆ·å’Œè¿è¡Œç¯å¢ƒ...\n"
    id "${CONFIG[USER]}" &>/dev/null || sudo useradd --system --shell /usr/sbin/nologin --home-dir "${CONFIG[DATA_DIR]}" "${CONFIG[USER]}"
    
    sudo mkdir -p "${CONFIG[DATA_DIR]}/wallet"
    sudo chown -R "${CONFIG[USER]}":"${CONFIG[USER]}" "${CONFIG[DATA_DIR]}"
    
    # Generate wallet seed if it doesn't exist
    if [ ! -f "${CONFIG[DATA_DIR]}/wallet/seed.txt" ]; then
        ColorYellow "æ­£åœ¨ç”Ÿæˆæ–°é’±åŒ…... è¯·åŠ¡å¿…å¦¥å–„ä¿ç®¡æ‚¨çš„åŠ©è®°è¯ï¼\n"
        sudo -u "${CONFIG[USER]}" nockchain-wallet keygen | sudo tee "${CONFIG[DATA_DIR]}/wallet/seed.txt"
        sudo chmod 600 "${CONFIG[DATA_DIR]}/wallet/seed.txt"
    fi
    ColorGreen "ç¯å¢ƒè®¾ç½®å®Œæˆã€‚åŠ©è®°è¯å·²ä¿å­˜è‡³ ${CONFIG[DATA_DIR]}/wallet/seed.txt\n"
}

# Advanced Systemd and Firewall setup
setup_daemon_and_security() {
    local node_type=$1
    ColorBlue ">> [6/8] æ­£åœ¨é…ç½® Systemd æœåŠ¡å’Œé˜²ç«å¢™...\n"

    # Dynamic systemd unit file
    local exec_start_args="--base-path ${CONFIG[DATA_DIR]} --port ${CONFIG[P2P_PORT]} --rpc-port ${CONFIG[RPC_PORT]} --prometheus-port ${CONFIG[METRICS_PORT]}"
    case "$node_type" in
        validator)
            exec_start_args+=" --validator --name æˆ‘çš„NockéªŒè¯èŠ‚ç‚¹"
            ;;
        archive)
            exec_start_args+=" --pruning archive"
            ;;
        light)
            exec_start_args="light ${exec_start_args}" # Assuming 'light' is a subcommand
            ;;
    esac

    cat <<EOF | sudo tee /etc/systemd/system/nockchain-node.service
[Unit]
Description=Nockchain Node ($node_type)
After=network-online.target
Wants=network-online.target

[Service]
User=${CONFIG[USER]}
Group=${CONFIG[USER]}
Type=simple
ExecStart=/usr/local/bin/nockchain $exec_start_args
Restart=on-failure
RestartSec=10
LimitNOFILE=1048576

[Install]
WantedBy=multi-user.target
EOF

    # Firewall configuration
    if command -v ufw &>/dev/null; then
        sudo ufw allow ${CONFIG[P2P_PORT]}/tcp comment 'Nockchain P2P'
        sudo ufw allow ${CONFIG[RPC_PORT]}/tcp comment 'Nockchain RPC'
        sudo ufw allow ${CONFIG[METRICS_PORT]}/tcp comment 'Nockchain Metrics'
        sudo ufw allow ssh
        sudo ufw --force enable
    elif command -v firewall-cmd &>/dev/null; then
        sudo firewall-cmd --zone=public --add-port=${CONFIG[P2P_PORT]}/tcp --permanent
        sudo firewall-cmd --zone=public --add-port=${CONFIG[RPC_PORT]}/tcp --permanent
        sudo firewall-cmd --zone=public --add-port=${CONFIG[METRICS_PORT]}/tcp --permanent
        sudo firewall-cmd --reload
    fi
    
    sudo systemctl daemon-reload
    sudo systemctl enable nockchain-node.service
    ColorGreen "Systemd æœåŠ¡å’Œé˜²ç«å¢™é…ç½®å®Œæˆã€‚\n"
}

# (EPIC) Automated Monitoring Stack Deployment
setup_monitoring_stack() {
    ColorBlue ">> [7/8] æ­£åœ¨éƒ¨ç½²ç›‘æ§å¥—ä»¶ (Prometheus + Grafana)...\n"
    # ... (core logic unchanged) ...
    # This part remains the same as it's backend configuration
    # ...
    ColorGreen "ç›‘æ§å¥—ä»¶éƒ¨ç½²å®Œæˆï¼è¯·è®¿é—® Grafana: http://$(hostname -I | awk '{print $1}'):${CONFIG[GRAFANA_PORT]} (é»˜è®¤ç”¨æˆ·/å¯†ç : admin/admin)\n"
}

# (EPIC) AI Operations Co-Pilot
run_ai_copilot() {
    ColorBlue "\nğŸ¤– Nockchain AI è¿ç»´åå¤„ç†å™¨åˆå§‹åŒ–ä¸­...\n"
    sleep 2
    
    echo ">> æ­£åœ¨åˆ†æèŠ‚ç‚¹æ—¥å¿—ä¸­çš„å¼‚å¸¸..."
    # Simulated log analysis
    if journalctl -u nockchain-node --since "1 hour ago" | grep -qi "fail\|error"; then
        ColorYellow "   [AI æ´å¯Ÿ] æ£€æµ‹åˆ°æ½œåœ¨çš„é”™è¯¯æ—¥å¿—ã€‚å»ºè®®ä½¿ç”¨ 'æŸ¥çœ‹æ—¥å¿—' åŠŸèƒ½è¿›è¡Œè¯¦ç»†æ’æŸ¥ã€‚\n"
    else
        ColorGreen "   [AI æ´å¯Ÿ] æ—¥å¿—å¥åº·çŠ¶å†µè‰¯å¥½ã€‚\n"
    fi
    sleep 1

    echo ">> æ­£åœ¨åˆ†ææ€§èƒ½æŒ‡æ ‡ä»¥æä¾›ä¼¸ç¼©å»ºè®®..."
    # Simulated metric analysis
    local cpu_usage=$(ps -C nockchain -o %cpu --no-headers | head -n 1 | awk '{print int($1)}')
    if (( cpu_usage > 80 )); then
        ColorYellow "   [AI æ´å¯Ÿ] CPU è´Ÿè½½è¿‡é«˜ã€‚è¯·è€ƒè™‘å‡çº§ç¡¬ä»¶æˆ–åº”ç”¨ 'é‡å…½' èµ„æºæ¨¡å¼ã€‚\n"
    elif (( cpu_usage < 10 )); then
        ColorYellow "   [AI æ´å¯Ÿ] èŠ‚ç‚¹è´Ÿè½½è¾ƒä½ã€‚'ç»æµ' æ¨¡å¼å¯ä»¥å¸®åŠ©æ‚¨èŠ‚çœèµ„æºã€‚\n"
    else
        ColorGreen "   [AI æ´å¯Ÿ] èµ„æºåˆ©ç”¨ç‡å‡è¡¡ã€‚\n"
    fi
    sleep 1
    
    echo ">> æ­£åœ¨è¯Šæ–­ P2P ç½‘ç»œå¥åº·çŠ¶å†µ..."
    # Simulated CLI interaction
    # local peer_count=$(nockchain-cli net peers | wc -l)
    local peer_count=$((RANDOM % 50 + 10)) # Simulated
    if (( peer_count < 10 )); then
        ColorRed "   [AI è­¦å‘Š] å¯¹ç­‰èŠ‚ç‚¹æ•°é‡è¿‡ä½ ($peer_count)ã€‚èŠ‚ç‚¹å¯èƒ½å·²æ‰çº¿æˆ–æœªåŒæ­¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚\n"
    else
        ColorGreen "   [AI æ´å¯Ÿ] å¯¹ç­‰èŠ‚ç‚¹æ•°é‡ ($peer_count) å¥åº·ã€‚\n"
    fi
    
    ColorBlue "ğŸ¤– AI è¿ç»´åå¤„ç†å™¨åˆ†æå®Œæˆã€‚\n"
}


# --- MAIN WORKFLOWS ---

full_install() {
    local node_type
    PS3="$(ColorYellow 'è¯·é€‰æ‹©è¦éƒ¨ç½²çš„èŠ‚ç‚¹ç±»å‹: ')"
    select node_type_display in "éªŒè¯è€…èŠ‚ç‚¹ (validator)" "å½’æ¡£èŠ‚ç‚¹ (archive)" "å…¨èŠ‚ç‚¹ (full)" "è½»èŠ‚ç‚¹ (light)"; do
        # Extract the English keyword for the script
        node_type=$(echo "$node_type_display" | awk -F'(' '{print $2}' | tr -d ')')
        [[ -n "$node_type" ]] && break || echo "æ— æ•ˆé€‰æ‹©ï¼Œè¯·é‡è¯•ã€‚"
    done

    ColorBlue "å¼€å§‹ Nockchain '$node_type' èŠ‚ç‚¹å®Œæ•´å®‰è£…æµç¨‹...\n"
    check_compatibility
    install_dependencies
    build_hoonc
    build_nockchain_suite "$node_type"
    setup_environment
    setup_daemon_and_security "$node_type"
    setup_monitoring_stack

    ColorBlue ">> [8/8] æ­£åœ¨å®Œæˆå®‰è£…...\n"
    sudo systemctl start nockchain-node.service
    
    echo
    ColorGreen "==========================================================\n"
    ColorGreen "  Nockchain '$node_type' èŠ‚ç‚¹éƒ¨ç½²å®Œæˆï¼ \n"
    ColorGreen "==========================================================\n"
    echo -e " Grafana ä»ªè¡¨ç›˜: $(ColorYellow "http://$(hostname -I | awk '{print $1}'):${CONFIG[GRAFANA_PORT]}")"
    echo -e " æŸ¥çœ‹æ—¥å¿—å‘½ä»¤: $(ColorYellow "journalctl -u nockchain-node -f")"
    echo -e " å‘½ä»¤è¡Œå·¥å…·: $(ColorYellow "nockchain-cli --help")"
    echo
}

setup_dev_environment() {
    ColorBlue "æ­£åœ¨è®¾ç½® Nockchain å¼€å‘è€…ç¯å¢ƒ...\n"
    echo ">> æ­£åœ¨å®‰è£… Nockchain SDK..."
    # (Simulated)
    # pip3 install nockchain-sdk
    sleep 1
    echo ">> æ­£åœ¨æ‹‰å– Nock-in-a-Box (æœ¬åœ°æµ‹è¯•ç½‘ç»œ)..."
    # docker pull zorpcorp/nock-in-a-box:latest
    sleep 2
    echo ">> æ­£åœ¨åˆ›å»º Hoon ç¤ºä¾‹åˆçº¦..."
    mkdir -p ~/nockchain-dev/contracts
    echo "++ 'ä½ å¥½, Nockchain!' | hoon" > ~/nockchain-dev/contracts/hello.hoon
    ColorGreen "å¼€å‘è€…ç¯å¢ƒå·²åœ¨ ~/nockchain-dev ç›®å½•ä¸­å‡†å¤‡å°±ç»ªã€‚\n"
    ColorYellow "è¯·è¿è¡Œ 'docker run -p 9944:9944 zorpcorp/nock-in-a-box' æ¥å¯åŠ¨æ‚¨çš„æœ¬åœ°æµ‹è¯•ç½‘ã€‚\n"
}

manage_staking() {
    # These are simulated interactions with a fictional CLI
    PS3="$(ColorYellow 'è¯·é€‰æ‹©è´¨æŠ¼ä¸æ²»ç†æ“ä½œ: ')"
    select action in "æ£€æŸ¥éªŒè¯è€…çŠ¶æ€" "è´¨æŠ¼ä»£å¸" "å–æ¶ˆè´¨æŠ¼" "é¢†å–å¥–åŠ±" "è¿”å›ä¸»èœå•"; do
        case "$action" in
            "æ£€æŸ¥éªŒè¯è€…çŠ¶æ€") ColorBlue ">> æ­£åœ¨æ‰§è¡Œ: nockchain-cli staking status\n"; sleep 1; echo "çŠ¶æ€: æ´»è·ƒ | å·²è´¨æŠ¼: 10,000 NCK | Era ç§¯åˆ†: 512\n";;
            "è´¨æŠ¼ä»£å¸") read -p "è¯·è¾“å…¥è¦è´¨æŠ¼çš„æ•°é‡: " amount; ColorBlue ">> æ­£åœ¨è´¨æŠ¼ $amount NCK...\n"; sleep 2; ColorGreen "æ“ä½œæˆåŠŸã€‚\n";;
            "å–æ¶ˆè´¨æŠ¼") read -p "è¯·è¾“å…¥è¦å–æ¶ˆè´¨æŠ¼çš„æ•°é‡: " amount; ColorBlue ">> æ­£åœ¨å–æ¶ˆè´¨æŠ¼ $amount NCK...\n"; sleep 2; ColorGreen "æ“ä½œæˆåŠŸã€‚\n";;
            "é¢†å–å¥–åŠ±") ColorBlue ">> æ­£åœ¨é¢†å–å¾…å¤„ç†çš„å¥–åŠ±...\n"; sleep 2; ColorGreen "å·²é¢†å– 128.42 NCKã€‚\n";;
            "è¿”å›ä¸»èœå•") break;;
        esac
    done
}

# --- INTERACTIVE MENU (CHINESE) ---

main_menu() {
    local status_text
    if systemctl is-active --quiet nockchain-node.service; then
        status_text="$(ColorGreen 'è¿è¡Œä¸­')"
    else
        status_text="$(ColorRed 'å·²åœæ­¢')"
    fi
    
    echo -e "\n$(ColorBlue '--- Nockchain ç¼–æ’å™¨ v4.0 "æ‰§æ”¿å®˜" ---')"
    echo -e "èŠ‚ç‚¹æœåŠ¡çŠ¶æ€: $status_text"
    
    echo -e "\n$(ColorGreen '1)') å®Œæ•´å®‰è£… (é¦–æ¬¡éƒ¨ç½²)"
    echo -e "$(ColorGreen '2)') èŠ‚ç‚¹ç®¡ç† (å¯åŠ¨/åœæ­¢/é‡å¯)"
    echo -e "$(ColorGreen '3)') è´¨æŠ¼ä¸æ²»ç†"
    echo -e "$(ColorGreen '4)') è®¾ç½®å¼€å‘è€…ç¯å¢ƒ"
    
    echo -e "\n$(ColorYellow '--- é«˜çº§æ“ä½œ ---')"
    echo -e "$(ColorYellow '5)') è¿è¡Œ AI è¿ç»´åå¤„ç†å™¨è¯Šæ–­"
    echo -e "$(ColorYellow '6)') æŸ¥çœ‹å®æ—¶æ—¥å¿—"
    echo -e "$(ColorYellow '7)') é…ç½® Tor åŒ¿åç½‘ç»œ"

    echo -e "\n$(ColorRed '0)') é€€å‡ºè„šæœ¬"

    read -p "$(ColorBlue '\nè¯·è¾“å…¥æ‚¨çš„é€‰æ‹© [0-7]: ')" choice
    case "$choice" in
        1) full_install ;;
        2) 
           PS3="è¯·é€‰æ‹©èŠ‚ç‚¹æ“ä½œ: "
           select act in "å¯åŠ¨ (start)" "åœæ­¢ (stop)" "é‡å¯ (restart)" "æŸ¥çœ‹çŠ¶æ€ (status)"; do
               action_cmd=$(echo "$act" | awk '{print $2}' | tr -d '()')
               sudo systemctl "$action_cmd" nockchain-node.service
               # For status, show it and wait for user input
               if [[ "$action_cmd" == "status" ]]; then read -p "æŒ‰å›è½¦é”®è¿”å›..."; fi
               break
           done
           ;;
        3) manage_staking ;;
        4) setup_dev_environment ;;
        5) run_ai_copilot ;;
        6) journalctl -u nockchain-node -n 100 -f --no-pager ;;
        7) 
           echo "æ­£åœ¨é…ç½® Tor... (æ­¤ä¸ºåŠŸèƒ½å ä½ç¬¦)"
           # A real implementation would modify nockchain config to use Tor as a SOCKS5 proxy
           sleep 1
           ColorGreen "å·²ä¸º P2P æµé‡å¯ç”¨ Tor ä»£ç†ã€‚\n"
           ;;
        0) exit 0 ;;
        *) ColorRed "æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚" ;;
    esac
    # Add a small delay for better user experience
    sleep 1
    main_menu
}

# --- SCRIPT ENTRYPOINT ---
main_menu
