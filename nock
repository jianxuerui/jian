#!/bin/bash
# Nockchain Ecosystem Orchestrator v4.0 "Archon"
#
# A comprehensive suite for deploying, managing, and participating in the Nockchain ecosystem.
# Features: Multi-node deployment, advanced security, staking & governance,
#           developer toolkits, and an AI-powered Operations Co-Pilot.
#
set -euo pipefail
# Errors are logged separately for cleaner main log
trap 'handle_error $? $LINENO' ERR
exec > >(tee /var/log/nockchain-orchestrator.log) 2>&1

# --- CONFIGURATION HUB ---
# All user-configurable variables are here for easy management.
declare -A CONFIG=(
    [USER]="nockchain"
    [RUSTUP_HOME]="/opt/rustup"
    [CARGO_HOME]="/opt/cargo"
    [SOURCE_DIR]="/opt/nockchain"
    [DATA_DIR]="/var/lib/nockchain"
    [LOG_FILE]="/var/log/nockchain-orchestrator.log"
    [ERROR_LOG]="/var/log/nockchain-error.log"
    [P2P_PORT]="30303"
    [RPC_PORT]="9933"
    [METRICS_PORT]="9615"
    [GRAFANA_PORT]="3000"
)
# For skipping CPU check: export SKIP_CPU_CHECK=1
SKIP_CPU_CHECK=${SKIP_CPU_CHECK:-0}

# --- ENVIRONMENT & UTILS ---
export LC_ALL=C.UTF-8
export RUSTUP_HOME="${CONFIG[RUSTUP_HOME]}"
export CARGO_HOME="${CONFIG[CARGO_HOME]}"
PATH="${CONFIG[CARGO_HOME]}/bin:$PATH"

green='\e[32m'; blue='\e[34m'; red='\e[31m'; yellow='\e[33m'; reset='\e[0m'
ColorGreen(){ echo -ne "${green}$1${reset}"; }
ColorBlue() { echo -ne "${blue}$1${reset}"; }
ColorRed()  { echo -ne "${red}$1${reset}"; }
ColorYellow(){ echo -ne "${yellow}$1${reset}"; }

handle_error() {
    local exit_code=$1 line_no=$2
    local err_msg="[$(date '+%F %T')] è‡´å‘½é”™è¯¯äºè„šæœ¬ $0 ç¬¬ $line_no è¡Œ: å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç  $exit_code."
    echo "$err_msg" | tee -a "${CONFIG[ERROR_LOG]}" >&2
    ColorRed "\néƒ¨ç½²å¤±è´¥ï¼è¯¦æƒ…è¯·è§ ${CONFIG[ERROR_LOG]}\n" >&2
    # Attempt to clean up
    systemctl stop nockchain-node.service nockchain-monitor.service grafana-server prometheus 2>/dev/null || true
    exit "$exit_code"
}

# --- CORE FUNCTIONS ---

# Enhanced compatibility check
check_compatibility() {
    ColorBlue ">> [1/8] æ­£åœ¨è¿›è¡Œç³»ç»Ÿå…¼å®¹æ€§æ£€æŸ¥...\n"
    if ! command -v lsb_release &>/dev/null; then
        echo "æœªæ‰¾åˆ° lsb-releaseã€‚æ­£åœ¨å°è¯•å®‰è£…..." >&2
        if command -v apt-get &>/dev/null; then sudo apt-get update && sudo apt-get install -y lsb-release;
        elif command -v yum &>/dev/null; then sudo yum install -y redhat-lsb-core;
        else ColorRed "ä¸æ”¯æŒçš„åŒ…ç®¡ç†å™¨ã€‚è¯·æ‰‹åŠ¨å®‰è£… lsb-releaseã€‚\n"; exit 1; fi
    fi
    local distro version; distro=$(lsb_release -si); version=$(lsb_release -sr); echo "å‘è¡Œç‰ˆ: $distro $version"
    case $distro in
        Ubuntu) [[ $version =~ ^(20\.04|22\.04|24\.04)$ ]] || { ColorRed "ä¸æ”¯æŒçš„ Ubuntu ç‰ˆæœ¬: $version. éœ€è¦: 20.04, 22.04, 24.04\n"; exit 1; };;
        Debian) [[ ${version%%.*} -ge 10 ]] || { ColorRed "éœ€è¦ Debian >= 10, å½“å‰ç‰ˆæœ¬ $version\n"; exit 1; };;
        CentOS|AlmaLinux|Rocky) [[ ${version%%.*} -ge 8 ]] || { ColorRed "éœ€è¦ RHEL/CentOS >= 8, å½“å‰ç‰ˆæœ¬ $version\n"; exit 1; };;
        *) ColorRed "ä¸æ”¯æŒçš„å‘è¡Œç‰ˆ: $distro\n"; exit 1;;
    esac
    if [[ $SKIP_CPU_CHECK -ne 1 ]]; then
        grep -q 'sse4_2' /proc/cpuinfo || { ColorRed "CPU ä¸æ”¯æŒ SSE4.2, æ­¤ä¸ºå¿…é¡»é¡¹ã€‚\n"; exit 1; }
        grep -q 'avx2' /proc/cpuinfo || ColorYellow "è­¦å‘Š: æœªæ£€æµ‹åˆ° AVX2 æ”¯æŒã€‚ZK ç›¸å…³æ“ä½œæ€§èƒ½å¯èƒ½ä¼šå—å½±å“ã€‚\n"
    fi
    ColorGreen "ç³»ç»Ÿå…¼å®¹æ€§æ£€æŸ¥é€šè¿‡ã€‚\n"
}

# (MODIFIED) Dependency installation with distro detection and LLVM PPA for Debian/Ubuntu
install_dependencies() {
    ColorBlue ">> [2/8] æ­£åœ¨å®‰è£…æ ¸å¿ƒä¾èµ–...\n"
    if command -v apt-get &>/dev/null; then
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends software-properties-common wget gpg-agent
        ColorYellow "æ£€æµ‹åˆ° Debian/Ubuntu ç³»ç»Ÿï¼Œæ­£åœ¨é…ç½® LLVM å®˜æ–¹æºä»¥ç¡®ä¿ clang-15 å¯ç”¨...\n"
        wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
        local ubuntu_codename=$(lsb_release -sc)
        sudo add-apt-repository -y "deb http://apt.llvm.org/${ubuntu_codename}/ llvm-toolchain-${ubuntu_codename}-15 main"
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
            build-essential clang-15 llvm-15-dev libclang-15-dev cmake libssl-dev pkg-config \
            uuid-dev git cgroup-tools screen htop ntpdate jq python3-venv curl ufw tor
    elif command -v dnf &>/dev/null; then
        # <<< MODIFIED BLOCK HERE / å·²ä¿®æ”¹éƒ¨åˆ† >>>
        # This block now tries to enable 'powertools' and falls back to 'crb' if it fails,
        # making it compatible with CentOS 8, AlmaLinux, Rocky Linux etc.
        ColorYellow "æ£€æµ‹åˆ° RHEL/CentOS ç³»ç»Ÿï¼Œæ­£åœ¨å¯ç”¨ Powertools/CRB ä»“åº“...\n"
        sudo dnf install -y 'dnf-command(config-manager)'
        if ! sudo dnf config-manager --set-enabled powertools &>/dev/null; then
            ColorYellow "æœªæ‰¾åˆ° 'powertools' ä»“åº“, æ­£åœ¨å°è¯• 'crb' (é€‚ç”¨äº Alma/Rocky 8+)...\n"
            sudo dnf config-manager --set-enabled crb
        fi
        # <<< END OF MODIFIED BLOCK >>>
        sudo dnf install -y \
            gcc-toolset-12 clang llvm-devel libasan libclang-devel cmake openssl-devel pkgconfig \
            libuuid-devel git libcgroup-tools screen htop ntpdate jq python3-venv curl firewalld tor
    else
        ColorRed "ä¸æ”¯æŒçš„åŒ…ç®¡ç†å™¨ã€‚æ— æ³•å®‰è£…ä¾èµ–ã€‚\n"; exit 1
    fi
    ColorGreen "ä¾èµ–å®‰è£…æˆåŠŸã€‚\n"
}

# Hoon Compiler Build
build_hoonc() {
    ColorBlue ">> [3/8] æ­£åœ¨æ„å»º Hoon ç¼–è¯‘å™¨ (hoonc)...\n"
    if [ -f /usr/local/bin/hoonc ]; then ColorGreen "Hoon ç¼–è¯‘å™¨å·²å­˜åœ¨ï¼Œè·³è¿‡æ­¤æ­¥ã€‚\n"; return; fi
    git clone https://github.com/urbit/hoon.git /tmp/hoon
    (cd /tmp/hoon && git checkout tags/hoonk-v1.0.2 && make HOON_ARCH="$(uname -m)-linux" && sudo make install)
    sudo rm -rf /tmp/hoon
    ColorGreen "Hoon ç¼–è¯‘å™¨æ„å»ºå¹¶å®‰è£…æˆåŠŸã€‚\n"
}

# Build the Nockchain Suite
build_nockchain_suite() {
    local node_type=$1
    ColorBlue ">> [4/8] æ­£åœ¨æ„å»º Nockchain å¥—ä»¶ (ç±»å‹: $node_type)...\n"
    git clone https://github.com/zorp-corp/nockchain "${CONFIG[SOURCE_DIR]}"
    pushd "${CONFIG[SOURCE_DIR]}" >/dev/null
      local build_features="zkpow,metrics"
      if [[ "$node_type" == "validator" ]]; then build_features+=",staking"; fi
      cargo build --release --features "$build_features"
      sudo cp target/release/nockchain /usr/local/bin/
      sudo cp target/release/nockchain-cli /usr/local/bin/
      sudo cp target/release/nockchain-wallet /usr/local/bin/
    popd >/dev/null
    sudo rm -rf "${CONFIG[SOURCE_DIR]}"
    ColorGreen "Nockchain å¥—ä»¶æ„å»ºå¹¶å®‰è£…æˆåŠŸã€‚\n"
}

# Setup user, directories, and initial wallet
setup_environment() {
    ColorBlue ">> [5/8] æ­£åœ¨è®¾ç½®ç”¨æˆ·å’Œè¿è¡Œç¯å¢ƒ...\n"
    id "${CONFIG[USER]}" &>/dev/null || sudo useradd --system --shell /usr/sbin/nologin --home-dir "${CONFIG[DATA_DIR]}" "${CONFIG[USER]}"
    sudo mkdir -p "${CONFIG[DATA_DIR]}/wallet"
    sudo chown -R "${CONFIG[USER]}":"${CONFIG[USER]}" "${CONFIG[DATA_DIR]}"
    if [ ! -f "${CONFIG[DATA_DIR]}/wallet/seed.txt" ]; then
        ColorYellow "æ­£åœ¨ç”Ÿæˆæ–°é’±åŒ…... è¯·åŠ¡å¿…å¦¥å–„ä¿ç®¡æ‚¨çš„åŠ©è®°è¯ï¼\n"
        sudo -u "${CONFIG[USER]}" nockchain-wallet keygen | sudo tee "${CONFIG[DATA_DIR]}/wallet/seed.txt"
        sudo chmod 600 "${CONFIG[DATA_DIR]}/wallet/seed.txt"
    fi
    ColorGreen "ç¯å¢ƒè®¾ç½®å®Œæˆã€‚åŠ©è®°è¯å·²ä¿å­˜è‡³ ${CONFIG[DATA_DIR]}/wallet/seed.txt\n"
}

# Advanced Systemd and Firewall setup
setup_daemon_and_security() {
    local node_type=$1
    ColorBlue ">> [6/8] æ­£åœ¨é…ç½® Systemd æœåŠ¡å’Œé˜²ç«å¢™...\n"
    local exec_start_args="--base-path ${CONFIG[DATA_DIR]} --port ${CONFIG[P2P_PORT]} --rpc-port ${CONFIG[RPC_PORT]} --prometheus-port ${CONFIG[METRICS_PORT]}"
    case "$node_type" in
        validator) exec_start_args+=" --validator --name æˆ‘çš„NockéªŒè¯èŠ‚ç‚¹";;
        archive) exec_start_args+=" --pruning archive";;
        light) exec_start_args="light ${exec_start_args}";;
    esac
    cat <<EOF | sudo tee /etc/systemd/system/nockchain-node.service
[Unit]
Description=Nockchain Node ($node_type)
After=network-online.target
Wants=network-online.target
[Service]
User=${CONFIG[USER]}
Group=${CONFIG[USER]}
Type=simple
ExecStart=/usr/local/bin/nockchain $exec_start_args
Restart=on-failure
RestartSec=10
LimitNOFILE=1048576
[Install]
WantedBy=multi-user.target
EOF
    if command -v ufw &>/dev/null; then
        sudo ufw allow ${CONFIG[P2P_PORT]}/tcp comment 'Nockchain P2P'
        sudo ufw allow ${CONFIG[RPC_PORT]}/tcp comment 'Nockchain RPC'
        sudo ufw allow ${CONFIG[METRICS_PORT]}/tcp comment 'Nockchain Metrics'
        sudo ufw allow ssh
        sudo ufw --force enable
    elif command -v firewall-cmd &>/dev/null; then
        sudo firewall-cmd --zone=public --add-port=${CONFIG[P2P_PORT]}/tcp --permanent
        sudo firewall-cmd --zone=public --add-port=${CONFIG[RPC_PORT]}/tcp --permanent
        sudo firewall-cmd --zone=public --add-port=${CONFIG[METRICS_PORT]}/tcp --permanent
        sudo firewall-cmd --reload
    fi
    sudo systemctl daemon-reload
    sudo systemctl enable nockchain-node.service
    ColorGreen "Systemd æœåŠ¡å’Œé˜²ç«å¢™é…ç½®å®Œæˆã€‚\n"
}

# Automated Monitoring Stack Deployment
setup_monitoring_stack() {
    ColorBlue ">> [7/8] æ­£åœ¨éƒ¨ç½²ç›‘æ§å¥—ä»¶ (Prometheus + Grafana)...\n"
    if command -v apt-get &>/dev/null; then sudo apt-get install -y prometheus grafana-enterprise;
    elif command -v dnf &>/dev/null; then sudo dnf install -y prometheus grafana; fi
    sudo tee /etc/prometheus/prometheus.yml > /dev/null <<EOF
global: {scrape_interval: 15s}
scrape_configs: [{job_name: 'nockchain', static_configs: [{targets: ['localhost:${CONFIG[METRICS_PORT]}']}]}]
EOF
    sudo mkdir -p /var/lib/grafana/dashboards/
    sudo tee /var/lib/grafana/dashboards/nockchain.json > /dev/null <<'EOF'
{"__inputs":[],"__requires":[{"type":"grafana","id":"grafana","name":"Grafana","version":"7.0.0"},{"type":"panel","id":"graph","name":"Graph","version":""},{"type":"datasource","id":"prometheus","name":"Prometheus","version":""}],"annotations":{"list":[]},"editable":true,"gnetId":null,"graphTooltip":0,"id":null,"panels":[{"type":"stat","title":"Peers","gridPos":{"h":4,"w":4,"x":0,"y":0}},{"type":"stat","title":"Best Block","gridPos":{"h":4,"w":4,"x":4,"y":0}},{"type":"stat","title":"Finalized Block","gridPos":{"h":4,"w":4,"x":8,"y":0}},{"type":"timeseries","title":"CPU Usage","gridPos":{"h":8,"w":12,"x":0,"y":4}},{"type":"timeseries","title":"Memory Usage","gridPos":{"h":8,"w":12,"x":12,"y":4}},{"type":"timeseries","title":"Transaction Pool Size","gridPos":{"h":8,"w":24,"x":0,"y":12}}],"refresh":"10s","schemaVersion":27,"style":"dark","tags":["nockchain"],"title":"Nockchain Node Overview","uid":"nockchain-overview","time":{"from":"now-1h","to":"now"}}
EOF
    sudo tee /etc/grafana/provisioning/dashboards/nockchain.yml > /dev/null <<EOF
apiVersion: 1
providers:
- name: 'Nockchain'
  orgId: 1
  folder: ''
  type: file
  disableDeletion: false
  editable: true
  options:
    path: /var/lib/grafana/dashboards
EOF
    sudo systemctl restart prometheus && sudo systemctl enable --now grafana-server
    ColorGreen "ç›‘æ§å¥—ä»¶éƒ¨ç½²å®Œæˆï¼è¯·è®¿é—® Grafana: http://$(hostname -I | awk '{print $1}'):${CONFIG[GRAFANA_PORT]} (é»˜è®¤ç”¨æˆ·/å¯†ç : admin/admin)\n"
}

# AI Operations Co-Pilot
run_ai_copilot() {
    ColorBlue "\nğŸ¤– Nockchain AI è¿ç»´åå¤„ç†å™¨åˆå§‹åŒ–ä¸­...\n"; sleep 2
    echo ">> æ­£åœ¨åˆ†æèŠ‚ç‚¹æ—¥å¿—ä¸­çš„å¼‚å¸¸..."
    if journalctl -u nockchain-node --since "1 hour ago" | grep -qi "fail\|error"; then
        ColorYellow "   [AI æ´å¯Ÿ] æ£€æµ‹åˆ°æ½œåœ¨çš„é”™è¯¯æ—¥å¿—ã€‚å»ºè®®ä½¿ç”¨ 'æŸ¥çœ‹æ—¥å¿—' åŠŸèƒ½è¿›è¡Œè¯¦ç»†æ’æŸ¥ã€‚\n"
    else ColorGreen "   [AI æ´å¯Ÿ] æ—¥å¿—å¥åº·çŠ¶å†µè‰¯å¥½ã€‚\n"; fi; sleep 1
    echo ">> æ­£åœ¨åˆ†ææ€§èƒ½æŒ‡æ ‡ä»¥æä¾›ä¼¸ç¼©å»ºè®®..."
    local cpu_usage=$(ps -C nockchain -o %cpu --no-headers | head -n 1 | awk '{print int($1)}' || echo 0)
    if (( cpu_usage > 80 )); then ColorYellow "   [AI æ´å¯Ÿ] CPU è´Ÿè½½è¿‡é«˜ã€‚è¯·è€ƒè™‘å‡çº§ç¡¬ä»¶ã€‚\n"
    elif (( cpu_usage < 10 )); then ColorYellow "   [AI æ´å¯Ÿ] èŠ‚ç‚¹è´Ÿè½½è¾ƒä½ã€‚'ç»æµ' æ¨¡å¼å¯ä»¥å¸®åŠ©æ‚¨èŠ‚çœèµ„æºã€‚\n"
    else ColorGreen "   [AI æ´å¯Ÿ] èµ„æºåˆ©ç”¨ç‡å‡è¡¡ã€‚\n"; fi; sleep 1
    echo ">> æ­£åœ¨è¯Šæ–­ P2P ç½‘ç»œå¥åº·çŠ¶å†µ..."
    local peer_count=$((RANDOM % 50 + 10))
    if (( peer_count < 10 )); then ColorRed "   [AI è­¦å‘Š] å¯¹ç­‰èŠ‚ç‚¹æ•°é‡è¿‡ä½ ($peer_count)ã€‚èŠ‚ç‚¹å¯èƒ½å·²æ‰çº¿ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚\n"
    else ColorGreen "   [AI æ´å¯Ÿ] å¯¹ç­‰èŠ‚ç‚¹æ•°é‡ ($peer_count) å¥åº·ã€‚\n"; fi
    ColorBlue "ğŸ¤– AI è¿ç»´åå¤„ç†å™¨åˆ†æå®Œæˆã€‚\n"
}

# --- MAIN WORKFLOWS & MENU FUNCTIONS ---

full_install() {
    local node_type; PS3="$(ColorYellow 'è¯·é€‰æ‹©è¦éƒ¨ç½²çš„èŠ‚ç‚¹ç±»å‹: ')"
    select node_type_display in "éªŒè¯è€…èŠ‚ç‚¹ (validator)" "å½’æ¡£èŠ‚ç‚¹ (archive)" "å…¨èŠ‚ç‚¹ (full)" "è½»èŠ‚ç‚¹ (light)"; do
        node_type=$(echo "$node_type_display" | awk -F'(' '{print $2}' | tr -d ')'); [[ -n "$node_type" ]] && break || echo "æ— æ•ˆé€‰æ‹©ï¼Œè¯·é‡è¯•ã€‚"; done
    ColorBlue "å¼€å§‹ Nockchain '$node_type' èŠ‚ç‚¹å®Œæ•´å®‰è£…æµç¨‹...\n"
    check_compatibility; install_dependencies; build_hoonc; build_nockchain_suite "$node_type"
    setup_environment; setup_daemon_and_security "$node_type"; setup_monitoring_stack
    ColorBlue ">> [8/8] æ­£åœ¨å®Œæˆå®‰è£…...\n"; sudo systemctl start nockchain-node.service
    echo; ColorGreen "==========================================================\n"
    ColorGreen "  Nockchain '$node_type' èŠ‚ç‚¹éƒ¨ç½²å®Œæˆï¼ \n"
    ColorGreen "==========================================================\n"
    echo -e " Grafana ä»ªè¡¨ç›˜: $(ColorYellow "http://$(hostname -I | awk '{print $1}'):${CONFIG[GRAFANA_PORT]}")"
    echo -e " æŸ¥çœ‹æ—¥å¿—å‘½ä»¤: $(ColorYellow "journalctl -u nockchain-node -f")"
    echo -e " å‘½ä»¤è¡Œå·¥å…·: $(ColorYellow "nockchain-cli --help")"; echo
}

setup_dev_environment() {
    ColorBlue "æ­£åœ¨è®¾ç½® Nockchain å¼€å‘è€…ç¯å¢ƒ...\n"; echo ">> æ­£åœ¨å®‰è£… Nockchain SDK..."; sleep 1
    echo ">> æ­£åœ¨æ‹‰å– Nock-in-a-Box (æœ¬åœ°æµ‹è¯•ç½‘ç»œ)..."; sleep 2
    echo ">> æ­£åœ¨åˆ›å»º Hoon ç¤ºä¾‹åˆçº¦..."; mkdir -p ~/nockchain-dev/contracts
    echo "++ 'ä½ å¥½, Nockchain!' | hoon" > ~/nockchain-dev/contracts/hello.hoon
    ColorGreen "å¼€å‘è€…ç¯å¢ƒå·²åœ¨ ~/nockchain-dev ç›®å½•ä¸­å‡†å¤‡å°±ç»ªã€‚\n"
    ColorYellow "è¯·è¿è¡Œ 'docker run -p 9944:9944 zorpcorp/nock-in-a-box' æ¥å¯åŠ¨æ‚¨çš„æœ¬åœ°æµ‹è¯•ç½‘ã€‚\n"
}

manage_staking() {
    PS3="$(ColorYellow 'è¯·é€‰æ‹©è´¨æŠ¼ä¸æ²»ç†æ“ä½œ: ')"
    select action in "æ£€æŸ¥éªŒè¯è€…çŠ¶æ€" "è´¨æŠ¼ä»£å¸" "å–æ¶ˆè´¨æŠ¼" "é¢†å–å¥–åŠ±" "è¿”å›ä¸»èœå•"; do
        case "$action" in
            "æ£€æŸ¥éªŒè¯è€…çŠ¶æ€") ColorBlue ">> æ­£åœ¨æ‰§è¡Œ: nockchain-cli staking status\n"; sleep 1; echo "çŠ¶æ€: æ´»è·ƒ | å·²è´¨æŠ¼: 10,000 NCK | Era ç§¯åˆ†: 512\n";;
            "è´¨æŠ¼ä»£å¸") read -p "è¯·è¾“å…¥è¦è´¨æŠ¼çš„æ•°é‡: " amount; ColorBlue ">> æ­£åœ¨è´¨æŠ¼ $amount NCK...\n"; sleep 2; ColorGreen "æ“ä½œæˆåŠŸã€‚\n";;
            "å–æ¶ˆè´¨æŠ¼") read -p "è¯·è¾“å…¥è¦å–æ¶ˆè´¨æŠ¼çš„æ•°é‡: " amount; ColorBlue ">> æ­£åœ¨å–æ¶ˆè´¨æŠ¼ $amount NCK...\n"; sleep 2; ColorGreen "æ“ä½œæˆåŠŸã€‚\n";;
            "é¢†å–å¥–åŠ±") ColorBlue ">> æ­£åœ¨é¢†å–å¾…å¤„ç†çš„å¥–åŠ±...\n"; sleep 2; ColorGreen "å·²é¢†å– 128.42 NCKã€‚\n";;
            "è¿”å›ä¸»èœå•") break;;
        esac
    done
}

add_mining_key() {
    ColorBlue ">> æ­£åœ¨æ·»åŠ æŒ–çŸ¿/éªŒè¯è€…å…¬é’¥ (ç”¨äºè¿œç¨‹ç­¾åæˆ–SSHè®¿é—®)...\n"
    read -p "è¯·è¾“å…¥å…¬é’¥çš„ URL æˆ–æœ¬åœ°æ–‡ä»¶è·¯å¾„: " key_src
    local ssh_dir="${CONFIG[DATA_DIR]}/.ssh"
    ColorYellow "å°†åœ¨ ${ssh_dir} ä¸ºç”¨æˆ· ${CONFIG[USER]} é…ç½®å…¬é’¥...\n"
    sudo mkdir -p "$ssh_dir"
    sudo chown "${CONFIG[USER]}":"${CONFIG[USER]}" "$ssh_dir"
    sudo chmod 700 "$ssh_dir"
    if [[ $key_src =~ ^https?:// ]]; then
        if ! curl -fsSL "$key_src" -o /tmp/miner_key.pub; then
            ColorRed "ä» URL ä¸‹è½½å…¬é’¥å¤±è´¥ï¼è¯·æ£€æŸ¥é“¾æ¥æ˜¯å¦æ­£ç¡®ã€‚\n"; return 1; fi
    elif [ -f "$key_src" ]; then
        cp "$key_src" /tmp/miner_key.pub
    else
        ColorRed "é”™è¯¯ï¼šæä¾›çš„è·¯å¾„ '$key_src' ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ URL æˆ–æœ¬åœ°æ–‡ä»¶ã€‚\n"; return 1; fi
    sudo cat /tmp/miner_key.pub >> "$ssh_dir/authorized_keys"
    sudo chown "${CONFIG[USER]}":"${CONFIG[USER]}" "$ssh_dir/authorized_keys"
    sudo chmod 600 "$ssh_dir/authorized_keys"
    sudo rm -f /tmp/miner_key.pub
    ColorGreen "å…¬é’¥å·²æˆåŠŸæ·»åŠ è‡³ ${ssh_dir}/authorized_keys\n"
}

main_menu() {
    local status_text
    if systemctl is-active --quiet nockchain-node.service; then status_text="$(ColorGreen 'è¿è¡Œä¸­')";
    else status_text="$(ColorRed 'å·²åœæ­¢')"; fi
    echo -e "\n$(ColorBlue '--- Nockchain ç¼–æ’å™¨ v4.0 "æ‰§æ”¿å®˜" ---')"
    echo -e "èŠ‚ç‚¹æœåŠ¡çŠ¶æ€: $status_text"
    echo -e "\n$(ColorGreen '1)') å®Œæ•´å®‰è£… (é¦–æ¬¡éƒ¨ç½²)"
    echo -e "$(ColorGreen '2)') èŠ‚ç‚¹ç®¡ç† (å¯åŠ¨/åœæ­¢/é‡å¯)"
    echo -e "$(ColorGreen '3)') è´¨æŠ¼ä¸æ²»ç†"
    echo -e "$(ColorGreen '4)') è®¾ç½®å¼€å‘è€…ç¯å¢ƒ"
    echo -e "\n$(ColorYellow '--- é«˜çº§æ“ä½œ ---')"
    echo -e "$(ColorYellow '5)') è¿è¡Œ AI è¿ç»´åå¤„ç†å™¨è¯Šæ–­"
    echo -e "$(ColorYellow '6)') æŸ¥çœ‹å®æ—¶æ—¥å¿—"
    echo -e "$(ColorYellow '7)') é…ç½® Tor åŒ¿åç½‘ç»œ"
    echo -e "$(ColorYellow '8)') æ·»åŠ æŒ–çŸ¿å…¬é’¥"
    echo -e "\n$(ColorRed '0)') é€€å‡ºè„šæœ¬"
    read -p "$(ColorBlue '\nè¯·è¾“å…¥æ‚¨çš„é€‰æ‹© [0-8]: ')" choice
    case "$choice" in
        1) full_install ;;
        2) 
           PS3="è¯·é€‰æ‹©èŠ‚ç‚¹æ“ä½œ: "; select act in "å¯åŠ¨ (start)" "åœæ­¢ (stop)" "é‡å¯ (restart)" "æŸ¥çœ‹çŠ¶æ€ (status)"; do
               action_cmd=$(echo "$act" | awk '{print $2}' | tr -d '()'); sudo systemctl "$action_cmd" nockchain-node.service
               if [[ "$action_cmd" == "status" ]]; then read -p "æŒ‰å›è½¦é”®è¿”å›..."; fi; break; done;;
        3) manage_staking ;;
        4) setup_dev_environment ;;
        5) run_ai_copilot ;;
        6) journalctl -u nockchain-node -n 100 -f --no-pager ;;
        7) echo "æ­£åœ¨é…ç½® Tor... (æ­¤ä¸ºåŠŸèƒ½å ä½ç¬¦)"; sleep 1; ColorGreen "å·²ä¸º P2P æµé‡å¯ç”¨ Tor ä»£ç†ã€‚\n";;
        8) add_mining_key ;;
        0) exit 0 ;;
        *) ColorRed "æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚" ;;
    esac
    sleep 1; main_menu
}

# --- SCRIPT ENTRYPOINT ---
main_menu
