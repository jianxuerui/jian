#!/bin/bash
# -*- coding: UTF-8 -*-
# Nockchainå®Œå…¨æ— sudoæƒé™ä¸­æ–‡ä¼˜åŒ–è„šæœ¬ v4.0

# é¢œè‰²å®šä¹‰
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
CYAN='\033[1;36m'
MAGENTA='\033[1;35m'
RESET='\033[0m'

# è·¯å¾„é…ç½®
INSTALL_PREFIX="$HOME/.local"
NOCKCHAIN_DIR="$HOME/nockchain"
LOG_FILE="$HOME/nockchain_install.log"
BACKUP_DIR="$HOME/nockchain_backup"
TOOLS_DIR="$HOME/.local/tools"

# ç¯å¢ƒå˜é‡è®¾ç½®
export PATH="$INSTALL_PREFIX/bin:$HOME/.cargo/bin:$PATH"
export LD_LIBRARY_PATH="$INSTALL_PREFIX/lib:$INSTALL_PREFIX/lib64:$LD_LIBRARY_PATH"
export PKG_CONFIG_PATH="$INSTALL_PREFIX/lib/pkgconfig:$PKG_CONFIG_PATH"
export C_INCLUDE_PATH="$INSTALL_PREFIX/include:$C_INCLUDE_PATH"
export CPLUS_INCLUDE_PATH="$INSTALL_PREFIX/include:$CPLUS_INCLUDE_PATH"

# æ¶ˆæ¯è¾“å‡ºå‡½æ•°
print_message() {
    local color=$1
    local message=$2
    echo -e "${color}${message}${RESET}"
}

log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

check_command() {
    if command -v "$1" >/dev/null 2>&1; then
        return 0
    else
        return 1
    fi
}

# æ˜¾ç¤ºä¸»èœå•
show_menu() {
    clear
    echo -e "${BLUE}
=======================================
 Nockchain æ— sudoæƒé™å®Œæ•´è§£å†³æ–¹æ¡ˆ v4.0
=======================================
${RESET}"
    echo -e "${YELLOW}1. å®Œæ•´å®‰è£…Nockchainï¼ˆæ— éœ€sudoæƒé™ï¼‰"
    echo "2. é…ç½®æŒ–çŸ¿å…¬é’¥"
    echo "3. å¯åŠ¨ä¼˜åŒ–æŒ–çŸ¿"
    echo "4. æŸ¥çœ‹å®æ—¶æ—¥å¿—"
    echo "5. æ£€æŸ¥é’±åŒ…ä½™é¢"
    echo "6. ç³»ç»ŸçŠ¶æ€ç›‘æ§"
    echo "7. å¤‡ä»½é’±åŒ…å¯†é’¥"
    echo "8. ç¯å¢ƒä¿®å¤å·¥å…·"
    echo "9. é€€å‡ºè„šæœ¬"
    echo -e "${BLUE}=======================================${RESET}"
}

# éªŒè¯å…¬é’¥æ ¼å¼
validate_pubkey() {
    local pubkey=$1
    if [[ $pubkey =~ ^[0-9a-fA-F]{128}$ ]]; then
        return 0
    elif [[ $pubkey =~ ^[1-9A-HJ-NP-Za-km-z]{40,50}$ ]]; then
        return 0
    else
        print_message "$RED" "é”™è¯¯ï¼šå…¬é’¥æ ¼å¼æ— æ•ˆ"
        print_message "$YELLOW" "æ”¯æŒæ ¼å¼ï¼š128ä½åå…­è¿›åˆ¶æˆ–Base58ç¼–ç "
        return 1
    fi
}

# æ£€æŸ¥å¹¶å®‰è£…Miniconda
install_miniconda() {
    print_message "$CYAN" "æ­£åœ¨æ£€æŸ¥Minicondaç¯å¢ƒ..."
    
    if check_command "conda"; then
        print_message "$GREEN" "Minicondaå·²å®‰è£…"
        return 0
    fi
    
    print_message "$CYAN" "æ­£åœ¨å®‰è£…Minicondaï¼ˆæ— éœ€sudoæƒé™ï¼‰..."
    
    # æ£€æµ‹ç³»ç»Ÿæ¶æ„
    local arch=$(uname -m)
    case $arch in
        x86_64) MINICONDA_URL="https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh" ;;
        aarch64) MINICONDA_URL="https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-aarch64.sh" ;;
        *) print_message "$RED" "ä¸æ”¯æŒçš„æ¶æ„: $arch"; return 1 ;;
    esac
    
    # ä¸‹è½½Minicondaå®‰è£…è„šæœ¬
    local miniconda_installer="/tmp/miniconda_installer.sh"
    if ! wget -q --show-progress "$MINICONDA_URL" -O "$miniconda_installer"; then
        print_message "$RED" "Minicondaä¸‹è½½å¤±è´¥"
        return 1
    fi
    
    # é™é»˜å®‰è£…Minicondaåˆ°ç”¨æˆ·ç›®å½•
    chmod +x "$miniconda_installer"
    if ! bash "$miniconda_installer" -b -p "$HOME/.miniconda3"; then
        print_message "$RED" "Minicondaå®‰è£…å¤±è´¥"
        return 1
    fi
    
    # åˆå§‹åŒ–condaç¯å¢ƒ
    source "$HOME/.miniconda3/etc/profile.d/conda.sh"
    conda config --set auto_activate_base false
    
    # æ·»åŠ åˆ°PATH
    export PATH="$HOME/.miniconda3/bin:$PATH"
    
    # æ¸…ç†å®‰è£…æ–‡ä»¶
    rm -f "$miniconda_installer"
    
    print_message "$GREEN" "Minicondaå®‰è£…å®Œæˆ"
    return 0
}

# ä½¿ç”¨condaå®‰è£…ç¼–è¯‘å·¥å…·
install_build_tools_with_conda() {
    print_message "$CYAN" "æ­£åœ¨åˆ›å»ºç¼–è¯‘ç¯å¢ƒ..."
    
    # ç¡®ä¿condaå¯ç”¨
    if ! check_command "conda"; then
        print_message "$RED" "Condaç¯å¢ƒä¸å¯ç”¨"
        return 1
    fi
    
    source "$HOME/.miniconda3/etc/profile.d/conda.sh"
    
    # åˆ›å»ºä¸“ç”¨çš„ç¼–è¯‘ç¯å¢ƒ
    print_message "$CYAN" "åˆ›å»ºnockchainç¼–è¯‘ç¯å¢ƒ..."
    conda create -n nockchain-build -y python=3.9 || {
        print_message "$YELLOW" "ç¯å¢ƒå·²å­˜åœ¨ï¼Œæ­£åœ¨æ›´æ–°..."
    }
    
    # æ¿€æ´»ç¯å¢ƒ
    conda activate nockchain-build
    
    # å®‰è£…ç¼–è¯‘å·¥å…·
    print_message "$CYAN" "å®‰è£…ç¼–è¯‘å·¥å…·ï¼ˆè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼‰..."
    local packages=(
        "gcc_linux-64"
        "gxx_linux-64" 
        "make"
        "cmake"
        "clang"
        "clangxx"
        "llvm-tools"
        "pkg-config"
        "openssl"
        "curl"
        "git"
        "wget"
    )
    
    for package in "${packages[@]}"; do
        print_message "$YELLOW" "å®‰è£… $package..."
        conda install -y "$package" -c conda-forge 2>/dev/null || {
            print_message "$YELLOW" "è·³è¿‡ $packageï¼ˆå¯èƒ½ä¸å¯ç”¨ï¼‰"
        }
    done
    
    # éªŒè¯å…³é”®å·¥å…·
    local tools=("gcc" "g++" "make" "clang" "git")
    local missing_tools=()
    
    for tool in "${tools[@]}"; do
        if check_command "$tool"; then
            print_message "$GREEN" "âœ… $tool: $(which $tool)"
        else
            missing_tools+=("$tool")
        fi
    done
    
    if [ ${#missing_tools[@]} -gt 0 ]; then
        print_message "$YELLOW" "éƒ¨åˆ†å·¥å…·æœªå®‰è£…: ${missing_tools[*]}"
        print_message "$YELLOW" "å°†å°è¯•ä»æºç ç¼–è¯‘..."
        return 1
    fi
    
    print_message "$GREEN" "ç¼–è¯‘å·¥å…·å®‰è£…å®Œæˆ"
    return 0
}

# ä»æºç ç¼–è¯‘å¿…è¦å·¥å…·
compile_tools_from_source() {
    print_message "$CYAN" "å¼€å§‹ä»æºç ç¼–è¯‘ç¼–è¯‘å·¥å…·..."
    
    mkdir -p "$TOOLS_DIR" "$INSTALL_PREFIX"/{bin,lib,include}
    cd "$TOOLS_DIR"
    
    # è®¾ç½®ç¼–è¯‘ç¯å¢ƒå˜é‡
    export CC="gcc"
    export CXX="g++"
    export CFLAGS="-O2 -fPIC"
    export CXXFLAGS="-O2 -fPIC"
    export LDFLAGS="-L$INSTALL_PREFIX/lib"
    export CPPFLAGS="-I$INSTALL_PREFIX/include"
    
    # å¦‚æœç³»ç»Ÿå®Œå…¨æ²¡æœ‰ç¼–è¯‘å·¥å…·ï¼Œå°è¯•ä¸‹è½½é¢„ç¼–è¯‘ç‰ˆæœ¬
    if ! check_command "gcc" && ! check_command "clang"; then
        print_message "$CYAN" "ç³»ç»Ÿç¼ºå°‘åŸºç¡€ç¼–è¯‘å™¨ï¼Œå°è¯•ä¸‹è½½é¢„ç¼–è¯‘ç‰ˆæœ¬..."
        
        # ä¸‹è½½æœ€å°åŒ–GCCå·¥å…·é“¾
        local gcc_url="https://github.com/steveicarus/mingw-w64-gcc/releases/download/gcc-11.2.0/gcc-11.2.0-linux-x86_64.tar.xz"
        if wget -q --timeout=30 "$gcc_url" -O gcc-minimal.tar.xz 2>/dev/null; then
            tar -xf gcc-minimal.tar.xz -C "$INSTALL_PREFIX" --strip-components=1
            export PATH="$INSTALL_PREFIX/bin:$PATH"
            rm -f gcc-minimal.tar.xz
        fi
    fi
    
    # ç¼–è¯‘makeå·¥å…·ï¼ˆå¦‚æœç¼ºå¤±ï¼‰
    if ! check_command "make"; then
        print_message "$CYAN" "ç¼–è¯‘GNU Make..."
        wget -q https://ftp.gnu.org/gnu/make/make-4.3.tar.gz
        tar -xzf make-4.3.tar.gz
        cd make-4.3
        ./configure --prefix="$INSTALL_PREFIX" --disable-nls
        ./build.sh && ./make install
        cd ..
        rm -rf make-4.3*
    fi
    
    print_message "$GREEN" "å·¥å…·ç¼–è¯‘å®Œæˆ"
}

# å®‰è£…Rustå·¥å…·é“¾
install_rust_toolchain() {
    print_message "$CYAN" "æ­£åœ¨å®‰è£…Rustå·¥å…·é“¾..."
    
    if check_command "rustc" && check_command "cargo"; then
        local rust_version=$(rustc --version 2>/dev/null)
        print_message "$YELLOW" "Rustå·²å®‰è£…: $rust_version"
        export PATH="$HOME/.cargo/bin:$PATH"
        return 0
    fi
    
    # ä¸‹è½½å¹¶å®‰è£…rustup
    print_message "$CYAN" "ä¸‹è½½å¹¶å®‰è£…Rust..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --no-modify-path
    
    if [ $? -ne 0 ]; then
        print_message "$RED" "Rustå®‰è£…å¤±è´¥"
        return 1
    fi
    
    # è®¾ç½®ç¯å¢ƒå˜é‡
    source "$HOME/.cargo/env"
    export PATH="$HOME/.cargo/bin:$PATH"
    
    # éªŒè¯å®‰è£…
    if check_command "rustc" && check_command "cargo"; then
        print_message "$GREEN" "Rustå®‰è£…æˆåŠŸ: $(rustc --version)"
        return 0
    else
        print_message "$RED" "RustéªŒè¯å¤±è´¥"
        return 1
    fi
}

# ä¸»å®‰è£…å‡½æ•°
install_nockchain_complete() {
    print_message "$GREEN" ">>> å¼€å§‹Nockchainå®Œæ•´å®‰è£…ï¼ˆæ— sudoæƒé™ï¼‰..."
    log_message "å¼€å§‹æ— sudoæƒé™å®Œæ•´å®‰è£…"
    
    # åˆ›å»ºå¿…è¦ç›®å½•
    mkdir -p "$INSTALL_PREFIX"/{bin,lib,include,share} "$NOCKCHAIN_DIR" "$BACKUP_DIR" "$TOOLS_DIR"
    
    # æ­¥éª¤1ï¼šæ£€æŸ¥ç³»ç»Ÿèµ„æº
    print_message "$MAGENTA" "æ­¥éª¤ 1/6: æ£€æŸ¥ç³»ç»Ÿèµ„æº..."
    local total_ram=$(free -m 2>/dev/null | awk '/^Mem:/{print $2}' || echo "0")
    local cpu_cores=$(nproc 2>/dev/null || echo "1")
    local available_space=$(df -m ~ 2>/dev/null | awk 'NR==2{print $4}' || echo "0")
    
    print_message "$YELLOW" "ç³»ç»Ÿé…ç½®ï¼š"
    print_message "$YELLOW" "- å†…å­˜: ${total_ram}MB"
    print_message "$YELLOW" "- CPUæ ¸å¿ƒ: ${cpu_cores}"
    print_message "$YELLOW" "- å¯ç”¨ç©ºé—´: ${available_space}MB"
    
    if [ "$total_ram" -lt 4096 ] && [ "$total_ram" -gt 0 ]; then
        print_message "$YELLOW" "è­¦å‘Šï¼šæ¨èå†…å­˜è‡³å°‘4GBï¼Œå½“å‰${total_ram}MB"
        read -p "æ˜¯å¦ç»§ç»­å®‰è£…ï¼Ÿ(y/N): " continue_install
        if [[ ! "$continue_install" =~ ^[Yy]$ ]]; then
            return 1
        fi
    fi
    
    # æ­¥éª¤2ï¼šå®‰è£…Minicondaç¯å¢ƒç®¡ç†å™¨
    print_message "$MAGENTA" "æ­¥éª¤ 2/6: å®‰è£…ç¯å¢ƒç®¡ç†å™¨..."
    if ! install_miniconda; then
        print_message "$RED" "ç¯å¢ƒç®¡ç†å™¨å®‰è£…å¤±è´¥"
        return 1
    fi
    
    # æ­¥éª¤3ï¼šå®‰è£…ç¼–è¯‘å·¥å…·
    print_message "$MAGENTA" "æ­¥éª¤ 3/6: å®‰è£…ç¼–è¯‘å·¥å…·..."
    source "$HOME/.miniconda3/etc/profile.d/conda.sh"
    
    if ! install_build_tools_with_conda; then
        print_message "$YELLOW" "Condaæ–¹å¼å®‰è£…å¤±è´¥ï¼Œå°è¯•æºç ç¼–è¯‘..."
        if ! compile_tools_from_source; then
            print_message "$RED" "ç¼–è¯‘å·¥å…·å®‰è£…å¤±è´¥"
            return 1
        fi
    fi
    
    # æ¿€æ´»ç¼–è¯‘ç¯å¢ƒ
    conda activate nockchain-build 2>/dev/null || true
    
    # æ­¥éª¤4ï¼šå®‰è£…Rustå·¥å…·é“¾
    print_message "$MAGENTA" "æ­¥éª¤ 4/6: å®‰è£…Rustå·¥å…·é“¾..."
    if ! install_rust_toolchain; then
        print_message "$RED" "Rustå®‰è£…å¤±è´¥"
        return 1
    fi
    
    # æ­¥éª¤5ï¼šå…‹éš†å’Œæ„å»ºNockchain
    print_message "$MAGENTA" "æ­¥éª¤ 5/6: å…‹éš†Nockchainé¡¹ç›®..."
    if [ -d "$NOCKCHAIN_DIR" ]; then
        print_message "$YELLOW" "å‘ç°ç°æœ‰å®‰è£…ï¼Œæ­£åœ¨æ›´æ–°..."
        cd "$NOCKCHAIN_DIR"
        git pull origin main || {
            print_message "$YELLOW" "æ›´æ–°å¤±è´¥ï¼Œé‡æ–°å…‹éš†..."
            cd "$HOME"
            rm -rf "$NOCKCHAIN_DIR"
            git clone https://github.com/zorp-corp/nockchain.git "$NOCKCHAIN_DIR"
        }
    else
        git clone https://github.com/zorp-corp/nockchain.git "$NOCKCHAIN_DIR" || {
            print_message "$RED" "ä»“åº“å…‹éš†å¤±è´¥"
            return 1
        }
    fi
    
    cd "$NOCKCHAIN_DIR"
    
    # é…ç½®ç¯å¢ƒæ–‡ä»¶
    if [ -f ".env_example" ]; then
        cp .env_example .env
    else
        cat > .env << 'EOF'
MINING_PUBKEY=0000000000000000000000000000000000000000000000000000000000000000
NETWORK=mainnet
MAX_PEERS=4000
LOG_LEVEL=info
RUST_LOG=info
RUST_MIN_STACK=8388608
EOF
    fi
    
    # æ­¥éª¤6ï¼šç¼–è¯‘é¡¹ç›®
    print_message "$MAGENTA" "æ­¥éª¤ 6/6: ç¼–è¯‘Nockchainé¡¹ç›®..."
    
    # è®¾ç½®ä¼˜åŒ–ç¼–è¯‘ç¯å¢ƒ
    export RUST_MIN_STACK=8388608
    export RUST_LOG=info
    export RUST_BACKTRACE=1
    export PATH="$HOME/.cargo/bin:$INSTALL_PREFIX/bin:$PATH"
    
    # ç¡®ä¿åœ¨condaç¯å¢ƒä¸­
    source "$HOME/.miniconda3/etc/profile.d/conda.sh"
    conda activate nockchain-build 2>/dev/null || true
    
    print_message "$CYAN" "æ­£åœ¨å®‰è£…hooncç¼–è¯‘å™¨..."
    if ! make install-hoonc; then
        print_message "$RED" "hooncç¼–è¯‘å™¨å®‰è£…å¤±è´¥"
        return 1
    fi
    
    print_message "$CYAN" "æ­£åœ¨æ„å»ºNockchainä¸»é¡¹ç›®..."
    if ! make build; then
        print_message "$RED" "é¡¹ç›®æ„å»ºå¤±è´¥"
        return 1
    fi
    
    print_message "$CYAN" "æ­£åœ¨å®‰è£…Nockchainé’±åŒ…..."
    if ! make install-nockchain-wallet; then
        print_message "$RED" "é’±åŒ…å®‰è£…å¤±è´¥"
        return 1
    fi
    
    print_message "$CYAN" "æ­£åœ¨å®‰è£…Nockchainä¸»ç¨‹åº..."
    if ! make install-nockchain; then
        print_message "$RED" "ä¸»ç¨‹åºå®‰è£…å¤±è´¥"
        return 1
    fi
    
    # ç”Ÿæˆé’±åŒ…
    print_message "$CYAN" "æ­£åœ¨ç”Ÿæˆé’±åŒ…å¯†é’¥..."
    if check_command "nockchain-wallet"; then
        local wallet_output
        wallet_output=$(nockchain-wallet keygen 2>&1)
        
        if [ $? -eq 0 ]; then
            print_message "$GREEN" "é’±åŒ…ç”ŸæˆæˆåŠŸï¼"
            print_message "$YELLOW" "é’±åŒ…ä¿¡æ¯ï¼š"
            echo "$wallet_output"
            
            # æå–å…¬é’¥å¹¶æ›´æ–°.envæ–‡ä»¶
            local pubkey=$(echo "$wallet_output" | grep -E "Public key:|å…¬é’¥:" | awk '{print $NF}' | head -1)
            if [ -n "$pubkey" ] && [ "$pubkey" != "0000000000000000000000000000000000000000000000000000000000000000" ]; then
                sed -i "s/MINING_PUBKEY=.*/MINING_PUBKEY=$pubkey/" .env
                print_message "$GREEN" "å…¬é’¥å·²è‡ªåŠ¨é…ç½®: $pubkey"
            fi
            
            # å¤‡ä»½é’±åŒ…ä¿¡æ¯
            echo "$wallet_output" > "$BACKUP_DIR/wallet_$(date +%Y%m%d_%H%M%S).txt"
            print_message "$GREEN" "é’±åŒ…ä¿¡æ¯å·²å¤‡ä»½"
        else
            print_message "$YELLOW" "é’±åŒ…ç”Ÿæˆå¯èƒ½å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ç”Ÿæˆ"
        fi
    fi
    
    # åˆ›å»ºç¯å¢ƒæ¿€æ´»è„šæœ¬
    cat > "$HOME/activate_nockchain.sh" << 'EOF'
#!/bin/bash
# Nockchainç¯å¢ƒæ¿€æ´»è„šæœ¬
source "$HOME/.miniconda3/etc/profile.d/conda.sh"
conda activate nockchain-build
export PATH="$HOME/.cargo/bin:$HOME/.local/bin:$PATH"
export RUST_MIN_STACK=8388608
export RUST_LOG=info
cd "$HOME/nockchain"
echo "Nockchainç¯å¢ƒå·²æ¿€æ´»"
echo "ä½¿ç”¨ 'make run-nockchain' å¯åŠ¨æŒ–çŸ¿"
EOF
    chmod +x "$HOME/activate_nockchain.sh"
    
    print_message "$GREEN" "ğŸ‰ Nockchainå®Œæ•´å®‰è£…æˆåŠŸï¼"
    print_message "$YELLOW" "å®‰è£…è·¯å¾„: $NOCKCHAIN_DIR"
    print_message "$YELLOW" "ç¯å¢ƒæ¿€æ´»: source ~/activate_nockchain.sh"
    print_message "$YELLOW" "å¤‡ä»½ç›®å½•: $BACKUP_DIR"
    print_message "$CYAN" "è¯·å¦¥å–„ä¿å­˜é’±åŒ…ä¿¡æ¯ï¼"
    
    log_message "Nockchainæ— sudoæƒé™å®‰è£…å®Œæˆ"
}

# é…ç½®æŒ–çŸ¿å…¬é’¥
configure_mining_key() {
    print_message "$CYAN" ">>> é…ç½®æŒ–çŸ¿å…¬é’¥"
    
    if [ ! -f "$NOCKCHAIN_DIR/.env" ]; then
        print_message "$RED" "é”™è¯¯ï¼šæœªæ‰¾åˆ°.envé…ç½®æ–‡ä»¶ï¼Œè¯·å…ˆå®‰è£…Nockchain"
        return 1
    fi
    
    print_message "$YELLOW" "å½“å‰å…¬é’¥ï¼š"
    local current_key=$(grep "MINING_PUBKEY" "$NOCKCHAIN_DIR/.env" | cut -d'=' -f2)
    print_message "$CYAN" "$current_key"
    
    echo
    read -p "è¯·è¾“å…¥æ–°çš„æŒ–çŸ¿å…¬é’¥ï¼ˆ128ä½åå…­è¿›åˆ¶æˆ–Base58æ ¼å¼ï¼‰: " new_pubkey
    
    if [ -z "$new_pubkey" ]; then
        print_message "$YELLOW" "è¾“å…¥ä¸ºç©ºï¼Œå–æ¶ˆæ“ä½œ"
        return 0
    fi
    
    if validate_pubkey "$new_pubkey"; then
        cd "$NOCKCHAIN_DIR"
        cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
        sed -i "s/MINING_PUBKEY=.*/MINING_PUBKEY=$new_pubkey/" .env
        print_message "$GREEN" "æŒ–çŸ¿å…¬é’¥æ›´æ–°æˆåŠŸï¼"
        log_message "æŒ–çŸ¿å…¬é’¥å·²æ›´æ–°"
    fi
}

# å¯åŠ¨æŒ–çŸ¿èŠ‚ç‚¹
start_mining() {
    print_message "$GREEN" ">>> å¯åŠ¨ä¼˜åŒ–æŒ–çŸ¿èŠ‚ç‚¹..."
    
    if [ ! -f "$NOCKCHAIN_DIR/.env" ]; then
        print_message "$RED" "é”™è¯¯ï¼šæœªæ‰¾åˆ°Nockchainå®‰è£…"
        return 1
    fi
    
    # æ¿€æ´»ç¯å¢ƒ
    source "$HOME/.miniconda3/etc/profile.d/conda.sh" 2>/dev/null
    conda activate nockchain-build 2>/dev/null || true
    
    cd "$NOCKCHAIN_DIR"
    
    # æ£€æŸ¥æ˜¯å¦å·²åœ¨è¿è¡Œ
    if screen -list | grep -q "nockchain"; then
        print_message "$YELLOW" "æ£€æµ‹åˆ°å·²æœ‰æŒ–çŸ¿è¿›ç¨‹åœ¨è¿è¡Œ"
        read -p "æ˜¯å¦é‡å¯æŒ–çŸ¿èŠ‚ç‚¹ï¼Ÿ(y/N): " restart_choice
        if [[ "$restart_choice" =~ ^[Yy]$ ]]; then
            screen -S nockchain -X quit 2>/dev/null
            sleep 2
        else
            return 0
        fi
    fi
    
    # æ£€æŸ¥å…¬é’¥é…ç½®
    local pubkey=$(grep "MINING_PUBKEY" .env | cut -d'=' -f2)
    if [ -z "$pubkey" ] || [ "$pubkey" = "0000000000000000000000000000000000000000000000000000000000000000" ]; then
        print_message "$RED" "è­¦å‘Šï¼šæœªé…ç½®æœ‰æ•ˆçš„æŒ–çŸ¿å…¬é’¥"
        read -p "æ˜¯å¦ç°åœ¨é…ç½®å…¬é’¥ï¼Ÿ(Y/n): " config_key
        if [[ ! "$config_key" =~ ^[Nn]$ ]]; then
            configure_mining_key
        fi
    fi
    
    # è®¾ç½®ç¯å¢ƒå˜é‡
    export RUST_MIN_STACK=8388608
    export RUST_LOG=info
    export PATH="$HOME/.cargo/bin:$HOME/.local/bin:$PATH"
    
    # åˆ›å»ºæ—¥å¿—ç›®å½•
    mkdir -p logs
    
    print_message "$CYAN" "æ­£åœ¨å¯åŠ¨æŒ–çŸ¿èŠ‚ç‚¹..."
    
    # åœ¨screenä¼šè¯ä¸­å¯åŠ¨
    screen -dmS nockchain bash -c "
        source '$HOME/.miniconda3/etc/profile.d/conda.sh' 2>/dev/null
        conda activate nockchain-build 2>/dev/null || true
        cd '$NOCKCHAIN_DIR'
        export RUST_MIN_STACK=8388608
        export RUST_LOG=info
        export PATH='$HOME/.cargo/bin:$HOME/.local/bin:$PATH'
        source .env
        echo '=== Nockchain æŒ–çŸ¿å¯åŠ¨ ===' > logs/mining.log
        echo 'å¯åŠ¨æ—¶é—´: $(date)' >> logs/mining.log
        echo 'å…¬é’¥: $MINING_PUBKEY' >> logs/mining.log
        echo 'ç¯å¢ƒ: æ— sudoæƒé™å®Œæ•´ç‰ˆ' >> logs/mining.log
        echo '==========================' >> logs/mining.log
        make run-nockchain 2>&1 | tee -a logs/mining.log
    "
    
    sleep 5
    
    if screen -list | grep -q "nockchain"; then
        print_message "$GREEN" "ğŸš€ æŒ–çŸ¿èŠ‚ç‚¹å¯åŠ¨æˆåŠŸï¼"
        print_message "$YELLOW" "ç®¡ç†å‘½ä»¤ï¼š"
        print_message "$CYAN" "- æŸ¥çœ‹çŠ¶æ€: screen -r nockchain"
        print_message "$CYAN" "- é€€å‡ºæŸ¥çœ‹: Ctrl+A, ç„¶åæŒ‰D"
        print_message "$CYAN" "- åœæ­¢æŒ–çŸ¿: screen -S nockchain -X quit"
        print_message "$CYAN" "- æ¿€æ´»ç¯å¢ƒ: source ~/activate_nockchain.sh"
        log_message "æŒ–çŸ¿èŠ‚ç‚¹å¯åŠ¨æˆåŠŸ"
    else
        print_message "$RED" "æŒ–çŸ¿èŠ‚ç‚¹å¯åŠ¨å¤±è´¥"
        return 1
    fi
}

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
view_logs() {
    print_message "$GREEN" ">>> æ˜¾ç¤ºæŒ–çŸ¿æ—¥å¿—ï¼ˆæŒ‰Ctrl+Cé€€å‡ºï¼‰"
    
    if [ -f "$NOCKCHAIN_DIR/logs/mining.log" ]; then
        print_message "$CYAN" "æ­£åœ¨æ˜¾ç¤ºå®æ—¶æ—¥å¿—..."
        tail -f "$NOCKCHAIN_DIR/logs/mining.log"
    else
        print_message "$YELLOW" "æœªæ‰¾åˆ°æ—¥å¿—æ–‡ä»¶ï¼Œå°è¯•è¿æ¥åˆ°screenä¼šè¯..."
        if screen -list | grep -q "nockchain"; then
            screen -r nockchain
        else
            print_message "$RED" "æœªæ‰¾åˆ°è¿è¡Œä¸­çš„æŒ–çŸ¿è¿›ç¨‹"
        fi
    fi
}

# æ£€æŸ¥é’±åŒ…ä½™é¢
check_balance() {
    print_message "$GREEN" ">>> æ£€æŸ¥é’±åŒ…ä½™é¢"
    
    # æ¿€æ´»ç¯å¢ƒ
    source "$HOME/.miniconda3/etc/profile.d/conda.sh" 2>/dev/null
    conda activate nockchain-build 2>/dev/null || true
    
    cd "$NOCKCHAIN_DIR"
    export PATH="$HOME/.cargo/bin:$HOME/.local/bin:$PATH"
    
    local pubkey=$(grep "MINING_PUBKEY" .env | cut -d'=' -f2)
    
    if [ -z "$pubkey" ] || [ "$pubkey" = "0000000000000000000000000000000000000000000000000000000000000000" ]; then
        print_message "$RED" "é”™è¯¯ï¼šæœªé…ç½®æœ‰æ•ˆçš„æŒ–çŸ¿å…¬é’¥"
        return 1
    fi
    
    print_message "$CYAN" "æ­£åœ¨æŸ¥è¯¢ä½™é¢..."
    print_message "$YELLOW" "å…¬é’¥: $pubkey"
    
    if check_command "nockchain-wallet"; then
        local socket_files=("./nockchain.sock" "./nockchain-leader.sock" "./nockchain-follower.sock")
        local balance_found=false
        
        for socket_file in "${socket_files[@]}"; do
            if [ -S "$socket_file" ]; then
                if nockchain-wallet --nockchain-socket "$socket_file" list-notes-by-pubkey -p "$pubkey" 2>/dev/null; then
                    balance_found=true
                    break
                fi
            fi
        done
        
        if [ "$balance_found" = false ]; then
            print_message "$YELLOW" "æ— æ³•è¿æ¥åˆ°èŠ‚ç‚¹ï¼Œè¯·ç¡®ä¿æŒ–çŸ¿èŠ‚ç‚¹æ­£åœ¨è¿è¡Œ"
        fi
    else
        print_message "$RED" "nockchain-walletå‘½ä»¤ä¸å¯ç”¨"
    fi
}

# ç³»ç»ŸçŠ¶æ€ç›‘æ§
system_monitor() {
    print_message "$BLUE" "====== ç³»ç»ŸçŠ¶æ€ç›‘æ§ ======"
    
    # CPUå’Œå†…å­˜ä¿¡æ¯
    if check_command "top"; then
        local cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1 2>/dev/null || echo "N/A")
        print_message "$YELLOW" "CPUä½¿ç”¨ç‡: ${cpu_usage}%"
    fi
    
    if check_command "free"; then
        local mem_used=$(free -m | awk '/^Mem:/{print $3}' 2>/dev/null || echo "0")
        local mem_total=$(free -m | awk '/^Mem:/{print $2}' 2>/dev/null || echo "0")
        if [ "$mem_total" -gt 0 ]; then
            local mem_percent=$((mem_used * 100 / mem_total))
            print_message "$YELLOW" "å†…å­˜ä½¿ç”¨: ${mem_used}MB / ${mem_total}MB (${mem_percent}%)"
        fi
    fi
    
    # ç£ç›˜ç©ºé—´
    local disk_info=$(df -h ~ 2>/dev/null | awk 'NR==2{print $4" å¯ç”¨"}' || echo "N/A")
    print_message "$YELLOW" "ç£ç›˜ç©ºé—´: $disk_info"
    
    # æŒ–çŸ¿çŠ¶æ€
    if screen -list 2>/dev/null | grep -q "nockchain"; then
        print_message "$GREEN" "æŒ–çŸ¿çŠ¶æ€: âœ… æ­£åœ¨è¿è¡Œ"
        if [ -f "$NOCKCHAIN_DIR/logs/mining.log" ]; then
            print_message "$CYAN" "æœ€è¿‘æ—¥å¿—ï¼š"
            tail -n 3 "$NOCKCHAIN_DIR/logs/mining.log" 2>/dev/null | while read -r line; do
                print_message "$YELLOW" "  $line"
            done
        fi
    else
        print_message "$RED" "æŒ–çŸ¿çŠ¶æ€: âŒ æœªè¿è¡Œ"
    fi
    
    # ç¯å¢ƒçŠ¶æ€
    print_message "$CYAN" "ç¯å¢ƒçŠ¶æ€ï¼š"
    print_message "$YELLOW" "- Conda: $(which conda 2>/dev/null || echo 'æœªå®‰è£…')"
    print_message "$YELLOW" "- Rust: $(which rustc 2>/dev/null || echo 'æœªå®‰è£…')"
    print_message "$YELLOW" "- ç¼–è¯‘å™¨: $(which gcc 2>/dev/null || which clang 2>/dev/null || echo 'æœªå®‰è£…')"
}

# å¤‡ä»½é’±åŒ…å¯†é’¥
backup_wallet() {
    print_message "$GREEN" ">>> å¤‡ä»½é’±åŒ…å¯†é’¥"
    
    # æ¿€æ´»ç¯å¢ƒ
    source "$HOME/.miniconda3/etc/profile.d/conda.sh" 2>/dev/null
    conda activate nockchain-build 2>/dev/null || true
    
    cd "$NOCKCHAIN_DIR"
    export PATH="$HOME/.cargo/bin:$HOME/.local/bin:$PATH"
    
    local backup_file="$BACKUP_DIR/complete_backup_$(date +%Y%m%d_%H%M%S).tar.gz"
    
    print_message "$CYAN" "æ­£åœ¨åˆ›å»ºå®Œæ•´å¤‡ä»½..."
    
    # åˆ›å»ºå¤‡ä»½ç›®å½•
    local temp_backup="/tmp/nockchain_backup_$(date +%Y%m%d_%H%M%S)"
    mkdir -p "$temp_backup"
    
    # å¤‡ä»½é…ç½®æ–‡ä»¶
    if [ -f ".env" ]; then
        cp .env "$temp_backup/"
    fi
    
    # å¤‡ä»½é’±åŒ…æ–‡ä»¶
    if check_command "nockchain-wallet"; then
        nockchain-wallet export-keys --output "$temp_backup/keys.export" 2>/dev/null || {
            print_message "$YELLOW" "é’±åŒ…å¯†é’¥å¯¼å‡ºå¤±è´¥ï¼Œè·³è¿‡"
        }
    fi
    
    # å¤‡ä»½å·²æœ‰çš„é’±åŒ…ä¿¡æ¯
    cp -r "$BACKUP_DIR"/*.txt "$temp_backup/" 2>/dev/null || true
    
    # å¤‡ä»½ç¯å¢ƒä¿¡æ¯
    cat > "$temp_backup/environment_info.txt" << EOF
# Nockchainç¯å¢ƒä¿¡æ¯å¤‡ä»½
å¤‡ä»½æ—¶é—´: $(date)
ç³»ç»Ÿä¿¡æ¯: $(uname -a)
Condaç¯å¢ƒ: $(conda info --base 2>/dev/null || echo "æœªå®‰è£…")
Rustç‰ˆæœ¬: $(rustc --version 2>/dev/null || echo "æœªå®‰è£…")
PATH: $PATH
å®‰è£…ç›®å½•: $NOCKCHAIN_DIR
EOF
    
    # åˆ›å»ºå‹ç¼©åŒ…
    tar -czf "$backup_file" -C "/tmp" "$(basename "$temp_backup")"
    
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    rm -rf "$temp_backup"
    
    print_message "$GREEN" "å®Œæ•´å¤‡ä»½åˆ›å»ºæˆåŠŸï¼"
    print_message "$YELLOW" "å¤‡ä»½æ–‡ä»¶: $backup_file"
    print_message "$CYAN" "è¯·å¦¥å–„ä¿å­˜æ­¤å¤‡ä»½æ–‡ä»¶"
    
    log_message "å®Œæ•´å¤‡ä»½å·²åˆ›å»º: $backup_file"
}

# ç¯å¢ƒä¿®å¤å·¥å…·
fix_environment() {
    print_message "$GREEN" ">>> ç¯å¢ƒä¿®å¤å·¥å…·"
    
    print_message "$CYAN" "æ­£åœ¨æ£€æŸ¥ç¯å¢ƒçŠ¶æ€..."
    
    # æ£€æŸ¥å…³é”®ç»„ä»¶
    local issues=()
    
    if ! check_command "conda"; then
        issues+=("Minicondaæœªå®‰è£…æˆ–æœªé…ç½®")
    fi
    
    if ! check_command "rustc"; then
        issues+=("Rustæœªå®‰è£…æˆ–æœªé…ç½®")
    fi
    
    if ! check_command "gcc" && ! check_command "clang"; then
        issues+=("ç¼–è¯‘å™¨æœªå®‰è£…")
    fi
    
    if [ ! -d "$NOCKCHAIN_DIR" ]; then
        issues+=("Nockchainç›®å½•ä¸å­˜åœ¨")
    fi
    
    if [ ${#issues[@]} -eq 0 ]; then
        print_message "$GREEN" "ç¯å¢ƒæ£€æŸ¥é€šè¿‡ï¼Œæ— éœ€ä¿®å¤"
        return 0
    fi
    
    print_message "$YELLOW" "å‘ç°ä»¥ä¸‹é—®é¢˜ï¼š"
    for issue in "${issues[@]}"; do
        print_message "$RED" "- $issue"
    done
    
    read -p "æ˜¯å¦è‡ªåŠ¨ä¿®å¤è¿™äº›é—®é¢˜ï¼Ÿ(Y/n): " fix_choice
    if [[ "$fix_choice" =~ ^[Nn]$ ]]; then
        return 0
    fi
    
    # ä¿®å¤ç¯å¢ƒé…ç½®
    print_message "$CYAN" "æ­£åœ¨ä¿®å¤ç¯å¢ƒ..."
    
    # é‡æ–°é…ç½®PATH
    cat >> "$HOME/.bashrc" << 'EOF'

# Nockchainç¯å¢ƒé…ç½®
export PATH="$HOME/.miniconda3/bin:$HOME/.cargo/bin:$HOME/.local/bin:$PATH"
export LD_LIBRARY_PATH="$HOME/.local/lib:$HOME/.local/lib64:$LD_LIBRARY_PATH"

# è‡ªåŠ¨æ¿€æ´»Nockchainç¯å¢ƒå‡½æ•°
activate_nockchain() {
    source "$HOME/.miniconda3/etc/profile.d/conda.sh" 2>/dev/null
    conda activate nockchain-build 2>/dev/null || true
    cd "$HOME/nockchain" 2>/dev/null || true
    export RUST_MIN_STACK=8388608
    export RUST_LOG=info
}
EOF
    
    # é‡æ–°åŠ è½½ç¯å¢ƒ
    source "$HOME/.bashrc"
    
    print_message "$GREEN" "ç¯å¢ƒä¿®å¤å®Œæˆ"
    print_message "$YELLOW" "è¯·è¿è¡Œ: source ~/.bashrc"
    print_message "$YELLOW" "æˆ–é‡æ–°ç™»å½•ä»¥åº”ç”¨æ›´æ”¹"
}

# ä¸»å¾ªç¯
main() {
    # æ£€æŸ¥rootæƒé™
    if [ "$EUID" -eq 0 ]; then
        print_message "$RED" "è¯·ä¸è¦ä»¥rootç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬"
        exit 1
    fi
    
    # åˆ›å»ºå¿…è¦ç›®å½•
    mkdir -p "$BACKUP_DIR" "$TOOLS_DIR"
    touch "$LOG_FILE"
    log_message "æ— sudoæƒé™è„šæœ¬å¯åŠ¨ v4.0"
    
    while true; do
        show_menu
        read -p "è¯·è¾“å…¥é€‰é¡¹ç¼–å·ï¼ˆ1-9ï¼‰: " choice
        
        case $choice in
            1) install_nockchain_complete ;;
            2) configure_mining_key ;;
            3) start_mining ;;
            4) view_logs ;;
            5) check_balance ;;
            6) system_monitor ;;
            7) backup_wallet ;;
            8) fix_environment ;;
            9)
                print_message "$GREEN" "æ„Ÿè°¢ä½¿ç”¨Nockchainæ— sudoæƒé™è§£å†³æ–¹æ¡ˆï¼"
                log_message "è„šæœ¬æ­£å¸¸é€€å‡º"
                exit 0
                ;;
            *)
                print_message "$RED" "æ— æ•ˆé€‰é¡¹ï¼Œè¯·è¾“å…¥1-9"
                ;;
        esac
        
        echo
        read -p "æŒ‰å›è½¦é”®ç»§ç»­..." -r
    done
}

# å¯åŠ¨ä¸»ç¨‹åº
main
