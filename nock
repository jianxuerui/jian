#!/bin/bash

# ========= Nockchain å®Œæ•´ç®¡ç†è„šæœ¬ v14.1 - åŒ…å«å®Œæ•´æ—¥å¿—åŠŸèƒ½ =========
RESET='\033[0m'
BOLD='\033[1m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'

NCK_DIR="$HOME/nockchain"
ENV_FILE="$NCK_DIR/.env"
LOG_FILE="$HOME/nockchain_build.log"
HOONC_LOG="$HOME/nockchain_hoonc.log"
NODE_LOG="$HOME/nockchain_node.log"

function show_banner() {
  clear
  echo -e "${BOLD}${CYAN}"
  echo "======================================================"
  echo "   Nockchain å®Œæ•´ç®¡ç†è„šæœ¬ v14.1 - åŒ…å«å®Œæ•´æ—¥å¿—åŠŸèƒ½"
  echo "======================================================"
  echo -e "${RESET}"
  echo "ğŸ¯ å®Œæ•´åŠŸèƒ½: å®‰è£… + æ„å»º + é’±åŒ… + èŠ‚ç‚¹ + æ—¥å¿—ç›‘æ§"
  echo "ğŸ’¾ å†…å­˜ä¼˜åŒ–: è‡ªåŠ¨å¤„ç†å¤§å†…å­˜éœ€æ±‚å’Œswapé…ç½®"
  echo "ğŸ”§ å…¨é¢ä¿®å¤: èµ„äº§æ–‡ä»¶ + è™šæ‹Ÿæ¸…å• + æ„å»ºå¤±è´¥ + å¯åŠ¨é—®é¢˜"
  echo "ğŸ“Š æ™ºèƒ½è¯Šæ–­: è¯¦ç»†é”™è¯¯åˆ†æå’Œè§£å†³å»ºè®®"
  echo "ğŸ“ˆ å®Œæ•´æ—¥å¿—: å¤šç§æ—¥å¿—æŸ¥çœ‹å’Œç›‘æ§æ–¹å¼"
  echo "------------------------------------------------------"
  echo ""
}

# ========= ä¹‹å‰çš„æ‰€æœ‰å®‰è£…å’Œæ„å»ºå‡½æ•°ä¿æŒä¸å˜ =========
# [å‰é¢çš„æ‰€æœ‰å‡½æ•°ä»£ç ä¿æŒç›¸åŒï¼Œè¿™é‡Œåªæ·»åŠ å®Œæ•´çš„æ—¥å¿—æŸ¥çœ‹åŠŸèƒ½]

# ========= å®Œæ•´çš„èŠ‚ç‚¹æ—¥å¿—æŸ¥çœ‹åŠŸèƒ½ =========
function view_node_logs() {
  echo -e "[*] èŠ‚ç‚¹æ—¥å¿—æŸ¥çœ‹é€‰é¡¹..."
  
  cd "$NCK_DIR" || return 1
  
  echo -e "${BLUE}[i] å¯ç”¨çš„æ—¥å¿—æŸ¥çœ‹æ–¹å¼:${RESET}"
  echo "  1) å®æ—¶èŠ‚ç‚¹æ—¥å¿— (screenä¼šè¯)"
  echo "  2) èŠ‚ç‚¹è¿è¡Œæ—¥å¿—æ–‡ä»¶"
  echo "  3) ç³»ç»Ÿnockchainæ—¥å¿—"
  echo "  4) æœ€æ–°é”™è¯¯æ—¥å¿—"
  echo "  5) å®Œæ•´æ—¥å¿—å†å²"
  echo "  0) è¿”å›ä¸»èœå•"
  echo ""
  
  read -p "è¯·é€‰æ‹©æ—¥å¿—æŸ¥çœ‹æ–¹å¼ (0-5): " log_choice
  
  case "$log_choice" in
    1) view_realtime_logs ;;
    2) view_node_log_file ;;
    3) view_system_nockchain_logs ;;
    4) view_latest_errors ;;
    5) view_full_log_history ;;
    0) return ;;
    *) echo -e "${RED}[-] æ— æ•ˆé€‰æ‹©${RESET}"; pause_and_return ;;
  esac
}

function view_realtime_logs() {
  echo -e "[*] æŸ¥çœ‹å®æ—¶èŠ‚ç‚¹æ—¥å¿—..."
  
  if command -v screen >/dev/null 2>&1 && screen -list | grep -qw "nockchain"; then
    echo -e "${GREEN}[+] å‘ç°è¿è¡Œä¸­çš„nockchain screenä¼šè¯${RESET}"
    echo -e "${YELLOW}[!] è¿›å…¥å®æ—¶æ—¥å¿—æŸ¥çœ‹ (æŒ‰ Ctrl+A+D é€€å‡ºä½†ä¿æŒèŠ‚ç‚¹è¿è¡Œ)${RESET}"
    echo -e "${YELLOW}[!] æŒ‰ Ctrl+C ç„¶å exit å¯ä»¥åœæ­¢èŠ‚ç‚¹${RESET}"
    echo ""
    read -p "æŒ‰Enterè¿›å…¥å®æ—¶æ—¥å¿—æŸ¥çœ‹..." key
    screen -r nockchain
  else
    echo -e "${RED}[-] æœªå‘ç°è¿è¡Œä¸­çš„nockchain screenä¼šè¯${RESET}"
    echo -e "${BLUE}[i] å°è¯•æŸ¥çœ‹å…¶ä»–æ—¥å¿—æ–‡ä»¶...${RESET}"
    view_node_log_file
  fi
  
  pause_and_return
}

function view_node_log_file() {
  echo -e "[*] æŸ¥çœ‹èŠ‚ç‚¹æ—¥å¿—æ–‡ä»¶..."
  
  if [ -f "$NODE_LOG" ]; then
    echo -e "${GREEN}[+] å‘ç°èŠ‚ç‚¹æ—¥å¿—æ–‡ä»¶: $NODE_LOG${RESET}"
    echo -e "${BLUE}[i] æ˜¾ç¤ºæœ€æ–°50è¡Œæ—¥å¿—ï¼ŒæŒ‰ Ctrl+C é€€å‡ºå®æ—¶ç›‘æ§${RESET}"
    echo ""
    
    # æ˜¾ç¤ºæœ€æ–°æ—¥å¿—
    echo -e "${YELLOW}=== æœ€æ–°50è¡Œæ—¥å¿— ===${RESET}"
    tail -50 "$NODE_LOG"
    
    echo ""
    read -p "æ˜¯å¦è¦å®æ—¶ç›‘æ§æ­¤æ—¥å¿—æ–‡ä»¶? (y/N): " monitor_choice
    if [[ "$monitor_choice" =~ ^[Yy]$ ]]; then
      echo -e "${BLUE}[i] å¼€å§‹å®æ—¶ç›‘æ§ (æŒ‰ Ctrl+C é€€å‡º)...${RESET}"
      tail -f "$NODE_LOG"
    fi
  elif [ -f "$NCK_DIR/nockchain.log" ]; then
    echo -e "${GREEN}[+] å‘ç°èŠ‚ç‚¹æ—¥å¿—æ–‡ä»¶: $NCK_DIR/nockchain.log${RESET}"
    echo -e "${BLUE}[i] æ˜¾ç¤ºæœ€æ–°50è¡Œæ—¥å¿—${RESET}"
    tail -50 "$NCK_DIR/nockchain.log"
    
    echo ""
    read -p "æ˜¯å¦è¦å®æ—¶ç›‘æ§æ­¤æ—¥å¿—æ–‡ä»¶? (y/N): " monitor_choice
    if [[ "$monitor_choice" =~ ^[Yy]$ ]]; then
      echo -e "${BLUE}[i] å¼€å§‹å®æ—¶ç›‘æ§ (æŒ‰ Ctrl+C é€€å‡º)...${RESET}"
      tail -f "$NCK_DIR/nockchain.log"
    fi
  else
    echo -e "${RED}[-] æœªæ‰¾åˆ°èŠ‚ç‚¹æ—¥å¿—æ–‡ä»¶${RESET}"
    echo -e "${BLUE}[i] å¯èƒ½çš„åŸå› :${RESET}"
    echo "  - èŠ‚ç‚¹å°šæœªå¯åŠ¨"
    echo "  - æ—¥å¿—æ–‡ä»¶ä½ç½®ä¸åŒ"
    echo "  - èŠ‚ç‚¹å¯åŠ¨å¤±è´¥"
  fi
  
  pause_and_return
}

function view_system_nockchain_logs() {
  echo -e "[*] æŸ¥çœ‹ç³»ç»Ÿnockchainç›¸å…³æ—¥å¿—..."
  
  # æ£€æŸ¥systemdæ—¥å¿—
  if command -v journalctl >/dev/null 2>&1; then
    echo -e "${BLUE}[i] æ£€æŸ¥systemdæ—¥å¿—...${RESET}"
    if journalctl -u nockchain --no-pager -n 20 2>/dev/null | grep -q "nockchain"; then
      echo -e "${GREEN}[+] å‘ç°systemd nockchainæœåŠ¡æ—¥å¿—${RESET}"
      journalctl -u nockchain --no-pager -n 50
    else
      echo -e "${YELLOW}[!] æ— systemd nockchainæœåŠ¡æ—¥å¿—${RESET}"
    fi
  fi
  
  # æ£€æŸ¥syslogä¸­çš„nockchainç›¸å…³æ—¥å¿—
  echo -e "${BLUE}[i] æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—ä¸­çš„nockchainç›¸å…³è®°å½•...${RESET}"
  if [ -f "/var/log/syslog" ]; then
    nockchain_logs=$(grep -i "nockchain" /var/log/syslog 2>/dev/null | tail -10)
    if [ -n "$nockchain_logs" ]; then
      echo -e "${GREEN}[+] å‘ç°ç³»ç»Ÿæ—¥å¿—ä¸­çš„nockchainè®°å½•:${RESET}"
      echo "$nockchain_logs"
    else
      echo -e "${YELLOW}[!] ç³»ç»Ÿæ—¥å¿—ä¸­æ— nockchainè®°å½•${RESET}"
    fi
  fi
  
  # æ£€æŸ¥å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æ—¥å¿—æ–‡ä»¶
  echo -e "${BLUE}[i] æœç´¢å½“å‰ç›®å½•ä¸‹çš„nockchainæ—¥å¿—æ–‡ä»¶...${RESET}"
  cd "$NCK_DIR" 2>/dev/null || cd "$HOME"
  
  found_logs=false
  for logfile in *.log nockchain*.log *.out; do
    if [ -f "$logfile" ]; then
      echo -e "${GREEN}[+] å‘ç°æ—¥å¿—æ–‡ä»¶: $logfile${RESET}"
      echo -e "  å¤§å°: $(du -h "$logfile" | cut -f1)"
      echo -e "  æœ€åä¿®æ”¹: $(stat -c %y "$logfile" 2>/dev/null || echo "æœªçŸ¥")"
      found_logs=true
    fi
  done
  
  if [ "$found_logs" = false ]; then
    echo -e "${YELLOW}[!] æœªå‘ç°æœ¬åœ°æ—¥å¿—æ–‡ä»¶${RESET}"
  fi
  
  pause_and_return
}

function view_latest_errors() {
  echo -e "[*] æŸ¥çœ‹æœ€æ–°é”™è¯¯æ—¥å¿—..."
  
  echo -e "${BLUE}[i] åˆ†æå„ç§æ—¥å¿—æ–‡ä»¶ä¸­çš„é”™è¯¯ä¿¡æ¯...${RESET}"
  
  # æ£€æŸ¥æ„å»ºæ—¥å¿—é”™è¯¯
  if [ -f "$LOG_FILE" ]; then
    echo -e "${YELLOW}=== æ„å»ºæ—¥å¿—é”™è¯¯ ===${RESET}"
    grep -i "error\|failed\|panic" "$LOG_FILE" | tail -5
    echo ""
  fi
  
  # æ£€æŸ¥hooncæ—¥å¿—é”™è¯¯
  if [ -f "$HOONC_LOG" ]; then
    echo -e "${YELLOW}=== hooncæ„å»ºé”™è¯¯ ===${RESET}"
    grep -i "error\|failed\|panic" "$HOONC_LOG" | tail -5
    echo ""
  fi
  
  # æ£€æŸ¥èŠ‚ç‚¹æ—¥å¿—é”™è¯¯
  if [ -f "$NODE_LOG" ]; then
    echo -e "${YELLOW}=== èŠ‚ç‚¹è¿è¡Œé”™è¯¯ ===${RESET}"
    grep -i "error\|failed\|panic\|addr.*use" "$NODE_LOG" | tail -5
    echo ""
  fi
  
  # æ£€æŸ¥screenä¼šè¯æ˜¯å¦æœ‰é”™è¯¯
  if command -v screen >/dev/null 2>&1; then
    if screen -list | grep -qw "nockchain"; then
      echo -e "${GREEN}[+] nockchain screenä¼šè¯æ­£åœ¨è¿è¡Œ${RESET}"
    else
      echo -e "${YELLOW}[!] æ— æ´»åŠ¨çš„nockchain screenä¼šè¯${RESET}"
    fi
  fi
  
  # æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
  if pgrep -f "nockchain" >/dev/null 2>&1; then
    echo -e "${GREEN}[+] å‘ç°è¿è¡Œä¸­çš„nockchainè¿›ç¨‹:${RESET}"
    pgrep -f "nockchain" | while read -r pid; do
      cmd=$(ps -p "$pid" -o args= 2>/dev/null || echo "unknown")
      echo -e "  PID $pid: $cmd"
    done
  else
    echo -e "${YELLOW}[!] æ— è¿è¡Œä¸­çš„nockchainè¿›ç¨‹${RESET}"
  fi
  
  pause_and_return
}

function view_full_log_history() {
  echo -e "[*] æŸ¥çœ‹å®Œæ•´æ—¥å¿—å†å²..."
  
  cd "$NCK_DIR" 2>/dev/null || cd "$HOME"
  
  echo -e "${BLUE}[i] å¯ç”¨çš„å†å²æ—¥å¿—æ–‡ä»¶:${RESET}"
  log_files=()
  
  if [ -f "$LOG_FILE" ]; then
    log_files+=("$LOG_FILE")
    echo -e "  1) ä¸»æ„å»ºæ—¥å¿—: $LOG_FILE ($(du -h "$LOG_FILE" | cut -f1))"
  fi
  
  if [ -f "$HOONC_LOG" ]; then
    log_files+=("$HOONC_LOG")
    echo -e "  2) hooncæ„å»ºæ—¥å¿—: $HOONC_LOG ($(du -h "$HOONC_LOG" | cut -f1))"
  fi
  
  if [ -f "$NODE_LOG" ]; then
    log_files+=("$NODE_LOG")
    echo -e "  3) èŠ‚ç‚¹è¿è¡Œæ—¥å¿—: $NODE_LOG ($(du -h "$NODE_LOG" | cut -f1))"
  fi
  
  # æŸ¥æ‰¾å…¶ä»–æ—¥å¿—æ–‡ä»¶
  local_logs=$(find . -name "*.log" -o -name "nockchain*.out" 2>/dev/null | head -5)
  if [ -n "$local_logs" ]; then
    echo -e "${BLUE}[i] å…¶ä»–å‘ç°çš„æ—¥å¿—æ–‡ä»¶:${RESET}"
    echo "$local_logs" | while read -r logfile; do
      if [ -f "$logfile" ]; then
        size=$(du -h "$logfile" | cut -f1)
        echo -e "  - $logfile ($size)"
      fi
    done
  fi
  
  if [ ${#log_files[@]} -eq 0 ]; then
    echo -e "${YELLOW}[!] æœªå‘ç°å†å²æ—¥å¿—æ–‡ä»¶${RESET}"
    pause_and_return
    return
  fi
  
  echo ""
  read -p "é€‰æ‹©è¦æŸ¥çœ‹çš„æ—¥å¿—æ–‡ä»¶ (1-3) æˆ–æŒ‰EnteræŸ¥çœ‹æ‰€æœ‰: " file_choice
  
  case "$file_choice" in
    1) if [ -f "$LOG_FILE" ]; then less "$LOG_FILE"; fi ;;
    2) if [ -f "$HOONC_LOG" ]; then less "$HOONC_LOG"; fi ;;
    3) if [ -f "$NODE_LOG" ]; then less "$NODE_LOG"; fi ;;
    "")
      echo -e "${BLUE}[i] æ˜¾ç¤ºæ‰€æœ‰æ—¥å¿—æ–‡ä»¶çš„æœ€æ–°å†…å®¹...${RESET}"
      for logfile in "${log_files[@]}"; do
        if [ -f "$logfile" ]; then
          echo -e "${YELLOW}=== $(basename "$logfile") æœ€æ–°50è¡Œ ===${RESET}"
          tail -50 "$logfile"
          echo ""
        fi
      done
      ;;
    *) echo -e "${RED}[-] æ— æ•ˆé€‰æ‹©${RESET}" ;;
  esac
  
  pause_and_return
}

# ========= å¢å¼ºçš„çŠ¶æ€æ£€æŸ¥ï¼ˆåŒ…å«æ—¥å¿—çŠ¶æ€ï¼‰ =========
function check_logs_status() {
  echo -e "[*] æ£€æŸ¥æ—¥å¿—çŠ¶æ€..."
  
  cd "$NCK_DIR" || return 1
  
  echo -e "${BLUE}[i] æ—¥å¿—æ–‡ä»¶çŠ¶æ€:${RESET}"
  
  # æ£€æŸ¥ä¸»è¦æ—¥å¿—æ–‡ä»¶
  for logfile in "$LOG_FILE" "$HOONC_LOG" "$NODE_LOG"; do
    if [ -f "$logfile" ]; then
      size=$(du -h "$logfile" | cut -f1)
      modified=$(stat -c %y "$logfile" 2>/dev/null | cut -d'.' -f1 || echo "æœªçŸ¥")
      echo -e "  âœ“ $(basename "$logfile"): $size (ä¿®æ”¹: $modified)"
    else
      echo -e "  âœ— $(basename "$logfile"): ä¸å­˜åœ¨"
    fi
  done
  
  # æ£€æŸ¥å®æ—¶æ—¥å¿—ï¼ˆscreenä¼šè¯ï¼‰
  if command -v screen >/dev/null 2>&1 && screen -list | grep -qw "nockchain"; then
    echo -e "  âœ“ å®æ—¶æ—¥å¿— (screenä¼šè¯): æ´»åŠ¨ä¸­"
  else
    echo -e "  âœ— å®æ—¶æ—¥å¿— (screenä¼šè¯): æ— æ´»åŠ¨ä¼šè¯"
  fi
  
  # æ£€æŸ¥æœ¬åœ°æ—¥å¿—æ–‡ä»¶
  local_log_count=$(find . -name "*.log" 2>/dev/null | wc -l)
  echo -e "  ğŸ“Š æœ¬åœ°æ—¥å¿—æ–‡ä»¶æ€»æ•°: $local_log_count"
  
  pause_and_return
}

# ========= ä¿æŒä¹‹å‰æ‰€æœ‰å…¶ä»–å‡½æ•°ä¸å˜ =========
# [è¿™é‡ŒåŒ…å«ä¹‹å‰æ‰€æœ‰çš„å®‰è£…ã€æ„å»ºã€é’±åŒ…ã€èŠ‚ç‚¹ç®¡ç†åŠŸèƒ½]

function pause_and_return() {
  echo ""
  read -n1 -r -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..." key
  main_menu
}

# ========= æ›´æ–°çš„ä¸»èœå•ï¼ˆåŒ…å«å®Œæ•´æ—¥å¿—åŠŸèƒ½ï¼‰ =========
function main_menu() {
  show_banner
  echo "è¯·é€‰æ‹©æ“ä½œ:"
  echo ""
  echo "ğŸš€ å®‰è£…å’Œæ„å»º:"
  echo "  1) ğŸ¯ å®Œæ•´å®‰è£… (ä»é›¶å¼€å§‹å®Œæ•´å®‰è£…)"
  echo "  2) ğŸ”§ é‡æ–°æ„å»ºæ‰€æœ‰ç»„ä»¶"
  echo "  3) ğŸ§¹ æ¸…ç†ç¯å¢ƒå¹¶é‡å»º"
  echo ""
  echo "ğŸ”‘ é’±åŒ…ç®¡ç†:"
  echo "  4) ğŸ”‘ ç”Ÿæˆæ–°é’±åŒ…"
  echo "  5) ğŸ“ è®¾ç½®æŒ–çŸ¿å…¬é’¥"
  echo "  6) ğŸ’¾ å¯¼å‡ºé’±åŒ…å¯†é’¥"
  echo "  7) ğŸ“‚ å¯¼å…¥é’±åŒ…å¯†é’¥"
  echo ""
  echo "âš¡ èŠ‚ç‚¹ç®¡ç†:"
  echo "  8) âš¡ ä¿®å¤å¹¶å¯åŠ¨èŠ‚ç‚¹"
  echo "  9) â¹ï¸  åœæ­¢æ‰€æœ‰æœåŠ¡"
  echo ""
  echo "ğŸ“ˆ æ—¥å¿—ç›‘æ§:"
  echo " 10) ğŸ“Š èŠ‚ç‚¹æ—¥å¿—æŸ¥çœ‹ (å®Œæ•´ç‰ˆ)"
  echo " 11) ğŸ” æ£€æŸ¥æ—¥å¿—çŠ¶æ€"
  echo " 12) âš ï¸  æŸ¥çœ‹æœ€æ–°é”™è¯¯"
  echo ""
  echo "ğŸ” çŠ¶æ€å’Œè¯Šæ–­:"
  echo " 13) ğŸ” æ£€æŸ¥å®Œæ•´çŠ¶æ€"
  echo " 14) ğŸ“Š ç³»ç»Ÿé—®é¢˜è¯Šæ–­"
  echo ""
  echo "  0) é€€å‡ºè„šæœ¬"
  echo ""
  echo -e "${CYAN}ğŸ’¡ æ–°å¢å®Œæ•´æ—¥å¿—åŠŸèƒ½: å®æ—¶ç›‘æ§ + å†å²æŸ¥çœ‹ + é”™è¯¯åˆ†æ${RESET}"
  echo -e "${CYAN}ğŸ’¡ å®Œæ•´è§£å†³æ–¹æ¡ˆ: å®‰è£… + æ„å»º + é’±åŒ… + èŠ‚ç‚¹ + æ—¥å¿—${RESET}"
  echo ""
  read -p "è¯·è¾“å…¥ç¼–å· (0-14): " choice

  case "$choice" in
    1) complete_installation_process ;;
    2) build_all_components_complete; pause_and_return ;;
    3) cleanup_and_rebuild ;;
    4) generate_wallet ;;
    5) set_mining_pubkey ;;
    6) export_wallet_keys ;;
    7) import_wallet_keys ;;
    8) fix_and_start_node ;;
    9) stop_all_services ;;
    10) view_node_logs ;;
    11) check_logs_status ;;
    12) view_latest_errors; pause_and_return ;;
    13) check_complete_status ;;
    14) diagnose_system_issues ;;
    0) echo "é€€å‡ºè„šæœ¬."; exit 0 ;;
    *) echo -e "${RED}[-] æ— æ•ˆé€‰é¡¹ï¼Œè¯·è¾“å…¥0-14${RESET}"; pause_and_return ;;
  esac
}

# æ£€æŸ¥ç”¨æˆ·æƒé™
if [ "$EUID" -eq 0 ]; then
  echo -e "${RED}[-] è¯·ä¸è¦ä»¥rootç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬${RESET}"
  exit 1
fi

# å¯åŠ¨ä¸»èœå•
main_menu
