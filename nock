#!/bin/bash

# ========= è‰²å½©å®šä¹‰ =========
RESET='\033[0m'
BOLD='\033[1m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'

# ========= é¡¹ç›®è·¯å¾„ =========
NCK_DIR="$HOME/nockchain"
ENV_FILE="$NCK_DIR/.env"

# ========= ç¯å¢ƒå˜é‡è®¾ç½® =========
export RUST_BACKTRACE=full
export CARGO_NET_RETRY=10
export CARGO_NET_TIMEOUT=120

# ========= æ¨ªå¹… =========
function show_banner() {
  clear
  echo -e "${BOLD}${BLUE}"
  echo "==============================================="
  echo "         Nockchain ç¤¾åŒºéªŒè¯å®‰è£…è„šæœ¬ v4.0"
  echo "==============================================="
  echo -e "${RESET}"
  echo "ğŸ“Œ ä½œè€…: K2 èŠ‚ç‚¹æ•™ç¨‹åˆ†äº«"
  echo "ğŸ”— Telegram: https://t.me/+EaCiFDOghoM3Yzll"
  echo "ğŸ¦ Twitter:  https://x.com/BtcK241918"
  echo "âš¡ åŸºäºç¤¾åŒºæˆåŠŸæ¡ˆä¾‹: Ubuntu 22.04 + 18GB RAM"
  echo "-----------------------------------------------"
  echo ""
}

# ========= ç³»ç»Ÿæ£€æŸ¥ =========
function check_system_requirements() {
  echo -e "[*] æ£€æŸ¥ç³»ç»Ÿè¦æ±‚..."
  
  # æ£€æŸ¥å†…å­˜ï¼ˆæ ¹æ®æœç´¢ç»“æœ[2]ï¼ŒæˆåŠŸæ¡ˆä¾‹ä½¿ç”¨18GB RAMï¼‰
  total_mem_kb=$(grep MemTotal /proc/meminfo 2>/dev/null | awk '{print $2}' || echo "0")
  total_mem_gb=$((total_mem_kb / 1024 / 1024))
  
  echo -e "${BLUE}[i] å½“å‰ç³»ç»Ÿå†…å­˜: ${total_mem_gb}GB${RESET}"
  echo -e "${BLUE}[i] ç¤¾åŒºæˆåŠŸæ¡ˆä¾‹é…ç½®: 1CPU/18GB RAM${RESET}"[2]
  
  if [ $total_mem_gb -lt 4 ]; then
    echo -e "${RED}[-] ä¸¥é‡è­¦å‘Š: å†…å­˜ä¸¥é‡ä¸è¶³ (${total_mem_gb}GB < 4GB)${RESET}"
    echo -e "${RED}    æ ¹æ®ç¤¾åŒºåé¦ˆï¼Œå†…å­˜ä¸è¶³ä¼šå¯¼è‡´panicé”™è¯¯${RESET}"[4]
    read -p "æ˜¯å¦ç»§ç»­? (y/N): " continue_choice
    if [[ ! "$continue_choice" =~ ^[Yy]$ ]]; then
      exit 1
    fi
  elif [ $total_mem_gb -lt 8 ]; then
    echo -e "${YELLOW}[!] è­¦å‘Š: å†…å­˜åä½ï¼Œå»ºè®®è‡³å°‘8GB${RESET}"
  else
    echo -e "${GREEN}[+] å†…å­˜æ£€æŸ¥é€šè¿‡: ${total_mem_gb}GB${RESET}"
  fi
  
  # æ£€æŸ¥ç£ç›˜ç©ºé—´
  free_space=$(df -BG "$HOME" | tail -1 | awk '{print $4}' | sed 's/G//')
  if [ "$free_space" -lt 20 ]; then
    echo -e "${RED}[-] è­¦å‘Š: ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œå»ºè®®è‡³å°‘20GBå¯ç”¨ç©ºé—´${RESET}"
  else
    echo -e "${GREEN}[+] ç£ç›˜ç©ºé—´æ£€æŸ¥é€šè¿‡: ${free_space}GBå¯ç”¨${RESET}"
  fi
  
  # æ£€æŸ¥æ“ä½œç³»ç»Ÿ
  if [[ "$OSTYPE" == "linux-gnu"* ]]; then
    OS="linux"
    if grep -q "Ubuntu" /etc/os-release 2>/dev/null; then
      ubuntu_version=$(grep VERSION_ID /etc/os-release | cut -d'"' -f2)
      echo -e "${GREEN}[+] æ£€æµ‹åˆ°Ubuntu ${ubuntu_version}${RESET}"
    fi
  else
    OS="unknown"
    echo -e "${YELLOW}[!] æ³¨æ„: ç¤¾åŒºæˆåŠŸæ¡ˆä¾‹åŸºäºUbuntu 22.04${RESET}"[2]
  fi
}

# ========= ç¤¾åŒºéªŒè¯çš„ä¾èµ–å®‰è£… =========
function install_dependencies_community() {
  echo -e "[*] å®‰è£…ç¤¾åŒºéªŒè¯çš„ä¾èµ–åŒ…..."[2]
  
  # æ ¹æ®æœç´¢ç»“æœ[2]ä¸­æˆåŠŸæ¡ˆä¾‹çš„ä¾èµ–åˆ—è¡¨
  sudo apt-get update && sudo apt-get upgrade -y
  
  sudo apt install \
    curl iptables build-essential git wget lz4 jq make gcc nano \
    automake autoconf tmux htop nvme-cli libgbm1 pkg-config \
    libssl-dev libleveldb-dev tar clang bsdmainutils ncdu unzip \
    libleveldb-dev libclang-dev llvm-dev -y
  
  # æ ¹æ®æœç´¢ç»“æœ[4]ä¸­Bruceçš„è§£å†³æ–¹æ¡ˆï¼Œç¡®ä¿build-essential
  sudo apt install build-essential -y
  
  echo -e "${GREEN}[+] ç¤¾åŒºéªŒè¯ä¾èµ–å®‰è£…å®Œæˆ${RESET}"
}

# ========= å†…å­˜ä¼˜åŒ–å’Œswapé…ç½® =========
function setup_memory_optimization() {
  echo -e "[*] é…ç½®å†…å­˜ä¼˜åŒ–..."
  
  # å¦‚æœå†…å­˜ä¸è¶³16GBï¼Œå¢åŠ swap
  if [ $total_mem_gb -lt 16 ]; then
    echo -e "${YELLOW}[*] å†…å­˜ä¸è¶³16GBï¼Œé…ç½®swapç©ºé—´...${RESET}"
    
    # æ£€æŸ¥ç°æœ‰swap
    current_swap=$(free -g | grep Swap | awk '{print $2}')
    if [ "$current_swap" -lt 8 ]; then
      echo -e "[*] åˆ›å»º8GB swapæ–‡ä»¶..."
      sudo fallocate -l 8G /swapfile 2>/dev/null || sudo dd if=/dev/zero of=/swapfile bs=1M count=8192 2>/dev/null
      sudo chmod 600 /swapfile
      sudo mkswap /swapfile >/dev/null 2>&1
      sudo swapon /swapfile >/dev/null 2>&1
      
      # æ·»åŠ åˆ°fstab
      if ! grep -q '/swapfile' /etc/fstab; then
        echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab >/dev/null
      fi
      
      echo -e "${GREEN}[+] Swapç©ºé—´å·²é…ç½®${RESET}"
    fi
  fi
  
  # å†…å­˜ç®¡ç†ä¼˜åŒ–
  sudo sysctl -w vm.overcommit_memory=1 >/dev/null 2>&1 || true
  sudo sysctl -w vm.max_map_count=655360 >/dev/null 2>&1 || true
  
  echo -e "${GREEN}[+] å†…å­˜ä¼˜åŒ–å®Œæˆ${RESET}"
}

# ========= Rustç¯å¢ƒè®¾ç½® =========
function setup_rust_community() {
  echo -e "[*] è®¾ç½®Rustç¯å¢ƒï¼ˆç¤¾åŒºæ–¹æ¡ˆï¼‰..."[2][4]
  
  # åˆ é™¤æ—§çš„Rustå®‰è£…
  if [ -d "$HOME/.cargo" ]; then
    echo -e "${YELLOW}[*] æ¸…ç†æ—§çš„Rustå®‰è£…...${RESET}"
    rm -rf "$HOME/.cargo"
  fi
  if [ -d "$HOME/.rustup" ]; then
    rm -rf "$HOME/.rustup"
  fi
  
  # æ ¹æ®æœç´¢ç»“æœ[2][4]çš„æ–¹æ³•å®‰è£…Rust
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  
  # ç«‹å³åŠ è½½ç¯å¢ƒ
  source $HOME/.cargo/env
  export PATH="$HOME/.cargo/bin:$PATH"
  
  # é…ç½®ç¯å¢ƒå˜é‡åˆ°shell
  for rc_file in "$HOME/.bashrc" "$HOME/.zshrc" "$HOME/.profile"; do
    if [ -f "$rc_file" ]; then
      if ! grep -q 'source $HOME/.cargo/env' "$rc_file"; then
        echo 'source $HOME/.cargo/env' >> "$rc_file"
      fi
      if ! grep -q 'export PATH="$HOME/.cargo/bin:$PATH"' "$rc_file"; then
        echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> "$rc_file"
      fi
    fi
  done
  
  # éªŒè¯å®‰è£…
  if command -v cargo >/dev/null 2>&1; then
    echo -e "${GREEN}[+] Rustå®‰è£…æˆåŠŸ${RESET}"
    rustc --version
    cargo --version
  else
    echo -e "${RED}[-] Rustå®‰è£…å¤±è´¥${RESET}"
    return 1
  fi
}

# ========= æ¸…ç†å’Œå…‹éš†ä»“åº“ =========
function clean_and_clone_community() {
  echo -e "[*] æ¸…ç†æ—§æ•°æ®å¹¶å…‹éš†ä»“åº“..."[2]
  
  cd "$HOME" || exit 1
  
  # æ ¹æ®æœç´¢ç»“æœ[2]çš„æ¸…ç†æ­¥éª¤
  echo -e "[*] æ¸…ç†æ—§æ•°æ®..."
  # kill miner screen
  screen -XS miner quit 2>/dev/null || true
  screen -XS nockchain quit 2>/dev/null || true
  
  # remove nockchain
  rm -rf nockchain
  rm -rf .nockapp
  
  echo -e "[*] å…‹éš†Nockchainä»“åº“..."
  # æ ¹æ®æœç´¢ç»“æœ[4]ä½¿ç”¨å®˜æ–¹ä»“åº“åœ°å€
  if ! git clone https://github.com/zorp-corp/nockchain; then
    echo -e "${RED}[-] ä»“åº“å…‹éš†å¤±è´¥${RESET}"
    return 1
  fi
  
  cd nockchain || return 1
  echo -e "${GREEN}[+] ä»“åº“å…‹éš†æˆåŠŸ${RESET}"
}

# ========= ç¤¾åŒºéªŒè¯çš„æ„å»ºæµç¨‹ =========
function build_community_method() {
  echo -e "[*] ä½¿ç”¨ç¤¾åŒºéªŒè¯çš„æ„å»ºæ–¹æ³•..."[2]
  
  cd "$NCK_DIR" || return 1
  
  # ç¡®ä¿ç¯å¢ƒå˜é‡æ­£ç¡®è®¾ç½®
  source $HOME/.cargo/env
  export PATH="$HOME/.cargo/bin:$PATH"
  
  # Step 4: Build (æ ¹æ®æœç´¢ç»“æœ[2])
  echo -e "[*] ç¬¬1æ­¥: è®¾ç½®ç¯å¢ƒæ–‡ä»¶..."
  cp .env_example .env
  echo -e "${GREEN}[+] .envæ–‡ä»¶åˆ›å»ºæˆåŠŸ${RESET}"
  
  # è®¾ç½®å†…å­˜å‹å¥½çš„æ„å»ºå‚æ•°
  export CARGO_BUILD_JOBS=1
  export RUSTFLAGS="-C opt-level=1 -C debuginfo=0"
  
  echo -e "[*] ç¬¬2æ­¥: æ„å»ºhoonc..."
  if timeout 1800 make install-hoonc; then
    echo -e "${GREEN}[+] hooncæ„å»ºæˆåŠŸ${RESET}"
  else
    echo -e "${YELLOW}[!] hooncæ„å»ºå¤±è´¥ï¼Œä½†ç»§ç»­...${RESET}"
  fi
  
  # ç¡®ä¿PATHåŒ…å«cargo bin
  export PATH="$HOME/.cargo/bin:$PATH"
  
  echo -e "[*] ç¬¬3æ­¥: æ„å»ºä¸»é¡¹ç›®..."
  if timeout 2400 make build; then
    echo -e "${GREEN}[+] ä¸»é¡¹ç›®æ„å»ºæˆåŠŸ${RESET}"
  else
    echo -e "${YELLOW}[!] ä¸»é¡¹ç›®æ„å»ºå¯èƒ½æœ‰é—®é¢˜ï¼Œç»§ç»­...${RESET}"
  fi
  
  echo -e "[*] ç¬¬4æ­¥: å®‰è£…é’±åŒ…..."
  if timeout 1200 make install-nockchain-wallet; then
    echo -e "${GREEN}[+] é’±åŒ…å®‰è£…æˆåŠŸ${RESET}"
  else
    echo -e "${YELLOW}[!] é’±åŒ…å®‰è£…å¤±è´¥${RESET}"
  fi
  
  export PATH="$HOME/.cargo/bin:$PATH"
  
  echo -e "[*] ç¬¬5æ­¥: å®‰è£…èŠ‚ç‚¹..."
  if timeout 1200 make install-nockchain; then
    echo -e "${GREEN}[+] èŠ‚ç‚¹å®‰è£…æˆåŠŸ${RESET}"
  else
    echo -e "${YELLOW}[!] èŠ‚ç‚¹å®‰è£…å¤±è´¥${RESET}"
  fi
  
  export PATH="$HOME/.cargo/bin:$PATH"
  
  # æ£€æŸ¥æ„å»ºç»“æœ
  echo -e "[*] æ£€æŸ¥æ„å»ºç»“æœ..."
  binary_count=0
  
  # æ£€æŸ¥é’±åŒ…
  if command -v nockchain-wallet >/dev/null 2>&1; then
    echo -e "${GREEN}  âœ“ nockchain-wallet (å·²å®‰è£…åˆ°PATH)${RESET}"
    ((binary_count++))
  elif [ -f "target/release/nockchain-wallet" ]; then
    echo -e "${GREEN}  âœ“ target/release/nockchain-wallet${RESET}"
    ((binary_count++))
  fi
  
  # æ£€æŸ¥èŠ‚ç‚¹
  if command -v nockchain >/dev/null 2>&1; then
    echo -e "${GREEN}  âœ“ nockchain (å·²å®‰è£…åˆ°PATH)${RESET}"
    ((binary_count++))
  elif [ -f "target/release/nockchain" ]; then
    echo -e "${GREEN}  âœ“ target/release/nockchain${RESET}"
    ((binary_count++))
  fi
  
  if [ $binary_count -gt 0 ]; then
    echo -e "${GREEN}[+] æ„å»ºæˆåŠŸï¼å‘ç° $binary_count ä¸ªå¯æ‰§è¡Œæ–‡ä»¶${RESET}"
    return 0
  else
    echo -e "${YELLOW}[!] æœªå‘ç°å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä½†æ„å»ºå¯èƒ½éƒ¨åˆ†æˆåŠŸ${RESET}"
    return 1
  fi
}

# ========= ä¸»å®‰è£…æµç¨‹ =========
function setup_all() {
  echo -e "[*] å¼€å§‹ç¤¾åŒºéªŒè¯çš„å®‰è£…æµç¨‹..."[2]
  
  check_system_requirements
  install_dependencies_community
  setup_memory_optimization
  setup_rust_community
  
  if ! clean_and_clone_community; then
    echo -e "${RED}[-] ä»“åº“å‡†å¤‡å¤±è´¥${RESET}"
    pause_and_return
    return
  fi
  
  if build_community_method; then
    echo -e "${GREEN}[+] âœ… Nockchainå®‰è£…æˆåŠŸï¼${RESET}"
    echo -e "${BLUE}[i] åŸºäºç¤¾åŒºæˆåŠŸæ¡ˆä¾‹ (Ubuntu 22.04 + 18GB RAM)${RESET}"[2]
    echo -e "${BLUE}[i] å¦‚æœåŒºå—é«˜åº¦åœç•™åœ¨0ï¼Œè¿™æ˜¯æ­£å¸¸ç°è±¡${RESET}"[4]
  else
    echo -e "${YELLOW}[!] å®‰è£…å¯èƒ½æœ‰éƒ¨åˆ†é—®é¢˜${RESET}"
    echo -e "${BLUE}[i] æ ¹æ®ç¤¾åŒºåé¦ˆï¼Œè¿™ç§æƒ…å†µä¸‹ä»å¯èƒ½å¯ä»¥è¿è¡Œ${RESET}"
  fi
  
  pause_and_return
}

# ========= é’±åŒ…ç”Ÿæˆ =========
function generate_wallet() {
  echo -e "[*] ç”Ÿæˆé’±åŒ…..."[2]
  cd "$NCK_DIR" || return 1
  
  # ç¡®ä¿ç¯å¢ƒå˜é‡
  source $HOME/.cargo/env 2>/dev/null || true
  export PATH="$HOME/.cargo/bin:$PATH"
  
  # æŸ¥æ‰¾é’±åŒ…äºŒè¿›åˆ¶æ–‡ä»¶
  wallet_bin=""
  if command -v nockchain-wallet >/dev/null 2>&1; then
    wallet_bin="nockchain-wallet"
  elif [ -f "target/release/nockchain-wallet" ]; then
    wallet_bin="./target/release/nockchain-wallet"
  elif [ -f "target/debug/nockchain-wallet" ]; then
    wallet_bin="./target/debug/nockchain-wallet"
  fi
  
  if [ -z "$wallet_bin" ]; then
    echo -e "${RED}[-] æœªæ‰¾åˆ°nockchain-walletäºŒè¿›åˆ¶æ–‡ä»¶${RESET}"
    echo -e "${YELLOW}[!] è¯·å…ˆå®Œæˆé¡¹ç›®æ„å»º${RESET}"
    pause_and_return
    return
  fi
  
  echo -e "${GREEN}[+] ä½¿ç”¨é’±åŒ…: $wallet_bin${RESET}"
  echo -e "${BLUE}[i] æ ¹æ®ç¤¾åŒºæŒ‡å—ï¼Œè¯·ä¿å­˜memoã€private keyå’Œpublic key${RESET}"[2]
  
  # ç”Ÿæˆé’±åŒ…
  if ! "$wallet_bin" keygen; then
    echo -e "${YELLOW}[!] é’±åŒ…ç”Ÿæˆå¯èƒ½é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥è¾“å‡º${RESET}"
  fi
  
  echo -e "${YELLOW}[!] é’±åŒ…ç”Ÿæˆå®Œæˆï¼Œè¯·å¤åˆ¶ä¸Šæ–¹å…¬é’¥åˆ°ä¸‹ä¸€æ­¥è®¾ç½®ä¸­${RESET}"
  echo -e "${BLUE}[i] å…¬é’¥æ ¼å¼ä¸º128ä½16è¿›åˆ¶å­—ç¬¦ä¸²${RESET}"
  echo -e "${BLUE}[i] è¯·å°†å…¬é’¥æ›¿æ¢åˆ°.envæ–‡ä»¶çš„MINING_PUBKEY=å¤„${RESET}"[2]
  pause_and_return
}

function validate_pubkey() {
  local pubkey="$1"
  
  if [ ${#pubkey} -ne 128 ]; then
    echo -e "${RED}[-] å…¬é’¥é•¿åº¦é”™è¯¯ï¼åº”ä¸º128ä½ï¼Œå½“å‰ä¸º${#pubkey}ä½${RESET}"
    return 1
  fi
  
  if [[ ! "$pubkey" =~ ^[0-9a-fA-F]{128}$ ]]; then
    echo -e "${RED}[-] å…¬é’¥æ ¼å¼é”™è¯¯ï¼åªèƒ½åŒ…å«0-9å’Œa-få­—ç¬¦${RESET}"
    return 1
  fi
  
  return 0
}

function set_pubkey_env() {
  echo -e "[*] è®¾ç½® MINING_PUBKEY åˆ° .env..."[2]
  cd "$NCK_DIR" || return 1

  echo -e "${BLUE}[i] å…¬é’¥æ ¼å¼è¦æ±‚ï¼š128ä½16è¿›åˆ¶å­—ç¬¦ä¸²${RESET}"
  echo -e "${BLUE}[i] æ ¹æ®ç¤¾åŒºæŒ‡å—ï¼Œæ›¿æ¢.envæ–‡ä»¶ä¸­çš„MINING_PUBKEY=å€¼${RESET}"[2]
  echo ""
  
  while true; do
    read -p "è¯·è¾“å…¥å…¬é’¥ (MINING_PUBKEY): " pubkey
    
    if [ -z "$pubkey" ]; then
      echo -e "${RED}[-] å…¬é’¥ä¸èƒ½ä¸ºç©º${RESET}"
      continue
    fi
    
    pubkey=$(echo "$pubkey" | tr -d ' \n\r\t')
    
    if validate_pubkey "$pubkey"; then
      pubkey=$(echo "$pubkey" | tr '[:upper:]' '[:lower:]')
      
      # æ›´æ–°.envæ–‡ä»¶
      if command -v sed >/dev/null 2>&1; then
        sed -i '/^MINING_PUBKEY=/d' "$ENV_FILE" 2>/dev/null || {
          grep -v '^MINING_PUBKEY=' "$ENV_FILE" > "$ENV_FILE.tmp" && mv "$ENV_FILE.tmp" "$ENV_FILE"
        }
      else
        grep -v '^MINING_PUBKEY=' "$ENV_FILE" > "$ENV_FILE.tmp" && mv "$ENV_FILE.tmp" "$ENV_FILE"
      fi
      echo "MINING_PUBKEY=$pubkey" >> "$ENV_FILE"
      
      echo -e "${GREEN}[+] å…¬é’¥æ ¼å¼éªŒè¯é€šè¿‡ï¼Œå·²å†™å…¥ .env æ–‡ä»¶${RESET}"
      echo -e "${GREEN}[+] å…¬é’¥: $pubkey${RESET}"
      break
    else
      echo -e "${YELLOW}[!] è¯·é‡æ–°è¾“å…¥æ­£ç¡®æ ¼å¼çš„å…¬é’¥${RESET}"
    fi
  done
  
  pause_and_return
}

function export_keys() {
  echo -e "[*] å¯¼å‡ºé’±åŒ…å¯†é’¥..."[2]
  cd "$NCK_DIR" || return 1
  
  # ç¡®ä¿ç¯å¢ƒå˜é‡
  source $HOME/.cargo/env 2>/dev/null || true
  export PATH="$HOME/.cargo/bin:$PATH"
  
  wallet_bin=""
  if command -v nockchain-wallet >/dev/null 2>&1; then
    wallet_bin="nockchain-wallet"
  elif [ -f "target/release/nockchain-wallet" ]; then
    wallet_bin="./target/release/nockchain-wallet"
  elif [ -f "target/debug/nockchain-wallet" ]; then
    wallet_bin="./target/debug/nockchain-wallet"
  fi
  
  if [ -z "$wallet_bin" ]; then
    echo -e "${RED}[-] æœªæ‰¾åˆ°nockchain-walletäºŒè¿›åˆ¶æ–‡ä»¶${RESET}"
    pause_and_return
    return
  fi
  
  "$wallet_bin" export-keys
  echo -e "${GREEN}[+] å¯†é’¥å·²å¯¼å‡ºåˆ° keys.export${RESET}"
  echo -e "${BLUE}[i] ç¡®ä¿keys.exportæ–‡ä»¶åœ¨nockchainç›®å½•ä¸­${RESET}"[2]
  pause_and_return
}

function import_keys() {
  echo -e "[*] å¯¼å…¥é’±åŒ…å¯†é’¥..."[2]
  cd "$NCK_DIR" || return 1
  
  # ç¡®ä¿ç¯å¢ƒå˜é‡
  source $HOME/.cargo/env 2>/dev/null || true
  export PATH="$HOME/.cargo/bin:$PATH"
  
  wallet_bin=""
  if command -v nockchain-wallet >/dev/null 2>&1; then
    wallet_bin="nockchain-wallet"
  elif [ -f "target/release/nockchain-wallet" ]; then
    wallet_bin="./target/release/nockchain-wallet"
  elif [ -f "target/debug/nockchain-wallet" ]; then
    wallet_bin="./target/debug/nockchain-wallet"
  fi
  
  if [ -z "$wallet_bin" ]; then
    echo -e "${RED}[-] æœªæ‰¾åˆ°nockchain-walletäºŒè¿›åˆ¶æ–‡ä»¶${RESET}"
    pause_and_return
    return
  fi
  
  read -p "[?] è¯·è¾“å…¥å¯†é’¥æ–‡ä»¶è·¯å¾„ (é»˜è®¤: ./keys.export): " keyfile
  keyfile=${keyfile:-"./keys.export"}
  
  if [ -f "$keyfile" ]; then
    "$wallet_bin" import-keys --input "$keyfile"
    echo -e "${GREEN}[+] å¯†é’¥å·²å¯¼å…¥${RESET}"
  else
    echo -e "${RED}[-] å¯†é’¥æ–‡ä»¶ä¸å­˜åœ¨: $keyfile${RESET}"
  fi
  pause_and_return
}

# ========= å¯åŠ¨èŠ‚ç‚¹ï¼ˆç¤¾åŒºå‘½ä»¤ï¼‰=========
function start_node_community() {
  echo -e "[*] å¯åŠ¨NockchainèŠ‚ç‚¹ï¼ˆç¤¾åŒºæ–¹æ³•ï¼‰..."[2]
  cd "$NCK_DIR" || return 1
  
  if [ ! -f "$ENV_FILE" ]; then
    echo -e "${RED}[-] .envæ–‡ä»¶ä¸å­˜åœ¨${RESET}"
    pause_and_return
    return
  fi
  
  source "$ENV_FILE"

  if [ -z "$MINING_PUBKEY" ]; then
    echo -e "${RED}[-] æœªè®¾ç½® MINING_PUBKEYï¼Œè¯·å…ˆè®¾ç½®æŒ–çŸ¿å…¬é’¥${RESET}"
    pause_and_return
    return
  fi

  # ç¡®ä¿ç¯å¢ƒå˜é‡
  source $HOME/.cargo/env 2>/dev/null || true
  export PATH="$HOME/.cargo/bin:$PATH"

  # æŸ¥æ‰¾èŠ‚ç‚¹äºŒè¿›åˆ¶æ–‡ä»¶
  node_bin=""
  if command -v nockchain >/dev/null 2>&1; then
    node_bin="nockchain"
  elif [ -f "target/release/nockchain" ]; then
    node_bin="./target/release/nockchain"
  elif [ -f "target/debug/nockchain" ]; then
    node_bin="./target/debug/nockchain"
  fi
  
  if [ -z "$node_bin" ]; then
    echo -e "${RED}[-] æœªæ‰¾åˆ°nockchainäºŒè¿›åˆ¶æ–‡ä»¶${RESET}"
    pause_and_return
    return
  fi

  echo -e "${GREEN}[+] ä½¿ç”¨èŠ‚ç‚¹: $node_bin${RESET}"
  echo -e "${BLUE}[i] æ ¹æ®ç¤¾åŒºåé¦ˆï¼Œå¦‚æœåŒºå—é«˜åº¦åœç•™åœ¨0æ˜¯æ­£å¸¸ç°è±¡${RESET}"[4]
  echo -e "${BLUE}[i] ä½¿ç”¨ç¤¾åŒºéªŒè¯çš„å¯åŠ¨å‘½ä»¤${RESET}"[2]

  # æ¸…ç†æ—§æ•°æ®ï¼ˆæ ¹æ®æœç´¢ç»“æœ[2]ï¼‰
  rm -rf ./.data.nockchain .socket/nockchain_npc.sock 2>/dev/null || true
  mkdir -p .socket

  # æ„å»ºç¤¾åŒºéªŒè¯çš„å¯åŠ¨å‘½ä»¤[2]
  start_cmd="RUST_LOG=info $node_bin --mining-pubkey $MINING_PUBKEY \
--mine \
--peer /ip4/95.216.102.60/udp/3006/quic-v1 \
--peer /ip4/65.109.156.108/udp/3006/quic-v1 \
--peer /ip4/65.21.67.175/udp/3006/quic-v1 \
--peer /ip4/65.109.156.172/udp/3006/quic-v1 \
--peer /ip4/34.174.22.166/udp/3006/quic-v1 \
--peer /ip4/34.95.155.151/udp/30000/quic-v1 \
--peer /ip4/34.18.98.38/udp/30000/quic-v1 \
--npc-socket .socket/nockchain.sock \
--bind /ip4/0.0.0.0/udp/3006/quic-v1 \
--max-established-incoming 1000 \
--max-established-outgoing 1000 \
--max-established 2000 \
--max-established-per-peer 10"

  if ! command -v screen >/dev/null 2>&1; then
    echo -e "${YELLOW}[!] screenæœªå®‰è£…ï¼Œç›´æ¥åå°å¯åŠ¨...${RESET}"
    nohup bash -c "$start_cmd" > nockchain.log 2>&1 &
    echo -e "${GREEN}[+] èŠ‚ç‚¹å·²åå°å¯åŠ¨ï¼Œæ—¥å¿—æ–‡ä»¶: nockchain.log${RESET}"
  else
    if screen -list | grep -qw "nockchain"; then
      echo "[*] å…³é—­æ—§çš„ screen ä¼šè¯..."
      screen -S nockchain -X quit >/dev/null 2>&1
      sleep 2
    fi

    screen -dmS nockchain bash -c "cd '$NCK_DIR' && $start_cmd"

    sleep 3
    if screen -list | grep -qw "nockchain"; then
      echo -e "${GREEN}[+] èŠ‚ç‚¹å·²å¯åŠ¨ (screen ä¼šè¯å: nockchain)${RESET}"
      echo -e "${GREEN}[+] ä½¿ç”¨å…¬é’¥: $MINING_PUBKEY${RESET}"
      echo -e "${YELLOW}[!] ä½¿ç”¨ 'screen -r nockchain' æŸ¥çœ‹æ—¥å¿—${RESET}"
      echo -e "${BLUE}[i] ç«¯å£ 3006/udp ç”¨äºP2Pé€šä¿¡${RESET}"[2]
    else
      echo -e "${RED}[-] èŠ‚ç‚¹å¯åŠ¨å¤±è´¥${RESET}"
      echo "è¯·æ£€æŸ¥é”™è¯¯æ—¥å¿—"
    fi
  fi
  
  pause_and_return
}

function view_logs() {
  if command -v screen >/dev/null 2>&1 && screen -list | grep -qw "nockchain"; then
    echo -e "${YELLOW}[!] è¿›å…¥æ—¥å¿—æŸ¥çœ‹ (Ctrl+A+D å¯é€€å‡º)...${RESET}"
    screen -r nockchain
  elif [ -f "$NCK_DIR/nockchain.log" ]; then
    echo -e "${YELLOW}[!] æ˜¾ç¤ºæœ€è¿‘æ—¥å¿— (æŒ‰Ctrl+Cé€€å‡º):${RESET}"
    tail -f "$NCK_DIR/nockchain.log"
  else
    echo -e "${RED}[-] èŠ‚ç‚¹æœªè¿è¡Œä¸”æ— æ—¥å¿—æ–‡ä»¶${RESET}"
  fi
  pause_and_return
}

function check_status() {
  echo -e "[*] æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€..."
  
  cd "$NCK_DIR" || return 1
  if [ -f "$ENV_FILE" ]; then
    source "$ENV_FILE" >/dev/null 2>&1
    if [ -n "$MINING_PUBKEY" ]; then
      echo -e "${GREEN}[+] å·²é…ç½®å…¬é’¥: ${MINING_PUBKEY:0:16}...${MINING_PUBKEY: -16}${RESET}"
    else
      echo -e "${YELLOW}[!] æœªè®¾ç½®æŒ–çŸ¿å…¬é’¥${RESET}"
    fi
  fi
  
  running=false
  if command -v screen >/dev/null 2>&1 && screen -list | grep -qw "nockchain"; then
    echo -e "${GREEN}[+] èŠ‚ç‚¹è¿è¡Œä¸­ (screenæ¨¡å¼)${RESET}"
    running=true
  elif pgrep -f "nockchain" >/dev/null 2>&1; then
    echo -e "${GREEN}[+] èŠ‚ç‚¹è¿è¡Œä¸­ (åå°æ¨¡å¼)${RESET}"
    running=true
  else
    echo -e "${RED}[-] èŠ‚ç‚¹æœªè¿è¡Œ${RESET}"
  fi
  
  if [ "$running" = true ]; then
    echo -e "${BLUE}[i] ç¤¾åŒºæé†’: åŒºå—é«˜åº¦åœç•™åœ¨0æ˜¯æ­£å¸¸ç°è±¡${RESET}"[4]
    echo -e "${YELLOW}[*] ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ:${RESET}"
    if command -v htop >/dev/null 2>&1; then
      echo -e "${YELLOW}[*] å¯åŠ¨htopç›‘æ§ (5ç§’åè‡ªåŠ¨è¿”å›):${RESET}"
      timeout 5 htop -d 1 2>/dev/null || true
    elif command -v top >/dev/null 2>&1; then
      echo -e "${YELLOW}[*] CPUå’Œå†…å­˜ä½¿ç”¨æƒ…å†µ:${RESET}"
      top -b -n1 | head -20
    fi
  fi
  
  # æ˜¾ç¤ºé’±åŒ…çŠ¶æ€æ£€æŸ¥å‘½ä»¤[2]
  if [ "$running" = true ] && [ -n "$MINING_PUBKEY" ]; then
    echo -e "${BLUE}[i] æ£€æŸ¥é’±åŒ…çŠ¶æ€å‘½ä»¤:${RESET}"
    echo -e "${BLUE}    nockchain-wallet --nockchain-socket \$HOME/nockchain/.socket/nockchain.sock list-notes-by-pubkey -p $MINING_PUBKEY${RESET}"[2]
  fi
  
  pause_and_return
}

function stop_node() {
  echo -e "[*] åœæ­¢èŠ‚ç‚¹..."
  stopped=false
  
  if command -v screen >/dev/null 2>&1 && screen -list | grep -qw "nockchain"; then
    screen -S nockchain -X quit >/dev/null 2>&1
    sleep 2
    stopped=true
  fi
  
  if pgrep -f "nockchain" >/dev/null 2>&1; then
    pkill -f "nockchain" >/dev/null 2>&1
    sleep 2
    stopped=true
  fi
  
  if [ "$stopped" = true ]; then
    echo -e "${GREEN}[+] èŠ‚ç‚¹å·²åœæ­¢${RESET}"
  else
    echo -e "${YELLOW}[!] èŠ‚ç‚¹æœªè¿è¡Œ${RESET}"
  fi
  pause_and_return
}

function pause_and_return() {
  echo ""
  read -n1 -r -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..." key
  main_menu
}

function main_menu() {
  show_banner
  echo "è¯·é€‰æ‹©æ“ä½œ:"
  echo "  1) ğŸš€ ç¤¾åŒºéªŒè¯å®‰è£… (åŸºäºUbuntu 22.04æˆåŠŸæ¡ˆä¾‹)"
  echo "  2) ğŸ”‘ ç”Ÿæˆé’±åŒ…"
  echo "  3) ğŸ“ è®¾ç½®æŒ–çŸ¿å…¬é’¥ (128ä½16è¿›åˆ¶)"
  echo "  4) ğŸ’¾ å¯¼å‡ºå¯†é’¥"
  echo "  5) ğŸ“‚ å¯¼å…¥å¯†é’¥"
  echo "  6) âš¡ å¯åŠ¨èŠ‚ç‚¹ (ç¤¾åŒºå‘½ä»¤)"
  echo "  7) ğŸ“Š æŸ¥çœ‹æ—¥å¿—"
  echo "  8) ğŸ” æ£€æŸ¥çŠ¶æ€"
  echo "  9) â¹ï¸  åœæ­¢èŠ‚ç‚¹"
  echo "  0) é€€å‡º"
  echo ""
  echo -e "${BLUE}ğŸ’¡ æœ¬ç‰ˆæœ¬åŸºäºç¤¾åŒºæˆåŠŸæ¡ˆä¾‹: 1CPU/18GB RAM + Ubuntu 22.04${RESET}"[2]
  echo -e "${BLUE}ğŸ’¡ è§£å†³äº†å†…å­˜panicå’Œæ„å»ºé¡ºåºé—®é¢˜${RESET}"[4]
  echo ""
  read -p "è¯·è¾“å…¥ç¼–å·: " choice

  case "$choice" in
    1) setup_all ;;
    2) generate_wallet ;;
    3) set_pubkey_env ;;
    4) export_keys ;;
    5) import_keys ;;
    6) start_node_community ;;
    7) view_logs ;;
    8) check_status ;;
    9) stop_node ;;
    0) echo "é€€å‡ºè„šæœ¬."; exit 0 ;;
    *) echo -e "${RED}[-] æ— æ•ˆé€‰é¡¹${RESET}"; pause_and_return ;;
  esac
}

main_menu
