#!/bin/bash
# ==============================================================================
# Nockchain 挖矿助手 (K2 增强融合版 v4.1 - 智能容错)
# ------------------------------------------------------------------------------
# HOW TO RUN THIS SCRIPT (重要运行说明):
# 1. 保存此脚本: 例如，保存为 `nock.sh`
# 2. 授予执行权限: chmod +x nock.sh
# 3. (可选但推荐) 修复格式问题: sudo apt-get install -y dos2unix && dos2unix nock.sh
# 4. 在 screen/tmux 中运行以防掉线:
#    screen -S nck
#    ./nock.sh
# ==============================================================================
# 作者: K2 节点教程分享
# Telegram: https://t.me/+EaCiFDOghoM3Yzll
# Twitter:  https://x.com/BtcK241918
# ==============================================================================

# 脚本健壮性设置
set -euo pipefail

# --- 全局常量和颜色定义 ---
RESET='\033[0m'
BOLD='\033[1m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'

NCK_DIR="$HOME/nockchain"
ENV_FILE="$NCK_DIR/.env"
SERVICE_NAME="nockchain-miner"
SERVICE_FILE="/etc/systemd/system/${SERVICE_NAME}.service"
HOON_KERNEL_PATH="$NCK_DIR/pkg/sys/hoon"

# --- 增强版 Hoon 内核 (Base64 编码) ---
ENHANCED_HOON_KERNEL_BASE64="OjoKOjo6OAEgICAgL3N5cy9ob29uICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOjoKICAPOjoiOjoAPToAPAE9PCAgcmlkZQo9PiAgJTEzOSAAPg==CiAgOjo6OgAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6OgogIA86OiI6OiAPToAPAE8PACAwOiB2ZXJzaW9uIHN0dWIgICAgICAgICAgICAgICAgICAgOjoKICApOjo/Pjw6Ojo7PDs/Ojo+Pjs6OiAgaG9vbi12ZXJzaW9uICA+"

# --- 核心函数 ---

function show_banner() {
  clear
  echo -e "${BOLD}${BLUE}"
  echo "======================================================"
  echo "  Nockchain 挖矿助手 (K2 增强融合版 v4.1)"
  echo "======================================================"
  echo -e "${RESET}"
  echo -e "✨ ${BOLD}${PURPLE}内核增强: 已注入 v139 优化版 Hoon 内核！${RESET}"
  echo -e "🧠 ${BOLD}${GREEN}智能环境感知: 自动检查内存并可创建Swap！${RESET}"
  echo -e "🛡️ ${BOLD}${CYAN}智能容错: 安装失败时将提供明确的错误提示！${RESET}"
  echo "🚀 ${BOLD}使用 Systemd 服务管理，确保稳定运行。${RESET}"
  echo "📌 作者: K2 节点教程分享"
  echo "🔗 Telegram: https://t.me/+EaCiFDOghoM3Yzll"
  echo "🐦 Twitter:  https://x.com/BtcK241918"
  echo "------------------------------------------------------"
  echo ""
}

function check_command() {
    if ! command -v "$1" &>/dev/null; then
        echo -e "${RED}[-] 错误: 命令 '$1' 未找到。请确保已安装。${RESET}" >&2
        return 1
    fi
}

function get_num_cores() {
    nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 4
}

function pause_and_return() {
  echo ""
  read -r -p "按任意键返回主菜单..." -s -n 1
  echo
}

# 智能检查并提示使用 screen/tmux
function preflight_check() {
    if [[ -z "${STY}" && -z "${TMUX}" ]]; then
        echo -e "${BOLD}${YELLOW}*** 警告：您当前不在 screen 或 tmux 会话中！***${RESET}"
        echo -e "为防止SSH掉线导致安装中断，强烈建议您退出脚本，然后按以下步骤操作："
        echo -e "   1. 运行: ${GREEN}screen -S nck${RESET}"
        echo -e "   2. 在新会话中，重新运行本脚本: ${GREEN}./$(basename "$0")${RESET}"
        echo -e "   (如果掉线，重连后运行 ${GREEN}screen -r nck${RESET} 即可恢复)"
        echo ""
        read -r -p "您确定要在没有 screen/tmux 的情况下继续吗？(可能导致安装失败) [y/N]: " confirm
        if [[ ! "$confirm" =~ ^[yY](es)?$ ]]; then
            echo -e "${RED}操作已取消。${RESET}"
            exit 1
        fi
    else
        echo -e "${GREEN}[+] 检测到您正在 screen 或 tmux 会话中，非常棒！安装将继续。${RESET}"
    fi
    sleep 2
}

# 检查并创建 Swap 虚拟内存
function check_and_create_swap() {
    echo -e "${BLUE}[*] 正在检查系统内存和Swap空间...${RESET}"
    local ram_mb=$(free -m | awk '/^Mem:/{print $2}')
    local swap_mb=$(free -m | awk '/^Swap:/{print $2}')
    local total_mem_mb=$((ram_mb + swap_mb))
    local min_mem_mb=3800 # 推荐至少有接近4GB的总内存（RAM+Swap）用于编译

    if [ "$total_mem_mb" -lt "$min_mem_mb" ]; then
        echo -e "${YELLOW}[!] 警告: 系统总内存 (RAM + Swap) 小于 ${min_mem_mb}MB。${RESET}"
        echo -e "编译 Nockchain 需要大量内存，可能会因内存不足而失败。"
        read -r -p "是否需要自动创建 4GB 的 Swap 虚拟内存文件? [Y/n]: " choice
        if [[ -z "$choice" || "$choice" =~ ^[yY]$ ]]; then
            echo -e "${BLUE}[*] 正在创建 4GB Swap 文件... 这可能需要一点时间。${RESET}"
            sudo fallocate -l 4G /swapfile || { echo -e "${RED}创建Swap文件失败。${RESET}"; return 1; }
            sudo chmod 600 /swapfile
            sudo mkswap /swapfile
            sudo swapon /swapfile
            # 确保重启后也生效
            if ! grep -q '/swapfile' /etc/fstab; then
                echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
            fi
            echo -e "${GREEN}[+] 4GB Swap 已成功创建并激活！${RESET}"
            free -h
        else
            echo -e "${YELLOW}[!] 您已选择跳过创建Swap。请注意，编译过程可能失败。${RESET}"
        fi
    else
        echo -e "${GREEN}[+] 系统内存充足，无需创建Swap。${RESET}"
    fi
    sleep 2
}

# --- 菜单功能实现 ---

# 1. 一键安装
function install_all() {
    show_banner
    preflight_check
    check_and_create_swap

    # ==================== MODIFICATION START ====================
    # 使用子 shell 来隔离环境和错误处理。
    # 这样即使安装失败，主脚本也不会因 `set -e` 而退出，
    # 而是可以捕获错误并给用户清晰的提示。
    (
    set -e # 在这个代码块中，任何错误都会导致它立即退出

    echo -e "${BLUE}--- 步骤 1/5: 安装系统依赖 ---${RESET}"
    sudo apt-get update
    sudo apt-get install -y clang llvm-dev libclang-dev pkg-config libssl-dev build-essential cmake git make curl

    echo -e "${BLUE}--- 步骤 2/5: 安装 Rust ---${RESET}"
    if ! command -v cargo &>/dev/null; then
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        # 立即将 cargo 添加到 PATH，以便后续步骤使用
        export PATH="$HOME/.cargo/bin:$PATH"
    else
        echo -e "${YELLOW}[!] Rust 已安装，跳过。${RESET}"
    fi
    # 确保cargo路径在当前会话中生效
    export PATH="$HOME/.cargo/bin:$PATH"

    echo -e "${BLUE}--- 步骤 3/5: 获取或更新 Nockchain 仓库 ---${RESET}"
    if [ -d "$NCK_DIR" ]; then
        echo -e "${BLUE}[*] 目录存在，正在更新...${RESET}"
        cd "$NCK_DIR" && git pull
    else
        echo -e "${BLUE}[*] 正在克隆仓库...${RESET}"
        git clone https://github.com/zorp-corp/nockchain "$NCK_DIR"
        cd "$NCK_DIR"
    fi

    echo -e "${PURPLE}--- 步骤 4/5: 注入 K2 增强版 Hoon 内核 (v139) ---${RESET}"
    if ! check_command base64; then
        echo -e "${RED}[-] 错误: 缺少 'base64' 命令。请安装 coreutils。${RESET}"
        exit 1
    fi

    echo "$ENHANCED_HOON_KERNEL_BASE64" | base64 --decode > "$HOON_KERNEL_PATH"
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}[+] 增强版 Hoon 内核已成功注入。${RESET}"
    else
        echo -e "${RED}[-] 错误: 注入增强版 Hoon 内核失败。${RESET}"
        exit 1
    fi

    echo -e "${BLUE}--- 步骤 5/5: 编译并安装 Nockchain ---${RESET}"
    export RUSTFLAGS="-C target-cpu=native -C opt-level=3"
    export CARGO_PROFILE_RELEASE_LTO="true"
    local num_cores=$(get_num_cores)
    echo -e "[*] 使用 ${num_cores} 个CPU核心进行编译..."
    # 编译失败时，下面的命令会因为 `set -e` 自动退出子 shell
    make -j"$num_cores" install
    )

    # 捕获上面子 shell 的退出码
    local exit_code=$?

    if [ "$exit_code" -ne 0 ]; then
        echo -e "${RED}=======================================================${RESET}"
        echo -e "${BOLD}${RED}[-] 安装或构建过程中发生错误！请向上滚动查看具体日志。${RESET}"
        echo -e "${YELLOW}常见原因包括: 权限不足(sudo)、网络问题、内存不足等。${RESET}"
        echo -e "${RED}=======================================================${RESET}"
    else
        echo -e "${GREEN}===============================================${RESET}"
        echo -e "${BOLD}${GREEN}[+] Nockchain 增强版已成功安装！${RESET}"
        echo -e "${YELLOW}[!] 下一步: 请运行选项 2 设置您的挖矿公钥。${RESET}"
        echo -e "${GREEN}===============================================${RESET}"
    fi
    # ===================== MODIFICATION END =====================
    pause_and_return
}

# 2. 设置公钥
function set_pubkey() {
    echo -e "${BLUE}[*] 设置 MINING_PUBKEY 到 .env 文件...${RESET}"
    if [ ! -d "$NCK_DIR" ]; then echo -e "${RED}项目目录不存在，请先运行安装。${RESET}"; pause_and_return; return; fi

    read -r -p "请输入您的挖矿公钥 (MINING_PUBKEY): " pubkey
    if ! [[ "$pubkey" =~ ^[0-9a-fA-F]{128}$ ]]; then
        echo -e "${RED}[-] 错误: 公钥格式不正确。它应该是128个十六进制字符。${RESET}"
        pause_and_return
        return
    fi

    if [ ! -f "$ENV_FILE" ]; then
        echo -e "${BLUE}[*] .env 文件不存在，将从 .env_example 创建。${RESET}"
        cp "$NCK_DIR/.env_example" "$ENV_FILE"
    fi

    local num_cores=$(get_num_cores)
    # 使用 sed 更新公钥，如果不存在则在文件末尾追加
    if grep -q '^MINING_PUBKEY=' "$ENV_FILE"; then
        sed -i -e "/^MINING_PUBKEY=/c\MINING_PUBKEY=$pubkey" "$ENV_FILE"
    else
        echo "MINING_PUBKEY=$pubkey" >> "$ENV_FILE"
    fi
    # 自动设置线程数，如果不存在的话
    if ! grep -q '^MINER_THREADS=' "$ENV_FILE"; then
        echo "MINER_THREADS=$num_cores" >> "$ENV_FILE"
    fi

    echo -e "${GREEN}[+] 挖矿配置已更新到 $ENV_FILE。${RESET}"
    echo -e "${YELLOW}[!] 如果您已启动挖矿服务，请重启 (选项 3) 以使更改生效。${RESET}"
    pause_and_return
}

# 3. 安装并启动节点 (systemd)
function start_node() {
    echo -e "${BLUE}[*] 安装并启动 Nockchain 挖矿服务...${RESET}"
    if ! check_command systemctl; then
        echo -e "${RED}[-] 错误: 您的系统不支持 systemd。此功能不可用。${RESET}"
        pause_and_return
        return
    fi
    
    if [ ! -f "$ENV_FILE" ] || ! grep -q "MINING_PUBKEY" "$ENV_FILE"; then
        echo -e "${RED}[-] 错误: MINING_PUBKEY 未设置! 请先运行选项 2。${RESET}"
        pause_and_return
        return
    fi
    
    cd "$NCK_DIR"
    
    echo -e "${BLUE}[*] 正在创建 systemd 服务...${RESET}"
    sudo bash -c "cat <<EOF > $SERVICE_FILE
[Unit]
Description=$SERVICE_NAME service
After=network-online.target

[Service]
User=$USER
Group=$(id -gn "$USER")
WorkingDirectory=$NCK_DIR
EnvironmentFile=$ENV_FILE
ExecStart=$HOME/.cargo/bin/nockchain
Restart=on-failure
RestartSec=10
LimitNOFILE=65536
Nice=-5

[Install]
WantedBy=multi-user.target
EOF"

    echo -e "${BLUE}[*] 正在重载并启动服务...${RESET}"
    sudo systemctl daemon-reload
    sudo systemctl enable "$SERVICE_NAME"
    sudo systemctl restart "$SERVICE_NAME" # 使用 restart 确保总是最新的配置

    echo -e "${GREEN}===============================================${RESET}"
    echo -e "${GREEN}[+] Nockchain 挖矿服务已成功启动！${RESET}"
    echo -e "${YELLOW}    使用选项 5 查看实时日志。${RESET}"
    echo -e "${GREEN}===============================================${RESET}"
    pause_and_return
}

# 4. 停止节点 (systemd)
function stop_node() {
    echo -e "${BLUE}[*] 停止 Nockchain 挖矿服务...${RESET}"
    if ! check_command systemctl || [ ! -f "$SERVICE_FILE" ]; then
        echo -e "${YELLOW}[!] Systemd 服务未安装或不可用。${RESET}"
        pause_and_return
        return
    fi
    sudo systemctl stop "$SERVICE_NAME"
    echo -e "${GREEN}[+] 服务已停止。${RESET}"
    pause_and_return
}

# 5. 查看日志 (systemd)
function view_logs() {
    echo -e "${BLUE}[*] 查看实时挖矿日志...${RESET}"
    if ! check_command journalctl || [ ! -f "$SERVICE_FILE" ]; then
        echo -e "${YELLOW}[!] Systemd 服务未安装或不可用。${RESET}"
        pause_and_return
        return
    fi
    echo -e "${YELLOW}[!] 按 Ctrl+C 退出日志查看。${RESET}"
    journalctl -u "$SERVICE_NAME" -f --no-pager
    pause_and_return
}

# ========= 主菜单 =========
function main_menu() {
  show_banner
  echo -e "${BOLD}${GREEN}--- Nockchain 挖矿助手 ---${RESET}"
  echo "请选择操作:"
  echo ""
  echo -e "  ${BOLD}1) 一键安装增强版 Nockchain${RESET} ${YELLOW}(自动环境检查, 智能容错)${RESET}"
  echo -e "  ${BOLD}2) 设置挖矿公钥 (MINING_PUBKEY)${RESET}"
  echo ""
  echo "  ${GREEN}3) 安装并启动/重启挖矿服务 (Systemd)${RESET}"
  echo "  ${RED}4) 停止挖矿服务 (Systemd)${RESET}"
  echo "  ${YELLOW}5) 查看实时挖矿日志 (Systemd)${RESET}"
  echo ""
  echo -e "  ${CYAN}0) 退出脚本${RESET}"
  echo ""
  read -r -p "请输入编号: " choice

  case "$choice" in
    1) install_all ;;
    2) set_pubkey ;;
    3) start_node ;;
    4) stop_node ;;
    5) view_logs ;;
    0) echo "退出脚本."; exit 0 ;;
    *) echo -e "${RED}[-] 无效选项，请重新输入。${RESET}"; pause_and_return ;;
  esac
}

# ========= 脚本入口 =========
while true; do
    main_menu
done

exit 0
