#!/bin/bash
# -*- coding: UTF-8 -*-
# Nockchainå†…å­˜ä¼˜åŒ–å®Œå…¨è§£å†³æ–¹æ¡ˆ v5.0

# é¢œè‰²å®šä¹‰
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
CYAN='\033[1;36m'
MAGENTA='\033[1;35m'
RESET='\033[0m'

# è·¯å¾„é…ç½®
INSTALL_PREFIX="$HOME/.local"
NOCKCHAIN_DIR="$HOME/nockchain"
LOG_FILE="$HOME/nockchain_install.log"
BACKUP_DIR="$HOME/nockchain_backup"
SWAP_FILE="/tmp/nockchain_swap"

# å†…å­˜ä¼˜åŒ–çŽ¯å¢ƒå˜é‡
export PATH="$INSTALL_PREFIX/bin:$HOME/.cargo/bin:$PATH"
export RUST_MIN_STACK=16777216  # 16MBæ ˆç©ºé—´
export RUST_LOG=error           # å‡å°‘æ—¥å¿—å†…å­˜ä½¿ç”¨
export RUST_BACKTRACE=0         # ç¦ç”¨å›žæº¯å‡å°‘å†…å­˜
export RUSTFLAGS="-C debuginfo=0 -C opt-level=1 -C codegen-units=1"
export CARGO_BUILD_JOBS=1       # å¼ºåˆ¶å•çº¿ç¨‹ç¼–è¯‘
export MALLOC_ARENA_MAX=2       # é™åˆ¶å†…å­˜åˆ†é…å™¨

# æ¶ˆæ¯è¾“å‡ºå‡½æ•°
print_message() {
    local color=$1
    local message=$2
    echo -e "${color}${message}${RESET}"
}

log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

check_command() {
    command -v "$1" >/dev/null 2>&1
}

# æ˜¾ç¤ºä¸»èœå•
show_menu() {
    clear
    echo -e "${BLUE}
=======================================
 Nockchain å†…å­˜ä¼˜åŒ–å®Œå…¨è§£å†³æ–¹æ¡ˆ v5.0
=======================================
${RESET}"
    echo -e "${YELLOW}1. å†…å­˜ä¼˜åŒ–å®Œæ•´å®‰è£…ï¼ˆå½»åº•è§£å†³ç¼–è¯‘é—®é¢˜ï¼‰"
    echo "2. é…ç½®æŒ–çŸ¿å…¬é’¥"
    echo "3. å¯åŠ¨ä¼˜åŒ–æŒ–çŸ¿"
    echo "4. æŸ¥çœ‹å®žæ—¶æ—¥å¿—"
    echo "5. æ£€æŸ¥é’±åŒ…ä½™é¢"
    echo "6. ç³»ç»Ÿå†…å­˜ç›‘æŽ§"
    echo "7. å¤‡ä»½é’±åŒ…å¯†é’¥"
    echo "8. å†…å­˜é—®é¢˜è¯Šæ–­ä¿®å¤"
    echo "9. é€€å‡ºè„šæœ¬"
    echo -e "${BLUE}=======================================${RESET}"
}

# æ£€æŸ¥å¹¶åˆ›å»ºswapç©ºé—´
setup_swap_space() {
    print_message "$CYAN" "æ­£åœ¨æ£€æŸ¥å¹¶ä¼˜åŒ–è™šæ‹Ÿå†…å­˜..."
    
    local total_ram=$(free -m | awk '/^Mem:/{print $2}')
    local current_swap=$(free -m | awk '/^Swap:/{print $2}')
    local recommended_swap=$((total_ram * 2))
    
    print_message "$YELLOW" "å†…å­˜çŠ¶æ€ï¼š"
    print_message "$YELLOW" "- ç‰©ç†å†…å­˜: ${total_ram}MB"
    print_message "$YELLOW" "- å½“å‰Swap: ${current_swap}MB"
    print_message "$YELLOW" "- æŽ¨èSwap: ${recommended_swap}MB"
    
    if [ "$current_swap" -lt "$recommended_swap" ]; then
        print_message "$CYAN" "åˆ›å»ºä¸´æ—¶swapæ–‡ä»¶ä»¥ç¡®ä¿ç¼–è¯‘æˆåŠŸ..."
        
        local swap_size=$((recommended_swap - current_swap))
        if [ "$swap_size" -gt 16384 ]; then
            swap_size=16384  # æœ€å¤§16GBä¸´æ—¶swap
        fi
        
        # åˆ›å»ºswapæ–‡ä»¶
        if ! sudo dd if=/dev/zero of="$SWAP_FILE" bs=1M count="$swap_size" 2>/dev/null; then
            print_message "$YELLOW" "æ— æ³•åˆ›å»ºswapæ–‡ä»¶ï¼Œå°†åœ¨ä½Žå†…å­˜æ¨¡å¼ä¸‹ç¼–è¯‘"
            return 1
        fi
        
        sudo chmod 600 "$SWAP_FILE"
        sudo mkswap "$SWAP_FILE" >/dev/null 2>&1
        sudo swapon "$SWAP_FILE" >/dev/null 2>&1
        
        print_message "$GREEN" "ä¸´æ—¶swapç©ºé—´åˆ›å»ºæˆåŠŸ: ${swap_size}MB"
        log_message "åˆ›å»ºä¸´æ—¶swap: ${swap_size}MB"
    fi
}

# æ¸…ç†swapç©ºé—´
cleanup_swap() {
    if [ -f "$SWAP_FILE" ]; then
        print_message "$CYAN" "æ¸…ç†ä¸´æ—¶swapç©ºé—´..."
        sudo swapoff "$SWAP_FILE" 2>/dev/null
        sudo rm -f "$SWAP_FILE" 2>/dev/null
        print_message "$GREEN" "ä¸´æ—¶swapç©ºé—´å·²æ¸…ç†"
    fi
}

# å†…å­˜ä¼˜åŒ–ç³»ç»Ÿé…ç½®
optimize_system_memory() {
    print_message "$CYAN" "æ­£åœ¨ä¼˜åŒ–ç³»ç»Ÿå†…å­˜é…ç½®..."
    
    # è®¾ç½®å†…å­˜è¿‡é‡åˆ†é…ç­–ç•¥
    echo 1 | sudo tee /proc/sys/vm/overcommit_memory >/dev/null 2>&1
    echo 80 | sudo tee /proc/sys/vm/overcommit_ratio >/dev/null 2>&1
    
    # ä¼˜åŒ–swapä½¿ç”¨ç­–ç•¥
    echo 10 | sudo tee /proc/sys/vm/swappiness >/dev/null 2>&1
    
    # å¢žåŠ æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
    ulimit -n 65536 2>/dev/null
    
    # è®¾ç½®è¿›ç¨‹å†…å­˜é™åˆ¶
    ulimit -v unlimited 2>/dev/null
    
    print_message "$GREEN" "ç³»ç»Ÿå†…å­˜é…ç½®ä¼˜åŒ–å®Œæˆ"
}

# å®‰è£…Minicondaï¼ˆå†…å­˜ä¼˜åŒ–ç‰ˆï¼‰
install_miniconda_optimized() {
    print_message "$CYAN" "æ­£åœ¨å®‰è£…å†…å­˜ä¼˜åŒ–ç‰ˆMiniconda..."
    
    if check_command "conda"; then
        print_message "$GREEN" "Minicondaå·²å®‰è£…"
        return 0
    fi
    
    local arch=$(uname -m)
    case $arch in
        x86_64) MINICONDA_URL="https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh" ;;
        aarch64) MINICONDA_URL="https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-aarch64.sh" ;;
        *) print_message "$RED" "ä¸æ”¯æŒçš„æž¶æž„: $arch"; return 1 ;;
    esac
    
    local installer="/tmp/miniconda_installer.sh"
    
    # ä½¿ç”¨å†…å­˜ä¼˜åŒ–çš„ä¸‹è½½æ–¹å¼
    if ! wget -q --show-progress --limit-rate=1m "$MINICONDA_URL" -O "$installer"; then
        print_message "$RED" "Minicondaä¸‹è½½å¤±è´¥"
        return 1
    fi
    
    chmod +x "$installer"
    
    # é™é»˜å®‰è£…ï¼Œå‡å°‘å†…å­˜ä½¿ç”¨
    if ! bash "$installer" -b -p "$HOME/.miniconda3" -s; then
        print_message "$RED" "Minicondaå®‰è£…å¤±è´¥"
        return 1
    fi
    
    source "$HOME/.miniconda3/etc/profile.d/conda.sh"
    conda config --set auto_activate_base false
    conda config --set channel_priority strict
    
    export PATH="$HOME/.miniconda3/bin:$PATH"
    rm -f "$installer"
    
    print_message "$GREEN" "Minicondaå†…å­˜ä¼˜åŒ–ç‰ˆå®‰è£…å®Œæˆ"
}

# å®‰è£…ç¼–è¯‘å·¥å…·ï¼ˆè¶…ä½Žå†…å­˜æ¨¡å¼ï¼‰
install_build_tools_low_memory() {
    print_message "$CYAN" "æ­£åœ¨å®‰è£…ç¼–è¯‘å·¥å…·ï¼ˆè¶…ä½Žå†…å­˜æ¨¡å¼ï¼‰..."
    
    source "$HOME/.miniconda3/etc/profile.d/conda.sh"
    
    # åˆ›å»ºæœ€å°åŒ–ç¼–è¯‘çŽ¯å¢ƒ
    conda create -n nockchain-minimal -y python=3.9 --no-default-packages
    conda activate nockchain-minimal
    
    # é€ä¸ªå®‰è£…å·¥å…·ï¼Œé¿å…å†…å­˜å³°å€¼
    local tools=("gcc_linux-64" "make" "clang" "pkg-config" "openssl")
    
    for tool in "${tools[@]}"; do
        print_message "$YELLOW" "å®‰è£… $tool..."
        conda install -y "$tool" -c conda-forge --no-deps --quiet || {
            print_message "$YELLOW" "è·³è¿‡ $tool"
        }
        sleep 2  # ç»™å†…å­˜å›žæ”¶æ—¶é—´
    done
    
    print_message "$GREEN" "ç¼–è¯‘å·¥å…·å®‰è£…å®Œæˆ"
}

# å†…å­˜ä¼˜åŒ–çš„Rustå®‰è£…
install_rust_low_memory() {
    print_message "$CYAN" "æ­£åœ¨å®‰è£…Rustå·¥å…·é“¾ï¼ˆå†…å­˜ä¼˜åŒ–ï¼‰..."
    
    if check_command "rustc"; then
        print_message "$YELLOW" "Rustå·²å®‰è£…: $(rustc --version)"
        return 0
    fi
    
    # è®¾ç½®å†…å­˜å‹å¥½çš„å®‰è£…é€‰é¡¹
    export RUSTUP_INIT_SKIP_PATH_CHECK=yes
    
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y \
        --default-toolchain stable \
        --profile minimal \
        --no-modify-path
    
    source "$HOME/.cargo/env"
    export PATH="$HOME/.cargo/bin:$PATH"
    
    # é…ç½®Cargoä½¿ç”¨å•çº¿ç¨‹
    mkdir -p "$HOME/.cargo"
    cat > "$HOME/.cargo/config.toml" << 'EOF'
[build]
jobs = 1

[profile.dev]
debug = false
opt-level = 1

[profile.release]
debug = false
lto = false
codegen-units = 1
EOF
    
    print_message "$GREEN" "Rustå†…å­˜ä¼˜åŒ–ç‰ˆå®‰è£…å®Œæˆ"
}

# è¶…ä½Žå†…å­˜ç¼–è¯‘Nockchain
compile_nockchain_low_memory() {
    print_message "$MAGENTA" "å¼€å§‹è¶…ä½Žå†…å­˜æ¨¡å¼ç¼–è¯‘Nockchain..."
    
    cd "$NOCKCHAIN_DIR" || return 1
    
    # è®¾ç½®æœ€ä¸¥æ ¼çš„å†…å­˜æŽ§åˆ¶
    export RUST_MIN_STACK=16777216      # 16MB
    export RUSTFLAGS="-C debuginfo=0 -C opt-level=1 -C codegen-units=1 -C incremental=false"
    export CARGO_BUILD_JOBS=1
    export CARGO_INCREMENTAL=0
    export RUST_LOG=error
    export RUST_BACKTRACE=0
    
    # æ¿€æ´»condaçŽ¯å¢ƒ
    source "$HOME/.miniconda3/etc/profile.d/conda.sh"
    conda activate nockchain-minimal
    
    print_message "$CYAN" "æ­¥éª¤1: æ¸…ç†ä¹‹å‰çš„ç¼–è¯‘ç¼“å­˜..."
    rm -rf target/ || true
    cargo clean || true
    
    print_message "$CYAN" "æ­¥éª¤2: ç¼–è¯‘hooncï¼ˆå•çº¿ç¨‹æ¨¡å¼ï¼‰..."
    
    # åˆ›å»ºå†…å­˜ç›‘æŽ§è„šæœ¬
    cat > memory_monitor.sh << 'EOF'
#!/bin/bash
while true; do
    mem_usage=$(free -m | awk '/^Mem:/{print $3}')
    if [ "$mem_usage" -gt 6144 ]; then  # å¦‚æžœè¶…è¿‡6GB
        echo "$(date): å†…å­˜ä½¿ç”¨è¿‡é«˜: ${mem_usage}MB" >> memory_warning.log
    fi
    sleep 30
done
EOF
    chmod +x memory_monitor.sh
    ./memory_monitor.sh &
    monitor_pid=$!
    
    # åˆ†æ­¥éª¤ç¼–è¯‘ï¼Œæ¯æ­¥ä¹‹é—´æ¸…ç†å†…å­˜
    if ! timeout 3600 make install-hoonc; then
        kill $monitor_pid 2>/dev/null
        print_message "$RED" "hooncç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ..."
        
        # å¤‡ç”¨ç¼–è¯‘æ–¹æ¡ˆï¼šæ‰‹åŠ¨ç¼–è¯‘
        print_message "$CYAN" "ä½¿ç”¨æ‰‹åŠ¨ç¼–è¯‘æ–¹æ¡ˆ..."
        cd crates/hoonc
        
        # é€ä¸ªç¼–è¯‘ä¾èµ–
        cargo build --release --bin hoonc --jobs 1 || {
            print_message "$RED" "æ‰‹åŠ¨ç¼–è¯‘ä¹Ÿå¤±è´¥"
            return 1
        }
        
        # æ‰‹åŠ¨å®‰è£…
        cp target/release/hoonc "$HOME/.cargo/bin/"
        cd ../..
    fi
    
    kill $monitor_pid 2>/dev/null
    
    print_message "$CYAN" "æ­¥éª¤3: ç¼–è¯‘ä¸»é¡¹ç›®..."
    sleep 5  # è®©å†…å­˜ç¨³å®š
    
    if ! timeout 3600 make build; then
        print_message "$RED" "ä¸»é¡¹ç›®ç¼–è¯‘å¤±è´¥"
        return 1
    fi
    
    print_message "$CYAN" "æ­¥éª¤4: å®‰è£…é’±åŒ…..."
    if ! make install-nockchain-wallet; then
        print_message "$YELLOW" "é’±åŒ…å®‰è£…å¤±è´¥ï¼Œä½†å¯ä»¥ç»§ç»­"
    fi
    
    print_message "$CYAN" "æ­¥éª¤5: å®‰è£…ä¸»ç¨‹åº..."
    if ! make install-nockchain; then
        print_message "$YELLOW" "ä¸»ç¨‹åºå®‰è£…å¤±è´¥ï¼Œä½†ç¼–è¯‘å·²å®Œæˆ"
    fi
    
    print_message "$GREEN" "Nockchainç¼–è¯‘å®Œæˆï¼"
}

# ä¸»å®‰è£…å‡½æ•°ï¼ˆå†…å­˜ä¼˜åŒ–ç‰ˆï¼‰
install_nockchain_memory_optimized() {
    print_message "$GREEN" ">>> å¼€å§‹Nockchainå†…å­˜ä¼˜åŒ–å®Œæ•´å®‰è£…..."
    log_message "å¼€å§‹å†…å­˜ä¼˜åŒ–å®‰è£…"
    
    # æ£€æŸ¥ç³»ç»Ÿèµ„æº
    local total_ram=$(free -m | awk '/^Mem:/{print $2}')
    local available_space=$(df -m ~ | awk 'NR==2{print $4}')
    
    print_message "$YELLOW" "ç³»ç»Ÿé…ç½®æ£€æŸ¥ï¼š"
    print_message "$YELLOW" "- ç‰©ç†å†…å­˜: ${total_ram}MB"
    print_message "$YELLOW" "- å¯ç”¨ç©ºé—´: ${available_space}MB"
    
    if [ "$total_ram" -lt 2048 ]; then
        print_message "$RED" "é”™è¯¯ï¼šç³»ç»Ÿå†…å­˜ä¸è¶³2GBï¼Œæ— æ³•å®‰å…¨ç¼–è¯‘"
        return 1
    fi
    
    if [ "$available_space" -lt 10240 ]; then
        print_message "$RED" "é”™è¯¯ï¼šç£ç›˜ç©ºé—´ä¸è¶³10GB"
        return 1
    fi
    
    # æ­¥éª¤1: è®¾ç½®è™šæ‹Ÿå†…å­˜
    print_message "$MAGENTA" "æ­¥éª¤ 1/7: è®¾ç½®è™šæ‹Ÿå†…å­˜..."
    setup_swap_space
    
    # æ­¥éª¤2: ä¼˜åŒ–ç³»ç»Ÿå†…å­˜é…ç½®
    print_message "$MAGENTA" "æ­¥éª¤ 2/7: ä¼˜åŒ–ç³»ç»Ÿå†…å­˜é…ç½®..."
    optimize_system_memory
    
    # æ­¥éª¤3: å®‰è£…Miniconda
    print_message "$MAGENTA" "æ­¥éª¤ 3/7: å®‰è£…çŽ¯å¢ƒç®¡ç†å™¨..."
    if ! install_miniconda_optimized; then
        print_message "$RED" "çŽ¯å¢ƒç®¡ç†å™¨å®‰è£…å¤±è´¥"
        cleanup_swap
        return 1
    fi
    
    # æ­¥éª¤4: å®‰è£…ç¼–è¯‘å·¥å…·
    print_message "$MAGENTA" "æ­¥éª¤ 4/7: å®‰è£…ç¼–è¯‘å·¥å…·..."
    if ! install_build_tools_low_memory; then
        print_message "$RED" "ç¼–è¯‘å·¥å…·å®‰è£…å¤±è´¥"
        cleanup_swap
        return 1
    fi
    
    # æ­¥éª¤5: å®‰è£…Rust
    print_message "$MAGENTA" "æ­¥éª¤ 5/7: å®‰è£…Rustå·¥å…·é“¾..."
    if ! install_rust_low_memory; then
        print_message "$RED" "Rustå®‰è£…å¤±è´¥"
        cleanup_swap
        return 1
    fi
    
    # æ­¥éª¤6: å…‹éš†é¡¹ç›®
    print_message "$MAGENTA" "æ­¥éª¤ 6/7: å…‹éš†Nockchainé¡¹ç›®..."
    if [ -d "$NOCKCHAIN_DIR" ]; then
        print_message "$YELLOW" "å‘çŽ°çŽ°æœ‰å®‰è£…ï¼Œæ­£åœ¨æ›´æ–°..."
        cd "$NOCKCHAIN_DIR"
        git pull origin main || {
            cd "$HOME"
            rm -rf "$NOCKCHAIN_DIR"
            git clone https://github.com/zorp-corp/nockchain.git "$NOCKCHAIN_DIR"
        }
    else
        git clone https://github.com/zorp-corp/nockchain.git "$NOCKCHAIN_DIR" || {
            print_message "$RED" "é¡¹ç›®å…‹éš†å¤±è´¥"
            cleanup_swap
            return 1
        }
    fi
    
    cd "$NOCKCHAIN_DIR"
    
    # é…ç½®çŽ¯å¢ƒæ–‡ä»¶
    if [ -f ".env_example" ]; then
        cp .env_example .env
    else
        cat > .env << 'EOF'
MINING_PUBKEY=0000000000000000000000000000000000000000000000000000000000000000
NETWORK=mainnet
MAX_PEERS=2000
LOG_LEVEL=error
RUST_LOG=error
RUST_MIN_STACK=16777216
EOF
    fi
    
    # æ­¥éª¤7: ç¼–è¯‘é¡¹ç›®
    print_message "$MAGENTA" "æ­¥éª¤ 7/7: ç¼–è¯‘é¡¹ç›®ï¼ˆå¯èƒ½éœ€è¦1-2å°æ—¶ï¼‰..."
    if ! compile_nockchain_low_memory; then
        print_message "$RED" "é¡¹ç›®ç¼–è¯‘å¤±è´¥"
        cleanup_swap
        return 1
    fi
    
    # ç”Ÿæˆé’±åŒ…ï¼ˆå¦‚æžœå¯èƒ½ï¼‰
    if check_command "nockchain-wallet"; then
        print_message "$CYAN" "æ­£åœ¨ç”Ÿæˆé’±åŒ…..."
        local wallet_output
        wallet_output=$(nockchain-wallet keygen 2>&1)
        
        if [ $? -eq 0 ]; then
            print_message "$GREEN" "é’±åŒ…ç”ŸæˆæˆåŠŸï¼"
            echo "$wallet_output"
            
            local pubkey=$(echo "$wallet_output" | grep -E "Public key:|å…¬é’¥:" | awk '{print $NF}')
            if [ -n "$pubkey" ]; then
                sed -i "s/MINING_PUBKEY=.*/MINING_PUBKEY=$pubkey/" .env
                print_message "$GREEN" "å…¬é’¥å·²é…ç½®: $pubkey"
            fi
            
            mkdir -p "$BACKUP_DIR"
            echo "$wallet_output" > "$BACKUP_DIR/wallet_$(date +%Y%m%d_%H%M%S).txt"
        fi
    fi
    
    # åˆ›å»ºå¯åŠ¨è„šæœ¬
    cat > "$HOME/start_nockchain.sh" << 'EOF'
#!/bin/bash
# Nockchainå¯åŠ¨è„šæœ¬ï¼ˆå†…å­˜ä¼˜åŒ–ç‰ˆï¼‰
source "$HOME/.miniconda3/etc/profile.d/conda.sh"
conda activate nockchain-minimal
export RUST_MIN_STACK=16777216
export RUST_LOG=error
export PATH="$HOME/.cargo/bin:$PATH"
cd "$HOME/nockchain"
echo "å¯åŠ¨NockchainæŒ–çŸ¿èŠ‚ç‚¹..."
make run-nockchain
EOF
    chmod +x "$HOME/start_nockchain.sh"
    
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    cleanup_swap
    
    print_message "$GREEN" "ðŸŽ‰ Nockchainå†…å­˜ä¼˜åŒ–å®‰è£…å®Œæˆï¼"
    print_message "$YELLOW" "å®‰è£…è·¯å¾„: $NOCKCHAIN_DIR"
    print_message "$YELLOW" "å¯åŠ¨è„šæœ¬: $HOME/start_nockchain.sh"
    print_message "$CYAN" "æ‰€æœ‰å†…å­˜é—®é¢˜å·²å½»åº•è§£å†³ï¼"
    
    log_message "å†…å­˜ä¼˜åŒ–å®‰è£…å®Œæˆ"
}

# éªŒè¯å…¬é’¥æ ¼å¼
validate_pubkey() {
    local pubkey=$1
    if [[ $pubkey =~ ^[0-9a-fA-F]{128}$ ]] || [[ $pubkey =~ ^[1-9A-HJ-NP-Za-km-z]{40,50}$ ]]; then
        return 0
    else
        print_message "$RED" "é”™è¯¯ï¼šå…¬é’¥æ ¼å¼æ— æ•ˆ"
        return 1
    fi
}

# é…ç½®æŒ–çŸ¿å…¬é’¥
configure_mining_key() {
    print_message "$CYAN" ">>> é…ç½®æŒ–çŸ¿å…¬é’¥"
    
    if [ ! -f "$NOCKCHAIN_DIR/.env" ]; then
        print_message "$RED" "é”™è¯¯ï¼šæœªæ‰¾åˆ°é…ç½®æ–‡ä»¶"
        return 1
    fi
    
    local current_key=$(grep "MINING_PUBKEY" "$NOCKCHAIN_DIR/.env" | cut -d'=' -f2)
    print_message "$YELLOW" "å½“å‰å…¬é’¥: $current_key"
    
    read -p "è¯·è¾“å…¥æ–°çš„æŒ–çŸ¿å…¬é’¥: " new_pubkey
    
    if [ -n "$new_pubkey" ] && validate_pubkey "$new_pubkey"; then
        cd "$NOCKCHAIN_DIR"
        cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
        sed -i "s/MINING_PUBKEY=.*/MINING_PUBKEY=$new_pubkey/" .env
        print_message "$GREEN" "å…¬é’¥æ›´æ–°æˆåŠŸï¼"
    fi
}

# å¯åŠ¨æŒ–çŸ¿ï¼ˆå†…å­˜ä¼˜åŒ–ç‰ˆï¼‰
start_mining_optimized() {
    print_message "$GREEN" ">>> å¯åŠ¨å†…å­˜ä¼˜åŒ–æŒ–çŸ¿èŠ‚ç‚¹..."
    
    if [ ! -f "$NOCKCHAIN_DIR/.env" ]; then
        print_message "$RED" "é”™è¯¯ï¼šæœªæ‰¾åˆ°å®‰è£…"
        return 1
    fi
    
    # æ£€æŸ¥çŽ°æœ‰è¿›ç¨‹
    if screen -list | grep -q "nockchain"; then
        print_message "$YELLOW" "æ£€æµ‹åˆ°æŒ–çŸ¿è¿›ç¨‹æ­£åœ¨è¿è¡Œ"
        read -p "æ˜¯å¦é‡å¯ï¼Ÿ(y/N): " restart
        if [[ "$restart" =~ ^[Yy]$ ]]; then
            screen -S nockchain -X quit
            sleep 3
        else
            return 0
        fi
    fi
    
    cd "$NOCKCHAIN_DIR"
    
    # è®¾ç½®å†…å­˜ä¼˜åŒ–çŽ¯å¢ƒ
    export RUST_MIN_STACK=16777216
    export RUST_LOG=error
    export MALLOC_ARENA_MAX=2
    
    source "$HOME/.miniconda3/etc/profile.d/conda.sh"
    conda activate nockchain-minimal
    
    print_message "$CYAN" "æ­£åœ¨å¯åŠ¨æŒ–çŸ¿èŠ‚ç‚¹..."
    
    # åœ¨screenä¸­å¯åŠ¨
    screen -dmS nockchain bash -c "
        source '$HOME/.miniconda3/etc/profile.d/conda.sh'
        conda activate nockchain-minimal
        cd '$NOCKCHAIN_DIR'
        export RUST_MIN_STACK=16777216
        export RUST_LOG=error
        export MALLOC_ARENA_MAX=2
        source .env
        echo '=== Nockchain å†…å­˜ä¼˜åŒ–æŒ–çŸ¿ ===' > logs/mining.log
        echo 'å¯åŠ¨æ—¶é—´: \$(date)' >> logs/mining.log
        echo 'å†…å­˜æ¨¡å¼: è¶…ä½Žå†…å­˜ä¼˜åŒ–' >> logs/mining.log
        echo '==========================' >> logs/mining.log
        make run-nockchain 2>&1 | tee -a logs/mining.log
    "
    
    sleep 5
    
    if screen -list | grep -q "nockchain"; then
        print_message "$GREEN" "ðŸš€ æŒ–çŸ¿èŠ‚ç‚¹å¯åŠ¨æˆåŠŸï¼"
        print_message "$CYAN" "- æŸ¥çœ‹çŠ¶æ€: screen -r nockchain"
        print_message "$CYAN" "- åœæ­¢æŒ–çŸ¿: screen -S nockchain -X quit"
    else
        print_message "$RED" "å¯åŠ¨å¤±è´¥"
    fi
}

# æŸ¥çœ‹æ—¥å¿—
view_logs() {
    print_message "$GREEN" ">>> æ˜¾ç¤ºæŒ–çŸ¿æ—¥å¿—"
    
    if [ -f "$NOCKCHAIN_DIR/logs/mining.log" ]; then
        tail -f "$NOCKCHAIN_DIR/logs/mining.log"
    else
        if screen -list | grep -q "nockchain"; then
            screen -r nockchain
        else
            print_message "$RED" "æœªæ‰¾åˆ°æ—¥å¿—æ–‡ä»¶æˆ–è¿è¡Œè¿›ç¨‹"
        fi
    fi
}

# æ£€æŸ¥ä½™é¢
check_balance() {
    print_message "$GREEN" ">>> æ£€æŸ¥é’±åŒ…ä½™é¢"
    
    source "$HOME/.miniconda3/etc/profile.d/conda.sh"
    conda activate nockchain-minimal
    
    cd "$NOCKCHAIN_DIR"
    local pubkey=$(grep "MINING_PUBKEY" .env | cut -d'=' -f2)
    
    if [ -z "$pubkey" ] || [ "$pubkey" = "0000000000000000000000000000000000000000000000000000000000000000" ]; then
        print_message "$RED" "æœªé…ç½®æœ‰æ•ˆå…¬é’¥"
        return 1
    fi
    
    print_message "$CYAN" "æŸ¥è¯¢ä½™é¢: $pubkey"
    
    if check_command "nockchain-wallet"; then
        for socket in ./nockchain*.sock; do
            if [ -S "$socket" ]; then
                nockchain-wallet --nockchain-socket "$socket" list-notes-by-pubkey -p "$pubkey" 2>/dev/null && break
            fi
        done
    fi
}

# ç³»ç»Ÿå†…å­˜ç›‘æŽ§
memory_monitor() {
    print_message "$BLUE" "====== ç³»ç»Ÿå†…å­˜ç›‘æŽ§ ======"
    
    # å†…å­˜ä½¿ç”¨æƒ…å†µ
    local mem_info=$(free -h | awk '/^Mem:/{print "ä½¿ç”¨: "$3" / æ€»è®¡: "$2" ("int($3/$2*100)"%)"}')
    print_message "$YELLOW" "å†…å­˜çŠ¶æ€: $mem_info"
    
    # Swapä½¿ç”¨æƒ…å†µ
    local swap_info=$(free -h | awk '/^Swap:/{print "ä½¿ç”¨: "$3" / æ€»è®¡: "$2}')
    print_message "$YELLOW" "SwapçŠ¶æ€: $swap_info"
    
    # ç³»ç»Ÿè´Ÿè½½
    local load_avg=$(uptime | awk -F'load average:' '{print $2}')
    print_message "$YELLOW" "ç³»ç»Ÿè´Ÿè½½: $load_avg"
    
    # æŒ–çŸ¿è¿›ç¨‹çŠ¶æ€
    if screen -list | grep -q "nockchain"; then
        print_message "$GREEN" "æŒ–çŸ¿çŠ¶æ€: âœ… æ­£åœ¨è¿è¡Œ"
        
        # è¿›ç¨‹å†…å­˜ä½¿ç”¨
        local nock_mem=$(ps aux | grep nockchain | grep -v grep | awk '{sum+=$6} END {print sum/1024}')
        if [ -n "$nock_mem" ]; then
            print_message "$CYAN" "æŒ–çŸ¿è¿›ç¨‹å†…å­˜: ${nock_mem}MB"
        fi
    else
        print_message "$RED" "æŒ–çŸ¿çŠ¶æ€: âŒ æœªè¿è¡Œ"
    fi
    
    # ç£ç›˜ç©ºé—´
    local disk_usage=$(df -h ~ | awk 'NR==2{print $4" å¯ç”¨"}')
    print_message "$YELLOW" "ç£ç›˜ç©ºé—´: $disk_usage"
}

# å¤‡ä»½é’±åŒ…
backup_wallet() {
    print_message "$GREEN" ">>> å¤‡ä»½é’±åŒ…å¯†é’¥"
    
    local backup_file="$BACKUP_DIR/complete_backup_$(date +%Y%m%d_%H%M%S).tar.gz"
    mkdir -p "$BACKUP_DIR"
    
    cd "$NOCKCHAIN_DIR"
    
    # åˆ›å»ºå¤‡ä»½
    tar -czf "$backup_file" .env logs/ *.txt 2>/dev/null || true
    
    # å¤‡ä»½é’±åŒ…é…ç½®
    if [ -f ".env" ]; then
        cp .env "$BACKUP_DIR/env_$(date +%Y%m%d_%H%M%S).backup"
    fi
    
    print_message "$GREEN" "å¤‡ä»½å®Œæˆ: $backup_file"
}

# å†…å­˜é—®é¢˜è¯Šæ–­ä¿®å¤
diagnose_memory_issues() {
    print_message "$GREEN" ">>> å†…å­˜é—®é¢˜è¯Šæ–­ä¿®å¤"
    
    print_message "$CYAN" "æ­£åœ¨æ£€æŸ¥å†…å­˜é…ç½®..."
    
    # æ£€æŸ¥swap
    local swap_total=$(free -m | awk '/^Swap:/{print $2}')
    local mem_total=$(free -m | awk '/^Mem:/{print $2}')
    
    print_message "$YELLOW" "è¯Šæ–­ç»“æžœï¼š"
    print_message "$YELLOW" "- ç‰©ç†å†…å­˜: ${mem_total}MB"
    print_message "$YELLOW" "- è™šæ‹Ÿå†…å­˜: ${swap_total}MB"
    
    if [ "$swap_total" -lt "$((mem_total * 2))" ]; then
        print_message "$RED" "é—®é¢˜ï¼šè™šæ‹Ÿå†…å­˜ä¸è¶³"
        read -p "æ˜¯å¦åˆ›å»ºä¸´æ—¶swapç©ºé—´ï¼Ÿ(Y/n): " create_swap
        if [[ ! "$create_swap" =~ ^[Nn]$ ]]; then
            setup_swap_space
        fi
    fi
    
    # æ£€æŸ¥ç¼–è¯‘é…ç½®
    if [ -f "$HOME/.cargo/config.toml" ]; then
        if grep -q "jobs = 1" "$HOME/.cargo/config.toml"; then
            print_message "$GREEN" "âœ… Cargoå·²é…ç½®å•çº¿ç¨‹ç¼–è¯‘"
        else
            print_message "$YELLOW" "âš ï¸  Cargoæœªé…ç½®å•çº¿ç¨‹ç¼–è¯‘"
        fi
    else
        print_message "$RED" "âŒ Cargoé…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
        print_message "$CYAN" "æ­£åœ¨åˆ›å»ºä¼˜åŒ–é…ç½®..."
        mkdir -p "$HOME/.cargo"
        cat > "$HOME/.cargo/config.toml" << 'EOF'
[build]
jobs = 1

[profile.dev]
debug = false
opt-level = 1
EOF
        print_message "$GREEN" "Cargoé…ç½®å·²ä¼˜åŒ–"
    fi
    
    # æ£€æŸ¥çŽ¯å¢ƒå˜é‡
    local issues=()
    
    if [ -z "$RUST_MIN_STACK" ] || [ "$RUST_MIN_STACK" -lt 16777216 ]; then
        issues+=("RUST_MIN_STACKæœªè®¾ç½®æˆ–è¿‡å°")
    fi
    
    if [ "$RUSTFLAGS" != *"debuginfo=0"* ]; then
        issues+=("RUSTFLAGSæœªä¼˜åŒ–")
    fi
    
    if [ ${#issues[@]} -gt 0 ]; then
        print_message "$YELLOW" "å‘çŽ°é…ç½®é—®é¢˜ï¼š"
        for issue in "${issues[@]}"; do
            print_message "$RED" "- $issue"
        done
        
        read -p "æ˜¯å¦è‡ªåŠ¨ä¿®å¤ï¼Ÿ(Y/n): " fix_issues
        if [[ ! "$fix_issues" =~ ^[Nn]$ ]]; then
            # åˆ›å»ºçŽ¯å¢ƒé…ç½®æ–‡ä»¶
            cat >> "$HOME/.bashrc" << 'EOF'

# Nockchainå†…å­˜ä¼˜åŒ–é…ç½®
export RUST_MIN_STACK=16777216
export RUSTFLAGS="-C debuginfo=0 -C opt-level=1"
export CARGO_BUILD_JOBS=1
export RUST_LOG=error
export MALLOC_ARENA_MAX=2
EOF
            print_message "$GREEN" "é…ç½®é—®é¢˜å·²ä¿®å¤"
            print_message "$YELLOW" "è¯·è¿è¡Œ: source ~/.bashrc"
        fi
    else
        print_message "$GREEN" "âœ… æ‰€æœ‰é…ç½®æ£€æŸ¥é€šè¿‡"
    fi
}

# æ¸…ç†é€€å‡ºå‡½æ•°
cleanup_on_exit() {
    cleanup_swap
    print_message "$CYAN" "æ¸…ç†å®Œæˆ"
}

# è®¾ç½®é€€å‡ºæ¸…ç†
trap cleanup_on_exit EXIT

# ä¸»å¾ªçŽ¯
main() {
    if [ "$EUID" -eq 0 ]; then
        print_message "$RED" "è¯·ä¸è¦ä»¥rootç”¨æˆ·è¿è¡Œ"
        exit 1
    fi
    
    mkdir -p "$BACKUP_DIR"
    touch "$LOG_FILE"
    log_message "å†…å­˜ä¼˜åŒ–è„šæœ¬å¯åŠ¨ v5.0"
    
    while true; do
        show_menu
        read -p "è¯·è¾“å…¥é€‰é¡¹ç¼–å·ï¼ˆ1-9ï¼‰: " choice
        
        case $choice in
            1) install_nockchain_memory_optimized ;;
            2) configure_mining_key ;;
            3) start_mining_optimized ;;
            4) view_logs ;;
            5) check_balance ;;
            6) memory_monitor ;;
            7) backup_wallet ;;
            8) diagnose_memory_issues ;;
            9)
                print_message "$GREEN" "æ„Ÿè°¢ä½¿ç”¨Nockchainå†…å­˜ä¼˜åŒ–è§£å†³æ–¹æ¡ˆï¼"
                cleanup_on_exit
                exit 0
                ;;
            *)
                print_message "$RED" "æ— æ•ˆé€‰é¡¹"
                ;;
        esac
        
        echo
        read -p "æŒ‰å›žè½¦é”®ç»§ç»­..." -r
    done
}

# å¯åŠ¨ç¨‹åº
main
