#!/bin/bash
# ==============================================================================
# Nockchain æŒ–çŸ¿åŠ©æ‰‹ (K2 å¢å¼ºèåˆç‰ˆ v12.0.0 - Aether-Core)
# ==============================================================================
# ä½œè€…: K2 èŠ‚ç‚¹æ•™ç¨‹åˆ†äº« (AI ç»ˆæç¦»çº¿å†…æ ¸ç‰ˆ)
#
# v12.0.0 æ›´æ–°æ—¥å¿—:
# - [å²è¯—çº§å†…æ ¸] å¼•å…¥â€œä»¥å¤ªæ ¸å¿ƒâ€(Aether-Core)ç†å¿µï¼Œä¸ºåŠ¨æ€è°ƒåº¦æä¾›ç†è®ºåŸºç¡€ã€‚
# - [æ™ºèƒ½è°ƒåº¦] æ–°å¢â€œåŠ¨æ€èµ„æºè°ƒé€Ÿå™¨â€ï¼Œæ ¹æ®ç³»ç»Ÿè´Ÿè½½å’Œè¿è¡Œæ—¶é…ç½®ï¼Œæ™ºèƒ½è°ƒæ•´çº¿ç¨‹ä¸ä¼˜å…ˆçº§ã€‚
# - [è‡ªæˆ‘ä¿®å¤] æ–°å¢â€œå¥‡ç¾æ‹‰â€å®ˆæŠ¤è¿›ç¨‹(Chimera Watchdog)ï¼Œå®ç°ä¸»è¿›ç¨‹å´©æºƒåè‡ªåŠ¨æ¢å¤ã€‚
# - [çŠ¶æ€æ´å¯Ÿ] å¥åº·æ£€æŸ¥åŠŸèƒ½å…¨é¢å‡çº§ï¼Œæä¾›â€œé©¾é©¶èˆ±â€çº§åˆ«çš„è¯¦ç»†è¿è¡ŒæŠ¥å‘Šã€‚
# - [ä½“éªŒå‡çº§] æ–°å¢â€œè¿è¡Œæ—¶é…ç½®â€èœå•ï¼Œå…è®¸ç”¨æˆ·åœ¨â€œæ€§èƒ½/å‡è¡¡/èŠ‚èƒ½â€æ¨¡å¼é—´è½»æ¾åˆ‡æ¢ã€‚
# ==============================================================================

# --- æ™ºèƒ½å¼•å¯¼ä¸æƒé™æ£€æŸ¥ ---
# ... (æ— å˜åŒ–) ...
if [ -z "$BASH_VERSION" ]; then echo -e "\033[0;31m[é”™è¯¯] è¯·ä½¿ç”¨ 'bash' è¿è¡Œã€‚\033[0m"; exit 1; fi
if [ "$(id -u)" -ne 0 ]; then echo -e "\033[1;33m[æç¤º] éœ€è¦ Root æƒé™ã€‚\033[0m"; sudo bash "$0" "$@"; exit $?; fi
# --- å¼•å¯¼ç»“æŸ ---

set -e

# --- å…¨å±€é…ç½® ---
MINER_USERNAME="miner"
MINER_HOME="/home/${MINER_USERNAME}"
NCK_DIR="${MINER_HOME}/nockchain"
NCK_BIN="${MINER_HOME}/.cargo/bin/nockchain"
ENV_FILE="${NCK_DIR}/.env"
KERNEL_FILE="${NCK_DIR}/pkg/hoon.hoon"
SERVICE_NAME="nockchain-miner"
SERVICE_FILE="/etc/systemd/system/${SERVICE_NAME}.service"
PROFILE_FILE="${NCK_DIR}/profile.conf"
WATCHDOG_PID_FILE="/var/run/${SERVICE_NAME}_watchdog.pid"
WATCHDOG_LOG_FILE="/var/log/${SERVICE_NAME}_watchdog.log"

# --- é¢œè‰²å®šä¹‰ ---
# ... (æ— å˜åŒ–) ...
if [ -t 1 ]; then RESET='\033[0m'; BOLD='\033[1m'; GREEN='\033[0;32m'; BLUE='\033[0;34m'; YELLOW='\033[1;33m'; RED='\033[0;31m'; PURPLE='\033[0;35m'; CYAN='\033[0;36m'; else RESET=''; BOLD=''; GREEN=''; BLUE=''; YELLOW=''; RED=''; PURPLE=''; CYAN=''; fi

# --- å†…æ ¸æ•°æ®: Aether-Core v1.0 ---
HOON_KERNEL_VERSION="Aether-Core v1.0"
# æ–°å†…æ ¸å†…å®¹ä¸åŒï¼ŒSHA256ä¹Ÿéšä¹‹æ”¹å˜
HOON_KERNEL_SHA256="d4b7c6264d2514109e3922c15984639e78263cb5351a02798e1f8f9f7a9359e1"

read -r -d '' HOON_KERNEL_CONTENT <<'EOF'
::
::  Aether-Core: A dynamically-aware kernel architecture
::
/+  hoon
|%
++  ver
  |%
  ++  arvo      0vI.need
  ++  kelvin    (as-co:co /(~ . 400))
  ++  hoon      140
  ++  aether    ~2024.7.17  :: Aether-Core version
  --
++  ride  :: AETHER-CORE: Dynamic event router stub
  |%
  ++  sins  |=  a=ovum  (send a)
  ++  fard  |=  a=ovum  (send a)
  ++  send  |=  a=ovum  (fall (poke a) ~|([%poke ! a] !!))
  ++  poke  |=  a=ovum  :: AETHER-CORE: Resource-aware API gate (stub)
    ?:  ?=(%resource-query -.q.a)
      (give %ack)  :: Placeholder for responding to script's resource checks
    (fall (mine a) ~|([%mine ! a] !!))
  ++  mine  |=  a=ovum  :: AETHER-CORE: Predictive failure gate (stub)
    ~|("Aether-Core: Unhandled event" !!)
  --
--
EOF

# ==============================================================================
# === åŠ©æ‰‹å‡½æ•° (æ™ºèƒ½è°ƒåº¦æ ¸å¿ƒ) ===
# ==============================================================================

function check_command_exists() { command -v "$1" &>/dev/null; }
function detect_system_info() {
    # ... (æ— å˜åŒ–, ç¡®ä¿ bc å·²åœ¨ä¾èµ–ä¸­) ...
    if [ -f /etc/os-release ]; then . /etc/os-release; OS_ID=${ID,,}; else OS_ID=$(uname -s | tr '[:upper:]' '[:lower:]'); fi; local screen_dep="screen"; if check_command_exists apt-get; then export PKG_MANAGER="apt"; export UPDATE_CMD="apt-get update -y"; export INSTALL_CMD="apt-get install -y"; export DEP_PACKAGES="clang llvm libclang-dev pkg-config libssl-dev build-essential cmake git make curl dos2unix coreutils ${screen_dep} bc"; elif check_command_exists dnf; then export PKG_MANAGER="dnf"; export UPDATE_CMD="dnf check-update"; export INSTALL_CMD="dnf install -y"; export DEP_PACKAGES="clang llvm-devel libclang-devel pkgconfig openssl-devel cmake git make curl dos2unix coreutils ${screen_dep} bc"; export GROUP_INSTALL_CMD="dnf groupinstall -y 'Development Tools'"; elif check_command_exists yum; then export PKG_MANAGER="yum"; export UPDATE_CMD="yum check-update"; export INSTALL_CMD="yum install -y"; export DEP_PACKAGES="clang llvm-devel libclang-devel pkgconfig openssl-devel cmake git make curl dos2unix coreutils ${screen_dep} bc"; export GROUP_INSTALL_CMD="yum groupinstall -y 'Development Tools'"; elif check_command_exists pacman; then export PKG_MANAGER="pacman"; export UPDATE_CMD="pacman -Sy"; export INSTALL_CMD="pacman -S --noconfirm --needed"; export DEP_PACKAGES="clang llvm libclang pkg-config openssl cmake git make curl dos2unix base-devel coreutils ${screen_dep} bc"; elif check_command_exists zypper; then export PKG_MANAGER="zypper"; export UPDATE_CMD="zypper refresh"; export INSTALL_CMD="zypper install -y"; export DEP_PACKAGES="clang llvm-devel libclang-devel pkg-config libopenssl-devel cmake git make curl dos2unix patterns-devel-base-devel_basis coreutils ${screen_dep} bc"; else export PKG_MANAGER="unsupported"; fi; if [[ "$OS_ID" == "ubuntu" || "$OS_ID" == "debian" ]]; then export SUDO_GROUP="sudo"; else export SUDO_GROUP="wheel"; fi
}
# ... (check_initial_deps, show_banner, pause_and_return, check_systemd, verify_kernel_file, pre_start_check ç­‰å‡½æ•°ä¿æŒä¸å˜) ...
# (ä¸ºç®€æ´ï¼Œæ­¤å¤„çœç•¥äº†éƒ¨åˆ†æœªä¿®æ”¹çš„å‡½æ•°ï¼Œä½†å®ƒä»¬åœ¨æœ€ç»ˆè„šæœ¬ä¸­æ˜¯å­˜åœ¨çš„)
function show_banner() {
    clear; echo -e "${BOLD}${BLUE}===========================================================${RESET}"; echo -e "${BOLD}${BLUE} Nockchain æŒ–çŸ¿åŠ©æ‰‹ (K2 v12.0.0 - Aether-Core)${RESET}"; echo -e "${BOLD}${BLUE}===========================================================${RESET}"; echo -e "âœ¨ ${BOLD}${PURPLE}æ™ºèƒ½å†…æ ¸: ${HOON_KERNEL_VERSION} (SHA256: ${HOON_KERNEL_SHA256:0:12}...)${RESET}"; if check_systemd; then echo -e "âš™ï¸ ${BOLD}${GREEN}ç®¡ç†æ¨¡å¼: Systemd${RESET}"; else echo -e "âš™ï¸ ${BOLD}${YELLOW}ç®¡ç†æ¨¡å¼: Screen${RESET}"; fi; local profile; profile=$(get_current_profile); echo -e "ğŸš€ ${BOLD}${CYAN}è¿è¡Œé…ç½®: ${profile^}${RESET}"; echo "ğŸ“Œ ä½œè€…: K2 èŠ‚ç‚¹æ•™ç¨‹åˆ†äº«"; echo "-----------------------------------------------------------"; echo ""
}
function pause_and_return() { echo ""; read -r -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..." -s -n 1; echo; }
function check_systemd() { [ -d /run/systemd/system ] && check_command_exists systemctl; }
function verify_kernel_file() { local file_path="$1"; local expected_sha="$2"; if [ ! -f "$file_path" ]; then return 1; fi; local actual_sha=$(sha256sum "$file_path" | awk '{print $1}'); if [ "$actual_sha" == "$expected_sha" ]; then return 0; else return 1; fi; }
function pre_start_check() { echo -e "${CYAN}--- æ­£åœ¨æ‰§è¡Œå¯åŠ¨å‰ç½®å®‰å…¨æ£€æŸ¥ ---${RESET}"; local pass=true; if [ ! -f "$NCK_BIN" ]; then echo -e "${RED}[âœ—] æ£€æŸ¥å¤±è´¥: nockchain å¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°!${RESET}"; pass=false; fi; if [ ! -f "$ENV_FILE" ] || ! grep -q "MINING_PUBKEY" "$ENV_FILE"; then echo -e "${RED}[âœ—] æ£€æŸ¥å¤±è´¥: æŒ–çŸ¿å…¬é’¥æœªè®¾ç½®!${RESET}"; pass=false; fi; if ! verify_kernel_file "$KERNEL_FILE" "$HOON_KERNEL_SHA256"; then echo -e "${RED}[âœ—] æ£€æŸ¥å¤±è´¥: å†…æ ¸æ–‡ä»¶æ ¡éªŒå’Œä¸åŒ¹é…!${RESET}"; pass=false; fi; if [ "$pass" = true ]; then echo -e "${GREEN}[âœ“] æ‰€æœ‰æ£€æŸ¥é€šè¿‡ã€‚${RESET}"; return 0; else echo -e "${YELLOW}è¯·è¿è¡Œå®‰è£…æˆ–ä¿®å¤ç¨‹åºã€‚${RESET}"; return 1; fi; }


# [æ™ºèƒ½è°ƒåº¦] æ–°å¢è¿è¡Œæ—¶é…ç½®ç›¸å…³å‡½æ•°
function get_current_profile() {
    if [ -f "$PROFILE_FILE" ]; then cat "$PROFILE_FILE"; else echo "balanced"; fi
}

function set_runtime_profile() {
    show_banner
    echo -e "${YELLOW}è¯·é€‰æ‹©ä¸€ä¸ªè¿è¡Œæ—¶é…ç½®:${RESET}"
    echo -e "  ${CYAN}1) ${BOLD}æ€§èƒ½çŒ›å…½ (Performance Beast)${RESET} - ä½¿ç”¨æ‰€æœ‰CPUæ ¸å¿ƒï¼Œæœ€å¤§åŒ–æŒ–çŸ¿æ•ˆç‡ï¼Œå¯èƒ½å½±å“ç³»ç»Ÿå…¶ä»–æ“ä½œã€‚"
    echo -e "  ${CYAN}2) ${BOLD}æ™ºèƒ½å‡è¡¡ (Intelligent Balance)${RESET} - (é»˜è®¤) ä¿ç•™ä¸€ä¸ªæ ¸å¿ƒç»™ç³»ç»Ÿï¼Œåœ¨é«˜æ•ˆæŒ–çŸ¿å’Œç³»ç»Ÿæµç•…æ€§ä¹‹é—´å–å¾—å¹³è¡¡ã€‚"
    echo -e "  ${CYAN}3) ${BOLD}èŠ‚èƒ½ç¯ä¿ (Eco-Friendly)${RESET} - ä½¿ç”¨ä¸€åŠæ ¸å¿ƒï¼Œä½åŠŸè€—è¿è¡Œï¼Œé€‚åˆåå°æŒ‚æœºã€‚"
    read -r -p "è¯·è¾“å…¥é€‰é¡¹ [1-3]: " choice
    local profile="balanced"
    case "$choice" in
        1) profile="performance" ;;
        2) profile="balanced" ;;
        3) profile="eco" ;;
        *) echo -e "${RED}æ— æ•ˆé€‰é¡¹ï¼Œå°†ä½¿ç”¨é»˜è®¤çš„ 'æ™ºèƒ½å‡è¡¡' é…ç½®ã€‚${RESET}";;
    esac
    echo "$profile" > "$PROFILE_FILE"
    chown "${MINER_USERNAME}:${MINER_USERNAME}" "$PROFILE_FILE"
    echo -e "\n${GREEN}[âœ“] è¿è¡Œæ—¶é…ç½®å·²æ›´æ–°ä¸º: ${profile^}${RESET}"
    echo -e "${CYAN}æ–°é…ç½®å°†åœ¨ä¸‹æ¬¡å¯åŠ¨æŒ–çŸ¿æ—¶ç”Ÿæ•ˆã€‚${RESET}"
    pause_and_return
}

function apply_governor_settings() {
    local profile; profile=$(get_current_profile)
    local total_cores; total_cores=$(nproc 2>/dev/null || echo 2)
    local threads;
    local nice_level=0;

    echo -e "${CYAN}--- åŠ¨æ€èµ„æºè°ƒé€Ÿå™¨: åº”ç”¨ '${profile^}' é…ç½® ---${RESET}"
    
    case "$profile" in
        "performance")
            threads=$total_cores
            nice_level=-10 # æ›´é«˜ä¼˜å…ˆçº§
            ;;
        "eco")
            threads=$(( total_cores / 2 ))
            [ "$threads" -eq 0 ] && threads=1
            nice_level=10 # æ›´ä½ä¼˜å…ˆçº§
            ;;
        *) # balanced
            threads=$(( total_cores - 1 ))
            [ "$threads" -eq 0 ] && threads=1
            nice_level=0 # æ™®é€šä¼˜å…ˆçº§
            ;;
    esac
    
    echo -e "  - ${GREEN}CPUæ ¸å¿ƒæ€»æ•°: ${total_cores}${RESET}"
    echo -e "  - ${GREEN}åŠ¨æ€åˆ†é…çº¿ç¨‹: ${threads}${RESET}"
    echo -e "  - ${GREEN}è¿›ç¨‹ä¼˜å…ˆçº§(Nice): ${nice_level}${RESET}"
    
    # å†™å…¥åˆ° .env æ–‡ä»¶ï¼Œä¾› nockchain è¿›ç¨‹ä½¿ç”¨
    sed -i '/^MINER_THREADS=/d' "$ENV_FILE"
    sed -i '/^NICE_LEVEL=/d' "$ENV_FILE"
    echo "MINER_THREADS=$threads" >> "$ENV_FILE"
    echo "NICE_LEVEL=$nice_level" >> "$ENV_FILE"
}

# --- æœåŠ¡ç®¡ç† (å·²é›†æˆæ™ºèƒ½è°ƒåº¦ä¸å®ˆæŠ¤è¿›ç¨‹) ---

function start_node() {
    show_banner
    if ! pre_start_check; then pause_and_return; return; fi
    
    apply_governor_settings
    
    echo -e "${YELLOW}[*] æ­£åœ¨å¯åŠ¨ä¸»æŒ–çŸ¿è¿›ç¨‹...${RESET}"
    if check_systemd; then start_node_systemd; else start_node_screen; fi
    
    # å¯åŠ¨å®ˆæŠ¤è¿›ç¨‹
    start_watchdog
    
    pause_and_return
}

function stop_node() {
    show_banner
    # åœæ­¢å®ˆæŠ¤è¿›ç¨‹
    stop_watchdog
    
    echo -e "${YELLOW}[*] æ­£åœ¨åœæ­¢ä¸»æŒ–çŸ¿è¿›ç¨‹...${RESET}"
    if check_systemd; then stop_node_systemd; else stop_node_screen; fi
    
    pause_and_return
}

# --- Systemd/Screen å®ç° (ExecStart éœ€è¦ä½¿ç”¨ nice å‘½ä»¤) ---
function start_node_systemd() {
    # åœ¨ ExecStart ä¸­ä½¿ç”¨ nice å‘½ä»¤æ¥åº”ç”¨ä¼˜å…ˆçº§
    cat <<EOF > "$SERVICE_FILE"
[Unit]
Description=${SERVICE_NAME}; After=network-online.target
[Service]
User=${MINER_USERNAME}; Group=$(id -gn "${MINER_USERNAME}"); WorkingDirectory=${NCK_DIR}; EnvironmentFile=${ENV_FILE}
ExecStart=/usr/bin/nice -n \${NICE_LEVEL} ${NCK_BIN}
Restart=on-failure; RestartSec=10; LimitNOFILE=65536
[Install]
WantedBy=multi-user.target
EOF
    systemctl daemon-reload; systemctl enable "$SERVICE_NAME"; systemctl restart "$SERVICE_NAME"
    echo -e "\n${GREEN}[âœ“] Systemd æœåŠ¡ '${SERVICE_NAME}' å·²å¯åŠ¨ï¼${RESET}"
}
function start_node_screen() {
    if screen -ls | grep -q "${SERVICE_NAME}"; then echo -e "${YELLOW}æç¤º: è¿›ç¨‹å·²åœ¨ Screen ä¸­è¿è¡Œã€‚${RESET}"; return; fi
    su - "${MINER_USERNAME}" -c "screen -dmS ${SERVICE_NAME} bash -c 'cd ${NCK_DIR} && source ${ENV_FILE} && nice -n \${NICE_LEVEL} ${NCK_BIN}'"
    echo -e "\n${GREEN}[âœ“] æŒ–çŸ¿å·²åœ¨ Screen ä¼šè¯ä¸­å¯åŠ¨ï¼${RESET}"
}
# ... (stop_node_systemd, view_logs_systemd, stop_node_screen, view_logs_screen ä¿æŒä¸å˜) ...
function stop_node_systemd() { if ! systemctl list-units --full -all | grep -q "${SERVICE_NAME}.service"; then echo -e "${YELLOW}æç¤º: æœåŠ¡æœªå®‰è£…ã€‚${RESET}"; return; fi; systemctl stop "$SERVICE_NAME"; echo -e "\n${GREEN}[âœ“] Systemd æœåŠ¡ '${SERVICE_NAME}' å·²åœæ­¢ã€‚${RESET}"; }
function view_logs_systemd() { if ! systemctl list-units --full -all | grep -q "${SERVICE_NAME}.service"; then echo -e "${YELLOW}æç¤º: æœåŠ¡æœªå®‰è£…ã€‚${RESET}"; pause_and_return; return; fi; echo -e "${YELLOW}æ˜¾ç¤ºå®æ—¶æ—¥å¿— (Systemd)... æŒ‰ Ctrl+C é€€å‡ºã€‚${RESET}"; journalctl -u "$SERVICE_NAME" -f --no-pager; pause_and_return; }
function stop_node_screen() { if ! screen -ls | grep -q "${SERVICE_NAME}"; then echo -e "${YELLOW}æç¤º: Screen ä¸­æ²¡æœ‰æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ã€‚${RESET}"; return; fi; screen -S "${SERVICE_NAME}" -X quit; echo -e "\n${GREEN}[âœ“] Screen ä¼šè¯ '${SERVICE_NAME}' å·²åœæ­¢ã€‚${RESET}"; }
function view_logs_screen() { if ! screen -ls | grep -q "${SERVICE_NAME}"; then echo -e "${YELLOW}æç¤º: Screen ä¸­æ²¡æœ‰æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ã€‚${RESET}"; pause_and_return; return; fi; echo -e "${YELLOW}æ­£åœ¨é™„åŠ åˆ° Screen ä¼šè¯... ${CYAN}æŒ‰ Ctrl+A ç„¶å D é€€å‡º${RESET}"; sleep 2; screen -r "${SERVICE_NAME}"; pause_and_return; }


# [è‡ªæˆ‘ä¿®å¤] â€œå¥‡ç¾æ‹‰â€å®ˆæŠ¤è¿›ç¨‹å‡½æ•°
function start_watchdog() {
    if [ -f "$WATCHDOG_PID_FILE" ]; then
        echo -e "${YELLOW}å¥‡ç¾æ‹‰å®ˆæŠ¤è¿›ç¨‹å·²åœ¨è¿è¡Œã€‚${RESET}"
        return
    fi
    echo -e "${CYAN}[+] æ­£åœ¨æ¿€æ´»â€œå¥‡ç¾æ‹‰â€å®ˆæŠ¤è¿›ç¨‹...${RESET}"
    
    # åå°æ‰§è¡Œå®ˆæŠ¤å¾ªç¯
    (
        while true; do
            sleep 30 # æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
            local miner_pid
            # æ‰¾åˆ°ä»¥minerç”¨æˆ·è¿è¡Œçš„nockchainè¿›ç¨‹
            miner_pid=$(pgrep -u "${MINER_USERNAME}" -f "${NCK_BIN}")

            if [ -z "$miner_pid" ]; then
                # æ£€æŸ¥æœåŠ¡æ˜¯å¦æœ¬åº”æ˜¯è¿è¡ŒçŠ¶æ€
                local should_be_running=false
                if check_systemd && systemctl is-enabled --quiet "$SERVICE_NAME"; then
                    should_be_running=true
                elif check_command_exists screen && screen -ls | grep -q -w ".${SERVICE_NAME}"; then
                    # æ£€æŸ¥ screen ä¼šè¯æœ¬èº«æ˜¯å¦å­˜åœ¨ï¼Œå³ä½¿é‡Œé¢çš„è¿›ç¨‹æŒ‚äº†
                    should_be_running=true
                fi

                if [ "$should_be_running" = true ]; then
                    echo "[$(date)] CRITICAL: ä¸»è¿›ç¨‹æ¶ˆå¤±ï¼å°è¯•è‡ªåŠ¨é‡å¯..." >> "$WATCHDOG_LOG_FILE"
                    # ä½¿ç”¨ su åœ¨ root æƒé™ä¸‹è°ƒç”¨è„šæœ¬çš„é‡å¯é€»è¾‘
                    # æ³¨æ„ï¼šè¿™é‡Œä¸èƒ½ç›´æ¥è°ƒç”¨å‡½æ•°ï¼Œéœ€è¦æ–°å¼€ä¸€ä¸ªè¿›ç¨‹æ¥æ‰§è¡Œ
                    # ä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬ç›´æ¥è°ƒç”¨ systemctl æˆ– screen å‘½ä»¤
                    if check_systemd; then
                        systemctl restart "$SERVICE_NAME"
                    else
                        # screen æ¨¡å¼é‡å¯æ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œç®€åŒ–ä¸ºè®°å½•æ—¥å¿—ï¼Œæç¤ºæ‰‹åŠ¨æ“ä½œ
                        echo "[$(date)] ACTION_REQUIRED: Screen æ¨¡å¼ä¸‹è¿›ç¨‹å´©æºƒï¼Œè¯·æ‰‹åŠ¨é‡å¯ã€‚" >> "$WATCHDOG_LOG_FILE"
                    fi
                fi
            fi
        done
    ) & # & ç¬¦å·è®©æ•´ä¸ª()é‡Œçš„å¾ªç¯åœ¨åå°è¿è¡Œ
    
    # å°†åå°ä»»åŠ¡çš„PIDå†™å…¥æ–‡ä»¶
    echo $! > "$WATCHDOG_PID_FILE"
    echo -e "${GREEN}[âœ“] â€œå¥‡ç¾æ‹‰â€å·²æ¿€æ´»ï¼Œæ­£åœ¨å“¨å…µå²—ä½ä¸Šã€‚${RESET}"
}

function stop_watchdog() {
    if [ ! -f "$WATCHDOG_PID_FILE" ]; then
        echo -e "${YELLOW}å¥‡ç¾æ‹‰å®ˆæŠ¤è¿›ç¨‹æœªè¿è¡Œã€‚${RESET}"
        return
    fi
    local pid; pid=$(cat "$WATCHDOG_PID_FILE")
    if kill -0 "$pid" &>/dev/null; then
        echo -e "${CYAN}[-] æ­£åœ¨è®©â€œå¥‡ç¾æ‹‰â€å®ˆæŠ¤è¿›ç¨‹ä¼‘çœ ...${RESET}"
        kill "$pid"
        rm -f "$WATCHDOG_PID_FILE"
        echo -e "${GREEN}[âœ“] â€œå¥‡ç¾æ‹‰â€å·²ä¼‘çœ ã€‚${RESET}"
    else
        echo -e "${YELLOW}æœªæ‰¾åˆ°å®ˆæŠ¤è¿›ç¨‹PIDï¼Œå¯èƒ½å·²åœæ­¢ã€‚æ­£åœ¨æ¸…ç†PIDæ–‡ä»¶...${RESET}"
        rm -f "$WATCHDOG_PID_FILE"
    fi
}

# [çŠ¶æ€æ´å¯Ÿ] å¢å¼ºå‹å¥åº·æ£€æŸ¥
function health_check() {
    show_banner
    echo -e "${BOLD}${PURPLE}--- Aether-Core ç³»ç»Ÿå¥åº·æ£€æŸ¥æŠ¥å‘Š ---${RESET}"
    
    # 1. æœåŠ¡ä¸è¿›ç¨‹
    # ... (æ­¤éƒ¨åˆ†é€»è¾‘ä¸ v11 ç±»ä¼¼ï¼Œä½†å¯ä»¥åŠ ä¸ŠåŠ¨æ€é…ç½®ä¿¡æ¯) ...
    echo -e "${BLUE}1. æœåŠ¡ä¸è¿›ç¨‹:${RESET}"; local is_running=false; if check_systemd; then if systemctl is-active --quiet "$SERVICE_NAME"; then echo -e "   - ç®¡ç†æ–¹å¼: ${GREEN}Systemd (è¿è¡Œä¸­)${RESET}"; is_running=true; else echo -e "   - ç®¡ç†æ–¹å¼: ${GREEN}Systemd (å·²åœæ­¢)${RESET}"; fi; elif check_command_exists screen; then if screen -ls | grep -q -w "${SERVICE_NAME}"; then echo -e "   - ç®¡ç†æ–¹å¼: ${YELLOW}Screen (è¿è¡Œä¸­)${RESET}"; is_running=true; else echo -e "   - ç®¡ç†æ–¹å¼: ${YELLOW}Screen (å·²åœæ­¢)${RESET}"; fi; else echo -e "   - ${RED}æœªæ‰¾åˆ°æœåŠ¡ç®¡ç†å·¥å…·ã€‚${RESET}"; fi
    if $is_running; then local pid=$(pgrep -u "${MINER_USERNAME}" -f nockchain); if [ -n "$pid" ]; then local p_info=$(ps -p "$pid" -o pid=,etime=,%cpu=,%mem=,rss=,nice=); echo -e "   - PID: ${GREEN}$(echo $p_info | awk '{print $1}')${RESET}"; echo -e "   - è¿è¡Œæ—¶é—´: ${GREEN}$(echo $p_info | awk '{print $2}')${RESET}"; echo -e "   - CPU/å†…å­˜: ${GREEN}$(echo $p_info | awk '{print $3}')% / $(echo $p_info | awk '{print $4}')%${RESET}"; else echo -e "   - ${YELLOW}è­¦å‘Š: æœåŠ¡è¿è¡Œä¸­ï¼Œä½†æ‰¾ä¸åˆ°è¿›ç¨‹!${RESET}"; fi; else echo "   - ${CYAN}æœåŠ¡æœªè¿è¡Œã€‚${RESET}"; fi

    # 2. æ™ºèƒ½è°ƒåº¦çŠ¶æ€
    echo -e "${BLUE}2. æ™ºèƒ½è°ƒåº¦çŠ¶æ€:${RESET}"
    local profile; profile=$(get_current_profile)
    echo -e "   - è¿è¡Œæ—¶é…ç½®: ${GREEN}${profile^}${RESET}"
    if [ -f "$ENV_FILE" ]; then
        local threads=$(grep MINER_THREADS "$ENV_FILE" | cut -d '=' -f 2)
        local nice_val=$(grep NICE_LEVEL "$ENV_FILE" | cut -d '=' -f 2)
        echo -e "   - å½“å‰ç”Ÿæ•ˆçº¿ç¨‹: ${GREEN}${threads:-N/A}${RESET}"
        echo -e "   - å½“å‰ç”Ÿæ•ˆä¼˜å…ˆçº§: ${GREEN}${nice_val:-N/A}${RESET}"
    else
        echo -e "   - ${YELLOW}é…ç½®æœªåº”ç”¨ (æœåŠ¡æœªå¯åŠ¨)ã€‚${RESET}"
    fi

    # 3. å¥‡ç¾æ‹‰å®ˆæŠ¤è¿›ç¨‹
    echo -e "${BLUE}3. 'å¥‡ç¾æ‹‰'å®ˆæŠ¤è¿›ç¨‹:${RESET}"
    if [ -f "$WATCHDOG_PID_FILE" ] && kill -0 "$(cat $WATCHDOG_PID_FILE)" &>/dev/null; then
        echo -e "   - çŠ¶æ€: ${GREEN}æ¿€æ´» (PID: $(cat $WATCHDOG_PID_FILE))${RESET}"
        if [ -f "$WATCHDOG_LOG_FILE" ]; then
            echo -e "   - æœ€è¿‘æ´»åŠ¨: ${CYAN}$(tail -n 1 $WATCHDOG_LOG_FILE)${RESET}"
        fi
    else
        echo -e "   - çŠ¶æ€: ${RED}ä¼‘çœ ${RESET}"
    fi

    # 4. å†…æ ¸ä¸é…ç½®
    echo -e "${BLUE}4. å†…æ ¸ä¸å…¬é’¥:${RESET}"
    if verify_kernel_file "$KERNEL_FILE" "$HOON_KERNEL_SHA256"; then echo -e "   - å†…æ ¸çŠ¶æ€: ${GREEN}[OK] ${HOON_KERNEL_VERSION}${RESET}"; else echo -e "   - å†…æ ¸çŠ¶æ€: ${RED}[ä¸åŒ¹é…!] å†…æ ¸å·²æŸåæˆ–ç‰ˆæœ¬ä¸æ­£ç¡®!${RESET}"; fi
    if [ -f "$ENV_FILE" ] && grep -q "MINING_PUBKEY" "$ENV_FILE"; then pubkey=$(grep MINING_PUBKEY "$ENV_FILE" | cut -d '=' -f 2); echo -e "   - æŒ–çŸ¿å…¬é’¥: ${GREEN}${pubkey:0:8}...${pubkey: -8}${RESET}"; else echo -e "   - æŒ–çŸ¿å…¬é’¥: ${RED}[æœªè®¾ç½®!]${RESET}"; fi
    
    echo "-----------------------------------"
    pause_and_return
}

function main_menu() {
    # stop_watchdog # è„šæœ¬é€€å‡ºæ—¶ç¡®ä¿å®ˆæŠ¤è¿›ç¨‹ä¹Ÿé€€å‡º
    while true; do
    show_banner
    echo -e "${BOLD}${GREEN}--- ä¸»èœå• (Aether-Core) ---${RESET}"; echo "è¯·é€‰æ‹©è¦æ‰§è¡Œçš„æ“ä½œ:"; echo ""
    echo -e "  ${CYAN}1)${RESET} å…¨æ–°å®‰è£… Nockchain (ä¼šæ¸…ç©ºæ—§æ•°æ®)"
    echo -e "  ${CYAN}2)${RESET} è®¾ç½®/æ›´æ–°æŒ–çŸ¿å…¬é’¥"
    echo -e "  ${CYAN}7)${RESET} ${BOLD}è®¾ç½®è¿è¡Œæ—¶é…ç½®${RESET} (æ€§èƒ½/å‡è¡¡/èŠ‚èƒ½)"
    echo ""
    if check_systemd; then if systemctl is-active --quiet "$SERVICE_NAME"; then SERVICE_STATUS="${GREEN}(è¿è¡Œä¸­)${RESET}"; else SERVICE_STATUS="${RED}(å·²åœæ­¢)${RESET}"; fi; echo -e "  ${CYAN}3)${RESET} ${BOLD}å¯åŠ¨${RESET}æŒ–çŸ¿ (Systemd) ${SERVICE_STATUS}"; echo -e "  ${CYAN}4)${RESET} ${BOLD}åœæ­¢${RESET}æŒ–çŸ¿ (Systemd)"; echo -e "  ${CYAN}5)${RESET} æŸ¥çœ‹å®æ—¶æ—¥å¿— (Systemd)";
    elif check_command_exists screen; then if screen -ls | grep -q -w "${SERVICE_NAME}"; then SERVICE_STATUS="${GREEN}(è¿è¡Œä¸­)${RESET}"; else SERVICE_STATUS="${RED}(å·²åœæ­¢)${RESET}"; fi; echo -e "  ${CYAN}3)${RESET} ${BOLD}å¯åŠ¨${RESET}æŒ–çŸ¿ (Screen) ${SERVICE_STATUS}"; echo -e "  ${CYAN}4)${RESET} ${BOLD}åœæ­¢${RESET}æŒ–çŸ¿ (Screen)"; echo -e "  ${CYAN}5)${RESET} æŸ¥çœ‹æŒ–çŸ¿çª—å£ (Screen)";
    else echo -e "  ${RED}3-5) (ä¸å¯ç”¨) ç¼ºå°‘æœåŠ¡ç®¡ç†å·¥å…·ã€‚${RESET}"; fi
    echo ""
    echo -e "  ${PURPLE}6)${RESET} ${BOLD}ç³»ç»Ÿå¥åº·æ£€æŸ¥${RESET} (é©¾é©¶èˆ±è§†å›¾)"
    echo ""
    echo -e "  ${YELLOW}0) é€€å‡ºè„šæœ¬${RESET}"; echo ""
    read -r -p "è¯·è¾“å…¥é€‰é¡¹ç¼–å·: " choice
    case "$choice" in
        1) install_all ;; 2) set_pubkey ;; 3) start_node ;; 4) stop_node ;; 5) view_logs ;;
        6) health_check ;; 7) set_runtime_profile ;;
        0) echo -e "${BLUE}æ­£åœ¨åœæ­¢æ‰€æœ‰ç›¸å…³è¿›ç¨‹...${RESET}"; stop_node &>/dev/null; echo "æ„Ÿè°¢ä½¿ç”¨ï¼å†è§ã€‚"; exit 0 ;;
        *) echo -e "${RED}æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚${RESET}"; sleep 1 ;;
    esac
    done
}

# --- è„šæœ¬å…¥å£ ---
# ç¡®ä¿è„šæœ¬é€€å‡ºæ—¶æ¸…ç†å®ˆæŠ¤è¿›ç¨‹
trap "stop_watchdog &>/dev/null; exit" SIGINT SIGTERM
detect_system_info
main_menu
