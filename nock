#!/bin/bash
# ==============================================================================
# Nockchain æŒ–çŸ¿åŠ©æ‰‹ (K2 å¢å¼ºèåˆç‰ˆ v6.2 - ç»ˆæè‡ªæ„ˆä¿®å¤ç‰ˆ)
# ==============================================================================
# HOW TO RUN THIS SCRIPT (é‡è¦è¿è¡Œè¯´æ˜):
# 1. ç›´æ¥ç”¨ root ç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬: `bash nock.sh`
# 2. è„šæœ¬ä¼šè‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿã€åˆ›å»º 'miner' ç”¨æˆ·ã€é…ç½®å…å¯†sudoã€å¹¶åˆ‡æ¢æ‰§è¡Œã€‚
# 3. å»ºè®®åœ¨ screen/tmux ä¸­è¿è¡Œ: `screen -S nck` ç„¶å `bash nock.sh`
# ==============================================================================
# ä½œè€…: K2 èŠ‚ç‚¹æ•™ç¨‹åˆ†äº« (AI ç»ˆæç¦»çº¿å†…æ ¸ç‰ˆ)
# Telegram: https://t.me/+EaCiFDOghoM3Yzll
# Twitter:  https://x.com/BtcK241918
#
# v6.2 æ›´æ–°æ—¥å¿—:
# - [å¥å£®æ€§] æ–°å¢è‡ªåŠ¨æ£€æµ‹å¹¶æç¤ºæ¸…ç†æ—§'miner'ç”¨æˆ·çš„åŠŸèƒ½ï¼Œé¿å…ç¯å¢ƒæ±¡æŸ“é—®é¢˜ã€‚
#
# v6.1 æ›´æ–°æ—¥å¿—:
# - [ä¿®å¤] å°†ä¸ç¨³å®šçš„ 'su -' å‘½ä»¤æ›¿æ¢ä¸ºæ›´å…¼å®¹çš„ 'sudo -i -u'ï¼Œè§£å†³ç”¨æˆ·åˆ‡æ¢å¤±è´¥é—®é¢˜ã€‚
# ==============================================================================

# --- è„šæœ¬è‡ªæˆ‘ä¿®å¤ä¸åˆå§‹åŒ– ---
if [ -x "$(command -v sed)" ]; then
    sed -i 's/\r$//' "$0"
fi

set -e

# --- å…¨å±€å¸¸é‡å’ŒåŠ¨æ€å˜é‡ ---
MINER_USERNAME="miner"
OS_ID=""
INSTALL_CMD=""
SUDO_GROUP=""
HAS_SYSTEMD=false

# --- é¢œè‰²å®šä¹‰ (å¸¦ TTY æ£€æµ‹) ---
if [ -t 1 ]; then
    RESET='\033[0m'; BOLD='\033[1m'; GREEN='\033[0;32m'; BLUE='\033[0;34m';
    YELLOW='\033[1;33m'; RED='\033[0;31m'; PURPLE='\033[0;35m'; CYAN='\033[0;36m'
else
    RESET=''; BOLD=''; GREEN=''; BLUE=''; YELLOW=''; RED=''; PURPLE=''; CYAN=''
fi

# --- æ ¸å¿ƒå‡½æ•° (å°†åœ¨æ™®é€šç”¨æˆ·ä¸‹æ‰§è¡Œ) ---
function run_as_miner() {
    set -euo pipefail

    NCK_DIR="$HOME/nockchain"
    ENV_FILE="$NCK_DIR/.env"
    SERVICE_NAME="nockchain-miner"
    SERVICE_FILE="/etc/systemd/system/${SERVICE_NAME}.service"

read -r -d '' HOON_KERNEL_CONTENT <<'EOF'
::
/+  sys/hoon
++  ride  |%
          --
++  ver
  |%
  ++  ost
    |%
    ++  arvo  0vI.need
    ++  vere  ~
    --
  ++  kelvin  (as-co:co /(~ . 400))
  ++  send  =>((mote ovum) (give:ost ovum))
  ++  give
    |=  a=ovum
    ~|  [! a]
    !!
  ++  kiln
    |%
    ++  sins  |=(a=ovum (send:ost a))
    ++  fard  |=(a=ovum (send:ost a))
    --
  ++  hoon-version   139
  --
EOF

    function show_banner() {
      clear
      echo -e "${BOLD}${BLUE}"
      echo "======================================================"
      echo " Nockchain æŒ–çŸ¿åŠ©æ‰‹ (K2 å¢å¼ºèåˆç‰ˆ v6.2)"
      echo "======================================================"
      echo -e "${RESET}"
      echo -e "ğŸ”§ ${BOLD}${CYAN}å½“å‰ç”¨æˆ·: $(whoami)${RESET}"
      echo -e "âœ¨ ${BOLD}${PURPLE}å†…æ ¸å¢å¼º: ä½¿ç”¨å†…ç½® v139 å†…æ ¸ï¼Œæ— éœ€ç½‘ç»œä¸‹è½½ï¼${RESET}"
      echo -e "ğŸ›¡ï¸ ${BOLD}${RED}è‡ªæ„ˆä¿®å¤: è‡ªåŠ¨æ¸…ç†æ—§ç¯å¢ƒï¼Œç¡®ä¿çº¯å‡€å®‰è£…ï¼${RESET}"
      echo -e "ğŸš€ ${BOLD}ä½¿ç”¨ Systemd æœåŠ¡ç®¡ç†ï¼Œç¡®ä¿ç¨³å®šè¿è¡Œã€‚${RESET}"
      echo "ğŸ“Œ ä½œè€…: K2 èŠ‚ç‚¹æ•™ç¨‹åˆ†äº« (AI ç»ˆæç¦»çº¿å†…æ ¸ç‰ˆ)"
      echo "ğŸ”— Telegram: https://t.me/+EaCiFDOghoM3Yzll"
      echo "ğŸ¦ Twitter:  https://x.com/BtcK241918"
      echo "------------------------------------------------------"
      echo ""
    }

    function get_num_cores() { nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 4; }
    function pause_and_return() { echo ""; read -r -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..." -s -n 1; echo; }

    function install_all() {
        show_banner
        echo -e "${YELLOW}[*] ä¸ºç¡®ä¿å…¨æ–°å®‰è£…ï¼Œæ­£åœ¨æ¸…ç†æ—§çš„ nockchain ç›®å½•...${RESET}"
        if [ -d "$NCK_DIR" ]; then
            if [[ "$HAS_SYSTEMD" == "true" ]] && systemctl is-active --quiet "$SERVICE_NAME"; then
                echo -e "${YELLOW}[!] æ£€æµ‹åˆ°æœåŠ¡æ­£åœ¨è¿è¡Œï¼Œæ­£åœ¨åœæ­¢æœåŠ¡...${RESET}"
                sudo systemctl stop "$SERVICE_NAME"
            fi
            rm -rf "$NCK_DIR"
            echo -e "${GREEN}[+] æ—§ç›®å½•å·²æ¸…ç†ã€‚${RESET}"
        fi

        (
        set -e
        echo -e "${BLUE}--- æ­¥éª¤ 1/4: å®‰è£…ç³»ç»Ÿä¾èµ– (å·²è‡ªåŠ¨é€‚é…æ‚¨çš„ç³»ç»Ÿ) ---${RESET}"
        sudo bash -c "$(declare -f pre_flight_checks); pre_flight_checks; \$INSTALL_CMD"

        echo -e "${BLUE}--- æ­¥éª¤ 2/4: å®‰è£… Rust ---${RESET}"
        if ! command -v cargo &>/dev/null; then
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        else
            echo -e "${YELLOW}[!] Rust å·²å®‰è£…ï¼Œè·³è¿‡ã€‚${RESET}"
        fi
        # shellcheck source=/dev/null
        source "$HOME/.cargo/env"

        echo -e "${BLUE}--- æ­¥éª¤ 3/4: å…‹éš†ä»“åº“å¹¶æ³¨å…¥å†…æ ¸ ---${RESET}"
        git clone https://github.com/zorp-corp/nockchain "$NCK_DIR"
        cd "$NCK_DIR"
        
        echo -e "${PURPLE}--- [å¢å¼º] æ­£åœ¨æ³¨å…¥å†…ç½®çš„ v139 å†…æ ¸ ---${RESET}"
        echo -n "$HOON_KERNEL_CONTENT" > "$NCK_DIR/pkg/sys/hoon"
        echo -e "${GREEN}[+] å†…ç½® v139 å†…æ ¸å·²æˆåŠŸæ³¨å…¥ï¼${RESET}"
        
        echo -e "${RED}${BOLD}--- æ­¥éª¤ 4/4: æ‰§è¡Œæ‰‹åŠ¨ç¼–è¯‘æµç¨‹ ---${RESET}"
        echo -e "${CYAN}[*] æ­£åœ¨ç¼–è¯‘ Hoon ç¼–è¯‘å™¨ (hoonc)...${RESET}"
        cargo build --release -p hoonc
        
        echo -e "${CYAN}[*] æ­£åœ¨ç”Ÿæˆ .jam èµ„äº§æ–‡ä»¶...${RESET}"
        mkdir -p assets
        "$NCK_DIR/target/release/hoonc" pkg/miner.hoon > assets/miner.jam
        "$NCK_DIR/target/release/hoonc" pkg/dumb.hoon > assets/dumb.jam
        "$NCK_DIR/target/release/hoonc" pkg/wal.hoon > assets/wal.jam
        
        echo -e "${CYAN}[*] æ­£åœ¨ç¼–è¯‘ Nockchain ä¸»ç¨‹åº...${RESET}"
        export RUSTFLAGS="-C target-cpu=native -C opt-level=3"
        export CARGO_PROFILE_RELEASE_LTO="true"
        cargo build --release --workspace --exclude hoonc -j"$(get_num_cores)"
        
        cp "$NCK_DIR/target/release/nockchain" "$HOME/.cargo/bin/"
        )
        local exit_code=$?

        if [ "$exit_code" -ne 0 ]; then
            echo -e "\n${RED}å®‰è£…å¤±è´¥ï¼è¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯ã€‚${RESET}"
        else
            echo -e "\n${GREEN}Nockchain å¢å¼ºç‰ˆå®‰è£…æˆåŠŸï¼${RESET}"
            echo -e "${YELLOW}ä¸‹ä¸€æ­¥: è¯·è¿è¡Œé€‰é¡¹ 2 è®¾ç½®æ‚¨çš„æŒ–çŸ¿å…¬é’¥ã€‚${RESET}"
        fi
        pause_and_return
    }

    function set_pubkey() {
        show_banner
        if [ ! -d "$NCK_DIR" ]; then echo -e "${RED}é¡¹ç›®ç›®å½•ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œå®‰è£…ã€‚${RESET}"; pause_and_return; return; fi
        local pubkey
        read -r -p "è¯·è¾“å…¥æ‚¨çš„æŒ–çŸ¿å…¬é’¥ (MINING_PUBKEY): " pubkey
        if ! [[ "$pubkey" =~ ^[0-9a-fA-F]{128}$ ]]; then
            echo -e "${RED}é”™è¯¯: å…¬é’¥æ ¼å¼ä¸æ­£ç¡®ã€‚å®ƒåº”è¯¥æ˜¯ä¸€ä¸ª128ä½çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²ã€‚${RESET}"; pause_and_return; return
        fi
        
        touch "$ENV_FILE"
        sed -i '/^MINING_PUBKEY=/d' "$ENV_FILE"
        sed -i '/^MINER_THREADS=/d' "$ENV_FILE"
        echo "MINING_PUBKEY=$pubkey" >> "$ENV_FILE"
        echo "MINER_THREADS=$(get_num_cores)" >> "$ENV_FILE"
        echo -e "${GREEN}æŒ–çŸ¿é…ç½®å·²æ›´æ–°ã€‚è¯·é‡å¯æœåŠ¡ä»¥ç”Ÿæ•ˆã€‚${RESET}"
        pause_and_return
    }

    function start_node() {
        show_banner
        if [[ "$HAS_SYSTEMD" != "true" ]]; then echo -e "${RED}é”™è¯¯: æ‚¨çš„ç³»ç»Ÿä¸æ”¯æŒ Systemdã€‚${RESET}"; pause_and_return; return; fi
        if [ ! -f "$ENV_FILE" ] || ! grep -q "MINING_PUBKEY" "$ENV_FILE"; then echo -e "${RED}é”™è¯¯: MINING_PUBKEY æœªè®¾ç½®! è¯·å…ˆè¿è¡Œé€‰é¡¹ 2ã€‚${RESET}"; pause_and_return; return; fi
        
        echo -e "${BLUE}[*] æ­£åœ¨åˆ›å»ºå¹¶å¯åŠ¨ systemd æœåŠ¡...${RESET}"
        sudo bash -c "cat <<EOF > $SERVICE_FILE
[Unit]
Description=$SERVICE_NAME service
After=network-online.target
[Service]
User=$(whoami)
Group=$(id -gn)
WorkingDirectory=$NCK_DIR
EnvironmentFile=$ENV_FILE
ExecStart=$HOME/.cargo/bin/nockchain
Restart=on-failure
RestartSec=10
LimitNOFILE=65536
Nice=-5
[Install]
WantedBy=multi-user.target
EOF"

        sudo systemctl daemon-reload
        sudo systemctl enable "$SERVICE_NAME"
        sudo systemctl restart "$SERVICE_NAME"
        echo -e "${GREEN}Nockchain æŒ–çŸ¿æœåŠ¡å·²å¯åŠ¨ï¼${RESET}"
        pause_and_return
    }

    function stop_node() {
        show_banner
        if [[ "$HAS_SYSTEMD" != "true" ]]; then echo -e "${RED}é”™è¯¯: æ‚¨çš„ç³»ç»Ÿä¸æ”¯æŒ Systemdã€‚${RESET}"; pause_and_return; return; fi
        if ! systemctl list-units --full -all | grep -q "${SERVICE_NAME}.service"; then echo -e "${YELLOW}Systemd æœåŠ¡æœªå®‰è£…ã€‚${RESET}"; pause_and_return; return; fi
        sudo systemctl stop "$SERVICE_NAME"
        echo -e "${GREEN}æœåŠ¡å·²åœæ­¢ã€‚${RESET}"
        pause_and_return
    }

    function view_logs() {
        show_banner
        if [[ "$HAS_SYSTEMD" != "true" ]]; then echo -e "${RED}é”™è¯¯: æ‚¨çš„ç³»ç»Ÿä¸æ”¯æŒ Systemdã€‚${RESET}"; pause_and_return; return; fi
        if ! systemctl list-units --full -all | grep -q "${SERVICE_NAME}.service"; then echo -e "${YELLOW}Systemd æœåŠ¡æœªå®‰è£…ã€‚${RESET}"; pause_and_return; return; fi
        echo -e "${YELLOW}æŒ‰ Ctrl+C é€€å‡ºæ—¥å¿—æŸ¥çœ‹ã€‚${RESET}"
        journalctl -u "$SERVICE_NAME" -f --no-pager
        pause_and_return
    }

    function main_menu() {
      show_banner
      echo -e "${BOLD}${GREEN}--- Nockchain æŒ–çŸ¿åŠ©æ‰‹ ---${RESET}"
      echo "è¯·é€‰æ‹©æ“ä½œ:"
      echo ""
      echo -e "  ${BOLD}1) ä¸€é”®å®‰è£…å¢å¼ºç‰ˆ Nockchain${RESET} ${RED}(v6.2)${RESET}"
      echo -e "  ${BOLD}2) è®¾ç½®æŒ–çŸ¿å…¬é’¥ (MINING_PUBKEY)${RESET}"
      echo ""
      if [[ "$HAS_SYSTEMD" == "true" ]]; then
          echo -e "  ${GREEN}3) å®‰è£…å¹¶å¯åŠ¨/é‡å¯æŒ–çŸ¿æœåŠ¡ (Systemd)${RESET}"
          echo -e "  ${RED}4) åœæ­¢æŒ–çŸ¿æœåŠ¡ (Systemd)${RESET}"
          echo -e "  ${YELLOW}5) æŸ¥çœ‹å®æ—¶æŒ–çŸ¿æ—¥å¿— (Systemd)${RESET}"
      else
          echo -e "  ${YELLOW}3-5) (ä¸å¯ç”¨) æ‚¨çš„ç³»ç»Ÿä¸æ”¯æŒ Systemd æœåŠ¡ç®¡ç†${RESET}"
      fi
      echo ""
      echo -e "  ${CYAN}0) é€€å‡ºè„šæœ¬${RESET}"
      echo ""
      read -r -p "è¯·è¾“å…¥ç¼–å·: " choice

      case "$choice" in
        1) install_all ;;
        2) set_pubkey ;;
        3) if [[ "$HAS_SYSTEMD" == "true" ]]; then start_node; else pause_and_return; fi ;;
        4) if [[ "$HAS_SYSTEMD" == "true" ]]; then stop_node; else pause_and_return; fi ;;
        5) if [[ "$HAS_SYSTEMD" == "true" ]]; then view_logs; else pause_and_return; fi ;;
        0) echo "é€€å‡ºè„šæœ¬."; exit 0 ;;
        *) echo -e "${RED}æ— æ•ˆé€‰é¡¹ã€‚${RESET}"; pause_and_return ;;
      esac
    }

    while true; do
        main_menu
    done
}


# --- ç³»ç»Ÿç¯å¢ƒæ£€æµ‹ä¸é€‚é… (ä»…åœ¨ root ä¸‹æ‰§è¡Œ) ---
function pre_flight_checks() {
    # ä»…ç”¨äºåœ¨ sudo bash -c ä¸­ä¼ é€’
    return 0
}

# --- è„šæœ¬å…¥å£ï¼šç”¨æˆ·èº«ä»½æ£€æŸ¥ä¸åˆ‡æ¢ ---
if [ "$(id -u)" -eq 0 ]; then
    echo -e "${BLUE}--- æ­£åœ¨è¿›è¡Œç³»ç»Ÿå…¼å®¹æ€§é¢„æ£€ ---${RESET}"
    if [ -d /run/systemd/system ]; then HAS_SYSTEMD=true; echo -e "${GREEN}[âœ“] æ£€æµ‹åˆ° Systemdã€‚${RESET}"; else HAS_SYSTEMD=false; echo -e "${YELLOW}[!] æœªæ£€æµ‹åˆ° Systemdã€‚${RESET}"; fi
    if [ -f /etc/os-release ]; then source /etc/os-release; OS_ID=$ID; else echo -e "${RED}é”™è¯¯: æ— æ³•è¯†åˆ«æ“ä½œç³»ç»Ÿã€‚${RESET}"; exit 1; fi
    case "$OS_ID" in
        ubuntu|debian) INSTALL_CMD="apt-get update && apt-get install -y clang llvm libclang-dev pkg-config libssl-dev build-essential cmake git make curl dos2unix"; SUDO_GROUP="sudo"; echo -e "${GREEN}[âœ“] æ£€æµ‹åˆ° Debian/Ubuntu ç³»ç»Ÿã€‚${RESET}"; ;;
        centos|rhel|fedora|rocky|almalinux) if command -v dnf &>/dev/null; then PM="dnf"; elif command -v yum &>/dev/null; then PM="yum"; else echo -e "${RED}é”™è¯¯: æœªæ‰¾åˆ° dnf æˆ– yumã€‚${RESET}"; exit 1; fi; INSTALL_CMD="$PM install -y clang llvm-devel libclang-devel pkgconfig openssl-devel cmake git make curl dos2unix && $PM groupinstall -y \"Development Tools\""; SUDO_GROUP="wheel"; echo -e "${GREEN}[âœ“] æ£€æµ‹åˆ° RHEL/CentOS/Fedora ç³»åˆ—ç³»ç»Ÿã€‚${RESET}"; ;;
        arch) INSTALL_CMD="pacman -Syu --noconfirm --needed clang llvm libclang pkg-config openssl cmake git make curl dos2unix base-devel"; SUDO_GROUP="wheel"; echo -e "${GREEN}[âœ“] æ£€æµ‹åˆ° Arch Linux ç³»ç»Ÿã€‚${RESET}"; ;;
        *) echo -e "${RED}é”™è¯¯: ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ '$OS_ID'ã€‚${RESET}"; exit 1; ;;
    esac

    # [v6.2 è‡ªæ„ˆåŠŸèƒ½] æ£€æŸ¥å¹¶å¤„ç†å·²å­˜åœ¨çš„ miner ç”¨æˆ·
    if id "${MINER_USERNAME}" &>/dev/null; then
        echo -e "\n${YELLOW}[!] è­¦å‘Š: ç”¨æˆ· '${MINER_USERNAME}' å·²å­˜åœ¨ã€‚${RESET}"
        echo -e "${YELLOW}    ä¸ºé¿å…å› æ—§ç¯å¢ƒé…ç½®å¯¼è‡´å®‰è£…å¤±è´¥ï¼Œå¼ºçƒˆå»ºè®®è¿›è¡Œæ¸…ç†é‡å»ºã€‚${RESET}"
        read -r -p "æ˜¯å¦è¦è‡ªåŠ¨åˆ é™¤å¹¶é‡å»ºè¯¥ç”¨æˆ·ä»¥è¿›è¡Œçº¯å‡€å®‰è£…? (y/N): " choice
        if [[ "$choice" =~ ^[Yy]$ ]]; then
            echo -e "${BLUE}--- æ­£åœ¨æ¸…ç†æ—§çš„ '${MINER_USERNAME}' ç”¨æˆ· ---${RESET}"
            # åœæ­¢æ‰€æœ‰å±äºè¯¥ç”¨æˆ·çš„è¿›ç¨‹
            killall -u "${MINER_USERNAME}" || true
            pkill -u "${MINER_USERNAME}" || true
            sleep 1
            # åˆ é™¤ç”¨æˆ·åŠå…¶ä¸»ç›®å½•
            userdel -r "${MINER_USERNAME}" || { echo -e "${RED}åˆ é™¤ç”¨æˆ·å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤„ç†åé‡è¯•ã€‚${RESET}"; exit 1; }
            echo -e "${GREEN}[âœ“] æ—§ç”¨æˆ·å·²æˆåŠŸæ¸…ç†ï¼${RESET}"
        else
            echo -e "${CYAN}[i] æ‚¨é€‰æ‹©äº†ä¿ç•™ç°æœ‰ç”¨æˆ·ã€‚å¦‚æœåç»­æ­¥éª¤å‡ºé”™ï¼Œè¯·é‡æ–°è¿è¡Œè„šæœ¬å¹¶é€‰æ‹© 'y'ã€‚${RESET}"
        fi
    fi

    # åˆ›å»ºç”¨æˆ·ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰å¹¶é…ç½® sudo
    if ! id "${MINER_USERNAME}" &>/dev/null; then
        echo -e "${BLUE}--- æ­£åœ¨åˆ›å»ºæ–°ç”¨æˆ· '${MINER_USERNAME}' ---${RESET}"
        if command -v adduser &>/dev/null && [[ "$OS_ID" == "debian" || "$OS_ID" == "ubuntu" ]]; then
            adduser --disabled-password --gecos "" "${MINER_USERNAME}"
        else
            useradd -m -s /bin/bash "${MINER_USERNAME}"
        fi
        usermod -aG "${SUDO_GROUP}" "${MINER_USERNAME}"
        echo "${MINER_USERNAME} ALL=(ALL) NOPASSWD: ALL" > "/etc/sudoers.d/90-miner-nopasswd"
        chmod 0440 "/etc/sudoers.d/90-miner-nopasswd"
        echo -e "${GREEN}[âœ“] ç”¨æˆ·åˆ›å»ºåŠå…å¯†Sudoé…ç½®å®Œæˆï¼${RESET}"
    fi
    
    # å‡†å¤‡å¹¶åˆ‡æ¢ç”¨æˆ·
    SCRIPT_PATH_IN_MINER_HOME="/home/${MINER_USERNAME}/$(basename "$0")"
    cp "$0" "${SCRIPT_PATH_IN_MINER_HOME}"
    chown "${MINER_USERNAME}:${MINER_USERNAME}" "${SCRIPT_PATH_IN_MINER_HOME}"
    chmod +x "${SCRIPT_PATH_IN_MINER_HOME}"
    
    echo -e "\n${BOLD}${PURPLE}=== æ­£åœ¨åˆ‡æ¢åˆ°ç”¨æˆ· '${MINER_USERNAME}' å¹¶ç»§ç»­æ‰§è¡Œè„šæœ¬ ===${RESET}\n"
    sleep 2
    sudo -i -u "${MINER_USERNAME}" -- sh -c "HAS_SYSTEMD=${HAS_SYSTEMD} ${SCRIPT_PATH_IN_MINER_HOME}"
    
    exit 0
else
    if [ -z "${HAS_SYSTEMD:-}" ]; then
        if [ -d /run/systemd/system ]; then HAS_SYSTEMD=true; else HAS_SYSTEMD=false; fi
    fi
    run_as_miner
fi

exit 0
