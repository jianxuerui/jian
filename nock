#!/bin/bash

# ========= Nockchain ç›®å½•å®‰å…¨ä¿®å¤ç‰ˆè„šæœ¬ v15.1 (æ„å»ºå¤±è´¥ä¿®å¤ç‰ˆ) =========
RESET='\033[0m'
BOLD='\033[1m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'

NCK_DIR="$HOME/nockchain"
ENV_FILE="$NCK_DIR/.env"
LOG_FILE="$HOME/nockchain_build.log"
HOONC_LOG="$HOME/nockchain_hoonc.log"
NODE_LOG="$HOME/nockchain_node.log"

function show_banner() {
  clear
  echo -e "${BOLD}${CYAN}"
  echo "======================================================"
  echo "   Nockchain æ„å»ºå¤±è´¥ä¿®å¤ç‰ˆè„šæœ¬ v15.1"
  echo "======================================================"
  echo -e "${RESET}"
  echo "ğŸ”§ æ„å»ºä¿®å¤: è§£å†³make buildå’Œinstallå¤±è´¥é—®é¢˜"
  echo "ğŸ’¾ å†…å­˜ä¼˜åŒ–: å¼ºåŒ–å†…å­˜æ£€æŸ¥å’Œswapé…ç½®"
  echo "ğŸ¯ åˆ†æ­¥æ„å»º: ä¼˜åŒ–æ„å»ºé¡ºåºï¼Œæé«˜æˆåŠŸç‡"
  echo "ğŸ“Š æ™ºèƒ½é‡è¯•: è‡ªåŠ¨é‡è¯•å¤±è´¥çš„æ„å»ºæ­¥éª¤"
  echo "ğŸš€ å®Œæ•´ç®¡ç†: ä»å®‰è£…åˆ°è¿è¡Œçš„ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆ"
  echo "------------------------------------------------------"
  echo ""
}

# ========= å…³é”®ï¼šç›®å½•å®‰å…¨æ£€æŸ¥å‡½æ•° =========
function ensure_nockchain_directory() {
  if [ ! -d "$NCK_DIR" ]; then
    echo -e "${YELLOW}[!] Nockchainé¡¹ç›®ç›®å½•ä¸å­˜åœ¨: $NCK_DIR${RESET}"
    echo -e "${BLUE}[i] å¯èƒ½çš„åŸå› :${RESET}"
    echo "  - é¡¹ç›®å°šæœªå…‹éš†"
    echo "  - å…‹éš†è¿‡ç¨‹å¤±è´¥"
    echo "  - ç›®å½•è¢«æ„å¤–åˆ é™¤"
    echo ""
    
    read -p "æ˜¯å¦è¦è‡ªåŠ¨å…‹éš†Nockchainé¡¹ç›®? (Y/n): " clone_choice
    
    if [[ "$clone_choice" =~ ^[Nn]$ ]]; then
      echo -e "${YELLOW}[!] æ— æ³•ç»§ç»­ï¼Œéœ€è¦Nockchainé¡¹ç›®ç›®å½•${RESET}"
      return 1
    else
      echo -e "[*] è‡ªåŠ¨å…‹éš†Nockchainé¡¹ç›®..."
      clone_nockchain_project
      return $?
    fi
  else
    echo -e "${GREEN}[+] Nockchainé¡¹ç›®ç›®å½•å­˜åœ¨${RESET}"
    return 0
  fi
}

function safe_cd_nockchain() {
  if ! ensure_nockchain_directory; then
    echo -e "${RED}[-] æ— æ³•è®¿é—®Nockchainç›®å½•${RESET}"
    pause_and_return
    return 1
  fi
  
  cd "$NCK_DIR" || {
    echo -e "${RED}[-] æ— æ³•è¿›å…¥ç›®å½•: $NCK_DIR${RESET}"
    pause_and_return
    return 1
  }
  
  return 0
}

# ========= å…‹éš†é¡¹ç›®å‡½æ•° =========
function clone_nockchain_project() {
  echo -e "[*] å…‹éš†Nockchainé¡¹ç›®..."
  
  cd "$HOME" || return 1
  
  if [ -d "nockchain" ]; then
    echo -e "[*] æ¸…ç†æ—§çš„é¡¹ç›®æ®‹ç•™..."
    rm -rf nockchain
  fi
  
  if git clone --depth 1 https://github.com/zorp-corp/nockchain; then
    echo -e "${GREEN}[+] é¡¹ç›®å…‹éš†æˆåŠŸ${RESET}"
    
    cd nockchain || return 1
    
    if [ -f ".env_example" ]; then
      cp .env_example .env
    else
      cat > .env << 'EOF'
MINING_PUBKEY=
RUST_LOG=info
EOF
    fi
    
    echo -e "[*] åˆ›å»ºå¿…éœ€çš„èµ„äº§æ–‡ä»¶..."
    mkdir -p assets
    touch assets/wal.jam
    touch assets/dumb.jam  
    touch assets/miner.jam
    
    mkdir -p .socket test-leader logs
    chmod 755 .socket test-leader
    
    echo -e "${GREEN}[+] é¡¹ç›®åˆå§‹åŒ–å®Œæˆ${RESET}"
    return 0
  else
    echo -e "${RED}[-] é¡¹ç›®å…‹éš†å¤±è´¥${RESET}"
    echo -e "${BLUE}[i] è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒGité…ç½®${RESET}"
    return 1
  fi
}

# ========= å¼ºåŒ–å†…å­˜æ£€æŸ¥å’ŒSwapé…ç½® =========
function optimize_system_advanced() {
  echo -e "[*] å¼ºåŒ–ç³»ç»Ÿå†…å­˜ä¼˜åŒ–ï¼ˆåŸºäºæ„å»ºå¤±è´¥ä¿®å¤ï¼‰..."
  
  total_mem_kb=$(grep MemTotal /proc/meminfo | awk '{print $2}')
  total_mem_gb=$((total_mem_kb / 1024 / 1024))
  
  echo -e "${BLUE}[i] ç³»ç»Ÿå†…å­˜: ${total_mem_gb}GB${RESET}"
  
  # åŸºäºç¤¾åŒºåé¦ˆï¼Œå¼ºåŒ–å†…å­˜è¦æ±‚[5][7]
  if [ $total_mem_gb -lt 8 ]; then
    echo -e "${RED}[-] ä¸¥é‡è­¦å‘Š: å†…å­˜ä¸¥é‡ä¸è¶³ï¼${RESET}"
    echo -e "${YELLOW}[!] Nockchainæ„å»ºè‡³å°‘éœ€è¦8GBå†…å­˜ï¼Œæ¨è16GB+${RESET}"
    echo -e "${YELLOW}[!] å½“å‰å†…å­˜å¯èƒ½å¯¼è‡´mem.rsé”™è¯¯å’Œæ„å»ºå¤±è´¥${RESET}"
    
    # é…ç½®å¤§å®¹é‡swap
    required_swap=$((24 - total_mem_gb))
    if [ $required_swap -gt 0 ]; then
      echo -e "[*] é…ç½®${required_swap}GBè¶…å¤§å®¹é‡swapæ¥è¡¥å¿å†…å­˜ä¸è¶³..."
      
      # åˆ é™¤æ—§çš„swapæ–‡ä»¶
      sudo swapoff /swapfile-nockchain-mega 2>/dev/null || true
      sudo rm -f /swapfile-nockchain-mega
      
      # åˆ›å»ºæ–°çš„å¤§å®¹é‡swap
      if sudo fallocate -l ${required_swap}G /swapfile-nockchain-mega 2>/dev/null; then
        sudo chmod 600 /swapfile-nockchain-mega
        sudo mkswap /swapfile-nockchain-mega >/dev/null 2>&1
        sudo swapon /swapfile-nockchain-mega >/dev/null 2>&1
        
        # æ·»åŠ åˆ°fstabä»¥ä¾¿é‡å¯åè‡ªåŠ¨æŒ‚è½½
        if ! grep -q "/swapfile-nockchain-mega" /etc/fstab; then
          echo '/swapfile-nockchain-mega none swap sw 0 0' | sudo tee -a /etc/fstab >/dev/null
        fi
        
        echo -e "${GREEN}[+] ${required_swap}GB è¶…å¤§Swapé…ç½®æˆåŠŸ${RESET}"
      else
        echo -e "${YELLOW}[!] Swapé…ç½®å¤±è´¥ï¼Œä½¿ç”¨ddæ–¹å¼...${RESET}"
        sudo dd if=/dev/zero of=/swapfile-nockchain-mega bs=1G count=$required_swap 2>/dev/null
        sudo chmod 600 /swapfile-nockchain-mega
        sudo mkswap /swapfile-nockchain-mega >/dev/null 2>&1
        sudo swapon /swapfile-nockchain-mega >/dev/null 2>&1
        echo -e "${GREEN}[+] ${required_swap}GB Swapå·²é…ç½®${RESET}"
      fi
    fi
  elif [ $total_mem_gb -lt 16 ]; then
    echo -e "${YELLOW}[!] å†…å­˜åä½ï¼Œå»ºè®®é…ç½®é¢å¤–swap${RESET}"
    required_swap=$((8))
    
    echo -e "[*] é…ç½®${required_swap}GBé¢å¤–swap..."
    sudo swapoff /swapfile-nockchain-extra 2>/dev/null || true
    sudo rm -f /swapfile-nockchain-extra
    
    sudo fallocate -l ${required_swap}G /swapfile-nockchain-extra 2>/dev/null || \
    sudo dd if=/dev/zero of=/swapfile-nockchain-extra bs=1G count=$required_swap 2>/dev/null
    
    sudo chmod 600 /swapfile-nockchain-extra
    sudo mkswap /swapfile-nockchain-extra >/dev/null 2>&1
    sudo swapon /swapfile-nockchain-extra >/dev/null 2>&1
    echo -e "${GREEN}[+] ${required_swap}GB é¢å¤–Swapå·²é…ç½®${RESET}"
  fi
  
  # é«˜çº§ç³»ç»Ÿä¼˜åŒ–å‚æ•°
  sudo sysctl -w vm.overcommit_memory=1 >/dev/null 2>&1 || true
  sudo sysctl -w vm.max_map_count=2097152 >/dev/null 2>&1 || true
  sudo sysctl -w vm.dirty_ratio=5 >/dev/null 2>&1 || true
  sudo sysctl -w vm.swappiness=60 >/dev/null 2>&1 || true  # æé«˜swapä½¿ç”¨
  sudo sysctl -w vm.vfs_cache_pressure=50 >/dev/null 2>&1 || true
  
  # æ˜¾ç¤ºå½“å‰å†…å­˜çŠ¶æ€
  echo -e "${BLUE}[i] å½“å‰å†…å­˜çŠ¶æ€:${RESET}"
  free -h
  
  echo -e "${GREEN}[+] å¼ºåŒ–ç³»ç»Ÿä¼˜åŒ–å®Œæˆ${RESET}"
}

function install_enhanced_dependencies() {
  echo -e "[*] å®‰è£…å¼ºåŒ–æ„å»ºä¾èµ–ï¼ˆè§£å†³æ„å»ºå¤±è´¥ï¼‰..."
  
  # åŸºäºç¤¾åŒºç»éªŒï¼Œå¼ºåŒ–ä¾èµ–å®‰è£…[2][5]
  sudo apt-get update -y && sudo apt-get upgrade -y
  
  # å®‰è£…å®Œæ•´çš„æ„å»ºå·¥å…·é“¾
  sudo apt install -y \
    build-essential \
    gcc g++ clang-12 llvm-12 llvm-12-dev libclang-12-dev \
    cmake make ninja-build autoconf automake libtool \
    curl git wget unzip tar gzip \
    pkg-config pkgconf \
    libssl-dev openssl libssl3 \
    python3 python3-dev python3-pip \
    libffi-dev zlib1g-dev libbz2-dev \
    libreadline-dev libsqlite3-dev libncurses5-dev \
    xz-utils tk-dev libgdbm-dev liblzma-dev uuid-dev \
    screen htop jq bc time strace \
    net-tools lld-12 \
    valgrind gdb \
    libc6-dev \
    linux-headers-$(uname -r) || true
  
  # è®¾ç½®clangç‰ˆæœ¬ç¬¦å·é“¾æ¥
  sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-12 100 2>/dev/null || true
  sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-12 100 2>/dev/null || true
  sudo update-alternatives --install /usr/bin/llvm-config llvm-config /usr/bin/llvm-config-12 100 2>/dev/null || true
  
  # éªŒè¯å…³é”®å·¥å…·
  echo -e "${BLUE}[i] éªŒè¯æ„å»ºå·¥å…·:${RESET}"
  for tool in gcc g++ clang cmake make pkg-config git; do
    if command -v "$tool" >/dev/null 2>&1; then
      tool_version=$(eval "$tool --version 2>/dev/null | head -1" || echo "unknown")
      echo -e "${GREEN}  âœ“ $tool: $tool_version${RESET}"
    else
      echo -e "${RED}  âœ— $tool: æœªå®‰è£…${RESET}"
      return 1
    fi
  done
  
  # è®¾ç½®æ„å»ºç¯å¢ƒå˜é‡
  export CC=clang
  export CXX=clang++
  export CARGO_BUILD_JOBS=1
  export LIBCLANG_PATH=/usr/lib/llvm-12/lib
  export LLVM_CONFIG_PATH=/usr/bin/llvm-config-12
  
  echo -e "${GREEN}[+] å¼ºåŒ–ä¾èµ–å®‰è£…å®Œæˆ${RESET}"
}

# ========= å¢å¼ºRustç¯å¢ƒé…ç½® =========
function setup_rust_enhanced() {
  echo -e "[*] å¢å¼ºRustç¯å¢ƒé…ç½®ï¼ˆè§£å†³æ„å»ºé—®é¢˜ï¼‰..."
  
  # æ€æ­»å¯èƒ½å­˜åœ¨çš„rustè¿›ç¨‹
  pkill -f cargo 2>/dev/null || true
  pkill -f rustc 2>/dev/null || true
  sleep 3
  
  # å®‰è£…æˆ–æ›´æ–°Rust
  if ! command -v rustc >/dev/null 2>&1; then
    echo -e "[*] å®‰è£…Rustï¼ˆå®˜æ–¹æ–¹æ³•ï¼‰..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
    source "$HOME/.cargo/env"
  else
    echo -e "[*] æ›´æ–°ç°æœ‰Rust..."
    source "$HOME/.cargo/env"
    rustup update stable
  fi
  
  export PATH="$HOME/.cargo/bin:$PATH"
  
  # å¼ºåŒ–Cargoé…ç½®ä»¥å‡å°‘å†…å­˜ä½¿ç”¨å’Œæé«˜æ„å»ºæˆåŠŸç‡
  mkdir -p "$HOME/.cargo"
  cat > "$HOME/.cargo/config.toml" << 'EOF'
[build]
jobs = 1

[net]
retry = 50
timeout = 1800
git-fetch-with-cli = true

[env]
CC = "clang"
CXX = "clang++"
LIBCLANG_PATH = "/usr/lib/llvm-12/lib"

[profile.release]
opt-level = 1
debug = false
debug-assertions = false
overflow-checks = false
lto = false
panic = "abort"
incremental = false
codegen-units = 1

[profile.dev]
opt-level = 0
debug = false
debug-assertions = false
overflow-checks = false
incremental = false
codegen-units = 1

[target.x86_64-unknown-linux-gnu]
linker = "clang"
EOF
  
  # éªŒè¯Rustç¯å¢ƒ
  if command -v cargo >/dev/null 2>&1 && command -v rustc >/dev/null 2>&1; then
    echo -e "${GREEN}[+] Rustç¯å¢ƒé…ç½®å®Œæˆ${RESET}"
    echo -e "${GREEN}[+] Rust: $(rustc --version)${RESET}"
    echo -e "${GREEN}[+] Cargo: $(cargo --version)${RESET}"
    return 0
  else
    echo -e "${RED}[-] Rustç¯å¢ƒé…ç½®å¤±è´¥${RESET}"
    return 1
  fi
}

# ========= åˆ†æ­¥éª¤æ„å»ºæµç¨‹ï¼ˆä¿®å¤æ„å»ºå¤±è´¥ï¼‰ =========
function build_components_step_by_step() {
  echo -e "[*] åˆ†æ­¥éª¤æ„å»ºNockchainç»„ä»¶ï¼ˆä¿®å¤ç‰ˆï¼‰..."
  
  if ! safe_cd_nockchain; then
    return 1
  fi
  
  # è®¾ç½®æ„å»ºç¯å¢ƒ
  source "$HOME/.cargo/env"
  export PATH="$HOME/.cargo/bin:$PATH"
  export CC=clang
  export CXX=clang++
  export CARGO_BUILD_JOBS=1
  export RUSTFLAGS="-C opt-level=1 -C debuginfo=0 -C panic=abort"
  export LIBCLANG_PATH=/usr/lib/llvm-12/lib
  export LLVM_CONFIG_PATH=/usr/bin/llvm-config-12
  
  echo -e "[*] å½»åº•æ¸…ç†æ„å»ºç¯å¢ƒ..."
  cargo clean >/dev/null 2>&1 || true
  rm -rf target/ 2>/dev/null || true
  rm -rf ~/.cargo/registry/cache/ 2>/dev/null || true
  
  # æ¸…ç†socketæ–‡ä»¶ï¼Œé¿å…Address already in useé”™è¯¯[4]
  find . -name "*.sock" -delete 2>/dev/null || true
  rm -f .socket/nockchain_npc.sock 2>/dev/null || true
  
  echo -e "[*] æ›´æ–°é¡¹ç›®ä¾èµ–..."
  timeout 900 cargo update >>"$LOG_FILE" 2>&1 || {
    echo -e "${YELLOW}[!] ä¾èµ–æ›´æ–°è¶…æ—¶ï¼Œç»§ç»­æ„å»º...${RESET}"
  }
  
  build_success=0
  total_components=3
  
  # æ­¥éª¤1: æ„å»ºhooncç¼–è¯‘å™¨[2][3]
  echo -e "${BLUE}[i] æ­¥éª¤1/3: æ„å»ºhooncç¼–è¯‘å™¨...${RESET}"
  if timeout 3600 make install-hoonc >>"$LOG_FILE" 2>&1; then
    echo -e "${GREEN}[+] hooncæ„å»ºæˆåŠŸ${RESET}"
    ((build_success++))
  else
    echo -e "${YELLOW}[!] hooncæ„å»ºå¤±è´¥ï¼Œå°è¯•æ‰‹åŠ¨æ„å»º...${RESET}"
    if timeout 3600 cargo build --bin hoonc --release >>"$LOG_FILE" 2>&1; then
      mkdir -p "$HOME/.cargo/bin"
      cp target/release/hoonc "$HOME/.cargo/bin/" 2>/dev/null || true
      chmod +x "$HOME/.cargo/bin/hoonc"
      echo -e "${GREEN}[+] hooncæ‰‹åŠ¨æ„å»ºæˆåŠŸ${RESET}"
      ((build_success++))
    else
      echo -e "${RED}[-] hooncæ„å»ºå®Œå…¨å¤±è´¥${RESET}"
    fi
  fi
  
  # ç¡®ä¿hooncåœ¨PATHä¸­
  export PATH="$HOME/.cargo/bin:$PATH"
  
  # æ­¥éª¤2: æ„å»ºä¸»é¡¹ç›®
  echo -e "${BLUE}[i] æ­¥éª¤2/3: æ„å»ºä¸»é¡¹ç›®...${RESET}"
  for attempt in 1 2 3; do
    echo -e "[*] ä¸»é¡¹ç›®æ„å»ºå°è¯• $attempt/3..."
    if timeout 5400 make build >>"$LOG_FILE" 2>&1; then
      echo -e "${GREEN}[+] ä¸»é¡¹ç›®æ„å»ºæˆåŠŸ${RESET}"
      break
    else
      echo -e "${YELLOW}[!] ä¸»é¡¹ç›®æ„å»ºå°è¯• $attempt å¤±è´¥${RESET}"
      if [ $attempt -eq 3 ]; then
        echo -e "${YELLOW}[!] ä¸»é¡¹ç›®æ„å»ºå¤±è´¥ï¼Œå°è¯•åˆ†åˆ«æ„å»ºç»„ä»¶...${RESET}"
        
        # åˆ†åˆ«æ„å»ºwalletå’Œnode
        for component in "nockchain-wallet" "nockchain"; do
          echo -e "[*] å•ç‹¬æ„å»º $component..."
          if timeout 3600 cargo build --bin "$component" --release >>"$LOG_FILE" 2>&1; then
            echo -e "${GREEN}[+] $component å•ç‹¬æ„å»ºæˆåŠŸ${RESET}"
            mkdir -p "$HOME/.cargo/bin"
            if [ -f "target/release/$component" ]; then
              cp "target/release/$component" "$HOME/.cargo/bin/"
              chmod +x "$HOME/.cargo/bin/$component"
            fi
          else
            echo -e "${YELLOW}[!] $component å•ç‹¬æ„å»ºå¤±è´¥${RESET}"
          fi
        done
      else
        echo -e "[*] æ¸…ç†ç¼“å­˜åé‡è¯•..."
        cargo clean >/dev/null 2>&1 || true
        sync && sudo sysctl -w vm.drop_caches=1 >/dev/null 2>&1 || true
        sleep 10
      fi
    fi
  done
  
  # æ­¥éª¤3: å®‰è£…ç»„ä»¶
  echo -e "${BLUE}[i] æ­¥éª¤3/3: å®‰è£…ç»„ä»¶...${RESET}"
  
  # å®‰è£…nockchain-wallet
  if timeout 1800 make install-nockchain-wallet >>"$LOG_FILE" 2>&1; then
    echo -e "${GREEN}[+] nockchain-walletå®‰è£…æˆåŠŸ${RESET}"
    ((build_success++))
  else
    echo -e "${YELLOW}[!] nockchain-walletå®‰è£…å¤±è´¥ï¼Œæ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶...${RESET}"
    if [ -f "target/release/nockchain-wallet" ]; then
      mkdir -p "$HOME/.cargo/bin"
      cp target/release/nockchain-wallet "$HOME/.cargo/bin/"
      chmod +x "$HOME/.cargo/bin/nockchain-wallet"
      echo -e "${GREEN}[+] nockchain-walletæ‰‹åŠ¨å®‰è£…æˆåŠŸ${RESET}"
      ((build_success++))
    fi
  fi
  
  # å®‰è£…nockchain
  if timeout 1800 make install-nockchain >>"$LOG_FILE" 2>&1; then
    echo -e "${GREEN}[+] nockchainå®‰è£…æˆåŠŸ${RESET}"
    ((build_success++))
  else
    echo -e "${YELLOW}[!] nockchainå®‰è£…å¤±è´¥ï¼Œæ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶...${RESET}"
    if [ -f "target/release/nockchain" ]; then
      mkdir -p "$HOME/.cargo/bin"
      cp target/release/nockchain "$HOME/.cargo/bin/"
      chmod +x "$HOME/.cargo/bin/nockchain"
      echo -e "${GREEN}[+] nockchainæ‰‹åŠ¨å®‰è£…æˆåŠŸ${RESET}"
      ((build_success++))
    fi
  fi
  
  # æœ€ç»ˆéªŒè¯
  echo -e "[*] æœ€ç»ˆæ„å»ºç»“æœéªŒè¯..."
  component_count=0
  
  for binary in "hoonc" "nockchain-wallet" "nockchain"; do
    if command -v "$binary" >/dev/null 2>&1; then
      binary_path=$(command -v "$binary")
      binary_size=$(du -h "$binary_path" 2>/dev/null | cut -f1 || echo "unknown")
      echo -e "${GREEN}  âœ“ $binary: $binary_path (å¤§å°: $binary_size)${RESET}"
      ((component_count++))
    else
      echo -e "${RED}  âœ— $binary: æœªæ‰¾åˆ°${RESET}"
    fi
  done
  
  echo -e "${BLUE}[i] æˆåŠŸæ„å»º: $component_count/$total_components ä¸ªç»„ä»¶${RESET}"
  
  if [ $component_count -eq $total_components ]; then
    echo -e "${GREEN}[+] âœ… æ‰€æœ‰ç»„ä»¶æ„å»ºæˆåŠŸï¼${RESET}"
    return 0
  elif [ $component_count -ge 2 ]; then
    echo -e "${YELLOW}[!] å¤§éƒ¨åˆ†ç»„ä»¶æ„å»ºæˆåŠŸ${RESET}"
    return 0
  else
    echo -e "${RED}[-] æ„å»ºå¤±è´¥${RESET}"
    return 1
  fi
}

# ========= å®Œæ•´å®‰è£…æµç¨‹ï¼ˆä¿®å¤ç‰ˆï¼‰ =========
function complete_installation_fixed() {
  echo -e "[*] å¼€å§‹Nockchainå®Œæ•´å®‰è£…æµç¨‹ï¼ˆæ„å»ºå¤±è´¥ä¿®å¤ç‰ˆï¼‰..."
  
  echo "=== Nockchainæ„å»ºå¤±è´¥ä¿®å¤ç‰ˆå®‰è£…æ—¥å¿— $(date) ===" > "$LOG_FILE"
  
  echo -e "${BLUE}[i] æ­¥éª¤1/5: å¼ºåŒ–ç³»ç»Ÿä¼˜åŒ–...${RESET}"
  optimize_system_advanced
  
  echo -e "${BLUE}[i] æ­¥éª¤2/5: å®‰è£…å¢å¼ºä¾èµ–...${RESET}"
  if ! install_enhanced_dependencies; then
    echo -e "${RED}[-] ä¾èµ–å®‰è£…å¤±è´¥${RESET}"
    pause_and_return
    return
  fi
  
  echo -e "${BLUE}[i] æ­¥éª¤3/5: é…ç½®å¢å¼ºRustç¯å¢ƒ...${RESET}"
  if ! setup_rust_enhanced; then
    echo -e "${RED}[-] Rustç¯å¢ƒé…ç½®å¤±è´¥${RESET}"
    pause_and_return
    return
  fi
  
  echo -e "${BLUE}[i] æ­¥éª¤4/5: å‡†å¤‡é¡¹ç›®...${RESET}"
  if ! clone_nockchain_project; then
    echo -e "${RED}[-] é¡¹ç›®å‡†å¤‡å¤±è´¥${RESET}"
    pause_and_return
    return
  fi
  
  echo -e "${BLUE}[i] æ­¥éª¤5/5: åˆ†æ­¥éª¤æ„å»ºç»„ä»¶...${RESET}"
  if build_components_step_by_step; then
    echo -e "${GREEN}[+] âœ… Nockchainæ„å»ºå¤±è´¥ä¿®å¤ç‰ˆå®‰è£…æˆåŠŸï¼${RESET}"
    echo -e "${BLUE}[i] æ‰€æœ‰å…³é”®ç»„ä»¶å·²æ„å»ºå®Œæˆ${RESET}"
    echo -e "${BLUE}[i] ä¸‹ä¸€æ­¥: ç”Ÿæˆé’±åŒ…å’Œè®¾ç½®æŒ–çŸ¿å…¬é’¥${RESET}"
    echo -e "${BLUE}[i] è¯¦ç»†æ—¥å¿—: $LOG_FILE${RESET}"
  else
    echo -e "${YELLOW}[!] å®‰è£…éƒ¨åˆ†æˆåŠŸï¼Œæ£€æŸ¥æ—¥å¿—è·å–è¯¦æƒ…${RESET}"
    echo -e "${BLUE}[i] æ—¥å¿—æ–‡ä»¶: $LOG_FILE${RESET}"
  fi
  
  pause_and_return
}

# ========= é’±åŒ…ç®¡ç†åŠŸèƒ½ï¼ˆå¢å¼ºç‰ˆï¼‰ =========
function generate_wallet_enhanced() {
  echo -e "[*] ç”Ÿæˆé’±åŒ…ï¼ˆå¢å¼ºç‰ˆï¼‰..."
  
  if ! safe_cd_nockchain; then
    return
  fi
  
  source "$HOME/.cargo/env" 2>/dev/null || true
  export PATH="$HOME/.cargo/bin:$PATH"
  
  wallet_bin=""
  if command -v nockchain-wallet >/dev/null 2>&1; then
    wallet_bin="nockchain-wallet"
  elif [ -f "target/release/nockchain-wallet" ]; then
    wallet_bin="./target/release/nockchain-wallet"
  elif [ -f "target/debug/nockchain-wallet" ]; then
    wallet_bin="./target/debug/nockchain-wallet"
  fi
  
  if [ -z "$wallet_bin" ]; then
    echo -e "${RED}[-] æœªæ‰¾åˆ°nockchain-walletç¨‹åº${RESET}"
    echo -e "${YELLOW}[!] è¯·å…ˆå®Œæˆæ„å»º${RESET}"
    pause_and_return
    return
  fi
  
  echo -e "${GREEN}[+] ä½¿ç”¨é’±åŒ…ç¨‹åº: $wallet_bin${RESET}"
  echo -e "${BLUE}[i] ç”Ÿæˆé’±åŒ…å¯†é’¥...${RESET}"
  
  # å°è¯•ç”Ÿæˆé’±åŒ…ï¼Œå¢åŠ é”™è¯¯å¤„ç†
  if "$wallet_bin" keygen 2>/dev/null; then
    echo -e "${GREEN}[+] é’±åŒ…ç”ŸæˆæˆåŠŸ${RESET}"
  else
    echo -e "${YELLOW}[!] é’±åŒ…ç”Ÿæˆå¯èƒ½æœ‰é—®é¢˜ï¼Œå°è¯•debugæ¨¡å¼...${RESET}"
    RUST_LOG=debug "$wallet_bin" keygen
  fi
  
  echo ""
  echo -e "${YELLOW}[!] é‡è¦æé†’:${RESET}"
  echo -e "${YELLOW}[!] 1. è¯·åŠ¡å¿…å¤‡ä»½ä¸Šæ–¹æ˜¾ç¤ºçš„åŠ©è®°è¯ã€ç§é’¥å’Œå…¬é’¥${RESET}"
  echo -e "${YELLOW}[!] 2. å…¬é’¥æ ¼å¼åº”ä¸º128ä½16è¿›åˆ¶å­—ç¬¦ä¸²${RESET}"
  echo -e "${YELLOW}[!] 3. ä¸‹ä¸€æ­¥éœ€è¦å°†å…¬é’¥è®¾ç½®åˆ°.envæ–‡ä»¶ä¸­${RESET}"
  echo ""
  pause_and_return
}

function set_mining_pubkey_enhanced() {
  echo -e "[*] è®¾ç½®æŒ–çŸ¿å…¬é’¥ï¼ˆå¢å¼ºç‰ˆï¼‰..."
  
  if ! safe_cd_nockchain; then
    return
  fi

  echo -e "${BLUE}[i] å…¬é’¥è¦æ±‚:${RESET}"
  echo -e "  - æ ¼å¼ï¼š128ä½16è¿›åˆ¶å­—ç¬¦ä¸²"
  echo -e "  - ç¤ºä¾‹ï¼šabcdef123456789... (å…±128ä¸ªå­—ç¬¦)"
  echo -e "  - ä¸å«ç©ºæ ¼ã€æ¢è¡Œç¬¦ç­‰ç‰¹æ®Šå­—ç¬¦"
  echo ""
  
  while true; do
    read -p "è¯·è¾“å…¥å®Œæ•´çš„æŒ–çŸ¿å…¬é’¥: " pubkey
    
    if [ -z "$pubkey" ]; then
      echo -e "${RED}[-] å…¬é’¥ä¸èƒ½ä¸ºç©º${RESET}"
      continue
    fi
    
    # æ¸…ç†å…¬é’¥æ ¼å¼
    pubkey=$(echo "$pubkey" | tr -d ' \n\r\t' | tr '[:upper:]' '[:lower:]')
    
    if [ ${#pubkey} -eq 128 ] && [[ "$pubkey" =~ ^[0-9a-f]{128}$ ]]; then
      # å†™å…¥.envæ–‡ä»¶
      sed -i '/^MINING_PUBKEY=/d' "$ENV_FILE" 2>/dev/null || true
      echo "MINING_PUBKEY=$pubkey" >> "$ENV_FILE"
      
      echo -e "${GREEN}[+] å…¬é’¥å·²æˆåŠŸå†™å…¥.envæ–‡ä»¶${RESET}"
      echo -e "${GREEN}[+] å…¬é’¥: ${pubkey:0:16}...${pubkey: -16}${RESET}"
      break
    else
      echo -e "${RED}[-] å…¬é’¥æ ¼å¼é”™è¯¯${RESET}"
      echo -e "${YELLOW}[!] å½“å‰é•¿åº¦: ${#pubkey}ï¼Œéœ€è¦128ä½${RESET}"
      echo -e "${YELLOW}[!] è¯·æ£€æŸ¥å…¬é’¥æ˜¯å¦å®Œæ•´ä¸”ä»…åŒ…å«0-9å’Œa-få­—ç¬¦${RESET}"
    fi
  done
  
  pause_and_return
}

# ========= èŠ‚ç‚¹å¯åŠ¨å¢å¼ºç‰ˆ =========
function fix_and_start_node_enhanced() {
  echo -e "[*] ä¿®å¤å¹¶å¯åŠ¨èŠ‚ç‚¹ï¼ˆå¢å¼ºç‰ˆï¼‰..."
  
  if ! safe_cd_nockchain; then
    return
  fi
  
  # æ£€æŸ¥é…ç½®
  if [ ! -f "$ENV_FILE" ]; then
    echo -e "${RED}[-] .envæ–‡ä»¶ä¸å­˜åœ¨${RESET}"
    echo -e "${YELLOW}[!] è¯·å…ˆè®¾ç½®æŒ–çŸ¿å…¬é’¥${RESET}"
    pause_and_return
    return
  fi
  
  source "$ENV_FILE"
  if [ -z "$MINING_PUBKEY" ]; then
    echo -e "${RED}[-] æœªè®¾ç½®æŒ–çŸ¿å…¬é’¥${RESET}"
    echo -e "${YELLOW}[!] è¯·å…ˆè¿è¡Œé’±åŒ…ç”Ÿæˆå’Œå…¬é’¥è®¾ç½®${RESET}"
    pause_and_return
    return
  fi
  
  # å½»åº•æ¸…ç†è¿è¡Œç¯å¢ƒ
  echo -e "[*] æ¸…ç†è¿è¡Œç¯å¢ƒ..."
  pkill -f nockchain 2>/dev/null || true
  screen -XS nockchain quit 2>/dev/null || true
  
  # æ¸…ç†socketæ–‡ä»¶[4]
  find . -name "*.sock" -delete 2>/dev/null || true
  find /tmp -name "*nockchain*.sock" -delete 2>/dev/null || true
  rm -f .socket/nockchain_npc.sock 2>/dev/null || true
  
  # æ£€æŸ¥ç«¯å£å ç”¨
  if netstat -tlnp 2>/dev/null | grep -q ":3006 "; then
    echo -e "[*] ç«¯å£3006è¢«å ç”¨ï¼Œå°è¯•é‡Šæ”¾..."
    pid=$(netstat -tlnp 2>/dev/null | grep ":3006 " | awk '{print $7}' | cut -d'/' -f1 | head -1)
    if [ -n "$pid" ] && [ "$pid" != "-" ]; then
      kill -9 "$pid" 2>/dev/null || true
    fi
  fi
  
  sleep 5
  
  # åˆ›å»ºå¿…è¦ç›®å½•
  mkdir -p .socket test-leader logs
  chmod 755 .socket test-leader
  
  # è®¾ç½®ç¯å¢ƒ
  source "$HOME/.cargo/env" 2>/dev/null || true
  export PATH="$HOME/.cargo/bin:$PATH"
  
  # æŸ¥æ‰¾èŠ‚ç‚¹ç¨‹åº
  node_bin=""
  if command -v nockchain >/dev/null 2>&1; then
    node_bin="nockchain"
  elif [ -f "target/release/nockchain" ]; then
    node_bin="./target/release/nockchain"
  elif [ -f "target/debug/nockchain" ]; then
    node_bin="./target/debug/nockchain"
  else
    echo -e "${RED}[-] æœªæ‰¾åˆ°nockchainèŠ‚ç‚¹ç¨‹åº${RESET}"
    echo -e "${YELLOW}[!] è¯·å…ˆå®Œæˆæ„å»º${RESET}"
    pause_and_return
    return
  fi
  
  echo -e "${GREEN}[+] ä½¿ç”¨èŠ‚ç‚¹ç¨‹åº: $node_bin${RESET}"
  echo -e "${GREEN}[+] æŒ–çŸ¿å…¬é’¥: ${MINING_PUBKEY:0:16}...${MINING_PUBKEY: -16}${RESET}"
  
  # æ„å»ºå¯åŠ¨å‘½ä»¤[2][3]
  start_cmd="RUST_LOG=info $node_bin --mining-pubkey $MINING_PUBKEY \
--mine \
--peer /ip4/95.216.102.60/udp/3006/quic-v1 \
--peer /ip4/65.109.156.108/udp/3006/quic-v1 \
--peer /ip4/65.21.67.175/udp/3006/quic-v1 \
--peer /ip4/65.109.156.172/udp/3006/quic-v1 \
--peer /ip4/34.174.22.166/udp/3006/quic-v1 \
--npc-socket .socket/nockchain.sock \
--bind /ip4/0.0.0.0/udp/3006/quic-v1"
  
  # å¯åŠ¨èŠ‚ç‚¹
  if command -v screen >/dev/null 2>&1; then
    echo -e "[*] ä½¿ç”¨screenå¯åŠ¨èŠ‚ç‚¹..."
    screen -dmS nockchain bash -c "cd '$NCK_DIR' && $start_cmd 2>&1 | tee '$NODE_LOG'"
    sleep 5
    
    if screen -list | grep -qw "nockchain"; then
      echo -e "${GREEN}[+] âœ… èŠ‚ç‚¹å¯åŠ¨æˆåŠŸï¼${RESET}"
      echo -e "${BLUE}[i] Screenä¼šè¯: nockchain${RESET}"
      echo -e "${BLUE}[i] æŸ¥çœ‹æ—¥å¿—: screen -r nockchain${RESET}"
      echo -e "${BLUE}[i] é€€å‡ºæŸ¥çœ‹: Ctrl+A+D${RESET}"
      echo -e "${BLUE}[i] æ—¥å¿—æ–‡ä»¶: $NODE_LOG${RESET}"
    else
      echo -e "${RED}[-] èŠ‚ç‚¹å¯åŠ¨å¤±è´¥${RESET}"
    fi
  else
    echo -e "[*] ä½¿ç”¨åå°è¿›ç¨‹å¯åŠ¨èŠ‚ç‚¹..."
    nohup bash -c "$start_cmd" > "$NODE_LOG" 2>&1 &
    echo -e "${GREEN}[+] èŠ‚ç‚¹å·²åå°å¯åŠ¨${RESET}"
    echo -e "${BLUE}[i] æ—¥å¿—æ–‡ä»¶: $NODE_LOG${RESET}"
  fi
  
  pause_and_return
}

# ========= å…¶ä»–åŠŸèƒ½å‡½æ•° =========
function check_enhanced_status() {
  echo -e "[*] æ£€æŸ¥ç³»ç»ŸçŠ¶æ€ï¼ˆå¢å¼ºç‰ˆï¼‰..."
  
  echo -e "${BLUE}[i] ç›®å½•çŠ¶æ€:${RESET}"
  if [ -d "$NCK_DIR" ]; then
    echo -e "  âœ“ é¡¹ç›®ç›®å½•: $NCK_DIR"
  else
    echo -e "  âœ— é¡¹ç›®ç›®å½•ä¸å­˜åœ¨: $NCK_DIR"
    echo -e "${YELLOW}[!] è¯·å…ˆè¿è¡Œå®Œæ•´å®‰è£…${RESET}"
    pause_and_return
    return
  fi
  
  cd "$NCK_DIR" || return 1
  
  echo -e "${BLUE}[i] é…ç½®çŠ¶æ€:${RESET}"
  if [ -f "$ENV_FILE" ]; then
    source "$ENV_FILE" >/dev/null 2>&1
    if [ -n "$MINING_PUBKEY" ]; then
      echo -e "  âœ“ æŒ–çŸ¿å…¬é’¥: ${MINING_PUBKEY:0:16}...${MINING_PUBKEY: -16}"
    else
      echo -e "  âœ— æŒ–çŸ¿å…¬é’¥æœªè®¾ç½®"
    fi
  else
    echo -e "  âœ— .envæ–‡ä»¶ä¸å­˜åœ¨"
  fi
  
  echo -e "${BLUE}[i] ç»„ä»¶çŠ¶æ€:${RESET}"
  component_count=0
  
  for binary in "hoonc" "nockchain-wallet" "nockchain"; do
    if command -v "$binary" >/dev/null 2>&1; then
      binary_path=$(command -v "$binary")
      binary_size=$(du -h "$binary_path" 2>/dev/null | cut -f1 || echo "unknown")
      echo -e "  âœ“ $binary: $binary_size"
      ((component_count++))
    else
      echo -e "  âœ— $binary: æœªæ‰¾åˆ°"
    fi
  done
  
  echo -e "${BLUE}[i] æ„å»ºæˆåŠŸç‡: $component_count/3 ($(( component_count * 100 / 3 ))%)${RESET}"
  
  echo -e "${BLUE}[i] èŠ‚ç‚¹çŠ¶æ€:${RESET}"
  if command -v screen >/dev/null 2>&1 && screen -list | grep -qw "nockchain"; then
    echo -e "  âœ“ èŠ‚ç‚¹è¿è¡Œä¸­ (screen session)"
  elif pgrep -f "nockchain" >/dev/null 2>&1; then
    echo -e "  âœ“ èŠ‚ç‚¹è¿è¡Œä¸­ (background process)"
  else
    echo -e "  âœ— èŠ‚ç‚¹æœªè¿è¡Œ"
  fi
  
  echo -e "${BLUE}[i] ç³»ç»Ÿèµ„æº:${RESET}"
  echo -e "  å†…å­˜: $(free -h | grep Mem | awk '{print $3"/"$2" ("int($3/$2*100)"%)"}')"
  echo -e "  Swap: $(free -h | grep Swap | awk '{print $3"/"$2" ("int($3/$2*100)"%)"}')"
  echo -e "  ç£ç›˜: $(df -h . | tail -1 | awk '{print $3"/"$2" ("$5" used)"}')"
  
  # ç½‘ç»œçŠ¶æ€
  echo -e "${BLUE}[i] ç½‘ç»œçŠ¶æ€:${RESET}"
  if netstat -tlnp 2>/dev/null | grep -q ":3006"; then
    echo -e "  âœ“ ç«¯å£3006å·²ç»‘å®š"
  else
    echo -e "  - ç«¯å£3006æœªç»‘å®š"
  fi
  
  if [ $component_count -eq 3 ]; then
    echo -e "${GREEN}[+] âœ… ç³»ç»ŸçŠ¶æ€ä¼˜ç§€ï¼Œæ‰€æœ‰ç»„ä»¶å°±ç»ªï¼${RESET}"
  elif [ $component_count -ge 2 ]; then
    echo -e "${YELLOW}[!] ç³»ç»ŸçŠ¶æ€è‰¯å¥½ï¼Œå¤§éƒ¨åˆ†ç»„ä»¶å°±ç»ª${RESET}"
  else
    echo -e "${RED}[-] ç³»ç»ŸçŠ¶æ€ä¸ä½³ï¼Œéœ€è¦é‡æ–°æ„å»º${RESET}"
  fi
  
  pause_and_return
}

function cleanup_and_rebuild_enhanced() {
  echo -e "[*] æ¸…ç†ç¯å¢ƒå¹¶é‡æ–°æ„å»ºï¼ˆå¢å¼ºç‰ˆï¼‰..."
  
  echo -e "[*] åœæ­¢æ‰€æœ‰ç›¸å…³è¿›ç¨‹..."
  pkill -f cargo 2>/dev/null || true
  pkill -f rustc 2>/dev/null || true
  pkill -f nockchain 2>/dev/null || true
  screen -XS nockchain quit 2>/dev/null || true
  sleep 5
  
  echo -e "[*] æ¸…ç†æ„å»ºæ–‡ä»¶..."
  if [ -d "$NCK_DIR" ]; then
    cd "$NCK_DIR"
    cargo clean >/dev/null 2>&1 || true
    rm -rf target/ 2>/dev/null || true
    find . -name "*.sock" -delete 2>/dev/null || true
  fi
  
  echo -e "[*] æ¸…ç†Cargoç¼“å­˜..."
  rm -rf ~/.cargo/registry/cache/ 2>/dev/null || true
  rm -rf ~/.cargo/registry/index/ 2>/dev/null || true
  
  echo -e "[*] æ¸…ç†ç³»ç»Ÿç¼“å­˜..."
  sync
  sudo sysctl -w vm.drop_caches=3 >/dev/null 2>&1 || true
  
  echo -e "${GREEN}[+] ç¯å¢ƒæ¸…ç†å®Œæˆ${RESET}"
  echo -e "[*] å¼€å§‹é‡æ–°æ„å»º..."
  
  if [ -d "$NCK_DIR" ]; then
    build_components_step_by_step
  else
    echo -e "${RED}[-] é¡¹ç›®ç›®å½•ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œå®Œæ•´å®‰è£…${RESET}"
  fi
  
  pause_and_return
}

function view_node_logs_enhanced() {
  if command -v screen >/dev/null 2>&1 && screen -list | grep -qw "nockchain"; then
    echo -e "${YELLOW}[!] è¿›å…¥screenæ—¥å¿—æŸ¥çœ‹...${RESET}"
    echo -e "${BLUE}[i] ä½¿ç”¨ Ctrl+A+D é€€å‡ºæŸ¥çœ‹${RESET}"
    sleep 2
    screen -r nockchain
  elif [ -f "$NODE_LOG" ]; then
    echo -e "${YELLOW}[!] æ˜¾ç¤ºèŠ‚ç‚¹æ—¥å¿— (Ctrl+C é€€å‡º):${RESET}"
    tail -f "$NODE_LOG"
  else
    echo -e "${RED}[-] æ— å¯ç”¨çš„æ—¥å¿—æ–‡ä»¶${RESET}"
  fi
  pause_and_return
}

function stop_all_services_enhanced() {
  echo -e "[*] åœæ­¢æ‰€æœ‰NockchainæœåŠ¡ï¼ˆå¢å¼ºç‰ˆï¼‰..."
  
  if command -v screen >/dev/null 2>&1 && screen -list | grep -qw "nockchain"; then
    screen -S nockchain -X quit >/dev/null 2>&1
    echo -e "${GREEN}[+] Screenä¼šè¯å·²ç»ˆæ­¢${RESET}"
  fi
  
  for process in "nockchain" "nockchain-wallet" "hoonc"; do
    if pgrep -f "$process" >/dev/null 2>&1; then
      pkill -f "$process" >/dev/null 2>&1
      echo -e "${GREEN}[+] $process è¿›ç¨‹å·²ç»ˆæ­¢${RESET}"
    fi
  done
  
  if [ -d "$NCK_DIR" ]; then
    cd "$NCK_DIR"
    find . -name "*.sock" -delete 2>/dev/null || true
  fi
  
  sleep 3
  
  echo -e "[*] éªŒè¯æœåŠ¡åœæ­¢çŠ¶æ€..."
  if ! pgrep -f "nockchain" >/dev/null 2>&1; then
    echo -e "${GREEN}[+] âœ… æ‰€æœ‰æœåŠ¡å·²å®Œå…¨åœæ­¢${RESET}"
  else
    echo -e "${YELLOW}[!] éƒ¨åˆ†æœåŠ¡å¯èƒ½ä»åœ¨è¿è¡Œ${RESET}"
  fi
  
  pause_and_return
}

function pause_and_return() {
  echo ""
  read -n1 -r -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..." key
  main_menu
}

# ========= ä¸»èœå• =========
function main_menu() {
  show_banner
  echo "è¯·é€‰æ‹©æ“ä½œ:"
  echo ""
  echo "ğŸš€ å®‰è£…å’Œæ„å»º:"
  echo "  1) ğŸ¯ å®Œæ•´å®‰è£… (æ„å»ºå¤±è´¥ä¿®å¤ç‰ˆ)"
  echo "  2) ğŸ”§ åˆ†æ­¥éª¤é‡æ–°æ„å»º"
  echo "  3) ğŸ§¹ æ¸…ç†ç¯å¢ƒå¹¶é‡å»º"
  echo ""
  echo "ğŸ”‘ é’±åŒ…ç®¡ç†:"
  echo "  4) ğŸ”‘ ç”Ÿæˆé’±åŒ… (å¢å¼ºç‰ˆ)"
  echo "  5) ğŸ“ è®¾ç½®æŒ–çŸ¿å…¬é’¥ (å¢å¼ºç‰ˆ)"
  echo ""
  echo "âš¡ èŠ‚ç‚¹ç®¡ç†:"
  echo "  6) âš¡ å¯åŠ¨èŠ‚ç‚¹ (å¢å¼ºç‰ˆ)"
  echo "  7) ğŸ“Š æŸ¥çœ‹èŠ‚ç‚¹æ—¥å¿—"
  echo "  8) â¹ï¸  åœæ­¢æ‰€æœ‰æœåŠ¡"
  echo ""
  echo "ğŸ” çŠ¶æ€å’Œè¯Šæ–­:"
  echo "  9) ğŸ” æ£€æŸ¥ç³»ç»ŸçŠ¶æ€ (å¢å¼ºç‰ˆ)"
  echo ""
  echo "  0) é€€å‡ºè„šæœ¬"
  echo ""
  echo -e "${CYAN}ğŸ’¡ æ„å»ºå¤±è´¥ä¿®å¤ç‰ˆ: ä¸“é—¨è§£å†³make buildå’Œinstallå¤±è´¥é—®é¢˜${RESET}"
  echo -e "${CYAN}ğŸ’¡ å¢å¼ºå†…å­˜ç®¡ç†: è‡ªåŠ¨é…ç½®swapï¼Œæ”¯æŒä½å†…å­˜ç¯å¢ƒ${RESET}"
  echo -e "${CYAN}ğŸ’¡ åˆ†æ­¥éª¤æ„å»º: æé«˜æ„å»ºæˆåŠŸç‡ï¼Œæ™ºèƒ½é”™è¯¯æ¢å¤${RESET}"
  echo ""
  read -p "è¯·è¾“å…¥ç¼–å· (0-9): " choice

  case "$choice" in
    1) complete_installation_fixed ;;
    2) 
      if ensure_nockchain_directory; then
        build_components_step_by_step
        pause_and_return
      fi
      ;;
    3) cleanup_and_rebuild_enhanced ;;
    4) generate_wallet_enhanced ;;
    5) set_mining_pubkey_enhanced ;;
    6) fix_and_start_node_enhanced ;;
    7) view_node_logs_enhanced ;;
    8) stop_all_services_enhanced ;;
    9) check_enhanced_status ;;
    0) echo "é€€å‡ºè„šæœ¬."; exit 0 ;;
    *) echo -e "${RED}[-] æ— æ•ˆé€‰é¡¹ï¼Œè¯·è¾“å…¥0-9${RESET}"; pause_and_return ;;
  esac
}

# æ£€æŸ¥ç”¨æˆ·æƒé™
if [ "$EUID" -eq 0 ]; then
  echo -e "${RED}[-] è¯·ä¸è¦ä»¥rootç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬${RESET}"
  exit 1
fi

# å¯åŠ¨ä¸»èœå•
main_menu
