#!/bin/bash

# ==============================================================================
# Nockchain å®‰è£…ä¸æŒ–çŸ¿åŠ©æ‰‹
# ------------------------------------------------------------------------------
# ä½œè€…: K2 èŠ‚ç‚¹æ•™ç¨‹åˆ†äº«
# Telegram: https://t.me/+EaCiFDOghoM3Yzll
# Twitter:  https://x.com/BtcK241918
# ==============================================================================

# è®¾ç½®è„šæœ¬å¥å£®æ€§é€‰é¡¹
# -u: é‡åˆ°æœªè®¾ç½®çš„å˜é‡æ—¶æŠ¥é”™
# -o pipefail: ç®¡é“å‘½ä»¤ä¸­ä»»ä½•ä¸€ä¸ªå‘½ä»¤å¤±è´¥ï¼Œæ•´ä¸ªç®¡é“å°±å¤±è´¥
set -uo pipefail

# å¦‚æœä½ åœ¨éäº¤äº’å¼ä¼šè¯ä¸­è¿è¡Œï¼Œæˆ–è€…å¸Œæœ›é˜²æ­¢ shell è‡ªèº«è¶…æ—¶ï¼Œå¯ä»¥è®¾ç½® TMOUTã€‚
# ä½†å¯¹äº SSH ä¼šè¯ï¼Œä¸‹é¢çš„ keep-alive æœºåˆ¶æ›´ç›´æ¥ã€‚
# export TMOUT=0 # è®¾ç½®ä¸º0è¡¨ç¤ºæ°¸ä¸è¶…æ—¶ï¼Œéœ€è¦æ—¶å–æ¶ˆæ³¨é‡Š

# ========= è‰²å½©å®šä¹‰ =========
RESET='\033[0m'
BOLD='\033[1m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'

# ========= é¡¹ç›®è·¯å¾„ =========
NCK_DIR="$HOME/nockchain"
ENV_FILE="$NCK_DIR/.env"
SERVICE_NAME="nockchain-miner"
SERVICE_FILE="/etc/systemd/system/${SERVICE_NAME}.service"

# ========= SSH è¿æ¥ä¿æŒæ´»è·ƒå˜é‡ =========
SSH_KEEP_ALIVE_PID=""

# ========= æ¨ªå¹… =========
function show_banner() {
  clear
  echo -e "${BOLD}${BLUE}"
  echo "==============================================="
  echo "         Nockchain å®‰è£…ä¸æŒ–çŸ¿åŠ©æ‰‹"
  echo "==============================================="
  echo -e "${RESET}"
  echo "ğŸ”§ å¢å¼ºç¼–è¯‘å¹¶è¡Œåº¦ï¼Œé…ç½®æŒ–çŸ¿çº¿ç¨‹æ•°"
  echo "ğŸš€ ${BOLD}æ›´å¼ºå¤§çš„æŒ–çŸ¿é”„å¤´ï¼šé‡‡ç”¨ Systemd æœåŠ¡ç®¡ç†ï¼Œæå‡ç¨³å®šæ€§ä¸æ€§èƒ½ï¼${RESET}"
  echo "ğŸ“Œ ä½œè€…: K2 èŠ‚ç‚¹æ•™ç¨‹åˆ†äº«"
  echo "ğŸ”— Telegram: https://t.me/+EaCiFDOghoM3Yzll"
  echo "ğŸ¦ Twitter:  https://x.com/BtcK241918"
  echo "-----------------------------------------------"
  echo ""
}

# ========= å¸¸ç”¨å‡½æ•° =========

# æ£€æŸ¥å‘½ä»¤æ˜¯å¦å­˜åœ¨
function check_command() {
    local cmd="$1"
    if ! command -v "$cmd" &>/dev/null; then
        echo -e "${RED}[-] é”™è¯¯: å‘½ä»¤ '$cmd' æœªæ‰¾åˆ°ã€‚è¯·ç¡®ä¿å·²å®‰è£…æˆ–åœ¨ PATH ä¸­ã€‚${RESET}"
        return 1
    fi
    return 0
}

# è·å–CPUæ ¸å¿ƒæ•°ï¼ˆå…¼å®¹ä¸åŒç³»ç»Ÿï¼‰
function get_num_cores() {
    local cores
    if check_command nproc; then
        cores=$(nproc)
    elif check_command sysctl; then # macOS/BSD
        cores=$(sysctl -n hw.ncpu)
    else
        echo -e "${YELLOW}[!] è­¦å‘Š: æ— æ³•è‡ªåŠ¨æ£€æµ‹CPUæ ¸å¿ƒæ•°ï¼Œé»˜è®¤ä¸º 2ã€‚${RESET}"
        cores=2 # é»˜è®¤å€¼
    fi
    echo "$cores"
}

# åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
function cd_nck_dir() {
  if [ -d "$NCK_DIR" ]; then
    cd "$NCK_DIR" || { echo -e "${RED}[-] æ— æ³•è¿›å…¥é¡¹ç›®ç›®å½•: $NCK_DIR${RESET}"; return 1; }
  else
    echo -e "${RED}[-] é¡¹ç›®ç›®å½•ä¸å­˜åœ¨: $NCK_DIR${RESET}"
    return 1
  fi
  return 0
}

# æš‚åœå¹¶è¿”å›ä¸»èœå•
function pause_and_return() {
  echo ""
  read -r -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..." -s -n 1 # -s éšè—è¾“å…¥ï¼Œ-n 1 åªè¯»å–ä¸€ä¸ªå­—ç¬¦
  echo # æ¢è¡Œï¼Œå› ä¸º -s ä¸ä¼šæ¢è¡Œ
  main_menu
}

# æ£€æŸ¥æœ€ä½ç£ç›˜ç©ºé—´ (ä¾‹å¦‚ï¼Œ5GB)
function check_disk_space() {
    local required_gb=5
    local available_kb

    # å°è¯•ä½¿ç”¨ df -k å¹¶è§£æï¼Œå…¼å®¹æ€§æ›´å¥½
    # awk '{print $4}' è·å–ç¬¬å››åˆ— (Available)
    # tail -n 1 ç¡®ä¿åªå–æœ€åä¸€è¡Œ (é€šå¸¸æ˜¯ç£ç›˜æŒ‚è½½ç‚¹ä¿¡æ¯)
    available_kb=$(df -k "$HOME" 2>/dev/null | awk 'NR==2 {print $4}')

    if [ -z "$available_kb" ]; then
        echo -e "${YELLOW}[!] è­¦å‘Š: æ— æ³•æ£€æŸ¥ç£ç›˜ç©ºé—´ï¼Œè¯·æ‰‹åŠ¨ç¡®è®¤æ‚¨çš„ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³ã€‚${RESET}"
        return 0 # ä¸é˜»æ­¢æ‰§è¡Œ
    fi

    local available_gb=$((available_kb / 1024 / 1024))

    if [ "$available_gb" -lt "$required_gb" ]; then
        echo -e "${RED}[-] é”™è¯¯: ç£ç›˜ç©ºé—´ä¸è¶³! è‡³å°‘éœ€è¦ ${required_gb}GBï¼Œå½“å‰å¯ç”¨ ${available_gb}GBã€‚${RESET}"
        echo -e "${RED}    è¯·æ¸…ç†ç£ç›˜ç©ºé—´åå†è¿è¡Œã€‚${RESET}"
        return 1 # é˜»æ­¢æ‰§è¡Œ
    else
        echo -e "${GREEN}[+] ç£ç›˜ç©ºé—´æ£€æŸ¥é€šè¿‡ï¼Œå¯ç”¨ ${available_gb}GBã€‚${RESET}"
        return 0 # å…è®¸æ‰§è¡Œ
    fi
}

# æŸ¥æ‰¾å¹¶æ‰§è¡Œ Nockchain äºŒè¿›åˆ¶æ–‡ä»¶
# å‚æ•°: binary_name (ä¾‹å¦‚: nockchain-wallet), ...args
function run_nockchain_binary() {
    local binary_name="$1"
    shift # ç§»é™¤ç¬¬ä¸€ä¸ªå‚æ•° (binary_name)
    local args="$@"

    local binary_path=""

    # 1. å°è¯•ä» PATH ä¸­æŸ¥æ‰¾ (make install åçš„ç†æƒ³è·¯å¾„)
    if command -v "$binary_name" &>/dev/null; then
        binary_path=$(command -v "$binary_name")
        echo -e "[*] æ­£åœ¨ä½¿ç”¨ PATH ä¸­çš„ '$binary_path'${RESET}"
    # 2. å°è¯•ä» NCK_DIR/target/release ä¸­æŸ¥æ‰¾ (ç›´æ¥ç¼–è¯‘åçš„è·¯å¾„)
    elif [ -x "$NCK_DIR/target/release/$binary_name" ]; then
        binary_path="$NCK_DIR/target/release/$binary_name"
        echo -e "[*] æ­£åœ¨ä½¿ç”¨é¡¹ç›®ç›®å½•ä¸­çš„ '$binary_path'${RESET}"
    else
        echo -e "${RED}[-] é”™è¯¯: æ‰¾ä¸åˆ°å¯æ‰§è¡Œæ–‡ä»¶ '$binary_name'ã€‚è¯·ç¡®ä¿å·²ç¼–è¯‘å¹¶å®‰è£… (è¿è¡Œé€‰é¡¹ 1)ã€‚${RESET}"
        return 1
    fi

    # æ‰§è¡Œå‘½ä»¤
    "$binary_path" $args || {
        echo -e "${RED}[-] å‘½ä»¤ '$binary_name $args' æ‰§è¡Œå¤±è´¥${RESET}"
        return 1
    }
    return 0
}

# ========= SSH è¿æ¥ä¿æŒæ´»è·ƒå‡½æ•° =========
# åœ¨åå°å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹ï¼Œå‘¨æœŸæ€§åœ°å‘é€ç©ºå­—ç¬¦åˆ°æ ‡å‡†è¾“å‡ºï¼Œä»¥é˜²æ­¢ SSH ä¼šè¯å› ä¸æ´»åŠ¨è€Œæ–­å¼€ã€‚
function start_ssh_keep_alive() {
    echo -e "${BLUE}[*] å¯åŠ¨ SSH è¿æ¥ä¿æŒæ´»åŠ¨è¿›ç¨‹...${RESET}"
    # æ¯ 30 ç§’å‘é€ä¸€ä¸ªç©ºè¡Œï¼ŒæŠ‘åˆ¶å…¶è¾“å‡ºï¼Œå¹¶åœ¨åå°è¿è¡Œ
    while true; do
        echo -n ""
        sleep 30
    done > /dev/null 2>&1 &
    SSH_KEEP_ALIVE_PID=$! # å­˜å‚¨åå°è¿›ç¨‹çš„ PID
    echo -e "${GREEN}[+] SSH è¿æ¥ä¿æŒæ´»åŠ¨è¿›ç¨‹å·²å¯åŠ¨ (PID: $SSH_KEEP_ALIVE_PID)${RESET}"
}

# åœæ­¢ SSH è¿æ¥ä¿æŒæ´»åŠ¨è¿›ç¨‹
function stop_ssh_keep_alive() {
    if [ -n "$SSH_KEEP_ALIVE_PID" ] && kill -0 "$SSH_KEEP_ALIVE_PID" 2>/dev/null; then
        echo -e "${BLUE}[*] åœæ­¢ SSH è¿æ¥ä¿æŒæ´»åŠ¨è¿›ç¨‹ (PID: $SSH_KEEP_ALIVE_PID)...${RESET}"
        kill "$SSH_KEEP_ALIVE_PID" > /dev/null 2>&1 # æ€æ­»è¿›ç¨‹å¹¶æŠ‘åˆ¶é”™è¯¯è¾“å‡º
        wait "$SSH_KEEP_ALIVE_PID" 2>/dev/null || true # ç­‰å¾…è¿›ç¨‹ç»ˆæ­¢ï¼Œå¿½ç•¥é”™è¯¯
        echo -e "${GREEN}[+] SSH è¿æ¥ä¿æŒæ´»åŠ¨è¿›ç¨‹å·²åœæ­¢${RESET}"
    fi
    SSH_KEEP_ALIVE_PID="" # æ¸…ç©º PID å˜é‡
}

# æ•è·è„šæœ¬é€€å‡ºæˆ–ä¸­æ–­ä¿¡å·ï¼Œç¡®ä¿åœæ­¢ SSH keep-alive è¿›ç¨‹
trap 'stop_ssh_keep_alive' EXIT SIGINT SIGTERM

# ========= é…ç½®å‡½æ•° =========

# ç¡®ä¿ .env æ–‡ä»¶å­˜åœ¨å¹¶åŒ…å«å¿…è¦çš„å˜é‡
function configure_mining_env() {
  echo -e "[*] æ£€æŸ¥å¹¶è®¾ç½® .env æ–‡ä»¶ä¸­çš„æŒ–çŸ¿ç›¸å…³é…ç½®..."
  local env_file="$1"
  local num_cores=$(get_num_cores)

  # å¤åˆ¶ç¤ºä¾‹æ–‡ä»¶å¦‚æœ .env ä¸å­˜åœ¨
  if [ ! -f "$env_file" ]; then
    if [ -f "$NCK_DIR/.env_example" ]; then
      cp -n "$NCK_DIR/.env_example" "$env_file"
      echo -e "${GREEN}[+] å·²ä» .env_example åˆ›å»º $env_file${RESET}"
    else
      echo -e "${RED}[-] é”™è¯¯: æ‰¾ä¸åˆ° .env_example æ–‡ä»¶ï¼Œæ— æ³•åˆ›å»º .env${RESET}"
      return 1
    fi
  fi

  # ç¡®ä¿ MINING_PUBKEY å­˜åœ¨ (ä»…æ£€æŸ¥ï¼Œä¸è‡ªåŠ¨è®¾ç½®ï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨æˆ–é€šè¿‡èœå•è®¾ç½®)
  if ! grep -q '^MINING_PUBKEY=' "$env_file"; then
    echo -e "${YELLOW}[!] æ¸©é¦¨æç¤º: .env æ–‡ä»¶ä¸­ç¼ºå°‘ MINING_PUBKEYï¼Œè¯·è¿è¡Œé€‰é¡¹ 2/3 ç”Ÿæˆ/è®¾ç½®æ‚¨çš„å…¬é’¥!${RESET}"
  fi

  # ç¡®ä¿ MINER_THREADS å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æ·»åŠ ï¼Œé»˜è®¤ä¸ºæ ¸å¿ƒæ•°
  if ! grep -q '^MINER_THREADS=' "$env_file"; then
    echo -e "${YELLOW}[!] .env æ–‡ä»¶ä¸­ç¼ºå°‘ MINER_THREADSï¼Œå°†æ·»åŠ é»˜è®¤å€¼ (CPUæ ¸å¿ƒæ•°: $num_cores)${RESET}"
    # ä½¿ç”¨ sed æ·»åŠ ï¼Œç¡®ä¿ä¸é‡å¤æ·»åŠ 
    if ! grep -q '^# æŒ–çŸ¿çº¿ç¨‹æ•°' "$env_file"; then
        echo "" >> "$env_file" # æ·»åŠ ä¸€ä¸ªç©ºè¡Œç¡®ä¿æ ¼å¼
        echo "# æŒ–çŸ¿çº¿ç¨‹æ•°ï¼Œå»ºè®®è®¾ç½®ä¸ºæ‚¨çš„CPUæ ¸å¿ƒæ•°" >> "$env_file"
    fi
    echo "MINER_THREADS=$num_cores" >> "$env_file"
    echo -e "${GREEN}[+] å·²æ·»åŠ  MINER_THREADS=$num_cores åˆ° $env_file${RESET}"
  else
    local current_threads=$(grep '^MINER_THREADS=' "$env_file" | cut -d'=' -f2)
    echo -e "[*] .env æ–‡ä»¶ä¸­å·²å­˜åœ¨ MINER_THREADS=$current_threads"
  fi

  return 0
}

function set_pubkey_env() {
  echo -e "[*] è®¾ç½® MINING_PUBKEY åˆ° .env..."
  if ! cd_nck_dir; then pause_and_return; return; fi

  read -r -p "è¯·è¾“å…¥å…¬é’¥ (MINING_PUBKEY): " pubkey
  if [ -z "$pubkey" ]; then
    echo -e "${RED}[-] å…¬é’¥ä¸èƒ½ä¸ºç©º${RESET}"
    pause_and_return
    return
  fi

  # ä½¿ç”¨ sed åˆ é™¤æ—§è¡Œå¹¶æ·»åŠ æ–°è¡Œ (å…¼å®¹ GNU/BSD sed)
  if grep -q '^MINING_PUBKEY=' "$ENV_FILE"; then
    if ! sed -i "/^MINING_PUBKEY=/c\MINING_PUBKEY=$pubkey" "$ENV_FILE" 2>/dev/null && \
       ! sed -i "" "/^MINING_PUBKEY=/c\MINING_PUBKEY=$pubkey" "$ENV_FILE" 2>/dev/null; then
      echo -e "${RED}[-] è­¦å‘Š: æ— æ³•æ›´æ–° MINING_PUBKEY åˆ° $ENV_FILEï¼Œè¯·æ‰‹åŠ¨ç¼–è¾‘ã€‚${RESET}"
      pause_and_return
      return
    fi
    echo -e "${GREEN}[+] å·²æ›´æ–° MINING_PUBKEY åˆ° $ENV_FILE${RESET}"
  else
    # å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ·»åŠ 
    echo "" >> "$ENV_FILE" # ç¡®ä¿åœ¨æœ«å°¾æ·»åŠ æ—¶æ ¼å¼æ­£ç¡®
    echo "MINING_PUBKEY=$pubkey" >> "$ENV_FILE"
    echo -e "${GREEN}[+] å·²æ·»åŠ  MINING_PUBKEY=$pubkey åˆ° $ENV_FILE${RESET}"
  fi

  if grep -q "MINING_PUBKEY=$pubkey" "$ENV_FILE"; then
      echo -e "${GREEN}[+] MINING_PUBKEY=$pubkey å·²æˆåŠŸå†™å…¥/æ›´æ–°åˆ° .env${RESET}"
      # é‡æ–°åŠ è½½ .env ä½¿é…ç½®ç”Ÿæ•ˆ for this script run
      . "$ENV_FILE" # POSIX `.` å‘½ä»¤æ›¿ä»£ `source`
  else
      echo -e "${RED}[-] å†™å…¥ MINING_PUBKEY åˆ° .env å¤±è´¥${RESET}"
  fi

  pause_and_return
}

function set_miner_threads_env() {
  echo -e "[*] è®¾ç½® MINER_THREADS åˆ° .env..."
  if ! cd_nck_dir; then pause_and_return; return; fi

  local max_cores=$(get_num_cores)
  echo "æ‚¨çš„ç³»ç»Ÿæ£€æµ‹åˆ°æœ‰ ${max_cores} ä¸ª CPU æ ¸å¿ƒã€‚"
  read -r -p "è¯·è¾“å…¥æŒ–çŸ¿çº¿ç¨‹æ•° (MINER_THREADSï¼Œå»ºè®®ä¸è¶…è¿‡æ ¸å¿ƒæ•° $max_cores): " threads
  if [ -z "$threads" ]; then
    echo -e "${RED}[-] çº¿ç¨‹æ•°ä¸èƒ½ä¸ºç©º${RESET}"
    pause_and_return
    return
  fi

  # éªŒè¯è¾“å…¥æ˜¯å¦ä¸ºéè´Ÿæ•°å­—
  if ! echo "$threads" | grep -q '^[0-9]\+$'; then # POSIX å…¼å®¹çš„æ•°å­—æ£€æŸ¥
    echo -e "${RED}[-] è¾“å…¥æ— æ•ˆï¼Œè¯·è¾“å…¥ä¸€ä¸ªéè´Ÿæ•°å­—${RESET}"
    pause_and_return
    return
  fi

   # ä½¿ç”¨ sed åˆ é™¤æ—§è¡Œå¹¶æ·»åŠ æ–°è¡Œ (å…¼å®¹ GNU/BSD sed)
  if grep -q '^MINER_THREADS=' "$ENV_FILE"; then
    if ! sed -i "/^MINER_THREADS=/c\MINER_THREADS=$threads" "$ENV_FILE" 2>/dev/null && \
       ! sed -i "" "/^MINER_THREADS=/c\MINER_THREADS=$threads" "$ENV_FILE" 2>/dev/null; then
      echo -e "${RED}[-] è­¦å‘Š: æ— æ³•æ›´æ–° MINER_THREADS åˆ° $ENV_FILEï¼Œè¯·æ‰‹åŠ¨ç¼–è¾‘ã€‚${RESET}"
      pause_and_return
      return
    fi
    echo -e "${GREEN}[+] å·²æ›´æ–° MINER_THREADS=$threads åˆ° $ENV_FILE${RESET}"
  else
    # å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ·»åŠ 
     if ! grep -q '^# æŒ–çŸ¿çº¿ç¨‹æ•°' "$ENV_FILE"; then
        echo "" >> "$ENV_FILE" # ç¡®ä¿åœ¨æœ«å°¾æ·»åŠ æ—¶æ ¼å¼æ­£ç¡®
        echo "# æŒ–çŸ¿çº¿ç¨‹æ•°ï¼Œå»ºè®®è®¾ç½®ä¸ºæ‚¨çš„CPUæ ¸å¿ƒæ•°" >> "$ENV_FILE"
    fi
    echo "MINER_THREADS=$threads" >> "$ENV_FILE"
    echo -e "${GREEN}[+] å·²æ·»åŠ  MINER_THREADS=$threads åˆ° $ENV_FILE${RESET}"
  fi

  if grep -q "MINER_THREADS=$threads" "$ENV_FILE"; then
      echo -e "${GREEN}[+] MINER_THREADS=$threads å·²æˆåŠŸå†™å…¥/æ›´æ–°åˆ° .env${RESET}"
      echo -e "${YELLOW}[!] æ³¨æ„: å¯åŠ¨èŠ‚ç‚¹è„šæœ¬ (run_nockchain_miner.sh) éœ€è¦è¯»å–å¹¶ä½¿ç”¨è¿™ä¸ªå˜é‡æ‰èƒ½ç”Ÿæ•ˆã€‚${RESET}"
      # é‡æ–°åŠ è½½ .env ä½¿é…ç½®ç”Ÿæ•ˆ for this script run
      . "$ENV_FILE" # POSIX `.` å‘½ä»¤æ›¿ä»£ `source`
  else
      echo -e "${RED}[-] å†™å…¥ MINER_THREADS åˆ° .env å¤±è´¥${RESET}"
  fi

  pause_and_return
}


# ========= å®‰è£…æ„å»ºå‡½æ•° =========
function setup_all() {
  show_banner # åœ¨å®‰è£…å‰å†æ¬¡æ˜¾ç¤ºæ¨ªå¹…

  # åœ¨é•¿æ—¶é—´æ“ä½œå‰å¯åŠ¨ SSH keep-alive
  start_ssh_keep_alive

  local exit_code=0 # ç”¨äºæ•è·å®‰è£…å­è¿›ç¨‹çš„é€€å‡ºç 

  # å°†æ‰€æœ‰å®‰è£…æ­¥éª¤æ”¾å…¥ä¸€ä¸ªå­ shellï¼Œå¹¶åœ¨å…¶ä¸­å¯ç”¨ `set -e`ï¼Œä»¥ä¾¿ä»»ä½•å‘½ä»¤å¤±è´¥éƒ½èƒ½ç«‹å³é€€å‡ºå­ shell
  (
    set -e # ä»»ä½•å‘½ä»¤å¤±è´¥éƒ½ç«‹å³é€€å‡ºå­ shell

    # æå‰æ£€æŸ¥å…³é”®å‘½ä»¤
    if ! check_command sudo || ! check_command git || ! check_command curl; then
        echo -e "${RED}[-] ç¼ºå°‘å¿…è¦çš„ç³»ç»Ÿå‘½ä»¤ (sudo, git, curl)ï¼Œè¯·å…ˆæ‰‹åŠ¨å®‰è£…ã€‚${RESET}"
        exit 1 # é€€å‡ºå­ shell
    fi

    # æ£€æŸ¥ç£ç›˜ç©ºé—´
    echo -e "[*] æ£€æŸ¥ç£ç›˜ç©ºé—´..."
    check_disk_space || exit 1

    echo -e "[*] å®‰è£…ç³»ç»Ÿä¾èµ– (build-essential, clang, llvm-dev, libclang-dev, pkg-config, libssl-dev, cmake, make, systemd)..."
    sudo apt update
    # ç¡®ä¿å®‰è£… systemd å·¥å…·
    if check_command systemctl; then
        sudo apt install -y clang llvm-dev libclang-dev pkg-config libssl-dev build-essential cmake git make
    else
        echo -e "${RED}[-] é”™è¯¯: æ‚¨çš„ç³»ç»Ÿä¸æ”¯æŒ systemdã€‚æ­¤è„šæœ¬ä¸»è¦ä¾èµ– systemd è¿›è¡ŒèŠ‚ç‚¹ç®¡ç†ã€‚${RESET}"
        echo -e "${RED}    å»ºè®®åœ¨æ”¯æŒ systemd çš„ Linux ç³»ç»Ÿä¸Šè¿è¡Œæ­¤è„šæœ¬ã€‚${RESET}"
        exit 1
    fi
    echo -e "${GREEN}[+] ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ${RESET}"

    echo -e "[*] å®‰è£… Rust..."
    if ! check_command cargo; then
      curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
      # ç«‹å³ä½¿ cargo åœ¨å½“å‰ shell session å¯ç”¨ (ç”¨äºåç»­ make å‘½ä»¤)
      export PATH="$HOME/.cargo/bin:$PATH"
      echo -e "${GREEN}[+] Rust å®‰è£…å®Œæˆ${RESET}"
    else
      echo -e "${YELLOW}[!] Rust å·²å®‰è£…ï¼Œè·³è¿‡å®‰è£…æ­¥éª¤${RESET}"
      # ç¡®ä¿å½“å‰ shell session æœ‰ cargoï¼Œå³ä½¿å·²ç»å®‰è£…
      export PATH="$HOME/.cargo/bin:$PATH"
    fi

    # ç¡®ä¿ cargo bin ç›®å½•åœ¨ PATH ä¸­ (æŒä¹…åŒ–)
    local rc_file=""
    case "$(basename "$SHELL")" in
        "bash") rc_file="$HOME/.bashrc" ;;
        "zsh") rc_file="$HOME/.zshrc" ;;
        *) rc_file="$HOME/.profile" # Fallback for other shells or non-interactive sessions
    esac

    if ! grep -q 'export PATH=.*\$HOME/\.cargo/bin:\$PATH' "$rc_file" 2>/dev/null; then
      echo '# Add Rust cargo bin to PATH' >> "$rc_file"
      echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> "$rc_file"
      echo -e "${GREEN}[+] å·²å°† Cargo æ·»åŠ åˆ° ${rc_file} çš„ PATH (å¯èƒ½éœ€è¦é‡æ–°ç™»å½•æˆ– '. ${rc_file}' ç”Ÿæ•ˆ)${RESET}"
    else
       echo -e "${YELLOW}[!] Cargo å·²åœ¨ ${rc_file} çš„ PATH ä¸­${RESET}"
    fi

    echo -e "[*] è·å–æˆ–æ›´æ–°ä»“åº“..."
    if [ -d "$NCK_DIR" ]; then
      echo -e "[*] é¡¹ç›®ç›®å½•å·²å­˜åœ¨ï¼Œå°è¯•æ‹‰å–æœ€æ–°ä»£ç ..."
      cd_nck_dir # åˆ‡æ¢åˆ°ç›®å½•ï¼Œå¦‚æœå¤±è´¥åˆ™ä¼šé€šè¿‡ set -e é€€å‡º
      git pull
      echo -e "${GREEN}[+] ä»“åº“å·²æ›´æ–°${RESET}"
    else
      echo -e "[*] å…‹éš†ä»“åº“åˆ° $NCK_DIR..."
      git clone https://github.com/zorp-corp/nockchain "$NCK_DIR"
      echo -e "${GREEN}[+] ä»“åº“å…‹éš†å®Œæˆ${RESET}"
      cd_nck_dir # åˆ‡æ¢åˆ°ç›®å½•ï¼Œå¦‚æœå¤±è´¥åˆ™ä¼šé€šè¿‡ set -e é€€å‡º
    fi

    # é…ç½® .env æ–‡ä»¶ï¼ŒåŒ…æ‹¬æŒ–çŸ¿çº¿ç¨‹æ•°
    configure_mining_env "$ENV_FILE"

    echo -e "[*] æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶..."
    # ç¡®ä¿ make å’Œ cargo å‘½ä»¤å­˜åœ¨
    if check_command make; then make clean || echo -e "${YELLOW}[!] make clean è­¦å‘Š: å¦‚æœé¦–æ¬¡æ„å»ºè¯·å¿½ç•¥æ­¤è­¦å‘Šã€‚${RESET}"; fi
    if check_command cargo; then cargo clean || echo -e "${YELLOW}[!] cargo clean è­¦å‘Š: å¦‚æœé¦–æ¬¡æ„å»ºè¯·å¿½ç•¥æ­¤è­¦å‘Šã€‚${RESET}"; fi
    echo -e "${GREEN}[+] æ¸…ç†å®Œæˆ (æˆ–å·²è·³è¿‡)${RESET}"

    # è®¾ç½® Rust ç¼–è¯‘ä¼˜åŒ–æ ‡å¿—
    export RUSTFLAGS="-C target-cpu=native -C opt-level=3"
    export CARGO_PROFILE_RELEASE_LTO="true"
    echo -e "${GREEN}[+] å·²è®¾ç½® Rust ç¼–è¯‘ä¼˜åŒ–æ ‡å¿—: RUSTFLAGS='$RUSTFLAGS', CARGO_PROFILE_RELEASE_LTO='$CARGO_PROFILE_RELEASE_LTO'${RESET}"

    local num_j_cores=$(get_num_cores) # ä½¿ç”¨å…¼å®¹æ€§å‡½æ•°è·å–æ ¸å¿ƒæ•°
    if [ "$num_j_cores" -eq 0 ]; then num_j_cores=1; fi # é¿å… -j 0 å¯¼è‡´çš„é—®é¢˜

    echo -e "[*] å®‰è£… hoonc (ä½¿ç”¨å¤šçº¿ç¨‹ç¼–è¯‘: make -j$num_j_cores)..."
    cd_nck_dir # å†æ¬¡ç¡®è®¤åœ¨æ­£ç¡®ç›®å½•
    make -j"$num_j_cores" install-hoonc
    echo -e "${GREEN}[+] hoonc å®‰è£…å®Œæˆ${RESET}"

    echo -e "[*] ç¼–è¯‘ Nockchain (ä½¿ç”¨å¤šçº¿ç¨‹ç¼–è¯‘: make -j$num_j_cores)..."
    cd_nck_dir # å†æ¬¡ç¡®è®¤åœ¨æ­£ç¡®ç›®å½•
    make -j"$num_j_cores" build
    echo -e "${GREEN}[+] Nockchain ç¼–è¯‘å®Œæˆ${RESET}"

    echo -e "[*] å®‰è£…é’±åŒ… (ä½¿ç”¨å¤šçº¿ç¨‹ç¼–è¯‘: make -j$num_j_cores)..."
    cd_nck_dir # å†æ¬¡ç¡®è®¤åœ¨æ­£ç¡®ç›®å½•
    make -j"$num_j_cores" install-nockchain-wallet
    echo -e "${GREEN}[+] é’±åŒ…å®‰è£…å®Œæˆ${RESET}"

    echo -e "[*] å®‰è£…èŠ‚ç‚¹ (ä½¿ç”¨å¤šçº¿ç¨‹ç¼–è¯‘: make -j$num_j_cores)..."
    cd_nck_dir # å†æ¬¡ç¡®è®¤åœ¨æ­£ç¡®ç›®å½•
    make -j"$num_j_cores" install-nockchain
    echo -e "${GREEN}[+] èŠ‚ç‚¹ç¨‹åºå®‰è£…å®Œæˆ${RESET}"

    # å¦‚æœæ‰€æœ‰å‘½ä»¤éƒ½æˆåŠŸï¼Œåˆ™å­ shell ä»¥ 0 é€€å‡ºç ç»“æŸ
  )
  exit_code=$? # æ•è·å­ shell çš„é€€å‡ºç 

  # åœæ­¢ SSH keep-aliveï¼Œæ— è®ºå®‰è£…æˆåŠŸä¸å¦
  stop_ssh_keep_alive

  if [ "$exit_code" -ne 0 ]; then
    echo -e "${RED}===============================================${RESET}"
    echo -e "${RED}[-] Nockchain å®‰è£…æˆ–æ„å»ºè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼è¯·æ£€æŸ¥ä¸Šè¿°æ—¥å¿—ã€‚${RESET}"
    echo -e "${RED}    å¦‚æœæŸä¸ª 'make' å‘½ä»¤å¤±è´¥ï¼Œæ‚¨å¯ä»¥å°è¯•è¿›å…¥ '$NCK_DIR' ç›®å½•ï¼Œæ‰‹åŠ¨æ‰§è¡Œå¤±è´¥çš„ 'make' å‘½ä»¤ä»¥æŸ¥çœ‹è¯¦ç»†é”™è¯¯ã€‚${RESET}"
    echo -e "${RED}===============================================${RESET}"
  else
    echo -e "${GREEN}===============================================${RESET}"
    echo -e "${GREEN}[+] Nockchain å®‰è£…å’Œæ„å»ºå·²æˆåŠŸå®Œæˆï¼${RESET}"
    echo -e "${GREEN}===============================================${RESET}"
    echo ""
    echo -e "${YELLOW}[!] ä¸‹ä¸€æ­¥é‡è¦äº‹é¡¹: ${RESET}"
    echo -e "${YELLOW}  1. ç”Ÿæˆæ‚¨çš„é’±åŒ…å¯†é’¥å¯¹ (èœå•é€‰é¡¹ 2)ã€‚${RESET}"
    echo -e "${YELLOW}  2. å°†ç”Ÿæˆçš„å…¬é’¥é…ç½®åˆ° .env æ–‡ä»¶ä¸­ (èœå•é€‰é¡¹ 3)ã€‚${RESET}"
    echo -e "${YELLOW}  3. æ£€æŸ¥ .env ä¸­çš„ MINER_THREADS é…ç½® (èœå•é€‰é¡¹ 11 å¯è®¾ç½®)ã€‚${RESET}"
    echo -e "${YELLOW}  4. å¯åŠ¨èŠ‚ç‚¹è¿›è¡ŒæŒ–çŸ¿ (èœå•é€‰é¡¹ 6) - æ¨èä½¿ç”¨ systemd æœåŠ¡ã€‚${RESET}"
    echo ""
  fi

  pause_and_return
}

# ========= é’±åŒ…æ“ä½œå‡½æ•° =========
function generate_wallet() {
  echo -e "[*] ç”Ÿæˆé’±åŒ…å¯†é’¥å¯¹..."
  if ! cd_nck_dir; then pause_and_return; return; fi

  # æ£€æŸ¥ç›®æ ‡ç›®å½•æ˜¯å¦æœ‰å†™å…¥æƒé™
  if [ ! -w "$NCK_DIR" ]; then
      echo -e "${RED}[-] é”™è¯¯: æ— æ³•åœ¨ $NCK_DIR ç›®å½•å†™å…¥æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥æƒé™ã€‚${RESET}"
      pause_and_return
      return
  fi

  echo -e "${YELLOW}[!] ç”Ÿæˆå¯†é’¥å¯¹çš„è¾“å‡ºä¼šåŒ…å«æ‚¨çš„ç§é’¥å’Œå…¬é’¥ï¼Œè¯·åŠ¡å¿…ä¿å­˜å¥½ï¼${RESET}"
  echo -e "${YELLOW}    ç‰¹åˆ«æ˜¯å…¬é’¥ï¼Œç¨åéœ€è¦é…ç½®åˆ° .env æ–‡ä»¶ä¸­ (MINING_PUBKEY)ã€‚${RESET}"
  echo -e "${YELLOW}    ç§é’¥ä¿å­˜åœ¨æ‚¨è¿è¡Œå‘½ä»¤çš„å½“å‰ç›®å½•ä¸‹çš„ wallet.keys æ–‡ä»¶ä¸­ã€‚${RESET}"
  echo "-----------------------------------------------"

  # åœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆ wallet.keys
  run_nockchain_binary "nockchain-wallet" keygen || {
    echo -e "${RED}[-] é’±åŒ…ç”Ÿæˆå¤±è´¥${RESET}"
    pause_and_return
    return
  }

  echo "-----------------------------------------------"
  echo -e "${GREEN}[+] é’±åŒ…å¯†é’¥å¯¹ç”Ÿæˆå®Œæˆ${RESET}"
  echo -e "${YELLOW}[!] å†æ¬¡æé†’ï¼šè¯·è®°å½•æ˜¾ç¤ºçš„å…¬é’¥ï¼Œå¹¶ä½¿ç”¨èœå•é€‰é¡¹ 3 å°†å…¶å†™å…¥ .env æ–‡ä»¶ä¸­çš„ MINING_PUBKEYã€‚${RESET}"
  echo -e "${YELLOW}[!] ç§é’¥å·²ä¿å­˜åˆ° $NCK_DIR/wallet.keys (è¯·å¦¥å–„ä¿ç®¡æ­¤æ–‡ä»¶ï¼)ã€‚${RESET}"

  pause_and_return
}

function export_keys() {
  echo -e "[*] å¯¼å‡ºé’±åŒ…å¯†é’¥åˆ°æ–‡ä»¶..."
  if ! cd_nck_dir; then pause_and_return; return; fi

  echo -e "${YELLOW}[!] å¯†é’¥æ–‡ä»¶åŒ…å«æ‚¨çš„ç§é’¥ï¼Œè¯·å¦¥å–„ä¿ç®¡å¯¼å‡ºæ–‡ä»¶ï¼${RESET}"
  echo -e "${YELLOW}    é»˜è®¤å¯¼å‡ºåˆ° $NCK_DIR/keys.export${RESET}"

  run_nockchain_binary "nockchain-wallet" export-keys || {
    echo -e "${RED}[-] å¯¼å‡ºå¯†é’¥å¤±è´¥${RESET}"
    pause_and_return
    return
  }

  echo -e "${GREEN}[+] å¯†é’¥å·²å¯¼å‡ºåˆ° $NCK_DIR/keys.export${RESET}"
  pause_and_return
}

function import_keys() {
  echo -e "[*] å¯¼å…¥é’±åŒ…å¯†é’¥æ–‡ä»¶..."
  if ! cd_nck_dir; then pause_and_return; return; fi

  read -r -p "[?] è¯·è¾“å…¥è¦å¯¼å…¥çš„å¯†é’¥æ–‡ä»¶è·¯å¾„ (é»˜è®¤: $NCK_DIR/keys.export): " keyfile_input
  keyfile=${keyfile_input:-"$NCK_DIR/keys.export"}

  if [ ! -f "$keyfile" ]; then
    echo -e "${RED}[-] é”™è¯¯: å¯†é’¥æ–‡ä»¶ '$keyfile' ä¸å­˜åœ¨${RESET}"
    pause_and_return
    return
  fi

  echo -e "[*] å°è¯•å¯¼å…¥ '$keyfile'..."
  run_nockchain_binary "nockchain-wallet" import-keys --input "$keyfile" || {
    echo -e "${RED}[-] å¯¼å…¥å¯†é’¥å¤±è´¥${RESET}"
    pause_and_return
    return
  }

  echo -e "${GREEN}[+] å¯†é’¥å·²æˆåŠŸå¯¼å…¥${RESET}"
  pause_and_return
}

# ========= èŠ‚ç‚¹æ“ä½œå‡½æ•° (Systemd) =========

function install_systemd_service() {
    echo -e "[*] æ£€æŸ¥æ˜¯å¦æ”¯æŒ systemd..."
    if ! check_command systemctl; then
        echo -e "${RED}[-] æ‚¨çš„ç³»ç»Ÿä¸æ”¯æŒ systemdã€‚${RESET}"
        echo -e "${RED}    æ­¤è„šæœ¬ä¸»è¦ä¾èµ– systemd è¿›è¡ŒèŠ‚ç‚¹ç®¡ç†ï¼Œå»ºè®®åœ¨æ”¯æŒ systemd çš„ Linux ç³»ç»Ÿä¸Šè¿è¡Œã€‚${RESET}"
        pause_and_return
        return 1
    fi

    echo -e "[*] åˆ›å»º systemd æœåŠ¡æ–‡ä»¶: $SERVICE_FILE..."
    if ! cd_nck_dir; then pause_and_return; return 1; fi

    # æ£€æŸ¥å¯åŠ¨è„šæœ¬æ˜¯å¦å­˜åœ¨å¹¶èµ‹äºˆæ‰§è¡Œæƒé™
    local run_script="./scripts/run_nockchain_miner.sh"
    if [ ! -f "$run_script" ]; then
        echo -e "${RED}[-] é”™è¯¯: æ‰¾ä¸åˆ°å¯åŠ¨è„šæœ¬ $run_scriptã€‚è¯·å…ˆè¿è¡Œé€‰é¡¹ 1 å®Œæˆå®‰è£…æ„å»ºã€‚${RESET}"
        pause_and_return
        return 1
    fi
    chmod +x "$run_script"

    # é‡æ–°åŠ è½½ .env ç¡®ä¿æœ€æ–°çš„é…ç½®è¢«è¯»å–
    if [ -f "$ENV_FILE" ]; then
        . "$ENV_FILE" # POSIX `.` å‘½ä»¤æ›¿ä»£ `source`
        echo -e "${GREEN}[+] å·²åŠ è½½ .env é…ç½®æ–‡ä»¶${RESET}"
    else
        echo -e "${RED}[-] è­¦å‘Š: .env æ–‡ä»¶ä¸å­˜åœ¨ï¼Œéƒ¨åˆ†é…ç½®å¯èƒ½ç¼ºå¤±ã€‚è¯·å…ˆè¿è¡Œé€‰é¡¹ 1 æˆ–æ‰‹åŠ¨åˆ›å»º .env${RESET}"
        pause_and_return # å¦‚æœ .env éƒ½ä¸å­˜åœ¨ï¼Œå¤§æ¦‚ç‡æ— æ³•å¯åŠ¨
        return 1
    fi

    # æ£€æŸ¥ MINING_PUBKEY æ˜¯å¦å·²è®¾ç½® (éç©º)
    if [ -z "${MINING_PUBKEY:-}" ]; then # ä½¿ç”¨ :- é˜²æ­¢æœªè®¾ç½®å˜é‡æŠ¥é”™ (set -u)
        echo -e "${RED}[-] é”™è¯¯: MINING_PUBKEY æœªåœ¨ .env æ–‡ä»¶ä¸­è®¾ç½®!${RESET}"
        echo "è¯·å…ˆè¿è¡Œèœå•é€‰é¡¹ 2 (ç”Ÿæˆé’±åŒ…) å’Œ 3 (è®¾ç½®å…¬é’¥) å®Œæˆé…ç½®ã€‚"
        pause_and_return
        return 1
    fi
    echo -e "[*] MINING_PUBKEY å·²é…ç½®: ${GREEN}$MINING_PUBKEY${RESET}"

    # æ£€æŸ¥ MINER_THREADS æ˜¯å¦å·²è®¾ç½® (éç©º)ï¼Œå¹¶æç¤º
    if [ -z "${MINER_THREADS:-}" ]; then # ä½¿ç”¨ :- é˜²æ­¢æœªè®¾ç½®å˜é‡æŠ¥é”™ (set -u)
        echo -e "${YELLOW}[!] è­¦å‘Š: MINER_THREADS æœªåœ¨ .env æ–‡ä»¶ä¸­è®¾ç½®ã€‚${RESET}"
        echo "    çŸ¿å·¥å¯èƒ½ä¼šä»¥é»˜è®¤çº¿ç¨‹æ•°è¿è¡Œ (é€šå¸¸ä¸ºå•çº¿ç¨‹)ã€‚å»ºè®®é€šè¿‡é€‰é¡¹ 11 è®¾ç½®ã€‚"
    else
        echo -e "[*] MINER_THREADS å·²é…ç½®: ${GREEN}$MINER_THREADS${RESET}"
    fi

    # åˆ›å»º systemd æœåŠ¡æ–‡ä»¶
    sudo bash -c "cat <<EOF > $SERVICE_FILE
[Unit]
Description=$SERVICE_NAME service
After=network.target

[Service]
User=$USER
Group=$USER
WorkingDirectory=$NCK_DIR
EnvironmentFile=$ENV_FILE
ExecStart=/bin/bash -c \"$NCK_DIR/scripts/run_nockchain_miner.sh\"
Restart=on-failure
RestartSec=5s
LimitNOFILE=65536 # Increase file descriptor limit for potential network connections

StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF"

    if [ $? -ne 0 ]; then
        echo -e "${RED}[-] é”™è¯¯: åˆ›å»º systemd æœåŠ¡æ–‡ä»¶å¤±è´¥ã€‚è¯·æ£€æŸ¥æƒé™æˆ–å°è¯•æ‰‹åŠ¨åˆ›å»ºã€‚${RESET}"
        pause_and_return
        return 1
    fi

    echo -e "${GREEN}[+] Systemd æœåŠ¡æ–‡ä»¶å·²åˆ›å»º: $SERVICE_FILE${RESET}"

    echo -e "[*] é‡è½½ systemd daemon..."
    sudo systemctl daemon-reload || { echo -e "${RED}[-] é”™è¯¯: systemctl daemon-reload å¤±è´¥${RESET}"; pause_and_return; return 1; }
    echo -e "${GREEN}[+] Systemd daemon å·²é‡è½½${RESET}"

    echo -e "[*] å¯ç”¨ $SERVICE_NAME æœåŠ¡ (å¼€æœºè‡ªå¯)..."
    sudo systemctl enable "$SERVICE_NAME" || { echo -e "${RED}[-] é”™è¯¯: systemctl enable å¤±è´¥${RESET}"; pause_and_return; return 1; }
    echo -e "${GREEN}[+] $SERVICE_NAME æœåŠ¡å·²å¯ç”¨${RESET}"

    echo -e "${GREEN}===============================================${RESET}"
    echo -e "${GREEN}[+] Nockchain æŒ–çŸ¿æœåŠ¡å·²æˆåŠŸå®‰è£…ä¸º systemd æœåŠ¡ï¼${RESET}"
    echo -e "${GREEN}    ç°åœ¨å¯ä»¥é€šè¿‡é€‰é¡¹ 6 æ¥å¯åŠ¨å®ƒã€‚${RESET}"
    echo -e "${GREEN}===============================================${RESET}"

    pause_and_return
}

function start_node_systemd() {
  echo -e "[*] å¯åŠ¨èŠ‚ç‚¹ (systemd æœåŠ¡: $SERVICE_NAME)..."
  if ! check_command systemctl; then
      echo -e "${RED}[-] æ‚¨çš„ç³»ç»Ÿä¸æ”¯æŒ systemdã€‚æ­¤åŠŸèƒ½ä¸å¯ç”¨ã€‚${RESET}"
      pause_and_return
      return
  fi

  if [ ! -f "$SERVICE_FILE" ]; then
      echo -e "${RED}[-] é”™è¯¯: systemd æœåŠ¡æ–‡ä»¶ '$SERVICE_FILE' ä¸å­˜åœ¨ã€‚è¯·å…ˆè¿è¡Œé€‰é¡¹ 6 (å®‰è£… Systemd æœåŠ¡)ã€‚${RESET}"
      pause_and_return
      return
  fi

  # æ£€æŸ¥å¹¶åœæ­¢æ—§çš„ screen ä¼šè¯ (ä»¥é˜²ä¸‡ä¸€ç”¨æˆ·ä» screen åˆ‡æ¢åˆ° systemd)
  if screen -list | grep -q "nockchain"; then
    echo "[*] æ£€æµ‹åˆ°æ—§çš„ 'nockchain' screen ä¼šè¯ï¼Œå°è¯•å…³é—­..."
    screen -S nockchain -X quit || {
      echo -e "${YELLOW}[!] è­¦å‘Š: æ— æ³•å…³é—­æ—§çš„ screen ä¼šè¯ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨æ“ä½œ: screen -S nockchain -X quit${RESET}"
    }
    sleep 2
  fi

  sudo systemctl start "$SERVICE_NAME" || {
    echo -e "${RED}===============================================${RESET}"
    echo -e "${RED}[-] èŠ‚ç‚¹å¯åŠ¨å¤±è´¥!${RESET}"
    echo -e "${RED}    è¯·æ£€æŸ¥æ—¥å¿—: journalctl -u $SERVICE_NAME --no-pager${RESET}"
    echo -e "${RED}===============================================${RESET}"
    pause_and_return
    return
  }

  echo -e "${GREEN}===============================================${RESET}"
  echo -e "${GREEN}[+] èŠ‚ç‚¹å·²æˆåŠŸå¯åŠ¨ä¸º systemd æœåŠ¡ '$SERVICE_NAME'${RESET}"
  echo -e "${YELLOW}[!] ä½¿ç”¨ 'systemctl status $SERVICE_NAME' æŸ¥çœ‹çŠ¶æ€ã€‚${RESET}"
  echo -e "${YELLOW}[!] ä½¿ç”¨ 'journalctl -u $SERVICE_NAME -f' æŸ¥çœ‹å®æ—¶æ—¥å¿—ã€‚${RESET}"
  echo -e "${GREEN}===============================================${RESET}"

  pause_and_return
}

function view_node_status_systemd() {
  echo -e "[*] æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€ (systemd æœåŠ¡: $SERVICE_NAME)..."
  if ! check_command systemctl; then
      echo -e "${RED}[-] æ‚¨çš„ç³»ç»Ÿä¸æ”¯æŒ systemdã€‚æ­¤åŠŸèƒ½ä¸å¯ç”¨ã€‚${RESET}"
      pause_and_return
      return
  fi
  sudo systemctl status "$SERVICE_NAME" || {
    echo -e "${RED}[-] æ— æ³•è·å–æœåŠ¡çŠ¶æ€ï¼Œå¯èƒ½æœåŠ¡æœªå®‰è£…æˆ–å·²åœæ­¢ã€‚${RESET}"
  }
  pause_and_return
}

function view_logs_systemd() {
  echo -e "[*] æŸ¥çœ‹èŠ‚ç‚¹æ—¥å¿— (systemd æœåŠ¡: $SERVICE_NAME)..."
  if ! check_command journalctl; then
      echo -e "${RED}[-] æ‚¨çš„ç³»ç»Ÿä¸æ”¯æŒ journalctl æˆ– systemd æ—¥å¿—ã€‚${RESET}"
      pause_and_return
      return
  fi
  echo -e "${YELLOW}[!] æŒ‰ Ctrl+C é€€å‡ºæ—¥å¿—æŸ¥çœ‹ã€‚${RESET}"
  echo "-----------------------------------------------"
  journalctl -u "$SERVICE_NAME" -f --no-pager || {
    echo -e "${RED}[-] æ— æ³•æŸ¥çœ‹æ—¥å¿—ï¼Œå¯èƒ½æœåŠ¡æœªè¿è¡Œæˆ–æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨ã€‚${RESET}"
  }
  pause_and_return
}

function stop_node_systemd() {
    echo -e "[*] åœæ­¢èŠ‚ç‚¹ (systemd æœåŠ¡: $SERVICE_NAME)..."
    if ! check_command systemctl; then
        echo -e "${RED}[-] æ‚¨çš„ç³»ç»Ÿä¸æ”¯æŒ systemdã€‚æ­¤åŠŸèƒ½ä¸å¯ç”¨ã€‚${RESET}"
        pause_and_return
        return
    fi

    if sudo systemctl is-active --quiet "$SERVICE_NAME"; then
        sudo systemctl stop "$SERVICE_NAME" || {
            echo -e "${RED}[-] æ— æ³•åœæ­¢æœåŠ¡ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨æ“ä½œã€‚${RESET}"
            pause_and_return
            return
        }
        echo -e "${GREEN}[+] èŠ‚ç‚¹æœåŠ¡ '$SERVICE_NAME' å·²åœæ­¢${RESET}"
    else
        echo -e "${YELLOW}[!] èŠ‚ç‚¹æœåŠ¡ '$SERVICE_NAME' æœªè¿è¡Œï¼Œæ— éœ€åœæ­¢ã€‚${RESET}"
    fi
    pause_and_return
}

function uninstall_systemd_service() {
    echo -e "[*] å¸è½½èŠ‚ç‚¹ systemd æœåŠ¡ ($SERVICE_NAME)..."
    if ! check_command systemctl; then
        echo -e "${RED}[-] æ‚¨çš„ç³»ç»Ÿä¸æ”¯æŒ systemdã€‚æ­¤åŠŸèƒ½ä¸å¯ç”¨ã€‚${RESET}"
        pause_and_return
        return
    fi

    if [ -f "$SERVICE_FILE" ]; then
        echo -e "[*] ç¦ç”¨å¹¶åœæ­¢æœåŠ¡..."
        sudo systemctl disable --now "$SERVICE_NAME" &>/dev/null
        echo -e "[*] åˆ é™¤æœåŠ¡æ–‡ä»¶..."
        sudo rm "$SERVICE_FILE" || {
            echo -e "${RED}[-] é”™è¯¯: æ— æ³•åˆ é™¤æœåŠ¡æ–‡ä»¶ '$SERVICE_FILE'ã€‚è¯·æ‰‹åŠ¨åˆ é™¤ã€‚${RESET}"
            pause_and_return
            return
        }
        echo -e "[*] é‡è½½ systemd daemon..."
        sudo systemctl daemon-reload || {
            echo -e "${RED}[-] é”™è¯¯: systemctl daemon-reload å¤±è´¥ã€‚${RESET}"
        }
        echo -e "${GREEN}[+] èŠ‚ç‚¹ systemd æœåŠ¡ '$SERVICE_NAME' å·²æˆåŠŸå¸è½½ã€‚${RESET}"
    else
        echo -e "${YELLOW}[!] æœåŠ¡æ–‡ä»¶ '$SERVICE_FILE' ä¸å­˜åœ¨ï¼Œæ— éœ€å¸è½½ã€‚${RESET}"
    fi
    pause_and_return
}


# ========= ä¸»èœå• =========
function main_menu() {
  show_banner
  echo "è¯·é€‰æ‹©æ“ä½œ:"
  echo "  ${GREEN}1) ä¸€é”®å®‰è£…ã€æ„å»ºå¹¶åˆå§‹åŒ– .env (æ¨èé¦–æ¬¡è¿è¡Œ)${RESET}"
  echo "  ${BLUE}--- é’±åŒ…æ“ä½œ ---${RESET}"
  echo "  2) ç”Ÿæˆé’±åŒ…å¯†é’¥å¯¹ (æ˜¾ç¤ºå…¬é’¥ï¼Œç§é’¥ä¿å­˜åˆ° wallet.keys)"
  echo "  3) è®¾ç½® MINING_PUBKEY åˆ° .env (æ ¹æ®å…¬é’¥è®¾ç½®æŒ–çŸ¿åœ°å€)"
  echo "  4) å¯¼å‡ºé’±åŒ…å¯†é’¥åˆ°æ–‡ä»¶ (keys.export)"
  echo "  5) å¯¼å…¥é’±åŒ…å¯†é’¥æ–‡ä»¶"
  echo "  ${BLUE}--- èŠ‚ç‚¹æ“ä½œ (Systemd ç®¡ç†) ---${RESET}"
  echo "  6) å®‰è£…å¹¶å¯åŠ¨èŠ‚ç‚¹æœåŠ¡ (Systemd è‡ªåŠ¨ç®¡ç†)"
  echo "  7) æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€ (Systemd)"
  echo "  8) æŸ¥çœ‹èŠ‚ç‚¹æ—¥å¿— (Systemd)"
  echo "  9) åœæ­¢èŠ‚ç‚¹æœåŠ¡ (Systemd)"
  echo "  10) å¸è½½èŠ‚ç‚¹æœåŠ¡ (Systemd)"
  echo "  ${YELLOW}--- èŠ‚ç‚¹é…ç½® ---${RESET}"
  echo "  11) è®¾ç½®æŒ–çŸ¿çº¿ç¨‹æ•° (MINER_THREADS) åˆ° .env"
  echo "  ${RED}0) é€€å‡º${RESET}"
  echo ""
  read -r -p "è¯·è¾“å…¥ç¼–å·: " choice

  case "$choice" in
    1) setup_all ;;
    2) generate_wallet ;;
    3) set_pubkey_env ;;
    4) export_keys ;;
    5) import_keys ;;
    # Systemd é€‰é¡¹
    6) install_systemd_service && start_node_systemd ;; # å…ˆå®‰è£…æœåŠ¡å†å¯åŠ¨
    7) view_node_status_systemd ;;
    8) view_logs_systemd ;;
    9) stop_node_systemd ;;
    10) uninstall_systemd_service ;;
    # é…ç½®é€‰é¡¹
    11) set_miner_threads_env ;;
    0) echo "é€€å‡ºè„šæœ¬."; exit 0 ;;
    *) echo -e "${RED}[-] æ— æ•ˆé€‰é¡¹${RESET}"; pause_and_return ;;
  esac
}

# ========= è„šæœ¬å…¥å£ =========
# ç¡®ä¿åœ¨è„šæœ¬å¼€å§‹æ—¶å°±åŠ è½½ .envï¼Œä»¥ä¾¿åç»­å‡½æ•°å¯ä»¥ä½¿ç”¨å…¶ä¸­çš„å˜é‡ï¼ˆå¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼‰
if [ -f "$ENV_FILE" ]; then
    . "$ENV_FILE"
fi

# å¯åŠ¨ä¸»èœå•å¾ªç¯
while true; do
    main_menu
done

exit 0 # æ­£å¸¸é€€å‡º
