#!/bin/bash

# ========= Nockchain åŠŸèƒ½å®Œæ•´ç‰ˆè„šæœ¬ v22.0 =========
RESET='\033[0m'
BOLD='\033[1m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'

NCK_DIR="$HOME/nockchain"
ENV_FILE="$NCK_DIR/.env"
LOG_FILE="$HOME/nockchain_build.log"
NODE_LOG="$HOME/nockchain_node.log"
USER_SOFTWARE_DIR="$HOME/software"
USER_BIN_DIR="$USER_SOFTWARE_DIR/bin"
USER_LIB_DIR="$USER_SOFTWARE_DIR/lib"
USER_INCLUDE_DIR="$USER_SOFTWARE_DIR/include"

function show_banner() {
  clear
  echo -e "${BOLD}${CYAN}"
  echo "============================================================"
  echo "   Nockchain åŠŸèƒ½å®Œæ•´ç‰ˆè„šæœ¬ v22.0"
  echo "============================================================"
  echo -e "${RESET}"
  echo "ğŸ¯ å®Œæ•´åŠŸèƒ½: ç¯å¢ƒä¿®å¤ + æ„å»º + é’±åŒ… + èŠ‚ç‚¹ç®¡ç†"
  echo "ğŸ”§ å·¥å…·ä¿®å¤: clang/pkg-config/make ä¾èµ–é—®é¢˜"
  echo "ğŸ’¾ å†…å­˜ä¼˜åŒ–: é˜²æ­¢mem.rsé”™è¯¯ï¼Œæ”¯æŒä½å†…å­˜VPS"
  echo "âš¡ èŠ‚ç‚¹ç®¡ç†: å¯åŠ¨/åœæ­¢/æ—¥å¿—æŸ¥çœ‹/çŠ¶æ€ç›‘æ§"
  echo "ğŸ”‘ é’±åŒ…ç®¡ç†: ç”Ÿæˆ/å¯¼å…¥/å…¬é’¥è®¾ç½®/å¤‡ä»½"
  echo "------------------------------------------------------------"
  echo ""
}

# ========= ç³»ç»Ÿç¯å¢ƒæ£€æµ‹å’Œä¿®å¤ =========
function detect_and_fix_system() {
  echo -e "[*] ç³»ç»Ÿç¯å¢ƒæ£€æµ‹å’Œä¿®å¤..."
  
  # æ£€æµ‹æ“ä½œç³»ç»Ÿ
  if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS_NAME=$NAME
    OS_VERSION=$VERSION_ID
    echo -e "${BLUE}[i] æ“ä½œç³»ç»Ÿ: $OS_NAME $OS_VERSION${RESET}"
  else
    OS_NAME="Unknown"
  fi
  
  # æ£€æµ‹å†…å­˜
  total_mem_kb=$(grep MemTotal /proc/meminfo | awk '{print $2}')
  total_mem_gb=$((total_mem_kb / 1024 / 1024))
  echo -e "${BLUE}[i] ç³»ç»Ÿå†…å­˜: ${total_mem_gb}GB${RESET}"
  
  # æ£€æµ‹sudoæƒé™
  if sudo -n true 2>/dev/null; then
    HAS_SUDO=true
    echo -e "${GREEN}[+] æœ‰sudoæƒé™${RESET}"
  else
    HAS_SUDO=false
    echo -e "${YELLOW}[!] æ— sudoæƒé™ï¼Œå°†ä½¿ç”¨ç”¨æˆ·ç©ºé—´æ–¹æ¡ˆ${RESET}"
  fi
  
  # åˆ›å»ºç›®å½•ç»“æ„
  mkdir -p "$USER_SOFTWARE_DIR"/{bin,lib,lib64,include,share,src,build}
  export PATH="$USER_BIN_DIR:$PATH"
  export PKG_CONFIG_PATH="$USER_LIB_DIR/pkgconfig:$USER_SOFTWARE_DIR/lib64/pkgconfig:$PKG_CONFIG_PATH"
  export LD_LIBRARY_PATH="$USER_LIB_DIR:$USER_SOFTWARE_DIR/lib64:$LD_LIBRARY_PATH"
  
  echo -e "${GREEN}[+] ç³»ç»Ÿç¯å¢ƒæ£€æµ‹å®Œæˆ${RESET}"
}

# ========= å®‰è£…ç¼ºå¤±çš„å·¥å…· =========
function install_missing_tools() {
  echo -e "[*] æ£€æµ‹å¹¶å®‰è£…ç¼ºå¤±çš„å·¥å…·..."
  
  missing_tools=()
  
  # æ£€æµ‹å…³é”®å·¥å…·
  for tool in gcc g++ clang make cmake pkg-config git; do
    if ! command -v "$tool" >/dev/null 2>&1; then
      missing_tools+=("$tool")
    fi
  done
  
  if [ ${#missing_tools[@]} -eq 0 ]; then
    echo -e "${GREEN}[+] æ‰€æœ‰å·¥å…·éƒ½å·²å°±ç»ª${RESET}"
    return 0
  fi
  
  echo -e "${YELLOW}[!] ç¼ºå°‘å·¥å…·: ${missing_tools[*]}${RESET}"
  
  # ç³»ç»Ÿæ–¹å¼å®‰è£…ï¼ˆå¦‚æœæœ‰sudoæƒé™ï¼‰
  if [ "$HAS_SUDO" = "true" ]; then
    echo -e "[*] ä½¿ç”¨ç³»ç»ŸåŒ…ç®¡ç†å™¨å®‰è£…..."
    
    sudo apt update -y
    
    # å®‰è£…build-essentialå’ŒåŸºç¡€å·¥å…·
    sudo apt install -y build-essential curl git wget pkg-config libssl-dev cmake
    
    # å®‰è£…clang
    for version in "" "-14" "-13" "-12"; do
      package_name="clang${version}"
      if sudo apt install -y $package_name; then
        echo -e "${GREEN}[+] $package_name å®‰è£…æˆåŠŸ${RESET}"
        break
      fi
    done
    
    # å®‰è£…llvm-dev
    sudo apt install -y llvm-dev libclang-dev 2>/dev/null || true
  else
    # ç”¨æˆ·ç©ºé—´å®‰è£…
    echo -e "[*] ä½¿ç”¨ç”¨æˆ·ç©ºé—´å®‰è£…..."
    install_user_space_tools
  fi
  
  # éªŒè¯å®‰è£…ç»“æœ
  remaining_missing=()
  for tool in "${missing_tools[@]}"; do
    if ! command -v "$tool" >/dev/null 2>&1; then
      remaining_missing+=("$tool")
    fi
  done
  
  if [ ${#remaining_missing[@]} -eq 0 ]; then
    echo -e "${GREEN}[+] æ‰€æœ‰å·¥å…·å®‰è£…æˆåŠŸ${RESET}"
    return 0
  else
    echo -e "${YELLOW}[!] ä»ç¼ºå°‘: ${remaining_missing[*]}${RESET}"
    return 1
  fi
}

# ========= ç”¨æˆ·ç©ºé—´å·¥å…·å®‰è£… =========
function install_user_space_tools() {
  echo -e "[*] ç”¨æˆ·ç©ºé—´å·¥å…·å®‰è£…..."
  
  cd "$USER_SOFTWARE_DIR/src"
  
  # å®‰è£…musl-crosså·¥å…·é“¾
  if ! command -v gcc >/dev/null 2>&1; then
    echo -e "[*] å®‰è£…musl-crosså·¥å…·é“¾..."
    if wget -q https://musl.cc/x86_64-linux-musl-cross.tgz; then
      tar -xzf x86_64-linux-musl-cross.tgz
      cp -r x86_64-linux-musl-cross/* "$USER_SOFTWARE_DIR/"
      ln -sf x86_64-linux-musl-gcc "$USER_BIN_DIR/gcc" 2>/dev/null || true
      ln -sf x86_64-linux-musl-g++ "$USER_BIN_DIR/g++" 2>/dev/null || true
    fi
  fi
  
  # å®‰è£…make
  if ! command -v make >/dev/null 2>&1; then
    echo -e "[*] å®‰è£…GNU Make..."
    if wget -q https://ftp.gnu.org/gnu/make/make-4.3.tar.gz; then
      tar -xzf make-4.3.tar.gz
      cd make-4.3
      ./configure --prefix="$USER_SOFTWARE_DIR"
      make -j$(nproc) && make install
      cd ..
    fi
  fi
  
  # å®‰è£…pkg-config
  if ! command -v pkg-config >/dev/null 2>&1; then
    echo -e "[*] å®‰è£…pkg-config..."
    if wget -q https://pkgconfig.freedesktop.org/releases/pkg-config-0.29.2.tar.gz; then
      tar -xzf pkg-config-0.29.2.tar.gz
      cd pkg-config-0.29.2
      ./configure --prefix="$USER_SOFTWARE_DIR" --with-internal-glib
      make -j$(nproc) && make install
      cd ..
    fi
  fi
  
  # å®‰è£…clangé¢„ç¼–è¯‘ç‰ˆ
  if ! command -v clang >/dev/null 2>&1; then
    echo -e "[*] å®‰è£…é¢„ç¼–è¯‘Clang..."
    if wget -q https://github.com/llvm/llvm-project/releases/download/llvmorg-14.0.6/clang+llvm-14.0.6-x86_64-linux-gnu-ubuntu-18.04.tar.xz; then
      tar -xf clang+llvm-14.0.6-x86_64-linux-gnu-ubuntu-18.04.tar.xz
      cp -r clang+llvm-14.0.6-x86_64-linux-gnu-ubuntu-18.04/* "$USER_SOFTWARE_DIR/"
      ln -sf clang-14 "$USER_BIN_DIR/clang" 2>/dev/null || true
      ln -sf clang++-14 "$USER_BIN_DIR/clang++" 2>/dev/null || true
    fi
  fi
  
  chmod +x "$USER_BIN_DIR"/* 2>/dev/null || true
}

# ========= é…ç½®å†…å­˜å’Œswap =========
function configure_memory_and_swap() {
  echo -e "[*] é…ç½®å†…å­˜å’Œswap..."
  
  total_mem_kb=$(grep MemTotal /proc/meminfo | awk '{print $2}')
  total_mem_gb=$((total_mem_kb / 1024 / 1024))
  current_swap_kb=$(grep SwapTotal /proc/meminfo | awk '{print $2}')
  current_swap_gb=$((current_swap_kb / 1024 / 1024))
  
  total_memory=$((total_mem_gb + current_swap_gb))
  
  if [ $total_memory -lt 8 ]; then
    required_swap=$((8 - total_mem_gb))
    echo -e "${YELLOW}[!] éœ€è¦é…ç½® ${required_swap}GB swap ä»¥é˜²æ­¢mem.rsé”™è¯¯${RESET}"
    
    swap_file="$HOME/nockchain.swap"
    
    if [ "$HAS_SUDO" = "true" ]; then
      if sudo fallocate -l ${required_swap}G "$swap_file"; then
        sudo chmod 600 "$swap_file"
        sudo mkswap "$swap_file"
        sudo swapon "$swap_file"
        echo -e "${GREEN}[+] ${required_swap}GB swapé…ç½®æˆåŠŸ${RESET}"
      fi
    else
      dd if=/dev/zero of="$swap_file" bs=1G count=$required_swap 2>/dev/null
      chmod 600 "$swap_file"
      echo -e "${YELLOW}[!] Swapæ–‡ä»¶å·²åˆ›å»ºï¼Œéœ€è¦sudoæƒé™å¯ç”¨${RESET}"
    fi
  else
    echo -e "${GREEN}[+] å†…å­˜å……è¶³ï¼Œæ— éœ€é¢å¤–swap${RESET}"
  fi
  
  # å†…å­˜ä¼˜åŒ–è®¾ç½®
  if [ "$HAS_SUDO" = "true" ]; then
    sudo sysctl -w vm.overcommit_memory=1 >/dev/null 2>&1 || true
    sudo sysctl -w vm.max_map_count=2097152 >/dev/null 2>&1 || true
  fi
}

# ========= è®¾ç½®ç¯å¢ƒå˜é‡ =========
function setup_environment() {
  echo -e "[*] è®¾ç½®ç¯å¢ƒå˜é‡..."
  
  cat > "$HOME/.nockchain_env" << EOF
#!/bin/bash
# NockchainåŠŸèƒ½å®Œæ•´ç‰ˆç¯å¢ƒå˜é‡
export PATH="$USER_BIN_DIR:\$PATH"
export PKG_CONFIG_PATH="$USER_LIB_DIR/pkgconfig:$USER_SOFTWARE_DIR/lib64/pkgconfig:\$PKG_CONFIG_PATH"
export LD_LIBRARY_PATH="$USER_LIB_DIR:$USER_SOFTWARE_DIR/lib64:\$LD_LIBRARY_PATH"
export C_INCLUDE_PATH="$USER_INCLUDE_DIR:\$C_INCLUDE_PATH"
export CPLUS_INCLUDE_PATH="$USER_INCLUDE_DIR:\$CPLUS_INCLUDE_PATH"

# ç¼–è¯‘å™¨è®¾ç½®
if command -v clang >/dev/null 2>&1; then
  export CC=clang
  export CXX=clang++
  export LIBCLANG_PATH="$USER_LIB_DIR"
elif command -v gcc >/dev/null 2>&1; then
  export CC=gcc
  export CXX=g++
fi

# Rustæ„å»ºä¼˜åŒ–
export CARGO_BUILD_JOBS=1
export RUSTFLAGS="-C opt-level=1 -C debuginfo=0 -C panic=abort"
export RUST_BACKTRACE=1
export RUST_MIN_STACK=16777216
EOF
  
  # æ·»åŠ åˆ°bashrc
  if ! grep -q "source.*nockchain_env" "$HOME/.bashrc" 2>/dev/null; then
    echo "" >> "$HOME/.bashrc"
    echo "# Nockchainç¯å¢ƒå˜é‡" >> "$HOME/.bashrc"
    echo "source \$HOME/.nockchain_env" >> "$HOME/.bashrc"
  fi
  
  source "$HOME/.nockchain_env"
  echo -e "${GREEN}[+] ç¯å¢ƒå˜é‡è®¾ç½®å®Œæˆ${RESET}"
}

# ========= å®Œæ•´ç¯å¢ƒå®‰è£… =========
function complete_environment_setup() {
  echo -e "[*] å¼€å§‹å®Œæ•´ç¯å¢ƒå®‰è£…..."
  
  echo "=== Nockchainå®Œæ•´ç¯å¢ƒå®‰è£…æ—¥å¿— $(date) ===" > "$LOG_FILE"
  
  echo -e "${BLUE}[i] æ­¥éª¤1/5: ç³»ç»Ÿç¯å¢ƒæ£€æµ‹...${RESET}"
  detect_and_fix_system
  
  echo -e "${BLUE}[i] æ­¥éª¤2/5: å®‰è£…ç¼ºå¤±å·¥å…·...${RESET}"
  install_missing_tools
  
  echo -e "${BLUE}[i] æ­¥éª¤3/5: é…ç½®å†…å­˜å’Œswap...${RESET}"
  configure_memory_and_swap
  
  echo -e "${BLUE}[i] æ­¥éª¤4/5: è®¾ç½®ç¯å¢ƒå˜é‡...${RESET}"
  setup_environment
  
  echo -e "${BLUE}[i] æ­¥éª¤5/5: å®‰è£…Rust...${RESET}"
  install_rust_if_needed
  
  echo -e "${GREEN}[+] âœ… å®Œæ•´ç¯å¢ƒå®‰è£…å®Œæˆï¼${RESET}"
  echo -e "${BLUE}[i] ä¸‹ä¸€æ­¥: æ„å»ºNockchainé¡¹ç›®${RESET}"
  
  pause_and_return
}

# ========= å®‰è£…Rust =========
function install_rust_if_needed() {
  if ! command -v rustc >/dev/null 2>&1; then
    echo -e "[*] å®‰è£…Rust..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
  else
    echo -e "[*] æ›´æ–°Rust..."
    rustup update stable 2>/dev/null || true
  fi
  
  source "$HOME/.cargo/env"
  export PATH="$HOME/.cargo/bin:$PATH"
  
  # ä¼˜åŒ–Cargoé…ç½®
  mkdir -p "$HOME/.cargo"
  cat > "$HOME/.cargo/config.toml" << 'EOF'
[build]
jobs = 1

[net]
retry = 50
timeout = 3600

[profile.release]
opt-level = 1
debug = false
lto = "off"
panic = "abort"
codegen-units = 1
strip = true

[profile.dev]
opt-level = 0
debug = false
codegen-units = 1
EOF
  
  echo -e "${GREEN}[+] Rusté…ç½®å®Œæˆ: $(rustc --version)${RESET}"
}

# ========= æ„å»ºNockchain =========
function build_nockchain_complete() {
  echo -e "[*] æ„å»ºNockchainé¡¹ç›®..."
  
  # åŠ è½½ç¯å¢ƒå˜é‡
  source "$HOME/.nockchain_env" 2>/dev/null || true
  source "$HOME/.cargo/env" 2>/dev/null || true
  
  # éªŒè¯å·¥å…·
  missing_tools=()
  for tool in make git rustc cargo; do
    if ! command -v "$tool" >/dev/null 2>&1; then
      missing_tools+=("$tool")
    fi
  done
  
  if [ ${#missing_tools[@]} -gt 0 ]; then
    echo -e "${RED}[-] ç¼ºå°‘å·¥å…·: ${missing_tools[*]}${RESET}"
    echo -e "${YELLOW}[!] è¯·å…ˆè¿è¡Œç¯å¢ƒå®‰è£…${RESET}"
    pause_and_return
    return
  fi
  
  # å…‹éš†é¡¹ç›®
  if [ ! -d "$NCK_DIR" ]; then
    echo -e "[*] å…‹éš†Nockchainé¡¹ç›®..."
    git clone --depth 1 https://github.com/zorp-corp/nockchain "$NCK_DIR" || {
      echo -e "${RED}[-] é¡¹ç›®å…‹éš†å¤±è´¥${RESET}"
      pause_and_return
      return
    }
  fi
  
  cd "$NCK_DIR"
  
  # æ¸…ç†ç¯å¢ƒ
  cargo clean >/dev/null 2>&1 || true
  rm -rf target/ 2>/dev/null || true
  
  # å‡†å¤‡é…ç½®
  if [ -f ".env_example" ]; then
    cp .env_example .env
  else
    cat > .env << 'EOF'
MINING_PUBKEY=
RUST_LOG=info
EOF
  fi
  
  mkdir -p assets .socket test-leader logs
  touch assets/wal.jam assets/dumb.jam assets/miner.jam 2>/dev/null || true
  
  # è®¾ç½®æ„å»ºç¯å¢ƒ
  export CARGO_BUILD_JOBS=1
  export RUSTFLAGS="-C opt-level=1 -C debuginfo=0 -C panic=abort"
  export RUST_MIN_STACK=16777216
  
  echo -e "[*] å¼€å§‹æ„å»º..."
  
  # æ„å»ºhoonc
  echo -e "[*] æ„å»ºhooncç¼–è¯‘å™¨..."
  if timeout 3600 make install-hoonc >>"$LOG_FILE" 2>&1; then
    echo -e "${GREEN}[+] hooncæ„å»ºæˆåŠŸ${RESET}"
  else
    echo -e "${YELLOW}[!] hooncæ„å»ºå¤±è´¥ï¼Œå°è¯•cargoæ–¹å¼...${RESET}"
    timeout 3600 cargo build --bin hoonc --release >>"$LOG_FILE" 2>&1 || true
  fi
  
  # æ„å»ºä¸»é¡¹ç›®
  echo -e "[*] æ„å»ºä¸»é¡¹ç›®..."
  if timeout 7200 make build >>"$LOG_FILE" 2>&1; then
    echo -e "${GREEN}[+] ä¸»é¡¹ç›®æ„å»ºæˆåŠŸ${RESET}"
  else
    echo -e "${YELLOW}[!] ä¸»é¡¹ç›®æ„å»ºå¤±è´¥ï¼Œåˆ†åˆ«æ„å»ºç»„ä»¶...${RESET}"
    for component in "nockchain-wallet" "nockchain"; do
      echo -e "[*] æ„å»º $component..."
      timeout 3600 cargo build --bin "$component" --release >>"$LOG_FILE" 2>&1 || true
    done
  fi
  
  # éªŒè¯ç»“æœ
  component_count=0
  for binary in "hoonc" "nockchain-wallet" "nockchain"; do
    if command -v "$binary" >/dev/null 2>&1 || [ -f "target/release/$binary" ]; then
      echo -e "${GREEN}  âœ“ $binary: å¯ç”¨${RESET}"
      ((component_count++))
    else
      echo -e "${RED}  âœ— $binary: æœªæ‰¾åˆ°${RESET}"
    fi
  done
  
  echo -e "${BLUE}[i] æ„å»ºæˆåŠŸ: $component_count/3 ä¸ªç»„ä»¶${RESET}"
  
  if [ $component_count -ge 2 ]; then
    echo -e "${GREEN}[+] âœ… Nockchainæ„å»ºæˆåŠŸï¼${RESET}"
  else
    echo -e "${YELLOW}[!] æ„å»ºéƒ¨åˆ†å¤±è´¥${RESET}"
  fi
  
  pause_and_return
}

# ========= ç”Ÿæˆé’±åŒ… =========
function generate_wallet() {
  echo -e "[*] ç”Ÿæˆé’±åŒ…..."
  
  cd "$NCK_DIR" || {
    echo -e "${RED}[-] Nockchainé¡¹ç›®ç›®å½•ä¸å­˜åœ¨${RESET}"
    echo -e "${YELLOW}[!] è¯·å…ˆè¿è¡Œæ„å»ºæ­¥éª¤${RESET}"
    pause_and_return
    return
  }
  
  source "$HOME/.cargo/env" 2>/dev/null || true
  
  if command -v nockchain-wallet >/dev/null 2>&1; then
    echo -e "${GREEN}[+] ä½¿ç”¨å·²å®‰è£…çš„nockchain-wallet${RESET}"
    echo -e "${BLUE}[i] è¯·ä¿å­˜å¥½ä»¥ä¸‹é’±åŒ…ä¿¡æ¯ï¼${RESET}"
    echo ""
    nockchain-wallet keygen
  elif [ -f "target/release/nockchain-wallet" ]; then
    echo -e "${GREEN}[+] ä½¿ç”¨æœ¬åœ°æ„å»ºçš„nockchain-wallet${RESET}"
    echo -e "${BLUE}[i] è¯·ä¿å­˜å¥½ä»¥ä¸‹é’±åŒ…ä¿¡æ¯ï¼${RESET}"
    echo ""
    ./target/release/nockchain-wallet keygen
  else
    echo -e "${RED}[-] æœªæ‰¾åˆ°nockchain-walletç¨‹åº${RESET}"
    echo -e "${YELLOW}[!] è¯·å…ˆå®Œæˆæ„å»ºæ­¥éª¤${RESET}"
  fi
  
  echo ""
  echo -e "${YELLOW}[!] é‡è¦æé†’:${RESET}"
  echo -e "${YELLOW}[!] 1. è¯·åŠ¡å¿…å¤‡ä»½ä¸Šæ–¹æ˜¾ç¤ºçš„åŠ©è®°è¯å’Œç§é’¥${RESET}"
  echo -e "${YELLOW}[!] 2. å¤åˆ¶å…¬é’¥ç”¨äºä¸‹ä¸€æ­¥è®¾ç½®${RESET}"
  echo -e "${YELLOW}[!] 3. ä¸¢å¤±åŠ©è®°è¯å°†æ— æ³•æ¢å¤é’±åŒ…${RESET}"
  
  pause_and_return
}

# ========= è®¾ç½®/æ›´æ”¹æŒ–çŸ¿å…¬é’¥ =========
function set_mining_pubkey() {
  echo -e "[*] è®¾ç½®/æ›´æ”¹æŒ–çŸ¿å…¬é’¥..."
  
  cd "$NCK_DIR" || {
    echo -e "${RED}[-] Nockchainé¡¹ç›®ç›®å½•ä¸å­˜åœ¨${RESET}"
    pause_and_return
    return
  }
  
  # æ˜¾ç¤ºå½“å‰å…¬é’¥ï¼ˆå¦‚æœæœ‰ï¼‰
  if [ -f "$ENV_FILE" ]; then
    current_pubkey=$(grep "MINING_PUBKEY=" "$ENV_FILE" 2>/dev/null | cut -d'=' -f2)
    if [ -n "$current_pubkey" ]; then
      echo -e "${BLUE}[i] å½“å‰å…¬é’¥: ${current_pubkey:0:16}...${current_pubkey: -16}${RESET}"
    else
      echo -e "${YELLOW}[!] å½“å‰æœªè®¾ç½®å…¬é’¥${RESET}"
    fi
  fi
  
  echo ""
  echo -e "${BLUE}[i] å…¬é’¥è¦æ±‚:${RESET}"
  echo -e "  - æ ¼å¼: 128ä½16è¿›åˆ¶å­—ç¬¦ä¸²"
  echo -e "  - æ¥æº: é’±åŒ…ç”Ÿæˆæ—¶æ˜¾ç¤ºçš„å…¬é’¥"
  echo -e "  - ç¤ºä¾‹: abcdef1234567890... (å…±128ä¸ªå­—ç¬¦)"
  echo ""
  
  read -p "è¯·è¾“å…¥å®Œæ•´çš„æŒ–çŸ¿å…¬é’¥ (ç•™ç©ºå–æ¶ˆ): " pubkey
  
  if [ -z "$pubkey" ]; then
    echo -e "${YELLOW}[!] æ“ä½œå·²å–æ¶ˆ${RESET}"
    pause_and_return
    return
  fi
  
  # æ¸…ç†æ ¼å¼
  pubkey=$(echo "$pubkey" | tr -d ' \n\r\t' | tr '[:upper:]' '[:lower:]')
  
  if [ ${#pubkey} -eq 128 ] && [[ "$pubkey" =~ ^[0-9a-f]{128}$ ]]; then
    # å¤‡ä»½æ—§é…ç½®
    if [ -f "$ENV_FILE" ]; then
      cp "$ENV_FILE" "$ENV_FILE.backup.$(date +%Y%m%d_%H%M%S)"
    fi
    
    # æ›´æ–°é…ç½®
    sed -i '/^MINING_PUBKEY=/d' "$ENV_FILE" 2>/dev/null || true
    echo "MINING_PUBKEY=$pubkey" >> "$ENV_FILE"
    
    echo -e "${GREEN}[+] âœ… æŒ–çŸ¿å…¬é’¥è®¾ç½®æˆåŠŸï¼${RESET}"
    echo -e "${GREEN}[+] å…¬é’¥: ${pubkey:0:16}...${pubkey: -16}${RESET}"
    echo -e "${BLUE}[i] é…ç½®å·²å¤‡ä»½åˆ°: $ENV_FILE.backup.*${RESET}"
  else
    echo -e "${RED}[-] å…¬é’¥æ ¼å¼é”™è¯¯${RESET}"
    echo -e "${YELLOW}[!] å½“å‰é•¿åº¦: ${#pubkey}ï¼Œéœ€è¦128ä½${RESET}"
    echo -e "${YELLOW}[!] åªèƒ½åŒ…å«0-9å’Œa-få­—ç¬¦${RESET}"
  fi
  
  pause_and_return
}

# ========= å¯åŠ¨èŠ‚ç‚¹ =========
function start_mining_node() {
  echo -e "[*] å¯åŠ¨æŒ–çŸ¿èŠ‚ç‚¹..."
  
  cd "$NCK_DIR" || {
    echo -e "${RED}[-] Nockchainé¡¹ç›®ç›®å½•ä¸å­˜åœ¨${RESET}"
    pause_and_return
    return
  }
  
  # æ£€æŸ¥é…ç½®
  if [ ! -f "$ENV_FILE" ]; then
    echo -e "${RED}[-] .envæ–‡ä»¶ä¸å­˜åœ¨${RESET}"
    echo -e "${YELLOW}[!] è¯·å…ˆè®¾ç½®æŒ–çŸ¿å…¬é’¥${RESET}"
    pause_and_return
    return
  fi
  
  source "$ENV_FILE"
  
  if [ -z "$MINING_PUBKEY" ]; then
    echo -e "${RED}[-] æŒ–çŸ¿å…¬é’¥æœªè®¾ç½®${RESET}"
    echo -e "${YELLOW}[!] è¯·å…ˆè¿è¡Œé’±åŒ…ç”Ÿæˆå’Œå…¬é’¥è®¾ç½®${RESET}"
    pause_and_return
    return
  fi
  
  # æ¸…ç†æ—§è¿›ç¨‹
  echo -e "[*] æ¸…ç†æ—§è¿›ç¨‹å’Œsocketæ–‡ä»¶..."
  pkill -f nockchain 2>/dev/null || true
  screen -XS nockchain quit 2>/dev/null || true
  
  # æ¸…ç†socketæ–‡ä»¶
  find . -name "*.sock" -delete 2>/dev/null || true
  find "$HOME" -name "nockchain*.sock" -delete 2>/dev/null || true
  
  # åˆ›å»ºå¿…è¦ç›®å½•
  mkdir -p .socket test-leader logs
  chmod 755 .socket test-leader
  
  # æ£€æŸ¥èŠ‚ç‚¹ç¨‹åº
  node_cmd=""
  if command -v nockchain >/dev/null 2>&1; then
    node_cmd="nockchain"
  elif [ -f "target/release/nockchain" ]; then
    node_cmd="./target/release/nockchain"
  else
    echo -e "${RED}[-] æœªæ‰¾åˆ°nockchainèŠ‚ç‚¹ç¨‹åº${RESET}"
    echo -e "${YELLOW}[!] è¯·å…ˆå®Œæˆæ„å»ºæ­¥éª¤${RESET}"
    pause_and_return
    return
  fi
  
  echo -e "${GREEN}[+] ä½¿ç”¨èŠ‚ç‚¹ç¨‹åº: $node_cmd${RESET}"
  echo -e "${GREEN}[+] æŒ–çŸ¿å…¬é’¥: ${MINING_PUBKEY:0:16}...${MINING_PUBKEY: -16}${RESET}"
  
  # æ„å»ºå¯åŠ¨å‘½ä»¤
  start_cmd="RUST_LOG=info RUST_MIN_STACK=16777216 $node_cmd \
--mining-pubkey $MINING_PUBKEY \
--mine \
--peer /ip4/95.216.102.60/udp/3006/quic-v1 \
--peer /ip4/65.109.156.108/udp/3006/quic-v1 \
--peer /ip4/65.21.67.175/udp/3006/quic-v1 \
--peer /ip4/65.109.156.172/udp/3006/quic-v1 \
--peer /ip4/34.174.22.166/udp/3006/quic-v1 \
--npc-socket .socket/nockchain.sock \
--bind /ip4/0.0.0.0/udp/3006/quic-v1"
  
  # å¯åŠ¨èŠ‚ç‚¹
  if command -v screen >/dev/null 2>&1; then
    echo -e "[*] ä½¿ç”¨screenå¯åŠ¨èŠ‚ç‚¹..."
    screen -dmS nockchain bash -c "cd '$NCK_DIR' && $start_cmd 2>&1 | tee logs/nockchain.log"
    sleep 5
    
    if screen -list | grep -qw "nockchain"; then
      echo -e "${GREEN}[+] âœ… èŠ‚ç‚¹å¯åŠ¨æˆåŠŸï¼${RESET}"
      echo -e "${BLUE}[i] Screenä¼šè¯: nockchain${RESET}"
      echo -e "${BLUE}[i] æŸ¥çœ‹å®æ—¶æ—¥å¿—: screen -r nockchain${RESET}"
      echo -e "${BLUE}[i] é€€å‡ºæ—¥å¿—æŸ¥çœ‹: Ctrl+A+D${RESET}"
      echo -e "${BLUE}[i] æ—¥å¿—æ–‡ä»¶: logs/nockchain.log${RESET}"
      
      # æ˜¾ç¤ºå¯åŠ¨çŠ¶æ€
      sleep 3
      echo -e "[*] æ£€æŸ¥èŠ‚ç‚¹å¯åŠ¨çŠ¶æ€..."
      if screen -S nockchain -X stuff "echo 'Node status check'\n" 2>/dev/null; then
        echo -e "${GREEN}[+] èŠ‚ç‚¹å“åº”æ­£å¸¸${RESET}"
      fi
    else
      echo -e "${RED}[-] èŠ‚ç‚¹å¯åŠ¨å¤±è´¥${RESET}"
      echo -e "${BLUE}[i] è¯·æŸ¥çœ‹é”™è¯¯æ—¥å¿—: tail -f logs/nockchain.log${RESET}"
    fi
  else
    echo -e "[*] ä½¿ç”¨åå°è¿›ç¨‹å¯åŠ¨èŠ‚ç‚¹..."
    nohup bash -c "$start_cmd" > logs/nockchain.log 2>&1 &
    node_pid=$!
    
    echo -e "${GREEN}[+] èŠ‚ç‚¹å·²åå°å¯åŠ¨ (PID: $node_pid)${RESET}"
    echo -e "${BLUE}[i] æ—¥å¿—æ–‡ä»¶: logs/nockchain.log${RESET}"
    echo -e "${BLUE}[i] æŸ¥çœ‹æ—¥å¿—: tail -f logs/nockchain.log${RESET}"
  fi
  
  echo ""
  echo -e "${YELLOW}[!] èŠ‚ç‚¹å¯åŠ¨æé†’:${RESET}"
  echo -e "${YELLOW}[!] 1. èŠ‚ç‚¹é¦–æ¬¡å¯åŠ¨éœ€è¦åŒæ­¥åŒºå—ï¼Œå¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´${RESET}"
  echo -e "${YELLOW}[!] 2. è¯·ä¿æŒç½‘ç»œè¿æ¥ç¨³å®š${RESET}"
  echo -e "${YELLOW}[!] 3. å¯é€šè¿‡æ—¥å¿—æŸ¥çœ‹åŠŸèƒ½ç›‘æ§èŠ‚ç‚¹çŠ¶æ€${RESET}"
  
  pause_and_return
}

# ========= æŸ¥çœ‹æ—¥å¿— =========
function view_node_logs() {
  echo -e "[*] æŸ¥çœ‹èŠ‚ç‚¹æ—¥å¿—..."
  
  # æ£€æŸ¥screenä¼šè¯
  if command -v screen >/dev/null 2>&1 && screen -list | grep -qw "nockchain"; then
    echo -e "${BLUE}[i] å‘ç°screenä¼šè¯ï¼Œé€‰æ‹©æŸ¥çœ‹æ–¹å¼:${RESET}"
    echo "  1) å®æ—¶æŸ¥çœ‹screenæ—¥å¿— (æ¨è)"
    echo "  2) æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶"
    echo ""
    read -p "è¯·é€‰æ‹© (1-2): " log_choice
    
    if [ "$log_choice" = "1" ]; then
      echo -e "${YELLOW}[!] è¿›å…¥screenå®æ—¶æ—¥å¿—æŸ¥çœ‹...${RESET}"
      echo -e "${BLUE}[i] ä½¿ç”¨ Ctrl+A+D é€€å‡ºæŸ¥çœ‹${RESET}"
      echo -e "${BLUE}[i] æŒ‰ä»»æ„é”®ç»§ç»­...${RESET}"
      read -n1
      screen -r nockchain
      pause_and_return
      return
    fi
  fi
  
  # æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶
  log_files=()
  
  # æ£€æŸ¥å¯èƒ½çš„æ—¥å¿—æ–‡ä»¶ä½ç½®
  if [ -f "$NCK_DIR/logs/nockchain.log" ]; then
    log_files+=("$NCK_DIR/logs/nockchain.log")
  fi
  
  if [ -f "$NCK_DIR/nockchain.log" ]; then
    log_files+=("$NCK_DIR/nockchain.log")
  fi
  
  if [ -f "$NODE_LOG" ]; then
    log_files+=("$NODE_LOG")
  fi
  
  if [ ${#log_files[@]} -eq 0 ]; then
    echo -e "${RED}[-] æœªæ‰¾åˆ°æ—¥å¿—æ–‡ä»¶${RESET}"
    echo -e "${YELLOW}[!] å¯èƒ½çš„åŸå› :${RESET}"
    echo -e "  1. èŠ‚ç‚¹å°šæœªå¯åŠ¨"
    echo -e "  2. æ—¥å¿—æ–‡ä»¶ä½ç½®ä¸åœ¨é¢„æœŸä½ç½®"
    echo -e "  3. æƒé™é—®é¢˜"
    pause_and_return
    return
  fi
  
  if [ ${#log_files[@]} -eq 1 ]; then
    log_file="${log_files[0]}"
  else
    echo -e "${BLUE}[i] æ‰¾åˆ°å¤šä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œè¯·é€‰æ‹©:${RESET}"
    for i in "${!log_files[@]}"; do
      log_size=$(du -h "${log_files[$i]}" 2>/dev/null | cut -f1 || echo "unknown")
      echo "  $((i+1))) ${log_files[$i]} (å¤§å°: $log_size)"
    done
    echo ""
    read -p "è¯·é€‰æ‹©æ—¥å¿—æ–‡ä»¶ (1-${#log_files[@]}): " file_choice
    
    if [[ "$file_choice" =~ ^[0-9]+$ ]] && [ "$file_choice" -ge 1 ] && [ "$file_choice" -le ${#log_files[@]} ]; then
      log_file="${log_files[$((file_choice-1))]}"
    else
      echo -e "${RED}[-] æ— æ•ˆé€‰æ‹©${RESET}"
      pause_and_return
      return
    fi
  fi
  
  echo -e "${GREEN}[+] æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶: $log_file${RESET}"
  echo -e "${BLUE}[i] å®æ—¶æŸ¥çœ‹æ—¥å¿— (Ctrl+C é€€å‡º)${RESET}"
  echo ""
  
  if [ -f "$log_file" ]; then
    tail -f "$log_file"
  else
    echo -e "${RED}[-] æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®${RESET}"
  fi
  
  pause_and_return
}

# ========= åœæ­¢æœåŠ¡ =========
function stop_all_services() {
  echo -e "[*] åœæ­¢æ‰€æœ‰NockchainæœåŠ¡..."
  
  services_stopped=0
  
  # åœæ­¢screenä¼šè¯
  if command -v screen >/dev/null 2>&1 && screen -list | grep -qw "nockchain"; then
    screen -S nockchain -X quit >/dev/null 2>&1
    echo -e "${GREEN}[+] Screenä¼šè¯å·²ç»ˆæ­¢${RESET}"
    ((services_stopped++))
  fi
  
  # åœæ­¢ç›¸å…³è¿›ç¨‹
  for process in "nockchain" "nockchain-wallet" "hoonc"; do
    if pgrep -f "$process" >/dev/null 2>&1; then
      pkill -f "$process" >/dev/null 2>&1
      echo -e "${GREEN}[+] $process è¿›ç¨‹å·²ç»ˆæ­¢${RESET}"
      ((services_stopped++))
    fi
  done
  
  # æ¸…ç†socketæ–‡ä»¶
  if [ -d "$NCK_DIR" ]; then
    cd "$NCK_DIR"
    socket_count=$(find . -name "*.sock" 2>/dev/null | wc -l)
    if [ $socket_count -gt 0 ]; then
      find . -name "*.sock" -delete 2>/dev/null || true
      echo -e "${GREEN}[+] $socket_count ä¸ªsocketæ–‡ä»¶å·²æ¸…ç†${RESET}"
      ((services_stopped++))
    fi
  fi
  
  sleep 3
  
  # éªŒè¯åœæ­¢çŠ¶æ€
  if ! pgrep -f "nockchain" >/dev/null 2>&1; then
    echo -e "${GREEN}[+] âœ… æ‰€æœ‰NockchainæœåŠ¡å·²å®Œå…¨åœæ­¢${RESET}"
  else
    echo -e "${YELLOW}[!] éƒ¨åˆ†æœåŠ¡å¯èƒ½ä»åœ¨è¿è¡Œ${RESET}"
    echo -e "${BLUE}[i] å¯ä»¥å°è¯•æ‰‹åŠ¨ç»ˆæ­¢: pkill -f nockchain${RESET}"
  fi
  
  if [ $services_stopped -eq 0 ]; then
    echo -e "${BLUE}[i] æ²¡æœ‰å‘ç°è¿è¡Œä¸­çš„æœåŠ¡${RESET}"
  else
    echo -e "${BLUE}[i] å…±åœæ­¢äº† $services_stopped ä¸ªæœåŠ¡/æ–‡ä»¶${RESET}"
  fi
  
  pause_and_return
}

# ========= çŠ¶æ€æ£€æŸ¥ =========
function check_complete_status() {
  echo -e "[*] æ£€æŸ¥å®Œæ•´ç³»ç»ŸçŠ¶æ€..."
  
  # åŠ è½½ç¯å¢ƒå˜é‡
  source "$HOME/.nockchain_env" 2>/dev/null || true
  source "$HOME/.cargo/env" 2>/dev/null || true
  
  echo -e "${BLUE}[i] === ç³»ç»Ÿèµ„æºçŠ¶æ€ ===${RESET}"
  echo -e "  ç‰©ç†å†…å­˜: $(free -h | grep Mem | awk '{print $3"/"$2" ("int($3/$2*100)"%)"}')"
  echo -e "  Swapå†…å­˜: $(free -h | grep Swap | awk '{print $3"/"$2" ("int($3/$2*100)"%)"}')"
  echo -e "  ç£ç›˜ä½¿ç”¨: $(df -h . | tail -1 | awk '{print $3"/"$2" ("$5")"}')"
  echo -e "  ç³»ç»Ÿè´Ÿè½½: $(uptime | awk -F'load average:' '{print $2}')"
  
  echo -e "${BLUE}[i] === æ„å»ºå·¥å…·çŠ¶æ€ ===${RESET}"
  tools_available=0
  total_tools=9
  
  for tool in gcc g++ clang make cmake pkg-config git rustc cargo; do
    if command -v "$tool" >/dev/null 2>&1; then
      tool_version=$($tool --version 2>/dev/null | head -1 | cut -d' ' -f1-3 || echo "unknown")
      echo -e "${GREEN}  âœ“ $tool: $tool_version${RESET}"
      ((tools_available++))
    else
      echo -e "${RED}  âœ— $tool: æœªæ‰¾åˆ°${RESET}"
    fi
  done
  
  echo -e "${BLUE}[i] å·¥å…·å®Œæ•´æ€§: $tools_available/$total_tools ($(( tools_available * 100 / total_tools ))%)${RESET}"
  
  echo -e "${BLUE}[i] === Nockchainç»„ä»¶çŠ¶æ€ ===${RESET}"
  if [ -d "$NCK_DIR" ]; then
    cd "$NCK_DIR"
    
    component_count=0
    for binary in "hoonc" "nockchain-wallet" "nockchain"; do
      if command -v "$binary" >/dev/null 2>&1; then
        binary_path=$(command -v "$binary")
        binary_size=$(du -h "$binary_path" 2>/dev/null | cut -f1 || echo "unknown")
        echo -e "${GREEN}  âœ“ $binary: $binary_path (å¤§å°: $binary_size)${RESET}"
        ((component_count++))
      elif [ -f "target/release/$binary" ]; then
        binary_size=$(du -h "target/release/$binary" 2>/dev/null | cut -f1 || echo "unknown")
        echo -e "${GREEN}  âœ“ $binary: target/release/$binary (å¤§å°: $binary_size)${RESET}"
        ((component_count++))
      else
        echo -e "${RED}  âœ— $binary: æœªæ‰¾åˆ°${RESET}"
      fi
    done
    
    echo -e "${BLUE}[i] ç»„ä»¶å®Œæ•´æ€§: $component_count/3 ($(( component_count * 100 / 3 ))%)${RESET}"
    
    # æ£€æŸ¥é…ç½®
    if [ -f "$ENV_FILE" ]; then
      source "$ENV_FILE" 2>/dev/null || true
      if [ -n "$MINING_PUBKEY" ]; then
        echo -e "${GREEN}  âœ“ æŒ–çŸ¿å…¬é’¥: ${MINING_PUBKEY:0:16}...${MINING_PUBKEY: -16}${RESET}"
        echo -e "${BLUE}    é…ç½®æ–‡ä»¶: $ENV_FILE${RESET}"
      else
        echo -e "${YELLOW}  ! æŒ–çŸ¿å…¬é’¥: å·²é…ç½®ä½†ä¸ºç©º${RESET}"
      fi
    else
      echo -e "${RED}  âœ— é…ç½®æ–‡ä»¶: $ENV_FILE ä¸å­˜åœ¨${RESET}"
    fi
  else
    echo -e "${RED}  âœ— é¡¹ç›®ç›®å½•: $NCK_DIR ä¸å­˜åœ¨${RESET}"
  fi
  
  echo -e "${BLUE}[i] === èŠ‚ç‚¹è¿è¡ŒçŠ¶æ€ ===${RESET}"
  if command -v screen >/dev/null 2>&1 && screen -list | grep -qw "nockchain"; then
    echo -e "${GREEN}  âœ“ èŠ‚ç‚¹è¿è¡Œä¸­ (screen session: nockchain)${RESET}"
    
    # æ£€æŸ¥screenä¼šè¯çŠ¶æ€
    screen_status=$(screen -list | grep nockchain | awk '{print $2}' || echo "unknown")
    echo -e "${BLUE}    ScreençŠ¶æ€: $screen_status${RESET}"
    
    # æ£€æŸ¥æ—¥å¿—æ–‡ä»¶
    if [ -f "$NCK_DIR/logs/nockchain.log" ]; then
      log_size=$(du -h "$NCK_DIR/logs/nockchain.log" 2>/dev/null | cut -f1 || echo "unknown")
      log_lines=$(wc -l < "$NCK_DIR/logs/nockchain.log" 2>/dev/null || echo "unknown")
      echo -e "${BLUE}    æ—¥å¿—æ–‡ä»¶: $NCK_DIR/logs/nockchain.log (å¤§å°: $log_size, è¡Œæ•°: $log_lines)${RESET}"
      
      # æ˜¾ç¤ºæœ€è¿‘çš„å‡ è¡Œæ—¥å¿—
      echo -e "${BLUE}    æœ€è¿‘æ—¥å¿—:${RESET}"
      tail -n 3 "$NCK_DIR/logs/nockchain.log" 2>/dev/null | sed 's/^/      /' || echo "      æ— æ³•è¯»å–æ—¥å¿—"
    fi
  elif pgrep -f "nockchain" >/dev/null 2>&1; then
    node_pid=$(pgrep -f "nockchain" | head -1)
    echo -e "${GREEN}  âœ“ èŠ‚ç‚¹è¿è¡Œä¸­ (PID: $node_pid)${RESET}"
  else
    echo -e "${RED}  âœ— èŠ‚ç‚¹æœªè¿è¡Œ${RESET}"
  fi
  
  # æ£€æŸ¥ç½‘ç»œçŠ¶æ€
  echo -e "${BLUE}[i] === ç½‘ç»œçŠ¶æ€ ===${RESET}"
  if command -v netstat >/dev/null 2>&1; then
    if netstat -tlnp 2>/dev/null | grep -q ":3006"; then
      port_info=$(netstat -tlnp 2>/dev/null | grep ":3006" | head -1)
      echo -e "${GREEN}  âœ“ ç«¯å£3006å·²ç»‘å®š${RESET}"
      echo -e "${BLUE}    è¯¦æƒ…: $port_info${RESET}"
    else
      echo -e "${YELLOW}  ! ç«¯å£3006æœªç»‘å®š${RESET}"
    fi
  else
    echo -e "${YELLOW}  ! netstatå‘½ä»¤ä¸å¯ç”¨ï¼Œæ— æ³•æ£€æŸ¥ç«¯å£${RESET}"
  fi
  
  # æ€»ä½“çŠ¶æ€è¯„ä¼°
  echo -e "${BLUE}[i] === æ€»ä½“çŠ¶æ€è¯„ä¼° ===${RESET}"
  if [ $tools_available -ge 7 ] && [ $component_count -ge 2 ]; then
    echo -e "${GREEN}  âœ… ç³»ç»ŸçŠ¶æ€ä¼˜ç§€ï¼Œå¯ä»¥æ­£å¸¸æŒ–çŸ¿${RESET}"
  elif [ $tools_available -ge 5 ] && [ $component_count -ge 1 ]; then
    echo -e "${YELLOW}  âš ï¸  ç³»ç»ŸçŠ¶æ€è‰¯å¥½ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯ç”¨${RESET}"
  else
    echo -e "${RED}  âŒ ç³»ç»ŸçŠ¶æ€ä¸ä½³ï¼Œéœ€è¦é‡æ–°å®‰è£…${RESET}"
  fi
  
  echo ""
  echo -e "${BLUE}[i] å¸¸ç”¨æ“ä½œ:${RESET}"
  echo -e "  - æŸ¥çœ‹å®æ—¶æ—¥å¿—: screen -r nockchain"
  echo -e "  - é‡å¯èŠ‚ç‚¹: å…ˆåœæ­¢æœåŠ¡ï¼Œå†å¯åŠ¨èŠ‚ç‚¹"
  echo -e "  - æ£€æŸ¥é”™è¯¯: tail -f logs/nockchain.log"
  
  pause_and_return
}

function pause_and_return() {
  echo ""
  read -n1 -r -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..." key
  main_menu
}

# ========= ä¸»èœå• =========
function main_menu() {
  show_banner
  echo "è¯·é€‰æ‹©æ“ä½œ:"
  echo ""
  echo "ğŸ”§ ç¯å¢ƒå‡†å¤‡:"
  echo "  1) ğŸ¯ å®Œæ•´ç¯å¢ƒå®‰è£…ï¼ˆæ¨èé¦–æ¬¡è¿è¡Œï¼‰"
  echo "  2) ğŸ”¨ æ„å»ºNockchainé¡¹ç›®"
  echo ""
  echo "ğŸ”‘ é’±åŒ…ç®¡ç†:"
  echo "  3) ğŸ”‘ ç”Ÿæˆæ–°é’±åŒ…"
  echo "  4) ğŸ“ è®¾ç½®/æ›´æ”¹æŒ–çŸ¿å…¬é’¥"
  echo ""
  echo "âš¡ èŠ‚ç‚¹ç®¡ç†:"
  echo "  5) ğŸš€ å¯åŠ¨æŒ–çŸ¿èŠ‚ç‚¹"
  echo "  6) ğŸ“Š æŸ¥çœ‹èŠ‚ç‚¹æ—¥å¿—"
  echo "  7) â¹ï¸  åœæ­¢æ‰€æœ‰æœåŠ¡"
  echo ""
  echo "ğŸ” çŠ¶æ€ç›‘æ§:"
  echo "  8) ğŸ” æ£€æŸ¥å®Œæ•´çŠ¶æ€"
  echo ""
  echo "  0) é€€å‡ºè„šæœ¬"
  echo ""
  echo -e "${CYAN}ğŸ’¡ ä½¿ç”¨è¯´æ˜:${RESET}"
  echo -e "${CYAN}   é¦–æ¬¡ä½¿ç”¨: 1 â†’ 2 â†’ 3 â†’ 4 â†’ 5${RESET}"
  echo -e "${CYAN}   æ—¥å¸¸ä½¿ç”¨: æ£€æŸ¥çŠ¶æ€(8) â†’ å¯åŠ¨èŠ‚ç‚¹(5) â†’ æŸ¥çœ‹æ—¥å¿—(6)${RESET}"
  echo -e "${CYAN}   æ•…éšœæ’é™¤: åœæ­¢æœåŠ¡(7) â†’ æ£€æŸ¥çŠ¶æ€(8) â†’ é‡æ–°å¯åŠ¨${RESET}"
  echo ""
  read -p "è¯·è¾“å…¥ç¼–å· (0-8): " choice

  case "$choice" in
    1) complete_environment_setup ;;
    2) build_nockchain_complete ;;
    3) generate_wallet ;;
    4) set_mining_pubkey ;;
    5) start_mining_node ;;
    6) view_node_logs ;;
    7) stop_all_services ;;
    8) check_complete_status ;;
    0) echo -e "${GREEN}æ„Ÿè°¢ä½¿ç”¨Nockchainç®¡ç†è„šæœ¬ï¼Œå†è§ï¼${RESET}"; exit 0 ;;
    *) echo -e "${RED}[-] æ— æ•ˆé€‰é¡¹ï¼Œè¯·è¾“å…¥0-8${RESET}"; pause_and_return ;;
  esac
}

# æ£€æŸ¥æƒé™
if [ "$EUID" -eq 0 ]; then
  echo -e "${RED}[-] è¯·ä¸è¦ä»¥rootç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬${RESET}"
  exit 1
fi

# å¯åŠ¨ä¸»èœå•
main_menu
