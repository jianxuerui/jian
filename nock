#!/bin/bash
# ==============================================================================
# Nockchain æŒ–çŸ¿åŠ©æ‰‹ (K2 å¢å¼ºèåˆç‰ˆ v8.0 - èœå•ç›´è¾¾ç‰ˆ)
# ==============================================================================
# ä½œè€…: K2 èŠ‚ç‚¹æ•™ç¨‹åˆ†äº« (AI ç»ˆæç¦»çº¿å†…æ ¸ç‰ˆ)
#
# v8.0 æ›´æ–°æ—¥å¿—:
# - [æµç¨‹é‡æ„] æ”¹ä¸ºâ€œèœå•ç›´è¾¾â€æ¨¡å‹ï¼Œç”¨æˆ·ä½¿ç”¨ root æƒé™è¿è¡Œä¸€æ¬¡å³å¯ã€‚
# - è„šæœ¬ä¼šè‡ªåŠ¨åˆ›å»º 'miner' ç”¨æˆ·ï¼Œå¹¶åœ¨åå°ä»¥è¯¥ç”¨æˆ·èº«ä»½æ‰§è¡Œç¼–è¯‘å’Œè¿è¡Œã€‚
# - ä¿ç•™äº† v7 çš„æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å’Œå®‰å…¨å®è·µï¼ˆå¦‚ä½¿ç”¨é root ç”¨æˆ·æŒ–çŸ¿ï¼‰ã€‚
# - ç®€åŒ–äº†ç”¨æˆ·æ“ä½œï¼Œæ— éœ€æ‰‹åŠ¨åˆ‡æ¢ç”¨æˆ·ã€‚
# ==============================================================================
set -e

# --- å…¨å±€é…ç½® ---
MINER_USERNAME="miner"
MINER_HOME="/home/${MINER_USERNAME}"
NCK_DIR="${MINER_HOME}/nockchain"
ENV_FILE="${NCK_DIR}/.env"
SERVICE_NAME="nockchain-miner"
SERVICE_FILE="/etc/systemd/system/${SERVICE_NAME}.service"

# --- é¢œè‰²å®šä¹‰ ---
if [ -t 1 ]; then
    RESET='\033[0m'; BOLD='\033[1m'; GREEN='\033[0;32m'; BLUE='\033[0;34m';
    YELLOW='\033[1;33m'; RED='\033[0;31m'; PURPLE='\033[0;35m'; CYAN='\033[0;36m'
else
    RESET=''; BOLD=''; GREEN=''; BLUE=''; YELLOW=''; RED=''; PURPLE=''; CYAN=''
fi

# --- å†…æ ¸æ•°æ® ---
read -r -d '' HOON_KERNEL_CONTENT <<'EOF'
::
/+  sys/hoon
++  ride  |%
          --
++  ver
  |%
  ++  ost
    |%
    ++  arvo  0vI.need
    ++  vere  ~
    --
  ++  kelvin  (as-co:co /(~ . 400))
  ++  send  =>((mote ovum) (give:ost ovum))
  ++  give
    |=  a=ovum
    ~|  [! a]
    !!
  ++  kiln
    |%
    ++  sins  |=(a=ovum (send:ost a))
    ++  fard  |=(a=ovum (send:ost a))
    --
  ++  hoon-version   139
  --
EOF

# ==============================================================================
# === åŠ©æ‰‹å‡½æ•° ===
# ==============================================================================

# æ£€æŸ¥æ˜¯å¦ä»¥ root èº«ä»½è¿è¡Œ
function check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        echo -e "${RED}é”™è¯¯: æ­¤è„šæœ¬éœ€è¦ä»¥ root æƒé™è¿è¡Œã€‚${RESET}"
        echo -e "${YELLOW}è¯·ä½¿ç”¨ 'sudo ./your_script_name.sh' æˆ–åˆ‡æ¢åˆ° root ç”¨æˆ·åè¿è¡Œã€‚${RESET}"
        exit 1
    fi
}

# æ˜¾ç¤ºæ¨ªå¹…
function show_banner() {
    clear
    echo -e "${BOLD}${BLUE}======================================================${RESET}"
    echo -e "${BOLD}${BLUE} Nockchain æŒ–çŸ¿åŠ©æ‰‹ (K2 å¢å¼ºèåˆç‰ˆ v8.0)${RESET}"
    echo -e "${BOLD}${BLUE}======================================================${RESET}"
    echo -e "âœ¨ ${BOLD}${PURPLE}å†…æ ¸å¢å¼º: ä½¿ç”¨å†…ç½® v139 å†…æ ¸ï¼${RESET}"
    echo -e "âš™ï¸ ${BOLD}${CYAN}è¿è¡Œæ¨¡å¼: èœå•ç›´è¾¾ (éœ€è¦ Root æƒé™)${RESET}"
    if id "${MINER_USERNAME}" &>/dev/null; then
        echo -e "ğŸ‘¤ ${GREEN}ä¸“ç”¨ç”¨æˆ· '${MINER_USERNAME}' å·²åˆ›å»ºã€‚${RESET}"
    else
        echo -e "ğŸ‘¤ ${YELLOW}ä¸“ç”¨ç”¨æˆ· '${MINER_USERNAME}' å¾…åˆ›å»º (å°†åœ¨å®‰è£…æ—¶è‡ªåŠ¨å¤„ç†)ã€‚${RESET}"
    fi
    echo "ğŸ“Œ ä½œè€…: K2 èŠ‚ç‚¹æ•™ç¨‹åˆ†äº«"
    echo "------------------------------------------------------"
    echo ""
}

# è·å–CPUæ ¸å¿ƒæ•°
function get_num_cores() {
    nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 4
}

# æš‚åœå¹¶è¿”å›
function pause_and_return() {
    echo ""
    read -r -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..." -s -n 1
    echo
}

# æ£€æŸ¥ systemd æ”¯æŒ
function check_systemd() {
    if [ -d /run/systemd/system ]; then
        echo "true"
    else
        echo "false"
    fi
}

# ==============================================================================
# === æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ===
# ==============================================================================

function install_all() {
    check_root
    show_banner
    echo -e "${YELLOW}[*] å¼€å§‹å…¨æ–°å®‰è£… Nockchain...${RESET}"

    # --- æ­¥éª¤ 1: æ¸…ç†å¹¶åˆ›å»ºç”¨æˆ· ---
    echo -e "${BLUE}--- æ­¥éª¤ 1/5: å‡†å¤‡ä¸“ç”¨ç”¨æˆ· '${MINER_USERNAME}' ---${RESET}"
    if id "${MINER_USERNAME}" &>/dev/null; then
        echo -e "${YELLOW}[!] æ£€æµ‹åˆ°æ—§ç”¨æˆ· '${MINER_USERNAME}'ï¼Œæ­£åœ¨æ¸…ç†...${RESET}"
        # åœæ­¢å¯èƒ½ç”±è¯¥ç”¨æˆ·è¿è¡Œçš„ä»»ä½•è¿›ç¨‹
        if systemctl is-active --quiet "$SERVICE_NAME"; then
            systemctl stop "$SERVICE_NAME"
            systemctl disable "$SERVICE_NAME"
            rm -f "$SERVICE_FILE"
            systemctl daemon-reload
        fi
        killall -u "${MINER_USERNAME}" 2>/dev/null || true
        userdel -r "${MINER_USERNAME}" 2>/dev/null || true
        echo -e "${GREEN}[+] æ—§ç”¨æˆ·åŠç›¸å…³æœåŠ¡å·²æ¸…ç†ã€‚${RESET}"
    fi
    
    echo -e "${CYAN}æ­£åœ¨åˆ›å»ºæ–°ç”¨æˆ· '${MINER_USERNAME}'...${RESET}"
    # å…¼å®¹å„ç§ç³»ç»Ÿçš„ useradd
    if command -v adduser &>/dev/null && grep -q -i "debian\|ubuntu" /etc/os-release; then
        adduser --disabled-password --gecos "" "${MINER_USERNAME}"
    else
        useradd -m -s /bin/bash "${MINER_USERNAME}"
    fi
    echo -e "${GREEN}[âœ“] ç”¨æˆ·åˆ›å»ºæˆåŠŸï¼${RESET}"

    # --- æ­¥éª¤ 2: å®‰è£…ç³»ç»Ÿä¾èµ– (ä»¥ root èº«ä»½) ---
    echo -e "${BLUE}--- æ­¥éª¤ 2/5: å®‰è£…ç³»ç»Ÿä¾èµ– ---${RESET}"
    (
        set -e
        # å°è¯•ç”¨å„ç§åŒ…ç®¡ç†å™¨å®‰è£…
        if command -v apt-get &>/dev/null; then
            apt-get update -y >/dev/null 2>&1
            apt-get install -y clang llvm libclang-dev pkg-config libssl-dev build-essential cmake git make curl dos2unix
        elif command -v dnf &>/dev/null; then
            dnf install -y clang llvm-devel libclang-devel pkgconfig openssl-devel cmake git make curl dos2unix
            dnf groupinstall -y 'Development Tools'
        elif command -v pacman &>/dev/null; then
            pacman -Syu --noconfirm --needed clang llvm libclang pkg-config openssl cmake git make curl dos2unix base-devel
        else
            echo -e "${RED}é”™è¯¯: æœªçŸ¥çš„åŒ…ç®¡ç†å™¨ã€‚è¯·æ‰‹åŠ¨å®‰è£…æ‰€éœ€ä¾èµ–ã€‚${RESET}"
            exit 1
        fi
    )
    echo -e "${GREEN}[âœ“] ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆã€‚${RESET}"

    # --- æ­¥éª¤ 3 & 4: å…‹éš†ã€ç¼–è¯‘ (åˆ‡æ¢åˆ° miner ç”¨æˆ·æ‰§è¡Œ) ---
    echo -e "${BLUE}--- æ­¥éª¤ 3/5: å®‰è£… Rust (ä»¥ '${MINER_USERNAME}' ç”¨æˆ·èº«ä»½) ---${RESET}"
    echo -e "${BLUE}--- æ­¥éª¤ 4/5: å…‹éš†å’Œç¼–è¯‘ Nockchain (ä»¥ '${MINER_USERNAME}' ç”¨æˆ·èº«ä»½) ---${RESET}"
    echo -e "${YELLOW}è¿™éƒ¨åˆ†å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…...${RESET}"
    
    # ä½¿ç”¨ su å’Œ heredoc åœ¨ miner ç”¨æˆ·ç¯å¢ƒä¸­æ‰§è¡Œä¸€é•¿ä¸²å‘½ä»¤
    su - "${MINER_USERNAME}" -c bash <<'EOF'
    set -euo pipefail # åœ¨å­ shell ä¸­ä¹Ÿéœ€è¦è®¾ç½®
    
    # å®‰è£… Rust
    if ! command -v cargo &>/dev/null; then
        echo "æ­£åœ¨å®‰è£… Rust..."
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    fi
    source "$HOME/.cargo/env"
    
    # å®šä¹‰å˜é‡
    NCK_DIR_SUB="$HOME/nockchain"
    
    # å…‹éš†å’Œç¼–è¯‘
    echo "æ­£åœ¨å…‹éš† Nockchain ä»“åº“..."
    rm -rf "$NCK_DIR_SUB" # ç¡®ä¿æ˜¯å…¨æ–°çš„
    git clone https://github.com/zorp-corp/nockchain "$NCK_DIR_SUB"
    cd "$NCK_DIR_SUB"
    
    echo "æ­£åœ¨æ³¨å…¥å¢å¼ºç‰ˆå†…æ ¸..."
    echo -n "$HOON_KERNEL_CONTENT" > "$NCK_DIR_SUB/pkg/sys/hoon"
    echo "å†…æ ¸æ³¨å…¥æˆåŠŸï¼"
    
    echo "æ­£åœ¨ç¼–è¯‘ï¼Œè¿™å°†èŠ±è´¹å‡ åˆ†é’Ÿæ—¶é—´..."
    # ç¼–è¯‘ hoonc å’Œå…¶ä»–ç»„ä»¶
    cargo build --release -p hoonc
    mkdir -p assets
    "$NCK_DIR_SUB/target/release/hoonc" pkg/miner.hoon > assets/miner.jam
    "$NCK_DIR_SUB/target/release/hoonc" pkg/dumb.hoon > assets/dumb.jam
    "$NCK_DIR_SUB/target/release/hoonc" pkg/wal.hoon > assets/wal.jam
    
    # ä¼˜åŒ–ç¼–è¯‘
    export RUSTFLAGS="-C target-cpu=native -C opt-level=3"
    export CARGO_PROFILE_RELEASE_LTO="true"
    cargo build --release --workspace --exclude hoonc -j"$(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 4)"
    
    # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶åˆ° PATH
    cp "$NCK_DIR_SUB/target/release/nockchain" "$HOME/.cargo/bin/"
    echo "ç¼–è¯‘å®Œæˆï¼"
EOF

    local exit_code=$?
    if [ "$exit_code" -ne 0 ]; then
        echo -e "\n${RED}å®‰è£…å¤±è´¥ï¼è¯·æ£€æŸ¥ä¸Šé¢çš„é”™è¯¯ä¿¡æ¯ã€‚${RESET}"
    else
        echo -e "\n${GREEN}[âœ“] Nockchain å®‰è£…æˆåŠŸï¼${RESET}"
        echo -e "${YELLOW}--- æ­¥éª¤ 5/5: å®Œæˆ ---${RESET}"
        echo -e "${CYAN}æ¥ä¸‹æ¥ï¼Œè¯·ä½¿ç”¨èœå•é€‰é¡¹ '2' æ¥è®¾ç½®æ‚¨çš„æŒ–çŸ¿å…¬é’¥ã€‚${RESET}"
    fi
    pause_and_return
}

function set_pubkey() {
    check_root
    show_banner
    if [ ! -d "$NCK_DIR" ]; then
        echo -e "${RED}é”™è¯¯: Nockchain å°šæœªå®‰è£…ã€‚è¯·å…ˆé€‰æ‹© '1' è¿›è¡Œå®‰è£…ã€‚${RESET}"
        pause_and_return
        return
    fi
    
    local pubkey
    read -r -p "è¯·è¾“å…¥æ‚¨çš„128ä½æŒ–çŸ¿å…¬é’¥: " pubkey
    
    # éªŒè¯å…¬é’¥æ ¼å¼ (128ä¸ªåå…­è¿›åˆ¶å­—ç¬¦)
    if ! [[ "$pubkey" =~ ^[0-9a-fA-F]{128}$ ]]; then
        echo -e "\n${RED}é”™è¯¯: å…¬é’¥æ ¼å¼æ— æ•ˆã€‚å®ƒåº”è¯¥æ˜¯128ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ï¼ˆ0-9, a-fï¼‰ã€‚${RESET}"
        pause_and_return
        return
    fi
    
    # åˆ›å»ºå¹¶å†™å…¥ .env æ–‡ä»¶
    touch "$ENV_FILE"
    # ç¡®ä¿æ–‡ä»¶å½’å±æ­£ç¡®
    chown "${MINER_USERNAME}:${MINER_USERNAME}" "$ENV_FILE"
    
    # åˆ é™¤æ—§æ¡ç›®å¹¶æ·»åŠ æ–°æ¡ç›®
    sed -i '/^MINING_PUBKEY=/d' "$ENV_FILE"
    sed -i '/^MINER_THREADS=/d' "$ENV_FILE"
    echo "MINING_PUBKEY=$pubkey" >> "$ENV_FILE"
    echo "MINER_THREADS=$(get_num_cores)" >> "$ENV_FILE"
    
    echo -e "\n${GREEN}[âœ“] é…ç½®å·²æˆåŠŸä¿å­˜åˆ°: ${ENV_FILE}${RESET}"
    echo -e "${CYAN}å…¬é’¥è®¾ç½®ä¸º: ${pubkey:0:10}...${pubkey: -10}${RESET}"
    echo -e "${CYAN}æŒ–çŸ¿çº¿ç¨‹æ•°è®¾ç½®ä¸º: $(get_num_cores)${RESET}"
    pause_and_return
}

function start_node() {
    check_root
    show_banner
    if [[ "$(check_systemd)" != "true" ]]; then
        echo -e "${RED}é”™è¯¯: ç³»ç»Ÿä¸æ”¯æŒ Systemdï¼Œæ— æ³•åˆ›å»ºæœåŠ¡ã€‚${RESET}"
        pause_and_return
        return
    fi
    if [ ! -f "$ENV_FILE" ] || ! grep -q "MINING_PUBKEY" "$ENV_FILE"; then
        echo -e "${RED}é”™è¯¯: å°šæœªè®¾ç½®å…¬é’¥ã€‚è¯·å…ˆé€‰æ‹© '2' è¿›è¡Œè®¾ç½®ã€‚${RESET}"
        pause_and_return
        return
    fi
    
    echo -e "${YELLOW}[*] æ­£åœ¨åˆ›å»ºå¹¶å¯åŠ¨ systemd æœåŠ¡...${RESET}"
    
    # åˆ›å»º systemd service æ–‡ä»¶
    cat <<EOF > "$SERVICE_FILE"
[Unit]
Description=$SERVICE_NAME service
After=network-online.target

[Service]
User=${MINER_USERNAME}
Group=$(id -gn "${MINER_USERNAME}")
WorkingDirectory=${NCK_DIR}
EnvironmentFile=${ENV_FILE}
ExecStart=${MINER_HOME}/.cargo/bin/nockchain
Restart=on-failure
RestartSec=10
LimitNOFILE=65536
Nice=-5

[Install]
WantedBy=multi-user.target
EOF

    # é‡æ–°åŠ è½½ã€å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡
    systemctl daemon-reload
    systemctl enable "$SERVICE_NAME"
    systemctl restart "$SERVICE_NAME"
    
    echo -e "\n${GREEN}[âœ“] æœåŠ¡ '${SERVICE_NAME}' å·²æˆåŠŸå¯åŠ¨å¹¶è®¾ç½®ä¸ºå¼€æœºè‡ªå¯ï¼${RESET}"
    echo -e "${CYAN}æ‚¨å¯ä»¥ä½¿ç”¨èœå•é€‰é¡¹ '5' æ¥æŸ¥çœ‹å®æ—¶æ—¥å¿—ã€‚${RESET}"
    pause_and_return
}

function stop_node() {
    check_root
    show_banner
    if ! systemctl list-units --full -all | grep -q "${SERVICE_NAME}.service"; then
        echo -e "${YELLOW}æç¤º: æœåŠ¡æœªå®‰è£…æˆ–æœªæ›¾è¿è¡Œè¿‡ï¼Œæ— éœ€åœæ­¢ã€‚${RESET}"
        pause_and_return
        return
    fi
    
    echo -e "${YELLOW}[*] æ­£åœ¨åœæ­¢ systemd æœåŠ¡...${RESET}"
    systemctl stop "$SERVICE_NAME"
    echo -e "\n${GREEN}[âœ“] æœåŠ¡ '${SERVICE_NAME}' å·²åœæ­¢ã€‚${RESET}"
    pause_and_return
}

function view_logs() {
    check_root
    show_banner
    if ! systemctl list-units --full -all | grep -q "${SERVICE_NAME}.service"; then
        echo -e "${YELLOW}æç¤º: æœåŠ¡æœªå®‰è£…ï¼Œæ— æ³•æŸ¥çœ‹æ—¥å¿—ã€‚${RESET}"
        pause_and_return
        return
    fi
    
    echo -e "${YELLOW}æ­£åœ¨æ˜¾ç¤ºå®æ—¶æ—¥å¿—... æŒ‰ Ctrl+C é€€å‡ºæ—¥å¿—å¹¶è¿”å›èœå•ã€‚${RESET}"
    echo "------------------------------------------------------"
    journalctl -u "$SERVICE_NAME" -f --no-pager
    pause_and_return
}

# ==============================================================================
# === ä¸»èœå•å’Œå¾ªç¯ ===
# ==============================================================================

function main_menu() {
    show_banner
    echo -e "${BOLD}${GREEN}--- ä¸»èœå• ---${RESET}"
    echo "è¯·é€‰æ‹©è¦æ‰§è¡Œçš„æ“ä½œ:"
    echo ""
    echo -e "  ${CYAN}1)${RESET} å…¨æ–°å®‰è£… Nockchain (ä¼šæ¸…ç©ºæ—§æ•°æ®)"
    echo -e "  ${CYAN}2)${RESET} è®¾ç½®/æ›´æ–°æŒ–çŸ¿å…¬é’¥"
    echo ""
    if [[ "$(check_systemd)" == "true" ]]; then
        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        if systemctl is-active --quiet "$SERVICE_NAME"; then
            SERVICE_STATUS="${GREEN}(è¿è¡Œä¸­)${RESET}"
        else
            SERVICE_STATUS="${RED}(å·²åœæ­¢)${RESET}"
        fi
        echo -e "  ${CYAN}3)${RESET} ${BOLD}å¯åŠ¨${RESET}æŒ–çŸ¿æœåŠ¡ ${SERVICE_STATUS}"
        echo -e "  ${CYAN}4)${RESET} ${BOLD}åœæ­¢${RESET}æŒ–çŸ¿æœåŠ¡"
        echo -e "  ${CYAN}5)${RESET} æŸ¥çœ‹å®æ—¶æ—¥å¿—"
    else
        echo -e "  ${RED}3-5) (ä¸å¯ç”¨) æ‚¨çš„ç³»ç»Ÿä¸æ”¯æŒ Systemd${RESET}"
    fi
    echo ""
    echo -e "  ${YELLOW}0) é€€å‡ºè„šæœ¬${RESET}"
    echo ""
    
    read -r -p "è¯·è¾“å…¥é€‰é¡¹ç¼–å·: " choice
    
    case "$choice" in
        1) install_all ;;
        2) set_pubkey ;;
        3) start_node ;;
        4) stop_node ;;
        5) view_logs ;;
        0) echo -e "${BLUE}æ„Ÿè°¢ä½¿ç”¨ï¼å†è§ã€‚${RESET}"; exit 0 ;;
        *) echo -e "${RED}æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚${RESET}"; sleep 1 ;;
    esac
}

# --- è„šæœ¬å…¥å£ ---
# æ£€æŸ¥rootæƒé™ï¼Œç„¶åç›´æ¥è¿›å…¥ä¸»å¾ªç¯
check_root
while true; do
    main_menu
done
