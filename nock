#!/bin/bash

# Nockchain èŠ‚ç‚¹ç®¡ç†è„šæœ¬ - ä¿®å¤ dpkg lock-frontend é”™è¯¯ç‰ˆ
# ç‰ˆæœ¬ï¼š8.0 è§£å†³ dpkg é”æ–‡ä»¶å†²çªä¸“ç‰ˆ
# ä¸»è¦ä¿®å¤ï¼šdpkg lock-frontend é”™è¯¯ã€åŒ…ç®¡ç†å†²çªã€é”æ–‡ä»¶æ¸…ç†

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# é…ç½®å¸¸é‡
NOCKCHAIN_REPO="https://github.com/zorp-corp/nockchain.git"
ENV_FILE=".env"
ENV_EXAMPLE=".env_example"
LOG_FILE="nockchain.log"
BACKUP_DIR="backups"

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_debug() {
    echo -e "${CYAN}[DEBUG]${NC} $1"
}

log_success() {
    echo -e "${PURPLE}[SUCCESS]${NC} $1"
}

# ä¿®å¤ dpkg é”æ–‡ä»¶é—®é¢˜
fix_dpkg_lock_issues() {
    log_info "æ£€æŸ¥å¹¶ä¿®å¤ dpkg é”æ–‡ä»¶é—®é¢˜..."
    
    # æ£€æŸ¥æ˜¯å¦å­˜åœ¨é”æ–‡ä»¶å†²çª
    local lock_files=(
        "/var/lib/dpkg/lock"
        "/var/lib/dpkg/lock-frontend"
        "/var/lib/apt/lists/lock"
        "/var/cache/apt/archives/lock"
    )
    
    local has_lock_issue=false
    
    # æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿è¡Œçš„ apt è¿›ç¨‹
    local apt_processes=$(ps aux | grep -E '(apt|apt-get|dpkg|aptitude)' | grep -v grep | grep -v "fix_dpkg_lock" | wc -l)
    
    if [ "$apt_processes" -gt 0 ]; then
        log_warn "æ£€æµ‹åˆ°æ­£åœ¨è¿è¡Œçš„åŒ…ç®¡ç†è¿›ç¨‹"
        ps aux | grep -E '(apt|apt-get|dpkg|aptitude)' | grep -v grep | grep -v "fix_dpkg_lock"
        has_lock_issue=true
    fi
    
    # æ£€æŸ¥é”æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    for lock_file in "${lock_files[@]}"; do
        if [ -f "$lock_file" ]; then
            log_warn "å‘ç°é”æ–‡ä»¶: $lock_file"
            has_lock_issue=true
        fi
    done
    
    if [ "$has_lock_issue" = true ]; then
        log_warn "å‘ç° dpkg é”æ–‡ä»¶é—®é¢˜ï¼Œå¼€å§‹ä¿®å¤..."
        
        # å°è¯•ä¼˜é›…åœ°ç­‰å¾…è¿›ç¨‹å®Œæˆ
        log_info "ç­‰å¾… 30 ç§’è®©è¿›ç¨‹è‡ªç„¶å®Œæˆ..."
        sleep 30
        
        # å†æ¬¡æ£€æŸ¥è¿›ç¨‹
        apt_processes=$(ps aux | grep -E '(apt|apt-get|dpkg|aptitude)' | grep -v grep | grep -v "fix_dpkg_lock" | wc -l)
        
        if [ "$apt_processes" -gt 0 ]; then
            log_warn "è¿›ç¨‹ä»åœ¨è¿è¡Œï¼Œå‡†å¤‡å¼ºåˆ¶ç»ˆæ­¢..."
            
            # è·å–è¿›ç¨‹ ID å¹¶ç»ˆæ­¢
            local pids=$(ps aux | grep -E '(apt|apt-get|dpkg|aptitude)' | grep -v grep | grep -v "fix_dpkg_lock" | awk '{print $2}')
            
            for pid in $pids; do
                if [ -n "$pid" ] && [ "$pid" != "$$" ]; then
                    log_info "ç»ˆæ­¢è¿›ç¨‹ PID: $pid"
                    sudo kill -TERM "$pid" 2>/dev/null || true
                fi
            done
            
            # ç­‰å¾…ä¼˜é›…ç»ˆæ­¢
            sleep 5
            
            # å¼ºåˆ¶ç»ˆæ­¢ä»åœ¨è¿è¡Œçš„è¿›ç¨‹
            pids=$(ps aux | grep -E '(apt|apt-get|dpkg|aptitude)' | grep -v grep | grep -v "fix_dpkg_lock" | awk '{print $2}')
            for pid in $pids; do
                if [ -n "$pid" ] && [ "$pid" != "$$" ]; then
                    log_warn "å¼ºåˆ¶ç»ˆæ­¢è¿›ç¨‹ PID: $pid"
                    sudo kill -9 "$pid" 2>/dev/null || true
                fi
            done
        fi
        
        # åˆ é™¤é”æ–‡ä»¶
        log_info "æ¸…ç†é”æ–‡ä»¶..."
        for lock_file in "${lock_files[@]}"; do
            if [ -f "$lock_file" ]; then
                log_info "åˆ é™¤é”æ–‡ä»¶: $lock_file"
                sudo rm -f "$lock_file" 2>/dev/null || true
            fi
        done
        
        # é‡æ–°é…ç½® dpkg
        log_info "é‡æ–°é…ç½® dpkg..."
        sudo dpkg --configure -a 2>/dev/null || true
        
        # æ¸…ç†å¹¶æ›´æ–°åŒ…ç¼“å­˜
        log_info "æ¸…ç†åŒ…ç¼“å­˜..."
        sudo apt clean 2>/dev/null || true
        
        log_success "dpkg é”æ–‡ä»¶é—®é¢˜ä¿®å¤å®Œæˆ"
    else
        log_success "æ²¡æœ‰å‘ç° dpkg é”æ–‡ä»¶é—®é¢˜"
    fi
}

# å®‰å…¨çš„ apt å‘½ä»¤æ‰§è¡Œå™¨
safe_apt_command() {
    local command="$1"
    local max_retries=3
    local retry_count=0
    
    while [ $retry_count -lt $max_retries ]; do
        log_info "æ‰§è¡Œ: $command (å°è¯• $((retry_count + 1))/$max_retries)"
        
        # è®¾ç½®éäº¤äº’æ¨¡å¼
        export DEBIAN_FRONTEND=noninteractive
        
        if eval "$command"; then
            log_success "å‘½ä»¤æ‰§è¡ŒæˆåŠŸ: $command"
            return 0
        else
            log_warn "å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œæ£€æŸ¥ dpkg é”æ–‡ä»¶..."
            retry_count=$((retry_count + 1))
            
            if [ $retry_count -lt $max_retries ]; then
                fix_dpkg_lock_issues
                sleep 5
            fi
        fi
    done
    
    log_error "å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°: $command"
    return 1
}

# æ£€æŸ¥ç³»ç»Ÿèµ„æº - ä¿®å¤ç®—æœ¯è¡¨è¾¾å¼é”™è¯¯
check_system_resources_enhanced() {
    log_info "æ‰§è¡Œå¢å¼ºç³»ç»Ÿèµ„æºæ£€æŸ¥..."
    
    # ä½¿ç”¨ä¼ ç»Ÿæ–¹å¼åˆå§‹åŒ–è­¦å‘Šè®¡æ•°å™¨
    local warnings=0
    
    # æ£€æŸ¥å†…å­˜ - æ›´ä¸¥æ ¼çš„è¦æ±‚
    local total_mem=$(free -g | awk '/^Mem:/{print $2}')
    local available_mem=$(free -g | awk '/^Mem:/{print $7}')
    
    if [ "$total_mem" -lt 32 ]; then
        log_error "ç³»ç»Ÿå†…å­˜ä¸è¶³: ${total_mem}GB (æœ€ä½è¦æ±‚32GBï¼Œæ¨è64GB+)"
        log_error "hoonc ç¼–è¯‘éœ€è¦å¤§é‡å†…å­˜ï¼Œå»ºè®®å‡çº§ç¡¬ä»¶æˆ–ä½¿ç”¨äº‘æœåŠ¡å™¨"
        warnings=$((warnings + 1))
    elif [ "$total_mem" -lt 64 ]; then
        log_warn "ç³»ç»Ÿå†…å­˜: ${total_mem}GB (æ¨è64GB+ï¼Œå¯èƒ½å½±å“ç¼–è¯‘é€Ÿåº¦)"
        warnings=$((warnings + 1))
    else
        log_success "ç³»ç»Ÿå†…å­˜: ${total_mem}GB âœ“"
    fi
    
    if [ "$available_mem" -lt 16 ]; then
        log_warn "å¯ç”¨å†…å­˜ä¸è¶³: ${available_mem}GBï¼Œå»ºè®®é‡Šæ”¾å†…å­˜æˆ–é‡å¯ç³»ç»Ÿ"
        warnings=$((warnings + 1))
    fi
    
    # æ£€æŸ¥ç£ç›˜ç©ºé—´
    local disk_space=$(df -BG . | awk 'NR==2 {print $4}' | sed 's/G//')
    if [ "$disk_space" -lt 50 ]; then
        log_error "å¯ç”¨ç£ç›˜ç©ºé—´ä¸è¶³: ${disk_space}GB (æœ€ä½è¦æ±‚50GB)"
        warnings=$((warnings + 1))
    elif [ "$disk_space" -lt 100 ]; then
        log_warn "å¯ç”¨ç£ç›˜ç©ºé—´: ${disk_space}GB (æ¨è100GB+)"
        warnings=$((warnings + 1))
    else
        log_success "å¯ç”¨ç£ç›˜ç©ºé—´: ${disk_space}GB âœ“"
    fi
    
    # æ£€æŸ¥CPUå’Œè´Ÿè½½
    local cpu_cores=$(nproc)
    
    if [ "$cpu_cores" -lt 4 ]; then
        log_warn "CPUæ ¸å¿ƒæ•°: ${cpu_cores}æ ¸ (æ¨è6æ ¸+)"
        warnings=$((warnings + 1))
    else
        log_success "CPUæ ¸å¿ƒæ•°: ${cpu_cores}æ ¸ âœ“"
    fi
    
    # æ£€æŸ¥è™šæ‹Ÿå†…å­˜è®¾ç½®
    local swap_total=$(free -g | awk '/^Swap:/{print $2}')
    if [ "$swap_total" -lt 8 ]; then
        log_warn "Swap ç©ºé—´: ${swap_total}GB (å»ºè®®è‡³å°‘8GB)"
        warnings=$((warnings + 1))
    fi
    
    if [ $warnings -gt 0 ]; then
        log_warn "å‘ç° $warnings ä¸ªèµ„æºè­¦å‘Šï¼Œå¯èƒ½å½±å“ç¼–è¯‘æˆåŠŸç‡"
        read -p "æ˜¯å¦ç»§ç»­å®‰è£…ï¼Ÿå»ºè®®åœ¨äº‘æœåŠ¡å™¨ä¸Šè¿è¡Œ (y/n): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            log_info "å»ºè®®ä½¿ç”¨é…ç½®æ›´é«˜çš„æœåŠ¡å™¨åé‡è¯•"
            exit 1
        fi
    fi
}

# ä¼˜åŒ–ç³»ç»Ÿè®¾ç½®
optimize_system_for_compilation() {
    log_info "ä¼˜åŒ–ç³»ç»Ÿè®¾ç½®ä»¥æé«˜ç¼–è¯‘æˆåŠŸç‡..."
    
    # å¯ç”¨å†…å­˜è¿‡é‡åˆ†é…
    log_info "å¯ç”¨å†…å­˜è¿‡é‡åˆ†é…..."
    sudo sysctl -w vm.overcommit_memory=1 2>/dev/null || true
    
    # è°ƒæ•´ OOM killer è®¾ç½®
    echo 'vm.oom_kill_allocating_task=1' | sudo tee -a /etc/sysctl.conf >/dev/null 2>&1 || true
    
    # å¢åŠ æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
    ulimit -n 65536 2>/dev/null || true
    
    # è®¾ç½®æ›´å¤§çš„æ ˆå¤§å°
    ulimit -s 16384 2>/dev/null || true
    
    # æ¸…ç†ç³»ç»Ÿç¼“å­˜
    log_info "æ¸…ç†ç³»ç»Ÿç¼“å­˜..."
    sudo sync 2>/dev/null || true
    sudo echo 3 | sudo tee /proc/sys/vm/drop_caches >/dev/null 2>&1 || true
    
    log_success "ç³»ç»Ÿä¼˜åŒ–å®Œæˆ"
}

# å®‰è£…ç³»ç»Ÿä¾èµ– - é›†æˆé”æ–‡ä»¶ä¿®å¤
install_system_dependencies_enhanced() {
    log_info "å®‰è£…å¢å¼ºç³»ç»Ÿä¾èµ–..."
    
    # é¦–å…ˆä¿®å¤å¯èƒ½çš„ dpkg é”æ–‡ä»¶é—®é¢˜
    fix_dpkg_lock_issues
    
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        # æ›´æ–°åŒ…åˆ—è¡¨
        safe_apt_command "sudo apt update"
        safe_apt_command "sudo apt upgrade -y"
        
        # æ ¸å¿ƒç¼–è¯‘å·¥å…·
        local core_packages=(
            "build-essential" "cmake" "ninja-build"
            "pkg-config" "autoconf" "automake" "libtool"
            "git" "curl" "wget" "unzip" "lz4"
        )
        
        # LLVM å’Œ Clang ç›¸å…³
        local llvm_packages=(
            "clang" "clang-tools" "clang-format"
            "llvm" "llvm-dev" "llvm-runtime"
            "libclang-dev" "libclang1" "libclang-common-dev"
            "lld" "libc++-dev" "libc++abi-dev"
        )
        
        # ç³»ç»Ÿåº“
        local system_packages=(
            "libssl-dev" "libffi-dev" "zlib1g-dev"
            "libbz2-dev" "libreadline-dev" "libsqlite3-dev"
            "libncursesw5-dev" "xz-utils" "tk-dev"
            "libxml2-dev" "libxmlsec1-dev" "libffi-dev"
            "liblzma-dev" "libleveldb-dev"
        )
        
        # å†…å­˜å’Œæ€§èƒ½ç›¸å…³
        local perf_packages=(
            "htop" "iotop" "sysstat" "psmisc"
            "linux-tools-common" "linux-tools-generic"
        )
        
        log_info "å®‰è£…æ ¸å¿ƒç¼–è¯‘å·¥å…·..."
        safe_apt_command "sudo apt install -y ${core_packages[*]}"
        
        log_info "å®‰è£… LLVM å’Œ Clang..."
        safe_apt_command "sudo apt install -y ${llvm_packages[*]}"
        
        log_info "å®‰è£…ç³»ç»Ÿåº“..."
        safe_apt_command "sudo apt install -y ${system_packages[*]}"
        
        log_info "å®‰è£…æ€§èƒ½ç›‘æ§å·¥å…·..."
        safe_apt_command "sudo apt install -y ${perf_packages[*]}"
        
        log_success "ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"
    fi
    
    # å®‰è£… Rust - æœ€æ–°ç¨³å®šç‰ˆ
    if ! command -v rustc &> /dev/null || ! command -v cargo &> /dev/null; then
        log_info "å®‰è£… Rust æœ€æ–°ç¨³å®šç‰ˆ..."
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
        source $HOME/.cargo/env
        
        # å®‰è£…å¿…è¦çš„ Rust ç»„ä»¶
        rustup component add rustfmt clippy
        
        log_success "Rust å®‰è£…å®Œæˆ: $(rustc --version)"
    else
        log_info "Rust å·²å®‰è£…: $(rustc --version)"
        
        # æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
        log_info "æ›´æ–° Rust åˆ°æœ€æ–°ç‰ˆæœ¬..."
        rustup update stable
        rustup default stable
    fi
}

# æ£€æŸ¥é¡¹ç›®æ ¹ç›®å½•
check_project_root() {
    local current_dir=$(pwd)
    log_debug "å½“å‰ç›®å½•: $current_dir"
    
    if [ -f "Cargo.toml" ] || [ -f "Makefile" ]; then
        if [ -f "Cargo.toml" ] && grep -q "nockchain" "Cargo.toml" 2>/dev/null; then
            log_success "æ£€æµ‹åˆ° Nockchain é¡¹ç›®æ ¹ç›®å½•"
            return 0
        elif [ -f "Makefile" ] && grep -q "nockchain\|hoonc" "Makefile" 2>/dev/null; then
            log_success "æ£€æµ‹åˆ° Nockchain é¡¹ç›®æ ¹ç›®å½•"
            return 0
        fi
    fi
    
    return 1
}

# è‡ªåŠ¨æŸ¥æ‰¾ nockchain ç›®å½•
find_nockchain_directory() {
    log_info "æ­£åœ¨æŸ¥æ‰¾ nockchain é¡¹ç›®ç›®å½•..."
    
    local found_dirs=($(find . -maxdepth 3 -name "nockchain*" -type d 2>/dev/null))
    
    if [ ${#found_dirs[@]} -gt 0 ]; then
        for dir in "${found_dirs[@]}"; do
            if [ -f "$dir/Cargo.toml" ] || [ -f "$dir/Makefile" ]; then
                log_success "æ‰¾åˆ° nockchain é¡¹ç›®ç›®å½•: $dir"
                cd "$dir"
                return 0
            fi
        done
    fi
    
    local parent_dirs=("../nockchain" "../../nockchain" "~/nockchain")
    for dir in "${parent_dirs[@]}"; do
        if [ -d "$dir" ] && ([ -f "$dir/Cargo.toml" ] || [ -f "$dir/Makefile" ]); then
            log_success "æ‰¾åˆ° nockchain é¡¹ç›®ç›®å½•: $dir"
            cd "$dir"
            return 0
        fi
    done
    
    return 1
}

# è‡ªåŠ¨åˆå§‹åŒ–é¡¹ç›®
auto_initialize_project() {
    log_warn "æœªæ‰¾åˆ° nockchain é¡¹ç›®ï¼Œå°†è‡ªåŠ¨åˆå§‹åŒ–..."
    
    read -p "æ˜¯å¦è‡ªåŠ¨å…‹éš† nockchain é¡¹ç›®ï¼Ÿ(y/n): " -n 1 -r
    echo
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        local target_dir="nockchain_$(date +%Y%m%d_%H%M%S)"
        
        log_info "æ­£åœ¨å…‹éš† nockchain é¡¹ç›®åˆ°: $target_dir"
        
        if git clone "$NOCKCHAIN_REPO" "$target_dir"; then
            cd "$target_dir"
            log_success "é¡¹ç›®å…‹éš†æˆåŠŸï¼Œå·²åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•"
            return 0
        else
            log_error "é¡¹ç›®å…‹éš†å¤±è´¥"
            return 1
        fi
    else
        log_error "è¯·æ‰‹åŠ¨è¿›å…¥ nockchain é¡¹ç›®æ ¹ç›®å½•åé‡æ–°è¿è¡Œè„šæœ¬"
        exit 1
    fi
}

# æ™ºèƒ½ç›®å½•æ£€æµ‹å’Œåˆå§‹åŒ–
smart_directory_setup() {
    log_info "å¼€å§‹æ™ºèƒ½ç›®å½•æ£€æµ‹..."
    
    if check_project_root; then
        return 0
    fi
    
    log_warn "å½“å‰ç›®å½•ä¸æ˜¯ nockchain é¡¹ç›®æ ¹ç›®å½•"
    
    if find_nockchain_directory; then
        if check_project_root; then
            return 0
        fi
    fi
    
    auto_initialize_project
}

# åˆå§‹åŒ–ç¯å¢ƒé…ç½®
initialize_environment() {
    log_info "åˆå§‹åŒ–ç¯å¢ƒé…ç½®..."
    
    # è®¾ç½® Rust ç¯å¢ƒ
    if [ -f "$HOME/.cargo/env" ]; then
        source "$HOME/.cargo/env"
    fi
    export PATH="$HOME/.cargo/bin:$PATH"
    
    # è®¾ç½®ç¼–è¯‘ä¼˜åŒ–ç¯å¢ƒå˜é‡
    export RUSTFLAGS="-C target-cpu=native -C opt-level=3"
    export CARGO_NET_RETRY=3
    export CARGO_NET_TIMEOUT=300
    export CARGO_HTTP_TIMEOUT=300
    
    # è®¾ç½® LLVM ç¯å¢ƒå˜é‡
    export LLVM_CONFIG_PATH="/usr/bin/llvm-config"
    export LIBCLANG_PATH="/usr/lib/x86_64-linux-gnu"
    
    # è®¾ç½®éäº¤äº’æ¨¡å¼
    export DEBIAN_FRONTEND=noninteractive
    
    # åˆ›å»ºç¯å¢ƒæ–‡ä»¶
    if [ ! -f "$ENV_FILE" ]; then
        if [ -f "$ENV_EXAMPLE" ]; then
            cp "$ENV_EXAMPLE" "$ENV_FILE"
            log_success "å·²ä» .env_example åˆ›å»º .env æ–‡ä»¶"
        else
            log_info "åˆ›å»ºé»˜è®¤ .env æ–‡ä»¶"
            cat > "$ENV_FILE" << 'EOF'
RUST_LOG=info,nockchain=info,nockchain_libp2p_io=info,libp2p=info,libp2p_quic=info
MINIMAL_LOG_FORMAT=true
MINING_PUBKEY=0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
EOF
        fi
    fi
    
    # åˆ›å»ºå¤‡ä»½ç›®å½•
    [ ! -d "$BACKUP_DIR" ] && mkdir -p "$BACKUP_DIR"
    
    log_success "ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
}

# éªŒè¯128ä½16è¿›åˆ¶æŒ–çŸ¿å…¬é’¥æ ¼å¼
validate_mining_pubkey() {
    local pubkey="$1"
    
    # æ£€æŸ¥æ˜¯å¦ä¸º128ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ï¼ˆ128ä½16è¿›åˆ¶ï¼‰
    if [[ ! "$pubkey" =~ ^[0-9a-fA-F]{128}$ ]]; then
        log_error "æ— æ•ˆçš„æŒ–çŸ¿å…¬é’¥æ ¼å¼"
        log_error "æŒ–çŸ¿å…¬é’¥å¿…é¡»æ˜¯128ä½16è¿›åˆ¶æ ¼å¼ï¼ˆ128ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ï¼‰"
        log_error "ç¤ºä¾‹æ ¼å¼: 1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
        return 1
    fi
    
    return 0
}

# ä¿®å¤ç‰ˆ hoonc å®‰è£…
install_hoonc_fixed() {
    log_info "å¼€å§‹ä¿®å¤ç‰ˆ hoonc ç¼–è¯‘å™¨å®‰è£…..."
    
    # æ¸…ç†ä¹‹å‰çš„æ„å»ºäº§ç‰©
    if [ -d "target" ]; then
        log_info "æ¸…ç†ä¹‹å‰çš„æ„å»ºäº§ç‰©..."
        rm -rf target/
    fi
    
    # æ¸…ç† Cargo ç¼“å­˜
    cargo clean 2>/dev/null || true
    
    # è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
    local cpu_cores=$(nproc)
    export CARGO_BUILD_JOBS=$(( cpu_cores / 2 ))
    export CARGO_TARGET_DIR="$(pwd)/target"
    
    log_info "ä½¿ç”¨ $CARGO_BUILD_JOBS ä¸ªå¹¶è¡Œç¼–è¯‘ä»»åŠ¡"
    log_info "ç›®æ ‡ç›®å½•: $CARGO_TARGET_DIR"
    
    # å°è¯•ä½¿ç”¨ä¸åŒçš„æ–¹æ³•å®‰è£… hoonc
    log_info "å°è¯•æ–¹æ³•1: ä½¿ç”¨ make install-hooncï¼ˆè¶…æ—¶ 20 åˆ†é’Ÿï¼‰..."
    
    if timeout 1200 make install-hoonc; then
        log_success "hoonc ç¼–è¯‘å™¨å®‰è£…æˆåŠŸï¼ˆæ–¹æ³•1ï¼‰"
        return 0
    else
        log_warn "æ–¹æ³•1å¤±è´¥ï¼Œå°è¯•æ–¹æ³•2: ç›´æ¥ä½¿ç”¨ cargo å®‰è£…..."
        
        # æ–¹æ³•2: ç›´æ¥ä½¿ç”¨ cargo å®‰è£…
        if timeout 1800 cargo install --locked --force --path crates/hoonc --bin hoonc; then
            log_success "hoonc ç¼–è¯‘å™¨å®‰è£…æˆåŠŸï¼ˆæ–¹æ³•2ï¼‰"
            return 0
        else
            log_warn "æ–¹æ³•2å¤±è´¥ï¼Œå°è¯•æ–¹æ³•3: é™ä½ä¼˜åŒ–çº§åˆ«..."
            
            # æ–¹æ³•3: é™ä½ä¼˜åŒ–çº§åˆ«
            export RUSTFLAGS="-C opt-level=1"
            if timeout 2400 cargo install --locked --force --path crates/hoonc --bin hoonc; then
                log_success "hoonc ç¼–è¯‘å™¨å®‰è£…æˆåŠŸï¼ˆæ–¹æ³•3ï¼‰"
                return 0
            else
                log_error "æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œhoonc ç¼–è¯‘å™¨å®‰è£…å¤±è´¥"
                log_error "å»ºè®®æ£€æŸ¥ç³»ç»Ÿèµ„æºæˆ–åœ¨æ›´é«˜é…ç½®çš„æœåŠ¡å™¨ä¸Šé‡è¯•"
                return 1
            fi
        fi
    fi
}

# åŠŸèƒ½1ï¼šå®Œæ•´å®‰è£… Nockchain - ä¿®å¤ç‰ˆ
install_nockchain_complete_fixed() {
    log_info "å¼€å§‹ä¿®å¤ç‰ˆå®Œæ•´å®‰è£… Nockchain..."
    
    # ç³»ç»Ÿæ£€æŸ¥å’Œä¼˜åŒ–
    check_system_resources_enhanced
    optimize_system_for_compilation
    install_system_dependencies_enhanced
    initialize_environment
    
    # è®¾ç½®ç¯å¢ƒ
    source $HOME/.cargo/env 2>/dev/null || true
    export PATH="$HOME/.cargo/bin:$PATH"
    
    # æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
    log_info "ç³»ç»Ÿä¿¡æ¯ï¼š"
    log_info "- Rust: $(rustc --version)"
    log_info "- Cargo: $(cargo --version)"
    log_info "- LLVM: $(llvm-config --version 2>/dev/null || echo 'N/A')"
    log_info "- Clang: $(clang --version | head -1 2>/dev/null || echo 'N/A')"
    
    # å®‰è£… hoonc ç¼–è¯‘å™¨ - ä½¿ç”¨ä¿®å¤ç‰ˆæ–¹æ³•
    install_hoonc_fixed || return 1
    
    # éªŒè¯ hoonc å®‰è£…
    if command -v hoonc &> /dev/null; then
        log_success "hoonc éªŒè¯æˆåŠŸ: $(command -v hoonc)"
    else
        log_error "hoonc éªŒè¯å¤±è´¥ï¼Œæœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
        return 1
    fi
    
    # æ„å»ºé¡¹ç›®
    log_info "æ„å»º Nockchain é¡¹ç›®ï¼ˆè¿™å¯èƒ½éœ€è¦å¾ˆé•¿æ—¶é—´ï¼‰..."
    local cpu_cores=$(nproc)
    export CARGO_BUILD_JOBS=$(( cpu_cores / 2 ))
    
    if timeout 3600 make build; then
        log_success "é¡¹ç›®æ„å»ºæˆåŠŸ"
    else
        log_error "é¡¹ç›®æ„å»ºå¤±è´¥æˆ–è¶…æ—¶"
        log_error "å»ºè®®æ£€æŸ¥ç³»ç»Ÿèµ„æºæˆ–å»¶é•¿è¶…æ—¶æ—¶é—´"
        return 1
    fi
    
    # å®‰è£…ç»„ä»¶
    log_info "å®‰è£… Nockchain ç»„ä»¶..."
    
    if make install-nockchain-wallet; then
        log_success "Nockchain é’±åŒ…å®‰è£…æˆåŠŸ"
    else
        log_error "Nockchain é’±åŒ…å®‰è£…å¤±è´¥"
        return 1
    fi
    
    if make install-nockchain; then
        log_success "Nockchain èŠ‚ç‚¹å®‰è£…æˆåŠŸ"
    else
        log_error "Nockchain èŠ‚ç‚¹å®‰è£…å¤±è´¥"
        return 1
    fi
    
    # æ›´æ–° PATH
    if ! grep -q 'export PATH="$HOME/.cargo/bin:$PATH"' ~/.bashrc; then
        echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> ~/.bashrc
        log_success "å·²æ·»åŠ  Cargo bin ç›®å½•åˆ° PATH"
    fi
    
    # ç”Ÿæˆé»˜è®¤çš„128ä½æŒ–çŸ¿å…¬é’¥
    log_info "ç”Ÿæˆ128ä½16è¿›åˆ¶æŒ–çŸ¿å…¬é’¥..."
    local hex_pubkey
    if command -v openssl &> /dev/null; then
        hex_pubkey=$(openssl rand -hex 64)
    else
        hex_pubkey=$(xxd -l 64 -p /dev/urandom | tr -d '\n')
    fi
    
    # æ›´æ–°é…ç½®æ–‡ä»¶
    if [ -f "$ENV_FILE" ]; then
        cp "$ENV_FILE" "${ENV_FILE}.backup.$(date +%Y%m%d_%H%M%S)"
        sed -i "s/^MINING_PUBKEY=.*/MINING_PUBKEY=$hex_pubkey/" "$ENV_FILE"
        log_success "å·²ç”Ÿæˆå¹¶è®¾ç½®128ä½æŒ–çŸ¿å…¬é’¥"
        log_info "æŒ–çŸ¿å…¬é’¥: $hex_pubkey"
    fi
    
    log_success "Nockchain å®Œæ•´å®‰è£…æˆåŠŸï¼"
    log_info "æ‰€æœ‰ç»„ä»¶å·²å®‰è£…å®Œæˆï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨"
}

# åŠŸèƒ½2ï¼šæ›´æ”¹æŒ–çŸ¿å…¬é’¥ï¼ˆ128ä½16è¿›åˆ¶æ ¼å¼ï¼‰
change_mining_pubkey() {
    log_info "æ›´æ”¹æŒ–çŸ¿å…¬é’¥ï¼ˆ128ä½16è¿›åˆ¶æ ¼å¼ï¼‰"
    echo
    log_info "è¯·è¾“å…¥128ä½16è¿›åˆ¶æ ¼å¼çš„æŒ–çŸ¿å…¬é’¥ï¼ˆ128ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ï¼‰"
    log_debug "æ ¼å¼ç¤ºä¾‹: 1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
    echo
    
    while true; do
        read -p "æŒ–çŸ¿å…¬é’¥ (128ä½16è¿›åˆ¶): " new_pubkey
        
        if [ -z "$new_pubkey" ]; then
            log_error "å…¬é’¥ä¸èƒ½ä¸ºç©º"
            continue
        fi
        
        # éªŒè¯128ä½16è¿›åˆ¶æ ¼å¼
        if validate_mining_pubkey "$new_pubkey"; then
            if [ -f "$ENV_FILE" ]; then
                # åˆ›å»ºå¤‡ä»½
                cp "$ENV_FILE" "$BACKUP_DIR/.env.backup.$(date +%Y%m%d_%H%M%S)"
                
                # æ›´æ–°å…¬é’¥
                if grep -q "MINING_PUBKEY=" "$ENV_FILE"; then
                    sed -i "s/^MINING_PUBKEY=.*/MINING_PUBKEY=$new_pubkey/" "$ENV_FILE"
                else
                    echo "MINING_PUBKEY=$new_pubkey" >> "$ENV_FILE"
                fi
                
                log_success "æŒ–çŸ¿å…¬é’¥å·²æ›´æ–°"
                log_info "æ–°å…¬é’¥: $new_pubkey"
                log_info "é…ç½®å·²å¤‡ä»½åˆ° $BACKUP_DIR/"
                break
            else
                log_error ".env æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œå®‰è£…é€‰é¡¹"
                break
            fi
        else
            log_error "è¯·è¾“å…¥æ­£ç¡®æ ¼å¼çš„128ä½16è¿›åˆ¶å…¬é’¥ï¼ˆ128ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ï¼‰"
        fi
    done
}

# åŠŸèƒ½3ï¼šå¯åŠ¨èŠ‚ç‚¹
start_node() {
    log_info "å¯åŠ¨ Nockchain æŒ–çŸ¿èŠ‚ç‚¹"
    
    # æ£€æŸ¥å¿…è¦æ¡ä»¶
    if ! command -v nockchain &> /dev/null; then
        log_error "nockchain æœªå®‰è£…ï¼Œè¯·å…ˆè¿è¡Œå®‰è£…é€‰é¡¹"
        return 1
    fi
    
    if [ ! -f "$ENV_FILE" ]; then
        log_error ".env æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œå®‰è£…é€‰é¡¹"
        return 1
    fi
    
    # åŠ è½½ç¯å¢ƒå˜é‡
    source "$ENV_FILE"
    export RUST_LOG MINIMAL_LOG_FORMAT MINING_PUBKEY
    
    # éªŒè¯æŒ–çŸ¿å…¬é’¥æ ¼å¼
    if ! validate_mining_pubkey "$MINING_PUBKEY" 2>/dev/null; then
        log_error "å½“å‰é…ç½®çš„æŒ–çŸ¿å…¬é’¥æ ¼å¼ä¸æ­£ç¡®"
        log_error "è¯·å…ˆä½¿ç”¨ 'æ›´æ”¹æŒ–çŸ¿å…¬é’¥' é€‰é¡¹è®¾ç½®æ­£ç¡®çš„128ä½16è¿›åˆ¶å…¬é’¥"
        return 1
    fi
    
    # æ£€æŸ¥ç°æœ‰è¿›ç¨‹
    if pgrep -f "nockchain" > /dev/null; then
        local existing_pids=$(pgrep -f nockchain | tr '\n' ' ')
        log_warn "æ£€æµ‹åˆ°è¿è¡Œä¸­çš„ Nockchain è¿›ç¨‹: $existing_pids"
        
        read -p "æ˜¯å¦åœæ­¢ç°æœ‰è¿›ç¨‹å¹¶é‡æ–°å¯åŠ¨ï¼Ÿ(y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            log_info "åœæ­¢ç°æœ‰è¿›ç¨‹..."
            pkill -TERM -f nockchain 2>/dev/null || true
            sleep 3
            if pgrep -f nockchain > /dev/null; then
                pkill -KILL -f nockchain 2>/dev/null || true
                sleep 2
            fi
            log_info "ç°æœ‰è¿›ç¨‹å·²åœæ­¢"
        else
            log_info "ä¿æŒç°æœ‰è¿›ç¨‹è¿è¡Œ"
            return 0
        fi
    fi
    
    log_info "é…ç½®ä¿¡æ¯ï¼š"
    log_info "- æŒ–çŸ¿å…¬é’¥: $MINING_PUBKEY"
    log_info "- æ—¥å¿—çº§åˆ«: $RUST_LOG"
    log_info "- æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
    
    # å¯åŠ¨èŠ‚ç‚¹
    log_info "æ­£åœ¨å¯åŠ¨æŒ–çŸ¿èŠ‚ç‚¹..."
    
    nohup nockchain --mining-pubkey "${MINING_PUBKEY}" --mine > "$LOG_FILE" 2>&1 &
    local node_pid=$!
    
    # ç­‰å¾…å¯åŠ¨
    sleep 5
    
    # éªŒè¯å¯åŠ¨çŠ¶æ€
    if kill -0 $node_pid 2>/dev/null; then
        log_success "èŠ‚ç‚¹å¯åŠ¨æˆåŠŸï¼"
        log_success "è¿›ç¨‹ID: $node_pid"
        log_info "æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
        
        # æ˜¾ç¤ºåˆå§‹æ—¥å¿—
        if [ -f "$LOG_FILE" ]; then
            log_info "æœ€è¿‘å‡ è¡Œæ—¥å¿—ï¼š"
            tail -n 5 "$LOG_FILE" 2>/dev/null || true
        fi
        
        log_info "ä½¿ç”¨ 'æŸ¥çœ‹æ—¥å¿—' é€‰é¡¹ç›‘æ§èŠ‚ç‚¹çŠ¶æ€"
    else
        log_error "èŠ‚ç‚¹å¯åŠ¨å¤±è´¥"
        if [ -f "$LOG_FILE" ]; then
            log_error "é”™è¯¯æ—¥å¿—ï¼š"
            tail -n 10 "$LOG_FILE"
        fi
        return 1
    fi
}

# åŠŸèƒ½4ï¼šæŸ¥çœ‹æ—¥å¿—
view_logs() {
    log_info "æŸ¥çœ‹ Nockchain èŠ‚ç‚¹æ—¥å¿—"
    
    if [ ! -f "$LOG_FILE" ]; then
        log_warn "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨: $LOG_FILE"
        
        # æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
        if pgrep -f "nockchain" > /dev/null; then
            log_info "èŠ‚ç‚¹æ­£åœ¨è¿è¡Œï¼Œä½†æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
            log_info "å»ºè®®é‡å¯èŠ‚ç‚¹ä»¥ç”Ÿæˆæ—¥å¿—æ–‡ä»¶"
        else
            log_info "èŠ‚ç‚¹æœªè¿è¡Œ"
        fi
        return 1
    fi
    
    echo
    log_info "=== æ—¥å¿—æ–‡ä»¶ä¿¡æ¯ ==="
    echo "æ–‡ä»¶ä½ç½®: $(realpath $LOG_FILE)"
    echo "æ–‡ä»¶å¤§å°: $(du -h "$LOG_FILE" | cut -f1)"
    echo "æœ€åä¿®æ”¹: $(stat -c %y "$LOG_FILE" 2>/dev/null || date -r "$LOG_FILE" 2>/dev/null)"
    
    echo
    log_info "=== æœ€è¿‘50è¡Œæ—¥å¿— ==="
    echo
    tail -n 50 "$LOG_FILE"
    
    echo
    log_info "=== å®æ—¶æ—¥å¿—ç›‘æ§ ==="
    log_info "æŒ‰ Ctrl+C é€€å‡ºç›‘æ§"
    echo
    
    # å®æ—¶ç›‘æ§æ—¥å¿—
    tail -f "$LOG_FILE"
}

# ä¸»èœå•æ˜¾ç¤º
show_main_menu() {
    clear
    echo -e "${PURPLE}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                 Nockchain èŠ‚ç‚¹ç®¡ç†å·¥å…·                        â•‘"
    echo "â•‘          ï¼ˆä¿®å¤ dpkg lock-frontend é”™è¯¯ç‰ˆ v8.0ï¼‰              â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    
    echo
    echo -e "${GREEN}ğŸ”§ æ ¸å¿ƒåŠŸèƒ½èœå•${NC}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo "  1. å®‰è£… Nockchainï¼ˆä¿®å¤ dpkg é”æ–‡ä»¶é—®é¢˜ç‰ˆï¼‰"
    echo "  2. æ›´æ”¹æŒ–çŸ¿å…¬é’¥ï¼ˆ128ä½16è¿›åˆ¶æ ¼å¼ï¼‰"
    echo "  3. å¯åŠ¨æŒ–çŸ¿èŠ‚ç‚¹"
    echo "  4. æŸ¥çœ‹èŠ‚ç‚¹æ—¥å¿—"
    echo
    echo "  0. é€€å‡º"
    echo
    echo -e "${YELLOW}ğŸ”¨ ä¿®å¤æ”¹è¿›ç‚¹ï¼š${NC}"
    echo -e "${YELLOW}â€¢ ä¿®å¤ dpkg lock-frontend é”æ–‡ä»¶å†²çª${NC}"
    echo -e "${YELLOW}â€¢ æ™ºèƒ½æ£€æµ‹å’Œæ¸…ç†åƒµå°¸é”æ–‡ä»¶${NC}"
    echo -e "${YELLOW}â€¢ å®‰å…¨çš„ apt å‘½ä»¤æ‰§è¡Œå™¨å’Œé‡è¯•æœºåˆ¶${NC}"
    echo -e "${YELLOW}â€¢ è¿›ç¨‹å†²çªæ£€æµ‹å’Œè‡ªåŠ¨å¤„ç†${NC}"
    echo
    echo -e "${CYAN}ğŸ“‹ ç³»ç»Ÿè¦æ±‚ï¼š${NC}"
    echo -e "${CYAN}â€¢ æœ€ä½: 32GB RAM, 4æ ¸ CPU, 50GB ç£ç›˜${NC}"
    echo -e "${CYAN}â€¢ æ¨è: 64GB+ RAM, 6æ ¸+ CPU, 100GB+ SSD${NC}"
    echo
    
    # æ˜¾ç¤ºå½“å‰çŠ¶æ€
    if [ -f "$ENV_FILE" ]; then
        local current_pubkey=$(grep "MINING_PUBKEY=" "$ENV_FILE" 2>/dev/null | cut -d'=' -f2)
        if [ -n "$current_pubkey" ] && [ "$current_pubkey" != "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000" ]; then
            echo -e "${CYAN}ğŸ“ å½“å‰æŒ–çŸ¿å…¬é’¥: ${current_pubkey:0:20}...${current_pubkey: -20}${NC}"
        else
            echo -e "${CYAN}ğŸ“ å½“å‰æŒ–çŸ¿å…¬é’¥: æœªè®¾ç½®æˆ–ä½¿ç”¨é»˜è®¤å€¼${NC}"
        fi
    fi
    
    if pgrep -f "nockchain" > /dev/null; then
        echo -e "${CYAN}ğŸ“ èŠ‚ç‚¹çŠ¶æ€: âœ… è¿è¡Œä¸­ (PID: $(pgrep -f nockchain | tr '\n' ' '))${NC}"
    else
        echo -e "${CYAN}ğŸ“ èŠ‚ç‚¹çŠ¶æ€: âŒ æœªè¿è¡Œ${NC}"
    fi
    echo
}

# ä¸»ç¨‹åº
main() {
    # å¯åŠ¨æ—¶è¿›è¡Œæ™ºèƒ½ç›®å½•æ£€æµ‹
    log_info "Nockchain èŠ‚ç‚¹ç®¡ç†å·¥å…·å¯åŠ¨ä¸­..."
    
    if ! smart_directory_setup; then
        log_error "æ— æ³•åˆå§‹åŒ–é¡¹ç›®ç¯å¢ƒ"
        exit 1
    fi
    
    # ä¸»å¾ªç¯
    while true; do
        show_main_menu
        read -p "è¯·é€‰æ‹©æ“ä½œ (0-4): " choice
        
        case $choice in
            1)
                install_nockchain_complete_fixed
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            2)
                change_mining_pubkey
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            3)
                start_node
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            4)
                view_logs
                ;;
            0)
                log_info "æ„Ÿè°¢ä½¿ç”¨ Nockchain èŠ‚ç‚¹ç®¡ç†å·¥å…·ï¼"
                log_info "ç¥æ‚¨æŒ–çŸ¿æ„‰å¿« ğŸš€"
                exit 0
                ;;
            *)
                log_error "æ— æ•ˆé€‰æ‹©ï¼Œè¯·è¾“å…¥ 0-4 ä¹‹é—´çš„æ•°å­—"
                sleep 2
                ;;
        esac
    done
}

# è„šæœ¬å…¥å£
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    # è®¾ç½®é”™è¯¯å¤„ç†
    set -eE
    trap 'log_error "è„šæœ¬åœ¨ç¬¬ $LINENO è¡Œå‡ºé”™"' ERR
    
    # å¯åŠ¨ä¸»ç¨‹åº
    main "$@"
fi
