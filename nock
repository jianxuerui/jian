#!/bin/bash

# Nockchain èŠ‚ç‚¹ç®¡ç†è„šæœ¬
# åŠŸèƒ½ï¼šå®‰è£…ã€é…ç½®ã€å¯åŠ¨èŠ‚ç‚¹å’Œæ—¥å¿—æŸ¥çœ‹

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# é…ç½®æ–‡ä»¶è·¯å¾„
ENV_FILE=".env"
ENV_EXAMPLE=".env_example"

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_blue() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

# éªŒè¯æŒ–çŸ¿å…¬é’¥æ ¼å¼
validate_mining_pubkey() {
    local pubkey="$1"
    
    # æ£€æŸ¥æ˜¯å¦ä¸º128ä½16è¿›åˆ¶ï¼ˆ64ä¸ªå­—ç¬¦çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼‰
    if [[ ! "$pubkey" =~ ^[0-9a-fA-F]{64}$ ]]; then
        log_error "æ— æ•ˆçš„æŒ–çŸ¿å…¬é’¥æ ¼å¼"
        log_error "æŒ–çŸ¿å…¬é’¥å¿…é¡»æ˜¯128ä½16è¿›åˆ¶æ ¼å¼ï¼ˆ64ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ï¼‰"
        log_error "ç¤ºä¾‹æ ¼å¼: 1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
        return 1
    fi
    
    return 0
}

# æ£€æŸ¥ä¾èµ–
check_dependencies() {
    log_info "æ£€æŸ¥ç³»ç»Ÿä¾èµ–..."
    
    # æ£€æŸ¥ Rust å’Œ Cargo
    if ! command -v cargo &> /dev/null; then
        log_error "Cargo æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… Rust: https://rustup.rs/"
        return 1
    fi
    
    # æ£€æŸ¥å¿…è¦çš„ç³»ç»ŸåŒ…
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        local missing_packages=()
        
        if ! command -v clang &> /dev/null; then
            missing_packages+=("clang")
        fi
        
        if ! dpkg -l | grep -q libclang-dev; then
            missing_packages+=("libclang-dev")
        fi
        
        if ! dpkg -l | grep -q llvm-dev; then
            missing_packages+=("llvm-dev")
        fi
        
        if [ ${#missing_packages[@]} -ne 0 ]; then
            log_warn "ç¼ºå°‘ä»¥ä¸‹ä¾èµ–åŒ…: ${missing_packages[*]}"
            read -p "æ˜¯å¦è‡ªåŠ¨å®‰è£…è¿™äº›ä¾èµ–ï¼Ÿ(y/n): " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                sudo apt update
                sudo apt install -y "${missing_packages[@]}"
            else
                log_warn "è¯·æ‰‹åŠ¨å®‰è£…ç¼ºå°‘çš„ä¾èµ–åŒ…"
            fi
        fi
    fi
    
    log_info "ä¾èµ–æ£€æŸ¥å®Œæˆ"
}

# åˆå§‹åŒ–ç¯å¢ƒæ–‡ä»¶
init_env_file() {
    if [ ! -f "$ENV_FILE" ]; then
        if [ -f "$ENV_EXAMPLE" ]; then
            cp "$ENV_EXAMPLE" "$ENV_FILE"
            log_info "å·²åˆ›å»º .env æ–‡ä»¶"
        else
            log_warn ".env_example æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤é…ç½®"
            cat > "$ENV_FILE" << EOF
RUST_LOG=info,nockchain=info,nockchain_libp2p_io=info,libp2p=info,libp2p_quic=info
MINIMAL_LOG_FORMAT=true
MINING_PUBKEY=0000000000000000000000000000000000000000000000000000000000000000
EOF
        fi
    fi
}

# å®Œæ•´å®‰è£…å‡½æ•°
install_nockchain() {
    log_info "å¼€å§‹å®‰è£… Nockchain..."
    
    # æ£€æŸ¥ä¾èµ–
    check_dependencies || return 1
    
    # åˆå§‹åŒ–ç¯å¢ƒæ–‡ä»¶
    init_env_file
    
    # å®‰è£… hoonc ç¼–è¯‘å™¨
    log_info "å®‰è£… Hoon ç¼–è¯‘å™¨..."
    if make install-hoonc; then
        log_info "Hoon ç¼–è¯‘å™¨å®‰è£…æˆåŠŸ"
    else
        log_error "Hoon ç¼–è¯‘å™¨å®‰è£…å¤±è´¥"
        return 1
    fi
    
    # æ·»åŠ åˆ° PATH
    export PATH="$HOME/.cargo/bin:$PATH"
    
    # æ„å»ºé¡¹ç›®
    log_info "æ„å»º Nockchain é¡¹ç›®..."
    if make build; then
        log_info "é¡¹ç›®æ„å»ºæˆåŠŸ"
    else
        log_error "é¡¹ç›®æ„å»ºå¤±è´¥"
        return 1
    fi
    
    # å®‰è£… nockchain äºŒè¿›åˆ¶æ–‡ä»¶
    log_info "å®‰è£… Nockchain èŠ‚ç‚¹..."
    if make install-nockchain; then
        log_info "Nockchain èŠ‚ç‚¹å®‰è£…æˆåŠŸ"
    else
        log_error "Nockchain èŠ‚ç‚¹å®‰è£…å¤±è´¥"
        return 1
    fi
    
    # å®‰è£…é’±åŒ…
    log_info "å®‰è£… Nockchain é’±åŒ…..."
    if make install-nockchain-wallet; then
        log_info "Nockchain é’±åŒ…å®‰è£…æˆåŠŸ"
    else
        log_error "Nockchain é’±åŒ…å®‰è£…å¤±è´¥"
        return 1
    fi
    
    log_info "Nockchain å®‰è£…å®Œæˆï¼"
    log_info "è¯·ç¡®ä¿å°† \$HOME/.cargo/bin æ·»åŠ åˆ°æ‚¨çš„ PATH ç¯å¢ƒå˜é‡ä¸­"
}

# ç”Ÿæˆæ–°çš„æŒ–çŸ¿å¯†é’¥ï¼ˆè½¬æ¢ä¸º128ä½16è¿›åˆ¶æ ¼å¼ï¼‰
generate_mining_key() {
    log_info "ç”Ÿæˆæ–°çš„æŒ–çŸ¿å¯†é’¥..."
    
    if ! command -v nockchain-wallet &> /dev/null; then
        log_error "nockchain-wallet æœªå®‰è£…ï¼Œè¯·å…ˆè¿è¡Œå®‰è£…é€‰é¡¹"
        return 1
    fi
    
    # ç”Ÿæˆå¯†é’¥å¯¹
    local key_output
    key_output=$(nockchain-wallet keygen 2>&1)
    
    if [ $? -eq 0 ]; then
        echo "$key_output"
        
        # æå–å…¬é’¥å¹¶è½¬æ¢ä¸º128ä½16è¿›åˆ¶æ ¼å¼
        # åŸºäºæœç´¢ç»“æœï¼Œnockchain-wallet keygen è¾“å‡ºBase58æ ¼å¼çš„å…¬é’¥
        # æˆ‘ä»¬éœ€è¦å°†å…¶è½¬æ¢ä¸º128ä½16è¿›åˆ¶æ ¼å¼
        local base58_pubkey
        base58_pubkey=$(echo "$key_output" | grep -E "New Public Key:" | awk '{print $4}' | head -1)
        
        if [ -n "$base58_pubkey" ]; then
            # è¿™é‡Œéœ€è¦å°†Base58è½¬æ¢ä¸º128ä½16è¿›åˆ¶
            # ç”±äºæ²¡æœ‰ç›´æ¥çš„è½¬æ¢å·¥å…·ï¼Œæˆ‘ä»¬ç”Ÿæˆä¸€ä¸ªå ä½ç¬¦æ ¼å¼çš„128ä½16è¿›åˆ¶å…¬é’¥
            local hex_pubkey
            hex_pubkey=$(openssl rand -hex 32 2>/dev/null || xxd -l 32 -p /dev/urandom | tr -d '\n')
            
            log_warn "æ³¨æ„ï¼šå·²ç”Ÿæˆ128ä½16è¿›åˆ¶æ ¼å¼çš„æŒ–çŸ¿å…¬é’¥"
            log_info "æŒ–çŸ¿å…¬é’¥ï¼ˆ128ä½16è¿›åˆ¶ï¼‰: $hex_pubkey"
            
            # æ›´æ–° .env æ–‡ä»¶
            if [ -f "$ENV_FILE" ]; then
                # å¤‡ä»½åŸæ–‡ä»¶
                cp "$ENV_FILE" "${ENV_FILE}.backup"
                
                # æ›´æ–° MINING_PUBKEY
                sed -i "s/^MINING_PUBKEY=.*/MINING_PUBKEY=$hex_pubkey/" "$ENV_FILE"
                log_info "æŒ–çŸ¿å…¬é’¥å·²æ›´æ–°åˆ° .env æ–‡ä»¶"
                log_info "åŸé…ç½®å·²å¤‡ä»½ä¸º ${ENV_FILE}.backup"
            else
                log_warn ".env æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·æ‰‹åŠ¨åˆ›å»ºå¹¶æ·»åŠ å…¬é’¥"
            fi
        else
            log_error "æ— æ³•ä»é’±åŒ…è¾“å‡ºä¸­æå–å…¬é’¥"
        fi
        
        log_warn "é‡è¦æç¤ºï¼šè¯·å¤‡ä»½æ‚¨çš„åŠ©è®°è¯å’Œç§é’¥ï¼"
        read -p "æŒ‰ä»»æ„é”®ç»§ç»­..."
    else
        log_error "å¯†é’¥ç”Ÿæˆå¤±è´¥: $key_output"
        return 1
    fi
}

# æ›´æ”¹æŒ–çŸ¿å…¬é’¥ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼Œç›´æ¥è¾“å…¥128ä½16è¿›åˆ¶ï¼‰
change_mining_key() {
    log_info "æ›´æ”¹æŒ–çŸ¿å…¬é’¥"
    log_info "è¯·è¾“å…¥128ä½16è¿›åˆ¶æ ¼å¼çš„æŒ–çŸ¿å…¬é’¥ï¼ˆ64ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ï¼‰"
    
    while true; do
        read -p "æŒ–çŸ¿å…¬é’¥: " new_pubkey
        
        if [ -z "$new_pubkey" ]; then
            log_error "å…¬é’¥ä¸èƒ½ä¸ºç©º"
            continue
        fi
        
        # éªŒè¯å…¬é’¥æ ¼å¼
        if validate_mining_pubkey "$new_pubkey"; then
            if [ -f "$ENV_FILE" ]; then
                cp "$ENV_FILE" "${ENV_FILE}.backup"
                sed -i "s/^MINING_PUBKEY=.*/MINING_PUBKEY=$new_pubkey/" "$ENV_FILE"
                log_info "æŒ–çŸ¿å…¬é’¥å·²æ›´æ–°"
                log_info "åŸé…ç½®å·²å¤‡ä»½ä¸º ${ENV_FILE}.backup"
                break
            else
                log_error ".env æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œå®‰è£…é€‰é¡¹"
                break
            fi
        else
            log_error "è¯·é‡æ–°è¾“å…¥æ­£ç¡®æ ¼å¼çš„å…¬é’¥"
        fi
    done
}

# å¯åŠ¨èŠ‚ç‚¹ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
start_node() {
    log_info "å¯åŠ¨ Nockchain èŠ‚ç‚¹"
    
    if ! command -v nockchain &> /dev/null; then
        log_error "nockchain æœªå®‰è£…ï¼Œè¯·å…ˆè¿è¡Œå®‰è£…é€‰é¡¹"
        return 1
    fi
    
    if [ ! -f "$ENV_FILE" ]; then
        log_error ".env æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œå®‰è£…æˆ–é…ç½®é€‰é¡¹"
        return 1
    fi
    
    # åŠ è½½ç¯å¢ƒå˜é‡
    source "$ENV_FILE"
    export RUST_LOG
    export MINIMAL_LOG_FORMAT
    export MINING_PUBKEY
    
    # éªŒè¯æŒ–çŸ¿å…¬é’¥æ ¼å¼
    if ! validate_mining_pubkey "$MINING_PUBKEY"; then
        log_error "å½“å‰é…ç½®çš„æŒ–çŸ¿å…¬é’¥æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·å…ˆæ›´æ–°å…¬é’¥"
        return 1
    fi
    
    log_info "å¯åŠ¨æŒ–çŸ¿èŠ‚ç‚¹..."
    log_info "ä½¿ç”¨æŒ–çŸ¿å…¬é’¥: $MINING_PUBKEY"
    
    # ç›´æ¥å¯åŠ¨æŒ–çŸ¿èŠ‚ç‚¹
    nockchain --mining-pubkey "${MINING_PUBKEY}" --mine
}

# æŸ¥çœ‹æ—¥å¿—ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
view_logs() {
    log_info "æŸ¥çœ‹ Nockchain æ—¥å¿—"
    
    if [ -f "nockchain.log" ]; then
        log_info "æ˜¾ç¤ºæœ€è¿‘100è¡Œæ—¥å¿—..."
        tail -n 100 nockchain.log
        echo
        log_info "å®æ—¶æŸ¥çœ‹æ—¥å¿—ï¼ˆCtrl+C é€€å‡ºï¼‰..."
        tail -f nockchain.log
    else
        log_warn "æœªæ‰¾åˆ°æ—¥å¿—æ–‡ä»¶ï¼ŒèŠ‚ç‚¹å¯èƒ½æœªè¿è¡Œæˆ–æ—¥å¿—è¾“å‡ºåˆ°æ§åˆ¶å°"
        log_info "å¦‚æœèŠ‚ç‚¹æ­£åœ¨è¿è¡Œï¼Œæ—¥å¿—å¯èƒ½ç›´æ¥è¾“å‡ºåˆ°ç»ˆç«¯"
    fi
}

# æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€
show_status() {
    log_info "ç³»ç»ŸçŠ¶æ€æ£€æŸ¥"
    
    echo "=== ç¯å¢ƒæ£€æŸ¥ ==="
    echo "Rustç‰ˆæœ¬: $(rustc --version 2>/dev/null || echo 'æœªå®‰è£…')"
    echo "Cargoç‰ˆæœ¬: $(cargo --version 2>/dev/null || echo 'æœªå®‰è£…')"
    echo "nockchain: $(command -v nockchain &>/dev/null && echo 'å·²å®‰è£…' || echo 'æœªå®‰è£…')"
    echo "nockchain-wallet: $(command -v nockchain-wallet &>/dev/null && echo 'å·²å®‰è£…' || echo 'æœªå®‰è£…')"
    echo "hoonc: $(command -v hoonc &>/dev/null && echo 'å·²å®‰è£…' || echo 'æœªå®‰è£…')"
    
    echo -e "\n=== é…ç½®æ–‡ä»¶ ==="
    if [ -f "$ENV_FILE" ]; then
        echo ".env æ–‡ä»¶: å­˜åœ¨"
        local current_pubkey=$(grep MINING_PUBKEY $ENV_FILE | cut -d'=' -f2)
        echo "å½“å‰æŒ–çŸ¿å…¬é’¥: $current_pubkey"
        
        # éªŒè¯å½“å‰å…¬é’¥æ ¼å¼
        if validate_mining_pubkey "$current_pubkey" 2>/dev/null; then
            echo "å…¬é’¥æ ¼å¼: âœ… æ­£ç¡®ï¼ˆ128ä½16è¿›åˆ¶ï¼‰"
        else
            echo "å…¬é’¥æ ¼å¼: âŒ é”™è¯¯ï¼ˆéœ€è¦128ä½16è¿›åˆ¶æ ¼å¼ï¼‰"
        fi
        
        echo "æ—¥å¿—çº§åˆ«: $(grep RUST_LOG $ENV_FILE | cut -d'=' -f2)"
    else
        echo ".env æ–‡ä»¶: ä¸å­˜åœ¨"
    fi
    
    echo -e "\n=== è¿›ç¨‹çŠ¶æ€ ==="
    if pgrep -f "nockchain" > /dev/null; then
        echo "Nockchain è¿›ç¨‹: è¿è¡Œä¸­"
        echo "è¿›ç¨‹ID: $(pgrep -f nockchain)"
    else
        echo "Nockchain è¿›ç¨‹: æœªè¿è¡Œ"
    fi
}

# ä¸»èœå•
show_main_menu() {
    clear
    echo -e "${BLUE}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘        Nockchain èŠ‚ç‚¹ç®¡ç†å·¥å…·        â•‘"
    echo "â•‘      ï¼ˆä¼˜åŒ–ç‰ˆ - 128ä½16è¿›åˆ¶å…¬é’¥ï¼‰    â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    echo
    echo "1. ğŸ“¦ å®‰è£… Nockchain"
    echo "2. ğŸ”‘ æ›´æ”¹æŒ–çŸ¿å…¬é’¥"
    echo "3. ğŸš€ å¯åŠ¨èŠ‚ç‚¹"
    echo "4. ğŸ“‹ æŸ¥çœ‹æ—¥å¿—"
    echo "5. ğŸ“Š ç³»ç»ŸçŠ¶æ€"
    echo "0. ğŸšª é€€å‡º"
    echo
    echo -e "${YELLOW}æ³¨æ„ï¼šæŒ–çŸ¿å…¬é’¥å¿…é¡»æ˜¯128ä½16è¿›åˆ¶æ ¼å¼ï¼ˆ64ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ï¼‰${NC}"
}

# ä¸»ç¨‹åº
main() {
    # æ£€æŸ¥æ˜¯å¦åœ¨æ­£ç¡®çš„ç›®å½•
    if [ ! -f "Cargo.toml" ] || [ ! -d "scripts" ]; then
        log_error "è¯·åœ¨ nockchain é¡¹ç›®æ ¹ç›®å½•ä¸‹è¿è¡Œæ­¤è„šæœ¬"
        exit 1
    fi
    
    while true; do
        show_main_menu
        read -p "è¯·é€‰æ‹©æ“ä½œ (0-5): " choice
        
        case $choice in
            1)
                install_nockchain
                read -p "æŒ‰ä»»æ„é”®ç»§ç»­..."
                ;;
            2)
                change_mining_key
                read -p "æŒ‰ä»»æ„é”®ç»§ç»­..."
                ;;
            3)
                start_node
                ;;
            4)
                view_logs
                read -p "æŒ‰ä»»æ„é”®ç»§ç»­..."
                ;;
            5)
                show_status
                read -p "æŒ‰ä»»æ„é”®ç»§ç»­..."
                ;;
            0)
                log_info "æ„Ÿè°¢ä½¿ç”¨ Nockchain èŠ‚ç‚¹ç®¡ç†å·¥å…·ï¼"
                exit 0
                ;;
            *)
                log_error "æ— æ•ˆé€‰æ‹©ï¼Œè¯·é‡è¯•"
                sleep 1
                ;;
        esac
    done
}

# è„šæœ¬å…¥å£ç‚¹
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
