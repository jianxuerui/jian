#!/usr/bin/env sh
# Ethminer 矿工专业工具 v7.4 (Definitive Fix)
# 最终解决方案：显式禁用Hunter，强制使用系统库，并为所有系统手动编译通用缺失的依赖(CLI11)，
# 再为 RHEL/CentOS 系列手动编译其特有缺失的依赖 (jsoncpp, ethash)。

set -euo pipefail
IFS='
'

# --- 全局配置 ---
CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/ethminer-tool"
CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/ethminer-tool"
REPO_PATH="$HOME/ethminer"
DEPS_SRC_PATH="/tmp/ethminer_deps_src" # 依赖源码临时存放处

LOG_FILE="$CACHE_DIR/miner.log"
CONFIG_FILE="$CONFIG_DIR/ethminer.conf"
PID_FILE="$CACHE_DIR/miner.pid"

# --- 动态命令配置 ---
SUDO_CMD=""
if [ "$(id -u)" -ne 0 ]; then
  SUDO_CMD="sudo"
fi

# --- 环境与依赖 ---

get_cpu_cores() {
  case "$(uname -s)" in
    Linux*)  nproc 2>/dev/null || echo "2" ;;
    *)       echo "2" ;;
  esac
}

init_environment() {
  mkdir -p "$CONFIG_DIR" "$CACHE_DIR" "$DEPS_SRC_PATH"
  if [ ! -f "$CONFIG_FILE" ]; then
    echo "▶ 首次运行，正在创建默认配置文件..."
    cat > "$CONFIG_FILE" <<EOF
# ethminer 配置文件
MINING_ADDRESS="0x0000000000000000000000000000000000000000"
POOL_URL="stratum+tcp://etc.2miners.com:1010"
WORKER_NAME="myrig1"
EOF
    echo "✔ 默认配置已创建于: $CONFIG_FILE"
    echo "请务必通过菜单选项 '2' 或 '3' 修改您的挖矿地址和矿池！"
    sleep 3
  fi
}

# --- 新增：编译通用缺失依赖 CLI11 ---
compile_cli11() {
    echo "--> [通用依赖] 正在编译: CLI11 (所有系统都需要)..."
    (
        cd "$DEPS_SRC_PATH"
        if [ ! -d "CLI11" ]; then
            git clone https://github.com/CLIUtils/CLI11.git
        fi
        cd CLI11
        mkdir -p build
        cd build
        # CLI11 是一个现代CMake项目，这样安装即可
        cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local
        $SUDO_CMD make install
    ) || { echo "!! 致命错误：编译 CLI11 失败。"; exit 1; }
    echo "✔ 依赖 CLI11 已成功编译并安装。"
}

# --- 手动编译 RHEL/CentOS 特有缺失的依赖 ---
compile_rhel_missing_prerequisites() {
    echo "================================================="
    echo "  为 RHEL/CentOS 编译其特有缺失的依赖..."
    echo "================================================="
    
    # --- 1. 编译 jsoncpp ---
    echo "--> [1/2] 正在编译依赖: jsoncpp..."
    (
        cd "$DEPS_SRC_PATH"
        if [ ! -d "jsoncpp" ]; then
            git clone https://github.com/open-source-parsers/jsoncpp.git
        fi
        cd jsoncpp; mkdir -p build; cd build
        cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local -DBUILD_STATIC_LIBS=OFF
        make -j"$(get_cpu_cores)"
        $SUDO_CMD make install
    ) || { echo "!! 致命错误：编译 jsoncpp 失败。"; exit 1; }
    echo "✔ 依赖 jsoncpp 已成功编译并安装。"

    # --- 2. 编译 ethash ---
    echo "--> [2/2] 正在编译依赖: ethash..."
    (
        cd "$DEPS_SRC_PATH"
        if [ ! -d "ethash" ]; then
            git clone https://github.com/chfast/ethash.git
        fi
        cd ethash; mkdir -p build; cd build
        cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local
        make -j"$(get_cpu_cores)"
        $SUDO_CMD make install
    ) || { echo "!! 致命错误：编译 ethash 失败。"; exit 1; }
    echo "✔ 依赖 ethash 已成功编译并安装。"
}

# --- 编译与安装核心流程 (最终版) ---
install_ethminer() {
  PKG_MANAGER=""
  while [ -z "$PKG_MANAGER" ]; do
    clear; echo "为正确安装依赖，请选择您的操作系统包管理器："; echo "-----------------------------------------------"; echo "  1) apt (适用于 Debian, Ubuntu 等)"; echo "  2) dnf/yum (适用于 Fedora, CentOS, RHEL)"; echo "-----------------------------------------------"; printf "请输入您的选择 [1-2]: "; read -r sys_choice
    case $sys_choice in 1) PKG_MANAGER="apt" ;; 2) PKG_MANAGER="dnf" ;; *) echo "输入无效。" && sleep 1 ;; esac
  done

  echo "✔ 系统选择完成: $PKG_MANAGER"
  
  echo "▶ 步骤 1/5: 安装所有可用的系统依赖..."
  case "$PKG_MANAGER" in
    apt)
      $SUDO_CMD apt-get update
      # Debian/Ubuntu 仓库很全，可以直接安装大部分依赖
      $SUDO_CMD apt-get install -y git cmake build-essential libboost-all-dev libssl-dev libjsoncpp-dev libethash-dev
      ;;
    dnf)
      echo "--> 正在启用 EPEL 和 CRB/PowerTools 仓库..."
      $SUDO_CMD "$PKG_MANAGER" -y install epel-release
      REPO_ID=$(dnf repolist --all | grep -i -E 'builder|powertools|crb' | head -n 1 | awk '{print $1}')
      if [ -n "$REPO_ID" ]; then $SUDO_CMD dnf config-manager --set-enabled "$REPO_ID"; fi
      
      echo "--> 正在安装基础依赖 (Boost, OpenSSL 等)..."
      $SUDO_CMD "$PKG_MANAGER" install -y git cmake gcc-c++ make boost-devel openssl-devel
      ;;
  esac
  echo "✔ 基础环境和可用依赖安装完成。"

  echo "▶ 步骤 2/5: 编译通用缺失依赖 CLI11 (所有系统都需要)..."
  compile_cli11
  
  # 只有在 dnf 系统上（我们知道它缺少包）才手动编译
  if [ "$PKG_MANAGER" = "dnf" ]; then
      echo "▶ 步骤 3/5: 编译 RHEL/CentOS 特有缺失的核心依赖..."
      compile_rhel_missing_prerequisites
  fi
  
  echo "▶ 步骤 4/5: 刷新动态链接库缓存..."
  $SUDO_CMD ldconfig
  echo "✔ 链接库缓存已刷新，系统可找到新编译的库。"

  echo "▶ 步骤 5/5: 下载/更新并编译 ethminer ..."
  if [ ! -d "$REPO_PATH/.git" ]; then
    echo "--> 正在克隆 ethminer 仓库..."
    git clone --recursive https://github.com/ethereum-mining/ethminer.git "$REPO_PATH"
  else
    echo "--> 正在更新 ethminer 仓库代码..."
    (cd "$REPO_PATH" && git pull && git submodule update --init --recursive)
  fi

  echo "--> 正在编译 ethminer (禁用Hunter，使用系统库)..."
  (
    cd "$REPO_PATH"
    mkdir -p build
    cd build
    # --- 这是最终的、最关键的修复 ---
    # 显式禁用 Hunter，并告诉 CMake 在 /usr/local 查找我们手动安装的所有依赖
    cmake .. -DETHASHCL=OFF -DETHASHCUDA=OFF -DHUNTER_ENABLED=OFF -DCMAKE_PREFIX_PATH=/usr/local
    make -j"$(get_cpu_cores)"
  ) || { echo "!! 致命错误：编译 ethminer 失败。请检查以上日志。"; exit 1; }
  echo "✔ 编译完成！"

  echo "▶ 安装程序..."
  mkdir -p "${HOME}/.local/bin"
  install -m755 "$REPO_PATH/build/ethminer/ethminer" "${HOME}/.local/bin/"
  echo "✔ ethminer 已成功安装到 ${HOME}/.local/bin/"

  if ! echo "$PATH" | grep -q "$HOME/.local/bin"; then
    echo "----------------------------------------------------------------------"
    echo "重要提示: '${HOME}/.local/bin' 不在你的 PATH 环境变量中。"
    echo "请运行以下命令，或将其加入 ~/.bashrc 文件："
    echo "  export PATH=\"\$HOME/.local/bin:\$PATH\""
    echo "----------------------------------------------------------------------"
  fi
  echo "按任意键返回主菜单..."
  read -n 1
}

# --- 日常管理功能 (无改动) ---
change_mining_address(){ . "$CONFIG_FILE"; echo "--- 更改挖矿地址 ---"; echo "当前挖矿地址: $MINING_ADDRESS"; printf "➤ 请输入新的挖矿地址 (或直接回车取消): "; read -r new_address; if [ -z "$new_address" ]; then echo "操作已取消。"; sleep 2; return; fi; if ! echo "$new_address" | grep -Eq '^0x[a-fA-F0-9]{40}$'; then echo "✘ 错误：地址格式无效。"; sleep 3; return 1; fi; sed -i.bak "s|^MINING_ADDRESS=.*|MINING_ADDRESS=\"$new_address\"|" "$CONFIG_FILE"; rm -f "${CONFIG_FILE}.bak"; echo "✔ 挖矿地址已成功更新！"; sleep 2; }
edit_config(){ echo "▶ 打开配置文件进行编辑..."; if command -v nano >/dev/null; then nano "$CONFIG_FILE"; elif command -v vi >/dev/null; then vi "$CONFIG_FILE"; else echo "未找到编辑器。请手动编辑: $CONFIG_FILE"; fi; echo "配置完成。"; sleep 2; }
start_miner(){ if [ -f "$PID_FILE" ] && ps -p "$(cat "$PID_FILE")" > /dev/null; then echo "矿机已经在运行 (PID: $(cat "$PID_FILE"))。"; sleep 2; return; fi; echo "▶ 正在启动矿机..."; if ! command -v ethminer >/dev/null; then echo "错误: 'ethminer' 命令未找到。请先安装(选项 1)。"; sleep 2; return 1; fi; . "$CONFIG_FILE"; POOL_HOST_PORT=$(echo "$POOL_URL" | sed 's|stratum+tcp://||'); STRATUM_URI="stratum+tcp://${MINING_ADDRESS}.${WORKER_NAME}@${POOL_HOST_PORT}"; echo "使用的矿池地址: $STRATUM_URI"; echo "日志文件位于: $LOG_FILE"; nohup ethminer -P "$STRATUM_URI" >"$LOG_FILE" 2>&1 & MINER_PID=$!; echo "$MINER_PID" > "$PID_FILE"; sleep 1; if ps -p "$MINER_PID" > /dev/null; then echo "✔ 矿机已启动，进程ID: $MINER_PID"; else echo "✘ 矿机启动失败，请查看日志: $LOG_FILE"; rm -f "$PID_FILE"; fi; sleep 2; }
stop_miner(){ if [ ! -f "$PID_FILE" ]; then echo "矿机未在运行。"; sleep 2; return; fi; PID=$(cat "$PID_FILE"); if ps -p "$PID" > /dev/null; then echo "▶ 正在停止矿机 (PID: $PID)..."; kill "$PID"; sleep 2; if ! ps -p "$PID" > /dev/null; then echo "✔ 矿机已停止。"; rm -f "$PID_FILE"; else echo "等待超时，强制停止..."; kill -9 "$PID"; rm -f "$PID_FILE"; fi; else echo "PID $PID 不存在。清理PID文件..."; rm -f "$PID_FILE"; fi; sleep 2; }
show_monitor(){ if [ -f "$LOG_FILE" ]; then echo "▶ 实时监控日志 (按 Ctrl+C 退出)..."; tail -f "$LOG_FILE"; else echo "日志文件不存在。"; sleep 2; fi; }

show_menu() {
  while true; do
    if [ -f "$CONFIG_FILE" ]; then . "$CONFIG_FILE"; fi
    clear
    cat << "EOF"
╔════════════════════════════════════════════════╗
║           Ethminer 矿工专业工具 v7.4           ║
╠════════════════════════════════════════════════╣
║ 1) 安装/更新 ethminer  2) 更改挖矿地址          ║
║ 3) 编辑矿池配置      4) 启动/停止矿机          ║
║ 5) 查看实时日志      0) 退出                   ║
╚════════════════════════════════════════════════╝
EOF
    echo; if [ -f "$PID_FILE" ] && ps -p "$(cat "$PID_FILE")" > /dev/null; then echo "当前状态: 运行中 (PID: $(cat "$PID_FILE"))"; else echo "当前状态: 已停止"; fi; echo "挖矿地址: ${MINING_ADDRESS:-未设置}"; echo "矿池地址: ${POOL_URL:-未设置}"; echo; printf "➤ 请输入选项 [0-5]: "; read -r choice
    case $choice in
      1) install_ethminer ;; 2) change_mining_address ;; 3) edit_config ;;
      4) if [ -f "$PID_FILE" ] && ps -p "$(cat "$PID_FILE")" > /dev/null; then stop_miner; else start_miner; fi ;;
      5) show_monitor ;; 0) echo "感谢使用，再见！"; exit 0 ;; *) echo "无效选项。"; sleep 1 ;;
    esac
  done
}

# --- 主程序入口 ---
main() {
  init_environment
  show_menu
}

main "$@"
