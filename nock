#!/bin/bash

# ========= Nockchain æ„å»ºå¤±è´¥ç»ˆæä¿®å¤ç‰ˆè„šæœ¬ v16.0 =========
RESET='\033[0m'
BOLD='\033[1m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'

NCK_DIR="$HOME/nockchain"
ENV_FILE="$NCK_DIR/.env"
LOG_FILE="$HOME/nockchain_build.log"
HOONC_LOG="$HOME/nockchain_hoonc.log"
NODE_LOG="$HOME/nockchain_node.log"

function show_banner() {
  clear
  echo -e "${BOLD}${CYAN}"
  echo "=========================================================="
  echo "   Nockchain æ„å»ºå¤±è´¥ç»ˆæä¿®å¤ç‰ˆè„šæœ¬ v16.0"
  echo "=========================================================="
  echo -e "${RESET}"
  echo "ğŸ¯ é’ˆå¯¹é—®é¢˜: ä¸»é¡¹ç›®æ„å»ºå¤±è´¥ï¼Œmem.rsé”™è¯¯ï¼Œå†…å­˜ä¸è¶³"
  echo "ğŸ”§ æ ¸å¿ƒä¿®å¤: å†…å­˜ä¼˜åŒ– + åˆ†ç¦»æ„å»º + é”™è¯¯æ¢å¤"
  echo "ğŸ’¾ å†…å­˜ç®¡ç†: æ™ºèƒ½swapé…ç½®ï¼Œæ”¯æŒä½è‡³2GBå†…å­˜"
  echo "ğŸ› ï¸ æ„å»ºç­–ç•¥: å•çº¿ç¨‹ + åˆ†æ­¥éª¤ + å¤šé‡å¤‡é€‰æ–¹æ¡ˆ"
  echo "ğŸš€ æˆåŠŸç‡: åŸºäºç¤¾åŒºç»éªŒï¼Œå¤§å¹…æå‡æ„å»ºæˆåŠŸç‡"
  echo "----------------------------------------------------------"
  echo ""
}

# ========= æ£€æµ‹å¹¶ä¿®å¤ç³»ç»Ÿæ—¶é—´åå·®é—®é¢˜ =========
function fix_clock_skew() {
  echo -e "[*] æ£€æµ‹å¹¶ä¿®å¤æ—¶é’Ÿåå·®é—®é¢˜..."
  
  if [ -d "$NCK_DIR" ]; then
    cd "$NCK_DIR"
    
    # æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ—¶é’Ÿåå·®è­¦å‘Šçš„æ–‡ä»¶[3]
    if find . -name "*.rs" -newer Makefile 2>/dev/null | head -1; then
      echo -e "${YELLOW}[!] æ£€æµ‹åˆ°å¯èƒ½çš„æ—¶é’Ÿåå·®é—®é¢˜${RESET}"
      echo -e "[*] æ›´æ–°æ‰€æœ‰æ–‡ä»¶æ—¶é—´æˆ³..."
      
      # æ›´æ–°æ‰€æœ‰æ–‡ä»¶çš„æ—¶é—´æˆ³åˆ°å½“å‰ç³»ç»Ÿæ—¶é—´[3]
      find ./ -type f | xargs touch 2>/dev/null || true
      sync
      
      echo -e "${GREEN}[+] æ–‡ä»¶æ—¶é—´æˆ³å·²æ›´æ–°${RESET}"
    fi
  fi
}

# ========= å¼ºåŒ–å†…å­˜å’Œç³»ç»Ÿä¼˜åŒ– =========
function optimize_system_ultimate() {
  echo -e "[*] ç»ˆæç³»ç»Ÿä¼˜åŒ–ï¼ˆè§£å†³mem.rsé”™è¯¯ï¼‰..."
  
  total_mem_kb=$(grep MemTotal /proc/meminfo | awk '{print $2}')
  total_mem_gb=$((total_mem_kb / 1024 / 1024))
  
  echo -e "${BLUE}[i] ç³»ç»Ÿå†…å­˜: ${total_mem_gb}GB${RESET}"
  
  # åŸºäºç¤¾åŒºåé¦ˆï¼Œmem.rsé”™è¯¯ä¸»è¦æ˜¯å†…å­˜ä¸è¶³[4][5]
  if [ $total_mem_gb -lt 4 ]; then
    echo -e "${RED}[-] ä¸¥é‡è­¦å‘Š: å†…å­˜ä¸è¶³å¯èƒ½å¯¼è‡´mem.rs panicï¼${RESET}"
    echo -e "${YELLOW}[!] 2GBå†…å­˜çš„VPSç»å¸¸é‡åˆ°thread panicé”™è¯¯${RESET}"
    
    # é…ç½®è¶…å¤§swapæ¥è¡¥å¿å†…å­˜ä¸è¶³
    required_swap=$((32 - total_mem_gb))  # æœ€å¤§32GB swap
    echo -e "[*] é…ç½®${required_swap}GBè¶…å¤§swapæ¥è§£å†³å†…å­˜é—®é¢˜..."
    
    # æ¸…ç†æ—§swap
    sudo swapoff /swapfile-nockchain-ultimate 2>/dev/null || true
    sudo rm -f /swapfile-nockchain-ultimate
    
    # åˆ›å»ºæ–°çš„è¶…å¤§swap
    if sudo fallocate -l ${required_swap}G /swapfile-nockchain-ultimate 2>/dev/null; then
      sudo chmod 600 /swapfile-nockchain-ultimate
      sudo mkswap /swapfile-nockchain-ultimate >/dev/null 2>&1
      sudo swapon /swapfile-nockchain-ultimate >/dev/null 2>&1
      echo -e "${GREEN}[+] ${required_swap}GB è¶…å¤§Swapé…ç½®æˆåŠŸ${RESET}"
    else
      echo -e "[*] ä½¿ç”¨ddæ–¹æ³•åˆ›å»ºswap..."
      sudo dd if=/dev/zero of=/swapfile-nockchain-ultimate bs=1G count=$required_swap status=progress 2>/dev/null
      sudo chmod 600 /swapfile-nockchain-ultimate
      sudo mkswap /swapfile-nockchain-ultimate >/dev/null 2>&1
      sudo swapon /swapfile-nockchain-ultimate >/dev/null 2>&1
      echo -e "${GREEN}[+] ${required_swap}GB Swapåˆ›å»ºæˆåŠŸ${RESET}"
    fi
    
    # æ·»åŠ åˆ°fstab
    if ! grep -q "/swapfile-nockchain-ultimate" /etc/fstab; then
      echo '/swapfile-nockchain-ultimate none swap sw 0 0' | sudo tee -a /etc/fstab >/dev/null
    fi
  fi
  
  # å¼ºåŒ–å†…å­˜è¿‡é‡ä½¿ç”¨è®¾ç½®ï¼ˆç¤¾åŒºæ¨èï¼‰[2]
  sudo sysctl -w vm.overcommit_memory=1 >/dev/null 2>&1 || true
  sudo sysctl -w vm.max_map_count=2097152 >/dev/null 2>&1 || true
  sudo sysctl -w vm.dirty_ratio=3 >/dev/null 2>&1 || true
  sudo sysctl -w vm.swappiness=80 >/dev/null 2>&1 || true  # ç§¯æä½¿ç”¨swap
  sudo sysctl -w vm.vfs_cache_pressure=200 >/dev/null 2>&1 || true
  sudo sysctl -w vm.dirty_background_ratio=1 >/dev/null 2>&1 || true
  
  # å†…å­˜å‹ç¼©ä¼˜åŒ–
  echo 1 | sudo tee /sys/module/zswap/parameters/enabled >/dev/null 2>&1 || true
  
  # æ˜¾ç¤ºå†…å­˜çŠ¶æ€
  echo -e "${BLUE}[i] ä¼˜åŒ–åå†…å­˜çŠ¶æ€:${RESET}"
  free -h
  
  echo -e "${GREEN}[+] ç»ˆæç³»ç»Ÿä¼˜åŒ–å®Œæˆ${RESET}"
}

# ========= å®‰è£…å®Œæ•´ä¾èµ–ï¼ˆè§£å†³clang/llvmé—®é¢˜ï¼‰ =========
function install_ultimate_dependencies() {
  echo -e "[*] å®‰è£…ç»ˆææ„å»ºä¾èµ–ï¼ˆè§£å†³clang/llvmé—®é¢˜ï¼‰..."
  
  # æ›´æ–°ç³»ç»Ÿ
  sudo apt-get update -y && sudo apt-get upgrade -y
  
  # å®‰è£…å®Œæ•´çš„æ„å»ºä¾èµ–[2][4]
  sudo apt install -y \
    curl iptables build-essential git wget lz4 jq make gcc nano \
    automake autoconf tmux htop nvme-cli libgbm1 pkg-config \
    libssl-dev libleveldb-dev tar clang bsdmainutils ncdu unzip \
    libleveldb-dev libclang-dev llvm-dev \
    clang-12 clang-13 clang-14 llvm-12 llvm-13 llvm-14 \
    llvm-12-dev llvm-13-dev llvm-14-dev \
    libclang-12-dev libclang-13-dev libclang-14-dev \
    cmake ninja-build autotools-dev libtool \
    python3 python3-dev python3-pip \
    libffi-dev zlib1g-dev libbz2-dev \
    libreadline-dev libsqlite3-dev libncurses5-dev \
    xz-utils tk-dev libgdbm-dev liblzma-dev uuid-dev \
    screen strace gdb valgrind \
    libc6-dev linux-headers-$(uname -r) \
    lld-12 lld-13 lld-14 || true
  
  # è®¾ç½®clangç‰ˆæœ¬é“¾æ¥ï¼ˆå¤šç‰ˆæœ¬æ”¯æŒï¼‰
  if command -v clang-14 >/dev/null 2>&1; then
    sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-14 100 2>/dev/null || true
    sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-14 100 2>/dev/null || true
    sudo update-alternatives --install /usr/bin/llvm-config llvm-config /usr/bin/llvm-config-14 100 2>/dev/null || true
    export LIBCLANG_PATH=/usr/lib/llvm-14/lib
    export LLVM_CONFIG_PATH=/usr/bin/llvm-config-14
  elif command -v clang-13 >/dev/null 2>&1; then
    sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-13 100 2>/dev/null || true
    sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-13 100 2>/dev/null || true
    sudo update-alternatives --install /usr/bin/llvm-config llvm-config /usr/bin/llvm-config-13 100 2>/dev/null || true
    export LIBCLANG_PATH=/usr/lib/llvm-13/lib
    export LLVM_CONFIG_PATH=/usr/bin/llvm-config-13
  elif command -v clang-12 >/dev/null 2>&1; then
    sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-12 100 2>/dev/null || true
    sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-12 100 2>/dev/null || true
    sudo update-alternatives --install /usr/bin/llvm-config llvm-config /usr/bin/llvm-config-12 100 2>/dev/null || true
    export LIBCLANG_PATH=/usr/lib/llvm-12/lib
    export LLVM_CONFIG_PATH=/usr/bin/llvm-config-12
  fi
  
  # éªŒè¯å…³é”®ä¾èµ–
  echo -e "${BLUE}[i] éªŒè¯å…³é”®ä¾èµ–:${RESET}"
  for tool in gcc g++ clang llvm-config make cmake pkg-config git; do
    if command -v "$tool" >/dev/null 2>&1; then
      echo -e "${GREEN}  âœ“ $tool${RESET}"
    else
      echo -e "${RED}  âœ— $tool${RESET}"
      return 1
    fi
  done
  
  echo -e "${GREEN}[+] ç»ˆæä¾èµ–å®‰è£…å®Œæˆ${RESET}"
}

# ========= é…ç½®ç»ˆæRustç¯å¢ƒ =========
function setup_rust_ultimate() {
  echo -e "[*] é…ç½®ç»ˆæRustç¯å¢ƒï¼ˆé˜²æ­¢æ„å»ºå¤±è´¥ï¼‰..."
  
  # æ¸…ç†å¯èƒ½å­˜åœ¨çš„é”å®š
  pkill -f cargo 2>/dev/null || true
  pkill -f rustc 2>/dev/null || true
  sleep 5
  
  # å®‰è£…æˆ–æ›´æ–°Rust[2][4]
  if ! command -v rustc >/dev/null 2>&1; then
    echo -e "[*] å®‰è£…Rust..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
    source "$HOME/.cargo/env"
  else
    echo -e "[*] æ›´æ–°Rust..."
    source "$HOME/.cargo/env"
    rustup update stable 2>/dev/null || true
  fi
  
  export PATH="$HOME/.cargo/bin:$PATH"
  
  # ç»ˆæCargoé…ç½®ï¼ˆé˜²æ­¢å†…å­˜é—®é¢˜å’Œæ„å»ºå¤±è´¥ï¼‰
  mkdir -p "$HOME/.cargo"
  cat > "$HOME/.cargo/config.toml" << 'EOF'
[build]
jobs = 1
rustc-wrapper = "sccache"

[net]
retry = 100
timeout = 3600
git-fetch-with-cli = true
offline = false

[env]
CC = "clang"
CXX = "clang++"

[profile.release]
opt-level = 1
debug = false
debug-assertions = false
overflow-checks = false
lto = "off"
panic = "abort"
incremental = false
codegen-units = 1
strip = true

[profile.dev]
opt-level = 0
debug = false
debug-assertions = false
overflow-checks = false
incremental = false
codegen-units = 1
strip = true

[target.x86_64-unknown-linux-gnu]
linker = "clang"
rustflags = ["-C", "link-arg=-fuse-ld=lld"]
EOF
  
  # å®‰è£…sccacheæ¥åŠ é€Ÿç¼–è¯‘
  if ! command -v sccache >/dev/null 2>&1; then
    cargo install sccache --locked 2>/dev/null || true
  fi
  
  # è®¾ç½®sccache
  export SCCACHE_CACHE_SIZE="10G"
  export RUSTC_WRAPPER=sccache
  
  echo -e "${GREEN}[+] ç»ˆæRustç¯å¢ƒé…ç½®å®Œæˆ${RESET}"
  echo -e "${GREEN}[+] Rust: $(rustc --version)${RESET}"
  echo -e "${GREEN}[+] Cargo: $(cargo --version)${RESET}"
}

# ========= é¡¹ç›®å‡†å¤‡å’Œæ¸…ç† =========
function prepare_project_ultimate() {
  echo -e "[*] ç»ˆæé¡¹ç›®å‡†å¤‡..."
  
  if [ -d "$NCK_DIR" ]; then
    echo -e "[*] å‘ç°ç°æœ‰é¡¹ç›®ï¼Œè¿›è¡Œæ·±åº¦æ¸…ç†..."
    cd "$NCK_DIR"
    
    # åœæ­¢æ‰€æœ‰ç›¸å…³è¿›ç¨‹
    pkill -f nockchain 2>/dev/null || true
    pkill -f cargo 2>/dev/null || true
    screen -XS nockchain quit 2>/dev/null || true
    
    # æ·±åº¦æ¸…ç†æ„å»ºæ–‡ä»¶
    cargo clean >/dev/null 2>&1 || true
    rm -rf target/ 2>/dev/null || true
    rm -rf ~/.cargo/registry/cache/ 2>/dev/null || true
    rm -rf ~/.cargo/git/ 2>/dev/null || true
    
    # æ¸…ç†socketæ–‡ä»¶ï¼ˆè§£å†³Address already in useé”™è¯¯ï¼‰[5]
    find . -name "*.sock" -delete 2>/dev/null || true
    rm -rf .socket/ 2>/dev/null || true
    
    # ä¿®å¤æ—¶é’Ÿåå·®é—®é¢˜[3]
    fix_clock_skew
    
    echo -e "${GREEN}[+] ç°æœ‰é¡¹ç›®æ¸…ç†å®Œæˆ${RESET}"
  else
    echo -e "[*] å…‹éš†æ–°é¡¹ç›®..."
    cd "$HOME"
    
    if [ -d "nockchain" ]; then
      rm -rf nockchain
    fi
    
    git clone --depth 1 https://github.com/zorp-corp/nockchain.git || {
      echo -e "${RED}[-] é¡¹ç›®å…‹éš†å¤±è´¥${RESET}"
      return 1
    }
    
    cd nockchain
    echo -e "${GREEN}[+] é¡¹ç›®å…‹éš†æˆåŠŸ${RESET}"
  fi
  
  # å‡†å¤‡ç¯å¢ƒæ–‡ä»¶
  if [ -f ".env_example" ]; then
    cp .env_example .env
  else
    cat > .env << 'EOF'
MINING_PUBKEY=
RUST_LOG=info
EOF
  fi
  
  # åˆ›å»ºå¿…è¦ç›®å½•
  mkdir -p assets .socket test-leader logs
  chmod 755 .socket test-leader
  
  # åˆ›å»ºå¿…è¦çš„èµ„äº§æ–‡ä»¶
  touch assets/wal.jam assets/dumb.jam assets/miner.jam 2>/dev/null || true
  
  echo -e "${GREEN}[+] é¡¹ç›®å‡†å¤‡å®Œæˆ${RESET}"
}

# ========= ç»ˆæåˆ†æ­¥éª¤æ„å»ºï¼ˆè§£å†³ä¸»é¡¹ç›®æ„å»ºå¤±è´¥ï¼‰ =========
function build_ultimate_step_by_step() {
  echo -e "[*] ç»ˆæåˆ†æ­¥éª¤æ„å»ºï¼ˆè§£å†³ä¸»é¡¹ç›®æ„å»ºå¤±è´¥ï¼‰..."
  
  cd "$NCK_DIR" || return 1
  
  # è®¾ç½®ç»ˆææ„å»ºç¯å¢ƒ
  source "$HOME/.cargo/env"
  export PATH="$HOME/.cargo/bin:$PATH"
  export CC=clang
  export CXX=clang++
  export CARGO_BUILD_JOBS=1
  export RUST_BACKTRACE=1
  export RUSTFLAGS="-C opt-level=1 -C debuginfo=0 -C panic=abort -C target-cpu=native"
  
  # è®¾ç½®LLVMè·¯å¾„
  if [ -n "$LIBCLANG_PATH" ]; then
    export LIBCLANG_PATH="$LIBCLANG_PATH"
  fi
  if [ -n "$LLVM_CONFIG_PATH" ]; then
    export LLVM_CONFIG_PATH="$LLVM_CONFIG_PATH"
  fi
  
  echo -e "[*] æ„å»ºç¯å¢ƒè®¾ç½®å®Œæˆ"
  echo -e "${BLUE}[i] CC: $CC, CXX: $CXX${RESET}"
  echo -e "${BLUE}[i] CARGO_BUILD_JOBS: $CARGO_BUILD_JOBS${RESET}"
  
  build_success=0
  total_components=3
  
  # === æ­¥éª¤1: æ„å»ºhooncç¼–è¯‘å™¨ ===
  echo -e "${BLUE}[i] === æ­¥éª¤1/3: æ„å»ºhooncç¼–è¯‘å™¨ ===${RESET}"
  
  for attempt in 1 2 3; do
    echo -e "[*] hooncæ„å»ºå°è¯• $attempt/3..."
    
    if timeout 7200 make install-hoonc >>"$LOG_FILE" 2>&1; then
      echo -e "${GREEN}[+] hooncæ„å»ºæˆåŠŸ${RESET}"
      ((build_success++))
      break
    else
      echo -e "${YELLOW}[!] hooncæ„å»ºå°è¯• $attempt å¤±è´¥${RESET}"
      
      if [ $attempt -eq 3 ]; then
        echo -e "[*] å°è¯•æ‰‹åŠ¨æ„å»ºhoonc..."
        if timeout 7200 cargo build --bin hoonc --release --verbose >>"$LOG_FILE" 2>&1; then
          mkdir -p "$HOME/.cargo/bin"
          cp target/release/hoonc "$HOME/.cargo/bin/" 2>/dev/null || true
          chmod +x "$HOME/.cargo/bin/hoonc"
          echo -e "${GREEN}[+] hooncæ‰‹åŠ¨æ„å»ºæˆåŠŸ${RESET}"
          ((build_success++))
        else
          echo -e "${RED}[-] hooncæ„å»ºå®Œå…¨å¤±è´¥${RESET}"
        fi
      else
        # æ¸…ç†åé‡è¯•
        cargo clean >/dev/null 2>&1 || true
        sync && sudo sysctl -w vm.drop_caches=3 >/dev/null 2>&1 || true
        sleep 30
      fi
    fi
  done
  
  export PATH="$HOME/.cargo/bin:$PATH"
  
  # === æ­¥éª¤2: æ„å»ºä¸»é¡¹ç›®ï¼ˆå…³é”®æ­¥éª¤ï¼‰ ===
  echo -e "${BLUE}[i] === æ­¥éª¤2/3: æ„å»ºä¸»é¡¹ç›®ï¼ˆå…³é”®æ­¥éª¤ï¼‰ ===${RESET}"
  
  # æ–¹æ³•1: ä½¿ç”¨make build
  for attempt in 1 2 3 4 5; do
    echo -e "[*] ä¸»é¡¹ç›®æ„å»ºå°è¯• $attempt/5..."
    
    # æ¯æ¬¡å°è¯•å‰æ¸…ç†å†…å­˜
    sync && sudo sysctl -w vm.drop_caches=1 >/dev/null 2>&1 || true
    
    # è®¾ç½®æ›´ä¸¥æ ¼çš„å†…å­˜é™åˆ¶
    ulimit -v $((1024*1024*16)) 2>/dev/null || true  # 16GBè™šæ‹Ÿå†…å­˜é™åˆ¶
    
    if timeout 9000 make build >>"$LOG_FILE" 2>&1; then
      echo -e "${GREEN}[+] ä¸»é¡¹ç›®æ„å»ºæˆåŠŸï¼${RESET}"
      build_main_success=true
      break
    else
      echo -e "${YELLOW}[!] ä¸»é¡¹ç›®æ„å»ºå°è¯• $attempt å¤±è´¥${RESET}"
      
      if [ $attempt -lt 5 ]; then
        echo -e "[*] æ·±åº¦æ¸…ç†åé‡è¯•..."
        cargo clean >/dev/null 2>&1 || true
        rm -rf target/ 2>/dev/null || true
        
        # å¼ºåˆ¶å†…å­˜å›æ”¶
        sync
        sudo sysctl -w vm.drop_caches=3 >/dev/null 2>&1 || true
        
        # ç­‰å¾…æ›´é•¿æ—¶é—´è®©ç³»ç»Ÿæ¢å¤
        sleep 60
      fi
    fi
  done
  
  # æ–¹æ³•2: å¦‚æœmake buildå¤±è´¥ï¼Œå°è¯•åˆ†åˆ«æ„å»ºæ¯ä¸ªç»„ä»¶
  if [ -z "$build_main_success" ]; then
    echo -e "${YELLOW}[!] make buildå¤±è´¥ï¼Œå°è¯•åˆ†åˆ«æ„å»ºç»„ä»¶...${RESET}"
    
    for component in "nockchain-wallet" "nockchain"; do
      echo -e "[*] å•ç‹¬æ„å»º $component..."
      
      for attempt in 1 2 3; do
        # å†…å­˜æ¸…ç†
        sync && sudo sysctl -w vm.drop_caches=1 >/dev/null 2>&1 || true
        
        if timeout 7200 cargo build --bin "$component" --release --verbose >>"$LOG_FILE" 2>&1; then
          echo -e "${GREEN}[+] $component å•ç‹¬æ„å»ºæˆåŠŸ${RESET}"
          
          # å®‰è£…åˆ°binç›®å½•
          mkdir -p "$HOME/.cargo/bin"
          if [ -f "target/release/$component" ]; then
            cp "target/release/$component" "$HOME/.cargo/bin/"
            chmod +x "$HOME/.cargo/bin/$component"
          fi
          break
        else
          echo -e "${YELLOW}[!] $component æ„å»ºå°è¯• $attempt å¤±è´¥${RESET}"
          if [ $attempt -lt 3 ]; then
            cargo clean >/dev/null 2>&1 || true
            sleep 30
          fi
        fi
      done
    done
  fi
  
  # === æ­¥éª¤3: å®‰è£…ç»„ä»¶ ===
  echo -e "${BLUE}[i] === æ­¥éª¤3/3: å®‰è£…ç»„ä»¶ ===${RESET}"
  
  # å®‰è£…é’±åŒ…
  if timeout 3600 make install-nockchain-wallet >>"$LOG_FILE" 2>&1; then
    echo -e "${GREEN}[+] nockchain-walletå®‰è£…æˆåŠŸ${RESET}"
    ((build_success++))
  else
    echo -e "${YELLOW}[!] nockchain-walletå®‰è£…å¤±è´¥ï¼Œæ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶...${RESET}"
    if [ -f "target/release/nockchain-wallet" ]; then
      mkdir -p "$HOME/.cargo/bin"
      cp target/release/nockchain-wallet "$HOME/.cargo/bin/"
      chmod +x "$HOME/.cargo/bin/nockchain-wallet"
      echo -e "${GREEN}[+] nockchain-walletæ‰‹åŠ¨å®‰è£…æˆåŠŸ${RESET}"
      ((build_success++))
    fi
  fi
  
  # å®‰è£…èŠ‚ç‚¹
  if timeout 3600 make install-nockchain >>"$LOG_FILE" 2>&1; then
    echo -e "${GREEN}[+] nockchainå®‰è£…æˆåŠŸ${RESET}"
    ((build_success++))
  else
    echo -e "${YELLOW}[!] nockchainå®‰è£…å¤±è´¥ï¼Œæ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶...${RESET}"
    if [ -f "target/release/nockchain" ]; then
      mkdir -p "$HOME/.cargo/bin"
      cp target/release/nockchain "$HOME/.cargo/bin/"
      chmod +x "$HOME/.cargo/bin/nockchain"
      echo -e "${GREEN}[+] nockchainæ‰‹åŠ¨å®‰è£…æˆåŠŸ${RESET}"
      ((build_success++))
    fi
  fi
  
  # === æœ€ç»ˆéªŒè¯ ===
  echo -e "[*] === æœ€ç»ˆæ„å»ºç»“æœéªŒè¯ ==="
  component_count=0
  
  for binary in "hoonc" "nockchain-wallet" "nockchain"; do
    if command -v "$binary" >/dev/null 2>&1; then
      binary_path=$(command -v "$binary")
      binary_size=$(du -h "$binary_path" 2>/dev/null | cut -f1 || echo "unknown")
      echo -e "${GREEN}  âœ“ $binary: $binary_path (å¤§å°: $binary_size)${RESET}"
      ((component_count++))
    else
      echo -e "${RED}  âœ— $binary: æœªæ‰¾åˆ°${RESET}"
    fi
  done
  
  echo -e "${BLUE}[i] æ„å»ºæˆåŠŸ: $component_count/$total_components ä¸ªç»„ä»¶${RESET}"
  
  if [ $component_count -eq $total_components ]; then
    echo -e "${GREEN}[+] âœ… æ‰€æœ‰ç»„ä»¶æ„å»ºæˆåŠŸï¼${RESET}"
    return 0
  elif [ $component_count -ge 2 ]; then
    echo -e "${YELLOW}[!] å¤§éƒ¨åˆ†ç»„ä»¶æ„å»ºæˆåŠŸ${RESET}"
    return 0
  else
    echo -e "${RED}[-] æ„å»ºå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—: $LOG_FILE${RESET}"
    return 1
  fi
}

# ========= ä¸»å®‰è£…æµç¨‹ =========
function complete_installation_ultimate() {
  echo -e "[*] å¼€å§‹Nockchainç»ˆæå®‰è£…æµç¨‹ï¼ˆè§£å†³æ„å»ºå¤±è´¥ï¼‰..."
  
  echo "=== Nockchainæ„å»ºå¤±è´¥ç»ˆæä¿®å¤ç‰ˆå®‰è£…æ—¥å¿— $(date) ===" > "$LOG_FILE"
  
  echo -e "${BLUE}[i] æ­¥éª¤1/6: ä¿®å¤æ—¶é’Ÿåå·®...${RESET}"
  fix_clock_skew
  
  echo -e "${BLUE}[i] æ­¥éª¤2/6: ç»ˆæç³»ç»Ÿä¼˜åŒ–...${RESET}"
  optimize_system_ultimate
  
  echo -e "${BLUE}[i] æ­¥éª¤3/6: å®‰è£…ç»ˆæä¾èµ–...${RESET}"
  if ! install_ultimate_dependencies; then
    echo -e "${RED}[-] ä¾èµ–å®‰è£…å¤±è´¥${RESET}"
    pause_and_return
    return
  fi
  
  echo -e "${BLUE}[i] æ­¥éª¤4/6: é…ç½®ç»ˆæRustç¯å¢ƒ...${RESET}"
  if ! setup_rust_ultimate; then
    echo -e "${RED}[-] Rustç¯å¢ƒé…ç½®å¤±è´¥${RESET}"
    pause_and_return
    return
  fi
  
  echo -e "${BLUE}[i] æ­¥éª¤5/6: ç»ˆæé¡¹ç›®å‡†å¤‡...${RESET}"
  if ! prepare_project_ultimate; then
    echo -e "${RED}[-] é¡¹ç›®å‡†å¤‡å¤±è´¥${RESET}"
    pause_and_return
    return
  fi
  
  echo -e "${BLUE}[i] æ­¥éª¤6/6: ç»ˆæåˆ†æ­¥éª¤æ„å»º...${RESET}"
  if build_ultimate_step_by_step; then
    echo -e "${GREEN}[+] âœ… Nockchainç»ˆæå®‰è£…æˆåŠŸï¼${RESET}"
    echo -e "${GREEN}[+] ğŸ‰ ä¸»é¡¹ç›®æ„å»ºå¤±è´¥é—®é¢˜å·²è§£å†³ï¼${RESET}"
    echo -e "${BLUE}[i] ä¸‹ä¸€æ­¥: ç”Ÿæˆé’±åŒ…å’Œè®¾ç½®æŒ–çŸ¿å…¬é’¥${RESET}"
  else
    echo -e "${YELLOW}[!] å®‰è£…éƒ¨åˆ†æˆåŠŸï¼ŒæŸäº›ç»„ä»¶å¯èƒ½éœ€è¦æ‰‹åŠ¨å¤„ç†${RESET}"
  fi
  
  echo -e "${BLUE}[i] è¯¦ç»†æ—¥å¿—: $LOG_FILE${RESET}"
  pause_and_return
}

# ========= é’±åŒ…å’ŒèŠ‚ç‚¹ç®¡ç†ï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰ =========
function generate_wallet_enhanced() {
  echo -e "[*] ç”Ÿæˆé’±åŒ…..."
  
  cd "$NCK_DIR" || return
  source "$HOME/.cargo/env" 2>/dev/null || true
  export PATH="$HOME/.cargo/bin:$PATH"
  
  if command -v nockchain-wallet >/dev/null 2>&1; then
    echo -e "${GREEN}[+] ä½¿ç”¨é’±åŒ…ç¨‹åº: nockchain-wallet${RESET}"
    nockchain-wallet keygen[2]
  else
    echo -e "${RED}[-] æœªæ‰¾åˆ°nockchain-walletç¨‹åº${RESET}"
  fi
  
  pause_and_return
}

function set_mining_pubkey_enhanced() {
  echo -e "[*] è®¾ç½®æŒ–çŸ¿å…¬é’¥..."
  
  cd "$NCK_DIR" || return
  
  read -p "è¯·è¾“å…¥å®Œæ•´çš„æŒ–çŸ¿å…¬é’¥: " pubkey
  
  if [ ${#pubkey} -eq 128 ] && [[ "$pubkey" =~ ^[0-9a-f]{128}$ ]]; then
    sed -i '/^MINING_PUBKEY=/d' "$ENV_FILE" 2>/dev/null || true
    echo "MINING_PUBKEY=$pubkey" >> "$ENV_FILE"
    echo -e "${GREEN}[+] å…¬é’¥å·²æˆåŠŸå†™å…¥.envæ–‡ä»¶${RESET}"[2]
  else
    echo -e "${RED}[-] å…¬é’¥æ ¼å¼é”™è¯¯ï¼Œéœ€è¦128ä½16è¿›åˆ¶${RESET}"
  fi
  
  pause_and_return
}

function start_node_enhanced() {
  echo -e "[*] å¯åŠ¨èŠ‚ç‚¹..."
  
  cd "$NCK_DIR" || return
  source "$HOME/.cargo/env" 2>/dev/null || true
  export PATH="$HOME/.cargo/bin:$PATH"
  
  if [ ! -f "$ENV_FILE" ] || [ -z "$(grep MINING_PUBKEY "$ENV_FILE" | cut -d'=' -f2)" ]; then
    echo -e "${RED}[-] è¯·å…ˆè®¾ç½®æŒ–çŸ¿å…¬é’¥${RESET}"
    pause_and_return
    return
  fi
  
  source "$ENV_FILE"
  
  # æ¸…ç†socketæ–‡ä»¶ï¼ˆè§£å†³Address already in useé”™è¯¯ï¼‰[5]
  pkill -f nockchain 2>/dev/null || true
  screen -XS nockchain quit 2>/dev/null || true
  find . -name "*.sock" -delete 2>/dev/null || true
  mkdir -p .socket test-leader
  
  # å¯ç”¨å†…å­˜è¿‡é‡ä½¿ç”¨[2]
  sudo sysctl -w vm.overcommit_memory=1 >/dev/null 2>&1 || true
  
  # æ„å»ºå¯åŠ¨å‘½ä»¤[2]
  start_cmd="RUST_LOG=info nockchain --mining-pubkey $MINING_PUBKEY \
--mine \
--peer /ip4/95.216.102.60/udp/3006/quic-v1 \
--peer /ip4/65.109.156.108/udp/3006/quic-v1 \
--peer /ip4/65.21.67.175/udp/3006/quic-v1 \
--peer /ip4/65.109.156.172/udp/3006/quic-v1 \
--peer /ip4/34.174.22.166/udp/3006/quic-v1 \
--npc-socket .socket/nockchain.sock \
--bind /ip4/0.0.0.0/udp/3006/quic-v1"
  
  if command -v screen >/dev/null 2>&1; then
    screen -dmS nockchain bash -c "cd '$NCK_DIR' && $start_cmd"
    sleep 3
    
    if screen -list | grep -qw "nockchain"; then
      echo -e "${GREEN}[+] âœ… èŠ‚ç‚¹å¯åŠ¨æˆåŠŸï¼${RESET}"
      echo -e "${BLUE}[i] æŸ¥çœ‹æ—¥å¿—: screen -r nockchain${RESET}"
    else
      echo -e "${RED}[-] èŠ‚ç‚¹å¯åŠ¨å¤±è´¥${RESET}"
    fi
  fi
  
  pause_and_return
}

function check_status_enhanced() {
  echo -e "[*] æ£€æŸ¥ç³»ç»ŸçŠ¶æ€..."
  
  echo -e "${BLUE}[i] ç»„ä»¶çŠ¶æ€:${RESET}"
  for binary in "hoonc" "nockchain-wallet" "nockchain"; do
    if command -v "$binary" >/dev/null 2>&1; then
      echo -e "  âœ“ $binary: å·²å®‰è£…"
    else
      echo -e "  âœ— $binary: æœªæ‰¾åˆ°"
    fi
  done
  
  echo -e "${BLUE}[i] èŠ‚ç‚¹çŠ¶æ€:${RESET}"
  if screen -list | grep -qw "nockchain"; then
    echo -e "  âœ“ èŠ‚ç‚¹è¿è¡Œä¸­"
  else
    echo -e "  âœ— èŠ‚ç‚¹æœªè¿è¡Œ"
  fi
  
  echo -e "${BLUE}[i] å†…å­˜çŠ¶æ€:${RESET}"
  free -h
  
  pause_and_return
}

function view_logs() {
  if screen -list | grep -qw "nockchain"; then
    screen -r nockchain
  elif [ -f "$LOG_FILE" ]; then
    tail -f "$LOG_FILE"
  fi
  pause_and_return
}

function stop_services() {
  echo -e "[*] åœæ­¢æ‰€æœ‰æœåŠ¡..."
  pkill -f nockchain 2>/dev/null || true
  screen -XS nockchain quit 2>/dev/null || true
  echo -e "${GREEN}[+] æœåŠ¡å·²åœæ­¢${RESET}"
  pause_and_return
}

function pause_and_return() {
  echo ""
  read -n1 -r -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..." key
  main_menu
}

# ========= ä¸»èœå• =========
function main_menu() {
  show_banner
  echo "è¯·é€‰æ‹©æ“ä½œ:"
  echo ""
  echo "ğŸš€ å®‰è£…å’Œæ„å»º:"
  echo "  1) ğŸ¯ ç»ˆæå®Œæ•´å®‰è£… (è§£å†³ä¸»é¡¹ç›®æ„å»ºå¤±è´¥)"
  echo ""
  echo "ğŸ”‘ é’±åŒ…ç®¡ç†:"
  echo "  2) ğŸ”‘ ç”Ÿæˆé’±åŒ…"
  echo "  3) ğŸ“ è®¾ç½®æŒ–çŸ¿å…¬é’¥"
  echo ""
  echo "âš¡ èŠ‚ç‚¹ç®¡ç†:"
  echo "  4) âš¡ å¯åŠ¨èŠ‚ç‚¹"
  echo "  5) ğŸ“Š æŸ¥çœ‹æ—¥å¿—"
  echo "  6) â¹ï¸  åœæ­¢æœåŠ¡"
  echo ""
  echo "ğŸ” çŠ¶æ€æ£€æŸ¥:"
  echo "  7) ğŸ” æ£€æŸ¥çŠ¶æ€"
  echo ""
  echo "  0) é€€å‡ºè„šæœ¬"
  echo ""
  echo -e "${CYAN}ğŸ¯ ä¸“é—¨è§£å†³: ä¸»é¡¹ç›®æ„å»ºå¤±è´¥ï¼Œmem.rsé”™è¯¯ï¼Œå†…å­˜ä¸è¶³${RESET}"
  echo -e "${CYAN}ğŸ’¡ é€‚ç”¨ç¯å¢ƒ: 2GB+ å†…å­˜çš„ VPSï¼Œè‡ªåŠ¨é…ç½®å¤§å®¹é‡swap${RESET}"
  echo ""
  read -p "è¯·è¾“å…¥ç¼–å· (0-7): " choice

  case "$choice" in
    1) complete_installation_ultimate ;;
    2) generate_wallet_enhanced ;;
    3) set_mining_pubkey_enhanced ;;
    4) start_node_enhanced ;;
    5) view_logs ;;
    6) stop_services ;;
    7) check_status_enhanced ;;
    0) echo "é€€å‡ºè„šæœ¬."; exit 0 ;;
    *) echo -e "${RED}[-] æ— æ•ˆé€‰é¡¹${RESET}"; pause_and_return ;;
  esac
}

# æ£€æŸ¥æƒé™
if [ "$EUID" -eq 0 ]; then
  echo -e "${RED}[-] è¯·ä¸è¦ä»¥rootç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬${RESET}"
  exit 1
fi

# å¯åŠ¨ä¸»èœå•
main_menu
