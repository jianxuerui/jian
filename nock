#!/bin/bash

# ========= è‰²å½©å®šä¹‰ =========
RESET='\033[0m'
BOLD='\033[1m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'

# ========= é¡¹ç›®è·¯å¾„ =========
NCK_DIR="$HOME/nockchain"
ENV_FILE="$NCK_DIR/.env"

# ========= æ¨ªå¹… =========
function show_banner() {
  clear
  echo -e "${BOLD}${BLUE}"
  echo "==============================================="
  echo "         Nockchain å®‰è£…ä¸æŒ–çŸ¿åŠ©æ‰‹"
  echo "==============================================="
  echo -e "${RESET}"
  echo "ğŸ”§ å¢å¼ºç¼–è¯‘å¹¶è¡Œåº¦ï¼Œé…ç½®æŒ–çŸ¿çº¿ç¨‹æ•°"
  echo "ğŸ“Œ ä½œè€…: K2 èŠ‚ç‚¹æ•™ç¨‹åˆ†äº«"
  echo "ğŸ”— Telegram: https://t.me/+EaCiFDOghoM3Yzll"
  echo "ğŸ¦ Twitter:  https://x.com/BtcK241918"
  echo "-----------------------------------------------"
  echo ""
}

# ========= å¸¸ç”¨å‡½æ•° =========
function cd_nck_dir() {
  if [ -d "$NCK_DIR" ]; then
    cd "$NCK_DIR" || { echo -e "${RED}[-] æ— æ³•è¿›å…¥é¡¹ç›®ç›®å½•: $NCK_DIR${RESET}"; exit 1; }
  else
    echo -e "${RED}[-] é¡¹ç›®ç›®å½•ä¸å­˜åœ¨: $NCK_DIR${RESET}"
    # exit 1 # å¦‚æœç›®å½•ä¸å­˜åœ¨ï¼Œåœ¨ setup_all ä¸­ä¼šå…‹éš†ï¼Œæ‰€ä»¥ä¸ä¸€å®šéœ€è¦ç«‹å³é€€å‡º
    # åœ¨éœ€è¦ç›®å½•å­˜åœ¨çš„å‡½æ•°ä¸­å†åˆ¤æ–­å¹¶é€€å‡º
    return 1
  fi
  return 0
}

function pause_and_return() {
  echo ""
  read -n1 -r -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..." key
  main_menu
}

# æ£€æŸ¥æœ€ä½ç£ç›˜ç©ºé—´ (ä¾‹å¦‚ï¼Œ5GB)
function check_disk_space() {
    local required_gb=5
    local available_kb=$(df -k --output=avail "$HOME" 2>/dev/null | tail -n 1)

    if [ -z "$available_kb" ]; then
        echo -e "${YELLOW}[!] è­¦å‘Š: æ— æ³•æ£€æŸ¥ç£ç›˜ç©ºé—´ï¼Œè¯·æ‰‹åŠ¨ç¡®è®¤æ‚¨çš„ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³ã€‚${RESET}"
        return 0 # ä¸é˜»æ­¢æ‰§è¡Œ
    fi

    local available_gb=$((available_kb / 1024 / 1024))

    if [ "$available_gb" -lt "$required_gb" ]; then
        echo -e "${RED}[-] é”™è¯¯: ç£ç›˜ç©ºé—´ä¸è¶³! è‡³å°‘éœ€è¦ ${required_gb}GBï¼Œå½“å‰å¯ç”¨ ${available_gb}GBã€‚${RESET}"
        echo -e "${RED}    è¯·æ¸…ç†ç£ç›˜ç©ºé—´åå†è¿è¡Œã€‚${RESET}"
        return 1 # é˜»æ­¢æ‰§è¡Œ
    else
        echo -e "${GREEN}[+] ç£ç›˜ç©ºé—´æ£€æŸ¥é€šè¿‡ï¼Œå¯ç”¨ ${available_gb}GBã€‚${RESET}"
        return 0 # å…è®¸æ‰§è¡Œ
    fi
}


# ========= é…ç½®å‡½æ•° =========

# ç¡®ä¿ .env æ–‡ä»¶å­˜åœ¨å¹¶åŒ…å«å¿…è¦çš„å˜é‡
function configure_mining_env() {
  echo -e "[*] æ£€æŸ¥å¹¶è®¾ç½® .env æ–‡ä»¶ä¸­çš„æŒ–çŸ¿ç›¸å…³é…ç½®..."
  local env_file="$1"
  local num_cores=$(nproc)

  # å¤åˆ¶ç¤ºä¾‹æ–‡ä»¶å¦‚æœ .env ä¸å­˜åœ¨
  if [ ! -f "$env_file" ]; then
    if [ -f "$NCK_DIR/.env_example" ]; then
      cp -n "$NCK_DIR/.env_example" "$env_file"
      echo -e "${GREEN}[+] å·²ä» .env_example åˆ›å»º $env_file${RESET}"
    else
      echo -e "${RED}[-] é”™è¯¯: æ‰¾ä¸åˆ° .env_example æ–‡ä»¶ï¼Œæ— æ³•åˆ›å»º .env${RESET}"
      return 1
    fi
  fi

  # ç¡®ä¿ MINING_PUBKEY å­˜åœ¨ (ä»…æ£€æŸ¥ï¼Œä¸è‡ªåŠ¨è®¾ç½®ï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨æˆ–é€šè¿‡èœå•è®¾ç½®)
  if ! grep -q '^MINING_PUBKEY=' "$env_file"; then
    echo -e "${YELLOW}[!] æ¸©é¦¨æç¤º: .env æ–‡ä»¶ä¸­ç¼ºå°‘ MINING_PUBKEYï¼Œè¯·è¿è¡Œé€‰é¡¹ 2/3 ç”Ÿæˆ/è®¾ç½®æ‚¨çš„å…¬é’¥!${RESET}"
  fi

  # ç¡®ä¿ MINER_THREADS å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æ·»åŠ ï¼Œé»˜è®¤ä¸ºæ ¸å¿ƒæ•°
  if ! grep -q '^MINER_THREADS=' "$env_file"; then
    echo -e "${YELLOW}[!] .env æ–‡ä»¶ä¸­ç¼ºå°‘ MINER_THREADSï¼Œå°†æ·»åŠ é»˜è®¤å€¼ (CPUæ ¸å¿ƒæ•°: $num_cores)${RESET}"
    # ä½¿ç”¨ sed æ·»åŠ ï¼Œç¡®ä¿ä¸é‡å¤æ·»åŠ 
    if ! grep -q '^# æŒ–çŸ¿çº¿ç¨‹æ•°' "$env_file"; then
        echo "" >> "$env_file" # æ·»åŠ ä¸€ä¸ªç©ºè¡Œç¡®ä¿æ ¼å¼
        echo "# æŒ–çŸ¿çº¿ç¨‹æ•°ï¼Œå»ºè®®è®¾ç½®ä¸ºæ‚¨çš„CPUæ ¸å¿ƒæ•°" >> "$env_file"
    fi
    echo "MINER_THREADS=$num_cores" >> "$env_file"
    echo -e "${GREEN}[+] å·²æ·»åŠ  MINER_THREADS=$num_cores åˆ° $env_file${RESET}"
  else
    local current_threads=$(grep '^MINER_THREADS=' "$env_file" | cut -d'=' -f2)
    echo -e "[*] .env æ–‡ä»¶ä¸­å·²å­˜åœ¨ MINER_THREADS=$current_threads"
  fi

  # é‡æ–° source .env ä½¿é…ç½®ç”Ÿæ•ˆ for this script run
  # æ³¨æ„: è¿™åªå½±å“å½“å‰è„šæœ¬çš„æ‰§è¡Œç¯å¢ƒã€‚å¦‚æœå¸Œæœ›å¯åŠ¨è„šæœ¬ä¹Ÿç”Ÿæ•ˆï¼Œéœ€è¦åœ¨å¯åŠ¨è„šæœ¬ä¸­ source .env
  # start_node å‡½æ•°ä¸­å·²ç»åšäº† sourceï¼Œè¿™æ˜¯æ­£ç¡®çš„ã€‚
  # source "$env_file" # æš‚æ—¶ä¸åœ¨è¿™é‡Œ sourceï¼Œé¿å…æ±¡æŸ“å…¨å±€ç¯å¢ƒï¼Œåªåœ¨éœ€è¦æ—¶ source

  return 0
}

function set_pubkey_env() {
  echo -e "[*] è®¾ç½® MINING_PUBKEY åˆ° .env..."
  if ! cd_nck_dir; then pause_and_return; return; fi

  read -p "è¯·è¾“å…¥å…¬é’¥ (MINING_PUBKEY): " pubkey
  if [ -z "$pubkey" ]; then
    echo -e "${RED}[-] å…¬é’¥ä¸èƒ½ä¸ºç©º${RESET}"
    pause_and_return
    return
  fi

  # ä½¿ç”¨ sed åˆ é™¤æ—§è¡Œå¹¶æ·»åŠ æ–°è¡Œ
  if grep -q '^MINING_PUBKEY=' "$ENV_FILE"; then
    sed -i "/^MINING_PUBKEY=/c\MINING_PUBKEY=$pubkey" "$ENV_FILE"
    echo -e "${GREEN}[+] å·²æ›´æ–° MINING_PUBKEY åˆ° $ENV_FILE${RESET}"
  else
    # å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ·»åŠ 
    echo "" >> "$ENV_FILE" # ç¡®ä¿åœ¨æœ«å°¾æ·»åŠ æ—¶æ ¼å¼æ­£ç¡®
    echo "MINING_PUBKEY=$pubkey" >> "$ENV_FILE"
     echo -e "${GREEN}[+] å·²æ·»åŠ  MINING_PUBKEY=$pubkey åˆ° $ENV_FILE${RESET}"
  fi


  if grep -q "MINING_PUBKEY=$pubkey" "$ENV_FILE"; then
      echo -e "${GREEN}[+] MINING_PUBKEY=$pubkey å·²æˆåŠŸå†™å…¥/æ›´æ–°åˆ° .env${RESET}"
      # é‡æ–° source .env ä½¿é…ç½®ç”Ÿæ•ˆ for this script run
      source "$ENV_FILE"
  else
      echo -e "${RED}[-] å†™å…¥ MINING_PUBKEY åˆ° .env å¤±è´¥${RESET}"
  fi

  pause_and_return
}

function set_miner_threads_env() {
  echo -e "[*] è®¾ç½® MINER_THREADS åˆ° .env..."
  if ! cd_nck_dir; then pause_and_return; return; fi

  local max_cores=$(nproc)
  echo "æ‚¨çš„ç³»ç»Ÿæ£€æµ‹åˆ°æœ‰ ${max_cores} ä¸ª CPU æ ¸å¿ƒã€‚"
  read -p "è¯·è¾“å…¥æŒ–çŸ¿çº¿ç¨‹æ•° (MINER_THREADSï¼Œå»ºè®®ä¸è¶…è¿‡æ ¸å¿ƒæ•° $max_cores): " threads
  if [ -z "$threads" ]; then
    echo -e "${RED}[-] çº¿ç¨‹æ•°ä¸èƒ½ä¸ºç©º${RESET}"
    pause_and_return
    return
  fi

  # éªŒè¯è¾“å…¥æ˜¯å¦ä¸ºéè´Ÿæ•°å­—
  if ! [[ "$threads" =~ ^[0-9]+$ ]]; then
    echo -e "${RED}[-] è¾“å…¥æ— æ•ˆï¼Œè¯·è¾“å…¥ä¸€ä¸ªéè´Ÿæ•°å­—${RESET}"
    pause_and_return
    return
  fi

   # ä½¿ç”¨ sed åˆ é™¤æ—§è¡Œå¹¶æ·»åŠ æ–°è¡Œ
  if grep -q '^MINER_THREADS=' "$ENV_FILE"; then
    sed -i "/^MINER_THREADS=/c\MINER_THREADS=$threads" "$ENV_FILE"
     echo -e "${GREEN}[+] å·²æ›´æ–° MINER_THREADS=$threads åˆ° $ENV_FILE${RESET}"
  else
    # å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ·»åŠ 
     if ! grep -q '^# æŒ–çŸ¿çº¿ç¨‹æ•°' "$ENV_FILE"; then
        echo "" >> "$ENV_FILE" # ç¡®ä¿åœ¨æœ«å°¾æ·»åŠ æ—¶æ ¼å¼æ­£ç¡®
        echo "# æŒ–çŸ¿çº¿ç¨‹æ•°ï¼Œå»ºè®®è®¾ç½®ä¸ºæ‚¨çš„CPUæ ¸å¿ƒæ•°" >> "$ENV_FILE"
    fi
    echo "MINER_THREADS=$threads" >> "$ENV_FILE"
     echo -e "${GREEN}[+] å·²æ·»åŠ  MINER_THREADS=$threads åˆ° $ENV_FILE${RESET}"
  fi


  if grep -q "MINER_THREADS=$threads" "$ENV_FILE"; then
      echo -e "${GREEN}[+] MINER_THREADS=$threads å·²æˆåŠŸå†™å…¥/æ›´æ–°åˆ° .env${RESET}"
      echo -e "${YELLOW}[!] æ³¨æ„: å¯åŠ¨èŠ‚ç‚¹è„šæœ¬ (run_nockchain_miner.sh) éœ€è¦è¯»å–å¹¶ä½¿ç”¨è¿™ä¸ªå˜é‡æ‰èƒ½ç”Ÿæ•ˆã€‚${RESET}"
      # é‡æ–° source .env ä½¿é…ç½®ç”Ÿæ•ˆ for this script run
      source "$ENV_FILE"
  else
      echo -e "${RED}[-] å†™å…¥ MINER_THREADS åˆ° .env å¤±è´¥${RESET}"
  fi


  pause_and_return
}


# ========= å®‰è£…æ„å»ºå‡½æ•° =========
function setup_all() {
  show_banner # åœ¨å®‰è£…å‰å†æ¬¡æ˜¾ç¤ºæ¨ªå¹…

  # æ£€æŸ¥ç£ç›˜ç©ºé—´
  echo -e "[*] æ£€æŸ¥ç£ç›˜ç©ºé—´..."
  if ! check_disk_space; then
      pause_and_return
      return
  fi

  echo -e "[*] å®‰è£…ç³»ç»Ÿä¾èµ–..."
  sudo apt update
  sudo apt install -y clang llvm-dev libclang-dev pkg-config libssl-dev build-essential cmake curl git make screen || { echo -e "${RED}[-] ç³»ç»Ÿä¾èµ–å®‰è£…å¤±è´¥${RESET}"; pause_and_return; return; }
  echo -e "${GREEN}[+] ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ${RESET}"

  echo -e "[*] å®‰è£… Rust..."
  if ! command -v cargo &>/dev/null; then
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y || { echo -e "${RED}[-] Rust å®‰è£…å¤±è´¥${RESET}"; pause_and_return; return; }
    source "$HOME/.cargo/env"
    echo -e "${GREEN}[+] Rust å®‰è£…å®Œæˆ${RESET}"
  else
    echo -e "${YELLOW}[!] Rust å·²å®‰è£…ï¼Œè·³è¿‡å®‰è£…æ­¥éª¤${RESET}"
    source "$HOME/.cargo/env" # ç¡®ä¿å½“å‰ shell session æœ‰ cargo
  fi

  # ç¡®ä¿ cargo bin ç›®å½•åœ¨ PATH ä¸­
  RC_FILE="$HOME/.bashrc"
  [[ "$SHELL" == *"zsh"* ]] && RC_FILE="$HOME/.zshrc"
  if ! grep -q 'export PATH=.*\$HOME/\.cargo/bin:\$PATH' "$RC_FILE"; then
    echo '# Add Rust cargo bin to PATH' >> "$RC_FILE"
    echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> "$RC_FILE"
    echo -e "${GREEN}[+] å·²å°† Cargo æ·»åŠ åˆ° ${RC_FILE} çš„ PATH (å¯èƒ½éœ€è¦é‡æ–°ç™»å½•æˆ– source ${RC_FILE} ç”Ÿæ•ˆ)${RESET}"
  else
     echo -e "${YELLOW}[!] Cargo å·²åœ¨ ${RC_FILE} çš„ PATH ä¸­${RESET}"
  fi
  export PATH="$HOME/.cargo/bin:$PATH" # ç¡®ä¿å½“å‰ shell session æœ‰ cargo

  echo -e "[*] è·å–æˆ–æ›´æ–°ä»“åº“..."
  if [ -d "$NCK_DIR" ]; then
    echo -e "[*] é¡¹ç›®ç›®å½•å·²å­˜åœ¨ï¼Œå°è¯•æ‹‰å–æœ€æ–°ä»£ç ..."
    if ! cd_nck_dir; then pause_and_return; return; }
    git pull || { echo -e "${RED}[-] Git pull å¤±è´¥${RESET}"; pause_and_return; return; }
    echo -e "${GREEN}[+] ä»“åº“å·²æ›´æ–°${RESET}"
  else
    echo -e "[*] å…‹éš†ä»“åº“åˆ° $NCK_DIR..."
    git clone https://github.com/zorp-corp/nockchain "$NCK_DIR" || { echo -e "${RED}[-] Git clone å¤±è´¥${RESET}"; pause_and_return; return; }
    echo -e "${GREEN}[+] ä»“åº“å…‹éš†å®Œæˆ${RESET}"
    if ! cd_nck_dir; then pause_and_return; return; }
  fi

  # é…ç½® .env æ–‡ä»¶ï¼ŒåŒ…æ‹¬æŒ–çŸ¿çº¿ç¨‹æ•°
  configure_mining_env "$ENV_FILE" || { echo -e "${RED}[-] .env é…ç½®å¤±è´¥${RESET}"; pause_and_return; return; }

  echo -e "[*] æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶..."
  make clean || echo -e "${YELLOW}[!] make clean å¯èƒ½å¤±è´¥ï¼Œå¦‚æœé¦–æ¬¡æ„å»ºè¯·å¿½ç•¥æ­¤è­¦å‘Šã€‚${RESET}"
  cargo clean || echo -e "${YELLOW}[!] cargo clean å¯èƒ½å¤±è´¥ï¼Œå¦‚æœé¦–æ¬¡æ„å»ºè¯·å¿½ç•¥æ­¤è­¦å‘Šã€‚${RESET}"
  echo -e "${GREEN}[+] æ¸…ç†å®Œæˆ (æˆ–å·²è·³è¿‡)${RESET}"

  echo -e "[*] å®‰è£… hoonc (ä½¿ç”¨å¤šçº¿ç¨‹ç¼–è¯‘: make -j)..."
  # ç¡®ä¿åœ¨ NCK_DIR ç›®å½•ä¸‹æ‰§è¡Œ
  if ! cd_nck_dir; then pause_and_return; return; }
  make -j install-hoonc || { echo -e "${RED}[-] install-hoonc å¤±è´¥${RESET}"; echo "è¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯å¹¶å°è¯•æ‰‹åŠ¨è¿è¡Œ 'cd $NCK_DIR && make -j install-hoonc'"; pause_and_return; return; }
  echo -e "${GREEN}[+] hoonc å®‰è£…å®Œæˆ${RESET}"

  echo -e "[*] ç¼–è¯‘ Nockchain (ä½¿ç”¨å¤šçº¿ç¨‹ç¼–è¯‘: make -j)..."
  if ! cd_nck_dir; then pause_and_return; return; }
  make -j build || { echo -e "${RED}[-] build å¤±è´¥${RESET}"; echo "è¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯å¹¶å°è¯•æ‰‹åŠ¨è¿è¡Œ 'cd $NCK_DIR && make -j build'"; pause_and_return; return; }
  echo -e "${GREEN}[+] Nockchain ç¼–è¯‘å®Œæˆ${RESET}"

  echo -e "[*] å®‰è£…é’±åŒ… (ä½¿ç”¨å¤šçº¿ç¨‹ç¼–è¯‘: make -j)..."
  if ! cd_nck_dir; then pause_and_return; return; }
  make -j install-nockchain-wallet || { echo -e "${RED}[-] install-nockchain-wallet å¤±è´¥${RESET}"; echo "è¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯å¹¶å°è¯•æ‰‹åŠ¨è¿è¡Œ 'cd $NCK_DIR && make -j install-nockchain-wallet'"; pause_and_return; return; }
  echo -e "${GREEN}[+] é’±åŒ…å®‰è£…å®Œæˆ${RESET}"

  echo -e "[*] å®‰è£…èŠ‚ç‚¹ (ä½¿ç”¨å¤šçº¿ç¨‹ç¼–è¯‘: make -j)..."
  if ! cd_nck_dir; then pause_and_return; return; }
  make -j install-nockchain || { echo -e "${RED}[-] install-nockchain å¤±è´¥${RESET}"; echo "è¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯å¹¶å°è¯•æ‰‹åŠ¨è¿è¡Œ 'cd $NCK_DIR && make -j install-nockchain'"; pause_and_return; return; }
  echo -e "${GREEN}[+] èŠ‚ç‚¹ç¨‹åºå®‰è£…å®Œæˆ${RESET}"

  echo -e "${GREEN}===============================================${RESET}"
  echo -e "${GREEN}[+] Nockchain å®‰è£…å’Œæ„å»ºå·²å®Œæˆï¼${RESET}"
  echo -e "${GREEN}===============================================${RESET}"
  echo ""
  echo -e "${YELLOW}[!] ä¸‹ä¸€æ­¥é‡è¦äº‹é¡¹: ${RESET}"
  echo -e "${YELLOW}  1. ç”Ÿæˆæ‚¨çš„é’±åŒ…å¯†é’¥å¯¹ (èœå•é€‰é¡¹ 2)ã€‚${RESET}"
  echo -e "${YELLOW}  2. å°†ç”Ÿæˆçš„å…¬é’¥é…ç½®åˆ° .env æ–‡ä»¶ä¸­ (èœå•é€‰é¡¹ 3)ã€‚${RESET}"
  echo -e "${YELLOW}  3. æ£€æŸ¥ .env ä¸­çš„ MINER_THREADS é…ç½® (èœå•é€‰é¡¹ 8 å¯è®¾ç½®)ã€‚${RESET}"
  echo -e "${YELLOW}  4. å¯åŠ¨èŠ‚ç‚¹è¿›è¡ŒæŒ–çŸ¿ (èœå•é€‰é¡¹ 6)ã€‚${RESET}"
  echo ""

  pause_and_return
}

# ========= é’±åŒ…æ“ä½œå‡½æ•° =========
function generate_wallet() {
  echo -e "[*] ç”Ÿæˆé’±åŒ…å¯†é’¥å¯¹..."
  if ! cd_nck_dir; then pause_and_return; return; }

  # æ£€æŸ¥ç›®æ ‡ç›®å½•æ˜¯å¦æœ‰å†™å…¥æƒé™
  if [ ! -w "$NCK_DIR" ]; then
      echo -e "${RED}[-] é”™è¯¯: æ— æ³•åœ¨ $NCK_DIR ç›®å½•å†™å…¥æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥æƒé™ã€‚${RESET}"
      pause_and_return
      return
  fi

  # æ£€æŸ¥é’±åŒ…ç¨‹åºæ˜¯å¦å­˜åœ¨
  if [ ! -x "./target/release/nockchain-wallet" ]; then
      echo -e "${RED}[-] é”™è¯¯: é’±åŒ…ç¨‹åº './target/release/nockchain-wallet' ä¸å­˜åœ¨æˆ–ä¸å¯æ‰§è¡Œã€‚è¯·å…ˆè¿è¡Œé€‰é¡¹ 1 å®Œæˆå®‰è£…æ„å»ºã€‚${RESET}"
      pause_and_return
      return
  fi


  echo -e "${YELLOW}[!] ç”Ÿæˆå¯†é’¥å¯¹çš„è¾“å‡ºä¼šåŒ…å«æ‚¨çš„ç§é’¥å’Œå…¬é’¥ï¼Œè¯·åŠ¡å¿…ä¿å­˜å¥½ï¼${RESET}"
  echo -e "${YELLOW}    ç‰¹åˆ«æ˜¯å…¬é’¥ï¼Œç¨åéœ€è¦é…ç½®åˆ° .env æ–‡ä»¶ä¸­ (MINING_PUBKEY)ã€‚${RESET}"
  echo -e "${YELLOW}    ç§é’¥ä¿å­˜åœ¨æ‚¨è¿è¡Œå‘½ä»¤çš„å½“å‰ç›®å½•ä¸‹çš„ wallet.keys æ–‡ä»¶ä¸­ã€‚${RESET}"
  echo "-----------------------------------------------"

  # åœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆ wallet.keys
  ./target/release/nockchain-wallet keygen || {
    echo -e "${RED}[-] é’±åŒ…ç”Ÿæˆå¤±è´¥${RESET}"
    echo "è¯·ç¡®ä¿ './target/release/nockchain-wallet' å¯æ‰§è¡Œï¼Œå¹¶ä¸”æ‚¨åœ¨é¡¹ç›®æ ¹ç›®å½• $NCK_DIR ä¸‹è¿è¡Œã€‚"
    pause_and_return
    return
  }

  echo "-----------------------------------------------"
  echo -e "${GREEN}[+] é’±åŒ…å¯†é’¥å¯¹ç”Ÿæˆå®Œæˆ${RESET}"
  echo -e "${YELLOW}[!] å†æ¬¡æé†’ï¼šè¯·è®°å½•æ˜¾ç¤ºçš„å…¬é’¥ï¼Œå¹¶ä½¿ç”¨èœå•é€‰é¡¹ 3 å°†å…¶å†™å…¥ .env æ–‡ä»¶ä¸­çš„ MINING_PUBKEYã€‚${RESET}"
  echo -e "${YELLOW}[!] ç§é’¥å·²ä¿å­˜åˆ° $NCK_DIR/wallet.keys (è¯·å¦¥å–„ä¿ç®¡æ­¤æ–‡ä»¶ï¼)ã€‚${RESET}"

  pause_and_return
}

function export_keys() {
  echo -e "[*] å¯¼å‡ºé’±åŒ…å¯†é’¥åˆ°æ–‡ä»¶..."
  if ! cd_nck_dir; then pause_and_return; return; }

    # æ£€æŸ¥é’±åŒ…ç¨‹åºæ˜¯å¦å­˜åœ¨
  if [ ! -x "./target/release/nockchain-wallet" ]; then
      echo -e "${RED}[-] é”™è¯¯: é’±åŒ…ç¨‹åº './target/release/nockchain-wallet' ä¸å­˜åœ¨æˆ–ä¸å¯æ‰§è¡Œã€‚è¯·å…ˆè¿è¡Œé€‰é¡¹ 1 å®Œæˆå®‰è£…æ„å»ºã€‚${RESET}"
      pause_and_return
      return
  fi

  echo -e "${YELLOW}[!] å¯†é’¥æ–‡ä»¶åŒ…å«æ‚¨çš„ç§é’¥ï¼Œè¯·å¦¥å–„ä¿ç®¡å¯¼å‡ºæ–‡ä»¶ï¼${RESET}"
  echo -e "${YELLOW}    é»˜è®¤å¯¼å‡ºåˆ° $NCK_DIR/keys.export${RESET}"

  ./target/release/nockchain-wallet export-keys || {
    echo -e "${RED}[-] å¯¼å‡ºå¯†é’¥å¤±è´¥${RESET}"
    echo "è¯·ç¡®ä¿ './target/release/nockchain-wallet' å¯æ‰§è¡Œï¼Œå¹¶ä¸”æ‚¨åœ¨é¡¹ç›®æ ¹ç›®å½• $NCK_DIR ä¸‹è¿è¡Œã€‚"
    pause_and_return
    return
  }

  echo -e "${GREEN}[+] å¯†é’¥å·²å¯¼å‡ºåˆ° $NCK_DIR/keys.export${RESET}"
  pause_and_return
}

function import_keys() {
  echo -e "[*] å¯¼å…¥é’±åŒ…å¯†é’¥æ–‡ä»¶..."
  if ! cd_nck_dir; then pause_and_return; return; }

    # æ£€æŸ¥é’±åŒ…ç¨‹åºæ˜¯å¦å­˜åœ¨
  if [ ! -x "./target/release/nockchain-wallet" ]; then
      echo -e "${RED}[-] é”™è¯¯: é’±åŒ…ç¨‹åº './target/release/nockchain-wallet' ä¸å­˜åœ¨æˆ–ä¸å¯æ‰§è¡Œã€‚è¯·å…ˆè¿è¡Œé€‰é¡¹ 1 å®Œæˆå®‰è£…æ„å»ºã€‚${RESET}"
      pause_and_return
      return
  fi

  read -p "[?] è¯·è¾“å…¥è¦å¯¼å…¥çš„å¯†é’¥æ–‡ä»¶è·¯å¾„ (é»˜è®¤: $NCK_DIR/keys.export): " keyfile_input
  keyfile=${keyfile_input:-"$NCK_DIR/keys.export"}

  if [ ! -f "$keyfile" ]; then
    echo -e "${RED}[-] é”™è¯¯: å¯†é’¥æ–‡ä»¶ '$keyfile' ä¸å­˜åœ¨${RESET}"
    pause_and_return
    return
  fi

  echo -e "[*] å°è¯•å¯¼å…¥ '$keyfile'..."
  ./target/release/nockchain-wallet import-keys --input "$keyfile" || {
    echo -e "${RED}[-] å¯¼å…¥å¯†é’¥å¤±è´¥${RESET}"
    echo "è¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®ï¼Œå¹¶ä¸” './target/release/nockchain-wallet' å¯æ‰§è¡Œã€‚"
    pause_and_return
    return
  }

  echo -e "${GREEN}[+] å¯†é’¥å·²æˆåŠŸå¯¼å…¥${RESET}"
  pause_and_return
}

# ========= èŠ‚ç‚¹æ“ä½œå‡½æ•° =========
function start_node() {
  echo -e "[*] å¯åŠ¨èŠ‚ç‚¹ (screen åå°ä¼šè¯: nockchain)..."
  if ! cd_nck_dir; then pause_and_return; return; }

  # æ£€æŸ¥å¯åŠ¨è„šæœ¬æ˜¯å¦å­˜åœ¨å¹¶èµ‹äºˆæ‰§è¡Œæƒé™
  local run_script="./scripts/run_nockchain_miner.sh"
  if [ ! -f "$run_script" ]; then
    echo -e "${RED}[-] é”™è¯¯: æ‰¾ä¸åˆ°å¯åŠ¨è„šæœ¬ $run_script${RESET}"
    echo "è¯·å…ˆè¿è¡Œé€‰é¡¹ 1 å®Œæˆå®‰è£…æ„å»ºã€‚"
    pause_and_return
    return
  fi
  chmod +x "$run_script"

  # æ£€æŸ¥èŠ‚ç‚¹ç¨‹åºæ˜¯å¦å­˜åœ¨
  if [ ! -x "./target/release/nockchain" ]; then
      echo -e "${RED}[-] é”™è¯¯: èŠ‚ç‚¹ç¨‹åº './target/release/nockchain' ä¸å­˜åœ¨æˆ–ä¸å¯æ‰§è¡Œã€‚è¯·å…ˆè¿è¡Œé€‰é¡¹ 1 å®Œæˆå®‰è£…æ„å»ºã€‚${RESET}"
      pause_and_return
      return
  fi


  # é‡æ–° source .env ç¡®ä¿æœ€æ–°çš„é…ç½®è¢«è¯»å–
  if [ -f "$ENV_FILE" ]; then
      source "$ENV_FILE"
      echo -e "${GREEN}[+] å·²åŠ è½½ .env é…ç½®æ–‡ä»¶${RESET}"
  else
      echo -e "${RED}[-] è­¦å‘Š: .env æ–‡ä»¶ä¸å­˜åœ¨ï¼Œéƒ¨åˆ†é…ç½®å¯èƒ½ç¼ºå¤±ã€‚è¯·å…ˆè¿è¡Œé€‰é¡¹ 1 æˆ–æ‰‹åŠ¨åˆ›å»º .env${RESET}"
      pause_and_return # å¦‚æœ .env éƒ½ä¸å­˜åœ¨ï¼Œå¤§æ¦‚ç‡æ— æ³•å¯åŠ¨
      return
  fi

  # æ£€æŸ¥ MINING_PUBKEY æ˜¯å¦å·²è®¾ç½® (éç©º)
  if [ -z "$MINING_PUBKEY" ]; then
      echo -e "${RED}[-] é”™è¯¯: MINING_PUBKEY æœªåœ¨ .env æ–‡ä»¶ä¸­è®¾ç½®!${RESET}"
      echo "è¯·å…ˆè¿è¡Œèœå•é€‰é¡¹ 2 (ç”Ÿæˆé’±åŒ…) å’Œ 3 (è®¾ç½®å…¬é’¥) å®Œæˆé…ç½®ã€‚"
      pause_and_return
      return
  fi
  echo -e "[*] MINING_PUBKEY å·²é…ç½®: ${GREEN}$MINING_PUBKEY${RESET}"

  # æ£€æŸ¥ MINER_THREADS æ˜¯å¦å·²è®¾ç½® (éç©º)ï¼Œå¹¶æç¤º
  if [ -z "$MINER_THREADS" ]; then
      echo -e "${YELLOW}[!] è­¦å‘Š: MINER_THREADS æœªåœ¨ .env æ–‡ä»¶ä¸­è®¾ç½®ã€‚${RESET}"
      echo "    çŸ¿å·¥å¯èƒ½ä¼šä»¥é»˜è®¤çº¿ç¨‹æ•°è¿è¡Œ (é€šå¸¸ä¸ºå•çº¿ç¨‹)ã€‚å»ºè®®é€šè¿‡é€‰é¡¹ 8 è®¾ç½®ã€‚"
  else
      echo -e "[*] MINER_THREADS å·²é…ç½®: ${GREEN}$MINER_THREADS${RESET}"
      # è¿™é‡Œçš„æç¤ºå·²ç»åŒ…å«åœ¨ set_miner_threads_env ä¸­ï¼Œå¯ä»¥åœ¨è¿™é‡Œç®€åŒ–
      # echo -e "${YELLOW}[!] æ³¨æ„: çŸ¿å·¥å®é™…ä½¿ç”¨çš„çº¿ç¨‹æ•°å–å†³äº run_nockchain_miner.sh è„šæœ¬æ˜¯å¦è¯»å–å¹¶ä¼ é€’ MINER_THREADS å˜é‡ç»™çŸ¿å·¥ç¨‹åºã€‚${RESET}"
  fi


  # æ£€æŸ¥å¹¶å…³é—­æ—§çš„ screen ä¼šè¯
  if screen -list | grep -qw "nockchain"; then
    echo "[*] æ£€æµ‹åˆ°æ—§çš„ 'nockchain' screen ä¼šè¯ï¼Œå°è¯•å…³é—­..."
    screen -S nockchain -X quit || {
      echo -e "${RED}[-] æ— æ³•å…³é—­æ—§çš„ screen ä¼šè¯ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨æ“ä½œ: screen -S nockchain -X quit${RESET}"
      # ä¸é€€å‡ºï¼Œå°è¯•ç»§ç»­ï¼Œä½†æç¤ºç”¨æˆ·å¯èƒ½å­˜åœ¨é—®é¢˜
      # pause_and_return; return;
    }
    sleep 2 # ç­‰å¾…æ—§ä¼šè¯å®Œå…¨é€€å‡º
    # å†æ¬¡æ£€æŸ¥æ˜¯å¦å…³é—­æˆåŠŸ
    if ! screen -list | grep -qw "nockchain"; then
        echo -e "${GREEN}[+] æ—§çš„ screen ä¼šè¯å·²å…³é—­${RESET}"
    else
        echo -e "${YELLOW}[!] è­¦å‘Š: æ—§çš„ screen ä¼šè¯å¯èƒ½æœªèƒ½å®Œå…¨å…³é—­ã€‚è¯·æ‰‹åŠ¨æ£€æŸ¥ã€‚${RESET}"
    fi
  fi

  # å¯åŠ¨æ–°çš„ screen ä¼šè¯å¹¶è¿è¡Œè„šæœ¬
  # ä½¿ç”¨ bash -c "command" æ˜¯ä¸ºäº†ç¡®ä¿ screen å†…çš„ shell ç¯å¢ƒæ­£ç¡®ï¼Œå¹¶ä¸”èƒ½æ‰§è¡Œ source å’Œè„šæœ¬
  echo -e "[*] åœ¨ screen ä¼šè¯ 'nockchain' ä¸­å¯åŠ¨æŒ–çŸ¿è„šæœ¬..."
  # æ³¨æ„è¿™é‡Œçš„å‘½ä»¤ï¼šcd åˆ°ç›®å½•ï¼Œç„¶å source .envï¼Œæœ€åæ‰§è¡Œè„šæœ¬ã€‚
  # è„šæœ¬ run_nockchain_miner.sh å†…éƒ¨é€šå¸¸ä¼šå†æ¬¡è°ƒç”¨ nockchain ç¨‹åºå¹¶å¯èƒ½ä¼ é€’å‚æ•°ï¼Œ
  # ç¡®ä¿ run_nockchain_miner.sh èƒ½å¤Ÿè¯»å– MINER_THREADS å˜é‡æ˜¯å…³é”®ã€‚
  screen -dmS nockchain bash -c "cd $NCK_DIR && source $ENV_FILE && ./scripts/run_nockchain_miner.sh"

  sleep 3 # ç­‰å¾… screen ä¼šè¯å¯åŠ¨å¹¶æ‰§è¡Œå‘½ä»¤

  if screen -list | grep -qw "nockchain"; then
    echo -e "${GREEN}===============================================${RESET}"
    echo -e "${GREEN}[+] èŠ‚ç‚¹å·²æˆåŠŸåœ¨ screen ä¼šè¯ 'nockchain' åå°å¯åŠ¨${RESET}"
    echo -e "${GREEN}===============================================${RESET}"
    echo -e "${YELLOW}[!] ä½¿ç”¨ 'screen -r nockchain' å‘½ä»¤æŸ¥çœ‹æ—¥å¿—ã€‚${RESET}"
    echo -e "${YELLOW}[!] åœ¨ screen ä¼šè¯ä¸­ï¼ŒæŒ‰ Ctrl+A ç„¶åæŒ‰ D é”®å¯ä»¥é€€å‡ºä¼šè¯å¹¶è®©å…¶åœ¨åå°è¿è¡Œã€‚${RESET}"
  else
    echo -e "${RED}===============================================${RESET}"
    echo -e "${RED}[-] èŠ‚ç‚¹å¯åŠ¨å¤±è´¥!${RESET}"
    echo -e "${RED}    è¯·å°è¯•æ‰‹åŠ¨è¿è¡Œ: cd $NCK_DIR && source $ENV_FILE && ./scripts/run_nockchain_miner.sh${RESET}"
    echo -e "${RED}    æ£€æŸ¥é”™è¯¯è¾“å‡ºã€‚${RESET}"
    echo -e "${RED}===============================================${RESET}"
  fi

  pause_and_return
}

function view_logs() {
  if screen -list | grep -qw "nockchain"; then
    echo -e "${YELLOW}[!] è¿æ¥åˆ° screen ä¼šè¯ 'nockchain' æŸ¥çœ‹æ—¥å¿—ã€‚${RESET}"
    echo -e "${YELLOW}[!] åœ¨ screen ä¸­æŒ‰ Ctrl+A ç„¶åæŒ‰ D é”®å¯ä»¥é€€å‡ºä¼šè¯å¹¶è®©å…¶åœ¨åå°è¿è¡Œã€‚${RESET}"
    echo -e "${YELLOW}[!] æŒ‰ Ctrl+C å¯èƒ½ç»ˆæ­¢èŠ‚ç‚¹è¿›ç¨‹ï¼Œè¯·è°¨æ…æ“ä½œã€‚${RESET}"
    echo "-----------------------------------------------"
    # ä½¿ç”¨ exec screen -r nockchain å¯ä»¥åœ¨é€€å‡º screen åç›´æ¥è¿”å›ä¸»èœå•ï¼Œè€Œä¸æ˜¯åœç•™åœ¨ shell
    # ä½†æ˜¯ä¸ºäº†å…¼å®¹æ€§ï¼Œè¿˜æ˜¯ç›´æ¥è°ƒç”¨ screen -r nockchainï¼Œç„¶åè®© pause_and_return å¤„ç†è¿”å›
    screen -r nockchain
  else
    echo -e "${RED}[-] èŠ‚ç‚¹ screen ä¼šè¯ 'nockchain' æœªè¿è¡Œã€‚${RESET}"
    echo "è¯·ä½¿ç”¨èœå•é€‰é¡¹ 6 å¯åŠ¨èŠ‚ç‚¹ã€‚"
  fi
  pause_and_return
}

function stop_node() {
    echo -e "[*] åœæ­¢èŠ‚ç‚¹ screen ä¼šè¯..."
    if screen -list | grep -qw "nockchain"; then
        echo "[*] æ£€æµ‹åˆ° 'nockchain' screen ä¼šè¯ï¼Œå°è¯•åœæ­¢..."
        screen -S nockchain -X quit || {
            echo -e "${RED}[-] æ— æ³•åœæ­¢ screen ä¼šè¯ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨æ“ä½œ: screen -S nockchain -X quit${RESET}"
            pause_and_return
            return
        }
        sleep 2 # ç­‰å¾…ä¼šè¯å®Œå…¨é€€å‡º
        if ! screen -list | grep -qw "nockchain"; then
             echo -e "${GREEN}[+] èŠ‚ç‚¹ screen ä¼šè¯å·²åœæ­¢${RESET}"
        else
             echo -e "${YELLOW}[!] è­¦å‘Š: èŠ‚ç‚¹ screen ä¼šè¯å¯èƒ½æœªèƒ½å®Œå…¨åœæ­¢ã€‚è¯·æ‰‹åŠ¨æ£€æŸ¥ã€‚${RESET}"
        fi
    else
        echo -e "${YELLOW}[!] èŠ‚ç‚¹ screen ä¼šè¯ 'nockchain' æœªè¿è¡Œï¼Œæ— éœ€åœæ­¢ã€‚${RESET}"
    fi
    pause_and_return
}


# ========= ä¸»èœå• =========
function main_menu() {
  show_banner
  echo "è¯·é€‰æ‹©æ“ä½œ:"
  echo "  ${GREEN}1) ä¸€é”®å®‰è£…ã€æ„å»ºå¹¶åˆå§‹åŒ– .env (æ¨èé¦–æ¬¡è¿è¡Œ)${RESET}"
  echo "  ${BLUE}--- é’±åŒ…æ“ä½œ ---${RESET}"
  echo "  2) ç”Ÿæˆé’±åŒ…å¯†é’¥å¯¹ (æ˜¾ç¤ºå…¬é’¥ï¼Œç§é’¥ä¿å­˜åˆ° wallet.keys)"
  echo "  3) è®¾ç½® MINING_PUBKEY åˆ° .env (æ ¹æ®å…¬é’¥è®¾ç½®æŒ–çŸ¿åœ°å€)"
  echo "  4) å¯¼å‡ºé’±åŒ…å¯†é’¥åˆ°æ–‡ä»¶ (keys.export)"
  echo "  5) å¯¼å…¥é’±åŒ…å¯†é’¥æ–‡ä»¶"
  echo "  ${BLUE}--- èŠ‚ç‚¹æ“ä½œ ---${RESET}"
  echo "  6) å¯åŠ¨èŠ‚ç‚¹ (screen åå°è¿è¡Œ)"
  echo "  7) æŸ¥çœ‹èŠ‚ç‚¹æ—¥å¿— (è¿æ¥åˆ° screen ä¼šè¯)"
  echo "  8) è®¾ç½®æŒ–çŸ¿çº¿ç¨‹æ•° (MINER_THREADS) åˆ° .env"
  echo "  9) åœæ­¢èŠ‚ç‚¹ (screen ä¼šè¯)"
  echo "  ${RED}0) é€€å‡º${RESET}"
  echo ""
  read -p "è¯·è¾“å…¥ç¼–å·: " choice

  case "$choice" in
    1) setup_all ;;
    2) generate_wallet ;;
    3) set_pubkey_env ;;
    4) export_keys ;;
    5) import_keys ;;
    6) start_node ;;
    7) view_logs ;;
    8) set_miner_threads_env ;; # æ–°å¢é€‰é¡¹
    9) stop_node ;; # æ–°å¢é€‰é¡¹
    0) echo "é€€å‡ºè„šæœ¬."; exit 0 ;;
    *) echo -e "${RED}[-] æ— æ•ˆé€‰é¡¹${RESET}"; pause_and_return ;;
  esac
}

# ========= è„šæœ¬å…¥å£ =========
# ç¡®ä¿åœ¨è„šæœ¬å¼€å§‹æ—¶å°±åŠ è½½ .envï¼Œä»¥ä¾¿åç»­å‡½æ•°å¯ä»¥ä½¿ç”¨å…¶ä¸­çš„å˜é‡ï¼ˆå¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼‰
# ä½†åªåœ¨éœ€è¦è¿™äº›å˜é‡çš„å‡½æ•°ä¸­ source æ›´å®‰å…¨ï¼Œé¿å…æ±¡æŸ“å…¨å±€ç¯å¢ƒã€‚
# start_node å‡½æ•°ä¸­å·²ç»åšäº† sourceï¼Œå…¶ä»–å¦‚ set_* å‡½æ•°ç›´æ¥ä¿®æ”¹æ–‡ä»¶ã€‚
# æ‰€ä»¥è¿™é‡Œçš„å…¨å±€ source å¯ä»¥ç§»é™¤æˆ–ä¿ç•™ï¼Œå½±å“ä¸å¤§ï¼Œä¿ç•™æ˜¯ä¸ºäº†æŸäº›ç®€å•æ£€æŸ¥å¯èƒ½ç”¨åˆ°ã€‚
if [ -f "$ENV_FILE" ]; then
    source "$ENV_FILE"
fi


# å¯åŠ¨ä¸»èœå•å¾ªç¯
while true; do
    main_menu
done

exit 0 # æ­£å¸¸é€€å‡º
