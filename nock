#!/bin/bash
# ==============================================================================
# Nockchain æŒ–çŸ¿åŠ©æ‰‹ (K2 å¢å¼ºèåˆç‰ˆ v10.0.0 - å²è¯—å…¼å®¹æ ¸å¿ƒç‰ˆ)
# ==============================================================================
# ä½œè€…: K2 èŠ‚ç‚¹æ•™ç¨‹åˆ†äº« (AI ç»ˆæç¦»çº¿å†…æ ¸ç‰ˆ)
#
# v10.0.0 æ›´æ–°æ—¥å¿—:
# - [å²è¯—å…¼å®¹] æ–°å¢é Systemd ç³»ç»Ÿæ”¯æŒï¼å½“æ£€æµ‹åˆ°ç³»ç»Ÿæ—  Systemd æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°ä½¿ç”¨ `screen` è¿›è¡Œåå°ç®¡ç†ã€‚
# - [å²è¯—å…¼å®¹] å¢åŠ äº† `screen` ä½œä¸ºæ ¸å¿ƒä¾èµ–ï¼Œç¡®ä¿åœ¨æ‰€æœ‰ç³»ç»Ÿä¸Šéƒ½æœ‰ä¸€è‡´çš„åå°è¿è¡Œä½“éªŒã€‚
# - [å²è¯—å…¼å®¹] å¼ºåŒ–æ ¸å¿ƒå·¥å…·æ¢æµ‹ã€‚ä¸º `nproc` ç­‰å‘½ä»¤å¢åŠ å®‰å…¨å›é€€æœºåˆ¶ï¼Œå³ä½¿åœ¨æœ€å°åŒ–ç³»ç»Ÿä¸­ä¹Ÿèƒ½è·å–å¿…è¦ä¿¡æ¯ã€‚
# - [é²æ£’æ€§å¢å¼º] åœ¨å®‰è£…å‰å¢åŠ å¯¹ `git` å’Œ `curl` çš„é¢„æ£€æŸ¥ï¼Œå¼•å¯¼ç”¨æˆ·ä¿®å¤ç¼ºå¤±çš„åŸºç¡€å·¥å…·ã€‚
# - [æ™ºèƒ½èœå•] ä¸»èœå•ç°åœ¨å¯ä»¥åŠ¨æ€æ˜¾ç¤ºæœåŠ¡ç®¡ç†æ–¹å¼ (Systemd æˆ– Screen)ï¼Œå¹¶æä¾›ç›¸åº”çš„çŠ¶æ€ä¿¡æ¯ã€‚
# ==============================================================================

# --- æ™ºèƒ½å¼•å¯¼ä¸æƒé™æ£€æŸ¥ ---
if [ -z "$BASH_VERSION" ]; then
    echo -e "\033[0;31m[é”™è¯¯] æ­¤è„šæœ¬å¿…é¡»ä½¿ç”¨ 'bash' è§£é‡Šå™¨è¿è¡Œï¼Œè€Œä¸æ˜¯ 'sh'ã€‚\033[0m"
    echo -e "\033[1;33mè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿è¡Œ: \033[0;32mbash $0\033[0m"
    exit 1
fi
if [ "$(id -u)" -ne 0 ]; then
    echo -e "\033[1;33m[æç¤º] æ­¤è„šæœ¬éœ€è¦ Root æƒé™æ¥å®‰è£…ä¾èµ–å’Œç®¡ç†æœåŠ¡ã€‚\033[0m"
    echo -e "\033[0;36mæ­£åœ¨å°è¯•ä½¿ç”¨ 'sudo' è‡ªåŠ¨ææƒ...\033[0m"
    if ! command -v sudo &>/dev/null; then
        echo -e "\033[0;31m[é”™è¯¯] 'sudo' å‘½ä»¤æœªæ‰¾åˆ°ã€‚è¯·ä»¥ root ç”¨æˆ·èº«ä»½ç›´æ¥è¿è¡Œæ­¤è„šæœ¬: 'su -' åå†æ‰§è¡Œ 'bash $0'\033[0m"
        exit 1
    fi
    sudo bash "$0" "$@"
    exit $?
fi
# --- å¼•å¯¼ç»“æŸ ---

set -e

# --- å…¨å±€é…ç½® ---
MINER_USERNAME="miner"
MINER_HOME="/home/${MINER_USERNAME}"
NCK_DIR="${MINER_HOME}/nockchain"
ENV_FILE="${NCK_DIR}/.env"
SERVICE_NAME="nockchain-miner" # ä¹Ÿç”¨ä½œ screen ä¼šè¯å
SERVICE_FILE="/etc/systemd/system/${SERVICE_NAME}.service"

# --- é¢œè‰²å®šä¹‰ ---
if [ -t 1 ]; then
    RESET='\033[0m'; BOLD='\033[1m'; GREEN='\033[0;32m'; BLUE='\033[0;34m';
    YELLOW='\033[1;33m'; RED='\033[0;31m'; PURPLE='\033[0;35m'; CYAN='\033[0;36m'
else
    RESET=''; BOLD=''; GREEN=''; BLUE=''; YELLOW=''; RED=''; PURPLE=''; CYAN=''
fi

# --- å†…æ ¸æ•°æ® (v140) ---
read -r -d '' HOON_KERNEL_CONTENT <<'EOF'
::
/+  hoon
|%
++  ver
  |%
  ++  arvo  0vI.need
  ++  kelvin  (as-co:co /(~ . 400))
  ++  hoon  140
  --
++  ride
  |%
  ++  sins  |=  a=ovum  (send a)
  ++  fard  |=  a=ovum  (send a)
  ++  send  |=  a=ovum  ~|([! a] !!)
  --
--
EOF

# ==============================================================================
# === åŠ©æ‰‹å‡½æ•° (å…¼å®¹æ€§æ ¸å¿ƒ) ===
# ==============================================================================

function check_command_exists() { command -v "$1" &>/dev/null; }

function detect_system_info() {
    # ... (æ­¤å‡½æ•°å†…éƒ¨é€»è¾‘ä¸å˜, ä½†ä¾èµ–åˆ—è¡¨å·²æ›´æ–°) ...
    if [ -f /etc/os-release ]; then . /etc/os-release; OS_ID=${ID,,}; else OS_ID=$(uname -s | tr '[:upper:]' '[:lower:]'); fi
    local screen_dep="screen" # screen ä½œä¸ºé€šç”¨åå°ç®¡ç†å™¨
    if check_command_exists apt-get; then
        export PKG_MANAGER="apt"; export UPDATE_CMD="apt-get update -y"; export INSTALL_CMD="apt-get install -y"
        export DEP_PACKAGES="clang llvm libclang-dev pkg-config libssl-dev build-essential cmake git make curl dos2unix coreutils ${screen_dep}"
    elif check_command_exists dnf; then
        export PKG_MANAGER="dnf"; export UPDATE_CMD="dnf check-update"; export INSTALL_CMD="dnf install -y"
        export DEP_PACKAGES="clang llvm-devel libclang-devel pkgconfig openssl-devel cmake git make curl dos2unix coreutils ${screen_dep}"
        export GROUP_INSTALL_CMD="dnf groupinstall -y 'Development Tools'"
    elif check_command_exists yum; then
        export PKG_MANAGER="yum"; export UPDATE_CMD="yum check-update"; export INSTALL_CMD="yum install -y"
        export DEP_PACKAGES="clang llvm-devel libclang-devel pkgconfig openssl-devel cmake git make curl dos2unix coreutils ${screen_dep}"
        export GROUP_INSTALL_CMD="yum groupinstall -y 'Development Tools'"
    elif check_command_exists pacman; then
        export PKG_MANAGER="pacman"; export UPDATE_CMD="pacman -Sy"; export INSTALL_CMD="pacman -S --noconfirm --needed"
        export DEP_PACKAGES="clang llvm libclang pkg-config openssl cmake git make curl dos2unix base-devel coreutils ${screen_dep}"
    elif check_command_exists zypper; then
        export PKG_MANAGER="zypper"; export UPDATE_CMD="zypper refresh"; export INSTALL_CMD="zypper install -y"
        export DEP_PACKAGES="clang llvm-devel libclang-devel pkg-config libopenssl-devel cmake git make curl dos2unix patterns-devel-base-devel_basis coreutils ${screen_dep}"
    else export PKG_MANAGER="unsupported"; fi
    if [[ "$OS_ID" == "ubuntu" || "$OS_ID" == "debian" ]]; then export SUDO_GROUP="sudo"; else export SUDO_GROUP="wheel"; fi
}

function check_initial_deps() {
    local missing_deps=()
    ! check_command_exists curl && missing_deps+=("curl")
    ! check_command_exists git && missing_deps+=("git")
    if [ ${#missing_deps[@]} -ne 0 ]; then
        echo -e "${RED}é”™è¯¯: ç¼ºå°‘æ ¸å¿ƒä¾èµ–å·¥å…·: ${missing_deps[*]}${RESET}"
        if [ "$PKG_MANAGER" != "unsupported" ]; then
            echo -e "${YELLOW}è¯·å°è¯•æ‰‹åŠ¨è¿è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£…å®ƒä»¬:${RESET}"
            echo -e "${CYAN}${INSTALL_CMD} ${missing_deps[*]}${RESET}"
        else
            echo -e "${YELLOW}è¯·æ ¹æ®æ‚¨çš„ç³»ç»Ÿæ‰‹åŠ¨å®‰è£…å®ƒä»¬ã€‚${RESET}"
        fi
        exit 1
    fi
}

function show_banner() {
    clear
    echo -e "${BOLD}${BLUE}======================================================${RESET}"
    echo -e "${BOLD}${BLUE} Nockchain æŒ–çŸ¿åŠ©æ‰‹ (K2 v10.0.0 - å²è¯—å…¼å®¹æ ¸å¿ƒç‰ˆ)${RESET}"
    echo -e "${BOLD}${BLUE}======================================================${RESET}"
    echo -e "âœ¨ ${BOLD}${PURPLE}å†…æ ¸å¢å¼º: ä½¿ç”¨å†…ç½® v140 å†…æ ¸ï¼${RESET}"
    if check_systemd; then
        echo -e "âš™ï¸ ${BOLD}${GREEN}ç®¡ç†æ¨¡å¼: Systemd (ç°ä»£ç³»ç»Ÿæ ‡å‡†)${RESET}"
    else
        echo -e "âš™ï¸ ${BOLD}${YELLOW}ç®¡ç†æ¨¡å¼: Screen (å…¼å®¹æ¨¡å¼)${RESET}"
    fi
    if id "${MINER_USERNAME}" &>/dev/null; then echo -e "ğŸ‘¤ ${GREEN}ä¸“ç”¨ç”¨æˆ· '${MINER_USERNAME}' å·²åˆ›å»ºã€‚${RESET}"; else echo -e "ğŸ‘¤ ${YELLOW}ä¸“ç”¨ç”¨æˆ· '${MINER_USERNAME}' å¾…åˆ›å»ºã€‚${RESET}"; fi
    echo "ğŸ“Œ ä½œè€…: K2 èŠ‚ç‚¹æ•™ç¨‹åˆ†äº«"
    echo "------------------------------------------------------"; echo ""
}

# [é²æ£’æ€§å¢å¼º] å³ä½¿ç³»ç»Ÿæ²¡æœ‰ nproc æˆ–å…¶ä»–å·¥å…·ï¼Œä¹Ÿèƒ½å®‰å…¨åœ°è¿”å›ä¸€ä¸ªå€¼
function get_num_cores_safe() { nproc 2>/dev/null || grep -c '^processor' /proc/cpuinfo 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 1; }
function get_total_mem_kb() { grep MemTotal /proc/meminfo | awk '{print $2}' || echo 0; }
function pause_and_return() { echo ""; read -r -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..." -s -n 1; echo; }
function check_systemd() { [ -d /run/systemd/system ] && check_command_exists systemctl; }

# ==============================================================================
# === æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ===
# ==============================================================================

function install_all() {
    show_banner; check_initial_deps
    echo -e "${YELLOW}[*] å¼€å§‹å…¨æ–°å®‰è£… Nockchain...${RESET}"
    echo -e "${BLUE}--- æ­¥éª¤ 1/5: å‡†å¤‡ä¸“ç”¨ç”¨æˆ· '${MINER_USERNAME}' ---${RESET}"
    # ... (ç”¨æˆ·æ¸…ç†å’Œåˆ›å»ºé€»è¾‘ä¸å˜) ...
    if id "${MINER_USERNAME}" &>/dev/null; then
        echo -e "${YELLOW}[!] æ£€æµ‹åˆ°æ—§ç”¨æˆ· '${MINER_USERNAME}'ï¼Œæ­£åœ¨æ¸…ç†...${RESET}"
        if check_systemd; then systemctl stop "$SERVICE_NAME" &>/dev/null; systemctl disable "$SERVICE_NAME" &>/dev/null; rm -f "$SERVICE_FILE"; systemctl daemon-reload &>/dev/null; fi
        if check_command_exists screen; then screen -S ${SERVICE_NAME} -X quit &>/dev/null || true; fi
        killall -u "${MINER_USERNAME}" 2>/dev/null || true; userdel -r "${MINER_USERNAME}" 2>/dev/null || true
        echo -e "${GREEN}[+] æ—§ç”¨æˆ·åŠç›¸å…³è¿›ç¨‹/æœåŠ¡å·²æ¸…ç†ã€‚${RESET}"
    fi
    if [[ "$OS_ID" == "debian" || "$OS_ID" == "ubuntu" ]] && command -v adduser &>/dev/null; then adduser --disabled-password --gecos "" "${MINER_USERNAME}"; else useradd -m -s /bin/bash "${MINER_USERNAME}"; fi
    usermod -aG "${SUDO_GROUP}" "${MINER_USERNAME}"; echo -e "${GREEN}[âœ“] ç”¨æˆ·åˆ›å»ºæˆåŠŸå¹¶å·²é…ç½® sudo æƒé™ï¼${RESET}"

    echo -e "${BLUE}--- æ­¥éª¤ 2/5: å®‰è£…ç³»ç»Ÿä¾èµ– ---${RESET}"
    # ... (ä¾èµ–å®‰è£…é€»è¾‘ä¸å˜) ...
    if [ "$PKG_MANAGER" == "unsupported" ]; then echo -e "${RED}é”™è¯¯: æœªèƒ½è¯†åˆ«æ‚¨çš„åŒ…ç®¡ç†å™¨ã€‚è¯·æ‰‹åŠ¨å®‰è£…æ‰€éœ€ä¾èµ–ã€‚${RESET}"; exit 1; fi
    echo -e "${CYAN}æ­£åœ¨æ›´æ–°åŒ…åˆ—è¡¨...${RESET}"; eval "$UPDATE_CMD"
    echo -e "${CYAN}æ­£åœ¨å®‰è£…æ ¸å¿ƒä¾èµ– (åŒ…æ‹¬ screen)...${RESET}"; eval "$INSTALL_CMD $DEP_PACKAGES"
    if [ -n "$GROUP_INSTALL_CMD" ]; then echo -e "${CYAN}æ­£åœ¨å®‰è£…å¼€å‘å·¥å…·é›†...${RESET}"; eval "$GROUP_INSTALL_CMD"; fi
    echo -e "${GREEN}[âœ“] ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆã€‚${RESET}"

    echo -e "${BLUE}--- æ­¥éª¤ 3/5 & 4/5: å…‹éš†å’Œç¼–è¯‘ (ä»¥ '${MINER_USERNAME}' ç”¨æˆ·èº«ä»½) ---${RESET}"
    local b64_kernel; b64_kernel=$(echo -n "$HOON_KERNEL_CONTENT" | base64)
    local total_mem_kb; total_mem_kb=$(get_total_mem_kb)
    su - "${MINER_USERNAME}" -c bash <<EOF
    set -euo pipefail
    source "\$HOME/.cargo/env" || true
    if ! command -v cargo &>/dev/null; then
        echo "--- [${MINER_USERNAME}] æ­£åœ¨å®‰è£… Rust... ---"
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source "\$HOME/.cargo/env"
    fi
    NCK_DIR_SUB="\$HOME/nockchain"; rm -rf "\$NCK_DIR_SUB"; git clone https://github.com/zorp-corp/nockchain "\$NCK_DIR_SUB"; cd "\$NCK_DIR_SUB"
    echo "--- [${MINER_USERNAME}] æ­£åœ¨æ³¨å…¥å¢å¼ºç‰ˆ v140 å†…æ ¸... ---"
    echo "$b64_kernel" | base64 -d > "\$NCK_DIR_SUB/pkg/hoon.hoon"
    echo "--- [${MINER_USERNAME}] æ­£åœ¨ç¼–è¯‘å·¥å…·å’Œä¸»ç¨‹åº... ---"
    cargo build --release -p hoonc; mkdir -p assets
    "\$NCK_DIR_SUB/target/release/hoonc" pkg/miner.hoon > assets/miner.jam
    "\$NCK_DIR_SUB/target/release/hoonc" pkg/dumb.hoon > assets/dumb.jam
    "\$NCK_DIR_SUB/target/release/hoonc" pkg/wal.hoon > assets/wal.jam
    export RUSTFLAGS="-C target-cpu=native -C opt-level=3"; export CARGO_PROFILE_RELEASE_LTO="true"
    if [ "$total_mem_kb" -lt 2500000 ] && [ "$total_mem_kb" -ne 0 ]; then
        echo "--- [${MINER_USERNAME}] WARN: å†…å­˜è¾ƒä½ï¼Œä½¿ç”¨å•æ ¸ç¼–è¯‘ã€‚ ---"; BUILD_JOBS=1
    else
        BUILD_JOBS=\$(nproc 2>/dev/null || echo 1); echo "--- [${MINER_USERNAME}] INFO: ä½¿ç”¨ \${BUILD_JOBS} æ ¸ç¼–è¯‘ã€‚ ---"
    fi
    cargo build --release --workspace --exclude hoonc -j"\${BUILD_JOBS}"
    cp "\$NCK_DIR_SUB/target/release/nockchain" "\$HOME/.cargo/bin/"
    echo "--- [${MINER_USERNAME}] ç¼–è¯‘æˆåŠŸï¼ ---"
EOF
    if [ $? -ne 0 ]; then echo -e "\n${RED}å®‰è£…å¤±è´¥ï¼${RESET}"; else echo -e "\n${GREEN}[âœ“] Nockchain å®‰è£…æˆåŠŸï¼${RESET}"; fi
    pause_and_return
}

function set_pubkey() {
    show_banner; if [ ! -d "$NCK_DIR" ]; then echo -e "${RED}é”™è¯¯: Nockchain å°šæœªå®‰è£…ã€‚${RESET}"; pause_and_return; return; fi
    local pubkey; read -r -p "è¯·è¾“å…¥æ‚¨çš„128ä½æŒ–çŸ¿å…¬é’¥: " pubkey
    if ! [[ "$pubkey" =~ ^[0-9a-fA-F]{128}$ ]]; then echo -e "\n${RED}é”™è¯¯: å…¬é’¥æ ¼å¼æ— æ•ˆã€‚${RESET}"; pause_and_return; return; fi
    touch "$ENV_FILE"; chown "${MINER_USERNAME}:${MINER_USERNAME}" "$ENV_FILE"
    sed -i '/^MINING_PUBKEY=/d' "$ENV_FILE"; sed -i '/^MINER_THREADS=/d' "$ENV_FILE"
    echo "MINING_PUBKEY=$pubkey" >> "$ENV_FILE"; echo "MINER_THREADS=$(get_num_cores_safe)" >> "$ENV_FILE"
    echo -e "\n${GREEN}[âœ“] é…ç½®å·²æˆåŠŸä¿å­˜ï¼${RESET}"; pause_and_return
}

# --- æœåŠ¡ç®¡ç†åˆ†æ´¾ ---
function start_node() { show_banner; if check_systemd; then start_node_systemd; else start_node_screen; fi; pause_and_return; }
function stop_node() { show_banner; if check_systemd; then stop_node_systemd; else stop_node_screen; fi; pause_and_return; }
function view_logs() { show_banner; if check_systemd; then view_logs_systemd; else view_logs_screen; fi; }

# --- Systemd å®ç° ---
function start_node_systemd() {
    if [ ! -f "$ENV_FILE" ] || ! grep -q "MINING_PUBKEY" "$ENV_FILE"; then echo -e "${RED}é”™è¯¯: å°šæœªè®¾ç½®å…¬é’¥ã€‚${RESET}"; return; fi
    echo -e "${YELLOW}[*] æ­£åœ¨ä½¿ç”¨ Systemd å¯åŠ¨æœåŠ¡...${RESET}"
    cat <<EOF > "$SERVICE_FILE"
[Unit]
Description=${SERVICE_NAME}; After=network-online.target
[Service]
User=${MINER_USERNAME}; Group=$(id -gn "${MINER_USERNAME}"); WorkingDirectory=${NCK_DIR}; EnvironmentFile=${ENV_FILE}
ExecStart=${MINER_HOME}/.cargo/bin/nockchain
Restart=on-failure; RestartSec=10; LimitNOFILE=65536; Nice=-5
[Install]
WantedBy=multi-user.target
EOF
    systemctl daemon-reload; systemctl enable "$SERVICE_NAME"; systemctl restart "$SERVICE_NAME"
    echo -e "\n${GREEN}[âœ“] Systemd æœåŠ¡ '${SERVICE_NAME}' å·²å¯åŠ¨å¹¶è®¾ä¸ºå¼€æœºè‡ªå¯ï¼${RESET}"
}
function stop_node_systemd() {
    if ! systemctl list-units --full -all | grep -q "${SERVICE_NAME}.service"; then echo -e "${YELLOW}æç¤º: æœåŠ¡æœªå®‰è£…ã€‚${RESET}"; return; fi
    echo -e "${YELLOW}[*] æ­£åœ¨åœæ­¢ Systemd æœåŠ¡...${RESET}"; systemctl stop "$SERVICE_NAME"
    echo -e "\n${GREEN}[âœ“] Systemd æœåŠ¡ '${SERVICE_NAME}' å·²åœæ­¢ã€‚${RESET}"
}
function view_logs_systemd() {
    if ! systemctl list-units --full -all | grep -q "${SERVICE_NAME}.service"; then echo -e "${YELLOW}æç¤º: æœåŠ¡æœªå®‰è£…ã€‚${RESET}"; pause_and_return; return; fi
    echo -e "${YELLOW}æ˜¾ç¤ºå®æ—¶æ—¥å¿— (Systemd)... æŒ‰ Ctrl+C é€€å‡ºã€‚${RESET}"; echo "------------------------------------------------------"
    journalctl -u "$SERVICE_NAME" -f --no-pager; pause_and_return
}

# --- Screen (å…¼å®¹æ¨¡å¼) å®ç° ---
function start_node_screen() {
    if ! check_command_exists screen; then echo -e "${RED}é”™è¯¯: 'screen' æœªå®‰è£…ã€‚è¯·å…ˆè¿è¡Œå®‰è£…ç¨‹åºã€‚${RESET}"; return; fi
    if [ ! -f "$ENV_FILE" ] || ! grep -q "MINING_PUBKEY" "$ENV_FILE"; then echo -e "${RED}é”™è¯¯: å°šæœªè®¾ç½®å…¬é’¥ã€‚${RESET}"; return; fi
    if screen -ls | grep -q "${SERVICE_NAME}"; then echo -e "${YELLOW}æç¤º: æŒ–çŸ¿è¿›ç¨‹å·²åœ¨ Screen ä¸­è¿è¡Œã€‚${RESET}"; return; fi
    echo -e "${YELLOW}[*] æ­£åœ¨ä½¿ç”¨ Screen (å…¼å®¹æ¨¡å¼) åœ¨åå°å¯åŠ¨æŒ–çŸ¿...${RESET}"
    # ä½¿ç”¨ su åœ¨ miner ç”¨æˆ·ä¸‹å¯åŠ¨ screen ä¼šè¯
    su - "${MINER_USERNAME}" -c "screen -dmS ${SERVICE_NAME} bash -c 'cd ${NCK_DIR} && source ${ENV_FILE} && ${MINER_HOME}/.cargo/bin/nockchain'"
    echo -e "\n${GREEN}[âœ“] æŒ–çŸ¿å·²åœ¨åä¸º '${SERVICE_NAME}' çš„ Screen ä¼šè¯ä¸­å¯åŠ¨ï¼${RESET}"
    echo -e "${CYAN}æç¤º: æ­¤æ¨¡å¼ä¸ä¼šå¼€æœºè‡ªå¯ã€‚æ‚¨å¯ä»¥åœ¨æœåŠ¡å™¨é‡å¯åæ‰‹åŠ¨è¿è¡Œæ­¤è„šæœ¬æ¥æ¢å¤æŒ–çŸ¿ã€‚${RESET}"
}
function stop_node_screen() {
    if ! check_command_exists screen; then echo -e "${RED}é”™è¯¯: 'screen' æœªå®‰è£…ã€‚${RESET}"; return; fi
    if ! screen -ls | grep -q "${SERVICE_NAME}"; then echo -e "${YELLOW}æç¤º: Screen ä¸­æ²¡æœ‰æ­£åœ¨è¿è¡Œçš„æŒ–çŸ¿è¿›ç¨‹ã€‚${RESET}"; return; fi
    echo -e "${YELLOW}[*] æ­£åœ¨åœæ­¢ Screen ä¼šè¯...${RESET}"; screen -S "${SERVICE_NAME}" -X quit
    echo -e "\n${GREEN}[âœ“] Screen ä¼šè¯ '${SERVICE_NAME}' å·²åœæ­¢ã€‚${RESET}"
}
function view_logs_screen() {
    if ! check_command_exists screen; then echo -e "${RED}é”™è¯¯: 'screen' æœªå®‰è£…ã€‚${RESET}"; pause_and_return; return; fi
    if ! screen -ls | grep -q "${SERVICE_NAME}"; then echo -e "${YELLOW}æç¤º: Screen ä¸­æ²¡æœ‰æ­£åœ¨è¿è¡Œçš„æŒ–çŸ¿è¿›ç¨‹ã€‚${RESET}"; pause_and_return; return; fi
    echo -e "${YELLOW}æ­£åœ¨é™„åŠ åˆ° Screen ä¼šè¯...${RESET}"; echo -e "${CYAN}è¦é€€å‡ºæŸ¥çœ‹å¹¶è¿”å›èœå•ï¼Œè¯·æŒ‰ç»„åˆé”®: Ctrl+A ç„¶åæŒ‰ D${RESET}"; echo "------------------------------------------------------"
    # ç­‰å¾…ç”¨æˆ·æŒ‰é”®ï¼Œå¦åˆ™ screen -r ä¼šç«‹å³æ¥ç®¡ç»ˆç«¯
    sleep 2
    screen -r "${SERVICE_NAME}"; pause_and_return
}

function main_menu() {
    while true; do
    show_banner
    echo -e "${BOLD}${GREEN}--- ä¸»èœå• ---${RESET}"; echo "è¯·é€‰æ‹©è¦æ‰§è¡Œçš„æ“ä½œ:"; echo ""
    echo -e "  ${CYAN}1)${RESET} å…¨æ–°å®‰è£… Nockchain (ä¼šæ¸…ç©ºæ—§æ•°æ®)"
    echo -e "  ${CYAN}2)${RESET} è®¾ç½®/æ›´æ–°æŒ–çŸ¿å…¬é’¥"
    echo ""
    if check_systemd; then
        if systemctl is-active --quiet "$SERVICE_NAME" &>/dev/null; then SERVICE_STATUS="${GREEN}(è¿è¡Œä¸­)${RESET}"; else SERVICE_STATUS="${RED}(å·²åœæ­¢)${RESET}"; fi
        echo -e "  ${CYAN}3)${RESET} ${BOLD}å¯åŠ¨${RESET}æŒ–çŸ¿ (Systemd) ${SERVICE_STATUS}"
        echo -e "  ${CYAN}4)${RESET} ${BOLD}åœæ­¢${RESET}æŒ–çŸ¿ (Systemd)"
        echo -e "  ${CYAN}5)${RESET} æŸ¥çœ‹å®æ—¶æ—¥å¿— (Systemd)"
    elif check_command_exists screen; then
        if screen -ls | grep -q -w "${SERVICE_NAME}"; then SERVICE_STATUS="${GREEN}(è¿è¡Œä¸­)${RESET}"; else SERVICE_STATUS="${RED}(å·²åœæ­¢)${RESET}"; fi
        echo -e "  ${CYAN}3)${RESET} ${BOLD}å¯åŠ¨${RESET}æŒ–çŸ¿ (Screen) ${SERVICE_STATUS}"
        echo -e "  ${CYAN}4)${RESET} ${BOLD}åœæ­¢${RESET}æŒ–çŸ¿ (Screen)"
        echo -e "  ${CYAN}5)${RESET} æŸ¥çœ‹æŒ–çŸ¿çª—å£ (Screen)"
    else
        echo -e "  ${RED}3-5) (ä¸å¯ç”¨) ç¼ºå°‘ Systemd æˆ– Screenã€‚è¯·å…ˆè¿è¡Œå®‰è£…ç¨‹åºã€‚${RESET}"
    fi
    echo ""; echo -e "  ${YELLOW}0) é€€å‡ºè„šæœ¬${RESET}"; echo ""
    read -r -p "è¯·è¾“å…¥é€‰é¡¹ç¼–å·: " choice
    case "$choice" in
        1) install_all ;; 2) set_pubkey ;; 3) start_node ;; 4) stop_node ;; 5) view_logs ;;
        0) echo -e "${BLUE}æ„Ÿè°¢ä½¿ç”¨ï¼å†è§ã€‚${RESET}"; exit 0 ;;
        *) echo -e "${RED}æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚${RESET}"; sleep 1 ;;
    esac
    done
}

# --- è„šæœ¬å…¥å£ ---
detect_system_info
main_menu
