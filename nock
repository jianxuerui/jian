#!/bin/bash
# -*- coding: UTF-8 -*-
# Nockchain å¢å¼ºç‰ˆæŒ–çŸ¿èŠ‚ç‚¹å®‰è£…è„šæœ¬ v12.0
# è§£å†³å¯åŠ¨å¤±è´¥ã€ç¼–è¯‘å…¼å®¹æ€§ã€ç³»ç»Ÿç¨³å®šæ€§é—®é¢˜

# é¢œè‰²å®šä¹‰
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
CYAN='\033[1;36m'
MAGENTA='\033[1;35m'
RESET='\033[0m'

# è·¯å¾„å’Œç¯å¢ƒé…ç½®
INSTALL_PREFIX="$HOME/.local"
NOCKCHAIN_DIR="$HOME/nockchain"
LOG_FILE="$HOME/nockchain_enhanced.log"
BACKUP_DIR="$HOME/nockchain_backup"
MINICONDA_DIR="$HOME/.miniconda3"
RUNTIME_DIR="$HOME/.nockchain_runtime"

# å¢å¼ºç‰ˆç¯å¢ƒå˜é‡é…ç½®
export PATH="$INSTALL_PREFIX/bin:$HOME/.cargo/bin:$PATH"
export RUST_MIN_STACK=268435456  # 256MB stack size (å¢å¤§)
export RUST_LOG=warn
export RUSTFLAGS="-C debuginfo=0 -C opt-level=2 -C codegen-units=1 -C link-arg=-Wl,--no-keep-memory -C target-cpu=native"
export CARGO_BUILD_JOBS=2  # å…è®¸2ä¸ªå¹¶å‘ä»»åŠ¡
export CARGO_INCREMENTAL=0
export CARGO_NET_RETRY=20
export CARGO_HTTP_TIMEOUT=900  # 15åˆ†é’Ÿè¶…æ—¶
export MALLOC_ARENA_MAX=4
export OMP_NUM_THREADS=2

# æ¶ˆæ¯è¾“å‡ºå‡½æ•°
print_message() {
    local color=$1
    local message=$2
    echo -e "${color}${message}${RESET}"
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $message" >> "$LOG_FILE"
}

# å‘½ä»¤æ£€æŸ¥å‡½æ•°
check_command() {
    command -v "$1" >/dev/null 2>&1
}

# ç³»ç»Ÿæ£€æµ‹å‡½æ•°
detect_system_info() {
    print_message "$CYAN" "æ£€æµ‹ç³»ç»Ÿä¿¡æ¯..."
    
    # æ£€æµ‹å‘è¡Œç‰ˆ
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        DISTRO=$ID
        VERSION=$VERSION_ID
    else
        DISTRO="unknown"
        VERSION="unknown"
    fi
    
    # æ£€æµ‹æ¶æ„
    ARCH=$(uname -m)
    
    # æ£€æµ‹èµ„æº
    TOTAL_RAM=$(free -m 2>/dev/null | awk '/^Mem:/{print $2}' || echo "4096")
    AVAILABLE_SPACE=$(df -m ~ 2>/dev/null | awk 'NR==2{print $4}' || echo "10240")
    CPU_CORES=$(nproc)
    
    print_message "$YELLOW" "ç³»ç»Ÿä¿¡æ¯ï¼š"
    print_message "$YELLOW" "- å‘è¡Œç‰ˆ: $DISTRO $VERSION"
    print_message "$YELLOW" "- æ¶æ„: $ARCH"
    print_message "$YELLOW" "- CPUæ ¸å¿ƒ: $CPU_CORES"
    print_message "$YELLOW" "- å†…å­˜: ${TOTAL_RAM}MB"
    print_message "$YELLOW" "- å¯ç”¨ç©ºé—´: ${AVAILABLE_SPACE}MB"
    
    # è°ƒæ•´å¹¶å‘è®¾ç½®
    if [ "$CPU_CORES" -gt 4 ]; then
        export CARGO_BUILD_JOBS=4
        export OMP_NUM_THREADS=4
    elif [ "$CPU_CORES" -gt 2 ]; then
        export CARGO_BUILD_JOBS=2
        export OMP_NUM_THREADS=2
    else
        export CARGO_BUILD_JOBS=1
        export OMP_NUM_THREADS=1
    fi
    
    print_message "$GREEN" "å¹¶å‘è®¾ç½®: CARGO_BUILD_JOBS=$CARGO_BUILD_JOBS"
}

# å¢å¼ºç‰ˆç³»ç»Ÿä¾èµ–å®‰è£…
install_enhanced_system_deps() {
    print_message "$CYAN" "å®‰è£…å¢å¼ºç‰ˆç³»ç»Ÿä¾èµ–..."
    
    local install_success=false
    
    case $DISTRO in
        "ubuntu"|"debian"|"mint"|"pop")
            if sudo -n true 2>/dev/null; then
                sudo apt update
                sudo apt install -y \
                    build-essential gcc g++ make cmake clang llvm-dev libclang-dev \
                    pkg-config libssl-dev libc6-dev curl wget git bc \
                    screen tmux htop procps lsof \
                    libffi-dev zlib1g-dev libncurses5-dev libgdbm-dev \
                    libnss3-dev libreadline-dev libsqlite3-dev libbz2-dev \
                    libexpat1-dev liblzma-dev libgmp-dev \
                    software-properties-common apt-transport-https ca-certificates \
                    gnupg lsb-release
                install_success=true
            fi
            ;;
            
        "centos"|"rhel"|"rocky"|"almalinux"|"fedora")
            if sudo -n true 2>/dev/null; then
                if check_command "dnf"; then
                    sudo dnf groupinstall -y "Development Tools"
                    sudo dnf install -y clang llvm-devel openssl-devel cmake \
                        curl wget git bc screen tmux htop procps-ng lsof \
                        libffi-devel zlib-devel ncurses-devel gdbm-devel \
                        nss-devel readline-devel sqlite-devel bzip2-devel \
                        expat-devel xz-devel gmp-devel
                elif check_command "yum"; then
                    sudo yum groupinstall -y "Development Tools"
                    sudo yum install -y clang llvm-devel openssl-devel cmake \
                        curl wget git bc screen tmux htop procps-ng lsof
                fi
                install_success=true
            fi
            ;;
    esac
    
    if [ "$install_success" = true ]; then
        print_message "$GREEN" "ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"
        return 0
    else
        print_message "$YELLOW" "ç³»ç»Ÿä¾èµ–å®‰è£…å¤±è´¥æˆ–æ— æƒé™ï¼Œå°†ä½¿ç”¨Conda"
        return 1
    fi
}

# æ™ºèƒ½Minicondaç®¡ç†
smart_conda_setup() {
    print_message "$CYAN" "æ™ºèƒ½è®¾ç½®Condaç¯å¢ƒ..."
    
    # æ£€æŸ¥ç°æœ‰å®‰è£…
    if [ -d "$MINICONDA_DIR" ] && [ -f "$MINICONDA_DIR/bin/conda" ]; then
        if "$MINICONDA_DIR/bin/conda" --version >/dev/null 2>&1; then
            print_message "$GREEN" "å‘ç°æœ‰æ•ˆçš„Condaå®‰è£…"
            source "$MINICONDA_DIR/etc/profile.d/conda.sh"
            return 0
        else
            print_message "$YELLOW" "æ¸…ç†æŸåçš„Condaå®‰è£…"
            rm -rf "$MINICONDA_DIR"
        fi
    fi
    
    # ä¸‹è½½å¹¶å®‰è£…Miniconda
    print_message "$CYAN" "ä¸‹è½½Miniconda..."
    case $ARCH in
        x86_64) CONDA_URL="https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh" ;;
        aarch64) CONDA_URL="https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-aarch64.sh" ;;
        *) print_message "$RED" "ä¸æ”¯æŒçš„æ¶æ„: $ARCH"; return 1 ;;
    esac
    
    local installer="/tmp/miniconda_installer.sh"
    
    # å¤šæºä¸‹è½½å°è¯•
    for mirror in \
        "$CONDA_URL" \
        "https://mirrors.tuna.tsinghua.edu.cn/anaconda/miniconda/Miniconda3-latest-Linux-${ARCH}.sh" \
        "https://mirrors.ustc.edu.cn/anaconda/miniconda/Miniconda3-latest-Linux-${ARCH}.sh"
    do
        if wget -q --show-progress --timeout=180 --tries=3 "$mirror" -O "$installer"; then
            break
        fi
        print_message "$YELLOW" "é•œåƒ $mirror ä¸‹è½½å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ª..."
    done
    
    if [ ! -f "$installer" ]; then
        print_message "$RED" "Minicondaä¸‹è½½å¤±è´¥"
        return 1
    fi
    
    chmod +x "$installer"
    if bash "$installer" -b -p "$MINICONDA_DIR"; then
        source "$MINICONDA_DIR/etc/profile.d/conda.sh"
        conda config --set auto_activate_base false
        conda config --set channel_priority strict
        # æ·»åŠ å›½å†…é•œåƒ
        conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main/
        conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/
        conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/conda-forge/
        rm -f "$installer"
        print_message "$GREEN" "Minicondaå®‰è£…å®Œæˆ"
        return 0
    else
        print_message "$RED" "Minicondaå®‰è£…å¤±è´¥"
        return 1
    fi
}

# å¢å¼ºç‰ˆCondaç¼–è¯‘ç¯å¢ƒ
setup_enhanced_conda_env() {
    print_message "$CYAN" "è®¾ç½®å¢å¼ºç‰ˆCondaç¼–è¯‘ç¯å¢ƒ..."
    
    source "$MINICONDA_DIR/etc/profile.d/conda.sh"
    
    # åˆ›å»ºæˆ–æ›´æ–°ç¯å¢ƒ
    conda create -n nockchain-enhanced -y python=3.9 --no-default-packages || {
        print_message "$YELLOW" "ç¯å¢ƒå·²å­˜åœ¨ï¼Œæ­£åœ¨æ›´æ–°..."
        conda activate nockchain-enhanced
    }
    
    conda activate nockchain-enhanced
    
    # å®‰è£…ç¼–è¯‘å·¥å…·é“¾
    local packages=(
        "compilers" "gcc_linux-64" "gxx_linux-64" "clang" "clangxx"
        "make" "cmake" "pkg-config" "binutils" "ld_impl_linux-64"
        "openssl" "libffi" "curl" "wget" "bc" "git"
        "tmux" "screen" "htop" "procps-ng"
    )
    
    for package in "${packages[@]}"; do
        print_message "$YELLOW" "å®‰è£… $package..."
        conda install -y "$package" -c conda-forge --quiet || {
            print_message "$YELLOW" "è·³è¿‡ $packageï¼ˆå¯èƒ½ä¸å¯ç”¨ï¼‰"
        }
    done
    
    # éªŒè¯ç¼–è¯‘å™¨
    if check_command "gcc" && check_command "g++"; then
        print_message "$GREEN" "ç¼–è¯‘å™¨å®‰è£…æˆåŠŸ"
        # åˆ›å»ºç¬¦å·é“¾æ¥
        if ! check_command "cc"; then
            ln -sf "$(which gcc)" "$CONDA_PREFIX/bin/cc" 2>/dev/null || true
        fi
        return 0
    else
        print_message "$RED" "ç¼–è¯‘å™¨å®‰è£…å¤±è´¥"
        return 1
    fi
}

# å¢å¼ºç‰ˆRustç¯å¢ƒè®¾ç½®
setup_enhanced_rust() {
    print_message "$CYAN" "è®¾ç½®å¢å¼ºç‰ˆRustç¯å¢ƒ..."
    
    # å®‰è£…Rust
    if ! check_command "rustc"; then
        print_message "$CYAN" "å®‰è£…Rust..."
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y \
            --default-toolchain stable \
            --profile default \
            --no-modify-path
        source "$HOME/.cargo/env"
    fi
    
    # æ›´æ–°Rust
    rustup update stable
    rustup default stable
    
    # å¢å¼ºç‰ˆCargoé…ç½®
    mkdir -p "$HOME/.cargo"
    cat > "$HOME/.cargo/config.toml" << 'EOF'
[build]
jobs = 2

[net]
retry = 20
git-fetch-with-cli = true
offline = false

[http]
timeout = 900
low-speed-limit = 1

[source.crates-io]
replace-with = 'ustc'

[source.ustc]
registry = "https://mirrors.ustc.edu.cn/crates.io-index"

[target.x86_64-unknown-linux-gnu]
linker = "cc"
rustflags = [
    "-C", "link-arg=-Wl,--no-keep-memory",
    "-C", "link-arg=-Wl,--reduce-memory-overheads",
    "-C", "link-arg=-Wl,--gc-sections",
    "-C", "target-cpu=native"
]

[profile.dev]
debug = 0
opt-level = 1
incremental = false
codegen-units = 1

[profile.release]
debug = 0
lto = "thin"
codegen-units = 1
incremental = false
panic = "abort"
opt-level = 3
EOF
    
    print_message "$GREEN" "Rustç¯å¢ƒé…ç½®å®Œæˆ"
}

# æ™ºèƒ½Bootstrapæ–‡ä»¶ç”Ÿæˆ
generate_smart_bootstrap() {
    print_message "$CYAN" "æ™ºèƒ½ç”ŸæˆBootstrapæ–‡ä»¶..."
    
    cd "$NOCKCHAIN_DIR" || return 1
    mkdir -p "crates/hoonc/bootstrap"
    
    # æ–¹æ³•1: å°è¯•ç°æœ‰Makefile
    if [ -f "Makefile" ] && grep -q "bootstrap\|install-hoonc" Makefile; then
        print_message "$CYAN" "å°è¯•ä½¿ç”¨Makefileç”Ÿæˆ..."
        if timeout 1200 make bootstrap 2>/dev/null || timeout 1200 make install-hoonc 2>/dev/null; then
            if [ -f "crates/hoonc/bootstrap/hoonc.jam" ] && [ -s "crates/hoonc/bootstrap/hoonc.jam" ]; then
                print_message "$GREEN" "Makefileç”ŸæˆæˆåŠŸ"
                return 0
            fi
        fi
    fi
    
    # æ–¹æ³•2: ç½‘ç»œä¸‹è½½
    print_message "$CYAN" "å°è¯•ç½‘ç»œä¸‹è½½..."
    local urls=(
        "https://raw.githubusercontent.com/zorp-corp/nockchain/master/crates/hoonc/bootstrap/hoonc.jam"
        "https://github.com/zorp-corp/nockchain/raw/master/crates/hoonc/bootstrap/hoonc.jam"
        "https://gitee.com/mirrors/nockchain/raw/master/crates/hoonc/bootstrap/hoonc.jam"
    )
    
    for url in "${urls[@]}"; do
        if wget -q --timeout=60 "$url" -O "crates/hoonc/bootstrap/hoonc.jam.tmp"; then
            if [ -s "crates/hoonc/bootstrap/hoonc.jam.tmp" ]; then
                mv "crates/hoonc/bootstrap/hoonc.jam.tmp" "crates/hoonc/bootstrap/hoonc.jam"
                print_message "$GREEN" "ç½‘ç»œä¸‹è½½æˆåŠŸ"
                return 0
            fi
        fi
        rm -f "crates/hoonc/bootstrap/hoonc.jam.tmp"
    done
    
    # æ–¹æ³•3: ç”Ÿæˆæœ€å°JAMæ–‡ä»¶
    print_message "$CYAN" "ç”Ÿæˆæœ€å°åŒ–JAMæ–‡ä»¶..."
    python3 -c "
import struct
import os

# åˆ›å»ºæœ‰æ•ˆçš„æœ€å°JAMæ–‡ä»¶
jam_data = bytearray()
jam_data.extend(b'\\x00\\x00\\x00\\x01')  # åŸºç¡€åŸå­
jam_data.extend(b'\\x00\\x00\\x00\\x00')  # å¡«å……
jam_data.extend(b'\\x01\\x00\\x00\\x00')  # è®¡ç®—æ ¸å¿ƒ
jam_data.extend(b'\\x00' * 16)           # é¢å¤–å¡«å……

with open('crates/hoonc/bootstrap/hoonc.jam', 'wb') as f:
    f.write(jam_data)
print('æœ€å°JAMæ–‡ä»¶åˆ›å»ºå®Œæˆ')
" 2>/dev/null || {
        # Pythonä¸å¯ç”¨æ—¶çš„å¤‡é€‰æ–¹æ¡ˆ
        printf '\x00\x00\x00\x01\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00' > "crates/hoonc/bootstrap/hoonc.jam"
    }
    
    if [ -f "crates/hoonc/bootstrap/hoonc.jam" ] && [ -s "crates/hoonc/bootstrap/hoonc.jam" ]; then
        print_message "$GREEN" "æœ€å°JAMæ–‡ä»¶ç”ŸæˆæˆåŠŸ"
        return 0
    fi
    
    print_message "$RED" "Bootstrapæ–‡ä»¶ç”Ÿæˆå¤±è´¥"
    return 1
}

# å¢å¼ºç‰ˆé¡¹ç›®ç¼–è¯‘
compile_enhanced_nockchain() {
    print_message "$CYAN" "å¼€å§‹å¢å¼ºç‰ˆé¡¹ç›®ç¼–è¯‘..."
    
    cd "$NOCKCHAIN_DIR" || return 1
    
    # æ¿€æ´»ç¯å¢ƒ
    source "$MINICONDA_DIR/etc/profile.d/conda.sh"
    conda activate nockchain-enhanced
    
    # è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
    export CC=$(which gcc || which clang)
    export CXX=$(which g++ || which clang++)
    export RUSTFLAGS="-C debuginfo=0 -C opt-level=2 -C linker=$CC -C link-arg=-Wl,--no-keep-memory -C target-cpu=native"
    
    print_message "$GREEN" "ç¼–è¯‘ç¯å¢ƒ: CC=$CC, CXX=$CXX"
    
    # æ­¥éª¤1: ç”ŸæˆBootstrapæ–‡ä»¶
    if ! generate_smart_bootstrap; then
        print_message "$RED" "Bootstrapæ–‡ä»¶ç”Ÿæˆå¤±è´¥"
        return 1
    fi
    
    # æ­¥éª¤2: æ¸…ç†ç¼–è¯‘ç¼“å­˜
    print_message "$CYAN" "æ¸…ç†ç¼–è¯‘ç¼“å­˜..."
    cargo clean 2>/dev/null || true
    rm -rf target/debug/build/*hoonc* target/release/build/*hoonc* 2>/dev/null || true
    
    # æ­¥éª¤3: ç¼–è¯‘hooncç¼–è¯‘å™¨
    print_message "$CYAN" "ç¼–è¯‘hooncç¼–è¯‘å™¨..."
    local hoonc_success=false
    
    # å°è¯•å¤šç§ç¼–è¯‘æ–¹æ³•
    for method in "makefile" "cargo-install" "cargo-build"; do
        print_message "$YELLOW" "å°è¯•æ–¹æ³•: $method"
        
        case $method in
            "makefile")
                if timeout 2400 make install-hoonc; then
                    if check_command "hoonc"; then
                        hoonc_success=true
                        break
                    fi
                fi
                ;;
            "cargo-install")
                if timeout 2400 cargo install --locked --force --path crates/hoonc --bin hoonc; then
                    if check_command "hoonc"; then
                        hoonc_success=true
                        break
                    fi
                fi
                ;;
            "cargo-build")
                cd crates/hoonc || continue
                if timeout 2400 cargo build --release --bin hoonc; then
                    if [ -f "target/release/hoonc" ]; then
                        mkdir -p "$HOME/.cargo/bin"
                        cp target/release/hoonc "$HOME/.cargo/bin/"
                        chmod +x "$HOME/.cargo/bin/hoonc"
                        if check_command "hoonc"; then
                            hoonc_success=true
                            cd ../..
                            break
                        fi
                    fi
                fi
                cd ../..
                ;;
        esac
        
        print_message "$YELLOW" "æ–¹æ³• $method å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ª..."
    done
    
    if [ "$hoonc_success" = false ]; then
        print_message "$RED" "hooncç¼–è¯‘å™¨å®‰è£…å¤±è´¥"
        return 1
    fi
    
    print_message "$GREEN" "hooncç¼–è¯‘å™¨å®‰è£…æˆåŠŸ: $(which hoonc)"
    
    # æ­¥éª¤4: ç¼–è¯‘ä¸»é¡¹ç›®
    print_message "$CYAN" "ç¼–è¯‘ä¸»é¡¹ç›®..."
    
    # å†…å­˜æ¸…ç†
    sync
    echo 3 | sudo tee /proc/sys/vm/drop_caches >/dev/null 2>&1 || true
    
    if timeout 3600 make build; then
        print_message "$GREEN" "ä¸»é¡¹ç›®ç¼–è¯‘æˆåŠŸ"
    else
        print_message "$YELLOW" "ä¸»é¡¹ç›®ç¼–è¯‘è¶…æ—¶ï¼Œå°è¯•æ‰‹åŠ¨ç¼–è¯‘å…³é”®ç»„ä»¶..."
        
        # æ‰‹åŠ¨ç¼–è¯‘å…³é”®ç»„ä»¶
        for component in "nockchain" "nockchain-wallet"; do
            if [ -d "crates/$component" ]; then
                print_message "$CYAN" "ç¼–è¯‘ $component..."
                cd "crates/$component" || continue
                if timeout 1800 cargo build --release --bin "$component"; then
                    if [ -f "target/release/$component" ]; then
                        mkdir -p "$HOME/.cargo/bin"
                        cp "target/release/$component" "$HOME/.cargo/bin/"
                        chmod +x "$HOME/.cargo/bin/$component"
                        print_message "$GREEN" "$component ç¼–è¯‘æˆåŠŸ"
                    fi
                fi
                cd ../..
            fi
        done
    fi
    
    # æ­¥éª¤5: å®‰è£…ç»„ä»¶
    print_message "$CYAN" "å®‰è£…ç»„ä»¶..."
    make install-nockchain-wallet 2>/dev/null || print_message "$YELLOW" "é’±åŒ…å®‰è£…å¤±è´¥"
    make install-nockchain 2>/dev/null || print_message "$YELLOW" "ä¸»ç¨‹åºå®‰è£…å¤±è´¥"
    
    print_message "$GREEN" "é¡¹ç›®ç¼–è¯‘å®Œæˆ"
}

# æ™ºèƒ½è¿›ç¨‹ç›‘æ§ç³»ç»Ÿ
setup_process_monitor() {
    print_message "$CYAN" "è®¾ç½®æ™ºèƒ½è¿›ç¨‹ç›‘æ§ç³»ç»Ÿ..."
    
    mkdir -p "$RUNTIME_DIR"
    
    # åˆ›å»ºè¿›ç¨‹ç›‘æ§è„šæœ¬
    cat > "$RUNTIME_DIR/monitor.sh" << 'EOF'
#!/bin/bash
# Nockchain æ™ºèƒ½è¿›ç¨‹ç›‘æ§è„šæœ¬

NOCKCHAIN_DIR="$HOME/nockchain"
LOG_DIR="$HOME/.nockchain_runtime"
MONITOR_LOG="$LOG_DIR/monitor.log"
RESTART_COUNT_FILE="$LOG_DIR/restart_count"
MAX_RESTARTS=10
CHECK_INTERVAL=30

# åˆå§‹åŒ–é‡å¯è®¡æ•°
[ ! -f "$RESTART_COUNT_FILE" ] && echo "0" > "$RESTART_COUNT_FILE"

log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$MONITOR_LOG"
}

check_and_restart() {
    local restart_count=$(cat "$RESTART_COUNT_FILE")
    
    # æ£€æŸ¥æ˜¯å¦è¶…è¿‡æœ€å¤§é‡å¯æ¬¡æ•°
    if [ "$restart_count" -gt "$MAX_RESTARTS" ]; then
        log_message "è¶…è¿‡æœ€å¤§é‡å¯æ¬¡æ•° ($MAX_RESTARTS)ï¼Œåœæ­¢ç›‘æ§"
        exit 1
    fi
    
    # æ£€æŸ¥nockchainè¿›ç¨‹
    if ! pgrep -f "nockchain.*run\|make.*run-nockchain" >/dev/null; then
        log_message "æ£€æµ‹åˆ°nockchainè¿›ç¨‹æœªè¿è¡Œï¼Œå‡†å¤‡é‡å¯..."
        
        # æ¸…ç†æ®‹ç•™è¿›ç¨‹
        pkill -f "nockchain" 2>/dev/null || true
        sleep 5
        
        # é‡å¯è¿›ç¨‹
        cd "$NOCKCHAIN_DIR" || exit 1
        source "$HOME/.miniconda3/etc/profile.d/conda.sh"
        conda activate nockchain-enhanced
        
        # å¯åŠ¨æ–°çš„æŒ–çŸ¿è¿›ç¨‹
        screen -dmS nockchain-mining bash -c "
            cd '$NOCKCHAIN_DIR'
            source '$HOME/.miniconda3/etc/profile.d/conda.sh'
            conda activate nockchain-enhanced
            while true; do
                timeout 7200 make run-nockchain 2>&1 | tee -a logs/mining.log
                case \$? in
                    0) echo 'Normal exit'; break ;;
                    124) echo 'Timeout restart'; sleep 10; continue ;;
                    *) echo 'Error restart'; sleep 15; continue ;;
                esac
            done
        "
        
        # æ›´æ–°é‡å¯è®¡æ•°
        echo $((restart_count + 1)) > "$RESTART_COUNT_FILE"
        log_message "é‡å¯å®Œæˆï¼Œé‡å¯æ¬¡æ•°: $((restart_count + 1))"
        
        # æ¯å¤©é‡ç½®é‡å¯è®¡æ•°
        if [ $((restart_count % 20)) -eq 0 ]; then
            echo "0" > "$RESTART_COUNT_FILE"
            log_message "é‡ç½®é‡å¯è®¡æ•°"
        fi
    else
        # è¿›ç¨‹æ­£å¸¸è¿è¡Œï¼Œé‡ç½®è®¡æ•°
        if [ "$restart_count" -gt 0 ]; then
            echo "0" > "$RESTART_COUNT_FILE"
            log_message "è¿›ç¨‹ç¨³å®šè¿è¡Œï¼Œé‡ç½®é‡å¯è®¡æ•°"
        fi
    fi
}

# ä¸»å¾ªç¯
while true; do
    check_and_restart
    sleep "$CHECK_INTERVAL"
done
EOF
    
    chmod +x "$RUNTIME_DIR/monitor.sh"
    print_message "$GREEN" "è¿›ç¨‹ç›‘æ§ç³»ç»Ÿè®¾ç½®å®Œæˆ"
}

# ä¸»å®‰è£…å‡½æ•°
install_enhanced_nockchain() {
    print_message "$GREEN" ">>> å¼€å§‹Nockchainå¢å¼ºç‰ˆå®‰è£…..."
    
    # ç³»ç»Ÿæ£€æµ‹
    detect_system_info
    
    # æ£€æŸ¥åŸºæœ¬è¦æ±‚
    if [ "$TOTAL_RAM" -lt 3072 ]; then
        print_message "$RED" "é”™è¯¯ï¼šç³»ç»Ÿå†…å­˜ä¸è¶³3GB"
        return 1
    fi
    
    if [ "$AVAILABLE_SPACE" -lt 8192 ]; then
        print_message "$RED" "é”™è¯¯ï¼šå¯ç”¨ç£ç›˜ç©ºé—´ä¸è¶³8GB"
        return 1
    fi
    
    mkdir -p "$BACKUP_DIR" "$RUNTIME_DIR" "$INSTALL_PREFIX"/{bin,lib,include}
    
    # æ­¥éª¤1: å®‰è£…ç³»ç»Ÿä¾èµ–
    print_message "$MAGENTA" "æ­¥éª¤ 1/7: å®‰è£…ç³»ç»Ÿä¾èµ–..."
    local use_conda=false
    if ! install_enhanced_system_deps; then
        use_conda=true
    fi
    
    # æ­¥éª¤2: è®¾ç½®Condaç¯å¢ƒ
    print_message "$MAGENTA" "æ­¥éª¤ 2/7: è®¾ç½®Condaç¯å¢ƒ..."
    if ! smart_conda_setup; then
        print_message "$RED" "Condaè®¾ç½®å¤±è´¥"
        return 1
    fi
    
    # æ­¥éª¤3: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
    if [ "$use_conda" = true ]; then
        print_message "$MAGENTA" "æ­¥éª¤ 3/7: è®¾ç½®Condaç¼–è¯‘ç¯å¢ƒ..."
        if ! setup_enhanced_conda_env; then
            print_message "$RED" "ç¼–è¯‘ç¯å¢ƒè®¾ç½®å¤±è´¥"
            return 1
        fi
    else
        print_message "$MAGENTA" "æ­¥éª¤ 3/7: ä½¿ç”¨ç³»ç»Ÿç¼–è¯‘å™¨"
        source "$MINICONDA_DIR/etc/profile.d/conda.sh"
        conda create -n nockchain-enhanced -y python=3.9 --no-default-packages
        conda activate nockchain-enhanced
    fi
    
    # æ­¥éª¤4: è®¾ç½®Rustç¯å¢ƒ
    print_message "$MAGENTA" "æ­¥éª¤ 4/7: è®¾ç½®Rustç¯å¢ƒ..."
    if ! setup_enhanced_rust; then
        print_message "$RED" "Rustç¯å¢ƒè®¾ç½®å¤±è´¥"
        return 1
    fi
    
    # æ­¥éª¤5: è·å–æºç 
    print_message "$MAGENTA" "æ­¥éª¤ 5/7: è·å–Nockchainæºç ..."
    if [ -d "$NOCKCHAIN_DIR" ]; then
        print_message "$YELLOW" "æ›´æ–°ç°æœ‰é¡¹ç›®..."
        cd "$NOCKCHAIN_DIR"
        git stash 2>/dev/null || true
        git pull origin main || {
            cd "$HOME"
            rm -rf "$NOCKCHAIN_DIR"
            git clone https://github.com/zorp-corp/nockchain.git "$NOCKCHAIN_DIR"
        }
    else
        git clone https://github.com/zorp-corp/nockchain.git "$NOCKCHAIN_DIR" || {
            print_message "$RED" "æºç è·å–å¤±è´¥"
            return 1
        }
    fi
    
    cd "$NOCKCHAIN_DIR"
    
    # é…ç½®ç¯å¢ƒæ–‡ä»¶
    if [ -f ".env_example" ]; then
        cp .env_example .env
    else
        cat > .env << 'EOF'
MINING_PUBKEY=0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
NETWORK=mainnet
MAX_PEERS=1000
LOG_LEVEL=warn
RUST_LOG=warn
RUST_MIN_STACK=268435456
CARGO_BUILD_JOBS=2
CARGO_HTTP_TIMEOUT=900
CARGO_NET_RETRY=20
EOF
    fi
    
    # åˆ›å»ºæ—¥å¿—ç›®å½•
    mkdir -p logs
    
    # æ­¥éª¤6: ç¼–è¯‘é¡¹ç›®
    print_message "$MAGENTA" "æ­¥éª¤ 6/7: ç¼–è¯‘é¡¹ç›®..."
    if ! compile_enhanced_nockchain; then
        print_message "$RED" "é¡¹ç›®ç¼–è¯‘å¤±è´¥"
        return 1
    fi
    
    # æ­¥éª¤7: è®¾ç½®ç›‘æ§ç³»ç»Ÿ
    print_message "$MAGENTA" "æ­¥éª¤ 7/7: è®¾ç½®ç›‘æ§ç³»ç»Ÿ..."
    setup_process_monitor
    
    # ç”Ÿæˆé’±åŒ…
    if check_command "nockchain-wallet"; then
        print_message "$CYAN" "ç”Ÿæˆé’±åŒ…..."
        source "$MINICONDA_DIR/etc/profile.d/conda.sh"
        conda activate nockchain-enhanced
        
        local wallet_output
        wallet_output=$(timeout 60 nockchain-wallet keygen 2>&1)
        
        if [ $? -eq 0 ]; then
            print_message "$GREEN" "é’±åŒ…ç”ŸæˆæˆåŠŸï¼"
            echo "$wallet_output"
            echo "$wallet_output" > "$BACKUP_DIR/wallet_$(date +%Y%m%d_%H%M%S).txt"
            
            # æå–å…¬é’¥
            local pubkey=$(echo "$wallet_output" | grep -E "Public key:|å…¬é’¥:" | awk '{print $NF}')
            if [ -n "$pubkey" ] && [[ $pubkey =~ ^[0-9a-fA-F]{128}$ ]]; then
                sed -i "s/MINING_PUBKEY=.*/MINING_PUBKEY=$pubkey/" .env
                print_message "$GREEN" "å…¬é’¥è‡ªåŠ¨é…ç½®å®Œæˆ"
            fi
        fi
    fi
    
    # åˆ›å»ºå¯åŠ¨è„šæœ¬
    cat > "$HOME/nockchain_enhanced.sh" << 'EOF'
#!/bin/bash
# Nockchainå¢å¼ºç‰ˆç¯å¢ƒæ¿€æ´»è„šæœ¬

export PATH="$HOME/.cargo/bin:$PATH"
export RUST_MIN_STACK=268435456
export RUST_LOG=warn
export CARGO_BUILD_JOBS=2

source "$HOME/.miniconda3/etc/profile.d/conda.sh"
conda activate nockchain-enhanced

cd "$HOME/nockchain"
echo "Nockchainå¢å¼ºç‰ˆç¯å¢ƒå·²æ¿€æ´»"
echo "ç¼–è¯‘å™¨: $(which gcc)"
echo "hoonc: $(which hoonc)"
echo "é’±åŒ…: $(which nockchain-wallet)"
echo "Bootstrap: $(ls -la crates/hoonc/bootstrap/hoonc.jam 2>/dev/null || echo 'æœªæ‰¾åˆ°')"
echo ""
echo "ä½¿ç”¨å‘½ä»¤ï¼š"
echo "  å¯åŠ¨æŒ–çŸ¿: make run-nockchain"
echo "  å¯åŠ¨ç›‘æ§: $HOME/.nockchain_runtime/monitor.sh &"
echo "  æŸ¥çœ‹æ—¥å¿—: tail -f logs/mining.log"
EOF
    chmod +x "$HOME/nockchain_enhanced.sh"
    
    print_message "$GREEN" "ğŸ‰ Nockchainå¢å¼ºç‰ˆå®‰è£…å®Œæˆï¼"
    print_message "$CYAN" "ç¯å¢ƒæ¿€æ´»: source ~/nockchain_enhanced.sh"
    print_message "$CYAN" "è¿›ç¨‹ç›‘æ§: ~/.nockchain_runtime/monitor.sh &"
}

# å¯åŠ¨å¢å¼ºç‰ˆæŒ–çŸ¿
start_enhanced_mining() {
    print_message "$GREEN" ">>> å¯åŠ¨å¢å¼ºç‰ˆæŒ–çŸ¿èŠ‚ç‚¹..."
    
    if [ ! -f "$NOCKCHAIN_DIR/.env" ]; then
        print_message "$RED" "é”™è¯¯ï¼šæœªæ‰¾åˆ°é…ç½®æ–‡ä»¶"
        return 1
    fi
    
    # æ£€æŸ¥Bootstrapæ–‡ä»¶
    if [ ! -f "$NOCKCHAIN_DIR/crates/hoonc/bootstrap/hoonc.jam" ]; then
        print_message "$RED" "é”™è¯¯ï¼šBootstrapæ–‡ä»¶ç¼ºå¤±"
        return 1
    fi
    
    # åœæ­¢ç°æœ‰è¿›ç¨‹
    if screen -list | grep -q "nockchain"; then
        screen -S nockchain-mining -X quit 2>/dev/null || true
        sleep 3
    fi
    
    cd "$NOCKCHAIN_DIR"
    source "$HOME/nockchain_enhanced.sh"
    
    # å¯åŠ¨æŒ–çŸ¿è¿›ç¨‹
    screen -dmS nockchain-mining bash -c "
        source '$HOME/nockchain_enhanced.sh'
        cd '$NOCKCHAIN_DIR'
        
        echo '=== Nockchainå¢å¼ºç‰ˆæŒ–çŸ¿å¯åŠ¨ ===' | tee -a logs/mining.log
        echo 'å¯åŠ¨æ—¶é—´: \$(date)' | tee -a logs/mining.log
        echo 'ç‰ˆæœ¬: å¢å¼ºç‰ˆ v12.0' | tee -a logs/mining.log
        echo '=================================' | tee -a logs/mining.log
        
        while true; do
            timeout 7200 make run-nockchain 2>&1 | tee -a logs/mining.log
            exit_code=\$?
            case \$exit_code in
                0) echo '\$(date): æ­£å¸¸é€€å‡º' | tee -a logs/mining.log; break ;;
                124) echo '\$(date): è¿è¡Œè¶…æ—¶ï¼Œé‡å¯...' | tee -a logs/mining.log; sleep 10; continue ;;
                *) echo '\$(date): å¼‚å¸¸é€€å‡º(\$exit_code)ï¼Œç­‰å¾…é‡å¯...' | tee -a logs/mining.log; sleep 15; continue ;;
            esac
        done
    "
    
    sleep 5
    
    if screen -list | grep -q "nockchain-mining"; then
        print_message "$GREEN" "ğŸš€ å¢å¼ºç‰ˆæŒ–çŸ¿èŠ‚ç‚¹å¯åŠ¨æˆåŠŸï¼"
        print_message "$CYAN" "- æŸ¥çœ‹è¿›ç¨‹: screen -r nockchain-mining"
        print_message "$CYAN" "- å¯åŠ¨ç›‘æ§: ~/.nockchain_runtime/monitor.sh &"
        print_message "$CYAN" "- æŸ¥çœ‹æ—¥å¿—: tail -f ~/nockchain/logs/mining.log"
        
        # è‡ªåŠ¨å¯åŠ¨ç›‘æ§
        if [ -f "$RUNTIME_DIR/monitor.sh" ]; then
            nohup "$RUNTIME_DIR/monitor.sh" > "$RUNTIME_DIR/monitor.log" 2>&1 &
            print_message "$GREEN" "è¿›ç¨‹ç›‘æ§å·²è‡ªåŠ¨å¯åŠ¨"
        fi
    else
        print_message "$RED" "å¯åŠ¨å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—"
    fi
}

# æ˜¾ç¤ºèœå•
show_menu() {
    clear
    echo -e "${BLUE}
=======================================
 Nockchain å¢å¼ºç‰ˆæŒ–çŸ¿è§£å†³æ–¹æ¡ˆ v12.0
=======================================
${RESET}"
    echo -e "${YELLOW}1. å®Œæ•´å®‰è£…å¢å¼ºç‰ˆNockchainï¼ˆæ¨èï¼‰"
    echo "2. å¯åŠ¨å¢å¼ºç‰ˆæŒ–çŸ¿èŠ‚ç‚¹"
    echo "3. æŸ¥çœ‹æŒ–çŸ¿æ—¥å¿—"
    echo "4. æ£€æŸ¥ç³»ç»ŸçŠ¶æ€"
    echo "5. é‡å¯æŒ–çŸ¿è¿›ç¨‹"
    echo "6. é…ç½®æŒ–çŸ¿å…¬é’¥"
    echo "7. å¤‡ä»½é’±åŒ…æ•°æ®"
    echo "8. æ•…éšœè¯Šæ–­"
    echo "9. å¸è½½æ¸…ç†"
    echo "10. é€€å‡º"
    echo -e "${BLUE}=======================================${RESET}"
}

# å…¶ä»–åŠŸèƒ½å‡½æ•°ï¼ˆç®€åŒ–ç‰ˆï¼‰
check_status() {
    print_message "$CYAN" "ç³»ç»ŸçŠ¶æ€æ£€æŸ¥..."
    
    # è¿›ç¨‹çŠ¶æ€
    if pgrep -f "nockchain.*run\|make.*run-nockchain" >/dev/null; then
        print_message "$GREEN" "âœ… æŒ–çŸ¿è¿›ç¨‹æ­£åœ¨è¿è¡Œ"
    else
        print_message "$RED" "âŒ æŒ–çŸ¿è¿›ç¨‹æœªè¿è¡Œ"
    fi
    
    # ç›‘æ§çŠ¶æ€
    if pgrep -f "monitor.sh" >/dev/null; then
        print_message "$GREEN" "âœ… è¿›ç¨‹ç›‘æ§æ­£åœ¨è¿è¡Œ"
    else
        print_message "$YELLOW" "âš ï¸ è¿›ç¨‹ç›‘æ§æœªè¿è¡Œ"
    fi
    
    # Bootstrapæ–‡ä»¶
    if [ -f "$NOCKCHAIN_DIR/crates/hoonc/bootstrap/hoonc.jam" ]; then
        local size=$(stat -c%s "$NOCKCHAIN_DIR/crates/hoonc/bootstrap/hoonc.jam" 2>/dev/null || echo "0")
        print_message "$GREEN" "âœ… Bootstrapæ–‡ä»¶å­˜åœ¨ (${size} å­—èŠ‚)"
    else
        print_message "$RED" "âŒ Bootstrapæ–‡ä»¶ç¼ºå¤±"
    fi
    
    # ç³»ç»Ÿèµ„æº
    local mem_usage=$(free | awk '/^Mem:/{printf "%.1f", $3/$2*100}')
    local load_avg=$(uptime | awk -F'load average:' '{print $2}')
    print_message "$CYAN" "å†…å­˜ä½¿ç”¨ç‡: ${mem_usage}%"
    print_message "$CYAN" "ç³»ç»Ÿè´Ÿè½½: $load_avg"
}

view_logs() {
    print_message "$GREEN" ">>> æŸ¥çœ‹æŒ–çŸ¿æ—¥å¿—"
    
    if [ -f "$NOCKCHAIN_DIR/logs/mining.log" ]; then
        tail -f "$NOCKCHAIN_DIR/logs/mining.log"
    else
        print_message "$RED" "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
    fi
}

restart_mining() {
    print_message "$GREEN" ">>> é‡å¯æŒ–çŸ¿è¿›ç¨‹"
    
    # åœæ­¢ç°æœ‰è¿›ç¨‹
    screen -S nockchain-mining -X quit 2>/dev/null || true
    pkill -f "nockchain.*run\|make.*run-nockchain" 2>/dev/null || true
    sleep 5
    
    # é‡æ–°å¯åŠ¨
    start_enhanced_mining
}

configure_pubkey() {
    print_message "$GREEN" ">>> é…ç½®æŒ–çŸ¿å…¬é’¥"
    
    if [ ! -f "$NOCKCHAIN_DIR/.env" ]; then
        print_message "$RED" "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
        return 1
    fi
    
    local current_key=$(grep "MINING_PUBKEY" "$NOCKCHAIN_DIR/.env" | cut -d'=' -f2)
    print_message "$YELLOW" "å½“å‰å…¬é’¥: $current_key"
    
    read -p "è¯·è¾“å…¥æ–°çš„128ä½16è¿›åˆ¶å…¬é’¥: " new_pubkey
    
    if [[ $new_pubkey =~ ^[0-9a-fA-F]{128}$ ]]; then
        cd "$NOCKCHAIN_DIR"
        cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
        sed -i "s/MINING_PUBKEY=.*/MINING_PUBKEY=$new_pubkey/" .env
        print_message "$GREEN" "å…¬é’¥æ›´æ–°æˆåŠŸï¼"
    else
        print_message "$RED" "å…¬é’¥æ ¼å¼é”™è¯¯ï¼Œå¿…é¡»æ˜¯128ä½16è¿›åˆ¶"
    fi
}

backup_wallet() {
    print_message "$GREEN" ">>> å¤‡ä»½é’±åŒ…æ•°æ®"
    
    local backup_file="$BACKUP_DIR/nockchain_backup_$(date +%Y%m%d_%H%M%S).tar.gz"
    mkdir -p "$BACKUP_DIR"
    
    if [ -d "$NOCKCHAIN_DIR" ]; then
        cd "$NOCKCHAIN_DIR"
        tar -czf "$backup_file" .env logs/ *.txt crates/hoonc/bootstrap/hoonc.jam 2>/dev/null || true
        print_message "$GREEN" "å¤‡ä»½å®Œæˆ: $backup_file"
    else
        print_message "$RED" "é¡¹ç›®ç›®å½•ä¸å­˜åœ¨"
    fi
}

diagnose_issues() {
    print_message "$GREEN" ">>> æ•…éšœè¯Šæ–­"
    
    echo "=== åŸºç¡€æ£€æŸ¥ ==="
    check_command "gcc" && print_message "$GREEN" "âœ… gcc: $(which gcc)" || print_message "$RED" "âŒ gccæœªæ‰¾åˆ°"
    check_command "rustc" && print_message "$GREEN" "âœ… rustc: $(rustc --version)" || print_message "$RED" "âŒ rustcæœªæ‰¾åˆ°"
    check_command "hoonc" && print_message "$GREEN" "âœ… hoonc: $(which hoonc)" || print_message "$RED" "âŒ hooncæœªæ‰¾åˆ°"
    
    echo -e "\n=== æ–‡ä»¶æ£€æŸ¥ ==="
    [ -f "$NOCKCHAIN_DIR/Makefile" ] && print_message "$GREEN" "âœ… Makefileå­˜åœ¨" || print_message "$RED" "âŒ Makefileç¼ºå¤±"
    [ -f "$NOCKCHAIN_DIR/.env" ] && print_message "$GREEN" "âœ… é…ç½®æ–‡ä»¶å­˜åœ¨" || print_message "$RED" "âŒ é…ç½®æ–‡ä»¶ç¼ºå¤±"
    [ -f "$NOCKCHAIN_DIR/crates/hoonc/bootstrap/hoonc.jam" ] && print_message "$GREEN" "âœ… Bootstrapæ–‡ä»¶å­˜åœ¨" || print_message "$RED" "âŒ Bootstrapæ–‡ä»¶ç¼ºå¤±"
    
    echo -e "\n=== è¿›ç¨‹æ£€æŸ¥ ==="
    if pgrep -f "nockchain" >/dev/null; then
        print_message "$GREEN" "âœ… å‘ç°nockchainç›¸å…³è¿›ç¨‹:"
        pgrep -f "nockchain" | while read pid; do
            ps -p $pid -o pid,cmd --no-headers
        done
    else
        print_message "$RED" "âŒ æœªå‘ç°nockchainè¿›ç¨‹"
    fi
    
    echo -e "\n=== æ—¥å¿—æ£€æŸ¥ ==="
    if [ -f "$NOCKCHAIN_DIR/logs/mining.log" ]; then
        print_message "$CYAN" "æœ€è¿‘çš„æ—¥å¿—:"
        tail -10 "$NOCKCHAIN_DIR/logs/mining.log"
    else
        print_message "$YELLOW" "æ— æŒ–çŸ¿æ—¥å¿—"
    fi
}

cleanup_installation() {
    print_message "$GREEN" ">>> å¸è½½æ¸…ç†"
    
    read -p "ç¡®å®šè¦å¸è½½æ‰€æœ‰ç»„ä»¶å—ï¼Ÿ(y/N): " confirm
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        # åœæ­¢æ‰€æœ‰è¿›ç¨‹
        screen -S nockchain-mining -X quit 2>/dev/null || true
        pkill -f "nockchain\|monitor.sh" 2>/dev/null || true
        
        # åˆ é™¤æ–‡ä»¶
        rm -rf "$NOCKCHAIN_DIR" "$RUNTIME_DIR" "$MINICONDA_DIR/envs/nockchain-enhanced"
        rm -f "$HOME/nockchain_enhanced.sh"
        
        print_message "$GREEN" "å¸è½½å®Œæˆ"
    fi
}

# ä¸»å‡½æ•°
main() {
    if [ "$EUID" -eq 0 ]; then
        print_message "$RED" "è¯·ä¸è¦ä»¥rootç”¨æˆ·è¿è¡Œ"
        exit 1
    fi
    
    mkdir -p "$BACKUP_DIR" "$RUNTIME_DIR"
    touch "$LOG_FILE"
    
    while true; do
        show_menu
        read -p "è¯·é€‰æ‹©æ“ä½œ (1-10): " choice
        
        case $choice in
            1) install_enhanced_nockchain ;;
            2) start_enhanced_mining ;;
            3) view_logs ;;
            4) check_status ;;
            5) restart_mining ;;
            6) configure_pubkey ;;
            7) backup_wallet ;;
            8) diagnose_issues ;;
            9) cleanup_installation ;;
            10) print_message "$GREEN" "è°¢è°¢ä½¿ç”¨ï¼"; exit 0 ;;
            *) print_message "$RED" "æ— æ•ˆé€‰é¡¹" ;;
        esac
        
        echo
        read -p "æŒ‰å›è½¦é”®ç»§ç»­..." -r
    done
}

# å¯åŠ¨è„šæœ¬
main
