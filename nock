#!/bin/bash

# Nockchain èŠ‚ç‚¹ç®¡ç†è„šæœ¬ - ç²¾ç®€èœå•ç‰ˆ
# ç‰ˆæœ¬ï¼š5.0 ä¿ç•™æ ¸å¿ƒåŠŸèƒ½èœå•ç‰ˆ
# ä¿ç•™åŠŸèƒ½ï¼šå®‰è£…ã€æ›´æ”¹æŒ–çŸ¿å…¬é’¥ã€å¯åŠ¨èŠ‚ç‚¹ã€æ—¥å¿—æŸ¥çœ‹

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# é…ç½®å¸¸é‡
NOCKCHAIN_REPO="https://github.com/zorp-corp/nockchain.git"
ENV_FILE=".env"
ENV_EXAMPLE=".env_example"
LOG_FILE="nockchain.log"
BACKUP_DIR="backups"

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_debug() {
    echo -e "${CYAN}[DEBUG]${NC} $1"
}

log_success() {
    echo -e "${PURPLE}[SUCCESS]${NC} $1"
}

# æ£€æŸ¥é¡¹ç›®æ ¹ç›®å½•
check_project_root() {
    local current_dir=$(pwd)
    log_debug "å½“å‰ç›®å½•: $current_dir"
    
    if [ -f "Cargo.toml" ] || [ -f "Makefile" ]; then
        if [ -f "Cargo.toml" ] && grep -q "nockchain" "Cargo.toml" 2>/dev/null; then
            log_success "æ£€æµ‹åˆ° Nockchain é¡¹ç›®æ ¹ç›®å½•"
            return 0
        elif [ -f "Makefile" ] && grep -q "nockchain\|hoonc" "Makefile" 2>/dev/null; then
            log_success "æ£€æµ‹åˆ° Nockchain é¡¹ç›®æ ¹ç›®å½•"
            return 0
        fi
    fi
    
    return 1
}

# è‡ªåŠ¨æŸ¥æ‰¾ nockchain ç›®å½•
find_nockchain_directory() {
    log_info "æ­£åœ¨æŸ¥æ‰¾ nockchain é¡¹ç›®ç›®å½•..."
    
    local found_dirs=($(find . -maxdepth 3 -name "nockchain" -type d 2>/dev/null))
    
    if [ ${#found_dirs[@]} -gt 0 ]; then
        for dir in "${found_dirs[@]}"; do
            if [ -f "$dir/Cargo.toml" ] || [ -f "$dir/Makefile" ]; then
                log_success "æ‰¾åˆ° nockchain é¡¹ç›®ç›®å½•: $dir"
                cd "$dir"
                return 0
            fi
        done
    fi
    
    local parent_dirs=("../nockchain" "../../nockchain" "~/nockchain")
    for dir in "${parent_dirs[@]}"; do
        if [ -d "$dir" ] && ([ -f "$dir/Cargo.toml" ] || [ -f "$dir/Makefile" ]); then
            log_success "æ‰¾åˆ° nockchain é¡¹ç›®ç›®å½•: $dir"
            cd "$dir"
            return 0
        fi
    done
    
    return 1
}

# è‡ªåŠ¨åˆå§‹åŒ–é¡¹ç›®
auto_initialize_project() {
    log_warn "æœªæ‰¾åˆ° nockchain é¡¹ç›®ï¼Œå°†è‡ªåŠ¨åˆå§‹åŒ–..."
    
    read -p "æ˜¯å¦è‡ªåŠ¨å…‹éš† nockchain é¡¹ç›®ï¼Ÿ(y/n): " -n 1 -r
    echo
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        local target_dir="nockchain_$(date +%Y%m%d_%H%M%S)"
        
        log_info "æ­£åœ¨å…‹éš† nockchain é¡¹ç›®åˆ°: $target_dir"
        
        if git clone "$NOCKCHAIN_REPO" "$target_dir"; then
            cd "$target_dir"
            log_success "é¡¹ç›®å…‹éš†æˆåŠŸï¼Œå·²åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•"
            return 0
        else
            log_error "é¡¹ç›®å…‹éš†å¤±è´¥"
            return 1
        fi
    else
        log_error "è¯·æ‰‹åŠ¨è¿›å…¥ nockchain é¡¹ç›®æ ¹ç›®å½•åé‡æ–°è¿è¡Œè„šæœ¬"
        exit 1
    fi
}

# æ™ºèƒ½ç›®å½•æ£€æµ‹å’Œåˆå§‹åŒ–
smart_directory_setup() {
    log_info "å¼€å§‹æ™ºèƒ½ç›®å½•æ£€æµ‹..."
    
    if check_project_root; then
        return 0
    fi
    
    log_warn "å½“å‰ç›®å½•ä¸æ˜¯ nockchain é¡¹ç›®æ ¹ç›®å½•"
    
    if find_nockchain_directory; then
        if check_project_root; then
            return 0
        fi
    fi
    
    auto_initialize_project
}

# å®‰è£…ç³»ç»Ÿä¾èµ–
install_system_dependencies() {
    log_info "æ­£åœ¨å®‰è£…ç³»ç»Ÿä¾èµ–..."
    
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        sudo apt update
        
        local apt_packages=(
            "curl" "git" "build-essential" "make" "gcc" "clang"
            "pkg-config" "libssl-dev" "libclang-dev" "llvm-dev"
            "libleveldb-dev" "cmake" "autoconf" "automake"
            "libtool" "wget" "unzip" "jq"
        )
        
        sudo apt install -y "${apt_packages[@]}"
        log_success "ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"
    fi
    
    # å®‰è£… Rust
    if ! command -v rustc &> /dev/null || ! command -v cargo &> /dev/null; then
        log_info "å®‰è£… Rust..."
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source $HOME/.cargo/env
        log_success "Rust å®‰è£…å®Œæˆ"
    else
        log_info "Rust å·²å®‰è£…ï¼š$(rustc --version)"
    fi
}

# åˆå§‹åŒ–ç¯å¢ƒé…ç½®
initialize_environment() {
    log_info "åˆå§‹åŒ–ç¯å¢ƒé…ç½®..."
    
    if [ -f "$HOME/.cargo/env" ]; then
        source "$HOME/.cargo/env"
    fi
    export PATH="$HOME/.cargo/bin:$PATH"
    
    if [ ! -f "$ENV_FILE" ]; then
        if [ -f "$ENV_EXAMPLE" ]; then
            cp "$ENV_EXAMPLE" "$ENV_FILE"
            log_success "å·²ä» .env_example åˆ›å»º .env æ–‡ä»¶"
        else
            log_info "åˆ›å»ºé»˜è®¤ .env æ–‡ä»¶"
            cat > "$ENV_FILE" << 'EOF'
RUST_LOG=info,nockchain=info,nockchain_libp2p_io=info,libp2p=info,libp2p_quic=info
MINIMAL_LOG_FORMAT=true
MINING_PUBKEY=0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
EOF
        fi
    fi
    
    [ ! -d "$BACKUP_DIR" ] && mkdir -p "$BACKUP_DIR"
}

# éªŒè¯128ä½16è¿›åˆ¶æŒ–çŸ¿å…¬é’¥æ ¼å¼
validate_mining_pubkey() {
    local pubkey="$1"
    
    # æ£€æŸ¥æ˜¯å¦ä¸º128ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ï¼ˆ128ä½16è¿›åˆ¶ï¼‰
    if [[ ! "$pubkey" =~ ^[0-9a-fA-F]{128}$ ]]; then
        log_error "æ— æ•ˆçš„æŒ–çŸ¿å…¬é’¥æ ¼å¼"
        log_error "æŒ–çŸ¿å…¬é’¥å¿…é¡»æ˜¯128ä½16è¿›åˆ¶æ ¼å¼ï¼ˆ128ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ï¼‰"
        log_error "ç¤ºä¾‹æ ¼å¼: 1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
        return 1
    fi
    
    return 0
}

# åŠŸèƒ½1ï¼šå®Œæ•´å®‰è£… Nockchain
install_nockchain_complete() {
    log_info "å¼€å§‹å®Œæ•´å®‰è£… Nockchain..."
    
    # æ£€æŸ¥ç³»ç»Ÿèµ„æº
    local total_mem=$(free -g | awk '/^Mem:/{print $2}')
    log_info "ç³»ç»Ÿå†…å­˜: ${total_mem}GB"
    
    local disk_space=$(df -BG . | awk 'NR==2 {print $4}' | sed 's/G//')
    log_info "å¯ç”¨ç£ç›˜ç©ºé—´: ${disk_space}GB"
    
    local cpu_cores=$(nproc)
    log_info "CPUæ ¸å¿ƒæ•°: ${cpu_cores}æ ¸"
    
    # å®‰è£…ä¾èµ–
    install_system_dependencies
    initialize_environment
    
    # è®¾ç½®ç¯å¢ƒ
    source $HOME/.cargo/env 2>/dev/null || true
    export PATH="$HOME/.cargo/bin:$PATH"
    
    # å®‰è£… Hoon ç¼–è¯‘å™¨
    log_info "å®‰è£… Hoon ç¼–è¯‘å™¨..."
    if timeout 300 make install-hoonc; then
        log_success "Hoon ç¼–è¯‘å™¨å®‰è£…æˆåŠŸ"
    else
        log_error "Hoon ç¼–è¯‘å™¨å®‰è£…å¤±è´¥"
        return 1
    fi
    
    # æ„å»ºé¡¹ç›®
    log_info "æ„å»º Nockchain é¡¹ç›®ï¼ˆè¿™å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼‰..."
    if timeout 600 make build; then
        log_success "é¡¹ç›®æ„å»ºæˆåŠŸ"
    else
        log_error "é¡¹ç›®æ„å»ºå¤±è´¥"
        return 1
    fi
    
    # å®‰è£…ç»„ä»¶
    log_info "å®‰è£… Nockchain ç»„ä»¶..."
    
    if make install-nockchain-wallet; then
        log_success "Nockchain é’±åŒ…å®‰è£…æˆåŠŸ"
    else
        log_error "Nockchain é’±åŒ…å®‰è£…å¤±è´¥"
        return 1
    fi
    
    if make install-nockchain; then
        log_success "Nockchain èŠ‚ç‚¹å®‰è£…æˆåŠŸ"
    else
        log_error "Nockchain èŠ‚ç‚¹å®‰è£…å¤±è´¥"
        return 1
    fi
    
    # æ›´æ–° PATH
    if ! grep -q 'export PATH="$HOME/.cargo/bin:$PATH"' ~/.bashrc; then
        echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> ~/.bashrc
        log_success "å·²æ·»åŠ  Cargo bin ç›®å½•åˆ° PATH"
    fi
    
    # ç”Ÿæˆé»˜è®¤çš„128ä½æŒ–çŸ¿å…¬é’¥
    log_info "ç”Ÿæˆ128ä½16è¿›åˆ¶æŒ–çŸ¿å…¬é’¥..."
    local hex_pubkey
    if command -v openssl &> /dev/null; then
        hex_pubkey=$(openssl rand -hex 64)
    else
        hex_pubkey=$(xxd -l 64 -p /dev/urandom | tr -d '\n')
    fi
    
    # æ›´æ–°é…ç½®æ–‡ä»¶
    if [ -f "$ENV_FILE" ]; then
        cp "$ENV_FILE" "${ENV_FILE}.backup.$(date +%Y%m%d_%H%M%S)"
        sed -i "s/^MINING_PUBKEY=.*/MINING_PUBKEY=$hex_pubkey/" "$ENV_FILE"
        log_success "å·²ç”Ÿæˆå¹¶è®¾ç½®128ä½æŒ–çŸ¿å…¬é’¥: $hex_pubkey"
    fi
    
    log_success "Nockchain å®Œæ•´å®‰è£…æˆåŠŸï¼"
}

# åŠŸèƒ½2ï¼šæ›´æ”¹æŒ–çŸ¿å…¬é’¥ï¼ˆ128ä½16è¿›åˆ¶æ ¼å¼ï¼‰
change_mining_pubkey() {
    log_info "æ›´æ”¹æŒ–çŸ¿å…¬é’¥ï¼ˆ128ä½16è¿›åˆ¶æ ¼å¼ï¼‰"
    echo
    log_info "è¯·è¾“å…¥128ä½16è¿›åˆ¶æ ¼å¼çš„æŒ–çŸ¿å…¬é’¥ï¼ˆ128ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ï¼‰"
    log_debug "æ ¼å¼ç¤ºä¾‹: 1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
    echo
    
    while true; do
        read -p "æŒ–çŸ¿å…¬é’¥ (128ä½16è¿›åˆ¶): " new_pubkey
        
        if [ -z "$new_pubkey" ]; then
            log_error "å…¬é’¥ä¸èƒ½ä¸ºç©º"
            continue
        fi
        
        # éªŒè¯128ä½16è¿›åˆ¶æ ¼å¼
        if validate_mining_pubkey "$new_pubkey"; then
            if [ -f "$ENV_FILE" ]; then
                # åˆ›å»ºå¤‡ä»½
                cp "$ENV_FILE" "$BACKUP_DIR/.env.backup.$(date +%Y%m%d_%H%M%S)"
                
                # æ›´æ–°å…¬é’¥
                if grep -q "MINING_PUBKEY=" "$ENV_FILE"; then
                    sed -i "s/^MINING_PUBKEY=.*/MINING_PUBKEY=$new_pubkey/" "$ENV_FILE"
                else
                    echo "MINING_PUBKEY=$new_pubkey" >> "$ENV_FILE"
                fi
                
                log_success "æŒ–çŸ¿å…¬é’¥å·²æ›´æ–°"
                log_info "æ–°å…¬é’¥: $new_pubkey"
                log_info "é…ç½®å·²å¤‡ä»½åˆ° $BACKUP_DIR/"
                break
            else
                log_error ".env æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œå®‰è£…é€‰é¡¹"
                break
            fi
        else
            log_error "è¯·è¾“å…¥æ­£ç¡®æ ¼å¼çš„128ä½16è¿›åˆ¶å…¬é’¥ï¼ˆ128ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ï¼‰"
        fi
    done
}

# åŠŸèƒ½3ï¼šå¯åŠ¨èŠ‚ç‚¹
start_node() {
    log_info "å¯åŠ¨ Nockchain æŒ–çŸ¿èŠ‚ç‚¹"
    
    # æ£€æŸ¥å¿…è¦æ¡ä»¶
    if ! command -v nockchain &> /dev/null; then
        log_error "nockchain æœªå®‰è£…ï¼Œè¯·å…ˆè¿è¡Œå®‰è£…é€‰é¡¹"
        return 1
    fi
    
    if [ ! -f "$ENV_FILE" ]; then
        log_error ".env æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œå®‰è£…é€‰é¡¹"
        return 1
    fi
    
    # åŠ è½½ç¯å¢ƒå˜é‡
    source "$ENV_FILE"
    export RUST_LOG MINIMAL_LOG_FORMAT MINING_PUBKEY
    
    # éªŒè¯æŒ–çŸ¿å…¬é’¥æ ¼å¼
    if ! validate_mining_pubkey "$MINING_PUBKEY" 2>/dev/null; then
        log_error "å½“å‰é…ç½®çš„æŒ–çŸ¿å…¬é’¥æ ¼å¼ä¸æ­£ç¡®"
        log_error "è¯·å…ˆä½¿ç”¨ 'æ›´æ”¹æŒ–çŸ¿å…¬é’¥' é€‰é¡¹è®¾ç½®æ­£ç¡®çš„128ä½16è¿›åˆ¶å…¬é’¥"
        return 1
    fi
    
    # æ£€æŸ¥ç°æœ‰è¿›ç¨‹
    if pgrep -f "nockchain" > /dev/null; then
        local existing_pids=$(pgrep -f nockchain | tr '\n' ' ')
        log_warn "æ£€æµ‹åˆ°è¿è¡Œä¸­çš„ Nockchain è¿›ç¨‹: $existing_pids"
        
        read -p "æ˜¯å¦åœæ­¢ç°æœ‰è¿›ç¨‹å¹¶é‡æ–°å¯åŠ¨ï¼Ÿ(y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            log_info "åœæ­¢ç°æœ‰è¿›ç¨‹..."
            pkill -TERM -f nockchain 2>/dev/null || true
            sleep 3
            if pgrep -f nockchain > /dev/null; then
                pkill -KILL -f nockchain 2>/dev/null || true
                sleep 2
            fi
            log_info "ç°æœ‰è¿›ç¨‹å·²åœæ­¢"
        else
            log_info "ä¿æŒç°æœ‰è¿›ç¨‹è¿è¡Œ"
            return 0
        fi
    fi
    
    log_info "é…ç½®ä¿¡æ¯ï¼š"
    log_info "- æŒ–çŸ¿å…¬é’¥: $MINING_PUBKEY"
    log_info "- æ—¥å¿—çº§åˆ«: $RUST_LOG"
    log_info "- æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
    
    # å¯åŠ¨èŠ‚ç‚¹
    log_info "æ­£åœ¨å¯åŠ¨æŒ–çŸ¿èŠ‚ç‚¹..."
    
    nohup nockchain --mining-pubkey "${MINING_PUBKEY}" --mine > "$LOG_FILE" 2>&1 &
    local node_pid=$!
    
    # ç­‰å¾…å¯åŠ¨
    sleep 5
    
    # éªŒè¯å¯åŠ¨çŠ¶æ€
    if kill -0 $node_pid 2>/dev/null; then
        log_success "èŠ‚ç‚¹å¯åŠ¨æˆåŠŸï¼"
        log_success "è¿›ç¨‹ID: $node_pid"
        log_info "æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
        
        # æ˜¾ç¤ºåˆå§‹æ—¥å¿—
        if [ -f "$LOG_FILE" ]; then
            log_info "æœ€è¿‘å‡ è¡Œæ—¥å¿—ï¼š"
            tail -n 5 "$LOG_FILE" 2>/dev/null || true
        fi
        
        log_info "ä½¿ç”¨ 'æŸ¥çœ‹æ—¥å¿—' é€‰é¡¹ç›‘æ§èŠ‚ç‚¹çŠ¶æ€"
    else
        log_error "èŠ‚ç‚¹å¯åŠ¨å¤±è´¥"
        if [ -f "$LOG_FILE" ]; then
            log_error "é”™è¯¯æ—¥å¿—ï¼š"
            tail -n 10 "$LOG_FILE"
        fi
        return 1
    fi
}

# åŠŸèƒ½4ï¼šæŸ¥çœ‹æ—¥å¿—
view_logs() {
    log_info "æŸ¥çœ‹ Nockchain èŠ‚ç‚¹æ—¥å¿—"
    
    if [ ! -f "$LOG_FILE" ]; then
        log_warn "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨: $LOG_FILE"
        
        # æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
        if pgrep -f "nockchain" > /dev/null; then
            log_info "èŠ‚ç‚¹æ­£åœ¨è¿è¡Œï¼Œä½†æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
            log_info "å»ºè®®é‡å¯èŠ‚ç‚¹ä»¥ç”Ÿæˆæ—¥å¿—æ–‡ä»¶"
        else
            log_info "èŠ‚ç‚¹æœªè¿è¡Œ"
        fi
        return 1
    fi
    
    echo
    log_info "=== æ—¥å¿—æ–‡ä»¶ä¿¡æ¯ ==="
    echo "æ–‡ä»¶ä½ç½®: $(realpath $LOG_FILE)"
    echo "æ–‡ä»¶å¤§å°: $(du -h "$LOG_FILE" | cut -f1)"
    echo "æœ€åä¿®æ”¹: $(stat -c %y "$LOG_FILE" 2>/dev/null || date -r "$LOG_FILE" 2>/dev/null)"
    
    echo
    log_info "=== æœ€è¿‘50è¡Œæ—¥å¿— ==="
    echo
    tail -n 50 "$LOG_FILE"
    
    echo
    log_info "=== å®æ—¶æ—¥å¿—ç›‘æ§ ==="
    log_info "æŒ‰ Ctrl+C é€€å‡ºç›‘æ§"
    echo
    
    # å®æ—¶ç›‘æ§æ—¥å¿—
    tail -f "$LOG_FILE"
}

# ä¸»èœå•æ˜¾ç¤º
show_main_menu() {
    clear
    echo -e "${PURPLE}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                 Nockchain èŠ‚ç‚¹ç®¡ç†å·¥å…·                        â•‘"
    echo "â•‘               ï¼ˆæ ¸å¿ƒåŠŸèƒ½èœå•ç‰ˆ v5.0ï¼‰                         â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    
    echo
    echo -e "${GREEN}ğŸ”§ æ ¸å¿ƒåŠŸèƒ½èœå•${NC}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo "  1. å®‰è£… Nockchainï¼ˆå®Œæ•´å®‰è£…æµç¨‹ï¼‰"
    echo "  2. æ›´æ”¹æŒ–çŸ¿å…¬é’¥ï¼ˆ128ä½16è¿›åˆ¶æ ¼å¼ï¼‰"
    echo "  3. å¯åŠ¨æŒ–çŸ¿èŠ‚ç‚¹"
    echo "  4. æŸ¥çœ‹èŠ‚ç‚¹æ—¥å¿—"
    echo
    echo "  0. é€€å‡º"
    echo
    echo -e "${YELLOW}ğŸ“‹ é‡è¦è¯´æ˜ï¼š${NC}"
    echo -e "${YELLOW}â€¢ æŒ–çŸ¿å…¬é’¥å¿…é¡»æ˜¯128ä½16è¿›åˆ¶æ ¼å¼ï¼ˆ128ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ï¼‰${NC}"
    echo -e "${YELLOW}â€¢ é¦–æ¬¡ä½¿ç”¨è¯·å…ˆé€‰æ‹© '1. å®‰è£… Nockchain'${NC}"
    echo -e "${YELLOW}â€¢ å¯åŠ¨èŠ‚ç‚¹å‰è¯·ç¡®ä¿å·²æ­£ç¡®è®¾ç½®æŒ–çŸ¿å…¬é’¥${NC}"
    echo
    
    # æ˜¾ç¤ºå½“å‰çŠ¶æ€
    if [ -f "$ENV_FILE" ]; then
        local current_pubkey=$(grep "MINING_PUBKEY=" "$ENV_FILE" 2>/dev/null | cut -d'=' -f2)
        if [ -n "$current_pubkey" ] && [ "$current_pubkey" != "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000" ]; then
            echo -e "${CYAN}ğŸ“ å½“å‰æŒ–çŸ¿å…¬é’¥: ${current_pubkey:0:20}...${current_pubkey: -20}${NC}"
        else
            echo -e "${CYAN}ğŸ“ å½“å‰æŒ–çŸ¿å…¬é’¥: æœªè®¾ç½®æˆ–ä½¿ç”¨é»˜è®¤å€¼${NC}"
        fi
    fi
    
    if pgrep -f "nockchain" > /dev/null; then
        echo -e "${CYAN}ğŸ“ èŠ‚ç‚¹çŠ¶æ€: âœ… è¿è¡Œä¸­ (PID: $(pgrep -f nockchain | tr '\n' ' '))${NC}"
    else
        echo -e "${CYAN}ğŸ“ èŠ‚ç‚¹çŠ¶æ€: âŒ æœªè¿è¡Œ${NC}"
    fi
    echo
}

# ä¸»ç¨‹åº
main() {
    # å¯åŠ¨æ—¶è¿›è¡Œæ™ºèƒ½ç›®å½•æ£€æµ‹
    log_info "Nockchain èŠ‚ç‚¹ç®¡ç†å·¥å…·å¯åŠ¨ä¸­..."
    
    if ! smart_directory_setup; then
        log_error "æ— æ³•åˆå§‹åŒ–é¡¹ç›®ç¯å¢ƒ"
        exit 1
    fi
    
    # ä¸»å¾ªç¯
    while true; do
        show_main_menu
        read -p "è¯·é€‰æ‹©æ“ä½œ (0-4): " choice
        
        case $choice in
            1)
                install_nockchain_complete
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            2)
                change_mining_pubkey
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            3)
                start_node
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            4)
                view_logs
                ;;
            0)
                log_info "æ„Ÿè°¢ä½¿ç”¨ Nockchain èŠ‚ç‚¹ç®¡ç†å·¥å…·ï¼"
                log_info "ç¥æ‚¨æŒ–çŸ¿æ„‰å¿« ğŸš€"
                exit 0
                ;;
            *)
                log_error "æ— æ•ˆé€‰æ‹©ï¼Œè¯·è¾“å…¥ 0-4 ä¹‹é—´çš„æ•°å­—"
                sleep 2
                ;;
        esac
    done
}

# è„šæœ¬å…¥å£
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    # è®¾ç½®é”™è¯¯å¤„ç†
    set -eE
    trap 'log_error "è„šæœ¬åœ¨ç¬¬ $LINENO è¡Œå‡ºé”™"' ERR
    
    # å¯åŠ¨ä¸»ç¨‹åº
    main "$@"
fi
