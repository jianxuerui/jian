#!/bin/bash
# -*- coding: UTF-8 -*-
# Nockchainä¸­æ–‡ä¼˜åŒ–æŒ–çŸ¿è„šæœ¬ v3.1 - ä¿®å¤makeå‘½ä»¤é—®é¢˜ç‰ˆ

# é¢œè‰²å®šä¹‰
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
CYAN='\033[1;36m'
MAGENTA='\033[1;35m'
RESET='\033[0m'

# è„šæœ¬é…ç½®
NOCKCHAIN_DIR="$HOME/nockchain"
LOG_FILE="$HOME/nockchain_install.log"
BACKUP_DIR="$HOME/nockchain_backup"

# æ˜¾ç¤ºå¸¦é¢œè‰²çš„æ¶ˆæ¯
print_message() {
    local color=$1
    local message=$2
    echo -e "${color}${message}${RESET}"
}

# è®°å½•æ—¥å¿—
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

# æ£€æŸ¥å‘½ä»¤æ˜¯å¦å­˜åœ¨
check_command() {
    if command -v "$1" >/dev/null 2>&1; then
        return 0
    else
        return 1
    fi
}

# æ£€æµ‹Linuxå‘è¡Œç‰ˆ
detect_distro() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        DISTRO=$ID
        VERSION=$VERSION_ID
    elif [ -f /etc/redhat-release ]; then
        DISTRO="centos"
    elif [ -f /etc/debian_version ]; then
        DISTRO="debian"
    else
        DISTRO="unknown"
    fi
    echo "$DISTRO"
}

# æ˜¾ç¤ºä¸»èœå•
show_menu() {
    clear
    echo -e "${BLUE}
=======================================
 Nockchain ä¸­æ–‡ä¼˜åŒ–æŒ–çŸ¿è„šæœ¬ v3.1
=======================================
${RESET}"
    echo -e "${YELLOW}1. å®‰è£…NockchainèŠ‚ç‚¹ï¼ˆè‡ªåŠ¨è§£å†³ä¾èµ–é—®é¢˜ï¼‰"
    echo "2. é…ç½®æŒ–çŸ¿å…¬é’¥"
    echo "3. å¯åŠ¨ä¼˜åŒ–æŒ–çŸ¿"
    echo "4. æŸ¥çœ‹å®æ—¶æ—¥å¿—"
    echo "5. æ£€æŸ¥é’±åŒ…ä½™é¢"
    echo "6. ç³»ç»ŸçŠ¶æ€ç›‘æ§"
    echo "7. å¤‡ä»½é’±åŒ…å¯†é’¥"
    echo "8. ä¿®å¤ç³»ç»Ÿä¾èµ–"
    echo "9. é€€å‡ºè„šæœ¬"
    echo -e "${BLUE}=======================================${RESET}"
}

# éªŒè¯å…¬é’¥æ ¼å¼
validate_pubkey() {
    local pubkey=$1
    # æ£€æŸ¥128ä½åå…­è¿›åˆ¶æ ¼å¼
    if [[ $pubkey =~ ^[0-9a-fA-F]{128}$ ]]; then
        return 0
    # æ£€æŸ¥Base58æ ¼å¼ï¼ˆå¤§çº¦44ä¸ªå­—ç¬¦ï¼‰
    elif [[ $pubkey =~ ^[1-9A-HJ-NP-Za-km-z]{40,50}$ ]]; then
        return 0
    else
        print_message "$RED" "é”™è¯¯ï¼šå…¬é’¥æ ¼å¼æ— æ•ˆ"
        print_message "$YELLOW" "æ”¯æŒçš„æ ¼å¼ï¼š"
        print_message "$YELLOW" "- 128ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸²"
        print_message "$YELLOW" "- Base58ç¼–ç æ ¼å¼ï¼ˆçº¦44ä¸ªå­—ç¬¦ï¼‰"
        return 1
    fi
}

# æ£€æŸ¥å¹¶å®‰è£…ç³»ç»Ÿä¾èµ–
install_system_dependencies() {
    print_message "$CYAN" "æ­£åœ¨æ£€æŸ¥å¹¶å®‰è£…ç³»ç»Ÿä¾èµ–..."
    
    local distro=$(detect_distro)
    print_message "$YELLOW" "æ£€æµ‹åˆ°ç³»ç»Ÿç±»å‹: $distro"
    
    case $distro in
        "ubuntu"|"debian"|"mint"|"pop")
            print_message "$CYAN" "æ­£åœ¨ä¸ºUbuntu/Debianç³»ç»Ÿå®‰è£…å¼€å‘å·¥å…·..."
            
            # æ£€æŸ¥æ˜¯å¦æœ‰sudoæƒé™
            if ! sudo -n true 2>/dev/null; then
                print_message "$RED" "é”™è¯¯ï¼šéœ€è¦sudoæƒé™æ¥å®‰è£…ç³»ç»Ÿä¾èµ–"
                print_message "$YELLOW" "è¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤æ‰‹åŠ¨å®‰è£…ï¼š"
                print_message "$YELLOW" "sudo apt update && sudo apt install -y build-essential curl git clang llvm-dev libclang-dev pkg-config libssl-dev wget screen htop"
                return 1
            fi
            
            # æ›´æ–°åŒ…ç´¢å¼•
            if ! sudo apt update; then
                print_message "$RED" "åŒ…ç´¢å¼•æ›´æ–°å¤±è´¥"
                return 1
            fi
            
            # å®‰è£…build-essentialå’Œå…¶ä»–å¿…è¦å·¥å…·
            local packages="build-essential curl git clang llvm-dev libclang-dev pkg-config libssl-dev wget screen htop"
            
            if ! sudo apt install -y $packages; then
                print_message "$RED" "ç³»ç»Ÿä¾èµ–å®‰è£…å¤±è´¥"
                return 1
            fi
            ;;
            
        "centos"|"rhel"|"rocky"|"almalinux")
            print_message "$CYAN" "æ­£åœ¨ä¸ºCentOS/RHELç³»ç»Ÿå®‰è£…å¼€å‘å·¥å…·..."
            
            if ! sudo -n true 2>/dev/null; then
                print_message "$RED" "é”™è¯¯ï¼šéœ€è¦sudoæƒé™æ¥å®‰è£…ç³»ç»Ÿä¾èµ–"
                print_message "$YELLOW" "è¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤æ‰‹åŠ¨å®‰è£…ï¼š"
                print_message "$YELLOW" "sudo dnf groupinstall -y \"Development Tools\" && sudo dnf install -y curl git clang llvm-devel wget screen htop"
                return 1
            fi
            
            # æ£€æŸ¥åŒ…ç®¡ç†å™¨
            if check_command "dnf"; then
                PKG_MGR="dnf"
            elif check_command "yum"; then
                PKG_MGR="yum"
            else
                print_message "$RED" "æœªæ‰¾åˆ°åŒ…ç®¡ç†å™¨ (dnf/yum)"
                return 1
            fi
            
            # å®‰è£…å¼€å‘å·¥å…·ç»„
            if ! sudo $PKG_MGR groupinstall -y "Development Tools"; then
                print_message "$YELLOW" "Development Toolsç»„å®‰è£…å¤±è´¥ï¼Œå°è¯•å•ç‹¬å®‰è£…..."
                if ! sudo $PKG_MGR install -y gcc gcc-c++ make; then
                    print_message "$RED" "æ ¸å¿ƒç¼–è¯‘å·¥å…·å®‰è£…å¤±è´¥"
                    return 1
                fi
            fi
            
            # å®‰è£…å…¶ä»–å¿…è¦å·¥å…·
            sudo $PKG_MGR install -y curl git clang llvm-devel wget screen htop
            ;;
            
        "fedora")
            print_message "$CYAN" "æ­£åœ¨ä¸ºFedoraç³»ç»Ÿå®‰è£…å¼€å‘å·¥å…·..."
            
            if ! sudo -n true 2>/dev/null; then
                print_message "$RED" "é”™è¯¯ï¼šéœ€è¦sudoæƒé™æ¥å®‰è£…ç³»ç»Ÿä¾èµ–"
                print_message "$YELLOW" "è¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤æ‰‹åŠ¨å®‰è£…ï¼š"
                print_message "$YELLOW" "sudo dnf groupinstall -y \"Development Tools\" && sudo dnf install -y curl git clang llvm-devel wget screen htop"
                return 1
            fi
            
            # æ›´æ–°ç³»ç»Ÿ
            sudo dnf update -y
            
            # å®‰è£…å¼€å‘å·¥å…·ç»„
            if ! sudo dnf groupinstall -y "Development Tools"; then
                print_message "$YELLOW" "Development Toolsç»„å®‰è£…å¤±è´¥ï¼Œå°è¯•å•ç‹¬å®‰è£…..."
                if ! sudo dnf install -y gcc gcc-c++ make; then
                    print_message "$RED" "æ ¸å¿ƒç¼–è¯‘å·¥å…·å®‰è£…å¤±è´¥"
                    return 1
                fi
            fi
            
            # å®‰è£…å…¶ä»–å¿…è¦å·¥å…·
            sudo dnf install -y curl git clang llvm-devel wget screen htop
            ;;
            
        *)
            print_message "$RED" "ä¸æ”¯æŒçš„ç³»ç»Ÿç±»å‹: $distro"
            print_message "$YELLOW" "è¯·æ‰‹åŠ¨å®‰è£…ä»¥ä¸‹å·¥å…·: gcc, g++, make, clang, curl, git"
            return 1
            ;;
    esac
    
    # éªŒè¯å…³é”®å‘½ä»¤æ˜¯å¦å®‰è£…æˆåŠŸ
    local missing_commands=()
    for cmd in gcc g++ make clang curl git; do
        if ! check_command "$cmd"; then
            missing_commands+=("$cmd")
        fi
    done
    
    if [ ${#missing_commands[@]} -gt 0 ]; then
        print_message "$RED" "ä»¥ä¸‹å‘½ä»¤ä»ç„¶ç¼ºå¤±: ${missing_commands[*]}"
        return 1
    fi
    
    print_message "$GREEN" "ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"
    log_message "ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"
    return 0
}

# å®‰è£…Rustå·¥å…·é“¾
install_rust() {
    print_message "$CYAN" "æ­£åœ¨æ£€æŸ¥Rustå®‰è£…çŠ¶æ€..."
    
    if check_command "rustc" && check_command "cargo"; then
        local rust_version=$(rustc --version 2>/dev/null)
        print_message "$YELLOW" "Rustå·²å®‰è£…: $rust_version"
        export PATH="$HOME/.cargo/bin:$PATH"
        return 0
    else
        print_message "$CYAN" "æ­£åœ¨å®‰è£…Rustå·¥å…·é“¾..."
        
        # ä¸‹è½½å¹¶å®‰è£…rustup
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        
        if [ $? -ne 0 ]; then
            print_message "$RED" "Rustå®‰è£…å¤±è´¥"
            return 1
        fi
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        source "$HOME/.cargo/env"
        export PATH="$HOME/.cargo/bin:$PATH"
        
        print_message "$GREEN" "Rustå®‰è£…å®Œæˆ"
        log_message "Rustå·¥å…·é“¾å®‰è£…å®Œæˆ"
    fi
}

# ä¸»å®‰è£…å‡½æ•°
install_nockchain() {
    print_message "$GREEN" ">>> å¼€å§‹å®‰è£…NockchainèŠ‚ç‚¹ï¼ˆåŒ…å«ä¾èµ–ä¿®å¤ï¼‰..."
    log_message "å¼€å§‹Nockchainå®Œæ•´å®‰è£…"
    
    # æ£€æŸ¥ç³»ç»Ÿè¦æ±‚
    print_message "$CYAN" "æ£€æŸ¥ç³»ç»Ÿé…ç½®..."
    local total_ram=$(free -m 2>/dev/null | awk '/^Mem:/{print $2}' || echo "0")
    local cpu_cores=$(nproc 2>/dev/null || echo "1")
    local available_space=$(df -m ~ 2>/dev/null | awk 'NR==2{print $4}' || echo "0")
    
    print_message "$YELLOW" "ç³»ç»Ÿé…ç½®æ£€æŸ¥ï¼š"
    print_message "$YELLOW" "- å†…å­˜: ${total_ram}MB"
    print_message "$YELLOW" "- CPUæ ¸å¿ƒ: ${cpu_cores}"
    print_message "$YELLOW" "- å¯ç”¨ç©ºé—´: ${available_space}MB"
    
    if [ "$total_ram" -lt 4096 ] && [ "$total_ram" -gt 0 ]; then
        print_message "$YELLOW" "è­¦å‘Šï¼šæ¨èå†…å­˜è‡³å°‘4GBï¼Œå½“å‰ä»…${total_ram}MB"
        read -p "æ˜¯å¦ç»§ç»­å®‰è£…ï¼Ÿ(y/N): " continue_install
        if [[ ! "$continue_install" =~ ^[Yy]$ ]]; then
            return 1
        fi
    fi
    
    # æ­¥éª¤1ï¼šå®‰è£…ç³»ç»Ÿä¾èµ–
    print_message "$MAGENTA" "æ­¥éª¤ 1/5: å®‰è£…ç³»ç»Ÿä¾èµ–..."
    if ! install_system_dependencies; then
        print_message "$RED" "ç³»ç»Ÿä¾èµ–å®‰è£…å¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯"
        return 1
    fi
    
    # æ­¥éª¤2ï¼šå®‰è£…Rust
    print_message "$MAGENTA" "æ­¥éª¤ 2/5: å®‰è£…Rustå·¥å…·é“¾..."
    if ! install_rust; then
        print_message "$RED" "Rustå®‰è£…å¤±è´¥"
        return 1
    fi
    
    # æ­¥éª¤3ï¼šå…‹éš†ä»“åº“
    print_message "$MAGENTA" "æ­¥éª¤ 3/5: å…‹éš†Nockchainä»“åº“..."
    if [ -d "$NOCKCHAIN_DIR" ]; then
        print_message "$YELLOW" "å‘ç°ç°æœ‰å®‰è£…ç›®å½•ï¼Œæ­£åœ¨æ›´æ–°..."
        cd "$NOCKCHAIN_DIR"
        if ! git pull origin main; then
            print_message "$YELLOW" "Gitæ›´æ–°å¤±è´¥ï¼Œå°è¯•é‡æ–°å…‹éš†..."
            cd "$HOME"
            rm -rf "$NOCKCHAIN_DIR"
            if ! git clone https://github.com/zorp-corp/nockchain.git "$NOCKCHAIN_DIR"; then
                print_message "$RED" "ä»“åº“å…‹éš†å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"
                return 1
            fi
        fi
    else
        if ! git clone https://github.com/zorp-corp/nockchain.git "$NOCKCHAIN_DIR"; then
            print_message "$RED" "ä»“åº“å…‹éš†å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"
            return 1
        fi
    fi
    
    cd "$NOCKCHAIN_DIR"
    
    # æ­¥éª¤4ï¼šé…ç½®ç¯å¢ƒ
    print_message "$MAGENTA" "æ­¥éª¤ 4/5: é…ç½®ç¼–è¯‘ç¯å¢ƒ..."
    
    # å¤åˆ¶ç¯å¢ƒé…ç½®æ–‡ä»¶
    if [ -f ".env_example" ]; then
        cp .env_example .env
    elif [ ! -f ".env" ]; then
        print_message "$YELLOW" "åˆ›å»ºé»˜è®¤.envé…ç½®æ–‡ä»¶..."
        cat > .env << 'EOF'
MINING_PUBKEY=0000000000000000000000000000000000000000000000000000000000000000
NETWORK=mainnet
MAX_PEERS=4000
LOG_LEVEL=info
RUST_LOG=info
RUST_MIN_STACK=8388608
EOF
    fi
    
    # è®¾ç½®ç¼–è¯‘ç¯å¢ƒå˜é‡
    export RUST_MIN_STACK=8388608
    export RUST_LOG=info
    export PATH="$HOME/.cargo/bin:$PATH"
    export CC=clang
    export CXX=clang++
    
    # éªŒè¯makeå‘½ä»¤
    if ! check_command "make"; then
        print_message "$RED" "makeå‘½ä»¤ä»ç„¶ä¸å¯ç”¨ï¼Œä¾èµ–å®‰è£…å¯èƒ½å¤±è´¥"
        return 1
    fi
    
    print_message "$GREEN" "makeå‘½ä»¤éªŒè¯é€šè¿‡: $(make --version | head -1)"
    
    # æ­¥éª¤5ï¼šç¼–è¯‘é¡¹ç›®
    print_message "$MAGENTA" "æ­¥éª¤ 5/5: ç¼–è¯‘Nockchainé¡¹ç›®..."
    print_message "$YELLOW" "æ³¨æ„ï¼šç¼–è¯‘è¿‡ç¨‹å¯èƒ½éœ€è¦15-30åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…..."
    
    # åˆ›å»ºç¼–è¯‘æ—¥å¿—æ–‡ä»¶
    local build_log="$NOCKCHAIN_DIR/build.log"
    
    # å®‰è£…hooncç¼–è¯‘å™¨
    print_message "$CYAN" "æ­£åœ¨å®‰è£…hooncç¼–è¯‘å™¨..."
    if ! make install-hoonc 2>&1 | tee -a "$build_log"; then
        print_message "$RED" "hooncç¼–è¯‘å™¨å®‰è£…å¤±è´¥"
        print_message "$YELLOW" "è¯¦ç»†é”™è¯¯ä¿¡æ¯è¯·æŸ¥çœ‹: $build_log"
        return 1
    fi
    
    # æ„å»ºä¸»é¡¹ç›®
    print_message "$CYAN" "æ­£åœ¨æ„å»ºNockchainä¸»é¡¹ç›®..."
    if ! make build 2>&1 | tee -a "$build_log"; then
        print_message "$RED" "é¡¹ç›®æ„å»ºå¤±è´¥"
        print_message "$YELLOW" "è¯¦ç»†é”™è¯¯ä¿¡æ¯è¯·æŸ¥çœ‹: $build_log"
        return 1
    fi
    
    # å®‰è£…é’±åŒ…
    print_message "$CYAN" "æ­£åœ¨å®‰è£…Nockchainé’±åŒ…..."
    if ! make install-nockchain-wallet 2>&1 | tee -a "$build_log"; then
        print_message "$RED" "é’±åŒ…å®‰è£…å¤±è´¥"
        print_message "$YELLOW" "è¯¦ç»†é”™è¯¯ä¿¡æ¯è¯·æŸ¥çœ‹: $build_log"
        return 1
    fi
    
    # å®‰è£…ä¸»ç¨‹åº
    print_message "$CYAN" "æ­£åœ¨å®‰è£…Nockchainä¸»ç¨‹åº..."
    if ! make install-nockchain 2>&1 | tee -a "$build_log"; then
        print_message "$RED" "ä¸»ç¨‹åºå®‰è£…å¤±è´¥"
        print_message "$YELLOW" "è¯¦ç»†é”™è¯¯ä¿¡æ¯è¯·æŸ¥çœ‹: $build_log"
        return 1
    fi
    
    # ç”Ÿæˆé’±åŒ…
    print_message "$CYAN" "æ­£åœ¨ç”Ÿæˆé’±åŒ…å¯†é’¥..."
    export PATH="$HOME/.cargo/bin:$PATH"
    
    if check_command "nockchain-wallet"; then
        # ç”Ÿæˆé’±åŒ…å¹¶æ•è·è¾“å‡º
        local wallet_output
        wallet_output=$(nockchain-wallet keygen 2>&1)
        
        if [ $? -eq 0 ]; then
            print_message "$GREEN" "é’±åŒ…ç”ŸæˆæˆåŠŸï¼"
            print_message "$YELLOW" "é’±åŒ…ä¿¡æ¯ï¼š"
            echo "$wallet_output"
            
            # æå–å…¬é’¥å¹¶æ›´æ–°.envæ–‡ä»¶
            local pubkey=$(echo "$wallet_output" | grep -E "Public key:|å…¬é’¥:" | awk '{print $NF}' | head -1)
            if [ -n "$pubkey" ] && [ "$pubkey" != "0000000000000000000000000000000000000000000000000000000000000000" ]; then
                sed -i "s/MINING_PUBKEY=.*/MINING_PUBKEY=$pubkey/" .env
                print_message "$GREEN" "å…¬é’¥å·²è‡ªåŠ¨é…ç½®: $pubkey"
            fi
            
            # å¤‡ä»½é’±åŒ…ä¿¡æ¯
            mkdir -p "$BACKUP_DIR"
            echo "$wallet_output" > "$BACKUP_DIR/wallet_$(date +%Y%m%d_%H%M%S).txt"
            print_message "$GREEN" "é’±åŒ…ä¿¡æ¯å·²å¤‡ä»½åˆ°: $BACKUP_DIR/"
        else
            print_message "$YELLOW" "é’±åŒ…ç”Ÿæˆå¯èƒ½å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ç”Ÿæˆ"
            echo "$wallet_output"
        fi
    else
        print_message "$YELLOW" "nockchain-walletå‘½ä»¤ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥å®‰è£…"
    fi
    
    print_message "$GREEN" "ğŸ‰ Nockchainå®‰è£…å®Œæˆï¼"
    print_message "$YELLOW" "å®‰è£…è·¯å¾„: $NOCKCHAIN_DIR"
    print_message "$YELLOW" "é…ç½®æ–‡ä»¶: $NOCKCHAIN_DIR/.env"
    print_message "$YELLOW" "æ„å»ºæ—¥å¿—: $build_log"
    print_message "$YELLOW" "å¤‡ä»½ç›®å½•: $BACKUP_DIR"
    print_message "$CYAN" "è¯·å¦¥å–„ä¿å­˜é’±åŒ…ä¿¡æ¯ï¼ŒåŒ…æ‹¬åŠ©è®°è¯å’Œç§é’¥ï¼"
    
    log_message "Nockchainå®Œæ•´å®‰è£…æˆåŠŸ"
}

# é…ç½®æŒ–çŸ¿å…¬é’¥
configure_mining_key() {
    print_message "$CYAN" ">>> é…ç½®æŒ–çŸ¿å…¬é’¥"
    
    if [ ! -f "$NOCKCHAIN_DIR/.env" ]; then
        print_message "$RED" "é”™è¯¯ï¼šæœªæ‰¾åˆ°.envé…ç½®æ–‡ä»¶ï¼Œè¯·å…ˆå®‰è£…Nockchain"
        return 1
    fi
    
    print_message "$YELLOW" "å½“å‰é…ç½®çš„å…¬é’¥ï¼š"
    local current_key=$(grep "MINING_PUBKEY" "$NOCKCHAIN_DIR/.env" | cut -d'=' -f2)
    print_message "$CYAN" "$current_key"
    
    echo
    read -p "è¯·è¾“å…¥æ–°çš„æŒ–çŸ¿å…¬é’¥ï¼ˆ128ä½åå…­è¿›åˆ¶æˆ–Base58æ ¼å¼ï¼‰: " new_pubkey
    
    if [ -z "$new_pubkey" ]; then
        print_message "$YELLOW" "è¾“å…¥ä¸ºç©ºï¼Œå–æ¶ˆæ“ä½œ"
        return 0
    fi
    
    if validate_pubkey "$new_pubkey"; then
        cd "$NOCKCHAIN_DIR"
        # å¤‡ä»½åŸé…ç½®
        cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
        
        # æ›´æ–°å…¬é’¥
        sed -i "s/MINING_PUBKEY=.*/MINING_PUBKEY=$new_pubkey/" .env
        print_message "$GREEN" "æŒ–çŸ¿å…¬é’¥æ›´æ–°æˆåŠŸï¼"
        print_message "$YELLOW" "åŸé…ç½®å·²å¤‡ä»½"
        log_message "æŒ–çŸ¿å…¬é’¥å·²æ›´æ–°ä¸º: $new_pubkey"
    else
        print_message "$RED" "å…¬é’¥æ ¼å¼éªŒè¯å¤±è´¥"
        return 1
    fi
}

# å¯åŠ¨æŒ–çŸ¿èŠ‚ç‚¹
start_mining() {
    print_message "$GREEN" ">>> å¯åŠ¨ä¼˜åŒ–æŒ–çŸ¿èŠ‚ç‚¹..."
    
    if [ ! -f "$NOCKCHAIN_DIR/.env" ]; then
        print_message "$RED" "é”™è¯¯ï¼šæœªæ‰¾åˆ°Nockchainå®‰è£…ï¼Œè¯·å…ˆå®‰è£…"
        return 1
    fi
    
    cd "$NOCKCHAIN_DIR"
    
    # æ£€æŸ¥æ˜¯å¦å·²åœ¨è¿è¡Œ
    if screen -list | grep -q "nockchain"; then
        print_message "$YELLOW" "æ£€æµ‹åˆ°å·²æœ‰æŒ–çŸ¿è¿›ç¨‹åœ¨è¿è¡Œ"
        print_message "$CYAN" "è¿›ç¨‹ä¿¡æ¯:"
        screen -list | grep nockchain
        read -p "æ˜¯å¦é‡å¯æŒ–çŸ¿èŠ‚ç‚¹ï¼Ÿ(y/N): " restart_choice
        if [[ "$restart_choice" =~ ^[Yy]$ ]]; then
            screen -S nockchain -X quit 2>/dev/null
            sleep 2
            print_message "$YELLOW" "å·²åœæ­¢ç°æœ‰æŒ–çŸ¿è¿›ç¨‹"
        else
            return 0
        fi
    fi
    
    # æ£€æŸ¥å…¬é’¥é…ç½®
    local pubkey=$(grep "MINING_PUBKEY" .env | cut -d'=' -f2)
    if [ -z "$pubkey" ] || [ "$pubkey" = "0000000000000000000000000000000000000000000000000000000000000000" ]; then
        print_message "$RED" "è­¦å‘Šï¼šæœªé…ç½®æœ‰æ•ˆçš„æŒ–çŸ¿å…¬é’¥"
        read -p "æ˜¯å¦ç°åœ¨é…ç½®å…¬é’¥ï¼Ÿ(Y/n): " config_key
        if [[ ! "$config_key" =~ ^[Nn]$ ]]; then
            configure_mining_key
            if [ $? -ne 0 ]; then
                return 1
            fi
        fi
    fi
    
    # è®¾ç½®ä¼˜åŒ–ç¯å¢ƒå˜é‡
    export RUST_MIN_STACK=8388608
    export RUST_LOG=info
    export PATH="$HOME/.cargo/bin:$PATH"
    
    # æ¸…ç†æ—§çš„socketæ–‡ä»¶
    rm -f *.sock
    
    # åˆ›å»ºæ—¥å¿—ç›®å½•
    mkdir -p logs
    
    print_message "$CYAN" "æ­£åœ¨å¯åŠ¨æŒ–çŸ¿èŠ‚ç‚¹ï¼Œè¯·ç¨å€™..."
    
    # åœ¨screenä¼šè¯ä¸­å¯åŠ¨æŒ–çŸ¿
    screen -dmS nockchain bash -c "
        cd '$NOCKCHAIN_DIR'
        export RUST_MIN_STACK=8388608
        export RUST_LOG=info
        export PATH='$HOME/.cargo/bin:$PATH'
        source .env
        echo '=== Nockchain æŒ–çŸ¿å¯åŠ¨æ—¥å¿— ===' > logs/mining.log
        echo 'å¯åŠ¨æ—¶é—´: $(date)' >> logs/mining.log
        echo 'å…¬é’¥: $MINING_PUBKEY' >> logs/mining.log
        echo '==============================' >> logs/mining.log
        make run-nockchain 2>&1 | tee -a logs/mining.log
    "
    
    sleep 5
    
    if screen -list | grep -q "nockchain"; then
        print_message "$GREEN" "ğŸš€ æŒ–çŸ¿èŠ‚ç‚¹å¯åŠ¨æˆåŠŸï¼"
        print_message "$YELLOW" "ç®¡ç†å‘½ä»¤ï¼š"
        print_message "$CYAN" "- æŸ¥çœ‹æŒ–çŸ¿çŠ¶æ€: screen -r nockchain"
        print_message "$CYAN" "- é€€å‡ºæŸ¥çœ‹æ¨¡å¼: Ctrl+A, ç„¶åæŒ‰D"
        print_message "$CYAN" "- åœæ­¢æŒ–çŸ¿: screen -S nockchain -X quit"
        print_message "$CYAN" "- æŸ¥çœ‹æ—¥å¿—: tail -f $NOCKCHAIN_DIR/logs/mining.log"
        log_message "æŒ–çŸ¿èŠ‚ç‚¹å¯åŠ¨æˆåŠŸ"
    else
        print_message "$RED" "æŒ–çŸ¿èŠ‚ç‚¹å¯åŠ¨å¤±è´¥"
        print_message "$YELLOW" "è¯·æ£€æŸ¥æ—¥å¿—æ–‡ä»¶: $NOCKCHAIN_DIR/logs/mining.log"
        return 1
    fi
}

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
view_logs() {
    print_message "$GREEN" ">>> æ˜¾ç¤ºæŒ–çŸ¿æ—¥å¿—ï¼ˆæŒ‰Ctrl+Cé€€å‡ºï¼‰"
    
    local log_files=(
        "$NOCKCHAIN_DIR/logs/mining.log"
        "$NOCKCHAIN_DIR/mining.log"
        "$NOCKCHAIN_DIR/nockchain.log"
    )
    
    local active_log=""
    for log_file in "${log_files[@]}"; do
        if [ -f "$log_file" ]; then
            active_log="$log_file"
            break
        fi
    done
    
    if [ -n "$active_log" ]; then
        print_message "$CYAN" "æ­£åœ¨æ˜¾ç¤ºæ—¥å¿—æ–‡ä»¶: $active_log"
        echo
        tail -f "$active_log"
    else
        print_message "$YELLOW" "æœªæ‰¾åˆ°æ—¥å¿—æ–‡ä»¶ï¼Œå°è¯•è¿æ¥åˆ°screenä¼šè¯..."
        if screen -list | grep -q "nockchain"; then
            print_message "$CYAN" "è¿æ¥åˆ°æŒ–çŸ¿è¿›ç¨‹..."
            screen -r nockchain
        else
            print_message "$RED" "æœªæ‰¾åˆ°è¿è¡Œä¸­çš„æŒ–çŸ¿è¿›ç¨‹"
            print_message "$YELLOW" "è¯·å…ˆå¯åŠ¨æŒ–çŸ¿èŠ‚ç‚¹"
        fi
    fi
}

# æ£€æŸ¥é’±åŒ…ä½™é¢
check_balance() {
    print_message "$GREEN" ">>> æ£€æŸ¥é’±åŒ…ä½™é¢"
    
    if [ ! -f "$NOCKCHAIN_DIR/.env" ]; then
        print_message "$RED" "é”™è¯¯ï¼šæœªæ‰¾åˆ°Nockchainå®‰è£…"
        return 1
    fi
    
    cd "$NOCKCHAIN_DIR"
    export PATH="$HOME/.cargo/bin:$PATH"
    
    # è·å–å…¬é’¥
    local pubkey=$(grep "MINING_PUBKEY" .env | cut -d'=' -f2)
    
    if [ -z "$pubkey" ] || [ "$pubkey" = "0000000000000000000000000000000000000000000000000000000000000000" ]; then
        print_message "$RED" "é”™è¯¯ï¼šæœªé…ç½®æœ‰æ•ˆçš„æŒ–çŸ¿å…¬é’¥"
        return 1
    fi
    
    print_message "$CYAN" "æ­£åœ¨æŸ¥è¯¢ä½™é¢..."
    print_message "$YELLOW" "å…¬é’¥: $pubkey"
    
    # æ£€æŸ¥é’±åŒ…å‘½ä»¤
    if ! check_command "nockchain-wallet"; then
        print_message "$RED" "nockchain-walletå‘½ä»¤ä¸å¯ç”¨"
        return 1
    fi
    
    # å°è¯•ä¸åŒçš„socketæ–‡ä»¶
    local socket_files=(
        "./nockchain.sock"
        "./nockchain-leader.sock"
        "./nockchain-follower.sock"
    )
    
    local balance_found=false
    for socket_file in "${socket_files[@]}"; do
        if [ -S "$socket_file" ]; then
            print_message "$CYAN" "å°è¯•è¿æ¥socket: $socket_file"
            if nockchain-wallet --nockchain-socket "$socket_file" list-notes-by-pubkey -p "$pubkey" 2>/dev/null; then
                balance_found=true
                break
            fi
        fi
    done
    
    if [ "$balance_found" = false ]; then
        print_message "$YELLOW" "æ— æ³•è¿æ¥åˆ°èŠ‚ç‚¹æŸ¥è¯¢ä½™é¢"
        print_message "$YELLOW" "å¯èƒ½çš„åŸå› ï¼š"
        print_message "$YELLOW" "1. æŒ–çŸ¿èŠ‚ç‚¹æœªè¿è¡Œ"
        print_message "$YELLOW" "2. èŠ‚ç‚¹æ­£åœ¨åŒæ­¥ä¸­"
        print_message "$YELLOW" "3. Socketæ–‡ä»¶ä¸å­˜åœ¨"
        print_message "$CYAN" "è¯·ç¡®ä¿æŒ–çŸ¿èŠ‚ç‚¹æ­£åœ¨è¿è¡Œåå†è¯•"
    fi
}

# ç³»ç»ŸçŠ¶æ€ç›‘æ§
system_monitor() {
    print_message "$BLUE" "====== ç³»ç»ŸçŠ¶æ€ç›‘æ§ ======"
    
    # CPUä½¿ç”¨ç‡
    if check_command "top"; then
        local cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1 2>/dev/null || echo "N/A")
        print_message "$YELLOW" "CPUä½¿ç”¨ç‡: ${cpu_usage}%"
    fi
    
    # å†…å­˜ä½¿ç”¨
    if check_command "free"; then
        local mem_used=$(free -m | awk '/^Mem:/{print $3}' 2>/dev/null || echo "0")
        local mem_total=$(free -m | awk '/^Mem:/{print $2}' 2>/dev/null || echo "0")
        if [ "$mem_total" -gt 0 ]; then
            local mem_percent=$((mem_used * 100 / mem_total))
            print_message "$YELLOW" "å†…å­˜ä½¿ç”¨: ${mem_used}MB / ${mem_total}MB (${mem_percent}%)"
        fi
    fi
    
    # ç£ç›˜ç©ºé—´
    local disk_info=$(df -h ~ 2>/dev/null | awk 'NR==2{print $4" å¯ç”¨ï¼Œä½¿ç”¨ç‡ "$5}' || echo "N/A")
    print_message "$YELLOW" "ç£ç›˜ç©ºé—´: $disk_info"
    
    # ç½‘ç»œè¿æ¥
    if check_command "netstat"; then
        local network_connections=$(netstat -an 2>/dev/null | grep ESTABLISHED | wc -l || echo "N/A")
        print_message "$YELLOW" "ç½‘ç»œè¿æ¥æ•°: $network_connections"
    fi
    
    # æŒ–çŸ¿è¿›ç¨‹çŠ¶æ€
    if screen -list 2>/dev/null | grep -q "nockchain"; then
        print_message "$GREEN" "æŒ–çŸ¿çŠ¶æ€: âœ… æ­£åœ¨è¿è¡Œ"
        
        # æ˜¾ç¤ºæœ€è¿‘çš„æŒ–çŸ¿æ—¥å¿—
        local log_files=(
            "$NOCKCHAIN_DIR/logs/mining.log"
            "$NOCKCHAIN_DIR/mining.log"
        )
        
        for log_file in "${log_files[@]}"; do
            if [ -f "$log_file" ]; then
                print_message "$CYAN" "æœ€è¿‘çš„æŒ–çŸ¿æ—¥å¿— ($log_file)ï¼š"
                tail -n 3 "$log_file" 2>/dev/null | while read -r line; do
                    print_message "$YELLOW" "  $line"
                done
                break
            fi
        done
    else
        print_message "$RED" "æŒ–çŸ¿çŠ¶æ€: âŒ æœªè¿è¡Œ"
    fi
    
    # ç³»ç»Ÿè´Ÿè½½
    if [ -f "/proc/loadavg" ]; then
        local load_avg=$(cat /proc/loadavg | cut -d' ' -f1-3)
        print_message "$YELLOW" "ç³»ç»Ÿè´Ÿè½½: $load_avg"
    fi
    
    echo
}

# å¤‡ä»½é’±åŒ…å¯†é’¥
backup_wallet() {
    print_message "$GREEN" ">>> å¤‡ä»½é’±åŒ…å¯†é’¥"
    
    if [ ! -f "$NOCKCHAIN_DIR/.env" ]; then
        print_message "$RED" "é”™è¯¯ï¼šæœªæ‰¾åˆ°Nockchainå®‰è£…"
        return 1
    fi
    
    cd "$NOCKCHAIN_DIR"
    export PATH="$HOME/.cargo/bin:$PATH"
    
    local backup_file="$BACKUP_DIR/keys_backup_$(date +%Y%m%d_%H%M%S).export"
    
    mkdir -p "$BACKUP_DIR"
    
    print_message "$CYAN" "æ­£åœ¨å¤‡ä»½é’±åŒ…å¯†é’¥..."
    
    # å°è¯•å¯¼å‡ºé’±åŒ…å¯†é’¥
    if check_command "nockchain-wallet"; then
        if nockchain-wallet export-keys --output "$backup_file" 2>/dev/null; then
            print_message "$GREEN" "é’±åŒ…å¯†é’¥å¤‡ä»½æˆåŠŸï¼"
            print_message "$YELLOW" "å¤‡ä»½æ–‡ä»¶: $backup_file"
        else
            print_message "$YELLOW" "ä½¿ç”¨å¤‡ç”¨æ–¹æ³•è¿›è¡Œå¤‡ä»½..."
        fi
    fi
    
    # å¤‡ä»½é…ç½®æ–‡ä»¶å’Œç›¸å…³ä¿¡æ¯
    local config_backup="$BACKUP_DIR/config_$(date +%Y%m%d_%H%M%S).backup"
    
    echo "# Nockchain é…ç½®å¤‡ä»½ - $(date)" > "$config_backup"
    echo "# ======================" >> "$config_backup"
    echo "" >> "$config_backup"
    
    if [ -f ".env" ]; then
        echo "## .env é…ç½®æ–‡ä»¶" >> "$config_backup"
        cat .env >> "$config_backup"
        echo "" >> "$config_backup"
    fi
    
    # å¤‡ä»½å·²æœ‰çš„é’±åŒ…ä¿¡æ¯æ–‡ä»¶
    for wallet_file in "$BACKUP_DIR"/wallet_*.txt; do
        if [ -f "$wallet_file" ]; then
            echo "## é’±åŒ…ä¿¡æ¯æ–‡ä»¶: $(basename "$wallet_file")" >> "$config_backup"
            cat "$wallet_file" >> "$config_backup"
            echo "" >> "$config_backup"
            break
        fi
    done
    
    print_message "$GREEN" "é…ç½®ä¿¡æ¯å¤‡ä»½å®Œæˆï¼"
    print_message "$YELLOW" "é…ç½®å¤‡ä»½æ–‡ä»¶: $config_backup"
    print_message "$CYAN" "è¯·å¦¥å–„ä¿å­˜å¤‡ä»½æ–‡ä»¶ï¼Œå®ƒä»¬åŒ…å«é‡è¦çš„é’±åŒ…ä¿¡æ¯"
    
    # æ˜¾ç¤ºå¤‡ä»½ç›®å½•å†…å®¹
    print_message "$YELLOW" "å¤‡ä»½ç›®å½•å†…å®¹:"
    ls -la "$BACKUP_DIR" 2>/dev/null || print_message "$RED" "æ— æ³•åˆ—å‡ºå¤‡ä»½ç›®å½•"
    
    log_message "é’±åŒ…å’Œé…ç½®å·²å¤‡ä»½åˆ° $BACKUP_DIR"
}

# ä¿®å¤ç³»ç»Ÿä¾èµ–
fix_dependencies() {
    print_message "$GREEN" ">>> ä¿®å¤ç³»ç»Ÿä¾èµ–"
    
    print_message "$CYAN" "æ­£åœ¨æ£€æŸ¥ç³»ç»Ÿä¾èµ–çŠ¶æ€..."
    
    # æ£€æŸ¥å…³é”®å‘½ä»¤
    local missing_commands=()
    local commands_to_check=("gcc" "g++" "make" "clang" "curl" "git" "rustc" "cargo")
    
    for cmd in "${commands_to_check[@]}"; do
        if check_command "$cmd"; then
            print_message "$GREEN" "âœ… $cmd: $(which $cmd)"
        else
            print_message "$RED" "âŒ $cmd: æœªæ‰¾åˆ°"
            missing_commands+=("$cmd")
        fi
    done
    
    if [ ${#missing_commands[@]} -eq 0 ]; then
        print_message "$GREEN" "æ‰€æœ‰ä¾èµ–éƒ½å·²æ­£ç¡®å®‰è£…ï¼"
        return 0
    fi
    
    print_message "$YELLOW" "å‘ç°ç¼ºå¤±çš„å‘½ä»¤: ${missing_commands[*]}"
    read -p "æ˜¯å¦ç«‹å³ä¿®å¤è¿™äº›ä¾èµ–ï¼Ÿ(Y/n): " fix_choice
    
    if [[ "$fix_choice" =~ ^[Nn]$ ]]; then
        return 0
    fi
    
    # é‡æ–°å®‰è£…ç³»ç»Ÿä¾èµ–
    if ! install_system_dependencies; then
        print_message "$RED" "ä¾èµ–ä¿®å¤å¤±è´¥"
        return 1
    fi
    
    # å¦‚æœRustç›¸å…³å‘½ä»¤ç¼ºå¤±ï¼Œé‡æ–°å®‰è£…Rust
    if [[ " ${missing_commands[*]} " =~ " rustc " ]] || [[ " ${missing_commands[*]} " =~ " cargo " ]]; then
        print_message "$CYAN" "æ­£åœ¨ä¿®å¤Rustå®‰è£…..."
        if ! install_rust; then
            print_message "$RED" "Rustä¿®å¤å¤±è´¥"
            return 1
        fi
    fi
    
    print_message "$GREEN" "ä¾èµ–ä¿®å¤å®Œæˆï¼"
    
    # å†æ¬¡æ£€æŸ¥
    print_message "$CYAN" "éªŒè¯ä¿®å¤ç»“æœ..."
    local still_missing=()
    for cmd in "${missing_commands[@]}"; do
        if ! check_command "$cmd"; then
            still_missing+=("$cmd")
        fi
    done
    
    if [ ${#still_missing[@]} -eq 0 ]; then
        print_message "$GREEN" "ğŸ‰ æ‰€æœ‰ä¾èµ–ä¿®å¤æˆåŠŸï¼"
    else
        print_message "$YELLOW" "ä»¥ä¸‹å‘½ä»¤ä»ç„¶ç¼ºå¤±: ${still_missing[*]}"
        print_message "$YELLOW" "å¯èƒ½éœ€è¦æ‰‹åŠ¨å®‰è£…æˆ–ç³»ç»Ÿé‡å¯"
    fi
}

# ä¸»å¾ªç¯
main() {
    # æ£€æŸ¥æ˜¯å¦ä»¥rootç”¨æˆ·è¿è¡Œ
    if [ "$EUID" -eq 0 ]; then
        print_message "$RED" "è¯·ä¸è¦ä»¥rootç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬"
        print_message "$YELLOW" "å»ºè®®ä½¿ç”¨æ™®é€šç”¨æˆ·è´¦æˆ·è¿è¡Œ"
        exit 1
    fi
    
    # åˆ›å»ºå¿…è¦ç›®å½•å’Œæ—¥å¿—æ–‡ä»¶
    mkdir -p "$BACKUP_DIR"
    touch "$LOG_FILE"
    log_message "è„šæœ¬å¯åŠ¨ - ä¿®å¤ç‰ˆ v3.1"
    
    while true; do
        show_menu
        read -p "è¯·è¾“å…¥é€‰é¡¹ç¼–å·ï¼ˆ1-9ï¼‰: " choice
        
        case $choice in
            1)
                install_nockchain
                ;;
            2)
                configure_mining_key
                ;;
            3)
                start_mining
                ;;
            4)
                view_logs
                ;;
            5)
                check_balance
                ;;
            6)
                system_monitor
                ;;
            7)
                backup_wallet
                ;;
            8)
                fix_dependencies
                ;;
            9)
                print_message "$GREEN" "æ„Ÿè°¢ä½¿ç”¨Nockchainä¼˜åŒ–è„šæœ¬ï¼Œå†è§ï¼"
                log_message "è„šæœ¬æ­£å¸¸é€€å‡º"
                exit 0
                ;;
            *)
                print_message "$RED" "æ— æ•ˆé€‰é¡¹ï¼Œè¯·è¾“å…¥1-9ä¹‹é—´çš„æ•°å­—"
                ;;
        esac
        
        echo
        read -p "æŒ‰å›è½¦é”®ç»§ç»­..." -r
    done
}

# å¯åŠ¨ä¸»ç¨‹åº
main
