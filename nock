#!/bin/bash

# ========= Nockchain å½»åº•è§£å†³ç‰ˆæ„å»ºè„šæœ¬ v19.0 =========
RESET='\033[0m'
BOLD='\033[1m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'

NCK_DIR="$HOME/nockchain"
ENV_FILE="$NCK_DIR/.env"
LOG_FILE="$HOME/nockchain_build.log"
USER_SOFTWARE_DIR="$HOME/software"
USER_BIN_DIR="$USER_SOFTWARE_DIR/bin"
USER_LIB_DIR="$USER_SOFTWARE_DIR/lib"
USER_INCLUDE_DIR="$USER_SOFTWARE_DIR/include"

function show_banner() {
  clear
  echo -e "${BOLD}${CYAN}"
  echo "============================================================"
  echo "   Nockchain å½»åº•è§£å†³ç‰ˆæ„å»ºè„šæœ¬ v19.0"
  echo "============================================================"
  echo -e "${RESET}"
  echo "ğŸ¯ å½»åº•ä¿®å¤: makeå·¥å…·ç¼ºå¤±å’Œç¯å¢ƒå˜é‡é—®é¢˜"
  echo "ğŸ”§ å¤šé‡ä¿éšœ: é™æ€é“¾æ¥ç‰ˆæœ¬ + ç³»ç»ŸåŒ…ç®¡ç† + æºç ç¼–è¯‘"
  echo "ğŸ’¾ å†…å­˜ä¼˜åŒ–: ä¸“é—¨è§£å†³mem.rs:302:23 panicé”™è¯¯"
  echo "âš¡ æ™ºèƒ½æ£€æµ‹: å®æ—¶éªŒè¯å·¥å…·å¯ç”¨æ€§"
  echo "ğŸ› ï¸ å®Œæ•´æ–¹æ¡ˆ: ä»ç¯å¢ƒåˆ°æ„å»ºçš„ä¸€ç«™å¼è§£å†³"
  echo "------------------------------------------------------------"
  echo ""
}

# ========= ç¯å¢ƒæ£€æµ‹å’Œåˆå§‹åŒ– =========
function detect_and_setup_environment() {
  echo -e "[*] ç¯å¢ƒæ£€æµ‹å’Œåˆå§‹åŒ–..."
  
  # æ£€æµ‹æ“ä½œç³»ç»Ÿ
  if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS_NAME=$NAME
    OS_VERSION=$VERSION_ID
    echo -e "${BLUE}[i] æ“ä½œç³»ç»Ÿ: $OS_NAME $OS_VERSION${RESET}"
  else
    OS_NAME="Unknown"
    echo -e "${YELLOW}[!] æ— æ³•æ£€æµ‹æ“ä½œç³»ç»Ÿç±»å‹${RESET}"
  fi
  
  # æ£€æµ‹æ¶æ„
  ARCH=$(uname -m)
  echo -e "${BLUE}[i] ç³»ç»Ÿæ¶æ„: $ARCH${RESET}"
  
  # æ£€æµ‹å†…å­˜ï¼ˆé’ˆå¯¹mem.rsé”™è¯¯ï¼‰[2]
  total_mem_kb=$(grep MemTotal /proc/meminfo | awk '{print $2}')
  total_mem_gb=$((total_mem_kb / 1024 / 1024))
  echo -e "${BLUE}[i] ç³»ç»Ÿå†…å­˜: ${total_mem_gb}GB${RESET}"
  
  if [ $total_mem_gb -lt 4 ]; then
    echo -e "${RED}[-] è­¦å‘Š: å†…å­˜ä¸è¶³å¯èƒ½å¯¼è‡´mem.rs:302:23 panicé”™è¯¯${RESET}"
    echo -e "${YELLOW}[!] å»ºè®®é…ç½®swapæ¥å¢åŠ å¯ç”¨å†…å­˜${RESET}"
  fi
  
  # åˆ›å»ºç›®å½•ç»“æ„
  mkdir -p "$USER_SOFTWARE_DIR"/{bin,lib,lib64,include,share,src,build,tmp}
  
  # è®¾ç½®åŸºç¡€ç¯å¢ƒå˜é‡
  export PATH="$USER_BIN_DIR:$PATH"
  export LD_LIBRARY_PATH="$USER_LIB_DIR:$USER_SOFTWARE_DIR/lib64:$LD_LIBRARY_PATH"
  export PKG_CONFIG_PATH="$USER_LIB_DIR/pkgconfig:$USER_SOFTWARE_DIR/lib64/pkgconfig:$PKG_CONFIG_PATH"
  export MANPATH="$USER_SOFTWARE_DIR/share/man:$MANPATH"
  
  echo -e "${GREEN}[+] ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ${RESET}"
}

# ========= ä¸‹è½½å·¥å…·å¢å¼ºç‰ˆ =========
function enhanced_download() {
  local url="$1"
  local output="$2"
  local description="$3"
  local max_attempts=5
  
  echo -e "[*] ä¸‹è½½ $description..."
  
  for attempt in $(seq 1 $max_attempts); do
    echo -e "  å°è¯• $attempt/$max_attempts..."
    
    # å°è¯•wget
    if command -v wget >/dev/null 2>&1; then
      if wget --timeout=30 --tries=3 -q -O "$output" "$url"; then
        if [ -f "$output" ] && [ -s "$output" ]; then
          echo -e "${GREEN}[+] ä¸‹è½½æˆåŠŸ: $description${RESET}"
          return 0
        fi
      fi
    fi
    
    # å°è¯•curl
    if command -v curl >/dev/null 2>&1; then
      if curl --connect-timeout 30 --max-time 120 -fsSL -o "$output" "$url"; then
        if [ -f "$output" ] && [ -s "$output" ]; then
          echo -e "${GREEN}[+] ä¸‹è½½æˆåŠŸ: $description${RESET}"
          return 0
        fi
      fi
    fi
    
    echo -e "${YELLOW}[!] ä¸‹è½½å¤±è´¥ï¼Œç­‰å¾…é‡è¯•...${RESET}"
    sleep $((attempt * 2))
  done
  
  echo -e "${RED}[-] ä¸‹è½½å¤±è´¥: $description${RESET}"
  return 1
}

# ========= å®‰è£…é™æ€é“¾æ¥ç‰ˆmakeï¼ˆå½»åº•è§£å†³æ–¹æ¡ˆï¼‰=========
function install_static_make() {
  echo -e "[*] å®‰è£…é™æ€é“¾æ¥ç‰ˆmakeï¼ˆå½»åº•è§£å†³æ–¹æ¡ˆï¼‰..."
  
  cd "$USER_SOFTWARE_DIR/src"
  
  # æ–¹æ¡ˆ1: ä½¿ç”¨é¢„ç¼–è¯‘çš„é™æ€é“¾æ¥ç‰ˆæœ¬
  echo -e "[*] å°è¯•ä¸‹è½½é¢„ç¼–è¯‘é™æ€make..."
  if enhanced_download "https://github.com/habitat-sh/core-plans-resource/raw/master/make/make-4.3-20220710220843-x86_64-linux.tar.xz" "make-static.tar.xz" "é™æ€make"; then
    tar -xf make-static.tar.xz 2>/dev/null || true
    
    # æŸ¥æ‰¾makeå¯æ‰§è¡Œæ–‡ä»¶
    make_binary=$(find . -name "make" -type f -executable 2>/dev/null | head -1)
    if [ -n "$make_binary" ]; then
      cp "$make_binary" "$USER_BIN_DIR/make"
      chmod +x "$USER_BIN_DIR/make"
      echo -e "${GREEN}[+] é™æ€makeå®‰è£…æˆåŠŸ${RESET}"
      return 0
    fi
  fi
  
  # æ–¹æ¡ˆ2: ä¸‹è½½GNU makeæºç å¹¶ç¼–è¯‘ä¸ºé™æ€é“¾æ¥
  echo -e "[*] ç¼–è¯‘é™æ€é“¾æ¥make..."
  if enhanced_download "https://ftp.gnu.org/gnu/make/make-4.3.tar.gz" "make-4.3.tar.gz" "GNU Makeæºç "; then
    tar -xzf make-4.3.tar.gz
    cd make-4.3
    
    # é…ç½®ä¸ºé™æ€é“¾æ¥ç¼–è¯‘
    if ./configure --prefix="$USER_SOFTWARE_DIR" --enable-static --disable-shared LDFLAGS=-static; then
      # å°è¯•ç¼–è¯‘
      if make -j$(nproc) LDFLAGS=-static; then
        cp make "$USER_BIN_DIR/make"
        chmod +x "$USER_BIN_DIR/make"
        echo -e "${GREEN}[+] é™æ€makeç¼–è¯‘æˆåŠŸ${RESET}"
        cd ..
        return 0
      fi
    fi
    cd ..
  fi
  
  # æ–¹æ¡ˆ3: ä¸‹è½½BusyBoxï¼ˆåŒ…å«makeåŠŸèƒ½ï¼‰
  echo -e "[*] å°è¯•BusyBoxæ–¹æ¡ˆ..."
  if enhanced_download "https://busybox.net/downloads/binaries/1.35.0-x86_64-linux-musl/busybox" "busybox" "BusyBox"; then
    chmod +x busybox
    cp busybox "$USER_BIN_DIR/busybox"
    
    # BusyBoxæ²¡æœ‰å®Œæ•´çš„makeï¼Œåˆ›å»ºç®€åŒ–ç‰ˆæœ¬
    cat > "$USER_BIN_DIR/make" << 'EOF'
#!/bin/bash
# ç®€åŒ–makeæ›¿ä»£å“
if [ "$1" = "build" ]; then
  echo "æ‰§è¡Œ cargo build --release"
  cargo build --release
elif [ "$1" = "install-hoonc" ]; then
  echo "æ‰§è¡Œ cargo build --bin hoonc --release && cargo install --bin hoonc --path ."
  cargo build --bin hoonc --release && cargo install --bin hoonc --path .
elif [ "$1" = "install-nockchain" ]; then
  echo "æ‰§è¡Œ cargo build --bin nockchain --release && cargo install --bin nockchain --path ."
  cargo build --bin nockchain --release && cargo install --bin nockchain --path .
elif [ "$1" = "install-nockchain-wallet" ]; then
  echo "æ‰§è¡Œ cargo build --bin nockchain-wallet --release && cargo install --bin nockchain-wallet --path ."
  cargo build --bin nockchain-wallet --release && cargo install --bin nockchain-wallet --path .
else
  echo "ç®€åŒ–make: æ”¯æŒçš„ç›®æ ‡ build, install-hoonc, install-nockchain, install-nockchain-wallet"
  exit 1
fi
EOF
    chmod +x "$USER_BIN_DIR/make"
    echo -e "${GREEN}[+] ç®€åŒ–makeå®‰è£…æˆåŠŸ${RESET}"
    return 0
  fi
  
  echo -e "${RED}[-] æ‰€æœ‰makeå®‰è£…æ–¹æ¡ˆéƒ½å¤±è´¥${RESET}"
  return 1
}

# ========= å®‰è£…åŸºç¡€ç¼–è¯‘å·¥å…·é“¾ =========
function install_basic_toolchain() {
  echo -e "[*] å®‰è£…åŸºç¡€ç¼–è¯‘å·¥å…·é“¾..."
  
  cd "$USER_SOFTWARE_DIR/src"
  
  # å®‰è£…GCCï¼ˆmuslç‰ˆæœ¬ï¼Œä½“ç§¯å°ï¼‰
  echo -e "[*] å®‰è£…musl-crossç¼–è¯‘å™¨..."
  if enhanced_download "https://musl.cc/x86_64-linux-musl-cross.tgz" "x86_64-linux-musl-cross.tgz" "musläº¤å‰ç¼–è¯‘å™¨"; then
    tar -xzf x86_64-linux-musl-cross.tgz
    cp -r x86_64-linux-musl-cross/* "$USER_SOFTWARE_DIR/"
    
    # åˆ›å»ºæ ‡å‡†gccé“¾æ¥
    ln -sf "$USER_BIN_DIR/x86_64-linux-musl-gcc" "$USER_BIN_DIR/gcc" 2>/dev/null || true
    ln -sf "$USER_BIN_DIR/x86_64-linux-musl-g++" "$USER_BIN_DIR/g++" 2>/dev/null || true
    ln -sf "$USER_BIN_DIR/x86_64-linux-musl-gcc" "$USER_BIN_DIR/cc" 2>/dev/null || true
    
    echo -e "${GREEN}[+] musl-crossç¼–è¯‘å™¨å®‰è£…æˆåŠŸ${RESET}"
  fi
  
  # å®‰è£…pkg-config
  echo -e "[*] å®‰è£…pkg-config..."
  if enhanced_download "https://pkgconfig.freedesktop.org/releases/pkg-config-0.29.2.tar.gz" "pkg-config-0.29.2.tar.gz" "pkg-config"; then
    tar -xzf pkg-config-0.29.2.tar.gz
    cd pkg-config-0.29.2
    
    if ./configure --prefix="$USER_SOFTWARE_DIR" --with-internal-glib; then
      make -j$(nproc) && make install
    fi
    cd ..
  fi
  
  # ç¡®ä¿å·¥å…·æœ‰æ‰§è¡Œæƒé™
  chmod +x "$USER_BIN_DIR"/* 2>/dev/null || true
}

# ========= å®‰è£…Clang/LLVMï¼ˆé¢„ç¼–è¯‘ç‰ˆï¼‰=========
function install_prebuilt_clang() {
  echo -e "[*] å®‰è£…é¢„ç¼–è¯‘Clang/LLVM..."
  
  cd "$USER_SOFTWARE_DIR/src"
  
  # ä¸‹è½½LLVM 14é¢„ç¼–è¯‘ç‰ˆæœ¬
  if enhanced_download "https://github.com/llvm/llvm-project/releases/download/llvmorg-14.0.6/clang+llvm-14.0.6-x86_64-linux-gnu-ubuntu-18.04.tar.xz" "clang+llvm-14.0.6.tar.xz" "Clang+LLVM 14"; then
    tar -xf clang+llvm-14.0.6.tar.xz
    cp -r clang+llvm-14.0.6-x86_64-linux-gnu-ubuntu-18.04/* "$USER_SOFTWARE_DIR/"
    
    # åˆ›å»ºæ ‡å‡†é“¾æ¥
    ln -sf "$USER_BIN_DIR/clang-14" "$USER_BIN_DIR/clang" 2>/dev/null || true
    ln -sf "$USER_BIN_DIR/clang++-14" "$USER_BIN_DIR/clang++" 2>/dev/null || true
    
    echo -e "${GREEN}[+] Clang/LLVMå®‰è£…æˆåŠŸ${RESET}"
  fi
}

# ========= æ™ºèƒ½å·¥å…·éªŒè¯ =========
function smart_tool_verification() {
  echo -e "[*] æ™ºèƒ½å·¥å…·éªŒè¯..."
  
  # é‡æ–°åŠ è½½ç¯å¢ƒå˜é‡
  export PATH="$USER_BIN_DIR:$PATH"
  
  echo -e "${BLUE}[i] éªŒè¯å…³é”®å·¥å…·:${RESET}"
  
  # éªŒè¯make
  if command -v make >/dev/null 2>&1; then
    make_path=$(command -v make)
    echo -e "${GREEN}  âœ“ make: $make_path${RESET}"
    
    # æµ‹è¯•makeåŠŸèƒ½
    cd "$USER_SOFTWARE_DIR/tmp"
    echo -e "test:\n\t@echo 'Make test passed'" > Makefile
    if make test >/dev/null 2>&1; then
      echo -e "${GREEN}    â””â”€ makeåŠŸèƒ½æµ‹è¯•é€šè¿‡${RESET}"
    else
      echo -e "${YELLOW}    â””â”€ makeåŠŸèƒ½æµ‹è¯•å¤±è´¥${RESET}"
    fi
    rm -f Makefile
  else
    echo -e "${RED}  âœ— make: æœªæ‰¾åˆ°${RESET}"
    return 1
  fi
  
  # éªŒè¯ç¼–è¯‘å™¨
  tools_found=0
  for tool in gcc g++ clang pkg-config; do
    if command -v "$tool" >/dev/null 2>&1; then
      tool_path=$(command -v "$tool")
      echo -e "${GREEN}  âœ“ $tool: $tool_path${RESET}"
      ((tools_found++))
    else
      echo -e "${YELLOW}  âœ— $tool: æœªæ‰¾åˆ°${RESET}"
    fi
  done
  
  # éªŒè¯git
  if command -v git >/dev/null 2>&1; then
    echo -e "${GREEN}  âœ“ git: $(command -v git)${RESET}"
    ((tools_found++))
  else
    echo -e "${YELLOW}  âœ— git: æœªæ‰¾åˆ°${RESET}"
  fi
  
  echo -e "${BLUE}[i] æ‰¾åˆ°å·¥å…·: $tools_found ä¸ª${RESET}"
  
  if [ $tools_found -ge 3 ]; then
    echo -e "${GREEN}[+] âœ… å·¥å…·éªŒè¯é€šè¿‡ï¼${RESET}"
    return 0
  else
    echo -e "${YELLOW}[!] éƒ¨åˆ†å·¥å…·ç¼ºå¤±ï¼Œä½†å¯èƒ½ä»å¯ç»§ç»­${RESET}"
    return 1
  fi
}

# ========= é…ç½®æ°¸ä¹…ç¯å¢ƒå˜é‡ =========
function setup_permanent_env() {
  echo -e "[*] é…ç½®æ°¸ä¹…ç¯å¢ƒå˜é‡..."
  
  # åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶
  cat > "$HOME/.nockchain_env" << EOF
#!/bin/bash
# Nockchainå½»åº•è§£å†³ç‰ˆç¯å¢ƒå˜é‡
export PATH="$USER_BIN_DIR:\$PATH"
export LD_LIBRARY_PATH="$USER_LIB_DIR:$USER_SOFTWARE_DIR/lib64:\$LD_LIBRARY_PATH"
export PKG_CONFIG_PATH="$USER_LIB_DIR/pkgconfig:$USER_SOFTWARE_DIR/lib64/pkgconfig:\$PKG_CONFIG_PATH"
export C_INCLUDE_PATH="$USER_INCLUDE_DIR:\$C_INCLUDE_PATH"
export CPLUS_INCLUDE_PATH="$USER_INCLUDE_DIR:\$CPLUS_INCLUDE_PATH"
export LIBRARY_PATH="$USER_LIB_DIR:$USER_SOFTWARE_DIR/lib64:\$LIBRARY_PATH"
export MANPATH="$USER_SOFTWARE_DIR/share/man:\$MANPATH"

# ç¼–è¯‘å™¨è®¾ç½®
if command -v clang >/dev/null 2>&1; then
  export CC=clang
  export CXX=clang++
  export LIBCLANG_PATH="$USER_LIB_DIR"
elif command -v gcc >/dev/null 2>&1; then
  export CC=gcc
  export CXX=g++
fi

# Rustæ„å»ºä¼˜åŒ–ï¼ˆè§£å†³mem.rsé”™è¯¯ï¼‰
export CARGO_BUILD_JOBS=1
export RUSTFLAGS="-C opt-level=1 -C debuginfo=0 -C panic=abort -C target-cpu=native"
export RUST_BACKTRACE=1

# å†…å­˜ä¼˜åŒ–è®¾ç½®
export RUST_MIN_STACK=16777216
EOF
  
  # æ·»åŠ åˆ°bashrc
  if ! grep -q "source.*nockchain_env" "$HOME/.bashrc" 2>/dev/null; then
    echo "" >> "$HOME/.bashrc"
    echo "# Nockchainå½»åº•è§£å†³ç‰ˆç¯å¢ƒ - è‡ªåŠ¨æ·»åŠ " >> "$HOME/.bashrc"
    echo "source \$HOME/.nockchain_env" >> "$HOME/.bashrc"
    echo -e "${GREEN}[+] å·²æ·»åŠ åˆ°.bashrc${RESET}"
  fi
  
  # ç«‹å³åŠ è½½
  source "$HOME/.nockchain_env"
  
  echo -e "${GREEN}[+] æ°¸ä¹…ç¯å¢ƒå˜é‡é…ç½®å®Œæˆ${RESET}"
}

# ========= ç³»ç»Ÿå†…å­˜ä¼˜åŒ–ï¼ˆè§£å†³mem.rsé”™è¯¯ï¼‰=========
function optimize_memory_for_nockchain() {
  echo -e "[*] ä¼˜åŒ–ç³»ç»Ÿå†…å­˜ï¼ˆè§£å†³mem.rs:302:23é”™è¯¯ï¼‰..."
  
  total_mem_kb=$(grep MemTotal /proc/meminfo | awk '{print $2}')
  total_mem_gb=$((total_mem_kb / 1024 / 1024))
  
  if [ $total_mem_gb -lt 8 ]; then
    echo -e "${YELLOW}[!] å†…å­˜ä¸è¶³ï¼Œé…ç½®swapä»¥é˜²æ­¢mem.rsé”™è¯¯${RESET}"
    
    # è®¡ç®—éœ€è¦çš„swapå¤§å°
    required_swap=$((16 - total_mem_gb))
    
    # æ£€æŸ¥ç°æœ‰swap
    current_swap_kb=$(grep SwapTotal /proc/meminfo | awk '{print $2}')
    current_swap_gb=$((current_swap_kb / 1024 / 1024))
    
    if [ $current_swap_gb -lt $required_swap ]; then
      echo -e "[*] é…ç½®${required_swap}GB swapæ–‡ä»¶..."
      
      swap_file="$HOME/nockchain.swap"
      
      # åˆ›å»ºswapæ–‡ä»¶ï¼ˆç”¨æˆ·æƒé™ï¼‰
      if dd if=/dev/zero of="$swap_file" bs=1G count=$required_swap 2>/dev/null; then
        chmod 600 "$swap_file"
        
        # å¦‚æœæœ‰sudoæƒé™åˆ™å¯ç”¨swap
        if sudo -n true 2>/dev/null; then
          sudo mkswap "$swap_file" >/dev/null 2>&1
          sudo swapon "$swap_file" >/dev/null 2>&1
          echo -e "${GREEN}[+] Swapé…ç½®æˆåŠŸ${RESET}"
        else
          echo -e "${YELLOW}[!] æ— sudoæƒé™ï¼Œswapæ–‡ä»¶å·²åˆ›å»ºä½†æœªå¯ç”¨${RESET}"
          echo -e "${BLUE}[i] å¯æ‰‹åŠ¨è¿è¡Œ: sudo mkswap $swap_file && sudo swapon $swap_file${RESET}"
        fi
      else
        echo -e "${YELLOW}[!] Swapæ–‡ä»¶åˆ›å»ºå¤±è´¥${RESET}"
      fi
    else
      echo -e "${GREEN}[+] å½“å‰swapå……è¶³: ${current_swap_gb}GB${RESET}"
    fi
  else
    echo -e "${GREEN}[+] å†…å­˜å……è¶³ï¼Œæ— éœ€é¢å¤–é…ç½®${RESET}"
  fi
  
  # è®¾ç½®å†…å­˜ç›¸å…³çš„ç³»ç»Ÿå‚æ•°ï¼ˆå¦‚æœæœ‰æƒé™ï¼‰
  if sudo -n true 2>/dev/null; then
    sudo sysctl -w vm.overcommit_memory=1 >/dev/null 2>&1 || true
    sudo sysctl -w vm.max_map_count=2097152 >/dev/null 2>&1 || true
  fi
}

# ========= å®Œæ•´å®‰è£…æµç¨‹ =========
function complete_thorough_installation() {
  echo -e "[*] å¼€å§‹Nockchainå½»åº•è§£å†³ç‰ˆå®‰è£…..."
  
  echo "=== Nockchainå½»åº•è§£å†³ç‰ˆå®‰è£…æ—¥å¿— $(date) ===" > "$LOG_FILE"
  
  echo -e "${BLUE}[i] æ­¥éª¤1/7: ç¯å¢ƒæ£€æµ‹å’Œåˆå§‹åŒ–...${RESET}"
  detect_and_setup_environment
  
  echo -e "${BLUE}[i] æ­¥éª¤2/7: å†…å­˜ä¼˜åŒ–é…ç½®...${RESET}"
  optimize_memory_for_nockchain
  
  echo -e "${BLUE}[i] æ­¥éª¤3/7: å®‰è£…é™æ€make...${RESET}"
  if ! install_static_make; then
    echo -e "${YELLOW}[!] é™æ€makeå®‰è£…å¤±è´¥ï¼Œä½†ç»§ç»­å…¶ä»–å·¥å…·å®‰è£…${RESET}"
  fi
  
  echo -e "${BLUE}[i] æ­¥éª¤4/7: å®‰è£…åŸºç¡€å·¥å…·é“¾...${RESET}"
  install_basic_toolchain
  
  echo -e "${BLUE}[i] æ­¥éª¤5/7: å®‰è£…Clang/LLVM...${RESET}"
  install_prebuilt_clang
  
  echo -e "${BLUE}[i] æ­¥éª¤6/7: é…ç½®ç¯å¢ƒå˜é‡...${RESET}"
  setup_permanent_env
  
  echo -e "${BLUE}[i] æ­¥éª¤7/7: æ™ºèƒ½å·¥å…·éªŒè¯...${RESET}"
  if smart_tool_verification; then
    echo -e "${GREEN}[+] âœ… å½»åº•è§£å†³ç‰ˆå®‰è£…å®Œæˆï¼${RESET}"
    echo -e "${GREEN}[+] ğŸ‰ makeå·¥å…·å·²å¯ç”¨ï¼${RESET}"
    echo -e "${BLUE}[i] ä¸‹ä¸€æ­¥: å®‰è£…Rustå¹¶æ„å»ºNockchain${RESET}"
  else
    echo -e "${YELLOW}[!] éƒ¨åˆ†å·¥å…·å®‰è£…å¤±è´¥ï¼Œä½†makeåº”è¯¥å·²å¯ç”¨${RESET}"
  fi
  
  echo -e "${BLUE}[i] ç¯å¢ƒæ–‡ä»¶: $HOME/.nockchain_env${RESET}"
  echo -e "${BLUE}[i] è¯¦ç»†æ—¥å¿—: $LOG_FILE${RESET}"
  
  pause_and_return
}

# ========= Rustå®‰è£…å’Œä¼˜åŒ– =========
function install_rust_optimized() {
  echo -e "[*] å®‰è£…Rustï¼ˆä¼˜åŒ–ç‰ˆï¼‰..."
  
  # åŠ è½½ç¯å¢ƒå˜é‡
  source "$HOME/.nockchain_env" 2>/dev/null || true
  
  if ! command -v rustc >/dev/null 2>&1; then
    echo -e "[*] ä¸‹è½½å¹¶å®‰è£…Rust..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
  else
    echo -e "[*] æ›´æ–°ç°æœ‰Rust..."
    rustup update stable 2>/dev/null || true
  fi
  
  source "$HOME/.cargo/env"
  export PATH="$HOME/.cargo/bin:$PATH"
  
  # ä¼˜åŒ–Cargoé…ç½®ï¼ˆè§£å†³mem.rsé”™è¯¯ï¼‰
  mkdir -p "$HOME/.cargo"
  cat > "$HOME/.cargo/config.toml" << 'EOF'
[build]
jobs = 1

[net]
retry = 50
timeout = 3600

[profile.release]
opt-level = 1
debug = false
lto = "off"
panic = "abort"
codegen-units = 1
strip = true

[profile.dev]
opt-level = 0
debug = false
codegen-units = 1

[target.x86_64-unknown-linux-gnu]
rustflags = ["-C", "target-cpu=native", "-C", "panic=abort"]
EOF
  
  echo -e "${GREEN}[+] Rustå®‰è£…ä¼˜åŒ–å®Œæˆ: $(rustc --version)${RESET}"
}

# ========= æ„å»ºNockchainï¼ˆå½»åº•è§£å†³ç‰ˆï¼‰=========
function build_nockchain_thorough() {
  echo -e "[*] æ„å»ºNockchainï¼ˆå½»åº•è§£å†³ç‰ˆï¼‰..."
  
  # åŠ è½½æ‰€æœ‰ç¯å¢ƒå˜é‡
  source "$HOME/.nockchain_env" 2>/dev/null || true
  source "$HOME/.cargo/env" 2>/dev/null || true
  export PATH="$USER_BIN_DIR:$HOME/.cargo/bin:$PATH"
  
  # éªŒè¯å¿…è¦å·¥å…·
  echo -e "[*] éªŒè¯æ„å»ºå·¥å…·..."
  missing_tools=()
  for tool in make git rustc cargo; do
    if ! command -v "$tool" >/dev/null 2>&1; then
      missing_tools+=("$tool")
    fi
  done
  
  if [ ${#missing_tools[@]} -gt 0 ]; then
    echo -e "${RED}[-] ç¼ºå°‘å¿…è¦å·¥å…·: ${missing_tools[*]}${RESET}"
    echo -e "${YELLOW}[!] è¯·å…ˆè¿è¡Œå½»åº•è§£å†³ç‰ˆå®‰è£…${RESET}"
    pause_and_return
    return
  fi
  
  echo -e "${GREEN}[+] æ‰€æœ‰å¿…è¦å·¥å…·å·²å°±ç»ª${RESET}"
  
  # å®‰è£…Rustï¼ˆå¦‚æœéœ€è¦ï¼‰
  if ! command -v rustc >/dev/null 2>&1; then
    install_rust_optimized
  fi
  
  # å…‹éš†é¡¹ç›®
  if [ ! -d "$NCK_DIR" ]; then
    echo -e "[*] å…‹éš†Nockchainé¡¹ç›®..."
    git clone --depth 1 https://github.com/zorp-corp/nockchain "$NCK_DIR" || {
      echo -e "${RED}[-] é¡¹ç›®å…‹éš†å¤±è´¥${RESET}"
      pause_and_return
      return
    }
  fi
  
  cd "$NCK_DIR"
  
  # æ¸…ç†æ„å»ºç¯å¢ƒ
  echo -e "[*] æ¸…ç†æ„å»ºç¯å¢ƒ..."
  cargo clean >/dev/null 2>&1 || true
  rm -rf target/ 2>/dev/null || true
  
  # å‡†å¤‡é…ç½®æ–‡ä»¶
  if [ -f ".env_example" ]; then
    cp .env_example .env
  else
    cat > .env << 'EOF'
MINING_PUBKEY=
RUST_LOG=info
EOF
  fi
  
  # åˆ›å»ºå¿…è¦ç›®å½•å’Œæ–‡ä»¶
  mkdir -p assets .socket test-leader logs
  touch assets/wal.jam assets/dumb.jam assets/miner.jam 2>/dev/null || true
  chmod 755 .socket test-leader
  
  # è®¾ç½®æ„å»ºç¯å¢ƒå˜é‡ï¼ˆé˜²æ­¢mem.rsé”™è¯¯ï¼‰[2]
  export CARGO_BUILD_JOBS=1
  export RUSTFLAGS="-C opt-level=1 -C debuginfo=0 -C panic=abort"
  export RUST_MIN_STACK=16777216
  export RUST_BACKTRACE=1
  
  echo -e "[*] å¼€å§‹åˆ†æ­¥éª¤æ„å»º..."
  
  # æ„å»ºhooncï¼ˆç¬¬ä¸€æ­¥ï¼‰
  echo -e "${BLUE}[i] æ­¥éª¤1/3: æ„å»ºhooncç¼–è¯‘å™¨...${RESET}"
  if timeout 3600 make install-hoonc >>"$LOG_FILE" 2>&1; then
    echo -e "${GREEN}[+] hooncæ„å»ºæˆåŠŸ${RESET}"
  else
    echo -e "${YELLOW}[!] hooncæ„å»ºå¤±è´¥ï¼Œå°è¯•ç›´æ¥cargoæ„å»º...${RESET}"
    if timeout 3600 cargo build --bin hoonc --release >>"$LOG_FILE" 2>&1; then
      cargo install --bin hoonc --path . >>"$LOG_FILE" 2>&1 || true
      echo -e "${GREEN}[+] hooncç›´æ¥æ„å»ºæˆåŠŸ${RESET}"
    else
      echo -e "${RED}[-] hooncæ„å»ºå®Œå…¨å¤±è´¥${RESET}"
    fi
  fi
  
  # æ„å»ºä¸»é¡¹ç›®ï¼ˆç¬¬äºŒæ­¥ï¼‰
  echo -e "${BLUE}[i] æ­¥éª¤2/3: æ„å»ºä¸»é¡¹ç›®...${RESET}"
  for attempt in 1 2 3; do
    echo -e "[*] ä¸»é¡¹ç›®æ„å»ºå°è¯• $attempt/3..."
    
    if timeout 7200 make build >>"$LOG_FILE" 2>&1; then
      echo -e "${GREEN}[+] ä¸»é¡¹ç›®æ„å»ºæˆåŠŸ${RESET}"
      break
    else
      echo -e "${YELLOW}[!] ä¸»é¡¹ç›®æ„å»ºå°è¯• $attempt å¤±è´¥${RESET}"
      if [ $attempt -eq 3 ]; then
        echo -e "[*] å°è¯•åˆ†åˆ«æ„å»ºç»„ä»¶..."
        for component in "nockchain-wallet" "nockchain"; do
          echo -e "[*] æ„å»º $component..."
          timeout 3600 cargo build --bin "$component" --release >>"$LOG_FILE" 2>&1 || true
        done
      else
        # æ¸…ç†åé‡è¯•
        cargo clean >/dev/null 2>&1 || true
        sleep 30
      fi
    fi
  done
  
  # å®‰è£…ç»„ä»¶ï¼ˆç¬¬ä¸‰æ­¥ï¼‰
  echo -e "${BLUE}[i] æ­¥éª¤3/3: å®‰è£…ç»„ä»¶...${RESET}"
  for component in "nockchain-wallet" "nockchain"; do
    echo -e "[*] å®‰è£… $component..."
    if timeout 1800 make install-$component >>"$LOG_FILE" 2>&1; then
      echo -e "${GREEN}[+] $component å®‰è£…æˆåŠŸ${RESET}"
    else
      # æ‰‹åŠ¨å®‰è£…
      if [ -f "target/release/$component" ]; then
        cargo install --bin "$component" --path . >>"$LOG_FILE" 2>&1 || true
        echo -e "${GREEN}[+] $component æ‰‹åŠ¨å®‰è£…æˆåŠŸ${RESET}"
      else
        echo -e "${YELLOW}[!] $component å®‰è£…å¤±è´¥${RESET}"
      fi
    fi
  done
  
  # éªŒè¯æ„å»ºç»“æœ
  echo -e "[*] éªŒè¯æ„å»ºç»“æœ..."
  component_count=0
  for binary in "hoonc" "nockchain-wallet" "nockchain"; do
    if command -v "$binary" >/dev/null 2>&1 || [ -f "target/release/$binary" ]; then
      echo -e "${GREEN}  âœ“ $binary: å¯ç”¨${RESET}"
      ((component_count++))
    else
      echo -e "${RED}  âœ— $binary: æœªæ‰¾åˆ°${RESET}"
    fi
  done
  
  echo -e "${BLUE}[i] æ„å»ºæˆåŠŸç‡: $component_count/3 ($(( component_count * 100 / 3 ))%)${RESET}"
  
  if [ $component_count -ge 2 ]; then
    echo -e "${GREEN}[+] âœ… Nockchainæ„å»ºæˆåŠŸï¼${RESET}"
    echo -e "${BLUE}[i] ä¸‹ä¸€æ­¥: ç”Ÿæˆé’±åŒ…å’Œè®¾ç½®æŒ–çŸ¿å…¬é’¥${RESET}"
  else
    echo -e "${YELLOW}[!] æ„å»ºéƒ¨åˆ†å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—${RESET}"
  fi
  
  echo -e "${BLUE}[i] æ„å»ºæ—¥å¿—: $LOG_FILE${RESET}"
  pause_and_return
}

# ========= å…¶ä»–ç®¡ç†åŠŸèƒ½ =========
function generate_wallet() {
  echo -e "[*] ç”Ÿæˆé’±åŒ…..."
  cd "$NCK_DIR" || return
  source "$HOME/.cargo/env" 2>/dev/null || true
  
  if command -v nockchain-wallet >/dev/null 2>&1; then
    nockchain-wallet keygen
  elif [ -f "target/release/nockchain-wallet" ]; then
    ./target/release/nockchain-wallet keygen
  else
    echo -e "${RED}[-] æœªæ‰¾åˆ°nockchain-walletç¨‹åº${RESET}"
  fi
  pause_and_return
}

function set_mining_pubkey() {
  echo -e "[*] è®¾ç½®æŒ–çŸ¿å…¬é’¥..."
  cd "$NCK_DIR" || return
  
  echo -e "${BLUE}[i] å…¬é’¥è¦æ±‚: 128ä½16è¿›åˆ¶å­—ç¬¦ä¸²${RESET}"
  read -p "è¯·è¾“å…¥å®Œæ•´çš„æŒ–çŸ¿å…¬é’¥: " pubkey
  
  # æ¸…ç†æ ¼å¼
  pubkey=$(echo "$pubkey" | tr -d ' \n\r\t' | tr '[:upper:]' '[:lower:]')
  
  if [ ${#pubkey} -eq 128 ] && [[ "$pubkey" =~ ^[0-9a-f]{128}$ ]]; then
    sed -i '/^MINING_PUBKEY=/d' "$ENV_FILE" 2>/dev/null || true
    echo "MINING_PUBKEY=$pubkey" >> "$ENV_FILE"
    echo -e "${GREEN}[+] å…¬é’¥å·²æˆåŠŸå†™å…¥.envæ–‡ä»¶${RESET}"
    echo -e "${GREEN}[+] å…¬é’¥: ${pubkey:0:16}...${pubkey: -16}${RESET}"
  else
    echo -e "${RED}[-] å…¬é’¥æ ¼å¼é”™è¯¯${RESET}"
    echo -e "${YELLOW}[!] å½“å‰é•¿åº¦: ${#pubkey}ï¼Œéœ€è¦128ä½${RESET}"
  fi
  pause_and_return
}

function start_node() {
  echo -e "[*] å¯åŠ¨èŠ‚ç‚¹..."
  cd "$NCK_DIR" || return
  source "$HOME/.cargo/env" 2>/dev/null || true
  source "$HOME/.nockchain_env" 2>/dev/null || true
  
  if [ ! -f "$ENV_FILE" ] || [ -z "$(grep MINING_PUBKEY "$ENV_FILE" | cut -d'=' -f2)" ]; then
    echo -e "${RED}[-] è¯·å…ˆè®¾ç½®æŒ–çŸ¿å…¬é’¥${RESET}"
    pause_and_return
    return
  fi
  
  source "$ENV_FILE"
  
  # æ¸…ç†æ—§è¿›ç¨‹
  pkill -f nockchain 2>/dev/null || true
  find . -name "*.sock" -delete 2>/dev/null || true
  mkdir -p .socket test-leader
  
  # å¯åŠ¨èŠ‚ç‚¹
  start_cmd="RUST_LOG=info RUST_MIN_STACK=16777216 nockchain --mining-pubkey $MINING_PUBKEY --mine --peer /ip4/95.216.102.60/udp/3006/quic-v1 --peer /ip4/65.109.156.108/udp/3006/quic-v1 --peer /ip4/65.21.67.175/udp/3006/quic-v1 --peer /ip4/65.109.156.172/udp/3006/quic-v1 --peer /ip4/34.174.22.166/udp/3006/quic-v1 --npc-socket .socket/nockchain.sock --bind /ip4/0.0.0.0/udp/3006/quic-v1"
  
  if command -v screen >/dev/null 2>&1; then
    screen -dmS nockchain bash -c "cd '$NCK_DIR' && $start_cmd"
    sleep 3
    if screen -list | grep -qw "nockchain"; then
      echo -e "${GREEN}[+] âœ… èŠ‚ç‚¹å¯åŠ¨æˆåŠŸï¼ˆscreenä¼šè¯ï¼‰${RESET}"
      echo -e "${BLUE}[i] æŸ¥çœ‹æ—¥å¿—: screen -r nockchain${RESET}"
    else
      echo -e "${RED}[-] èŠ‚ç‚¹å¯åŠ¨å¤±è´¥${RESET}"
    fi
  else
    nohup bash -c "$start_cmd" > nockchain.log 2>&1 &
    echo -e "${GREEN}[+] èŠ‚ç‚¹å·²åå°å¯åŠ¨${RESET}"
    echo -e "${BLUE}[i] æ—¥å¿—æ–‡ä»¶: nockchain.log${RESET}"
  fi
  pause_and_return
}

function check_status() {
  echo -e "[*] æ£€æŸ¥ç³»ç»ŸçŠ¶æ€..."
  
  source "$HOME/.nockchain_env" 2>/dev/null || true
  
  echo -e "${BLUE}[i] ç¯å¢ƒçŠ¶æ€:${RESET}"
  echo -e "  è½¯ä»¶ç›®å½•: $USER_SOFTWARE_DIR"
  echo -e "  ç¯å¢ƒæ–‡ä»¶: $HOME/.nockchain_env"
  
  echo -e "${BLUE}[i] å·¥å…·çŠ¶æ€:${RESET}"
  for tool in make gcc g++ clang pkg-config git rustc cargo; do
    if command -v "$tool" >/dev/null 2>&1; then
      echo -e "  âœ“ $tool: $(command -v "$tool")"
    else
      echo -e "  âœ— $tool: æœªæ‰¾åˆ°"
    fi
  done
  
  echo -e "${BLUE}[i] å†…å­˜çŠ¶æ€:${RESET}"
  echo -e "  ç‰©ç†å†…å­˜: $(free -h | grep Mem | awk '{print $3"/"$2}')"
  echo -e "  Swapå†…å­˜: $(free -h | grep Swap | awk '{print $3"/"$2}')"
  
  echo -e "${BLUE}[i] Nockchainç»„ä»¶:${RESET}"
  if [ -d "$NCK_DIR" ]; then
    cd "$NCK_DIR"
    for binary in "hoonc" "nockchain-wallet" "nockchain"; do
      if command -v "$binary" >/dev/null 2>&1 || [ -f "target/release/$binary" ]; then
        echo -e "  âœ“ $binary: å¯ç”¨"
      else
        echo -e "  âœ— $binary: æœªæ‰¾åˆ°"
      fi
    done
    
    if [ -f "$ENV_FILE" ]; then
      if grep -q "MINING_PUBKEY=" "$ENV_FILE" && [ -n "$(grep MINING_PUBKEY "$ENV_FILE" | cut -d'=' -f2)" ]; then
        pubkey=$(grep MINING_PUBKEY "$ENV_FILE" | cut -d'=' -f2)
        echo -e "  âœ“ æŒ–çŸ¿å…¬é’¥: ${pubkey:0:16}...${pubkey: -16}"
      else
        echo -e "  âœ— æŒ–çŸ¿å…¬é’¥: æœªè®¾ç½®"
      fi
    fi
  else
    echo -e "  âœ— é¡¹ç›®ç›®å½•ä¸å­˜åœ¨"
  fi
  
  echo -e "${BLUE}[i] èŠ‚ç‚¹çŠ¶æ€:${RESET}"
  if command -v screen >/dev/null 2>&1 && screen -list | grep -qw "nockchain"; then
    echo -e "  âœ“ èŠ‚ç‚¹è¿è¡Œä¸­ (screen session)"
  elif pgrep -f "nockchain" >/dev/null 2>&1; then
    echo -e "  âœ“ èŠ‚ç‚¹è¿è¡Œä¸­ (background process)"
  else
    echo -e "  âœ— èŠ‚ç‚¹æœªè¿è¡Œ"
  fi
  
  pause_and_return
}

function pause_and_return() {
  echo ""
  read -n1 -r -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..." key
  main_menu
}

# ========= ä¸»èœå• =========
function main_menu() {
  show_banner
  echo "è¯·é€‰æ‹©æ“ä½œ:"
  echo ""
  echo "ğŸš€ å½»åº•è§£å†³:"
  echo "  1) ğŸ¯ å½»åº•è§£å†³ç‰ˆç¯å¢ƒå®‰è£…ï¼ˆå¼ºçƒˆæ¨èï¼‰"
  echo "  2) ğŸ”§ æ„å»ºNockchainé¡¹ç›®"
  echo ""
  echo "ğŸ”‘ é’±åŒ…ç®¡ç†:"
  echo "  3) ğŸ”‘ ç”Ÿæˆé’±åŒ…"
  echo "  4) ğŸ“ è®¾ç½®æŒ–çŸ¿å…¬é’¥"
  echo ""
  echo "âš¡ èŠ‚ç‚¹ç®¡ç†:"
  echo "  5) âš¡ å¯åŠ¨èŠ‚ç‚¹"
  echo "  6) ğŸ” æ£€æŸ¥å®Œæ•´çŠ¶æ€"
  echo ""
  echo "  0) é€€å‡ºè„šæœ¬"
  echo ""
  echo -e "${CYAN}ğŸ¯ å½»åº•ä¿®å¤: makeå·¥å…·ç¼ºå¤± + mem.rs:302:23 panicé”™è¯¯${RESET}"
  echo -e "${CYAN}ğŸ”§ å¤šé‡ä¿éšœ: é™æ€é“¾æ¥ + é¢„ç¼–è¯‘ + æºç ç¼–è¯‘${RESET}"
  echo -e "${CYAN}ğŸ’¾ å†…å­˜ä¼˜åŒ–: è‡ªåŠ¨é…ç½®swapï¼Œè§£å†³å†…å­˜ä¸è¶³é—®é¢˜${RESET}"
  echo ""
  read -p "è¯·è¾“å…¥ç¼–å· (0-6): " choice

  case "$choice" in
    1) complete_thorough_installation ;;
    2) build_nockchain_thorough ;;
    3) generate_wallet ;;
    4) set_mining_pubkey ;;
    5) start_node ;;
    6) check_status ;;
    0) echo "é€€å‡ºè„šæœ¬."; exit 0 ;;
    *) echo -e "${RED}[-] æ— æ•ˆé€‰é¡¹${RESET}"; pause_and_return ;;
  esac
}

# æ£€æŸ¥æƒé™
if [ "$EUID" -eq 0 ]; then
  echo -e "${RED}[-] è¯·ä¸è¦ä»¥rootç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬${RESET}"
  exit 1
fi

# å¯åŠ¨ä¸»èœå•
main_menu
