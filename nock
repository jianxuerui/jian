#!/bin/bash

# ========= Nockchain AWS-LC-SYS ä¿®å¤è„šæœ¬ v1.0 =========
RESET='\033[0m'
BOLD='\033[1m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'

NCK_DIR="$HOME/nockchain"
ENV_FILE="$NCK_DIR/.env"
BUILD_LOG="$HOME/nockchain_build.log"
NODE_LOG="$NCK_DIR/logs/nockchain.log"

# ---------- è¾…åŠ©å‡½æ•° ----------
log() { echo -e "${BLUE}[*] $*${RESET}"; }
ok()  { echo -e "${GREEN}[âœ“] $*${RESET}"; }
warn(){ echo -e "${YELLOW}[!] $*${RESET}"; }
err() { echo -e "${RED}[âœ—] $*${RESET}"; }
pause() { echo; read -n1 -r -p "æŒ‰ä»»æ„é”®è¿”å›èœå•..." _; }

# ---------- å®‰è£… Clang ----------
install_clang() {
  log "å®‰è£… Clang ç¼–è¯‘å™¨"
  
  if command -v clang >/dev/null 2>&1; then
    ok "Clang å·²å®‰è£…: $(clang --version | head -n1)"
    return 0
  fi
  
  if command -v apt >/dev/null 2>&1; then
    log "ä½¿ç”¨ apt å®‰è£… Clang"
    sudo apt update -y
    sudo apt install -y clang
  elif command -v yum >/dev/null 2>&1; then
    log "ä½¿ç”¨ yum å®‰è£… Clang"
    sudo yum install -y clang
  else
    err "æ— æ³•å®‰è£… Clangï¼Œè¯·æ‰‹åŠ¨å®‰è£…"
    return 1
  fi
  
  if command -v clang >/dev/null 2>&1; then
    ok "Clang å®‰è£…æˆåŠŸ: $(clang --version | head -n1)"
    return 0
  else
    err "Clang å®‰è£…å¤±è´¥"
    return 1
  fi
}

# ---------- ä½¿ç”¨ Clang æ„å»º ----------
build_with_clang() {
  log "ä½¿ç”¨ Clang æ„å»º Nockchain"
  
  # ç¡®ä¿ Clang å·²å®‰è£…
  if ! command -v clang >/dev/null 2>&1; then
    err "Clang æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… Clang"
    return 1
  fi
  
  # è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œå¼ºåˆ¶ä½¿ç”¨ Clang
  export CC=clang
  export CXX=clang++
  
  # æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶
  cd "$NCK_DIR" || return 1
  cargo clean
  
  # ä½¿ç”¨ Clang æ„å»º
  log "å¼€å§‹æ„å»º (ä½¿ç”¨ Clang æ›¿ä»£ GCC)"
  cargo build --release 2>&1 | tee "$BUILD_LOG"
  
  if [ $? -eq 0 ]; then
    ok "æ„å»ºæˆåŠŸ"
    return 0
  else
    err "æ„å»ºå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—: $BUILD_LOG"
    return 1
  fi
}

# ---------- å®Œæ•´å®‰è£… ----------
complete_installation() {
  log "å¼€å§‹å®Œæ•´å®‰è£… Nockchain (ä½¿ç”¨ Clang)"
  
  # å®‰è£… Clang
  install_clang || return 1
  
  # å®‰è£… Rust (å¦‚æœéœ€è¦)
  if ! command -v rustc >/dev/null 2>&1; then
    log "å®‰è£… Rust"
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    source "$HOME/.cargo/env"
  fi
  
  # å…‹éš†é¡¹ç›® (å¦‚æœéœ€è¦)
  if [ ! -d "$NCK_DIR" ]; then
    log "å…‹éš† Nockchain é¡¹ç›®"
    git clone --depth 1 https://github.com/zorp-corp/nockchain "$NCK_DIR"
  fi
  
  # ä½¿ç”¨ Clang æ„å»º
  build_with_clang
}

# ---------- è®¾ç½®æŒ–çŸ¿å…¬é’¥ ----------
set_mining_pubkey() {
  log "è®¾ç½®æŒ–çŸ¿å…¬é’¥"
  
  if [ ! -f "$ENV_FILE" ]; then
    mkdir -p "$NCK_DIR"
    echo "MINING_PUBKEY=" > "$ENV_FILE"
    echo "RUST_LOG=info" >> "$ENV_FILE"
  fi
  
  read -rp "è¾“å…¥ 128 ä½å…¬é’¥: " key
  key=$(echo "$key" | tr -d '[:space:]' | tr A-F a-f)
  
  if [ ${#key} -eq 128 ] && [[ "$key" =~ ^[0-9a-f]+$ ]]; then
    sed -i "/^MINING_PUBKEY=/d" "$ENV_FILE"
    echo "MINING_PUBKEY=$key" >> "$ENV_FILE"
    ok "å…¬é’¥å·²å†™å…¥ .env"
  else
    err "å…¬é’¥æ ¼å¼ä¸æ­£ç¡®"
  fi
  
  pause
}

# ---------- å¯åŠ¨èŠ‚ç‚¹ ----------
start_node() {
  log "å¯åŠ¨ Nockchain èŠ‚ç‚¹"
  
  # æ£€æŸ¥ç¯å¢ƒ
  source "$ENV_FILE" 2>/dev/null || true
  if [ -z "$MINING_PUBKEY" ]; then
    err "æœªè®¾ç½®æŒ–çŸ¿å…¬é’¥ï¼Œè¯·å…ˆè®¾ç½®"
    pause
    return 1
  fi
  
  # æ¸…ç† socket æ–‡ä»¶
  pkill -f nockchain 2>/dev/null || true
  find "$NCK_DIR" -name "*.sock" -delete 2>/dev/null || true
  mkdir -p "$NCK_DIR/.socket" "$NCK_DIR/logs"
  
  # æ„å»ºå¯åŠ¨å‘½ä»¤
  START_CMD="RUST_MIN_STACK=33554432 RUST_LOG=info $NCK_DIR/target/release/nockchain \
    --mining-pubkey $MINING_PUBKEY \
    --mine \
    --peer /ip4/95.216.102.60/udp/3006/quic-v1 \
    --peer /ip4/65.109.156.108/udp/3006/quic-v1 \
    --peer /ip4/65.21.67.175/udp/3006/quic-v1 \
    --peer /ip4/65.109.156.172/udp/3006/quic-v1 \
    --peer /ip4/34.174.22.166/udp/3006/quic-v1 \
    --npc-socket $NCK_DIR/.socket/nockchain.sock \
    --bind /ip4/0.0.0.0/udp/3006/quic-v1"
  
  # å¯åŠ¨èŠ‚ç‚¹
  cd "$NCK_DIR"
  if command -v screen >/dev/null; then
    screen -dmS nockchain bash -c "$START_CMD 2>&1 | tee $NODE_LOG"
    sleep 3
    if screen -list | grep -qw "nockchain"; then
      ok "èŠ‚ç‚¹å·²å¯åŠ¨ (screen ä¼šè¯: nockchain)"
    else
      err "èŠ‚ç‚¹å¯åŠ¨å¤±è´¥"
    fi
  else
    nohup bash -c "$START_CMD" > "$NODE_LOG" 2>&1 &
    ok "èŠ‚ç‚¹å·²åå°å¯åŠ¨"
  fi
  
  pause
}

# ---------- æŸ¥çœ‹æ—¥å¿— ----------
view_logs() {
  if [ -f "$NODE_LOG" ]; then
    tail -n 100 -f "$NODE_LOG"
  else
    err "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨: $NODE_LOG"
  fi
  pause
}

# ---------- ä¸»èœå• ----------
while true; do
  clear
  echo -e "${CYAN}${BOLD}"
  echo "================================================"
  echo "        Nockchain AWS-LC-SYS ä¿®å¤è„šæœ¬ v1.0"
  echo "================================================"
  echo -e "${RESET}"
  echo ""
  echo -e "${GREEN}ğŸ”§ å®‰è£…é€‰é¡¹:${RESET}"
  echo "  1) ä½¿ç”¨ Clang å®Œæ•´å®‰è£… Nockchain"
  echo ""
  echo -e "${GREEN}ğŸ”‘ èŠ‚ç‚¹ç®¡ç†:${RESET}"
  echo "  2) è®¾ç½®æŒ–çŸ¿å…¬é’¥"
  echo "  3) å¯åŠ¨æŒ–çŸ¿èŠ‚ç‚¹"
  echo "  4) æŸ¥çœ‹èŠ‚ç‚¹æ—¥å¿—"
  echo ""
  echo "  0) é€€å‡ºè„šæœ¬"
  echo ""
  read -rp "è¯·é€‰æ‹©æ“ä½œ (0-4): " choice
  
  case $choice in
    1) complete_installation; pause ;;
    2) set_mining_pubkey ;;
    3) start_node ;;
    4) view_logs ;;
    0) echo -e "${GREEN}æ„Ÿè°¢ä½¿ç”¨ï¼${RESET}"; exit 0 ;;
    *) warn "æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°é€‰æ‹©"; sleep 1 ;;
  esac
done
